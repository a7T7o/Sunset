# å†œç”°ç³»ç»Ÿæ·±åº¦åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-26  
**ç›®çš„**: ç³»ç»Ÿæ€§å®¡è§†å†œç”°ç³»ç»Ÿï¼Œæ‰¾å‡ºæ ¸å¿ƒé—®é¢˜ï¼Œåˆ¶å®šé‡æ„æ–¹æ¡ˆ

---

## ä¸€ã€èµ„æºæ¸…å•ç¡®è®¤ï¼ˆç”¨æˆ·æ¾„æ¸…ï¼‰

### 1.1 ä¸­å¿ƒå—èµ„æº

| ç¼–å· | åç§° | ç”¨é€” |
|------|------|------|
| C0 | æœªæ–½è‚¥ä¸­å¿ƒå— | é”„åœ°åé»˜è®¤çŠ¶æ€ |
| C1 | å·²æ–½è‚¥ä¸­å¿ƒå— | æ–½è‚¥åçŠ¶æ€ |

**é‡è¦æ¾„æ¸…**ï¼šC0/C1 ä¸æ˜¯å¹²ç‡¥/æ¹¿æ¶¦çš„åŒºåˆ†ï¼Œè€Œæ˜¯æ–½è‚¥çŠ¶æ€çš„åŒºåˆ†ï¼

### 1.2 è¾¹ç•Œèµ„æºï¼ˆ15 ä¸ªï¼‰

| ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| å•æ–¹å‘ | 4 | U, D, L, R |
| åŒæ–¹å‘å¯¹è¾¹ | 2 | UD, LR |
| åŒæ–¹å‘ç›¸é‚» | 4 | UL, UR, DL, DR |
| ä¸‰æ–¹å‘ | 4 | UDL, UDR, ULR, DLR |
| å››æ–¹å‘ | 1 | UDLR |

### 1.3 é˜´å½±èµ„æºï¼ˆ4 ä¸ªï¼‰

| ç¼–å· | åç§° | ä½ç½® |
|------|------|------|
| SLU | å·¦ä¸Šé˜´å½± | å·¦ä¸Šè§’æœ‰ä¸­å¿ƒå—æ—¶ |
| SRU | å³ä¸Šé˜´å½± | å³ä¸Šè§’æœ‰ä¸­å¿ƒå—æ—¶ |
| SLD | å·¦ä¸‹é˜´å½± | å·¦ä¸‹è§’æœ‰ä¸­å¿ƒå—æ—¶ |
| SRD | å³ä¸‹é˜´å½± | å³ä¸‹è§’æœ‰ä¸­å¿ƒå—æ—¶ |

### 1.4 æ°´æ¸èµ„æºï¼ˆ3 ä¸ªï¼‰

| ç¼–å· | ç”¨é€” |
|------|------|
| W0 | æ°´æ¸å˜ä½“ 1 |
| W1 | æ°´æ¸å˜ä½“ 2 |
| W2 | æ°´æ¸å˜ä½“ 3 |

### 1.5 æ¹¿æ¶¦æ•ˆæœï¼ˆä»£ç å®ç°ï¼‰

**ç”¨æˆ·æ˜ç¡®**ï¼š
- ä¸ä¼šæ–°å¢ Sprite
- æ¹¿æ¶¦æ•ˆæœéœ€è¦é€šè¿‡ä»£ç å®ç°ï¼ˆé¢œè‰²å˜åŒ–ã€Shader ç­‰ï¼‰
- æµ‡æ°´åä¸€å®šæ—¶é—´å†…æ¸å˜æˆæ¹¿æ¶¦æ ·å¼
- æµ‡æ°´ Tile é€æ¸æ¶ˆå¤±ï¼ˆä¸æ˜¯æœ€åˆè®¾è®¡çš„ 2 å°æ—¶ï¼‰

---

## äºŒã€é‡æ„å†å²å›é¡¾

### 2.1 åŸå§‹è®¾è®¡ï¼ˆä¼šè¯ 5 - é‡æ„è§„åˆ’ï¼‰

**è®¾è®¡ç›®æ ‡**ï¼š
```
FarmingManagerNewï¼ˆåè°ƒè€…ï¼‰
â”œâ”€â”€ FarmTileManagerï¼ˆè€•åœ°çŠ¶æ€ç®¡ç†ï¼‰
â”œâ”€â”€ CropManagerï¼ˆä½œç‰©ç”Ÿå‘½å‘¨æœŸï¼‰
â””â”€â”€ FarmVisualManagerï¼ˆè§†è§‰æ›´æ–°ï¼‰
```

**é¢„æœŸåŠŸèƒ½**ï¼š
1. é”„åœ° â†’ ç”Ÿæˆè€•åœ° Tile
2. æµ‡æ°´ â†’ æ›´æ–°æ¹¿åº¦çŠ¶æ€ + è§†è§‰æ•ˆæœ
3. ç§æ¤ â†’ åˆ›å»ºä½œç‰©å®ä¾‹
4. ç”Ÿé•¿ â†’ æ¯æ—¥æ£€æµ‹æµ‡æ°´çŠ¶æ€
5. æ”¶è· â†’ è·å–ä½œç‰© + æ¸…ç†

### 2.2 å®é™…å®ç°çŠ¶æ€

| æ¨¡å— | è®¾è®¡ | å®ç° | å·®è· |
|------|------|------|------|
| FarmingManagerNew | åè°ƒè€… | âœ… å·²å®ç° | ä½†åœºæ™¯ä¸­æœªé…ç½® |
| FarmTileManager | è€•åœ°æ•°æ® | âœ… å·²å®ç° | æ­£å¸¸å·¥ä½œ |
| FarmVisualManager | è§†è§‰æ›´æ–° | âš ï¸ éƒ¨åˆ†å®ç° | ä½¿ç”¨æ—§ç‰ˆå­—æ®µ |
| FarmlandBorderManager | è¾¹ç•Œç®¡ç† | âœ… å·²å®ç° | æ­£å¸¸å·¥ä½œ |
| CropManager | ä½œç‰©ç®¡ç† | âœ… å·²å®ç° | è®¾è®¡æ¨¡å¼æœ‰äº‰è®® |
| LayerTilemaps | æ¥¼å±‚é…ç½® | âš ï¸ æ··ä¹± | æ–°æ—§ä¸¤å¥—å­—æ®µ |

### 2.3 è®¾è®¡ vs å®ç°çš„å·®è·

#### å·®è· 1ï¼šFarmVisualManager ä½¿ç”¨æ—§ç‰ˆå­—æ®µ

**è®¾è®¡é¢„æœŸ**ï¼š
```csharp
// ä½¿ç”¨æ–°ç‰ˆå­—æ®µ
tilemaps.farmlandCenterTilemap.SetTile(...)
tilemaps.farmlandBorderTilemap.SetTile(...)
```

**å®é™…å®ç°**ï¼š
```csharp
// FarmVisualManager.UpdateTileVisual() ç¬¬ 108 è¡Œ
if (tilemaps == null || tilemaps.farmlandTilemap == null) return;
tilemaps.farmlandTilemap.SetTile(cellPosition, targetTile);
```

**é—®é¢˜**ï¼šFarmVisualManager ä½¿ç”¨ `farmlandTilemap`ï¼ˆæ—§ç‰ˆï¼‰ï¼Œä½†ç”¨æˆ·é…ç½®çš„æ˜¯ `farmlandCenterTilemap`ï¼ˆæ–°ç‰ˆï¼‰ã€‚

#### å·®è· 2ï¼šLayerTilemaps æœ‰æ–°æ—§ä¸¤å¥—å­—æ®µ

```csharp
// LayerTilemaps.cs
public Tilemap farmlandTilemap;        // æ—§ç‰ˆï¼šRule Tile ç³»ç»Ÿ
public Tilemap waterPuddleTilemap;     // æ—§ç‰ˆï¼šæ°´æ¸å åŠ 

public Tilemap farmlandCenterTilemap;  // æ–°ç‰ˆï¼šä¸­å¿ƒå—
public Tilemap farmlandBorderTilemap;  // æ–°ç‰ˆï¼šè¾¹ç•Œè£…é¥°
```

**é—®é¢˜**ï¼šä¸¤å¥—å­—æ®µå…±å­˜ï¼Œå®¹æ˜“æ··æ·†ï¼Œä¸åŒç»„ä»¶ä½¿ç”¨ä¸åŒå­—æ®µã€‚

#### å·®è· 3ï¼šFarmingManagerNew æœªåœ¨åœºæ™¯ä¸­é…ç½®

**è°ƒç”¨é“¾**ï¼š
```
GameInputManager.TryTillSoil()
  â†’ FarmingManagerNew.Instance.CanTillAt()  â† è¿™é‡ŒæŠ¥é”™
```

**é—®é¢˜**ï¼šåœºæ™¯ä¸­æœ‰ FarmTileManagerï¼Œä½†æ²¡æœ‰ FarmingManagerNewã€‚

#### å·®è· 4ï¼šFarmVisualManager çš„ dryFarmlandTile æ— ç”¨

**è®¾è®¡é¢„æœŸ**ï¼šä½¿ç”¨ Rule Tile è‡ªåŠ¨æ‹¼æ¥è¾¹ç•Œ
**å®é™…æƒ…å†µ**ï¼šä½¿ç”¨ä»£ç æ§åˆ¶è¾¹ç•Œï¼ˆFarmlandBorderManagerï¼‰

**é—®é¢˜**ï¼š`dryFarmlandTile` å­—æ®µåœ¨æ–°ç³»ç»Ÿä¸­å®Œå…¨æ— ç”¨ã€‚

---

## ä¸‰ã€æ ¸å¿ƒé—®é¢˜è¯†åˆ«

### 3.1 é—®é¢˜ä¼˜å…ˆçº§çŸ©é˜µ

| # | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | ä¿®å¤éš¾åº¦ |
|---|------|---------|---------|---------|
| P1 | GameInputManager ä¾èµ– FarmingManagerNew.Instance | ğŸ”´ è‡´å‘½ | é”„åœ°/æµ‡æ°´å®Œå…¨ä¸å·¥ä½œ | ä½ |
| P2 | FarmVisualManager ä½¿ç”¨æ—§ç‰ˆ Tilemap å­—æ®µ | ğŸ”´ é«˜ | è§†è§‰æ›´æ–°ä¸å·¥ä½œ | ä¸­ |
| P3 | LayerTilemaps æ–°æ—§å­—æ®µæ··ä¹± | ğŸŸ¡ ä¸­ | é…ç½®æ··ä¹± | ä¸­ |
| P4 | FarmVisualManager.dryFarmlandTile æ— ç”¨ | ğŸŸ¡ ä¸­ | é…ç½®æ··ä¹± | ä½ |
| P5 | CropManager è®¾è®¡æ¨¡å¼ä¸é¡¹ç›®é£æ ¼ä¸ä¸€è‡´ | ğŸŸ¡ ä¸­ | åç»­ç»´æŠ¤ | é«˜ |
| P6 | æ¹¿æ¶¦æ•ˆæœæœªå®ç° | ğŸŸ¢ ä½ | è§†è§‰æ•ˆæœ | ä¸­ |

### 3.2 æ ¹æœ¬åŸå› åˆ†æ

```
æ ¹æœ¬åŸå› ï¼šéœ€æ±‚å˜æ›´åï¼Œä»£ç æ²¡æœ‰åŒæ­¥æ›´æ–°
    â”‚
    â”œâ”€â”€ åŸå›  1ï¼šä» Rule Tile ç³»ç»Ÿåˆ‡æ¢åˆ°ä»£ç æ§åˆ¶è¾¹ç•Œ
    â”‚   â””â”€â”€ å½±å“ï¼šFarmVisualManager çš„è®¾è®¡ç›®æ ‡å¤±æ•ˆ
    â”‚
    â”œâ”€â”€ åŸå›  2ï¼šLayerTilemaps æ·»åŠ æ–°å­—æ®µä½†ä¿ç•™æ—§å­—æ®µ
    â”‚   â””â”€â”€ å½±å“ï¼šä¸åŒç»„ä»¶ä½¿ç”¨ä¸åŒå­—æ®µ
    â”‚
    â””â”€â”€ åŸå›  3ï¼šFarmingManagerNew ä½œä¸ºåè°ƒè€…ï¼Œä½†åœºæ™¯ä¸­æœªé…ç½®
        â””â”€â”€ å½±å“ï¼šæ•´ä¸ªå†œç”°ç³»ç»Ÿæ— æ³•å·¥ä½œ
```

### 3.3 æœ€æ ¸å¿ƒçš„é—®é¢˜

**P1ï¼šGameInputManager ä¾èµ– FarmingManagerNew.Instance**

è¿™æ˜¯æœ€æ ¸å¿ƒçš„é—®é¢˜ï¼Œå› ä¸ºï¼š
1. å®ƒç›´æ¥å¯¼è‡´é”„åœ°å’Œæµ‡æ°´åŠŸèƒ½å®Œå…¨ä¸å·¥ä½œ
2. å®ƒæ˜¯ç”¨æˆ·å½“å‰é‡åˆ°çš„å®é™…é—®é¢˜
3. ä¿®å¤å®ƒå¯ä»¥è®©ç³»ç»Ÿè‡³å°‘èƒ½è¿è¡Œèµ·æ¥

---

## å››ã€å½“å‰ç³»ç»Ÿæ¶æ„åˆ†æ

### 4.1 è°ƒç”¨é“¾è·¯å›¾

```
ç”¨æˆ·æ“ä½œ
    â”‚
    â–¼
GameInputManager
    â”‚
    â”œâ”€â”€ TryTillSoil(worldPos)
    â”‚   â””â”€â”€ FarmingManagerNew.Instance.CanTillAt()  â† ğŸ”´ è¿™é‡ŒæŠ¥é”™
    â”‚       â””â”€â”€ FarmTileManager.CanTillAt()
    â”‚           â””â”€â”€ FarmlandBorderManager.OnCenterBlockPlaced()
    â”‚
    â””â”€â”€ TryWaterTile(worldPos)
        â””â”€â”€ FarmingManagerNew.Instance.WaterTile()  â† ğŸ”´ è¿™é‡ŒæŠ¥é”™
            â””â”€â”€ FarmTileManager.SetWatered()
                â””â”€â”€ FarmVisualManager.UpdateTileVisual()  â† ğŸŸ¡ ä½¿ç”¨æ—§ç‰ˆå­—æ®µ
```

### 4.2 ç»„ä»¶èŒè´£åˆ†æ

| ç»„ä»¶ | è®¾è®¡èŒè´£ | å®é™…èŒè´£ | é—®é¢˜ |
|------|---------|---------|------|
| FarmingManagerNew | åè°ƒè€… | åè°ƒè€… | åœºæ™¯ä¸­æœªé…ç½® |
| FarmTileManager | è€•åœ°æ•°æ® CRUD | è€•åœ°æ•°æ® CRUD | âœ… æ­£å¸¸ |
| FarmVisualManager | Tile è§†è§‰ + éŸ³æ•ˆ | Tile è§†è§‰ + éŸ³æ•ˆ | ä½¿ç”¨æ—§ç‰ˆå­—æ®µ |
| FarmlandBorderManager | è¾¹ç•Œè®¡ç®— + æ”¾ç½® | è¾¹ç•Œè®¡ç®— + æ”¾ç½® | âœ… æ­£å¸¸ |
| CropManager | ä½œç‰©ç”Ÿå‘½å‘¨æœŸ | ä½œç‰©ç”Ÿå‘½å‘¨æœŸ | è®¾è®¡æ¨¡å¼äº‰è®® |

### 4.3 æ•°æ®æµåˆ†æ

```
é”„åœ°æµç¨‹ï¼ˆè®¾è®¡ï¼‰ï¼š
GameInputManager â†’ FarmingManagerNew â†’ FarmTileManager â†’ FarmlandBorderManager
                                    â†˜ FarmVisualManager

é”„åœ°æµç¨‹ï¼ˆå®é™…ï¼‰ï¼š
GameInputManager â†’ FarmingManagerNew (null) â†’ ğŸ’¥ æŠ¥é”™
```

---

## äº”ã€é‡æ„æ–¹æ¡ˆ

### 5.1 æ–¹æ¡ˆ Aï¼šå®Œæ•´é…ç½®ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

**æ€è·¯**ï¼šåœ¨åœºæ™¯ä¸­æ·»åŠ  FarmingManagerNewï¼Œé…ç½®æ‰€æœ‰å¼•ç”¨

**æ­¥éª¤**ï¼š
1. åœ¨åœºæ™¯ä¸­åˆ›å»º FarmingManagerNew GameObject
2. é…ç½®å­ç®¡ç†å™¨å¼•ç”¨ï¼ˆtileManager, cropManager, visualManagerï¼‰
3. ä¿®å¤ FarmVisualManager ä½¿ç”¨æ–°ç‰ˆå­—æ®µ
4. æ¸…ç† LayerTilemaps æ—§ç‰ˆå­—æ®µ

**ä¼˜ç‚¹**ï¼š
- æ”¹åŠ¨æœ€å°
- ä¿æŒåŸæœ‰æ¶æ„

**ç¼ºç‚¹**ï¼š
- éœ€è¦é…ç½®å¤šä¸ªç»„ä»¶
- FarmingManagerNew å¯èƒ½æ˜¯è¿‡åº¦è®¾è®¡

### 5.2 æ–¹æ¡ˆ Bï¼šç®€åŒ–æ¶æ„ï¼ˆæ¨èï¼‰

**æ€è·¯**ï¼šç»•è¿‡ FarmingManagerNewï¼Œç›´æ¥è°ƒç”¨ FarmTileManager

**æ­¥éª¤**ï¼š
1. ä¿®æ”¹ GameInputManager.TryTillSoil() ç›´æ¥è°ƒç”¨ FarmTileManager
2. ä¿®æ”¹ GameInputManager.TryWaterTile() ç›´æ¥è°ƒç”¨ FarmTileManager
3. åˆ é™¤æˆ–æš‚ä¸ä½¿ç”¨ FarmingManagerNew
4. åˆ é™¤æˆ–æš‚ä¸ä½¿ç”¨ FarmVisualManagerï¼ˆè§†è§‰æ•ˆæœåç»­å†åŠ ï¼‰
5. æ¸…ç† LayerTilemaps æ—§ç‰ˆå­—æ®µ

**ä¼˜ç‚¹**ï¼š
- æ¶æ„æ›´ç®€å•
- å‡å°‘é…ç½®å¤æ‚åº¦
- æ›´å®¹æ˜“è°ƒè¯•

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹ GameInputManager
- æš‚æ—¶æ²¡æœ‰è§†è§‰æ•ˆæœï¼ˆéŸ³æ•ˆã€ç²’å­ï¼‰

### 5.3 æ–¹æ¡ˆ Cï¼šæ¸è¿›å¼é‡æ„

**æ€è·¯**ï¼šåˆ†é˜¶æ®µé‡æ„ï¼Œæ¯é˜¶æ®µéƒ½å¯éªŒæ”¶

**é˜¶æ®µ 1**ï¼šè®©é”„åœ°å·¥ä½œ
- ä¿®æ”¹ GameInputManager ç›´æ¥è°ƒç”¨ FarmTileManager
- éªŒæ”¶ï¼šé”„åœ°èƒ½ç”Ÿæˆä¸­å¿ƒå—å’Œè¾¹ç•Œ

**é˜¶æ®µ 2**ï¼šè®©æµ‡æ°´å·¥ä½œ
- å®ç°ç®€åŒ–ç‰ˆæµ‡æ°´ï¼ˆåªæ›´æ–°æ•°æ®ï¼Œä¸æ›´æ–°è§†è§‰ï¼‰
- éªŒæ”¶ï¼šæµ‡æ°´èƒ½æ›´æ–°è€•åœ°çŠ¶æ€

**é˜¶æ®µ 3**ï¼šæ·»åŠ æ¹¿æ¶¦è§†è§‰æ•ˆæœ
- å®ç°ä»£ç æ§åˆ¶çš„æ¹¿æ¶¦æ•ˆæœï¼ˆé¢œè‰²å˜åŒ–æˆ– Shaderï¼‰
- éªŒæ”¶ï¼šæµ‡æ°´åè€•åœ°é¢œè‰²å˜åŒ–

**é˜¶æ®µ 4**ï¼šæ¸…ç†æ—§ä»£ç 
- åˆ é™¤ FarmVisualManager çš„æ—§ç‰ˆå­—æ®µ
- æ¸…ç† LayerTilemaps çš„æ—§ç‰ˆå­—æ®µ
- éªŒæ”¶ï¼šä»£ç æ•´æ´

---

## å…­ã€æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ Cï¼ˆæ¸è¿›å¼é‡æ„ï¼‰

### 6.1 ç†ç”±

1. **ç”¨æˆ·å½“å‰ä¼˜å…ˆçº§**ï¼šå…ˆå®Œæˆè€•åœ°ç”Ÿæˆã€è¾¹ç•Œå’Œæµ‡æ°´
2. **é£é™©æ§åˆ¶**ï¼šæ¯é˜¶æ®µéƒ½å¯éªŒæ”¶ï¼Œå‡ºé—®é¢˜å®¹æ˜“å®šä½
3. **çµæ´»æ€§**ï¼šå¯ä»¥æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´åç»­é˜¶æ®µ

### 6.2 é˜¶æ®µ 1 è¯¦ç»†è®¾è®¡

**ç›®æ ‡**ï¼šè®©é”„åœ°å·¥ä½œ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `GameInputManager.cs` - TryTillSoil() æ–¹æ³•

**ä¿®æ”¹å†…å®¹**ï¼š
```csharp
// ä¿®æ”¹å‰
private bool TryTillSoil(Vector3 worldPosition)
{
    var farmingManager = FarmingManagerNew.Instance;
    if (farmingManager == null)
    {
        if (showDebugInfo)
            Debug.Log("[GameInputManager] FarmingManagerNew æœªåˆå§‹åŒ–");
        return false;
    }
    // ...
}

// ä¿®æ”¹å
private bool TryTillSoil(Vector3 worldPosition)
{
    var tileManager = FarmTileManager.Instance;
    if (tileManager == null)
    {
        if (showDebugInfo)
            Debug.Log("[GameInputManager] FarmTileManager æœªåˆå§‹åŒ–");
        return false;
    }
    
    // è·å–å½“å‰æ¥¼å±‚
    int layerIndex = tileManager.GetCurrentLayerIndex(worldPosition);
    var tilemaps = tileManager.GetLayerTilemaps(layerIndex);
    
    if (tilemaps == null || !tilemaps.IsNewFarmlandSystemValid())
    {
        if (showDebugInfo)
            Debug.Log("[GameInputManager] æ¥¼å±‚é…ç½®æ— æ•ˆ");
        return false;
    }
    
    // è½¬æ¢ä¸ºæ ¼å­åæ ‡
    Vector3Int cellPosition = tilemaps.WorldToCell(worldPosition);
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥é”„åœ°
    if (!tileManager.CanTillAt(layerIndex, cellPosition))
    {
        if (showDebugInfo)
            Debug.Log($"[GameInputManager] æ— æ³•åœ¨æ­¤ä½ç½®é”„åœ°: {cellPosition}");
        return false;
    }
    
    // æ‰§è¡Œé”„åœ°
    bool success = tileManager.CreateTile(layerIndex, cellPosition);
    
    if (showDebugInfo)
        Debug.Log($"[GameInputManager] é”„åœ°{(success ? "æˆåŠŸ" : "å¤±è´¥")}: {cellPosition}");
    
    return success;
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] é”„åœ°èƒ½ç”Ÿæˆä¸­å¿ƒå— Tile
- [ ] è¾¹ç•Œèƒ½æ­£ç¡®è®¡ç®—å’Œæ”¾ç½®
- [ ] ä¸æŠ¥ FarmingManagerNew æœªåˆå§‹åŒ–é”™è¯¯

### 6.3 é˜¶æ®µ 2 è¯¦ç»†è®¾è®¡

**ç›®æ ‡**ï¼šè®©æµ‡æ°´å·¥ä½œ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `GameInputManager.cs` - TryWaterTile() æ–¹æ³•

**ä¿®æ”¹å†…å®¹**ï¼š
```csharp
// ä¿®æ”¹å
private bool TryWaterTile(Vector3 worldPosition)
{
    var tileManager = FarmTileManager.Instance;
    if (tileManager == null)
    {
        if (showDebugInfo)
            Debug.Log("[GameInputManager] FarmTileManager æœªåˆå§‹åŒ–");
        return false;
    }
    
    // è·å–å½“å‰æ¥¼å±‚
    int layerIndex = tileManager.GetCurrentLayerIndex(worldPosition);
    var tilemaps = tileManager.GetLayerTilemaps(layerIndex);
    
    if (tilemaps == null)
    {
        return false;
    }
    
    // è½¬æ¢ä¸ºæ ¼å­åæ ‡
    Vector3Int cellPosition = tilemaps.WorldToCell(worldPosition);
    
    // è·å–å½“å‰æ—¶é—´
    float currentTime = 0f;
    if (TimeManager.Instance != null)
    {
        currentTime = TimeManager.Instance.GetHour() + TimeManager.Instance.GetMinute() / 60f;
    }
    
    // æ‰§è¡Œæµ‡æ°´
    bool success = tileManager.SetWatered(layerIndex, cellPosition, currentTime);
    
    if (showDebugInfo)
        Debug.Log($"[GameInputManager] æµ‡æ°´{(success ? "æˆåŠŸ" : "å¤±è´¥")}: {cellPosition}");
    
    return success;
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æµ‡æ°´èƒ½æ›´æ–°è€•åœ°çš„ wateredToday çŠ¶æ€
- [ ] æµ‡æ°´èƒ½æ›´æ–°è€•åœ°çš„ moistureState
- [ ] ä¸æŠ¥é”™

### 6.4 é˜¶æ®µ 3 è¯¦ç»†è®¾è®¡

**ç›®æ ‡**ï¼šæ·»åŠ æ¹¿æ¶¦è§†è§‰æ•ˆæœ

**æ–¹æ¡ˆé€‰æ‹©**ï¼š
1. **é¢œè‰²å˜åŒ–**ï¼šé€šè¿‡ SpriteRenderer.color æˆ– Tilemap.SetColor() å®ç°
2. **Shader**ï¼šåˆ›å»ºè‡ªå®šä¹‰ Shader å®ç°æ¹¿æ¶¦æ•ˆæœ
3. **å åŠ å±‚**ï¼šåœ¨æ°´æ¸ Tilemap ä¸Šæ”¾ç½®åŠé€æ˜æ·±è‰² Tile

**æ¨èæ–¹æ¡ˆ**ï¼šé¢œè‰²å˜åŒ–ï¼ˆæœ€ç®€å•ï¼‰

**å®ç°æ€è·¯**ï¼š
```csharp
// åœ¨ FarmlandBorderManager æˆ–æ–°å»º FarmlandVisualHelper ä¸­
public void SetTileWetVisual(int layerIndex, Vector3Int cellPosition, bool isWet)
{
    var tilemaps = FarmTileManager.Instance?.GetLayerTilemaps(layerIndex);
    if (tilemaps == null) return;
    
    // è®¾ç½®ä¸­å¿ƒå—é¢œè‰²
    Color targetColor = isWet ? new Color(0.7f, 0.6f, 0.5f) : Color.white;
    tilemaps.farmlandCenterTilemap.SetColor(cellPosition, targetColor);
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æµ‡æ°´åè€•åœ°é¢œè‰²å˜æ·±
- [ ] å¹²ç‡¥åè€•åœ°é¢œè‰²æ¢å¤

### 6.5 é˜¶æ®µ 4 è¯¦ç»†è®¾è®¡

**ç›®æ ‡**ï¼šæ¸…ç†æ—§ä»£ç 

**æ¸…ç†å†…å®¹**ï¼š
1. LayerTilemaps åˆ é™¤ `farmlandTilemap` å­—æ®µ
2. FarmVisualManager åˆ é™¤ `dryFarmlandTile`ã€`wetDarkTile` å­—æ®µ
3. æˆ–è€…ç›´æ¥åˆ é™¤ FarmVisualManagerï¼ˆå¦‚æœä¸éœ€è¦éŸ³æ•ˆå’Œç²’å­ï¼‰

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] ç¼–è¯‘é€šè¿‡
- [ ] åŠŸèƒ½æ­£å¸¸
- [ ] ä»£ç æ•´æ´

---

## ä¸ƒã€LayerTilemaps.WorldToCell() é—®é¢˜

### 7.1 å½“å‰å®ç°

```csharp
public Vector3Int WorldToCell(Vector3 worldPosition)
{
    if (farmlandTilemap == null) return Vector3Int.zero;  // â† ä½¿ç”¨æ—§ç‰ˆå­—æ®µ
    return farmlandTilemap.WorldToCell(worldPosition);
}
```

### 7.2 é—®é¢˜

å¦‚æœç”¨æˆ·åªé…ç½®äº† `farmlandCenterTilemap`ï¼ˆæ–°ç‰ˆï¼‰ï¼Œæ²¡æœ‰é…ç½® `farmlandTilemap`ï¼ˆæ—§ç‰ˆï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å› `Vector3Int.zero`ï¼Œå¯¼è‡´æ‰€æœ‰åæ ‡è½¬æ¢å¤±è´¥ã€‚

### 7.3 ä¿®å¤æ–¹æ¡ˆ

```csharp
public Vector3Int WorldToCell(Vector3 worldPosition)
{
    // ä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆå­—æ®µ
    if (farmlandCenterTilemap != null)
        return farmlandCenterTilemap.WorldToCell(worldPosition);
    
    // å…¼å®¹æ—§ç‰ˆå­—æ®µ
    if (farmlandTilemap != null)
        return farmlandTilemap.WorldToCell(worldPosition);
    
    // ä½¿ç”¨åœ°é¢ Tilemap ä½œä¸ºåå¤‡
    if (groundTilemap != null)
        return groundTilemap.WorldToCell(worldPosition);
    
    return Vector3Int.zero;
}

public Vector3 GetCellCenterWorld(Vector3Int cellPosition)
{
    // ä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆå­—æ®µ
    if (farmlandCenterTilemap != null)
        return farmlandCenterTilemap.GetCellCenterWorld(cellPosition);
    
    // å…¼å®¹æ—§ç‰ˆå­—æ®µ
    if (farmlandTilemap != null)
        return farmlandTilemap.GetCellCenterWorld(cellPosition);
    
    // ä½¿ç”¨åœ°é¢ Tilemap ä½œä¸ºåå¤‡
    if (groundTilemap != null)
        return groundTilemap.GetCellCenterWorld(cellPosition);
    
    return Vector3.zero;
}
```

---

## å…«ã€CropManager è®¾è®¡æ¨¡å¼è®¨è®º

### 8.1 å½“å‰è®¾è®¡

```
CropManagerï¼ˆå…¨å±€å•ä¾‹ï¼‰
â”œâ”€â”€ ç®¡ç†æ‰€æœ‰ä½œç‰©å®ä¾‹çš„å­—å…¸
â”‚     Dictionary<(layer, pos), CropController>
â””â”€â”€ è´Ÿè´£ï¼š
      - åˆ›å»ºä½œç‰© GameObject
      - é”€æ¯ä½œç‰© GameObject
      - æ¯æ—¥ç”Ÿé•¿é€»è¾‘
      - æ”¶è·é€»è¾‘
```

### 8.2 ç”¨æˆ·æœŸæœ›çš„è®¾è®¡ï¼ˆç±»ä¼¼ TreeControllerï¼‰

```
æ¯ä¸ªä½œç‰© GameObject
â””â”€â”€ CropControllerï¼ˆç‹¬ç«‹ç»„ä»¶ï¼‰
      - ç®¡ç†è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸ
      - ç®¡ç†è‡ªå·±çš„ç”Ÿé•¿é˜¶æ®µ
      - ç®¡ç†è‡ªå·±çš„ Sprite åˆ‡æ¢
      - å“åº”å¤–éƒ¨äº‹ä»¶ï¼ˆæµ‡æ°´ã€æ”¶è·ï¼‰
```

### 8.3 åˆ†æ

**å½“å‰è®¾è®¡çš„ä¼˜ç‚¹**ï¼š
- é›†ä¸­ç®¡ç†ï¼Œä¾¿äºæ‰¹é‡æ“ä½œï¼ˆå¦‚æ¯æ—¥ç”Ÿé•¿ï¼‰
- æ•°æ®å’Œ GameObject åˆ†ç¦»ï¼Œä¾¿äºåºåˆ—åŒ–

**å½“å‰è®¾è®¡çš„ç¼ºç‚¹**ï¼š
- ä¸é¡¹ç›®ä¸­å…¶ä»–ç±»ä¼¼ç³»ç»Ÿï¼ˆTreeControllerã€StoneControllerï¼‰é£æ ¼ä¸ä¸€è‡´
- CropManager æ‰¿æ‹…äº†å¤ªå¤šèŒè´£
- å¢åŠ äº†ç†è§£å’Œç»´æŠ¤çš„å¤æ‚åº¦

### 8.4 å»ºè®®

**å½“å‰é˜¶æ®µ**ï¼šä¿æŒç°æœ‰è®¾è®¡ï¼Œä¼˜å…ˆå®Œæˆè€•åœ°å’Œæµ‡æ°´åŠŸèƒ½

**åç»­é˜¶æ®µ**ï¼šé‡æ„ CropManagerï¼Œè®© CropController ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸ
- CropManager åªä½œä¸º"å·¥å‚"æˆ–"æ³¨å†Œè¡¨"
- CropController ç®¡ç†è‡ªå·±çš„ç”Ÿé•¿ã€æ¯èã€æ”¶è·
- ç±»ä¼¼ TreeControllerV2 çš„è®¾è®¡

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒé—®é¢˜

1. **P1**ï¼šGameInputManager ä¾èµ– FarmingManagerNew.Instanceï¼ˆè‡´å‘½ï¼‰
2. **P2**ï¼šFarmVisualManager ä½¿ç”¨æ—§ç‰ˆ Tilemap å­—æ®µï¼ˆé«˜ï¼‰
3. **P3**ï¼šLayerTilemaps.WorldToCell() ä½¿ç”¨æ—§ç‰ˆå­—æ®µï¼ˆé«˜ï¼‰

### 9.2 æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆ Cï¼šæ¸è¿›å¼é‡æ„**

- é˜¶æ®µ 1ï¼šä¿®æ”¹ GameInputManager ç›´æ¥è°ƒç”¨ FarmTileManagerï¼ˆè®©é”„åœ°å·¥ä½œï¼‰
- é˜¶æ®µ 2ï¼šä¿®æ”¹æµ‡æ°´é€»è¾‘ï¼ˆè®©æµ‡æ°´å·¥ä½œï¼‰
- é˜¶æ®µ 3ï¼šæ·»åŠ æ¹¿æ¶¦è§†è§‰æ•ˆæœï¼ˆä»£ç å®ç°ï¼‰
- é˜¶æ®µ 4ï¼šæ¸…ç†æ—§ä»£ç 

### 9.3 ä¸‹ä¸€æ­¥

ç­‰å¾…ç”¨æˆ·å®¡æ ¸æœ¬æŠ¥å‘Šï¼Œç¡®è®¤é‡æ„æ–¹æ¡ˆåå¼€å§‹æ‰§è¡Œã€‚

---

**æ–‡æ¡£ç»´æŠ¤è€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2026-01-26
