using UnityEngine;
using UnityEngine.Tilemaps;
using System.Collections.Generic;

namespace FarmGame.Farm
{
    /// <summary>
    /// å†œç”°å·¥å…·é¢„è§ˆç»„ä»¶
    /// è´Ÿè´£æ˜¾ç¤ºé”„å¤´/æ°´å£¶çš„é¢„è§ˆæ•ˆæœ
    /// 
    /// ç‰¹æ€§ï¼š
    /// - è‡ªç”Ÿèƒ½åŠ›ï¼šAwake æ—¶è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„ GhostTilemap å’Œ CursorRenderer
    /// - 1+8 é¢„è§ˆï¼šé”„å¤´æ˜¾ç¤ºä¸­å¿ƒå— + å‘¨å›´ 8 æ ¼è¾¹ç•Œå˜åŒ–
    /// - é¢œè‰²åé¦ˆï¼šç»¿è‰²=å¯ç”¨ï¼Œçº¢è‰²=ä¸å¯ç”¨ï¼Œè“è‰²=æµ‡æ°´
    /// </summary>
    public class FarmToolPreview : MonoBehaviour
    {
        #region å•ä¾‹ï¼ˆLazy Singletonï¼‰
        
        private static FarmToolPreview _instance;
        
        /// <summary>
        /// å•ä¾‹è®¿é—®å™¨ï¼ˆLazy Singletonï¼‰
        /// å¦‚æœåœºæ™¯ä¸­æ²¡æœ‰ FarmToolPreviewï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª
        /// </summary>
        public static FarmToolPreview Instance
        {
            get
            {
                if (_instance == null)
                {
                    // å…ˆå°è¯•åœ¨åœºæ™¯ä¸­æŸ¥æ‰¾
                    _instance = FindFirstObjectByType<FarmToolPreview>();
                    
                    if (_instance == null)
                    {
                        // ğŸ”¥ çœŸæ­£çš„è‡ªç”Ÿèƒ½åŠ›ï¼šå¦‚æœåœºæ™¯æ²¡æœ‰ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ª
                        var go = new GameObject("FarmToolPreview_AutoGenerated");
                        _instance = go.AddComponent<FarmToolPreview>();
                        Debug.Log("[FarmToolPreview] è‡ªåŠ¨åˆ›å»ºå®ä¾‹ï¼ˆåœºæ™¯ä¸­æœªæ‰¾åˆ°ï¼‰");
                    }
                }
                return _instance;
            }
        }
        
        #endregion
        
        #region é¢„è§ˆçŠ¶æ€æšä¸¾
        
        public enum FarmPreviewState
        {
            Hidden,     // éšè—
            Valid,      // æœ‰æ•ˆï¼ˆç»¿è‰²ï¼‰
            Invalid     // æ— æ•ˆï¼ˆçº¢è‰²ï¼‰
        }
        
        // ğŸ”¥ 9.0.5 æ–°å¢ï¼šæµ‡æ°´å¤±è´¥åŸå› 
        public enum WateringFailureReason
        {
            None,           // æ— å¤±è´¥
            NoFarmland,     // æ²¡æœ‰è€•åœ°æ•°æ®
            NotTilled,      // æœªè€•ä½œ
            AlreadyWatered, // å·²æµ‡æ°´
            HasObstacle,    // æœ‰éšœç¢ç‰©
            ManagerNull     // FarmTileManager ä¸º null
        }
        
        #endregion
        
        #region é…ç½®
        
        [Header("å…‰æ ‡é…ç½®")]
        [Tooltip("å…‰æ ‡ Spriteï¼ˆæ–¹å½¢æ¡†ï¼‰")]
        [SerializeField] private Sprite cursorSprite;
        
        [Tooltip("æœ‰æ•ˆæ—¶çš„é¢œè‰²ï¼ˆç»¿è‰²ï¼‰")]
        [SerializeField] private Color validColor = new Color(0f, 1f, 0f, 0.5f);
        
        [Tooltip("æ— æ•ˆæ—¶çš„é¢œè‰²ï¼ˆçº¢è‰²ï¼‰")]
        [SerializeField] private Color invalidColor = new Color(1f, 0f, 0f, 0.5f);
        
        [Tooltip("æµ‡æ°´æ—¶çš„é¢œè‰²ï¼ˆè“è‰²ï¼‰")]
        [SerializeField] private Color wateringColor = new Color(0f, 0.5f, 1f, 0.5f);
        
        [Header("é¢„è§ˆé€æ˜åº¦")]
        [SerializeField, Range(0.1f, 1f)] private float previewAlpha = 0.5f;
        
        [Header("Debug")]
        [SerializeField] private bool showDebugInfo = false;
        
        #endregion
        
        #region è¿è¡Œæ—¶å¼•ç”¨ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
        
        private Tilemap ghostTilemap;
        private TilemapRenderer ghostTilemapRenderer;
        private SpriteRenderer cursorRenderer;
        
        #endregion
        
        #region çŠ¶æ€
        
        private FarmPreviewState currentState = FarmPreviewState.Hidden;
        private Vector3Int lastCellPosition;
        private int lastLayerIndex = -1;
        private bool isHoeMode = false; // true=é”„å¤´, false=æ°´å£¶
        private bool isSeedMode = false; // ğŸ”¥ æ–°å¢ï¼šç§å­æ¨¡å¼
        
        // ğŸ”¥ æ–°å¢ï¼šå½“å‰ Sorting Layer ç¼“å­˜
        private string currentSortingLayer = "Layer 1";
        
        // ğŸ”¥ 9.0.4 æ–°å¢ï¼šå…¬å¼€å±æ€§ä¾› GameInputManager æŸ¥è¯¢
        /// <summary>
        /// å½“å‰ç›®æ ‡æ˜¯å¦åœ¨ä½¿ç”¨è·ç¦»å†…
        /// </summary>
        public bool IsInRange { get; private set; }
        
        /// <summary>
        /// å½“å‰å…‰æ ‡ä½ç½®ï¼ˆæ ¼å­ä¸­å¿ƒä¸–ç•Œåæ ‡ï¼‰
        /// </summary>
        public Vector3 CurrentCursorPos { get; private set; }
        
        /// <summary>
        /// å½“å‰ç›®æ ‡çš„æ ¼å­åæ ‡
        /// </summary>
        public Vector3Int CurrentCellPos { get; private set; }
        
        /// <summary>
        /// å½“å‰ç›®æ ‡çš„æ¥¼å±‚ç´¢å¼•
        /// </summary>
        public int CurrentLayerIndex { get; private set; }
        
        // ğŸ”¥ æ–°å¢ï¼šç§å­é¢œè‰²
        [Header("ç§å­é¢„è§ˆé…ç½®")]
        [SerializeField] private Color seedValidColor = new Color(0f, 0.8f, 0.2f, 0.6f);
        [SerializeField] private Color seedInvalidColor = new Color(1f, 0.2f, 0f, 0.6f);
        
        // ç¼“å­˜å½“å‰é¢„è§ˆçš„ Tilesï¼ˆç”¨äºæ¸…é™¤ï¼‰
        private HashSet<Vector3Int> currentPreviewPositions = new HashSet<Vector3Int>();
        
        // ğŸ”¥ è¯Šæ–­æ—¥å¿—å»é‡æ ‡å¿—
        private bool _hasLoggedDiagnostics = false;
        private bool _hasLoggedPreviewTiles = false;
        
        // === ğŸ”¥ 9.0.5 æ–°å¢ï¼šé”å®šæœºåˆ¶ ===
        private bool _isLocked = false;
        private Vector3 _lockedWorldPosition;
        private Vector3Int _lockedCellPos;
        private int _lockedLayerIndex;
        
        // ğŸ”¥ 9.0.5 æ–°å¢ï¼šæµ‡æ°´å¤±è´¥åŸå› 
        public WateringFailureReason LastWateringFailure { get; private set; } = WateringFailureReason.None;
        
        #endregion
        
        #region ç”Ÿå‘½å‘¨æœŸ
        
        private void Awake()
        {
            if (_instance == null)
            {
                _instance = this;
                EnsureComponents();
            }
            else if (_instance != this)
            {
                Destroy(gameObject);
            }
        }
        
        private void OnDestroy()
        {
            if (_instance == this)
            {
                _instance = null;
            }
        }
        
        /// <summary>
        /// è‡ªç”Ÿèƒ½åŠ›ï¼šç¡®ä¿æ‰€æœ‰å¿…è¦ç»„ä»¶å­˜åœ¨
        /// </summary>
        private void EnsureComponents()
        {
            // ğŸ”¥ é¦–å…ˆç¡®ä¿æœ‰ Grid ç»„ä»¶ï¼ˆTilemap å¿…é¡»åœ¨ Grid ä¸‹æ‰èƒ½æ­£ç¡®æ˜¾ç¤ºï¼‰
            var grid = GetComponent<Grid>();
            if (grid == null)
            {
                grid = gameObject.AddComponent<Grid>();
                grid.cellSize = new Vector3(1f, 1f, 0f); // æ ‡å‡† 1x1 æ ¼å­
                grid.cellGap = Vector3.zero;
                grid.cellLayout = GridLayout.CellLayout.Rectangle;
                grid.cellSwizzle = GridLayout.CellSwizzle.XYZ;
            }
            
            // 1. ç¡®ä¿ GhostTilemap å­˜åœ¨
            if (ghostTilemap == null)
            {
                var ghostGO = transform.Find("GhostTilemap");
                if (ghostGO == null)
                {
                    ghostGO = new GameObject("GhostTilemap").transform;
                    ghostGO.SetParent(transform);
                    ghostGO.localPosition = Vector3.zero;
                }
                
                ghostTilemap = ghostGO.GetComponent<Tilemap>();
                if (ghostTilemap == null)
                {
                    ghostTilemap = ghostGO.gameObject.AddComponent<Tilemap>();
                }
                
                ghostTilemapRenderer = ghostGO.GetComponent<TilemapRenderer>();
                if (ghostTilemapRenderer == null)
                {
                    ghostTilemapRenderer = ghostGO.gameObject.AddComponent<TilemapRenderer>();
                }
                
                // è®¾ç½® Sorting Layerï¼ˆä½¿ç”¨é¡¹ç›®ä¸­å­˜åœ¨çš„ Layer 1ï¼Œé«˜ sortingOrder ç¡®ä¿åœ¨åœ°é¢ä¹‹ä¸Šï¼‰
                ghostTilemapRenderer.sortingLayerName = "Layer 1";
                ghostTilemapRenderer.sortingOrder = 9999; // æé«˜å€¼ç¡®ä¿åœ¨æ‰€æœ‰åœ°é¢ Tile ä¹‹ä¸Š
                
                // è®¾ç½®é€æ˜åº¦
                ghostTilemap.color = new Color(1f, 1f, 1f, previewAlpha);
                
                if (showDebugInfo)
                    Debug.Log("[FarmToolPreview] è‡ªåŠ¨åˆ›å»º GhostTilemapï¼ˆå« Gridï¼‰");
            }
            
            // 2. ç¡®ä¿ CursorRenderer å­˜åœ¨
            if (cursorRenderer == null)
            {
                var cursorGO = transform.Find("CursorRenderer");
                if (cursorGO == null)
                {
                    cursorGO = new GameObject("CursorRenderer").transform;
                    cursorGO.SetParent(transform);
                    cursorGO.localPosition = Vector3.zero;
                }
                
                cursorRenderer = cursorGO.GetComponent<SpriteRenderer>();
                if (cursorRenderer == null)
                {
                    cursorRenderer = cursorGO.gameObject.AddComponent<SpriteRenderer>();
                }
                
                // è®¾ç½® Sorting Layerï¼ˆä½¿ç”¨é¡¹ç›®ä¸­å­˜åœ¨çš„ Layer 1ï¼Œé«˜ sortingOrder ç¡®ä¿åœ¨é¢„è§ˆ Tilemap ä¹‹ä¸Šï¼‰
                cursorRenderer.sortingLayerName = "Layer 1";
                cursorRenderer.sortingOrder = 10000; // æ¯” ghostTilemap æ›´é«˜
                
                // è®¾ç½® Spriteï¼ˆå¦‚æœæ²¡æœ‰é…ç½®ï¼Œç¨‹åºåŒ–ç”Ÿæˆä¸€ä¸ªç™½è‰²æ–¹æ¡†ï¼‰
                if (cursorSprite != null)
                {
                    cursorRenderer.sprite = cursorSprite;
                }
                else
                {
                    // ğŸ”¥ ç¨‹åºåŒ–ç”Ÿæˆå…‰æ ‡ Spriteï¼ˆ1x1 ç™½è‰² Textureï¼‰
                    cursorRenderer.sprite = CreateProceduralCursorSprite();
                    if (showDebugInfo)
                        Debug.Log("[FarmToolPreview] ç¨‹åºåŒ–ç”Ÿæˆå…‰æ ‡ Spriteï¼ˆæœªé…ç½® cursorSpriteï¼‰");
                }
                
                if (showDebugInfo)
                    Debug.Log("[FarmToolPreview] è‡ªåŠ¨åˆ›å»º CursorRenderer");
            }
        }
        
        #endregion
        
        #region å…¬å¼€æ¥å£
        
        // === ğŸ”¥ 9.0.5 æ–°å¢ï¼šé”å®šæœºåˆ¶å…¬å¼€æ¥å£ ===
        
        /// <summary>
        /// æ˜¯å¦å¤„äºé”å®šçŠ¶æ€
        /// </summary>
        public bool IsLocked => _isLocked;
        
        /// <summary>
        /// é”å®šæ—¶çš„ä¸–ç•Œåæ ‡ï¼ˆä¾›å¯¼èˆªå›è°ƒä¸­è·ç¦»æ ¡éªŒä½¿ç”¨ï¼‰
        /// </summary>
        public Vector3 LockedWorldPos => _lockedWorldPosition;
        
        /// <summary>
        /// é”å®šæ—¶çš„æ ¼å­åæ ‡ï¼ˆä¾›å¯¼èˆªä¸­åŒä½ç½®æ£€æµ‹ä½¿ç”¨ï¼‰
        /// </summary>
        public Vector3Int LockedCellPos => _lockedCellPos;
        
        /// <summary>
        /// é”å®šé¢„è§ˆä½ç½®ï¼ˆç‚¹å‡»åè°ƒç”¨ï¼‰
        /// å†»ç»“è§†è§‰æ˜¾ç¤ºï¼Œä½†å®æ—¶æ•°æ®ç»§ç»­æ›´æ–°
        /// </summary>
        public void LockPosition(Vector3 worldPos, Vector3Int cellPos, int layerIndex)
        {
            _isLocked = true;
            _lockedWorldPosition = worldPos;
            _lockedCellPos = cellPos;
            _lockedLayerIndex = layerIndex;
            
            // ğŸ”¥ 10.1.1è¡¥ä¸002 P3 ä¿®å¤ï¼šé”å®šæ—¶æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„ GhostTilemap æ¸²æŸ“ï¼ˆä»…é”„å¤´æ¨¡å¼ï¼‰
            if (isHoeMode && FarmlandBorderManager.Instance != null)
            {
                ClearGhostTilemap();
                
                // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦å¯ä»¥é”„åœ°
                bool canTill = FarmTileManager.Instance != null &&
                               FarmTileManager.Instance.CanTillAt(layerIndex, cellPos);
                
                // ä¹Ÿæ£€æŸ¥æ¯èä½œç‰©æ¸…é™¤ï¼ˆä¸ UpdateHoePreview é€»è¾‘ä¸€è‡´ï¼‰
                bool canClearWithered = false;
                if (!canTill && FarmTileManager.Instance != null)
                {
                    var tileData = FarmTileManager.Instance.GetTileData(layerIndex, cellPos);
                    if (tileData?.cropController != null &&
                        tileData.cropController.GetState() == CropState.WitheredImmature)
                        canClearWithered = true;
                }
                
                if (canTill)
                {
                    var previewTiles = FarmlandBorderManager.Instance.GetPreviewTiles(layerIndex, cellPos);
                    foreach (var kvp in previewTiles)
                    {
                        if (kvp.Value != null)
                        {
                            ghostTilemap.SetTile(kvp.Key, kvp.Value);
                            currentPreviewPositions.Add(kvp.Key);
                        }
                    }
                }
            }
            
            // ğŸ”¥ 10.1.0 AC-1.4ï¼šé”å®šæ—¶è‡ªåŠ¨åˆ·æ–°è§†è§‰åˆ°é”å®šä½ç½®ï¼ˆæ¶ˆé™¤åŒå¸§è§£é”+é‡é”çš„è§†è§‰è·³å˜ï¼‰
            UpdateCursor(layerIndex, cellPos);
            
            if (showDebugInfo)
                Debug.Log($"[FarmToolPreview] LockPosition: pos={worldPos}, cell={cellPos}, layer={layerIndex}");
        }
        
        /// <summary>
        /// è§£é”é¢„è§ˆä½ç½®ï¼ˆæ‰§è¡Œå®Œæˆ/å–æ¶ˆåè°ƒç”¨ï¼‰
        /// æ¢å¤è§†è§‰è·Ÿéšé¼ æ ‡
        /// </summary>
        public void UnlockPosition()
        {
            _isLocked = false;
            
            if (showDebugInfo)
                Debug.Log("[FarmToolPreview] UnlockPosition");
        }
        
        /// <summary>
        /// ğŸ”¥ é‡æ„ï¼šæ›´æ–°é”„å¤´é¢„è§ˆ
        /// æ–°å¢å‚æ•°ï¼šplayerTransform å’Œ reach ç”¨äºè·ç¦»æ£€æµ‹
        /// ğŸ”¥ 9.0.4ï¼šIsValid ä¸å†åŒ…å«è·ç¦»åˆ¤æ–­ï¼Œè·ç¦»çŠ¶æ€å•ç‹¬è®°å½•åˆ° IsInRange
        /// </summary>
        /// <param name="layerIndex">æ¥¼å±‚ç´¢å¼•</param>
        /// <param name="cellPos">æ ¼å­åæ ‡</param>
        /// <param name="playerTransform">ç©å®¶ Transformï¼ˆç”¨äºè·ç¦»æ£€æµ‹å’Œ Layer åŒæ­¥ï¼‰</param>
        /// <param name="reach">å·¥å…·ä½¿ç”¨è·ç¦»</param>
        public void UpdateHoePreview(int layerIndex, Vector3Int cellPos, Transform playerTransform = null, float reach = 1.5f)
        {
            isHoeMode = true;
            isSeedMode = false;
            
            // ğŸ”¥ ä¸€æ¬¡æ€§è¯Šæ–­æ—¥å¿—ï¼ˆåªåœ¨é¦–æ¬¡è°ƒç”¨æ—¶è¾“å‡ºï¼‰
            LogDiagnosticsOnce();
            
            // ğŸ”¥ Step 1: æ›´æ–° Sorting Layerï¼ˆè·Ÿéšç©å®¶æ¥¼å±‚ï¼‰
            if (playerTransform != null)
            {
                UpdateSortingLayer(playerTransform);
            }
            
            // è·å–æ ¼å­ä¸­å¿ƒä¸–ç•Œåæ ‡
            Vector3 cellCenter = GetCellCenterWorld(layerIndex, cellPos);
            
            // ğŸ”¥ Step 2: éšœç¢ç‰©æ£€æµ‹ï¼ˆä½¿ç”¨ HasFarmingObstacleï¼Œä¸æ£€æµ‹ Playerï¼‰
            bool hasObstacle = PlacementValidator.HasFarmingObstacle(cellCenter);
            
            // ğŸ”¥ Step 3: æ£€æŸ¥æ˜¯å¦å¯ä»¥é”„åœ°
            bool canTill = FarmTileManager.Instance != null && 
                           FarmTileManager.Instance.CanTillAt(layerIndex, cellPos);
            
            // ğŸ”¥ 10.X çº æ­£ï¼šé€šè¿‡ FarmTileData.cropController æŸ¥æ‰¾æ¯èä½œç‰©ï¼ˆæ›¿ä»£ CropManager.GetCropï¼‰
            bool canClearWithered = false;
            if (!canTill && FarmTileManager.Instance != null)
            {
                var tileData = FarmTileManager.Instance.GetTileData(layerIndex, cellPos);
                if (tileData?.cropController != null && tileData.cropController.GetState() == CropState.WitheredImmature)
                    canClearWithered = true;
            }
            
            // ğŸ”¥ 9.0.4 ä¿®æ”¹ï¼šIsValid ä¸å†åŒ…å«è·ç¦»åˆ¤æ–­
            bool isValid = !hasObstacle && (canTill || canClearWithered);
            
            // æ›´æ–°çŠ¶æ€
            currentState = isValid ? FarmPreviewState.Valid : FarmPreviewState.Invalid;
            
            // ğŸ”¥ 9.0.5ï¼šæ°¸è¿œæ›´æ–°å®æ—¶æ•°æ®ï¼ˆä¸ç®¡æ˜¯å¦é”å®šï¼‰
            UpdateRealtimeData(layerIndex, cellPos, cellCenter, playerTransform, reach);
            
            // ğŸ”¥ 9.0.5ï¼šé”å®šçŠ¶æ€ä¸‹ä¸æ›´æ–°è§†è§‰
            if (_isLocked) return;
            
            // æ¸…é™¤æ—§é¢„è§ˆ
            ClearGhostTilemap();
            
            // å¦‚æœå¯ä»¥é”„åœ°ï¼Œæ˜¾ç¤º 1+8 é¢„è§ˆ
            if (canTill && FarmlandBorderManager.Instance != null)
            {
                var previewTiles = FarmlandBorderManager.Instance.GetPreviewTiles(layerIndex, cellPos);
                
                // ğŸ”¥ è¯Šæ–­ï¼šæ£€æŸ¥ previewTiles æ˜¯å¦ä¸ºç©ºï¼ˆä¸€æ¬¡æ€§è¾“å‡ºï¼Œä¸ä¾èµ– showDebugInfoï¼‰
                if (!_hasLoggedPreviewTiles)
                {
                    _hasLoggedPreviewTiles = true;
                    Debug.Log($"[FarmToolPreview] GetPreviewTiles è¿”å› {previewTiles.Count} ä¸ª Tile");
                    foreach (var kvp in previewTiles)
                    {
                        Debug.Log($"  - {kvp.Key}: {(kvp.Value != null ? kvp.Value.name : "null")}");
                    }
                }
                
                foreach (var kvp in previewTiles)
                {
                    if (kvp.Value != null)
                    {
                        ghostTilemap.SetTile(kvp.Key, kvp.Value);
                        currentPreviewPositions.Add(kvp.Key);
                    }
                }
            }
            else if (!_hasLoggedPreviewTiles)
            {
                _hasLoggedPreviewTiles = true;
                Debug.Log($"[FarmToolPreview] è·³è¿‡ 1+8 é¢„è§ˆ: canTill={canTill}, BorderManager={(FarmlandBorderManager.Instance != null ? "å­˜åœ¨" : "null")}");
            }
            
            // æ›´æ–°å…‰æ ‡
            UpdateCursor(layerIndex, cellPos);
            
            // è®°å½•ä½ç½®
            lastCellPosition = cellPos;
            lastLayerIndex = layerIndex;
            
            // æ˜¾ç¤º
            Show();
        }
        
        /// <summary>
        /// ğŸ”¥ é‡æ„ï¼šæ›´æ–°æ°´å£¶é¢„è§ˆ
        /// æ–°å¢å‚æ•°ï¼šplayerTransform å’Œ reach ç”¨äºè·ç¦»æ£€æµ‹
        /// ğŸ”¥ 9.0.4ï¼šIsValid ä¸å†åŒ…å«è·ç¦»åˆ¤æ–­ï¼Œè·ç¦»çŠ¶æ€å•ç‹¬è®°å½•åˆ° IsInRange
        /// </summary>
        public void UpdateWateringPreview(int layerIndex, Vector3Int cellPos, Transform playerTransform = null, float reach = 1.5f)
        {
            isHoeMode = false;
            isSeedMode = false;
            
            // ğŸ”¥ Step 1: æ›´æ–° Sorting Layer
            if (playerTransform != null)
            {
                UpdateSortingLayer(playerTransform);
            }
            
            // è·å–æ ¼å­ä¸­å¿ƒä¸–ç•Œåæ ‡
            Vector3 cellCenter = GetCellCenterWorld(layerIndex, cellPos);
            
            // ğŸ”¥ Step 2: éšœç¢ç‰©æ£€æµ‹
            bool hasObstacle = PlacementValidator.HasFarmingObstacle(cellCenter);
            
            // ğŸ”¥ Step 3: æ£€æŸ¥æ˜¯å¦å¯ä»¥æµ‡æ°´
            var tileData = FarmTileManager.Instance?.GetTileData(layerIndex, cellPos);
            bool canWater = tileData != null && 
                            tileData.isTilled && 
                            !tileData.wateredToday;
            
            // ğŸ”¥ 9.0.5ï¼šè®°å½•æµ‡æ°´å¤±è´¥åŸå› 
            if (hasObstacle)
                LastWateringFailure = WateringFailureReason.HasObstacle;
            else if (FarmTileManager.Instance == null)
                LastWateringFailure = WateringFailureReason.ManagerNull;
            else if (tileData == null)
                LastWateringFailure = WateringFailureReason.NoFarmland;
            else if (!tileData.isTilled)
                LastWateringFailure = WateringFailureReason.NotTilled;
            else if (tileData.wateredToday)
                LastWateringFailure = WateringFailureReason.AlreadyWatered;
            else
                LastWateringFailure = WateringFailureReason.None;
            
            // ğŸ”¥ 9.0.4 ä¿®æ”¹ï¼šIsValid ä¸å†åŒ…å«è·ç¦»åˆ¤æ–­
            bool isValid = !hasObstacle && canWater;
            
            // æ›´æ–°çŠ¶æ€
            currentState = isValid ? FarmPreviewState.Valid : FarmPreviewState.Invalid;
            
            // ğŸ”¥ 9.0.5ï¼šæ°¸è¿œæ›´æ–°å®æ—¶æ•°æ®ï¼ˆä¸ç®¡æ˜¯å¦é”å®šï¼‰
            UpdateRealtimeData(layerIndex, cellPos, cellCenter, playerTransform, reach);
            
            // ğŸ”¥ 9.0.5ï¼šé”å®šçŠ¶æ€ä¸‹ä¸æ›´æ–°è§†è§‰
            if (_isLocked) return;
            
            // æ¸…é™¤æ—§é¢„è§ˆï¼ˆæ°´å£¶ä¸æ˜¾ç¤º 1+8ï¼‰
            ClearGhostTilemap();
            
            // æ›´æ–°å…‰æ ‡
            UpdateCursor(layerIndex, cellPos);
            
            // è®°å½•ä½ç½®
            lastCellPosition = cellPos;
            lastLayerIndex = layerIndex;
            
            // æ˜¾ç¤º
            Show();
        }
        
        /// <summary>
        /// ğŸ”¥ æ–°å¢ï¼šæ›´æ–°ç§å­é¢„è§ˆ
        /// åªæ˜¾ç¤ºçº¢/ç»¿å…‰æ ‡ï¼Œéšè— GhostTilemap
        /// ğŸ”¥ 9.0.4ï¼šIsValid ä¸å†åŒ…å«è·ç¦»åˆ¤æ–­ï¼Œè·ç¦»çŠ¶æ€å•ç‹¬è®°å½•åˆ° IsInRange
        /// </summary>
        /// <param name="alignedPos">å¯¹é½åçš„ä¸–ç•Œåæ ‡ï¼ˆæ ¼å­ä¸­å¿ƒï¼‰</param>
        /// <param name="seedData">ç§å­æ•°æ®</param>
        /// <param name="playerTransform">ç©å®¶ Transform</param>
        /// <param name="reach">ç§æ¤è·ç¦»</param>
        public void UpdateSeedPreview(Vector3 alignedPos, FarmGame.Data.SeedData seedData, Transform playerTransform = null, float reach = 1.5f)
        {
            isHoeMode = false;
            isSeedMode = true;
            
            // ğŸ”¥ Step 1: æ›´æ–° Sorting Layer
            if (playerTransform != null)
            {
                UpdateSortingLayer(playerTransform);
            }
            
            // è·å–æ¥¼å±‚å’Œæ ¼å­åæ ‡
            var farmTileManager = FarmTileManager.Instance;
            if (farmTileManager == null)
            {
                currentState = FarmPreviewState.Invalid;
                IsInRange = false;
                UpdateCursorForSeed(alignedPos, false);
                Show();
                return;
            }
            
            int layerIndex = farmTileManager.GetCurrentLayerIndex(alignedPos);
            var tilemaps = farmTileManager.GetLayerTilemaps(layerIndex);
            
            if (tilemaps == null)
            {
                currentState = FarmPreviewState.Invalid;
                IsInRange = false;
                UpdateCursorForSeed(alignedPos, false);
                Show();
                return;
            }
            
            Vector3Int cellPos = tilemaps.WorldToCell(alignedPos);
            
            // ğŸ”¥ Step 2: éšœç¢ç‰©æ£€æµ‹
            bool hasObstacle = PlacementValidator.HasFarmingObstacle(alignedPos);
            
            // ğŸ”¥ Step 3: æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§æ¤
            var tileData = farmTileManager.GetTileData(layerIndex, cellPos);
            bool canPlant = tileData != null && tileData.CanPlant();
            
            // ğŸ”¥ Step 5: æ£€æŸ¥å­£èŠ‚ï¼ˆå¯é€‰ï¼‰
            bool correctSeason = true;
            if (seedData != null && TimeManager.Instance != null)
            {
                if (seedData.season != FarmGame.Data.Season.AllSeason)
                {
                    var currentSeason = TimeManager.Instance.GetSeason();
                    correctSeason = (int)seedData.season == (int)currentSeason;
                }
            }
            
            // ğŸ”¥ 9.0.4 ä¿®æ”¹ï¼šIsValid ä¸å†åŒ…å«è·ç¦»åˆ¤æ–­
            bool isValid = !hasObstacle && canPlant && correctSeason;
            
            // æ›´æ–°çŠ¶æ€
            currentState = isValid ? FarmPreviewState.Valid : FarmPreviewState.Invalid;
            
            // ğŸ”¥ 9.0.5ï¼šæ°¸è¿œæ›´æ–°å®æ—¶æ•°æ®ï¼ˆä¸ç®¡æ˜¯å¦é”å®šï¼‰
            UpdateRealtimeData(layerIndex, cellPos, alignedPos, playerTransform, reach);
            
            // ğŸ”¥ 9.0.5ï¼šé”å®šçŠ¶æ€ä¸‹ä¸æ›´æ–°è§†è§‰
            if (_isLocked) return;
            
            // ğŸ”¥ ç§å­æ¨¡å¼ï¼šéšè— GhostTilemapï¼Œåªæ˜¾ç¤ºå…‰æ ‡
            ClearGhostTilemap();
            if (ghostTilemap != null)
            {
                ghostTilemap.gameObject.SetActive(false);
            }
            
            // æ›´æ–°å…‰æ ‡ï¼ˆä½¿ç”¨ç§å­é¢œè‰²ï¼‰
            UpdateCursorForSeed(alignedPos, isValid);
            
            // è®°å½•ä½ç½®
            lastCellPosition = cellPos;
            lastLayerIndex = layerIndex;
            
            // æ˜¾ç¤ºå…‰æ ‡
            if (cursorRenderer != null)
            {
                cursorRenderer.gameObject.SetActive(true);
            }
        }
        
        /// <summary>
        /// æ˜¾ç¤ºé¢„è§ˆ
        /// </summary>
        public void Show()
        {
            if (!isSeedMode && ghostTilemap != null)
                ghostTilemap.gameObject.SetActive(true);
            if (cursorRenderer != null)
                cursorRenderer.gameObject.SetActive(true);
        }
        
        /// <summary>
        /// éšè—é¢„è§ˆ
        /// </summary>
        public void Hide()
        {
            currentState = FarmPreviewState.Hidden;
            isSeedMode = false;
            
            ClearGhostTilemap();
            
            if (ghostTilemap != null)
                ghostTilemap.gameObject.SetActive(false);
            if (cursorRenderer != null)
                cursorRenderer.gameObject.SetActive(false);
        }
        
        /// <summary>
        /// æ£€æŸ¥å½“å‰é¢„è§ˆæ˜¯å¦æœ‰æ•ˆ
        /// </summary>
        public bool IsValid()
        {
            return currentState == FarmPreviewState.Valid;
        }
        
        /// <summary>
        /// è·å–å½“å‰é¢„è§ˆçŠ¶æ€
        /// </summary>
        public FarmPreviewState GetState()
        {
            return currentState;
        }
        
        #endregion
        
        #region å†…éƒ¨æ–¹æ³•
        
        /// <summary>
        /// ğŸ”¥ 9.0.5 æ–°å¢ï¼šè½»é‡çº§å®æ—¶æ•°æ®æ›´æ–°ï¼ˆä¸è§¦ç¢°è§†è§‰æ¸²æŸ“ï¼‰
        /// é”å®šçŠ¶æ€ä¸‹ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œç¡®ä¿ GameInputManager èƒ½è¯»åˆ°æœ€æ–°çš„é¼ æ ‡ä½ç½®æ•°æ®
        /// </summary>
        private void UpdateRealtimeData(int layerIndex, Vector3Int cellPos, Vector3 cellCenter, Transform playerTransform, float reach)
        {
            CurrentCursorPos = cellCenter;
            CurrentCellPos = cellPos;
            CurrentLayerIndex = layerIndex;
            IsInRange = playerTransform != null ? IsWithinReach(playerTransform, cellCenter, reach) : true;
        }
        
        /// <summary>
        /// ğŸ”¥ ä¸€æ¬¡æ€§è¯Šæ–­æ—¥å¿—ï¼ˆåªåœ¨é¦–æ¬¡è°ƒç”¨æ—¶è¾“å‡ºï¼‰
        /// ç”¨äºæ’æŸ¥é¢„è§ˆä¸æ˜¾ç¤ºçš„é—®é¢˜
        /// </summary>
        private void LogDiagnosticsOnce()
        {
            if (_hasLoggedDiagnostics) return;
            _hasLoggedDiagnostics = true;
            
            Debug.Log("=== [FarmToolPreview] è¯Šæ–­ä¿¡æ¯ ===");
            
            // 1. æ£€æŸ¥ GhostTilemap
            if (ghostTilemap == null)
            {
                Debug.LogError("[FarmToolPreview] âŒ ghostTilemap ä¸º null");
            }
            else
            {
                Debug.Log($"[FarmToolPreview] âœ“ ghostTilemap å­˜åœ¨: {ghostTilemap.gameObject.name}");
                Debug.Log($"  - active: {ghostTilemap.gameObject.activeSelf}");
                Debug.Log($"  - parent Grid: {(ghostTilemap.layoutGrid != null ? ghostTilemap.layoutGrid.name : "null")}");
            }
            
            // 2. æ£€æŸ¥ GhostTilemapRenderer
            if (ghostTilemapRenderer == null)
            {
                Debug.LogError("[FarmToolPreview] âŒ ghostTilemapRenderer ä¸º null");
            }
            else
            {
                Debug.Log($"[FarmToolPreview] âœ“ ghostTilemapRenderer å­˜åœ¨");
                Debug.Log($"  - sortingLayerName: {ghostTilemapRenderer.sortingLayerName}");
                Debug.Log($"  - sortingOrder: {ghostTilemapRenderer.sortingOrder}");
                Debug.Log($"  - enabled: {ghostTilemapRenderer.enabled}");
            }
            
            // 3. æ£€æŸ¥ CursorRenderer
            if (cursorRenderer == null)
            {
                Debug.LogError("[FarmToolPreview] âŒ cursorRenderer ä¸º null");
            }
            else
            {
                Debug.Log($"[FarmToolPreview] âœ“ cursorRenderer å­˜åœ¨");
                Debug.Log($"  - sprite: {(cursorRenderer.sprite != null ? cursorRenderer.sprite.name : "null")}");
                Debug.Log($"  - sortingLayerName: {cursorRenderer.sortingLayerName}");
                Debug.Log($"  - sortingOrder: {cursorRenderer.sortingOrder}");
                Debug.Log($"  - color: {cursorRenderer.color}");
                Debug.Log($"  - enabled: {cursorRenderer.enabled}");
                Debug.Log($"  - active: {cursorRenderer.gameObject.activeSelf}");
            }
            
            // 4. æ£€æŸ¥ FarmlandBorderManager
            if (FarmlandBorderManager.Instance == null)
            {
                Debug.LogError("[FarmToolPreview] âŒ FarmlandBorderManager.Instance ä¸º nullï¼ˆåœºæ™¯ä¸­æ²¡æœ‰æ­¤ç»„ä»¶ï¼‰");
            }
            else
            {
                Debug.Log("[FarmToolPreview] âœ“ FarmlandBorderManager.Instance å­˜åœ¨");
                // éªŒè¯ Tile èµ„æº
                FarmlandBorderManager.Instance.ValidateTileResources();
            }
            
            // 5. æ£€æŸ¥ FarmTileManager
            if (FarmTileManager.Instance == null)
            {
                Debug.LogError("[FarmToolPreview] âŒ FarmTileManager.Instance ä¸º null");
            }
            else
            {
                Debug.Log($"[FarmToolPreview] âœ“ FarmTileManager.Instance å­˜åœ¨, LayerCount={FarmTileManager.Instance.LayerCount}");
            }
            
            // 6. æ£€æŸ¥ Sorting Layer æ˜¯å¦å­˜åœ¨
            Debug.Log("[FarmToolPreview] æ£€æŸ¥ Sorting Layers...");
            var sortingLayers = SortingLayer.layers;
            bool hasGround = false, hasEffects = false;
            foreach (var layer in sortingLayers)
            {
                if (layer.name == "Ground") hasGround = true;
                if (layer.name == "Effects") hasEffects = true;
            }
            Debug.Log($"  - Ground: {(hasGround ? "âœ“ å­˜åœ¨" : "âŒ ä¸å­˜åœ¨")}");
            Debug.Log($"  - Effects: {(hasEffects ? "âœ“ å­˜åœ¨" : "âŒ ä¸å­˜åœ¨")}");
            
            Debug.Log("=== è¯Šæ–­ç»“æŸ ===");
        }
        
        /// <summary>
        /// ğŸ”¥ ç¨‹åºåŒ–ç”Ÿæˆå…‰æ ‡ Sprite
        /// åˆ›å»ºä¸€ä¸ª 16x16 çš„ç™½è‰²æ–¹æ¡†ï¼ˆè¾¹æ¡† 2 åƒç´ ï¼‰
        /// </summary>
        private Sprite CreateProceduralCursorSprite()
        {
            int size = 16;
            int border = 2;
            
            var texture = new Texture2D(size, size, TextureFormat.RGBA32, false);
            texture.filterMode = FilterMode.Point;
            
            var pixels = new Color32[size * size];
            var white = new Color32(255, 255, 255, 255);
            var transparent = new Color32(0, 0, 0, 0);
            
            for (int y = 0; y < size; y++)
            {
                for (int x = 0; x < size; x++)
                {
                    // è¾¹æ¡†åŒºåŸŸä¸ºç™½è‰²ï¼Œå†…éƒ¨é€æ˜
                    bool isBorder = x < border || x >= size - border || 
                                    y < border || y >= size - border;
                    pixels[y * size + x] = isBorder ? white : transparent;
                }
            }
            
            texture.SetPixels32(pixels);
            texture.Apply();
            
            // åˆ›å»º Spriteï¼ˆ16 PPUï¼Œä¸ Tilemap å¯¹é½ï¼‰
            return Sprite.Create(texture, new Rect(0, 0, size, size), new Vector2(0.5f, 0.5f), 16f);
        }
        
        /// <summary>
        /// æ¸…é™¤ GhostTilemap ä¸Šçš„æ‰€æœ‰é¢„è§ˆ Tiles
        /// </summary>
        private void ClearGhostTilemap()
        {
            if (ghostTilemap == null) return;
            
            foreach (var pos in currentPreviewPositions)
            {
                ghostTilemap.SetTile(pos, null);
            }
            currentPreviewPositions.Clear();
        }
        
        /// <summary>
        /// æ›´æ–°å…‰æ ‡ä½ç½®å’Œé¢œè‰²
        /// </summary>
        private void UpdateCursor(int layerIndex, Vector3Int cellPos)
        {
            if (cursorRenderer == null) return;
            
            // è·å–æ ¼å­ä¸­å¿ƒä¸–ç•Œåæ ‡
            var tilemaps = FarmTileManager.Instance?.GetLayerTilemaps(layerIndex);
            Vector3 worldPos;
            
            if (tilemaps != null)
            {
                worldPos = tilemaps.GetCellCenterWorld(cellPos);
            }
            else
            {
                // å›é€€ï¼šä½¿ç”¨ PlacementGridCalculator
                worldPos = PlacementGridCalculator.GetCellCenter(new Vector3(cellPos.x, cellPos.y, 0));
            }
            
            cursorRenderer.transform.position = worldPos;
            
            // è®¾ç½®é¢œè‰²
            Color color;
            if (!isHoeMode && currentState == FarmPreviewState.Valid)
            {
                // æ°´å£¶æœ‰æ•ˆ = è“è‰²
                color = wateringColor;
            }
            else if (currentState == FarmPreviewState.Valid)
            {
                // é”„å¤´æœ‰æ•ˆ = ç»¿è‰²
                color = validColor;
            }
            else
            {
                // æ— æ•ˆ = çº¢è‰²
                color = invalidColor;
            }
            
            cursorRenderer.color = color;
        }
        
        /// <summary>
        /// ğŸ”¥ æ–°å¢ï¼šæ›´æ–°ç§å­æ¨¡å¼çš„å…‰æ ‡
        /// </summary>
        private void UpdateCursorForSeed(Vector3 worldPos, bool isValid)
        {
            if (cursorRenderer == null) return;
            
            cursorRenderer.transform.position = worldPos;
            cursorRenderer.color = isValid ? seedValidColor : seedInvalidColor;
        }
        
        /// <summary>
        /// ğŸ”¥ æ–°å¢ï¼šæ›´æ–° Sorting Layerï¼ˆè·Ÿéšç©å®¶æ¥¼å±‚ï¼‰
        /// </summary>
        private void UpdateSortingLayer(Transform playerTransform)
        {
            if (playerTransform == null) return;
            
            string playerSortingLayer = PlacementLayerDetector.GetPlayerSortingLayer(playerTransform);
            
            // åªåœ¨ Layer å˜åŒ–æ—¶æ›´æ–°
            if (playerSortingLayer != currentSortingLayer)
            {
                currentSortingLayer = playerSortingLayer;
                
                // æ›´æ–° GhostTilemap çš„ Sorting Layer
                if (ghostTilemapRenderer != null)
                {
                    ghostTilemapRenderer.sortingLayerName = currentSortingLayer;
                }
                
                // æ›´æ–° CursorRenderer çš„ Sorting Layer
                if (cursorRenderer != null)
                {
                    cursorRenderer.sortingLayerName = currentSortingLayer;
                }
                
                if (showDebugInfo)
                {
                    Debug.Log($"[FarmToolPreview] Sorting Layer æ›´æ–°ä¸º: {currentSortingLayer}");
                }
            }
        }
        
        /// <summary>
        /// ğŸ”¥ æ–°å¢ï¼šè·å–ç©å®¶ä¸­å¿ƒä½ç½®
        /// </summary>
        private Vector2 GetPlayerCenter(Transform playerTransform)
        {
            if (playerTransform == null) return Vector2.zero;
            
            var collider = playerTransform.GetComponent<Collider2D>();
            return collider != null ? (Vector2)collider.bounds.center : (Vector2)playerTransform.position;
        }
        
        /// <summary>
        /// ğŸ”¥ æ–°å¢ï¼šè·å–æ ¼å­ä¸­å¿ƒä¸–ç•Œåæ ‡
        /// </summary>
        private Vector3 GetCellCenterWorld(int layerIndex, Vector3Int cellPos)
        {
            var tilemaps = FarmTileManager.Instance?.GetLayerTilemaps(layerIndex);
            if (tilemaps != null)
            {
                return tilemaps.GetCellCenterWorld(cellPos);
            }
            
            // å›é€€ï¼šä½¿ç”¨ PlacementGridCalculator
            return PlacementGridCalculator.GetCellCenter(new Vector3(cellPos.x + 0.5f, cellPos.y + 0.5f, 0));
        }
        
        /// <summary>
        /// ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨ä½¿ç”¨è·ç¦»å†…
        /// </summary>
        private bool IsWithinReach(Transform playerTransform, Vector3 targetPos, float reach)
        {
            Vector2 playerCenter = GetPlayerCenter(playerTransform);
            float distance = Vector2.Distance(playerCenter, targetPos);
            return distance <= reach;
        }
        
        #endregion
    }
}
