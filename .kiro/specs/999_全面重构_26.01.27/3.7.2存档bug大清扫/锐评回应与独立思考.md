# é”è¯„å›åº”ä¸ç‹¬ç«‹æ€è€ƒ

**åˆ›å»ºæ—¥æœŸ**: 2026-02-01
**ä½œè€…**: Kiro
**ç›®çš„**: è®°å½•å¯¹é”è¯„001å’Œé”è¯„002çš„ç‹¬ç«‹å®¡è§†ã€ç–‘è™‘å’Œå›åº”

---

## ä¸€ã€é”è¯„001 å›åº”

### 1.1 é”è¯„001 æ ¸å¿ƒæŒ‡ä»¤å›é¡¾

é”è¯„001ï¼ˆé”è¯„013ï¼šåŠ¨æ€å¯¹è±¡çš„ç”Ÿæ­»ç°¿ï¼‰æå‡ºäº†å››å¤§ç¼ºå¤±ï¼š

| ç¼ºå¤±é¡¹ | é”è¯„æè¿° | å½“å‰çŠ¶æ€ |
|--------|---------|---------|
| A. prefabId | é¢„åˆ¶ä½“æ ‡è¯†ï¼Œç”¨äºé‡å»ºæ—¶çŸ¥é“å®ä¾‹åŒ–å“ªä¸ªé¢„åˆ¶ä½“ | WorldObjectSaveData æœ‰æ­¤å­—æ®µä½†æœªä½¿ç”¨ |
| B. position | ä½ç½®æ•°æ® | å·²æœ‰ï¼ŒWorldObjectSaveData.GetPosition() |
| C. seasonState | å­£èŠ‚çŠ¶æ€ | TreeSaveData ç¼ºå¤± |
| D. æ‰è½ç‰©æŒä¹…åŒ– | WorldItemSaveData | å®Œå…¨ç¼ºå¤± |

### 1.2 æˆ‘è®¤åŒçš„éƒ¨åˆ†

1. **æ ¸å¿ƒé—®é¢˜è¯Šæ–­æ­£ç¡®**
   - åŠ¨æ€å¯¹è±¡ï¼ˆæ ‘è‹—ï¼‰åœ¨é‡å¯åä¸å­˜åœ¨äºåœºæ™¯ä¸­
   - Registry çš„ `FindByGuid()` æ‰¾ä¸åˆ°å¯¹è±¡
   - å­˜æ¡£æ•°æ®è¢«ä¸¢å¼ƒï¼Œå¯¼è‡´æ ‘è‹—"æ¶ˆå¤±"

2. **è§£å†³æ–¹å‘æ­£ç¡®**
   - éœ€è¦ä»"æ¢å¤æ•°æ®"å‡çº§ä¸º"æ¢å¤å­˜åœ¨ + æ¢å¤æ•°æ®"
   - æ ¸å¿ƒé€»è¾‘ï¼š`FindByGuid(guid) â†’ æ‰¾ä¸åˆ°? â†’ Instantiate(prefab) â†’ Load(data)`

3. **prefabId æ˜¯å¿…è¦çš„**
   - å¿…é¡»çŸ¥é“ç”¨å“ªä¸ªé¢„åˆ¶ä½“é‡å»º
   - ä¸èƒ½å‡­ç©ºåˆ›å»ºå¯¹è±¡

### 1.3 æˆ‘çš„ç–‘è™‘ä¸ç‹¬ç«‹åˆ†æ

#### ç–‘è™‘ 1ï¼šprefabId çš„æ¥æºé—®é¢˜

**é”è¯„å‡è®¾**ï¼šTreeController çŸ¥é“è‡ªå·±çš„ prefabIdï¼Œå¯ä»¥åœ¨ `Save()` æ—¶å†™å…¥ã€‚

**å®é™…æƒ…å†µ**ï¼š
- æˆ‘æ£€æŸ¥äº† `TreeController.cs`ï¼Œå‘ç°å®ƒ**æ²¡æœ‰å­˜å‚¨é¢„åˆ¶ä½“ä¿¡æ¯çš„å­—æ®µ**
- æ ‘è‹—æ˜¯é€šè¿‡ `PlacementManager.InstantiatePlacementPrefab()` åˆ›å»ºçš„
- é¢„åˆ¶ä½“æ¥è‡ª `SaplingData.placementPrefab`
- **TreeController æœ¬èº«å¹¶ä¸çŸ¥é“è‡ªå·±æ˜¯ä»å“ªä¸ªé¢„åˆ¶ä½“å®ä¾‹åŒ–çš„ï¼**

**è¿™æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜**ï¼šè¿è¡Œæ—¶å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œå¦‚ä½•çŸ¥é“è‡ªå·±çš„"å‡ºç”Ÿè¯æ˜"ï¼Ÿ

**æˆ‘çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ TreeController ä¸­æ–°å¢ `[SerializeField] private string prefabId` å­—æ®µ
- åœ¨ PlacementManager æ”¾ç½®æ ‘è‹—æ—¶ï¼Œè°ƒç”¨ `treeController.SetPrefabId(prefabId)` è®¾ç½®
- è¿™éœ€è¦ä¿®æ”¹ PlacementManager çš„ `HandleSaplingPlacement()` æ–¹æ³•

#### ç–‘è™‘ 2ï¼šé¢„åˆ¶ä½“å­˜æ”¾ä½ç½®

**é”è¯„å‡è®¾**ï¼šå¯ä»¥ä½¿ç”¨ `Resources.Load` æˆ– `PrefabManager` åŠ è½½é¢„åˆ¶ä½“ã€‚

**å®é™…æƒ…å†µ**ï¼š
- æˆ‘æ£€æŸ¥äº†é¡¹ç›®ç»“æ„ï¼Œæ ‘æœ¨é¢„åˆ¶ä½“åœ¨ `Assets/222_Prefabs/Tree/` ç›®å½•
- **ä¸åœ¨ Resources ç›®å½•ä¸‹ï¼**
- å› æ­¤**ä¸èƒ½ä½¿ç”¨ `Resources.Load()`**

**æˆ‘çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- å¿…é¡»ä½¿ç”¨ `PrefabRegistry` ScriptableObject
- åœ¨ç¼–è¾‘å™¨ä¸­æ‰‹åŠ¨é…ç½® prefabId â†’ Prefab çš„æ˜ å°„
- æˆ–è€…å°†é¢„åˆ¶ä½“ç§»åŠ¨åˆ° Resources ç›®å½•ï¼ˆä¸æ¨èï¼Œä¼šæ”¹å˜é¡¹ç›®ç»“æ„ï¼‰

#### ç–‘è™‘ 3ï¼šåœºæ™¯å±‚çº§é—®é¢˜

**é”è¯„æœªæåŠ**ï¼šé‡å»ºçš„å¯¹è±¡åº”è¯¥æ”¾åœ¨å“ªä¸ªå±‚çº§ä¸‹ï¼Ÿ

**å½“å‰æƒ…å†µ**ï¼š
- åŸå§‹æ ‘è‹—æ˜¯æ”¾åœ¨ `LAYER 1/Props/` ä¸‹çš„
- é‡å»ºæ—¶éœ€è¦æ‰¾åˆ°æ­£ç¡®çš„çˆ¶ç‰©ä½“
- å¦‚æœç›´æ¥ `Instantiate(prefab, position, rotation)`ï¼Œå¯¹è±¡ä¼šåœ¨åœºæ™¯æ ¹çº§

**æˆ‘çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ `WorldObjectSaveData` ä¸­å·²æœ‰ `layer` å­—æ®µ
- é‡å»ºæ—¶æ ¹æ® `layer` å­—æ®µæŸ¥æ‰¾å¯¹åº”çš„ Props çˆ¶ç‰©ä½“
- ä¾‹å¦‚ï¼š`layer = 1` â†’ æŸ¥æ‰¾ `LAYER 1/Props/`

#### ç–‘è™‘ 4ï¼šTreeSaveData æ‰©å±•å­—æ®µçš„å¿…è¦æ€§

**é”è¯„è¦æ±‚**ï¼šå¢åŠ  `season`ã€`isStump`ã€`stumpHealth`

**æˆ‘çš„åˆ†æ**ï¼š

| å­—æ®µ | é”è¯„è¦æ±‚ | æˆ‘çš„åˆ¤æ–­ | ç†ç”± |
|------|---------|---------|------|
| `season` | éœ€è¦ | **ä¸éœ€è¦** | Load() åä¼šè¢« SeasonManager è¦†ç›–ï¼Œå­£èŠ‚æ˜¯å…¨å±€çŠ¶æ€ |
| `isStump` | éœ€è¦ | **ä¸éœ€è¦** | å¯ä»¥ä» `state` å­—æ®µæ¨æ–­ï¼ˆ`state == TreeState.Stump`ï¼‰ |
| `stumpHealth` | éœ€è¦ | **éœ€è¦** | å½“å‰ TreeSaveData ç¡®å®æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼Œæ ‘æ¡©è¡€é‡ä¼šä¸¢å¤± |

**ç»“è®º**ï¼šåªéœ€è¦å¢åŠ  `stumpHealth`ï¼Œå…¶ä»–å¯ä»¥æ¨æ–­ã€‚

#### ç–‘è™‘ 5ï¼šæ‰è½ç‰©æŒä¹…åŒ–çš„ä¼˜å…ˆçº§

**é”è¯„æåˆ°**ï¼šæ‰è½ç‰©ä¹Ÿéœ€è¦å­˜æ¡£ã€‚

**æˆ‘çš„å»ºè®®**ï¼š
- è¿™æ˜¯æ‰©å±•åŠŸèƒ½ï¼Œæœ¬æ¬¡ä¸å®ç°
- å…ˆèšç„¦æ ‘è‹—é—®é¢˜ï¼Œè§£å†³ç”¨æˆ·æœ€ç›´æ¥çš„ç—›ç‚¹
- æ‰è½ç‰©æŒä¹…åŒ–å¯ä»¥ä½œä¸ºåç»­ä»»åŠ¡

---

## äºŒã€é”è¯„002 å›åº”

### 2.1 é”è¯„002 æ ¸å¿ƒæŒ‡ä»¤å›é¡¾

é”è¯„002ï¼ˆé”è¯„014ï¼šæ¶æ„æ¼æ´ä¿®è¡¥ä¸æ€§èƒ½è­¦ç¤ºï¼‰æŒ‡å‡ºäº† 3 ä¸ªè‡´å‘½ç›²åŒºï¼š

| ç›²åŒº | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ |
|------|---------|---------|
| ç›²åŒºä¸€ | æ—§å­˜æ¡£çš„ prefabId ä¸ºç©ºï¼Œé‡å»ºä¼šå¤±è´¥ | ğŸ”´ é«˜ |
| ç›²åŒºäºŒ | PrefabRegistry çš„å†…å­˜/æ€§èƒ½é—®é¢˜ | ğŸŸ¡ ä¸­ |
| ç›²åŒºä¸‰ | å­£èŠ‚ä¸çŠ¶æ€çš„è§†è§‰é—ªçƒé—®é¢˜ | ğŸŸ¡ ä¸­ |

### 2.2 ç›²åŒºä¸€ï¼šæ—§å­˜æ¡£å…¼å®¹æ€§ï¼ˆæˆ‘è®¤åŒï¼‰

**é”è¯„æŒ‡å‡ºçš„é—®é¢˜**ï¼š
- ç©å®¶æ‰‹ä¸Šå·²æœ‰æ—§å­˜æ¡£ï¼ˆ`slot1.json`ï¼‰
- æ—§å­˜æ¡£çš„ `prefabId` æ˜¯ç©ºå­—ç¬¦ä¸² `""`
- æ–°ä»£ç è¿è¡Œæ—¶ï¼šæ‰¾ä¸åˆ° GUID â†’ å°è¯•é‡å»º â†’ prefabId ä¸ºç©º â†’ é‡å»ºå¤±è´¥ â†’ æ ‘è‹—ä¾ç„¶æ¶ˆå¤±

**æˆ‘çš„åˆ†æ**ï¼š
- è¿™æ˜¯ä¸€ä¸ª**çœŸå®å­˜åœ¨çš„é—®é¢˜**
- æˆ‘æ£€æŸ¥äº† `slot1.json`ï¼Œç¡®è®¤æ‰€æœ‰ Tree çš„ `prefabId` éƒ½æ˜¯ `""`
- å¦‚æœä¸å¤„ç†ï¼Œæ—§å­˜æ¡£çš„æ ‘è‹—ä»ç„¶ä¼šæ¶ˆå¤±

**æˆ‘çš„è§£å†³æ–¹æ¡ˆ**ï¼š

é‡‡ç”¨é”è¯„å»ºè®®çš„ **Legacy Fallbackï¼ˆé—ç•™å›é€€é€»è¾‘ï¼‰**ï¼š

```csharp
// åœ¨ DynamicObjectFactory.TryReconstruct ä¸­
if (string.IsNullOrEmpty(data.prefabId))
{
    // æ—§å­˜æ¡£å…¼å®¹ï¼šå°è¯•æ ¹æ® objectType æ¨æ–­é»˜è®¤é¢„åˆ¶ä½“
    if (data.objectType == "Tree")
    {
        // ä½¿ç”¨é»˜è®¤æ ‘æœ¨é¢„åˆ¶ä½“è¿›è¡Œ"æŠ¢æ•‘æ€§é‡å»º"
        data.prefabId = "Tree_M1";  // é»˜è®¤ä½¿ç”¨ M1 é¢„åˆ¶ä½“
        Debug.LogWarning($"[DynamicObjectFactory] æ—§å­˜æ¡£å…¼å®¹ï¼šä½¿ç”¨é»˜è®¤é¢„åˆ¶ä½“ {data.prefabId}");
    }
    else
    {
        return null;  // å…¶ä»–ç±»å‹æ— æ³•æ¨æ–­ï¼Œæ”¾å¼ƒé‡å»º
    }
}
```

**è¡¥å……è€ƒè™‘**ï¼š
- è¿™ç§"æŠ¢æ•‘æ€§é‡å»º"å¯èƒ½å¯¼è‡´æ ‘æœ¨å¤–è§‚ä¸æ­£ç¡®ï¼ˆæ¯”å¦‚åŸæœ¬æ˜¯æ¾æ ‘ï¼Œé‡å»ºæˆäº†æ©¡æ ‘ï¼‰
- ä½†æ¯”å®Œå…¨æ¶ˆå¤±è¦å¥½
- å¯ä»¥åœ¨æ—¥å¿—ä¸­æç¤ºç”¨æˆ·"æ£€æµ‹åˆ°æ—§å­˜æ¡£ï¼Œéƒ¨åˆ†æ ‘æœ¨å¯èƒ½å¤–è§‚å¼‚å¸¸"

### 2.3 ç›²åŒºäºŒï¼šPrefabRegistry å†…å­˜é—®é¢˜ï¼ˆéƒ¨åˆ†è®¤åŒï¼‰

**é”è¯„æŒ‡å‡ºçš„é—®é¢˜**ï¼š
- å¦‚æœåœ¨ `Initialize` é‡Œ `Resources.LoadAll`ï¼Œä¼šé€ æˆå¯åŠ¨å¡é¡¿å’Œå†…å­˜å ç”¨
- å¦‚æœæ‰‹åŠ¨é…ç½®ï¼Œç¹çä¸”å®¹æ˜“æ¼

**æˆ‘çš„åˆ†æ**ï¼š

é”è¯„çš„æ‹…å¿§æ˜¯åŸºäº `Resources.LoadAll` çš„åœºæ™¯ï¼Œä½†æˆ‘çš„è®¾è®¡æ˜¯ï¼š
- ä½¿ç”¨ ScriptableObject åœ¨ç¼–è¾‘å™¨ä¸­é…ç½®å¼•ç”¨
- **ä¸æ˜¯è¿è¡Œæ—¶åŠ è½½**ï¼Œè€Œæ˜¯ç¼–è¾‘å™¨æ—¶å°±å·²ç»å¼•ç”¨å¥½äº†
- Unity çš„ ScriptableObject å¼•ç”¨æ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰çœŸæ­£è®¿é—®æ—¶æ‰ä¼šåŠ è½½

**æˆ‘çš„åˆ¤æ–­**ï¼š
- å¦‚æœé¢„åˆ¶ä½“æ•°é‡ä¸å¤šï¼ˆ<100ï¼‰ï¼Œåœ¨ç¼–è¾‘å™¨é˜¶æ®µæ”¶é›†å¼•ç”¨æ˜¯å¯æ¥å—çš„
- å½“å‰é¡¹ç›®æ ‘æœ¨é¢„åˆ¶ä½“åªæœ‰ 3 ä¸ªï¼ˆM1, M2, M3ï¼‰ï¼Œå†…å­˜å½±å“å¯ä»¥å¿½ç•¥
- **ä¸éœ€è¦å®ç°æ‡’åŠ è½½**

**ä½†æˆ‘æ¥å—é”è¯„çš„å»ºè®®**ï¼š
- åœ¨ `PrefabRegistry.GetPrefab()` ä¸­æ·»åŠ ç©ºå€¼æ£€æŸ¥
- å¦‚æœé¢„åˆ¶ä½“æœªé…ç½®ï¼Œè¾“å‡ºè­¦å‘Šè€Œä¸æ˜¯å´©æºƒ

### 2.4 ç›²åŒºä¸‰ï¼šå­£èŠ‚ä¸çŠ¶æ€çš„è§†è§‰é—ªçƒï¼ˆæˆ‘è®¤åŒï¼‰

**é”è¯„æŒ‡å‡ºçš„é—®é¢˜**ï¼š
- å½“ `Instantiate` ä¸€ä¸ªæ ‘è‹—æ—¶ï¼Œå®ƒçš„ `Start()` ä¼šè¿è¡Œ
- å¦‚æœ `Start()` é‡Œè®¾ç½®äº†é»˜è®¤ Spriteï¼ˆå¦‚æ˜¥å¤©ï¼‰ï¼Œè€Œå­˜æ¡£é‡Œæ˜¯å†¬å¤©
- `Load()` æ¢å¤äº†å­£èŠ‚æ•°æ®ï¼Œä½†å¦‚æœæ²¡æœ‰ç«‹å³åˆ·æ–° Sprite
- ç©å®¶ä¼šçœ‹åˆ°ä¸€ç¬é—´çš„æ˜¥å¤©æ ‘ï¼Œç„¶åæ‰å˜æˆå†¬å¤©æ ‘ï¼ˆé—ªçƒï¼‰

**æˆ‘çš„åˆ†æ**ï¼š
- è¿™æ˜¯ä¸€ä¸ª**çœŸå®å­˜åœ¨çš„é—®é¢˜**
- éœ€è¦ç¡®ä¿ `Load()` åç«‹å³åˆ·æ–°è§†è§‰

**æˆ‘çš„è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šåœ¨ Load() æœ«å°¾å¼ºåˆ¶åˆ·æ–°**
```csharp
public void Load(WorldObjectSaveData data)
{
    // ... æ¢å¤æ•°æ® ...
    
    // å¼ºåˆ¶åˆ·æ–°è§†è§‰
    UpdateVisuals();
}
```

**æ–¹æ¡ˆ Bï¼šå®ä¾‹åŒ–æ—¶å…ˆç¦ç”¨ï¼ŒLoad åå†å¯ç”¨**
```csharp
// åœ¨ DynamicObjectFactory.TryReconstruct ä¸­
var instance = Object.Instantiate(prefab, position, Quaternion.identity);
instance.SetActive(false);  // å…ˆç¦ç”¨ï¼Œé¿å… Start() è®¾ç½®é»˜è®¤å¤–è§‚

// ... è·å–ç»„ä»¶ã€è®¾ç½® GUID ...

persistentObj.Load(data);  // æ¢å¤æ•°æ®
instance.SetActive(true);  // å¯ç”¨ï¼Œæ­¤æ—¶å¤–è§‚å·²æ­£ç¡®
```

**æˆ‘çš„é€‰æ‹©**ï¼šé‡‡ç”¨æ–¹æ¡ˆ Bï¼Œæ›´å½»åº•åœ°é¿å…é—ªçƒã€‚

---

## ä¸‰ã€ç»¼åˆç»“è®º

### 3.1 é”è¯„001 å›åº”æ€»ç»“

| æŒ‡ä»¤ | æˆ‘çš„æ€åº¦ | è¡ŒåŠ¨ |
|------|---------|------|
| å¢åŠ  prefabId | âœ… è®¤åŒ | åœ¨ TreeController æ–°å¢å­—æ®µï¼ŒPlacementManager è®¾ç½® |
| å¢åŠ  position | âœ… å·²æœ‰ | æ— éœ€ä¿®æ”¹ |
| å¢åŠ  seasonState | âš ï¸ éƒ¨åˆ†è®¤åŒ | ä¸éœ€è¦å­˜æ¡£ seasonï¼Œä½†éœ€è¦åœ¨ Load ååˆ·æ–°è§†è§‰ |
| æ‰è½ç‰©æŒä¹…åŒ– | â¸ï¸ å»¶å | æœ¬æ¬¡ä¸å®ç°ï¼Œä½œä¸ºåç»­ä»»åŠ¡ |

### 3.2 é”è¯„002 å›åº”æ€»ç»“

| ç›²åŒº | æˆ‘çš„æ€åº¦ | è¡ŒåŠ¨ |
|------|---------|------|
| æ—§å­˜æ¡£å…¼å®¹ | âœ… è®¤åŒ | æ·»åŠ  Legacy Fallback é€»è¾‘ |
| å†…å­˜é—®é¢˜ | âš ï¸ éƒ¨åˆ†è®¤åŒ | å½“å‰è§„æ¨¡å¯æ¥å—ï¼Œæ·»åŠ ç©ºå€¼æ£€æŸ¥ |
| è§†è§‰é—ªçƒ | âœ… è®¤åŒ | å®ä¾‹åŒ–æ—¶å…ˆç¦ç”¨ï¼ŒLoad åå†å¯ç”¨ |

### 3.3 éœ€è¦æ›´æ–°çš„è®¾è®¡

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘éœ€è¦åœ¨ design.md ä¸­è¡¥å……ï¼š

1. **æ—§å­˜æ¡£å…¼å®¹é€»è¾‘**ï¼šåœ¨ `DynamicObjectFactory.TryReconstruct` ä¸­æ·»åŠ  Legacy Fallback
2. **è§†è§‰é—ªçƒé˜²æŠ¤**ï¼šå®ä¾‹åŒ–æ—¶å…ˆ `SetActive(false)`ï¼ŒLoad åå† `SetActive(true)`
3. **TreeController.Load() æœ«å°¾**ï¼šå¼ºåˆ¶è°ƒç”¨ `UpdateVisuals()` åˆ·æ–°å¤–è§‚

### 3.4 éœ€è¦æ›´æ–°çš„ä»»åŠ¡

åœ¨ tasks.md ä¸­æ’å…¥ä»¥ä¸‹å­ä»»åŠ¡ï¼š

1. **[Data] é—ç•™å…¼å®¹**ï¼šåœ¨ `DynamicObjectFactory.TryReconstruct` ä¸­å¤„ç† `prefabId` ä¸ºç©ºçš„æƒ…å†µ
2. **[Visual] é—ªçƒé˜²æŠ¤**ï¼šå®ä¾‹åŒ–æ—¶ç¦ç”¨å¯¹è±¡ï¼ŒLoad åå¯ç”¨
3. **[Visual] å­£èŠ‚åˆ·æ–°**ï¼šåœ¨ `TreeController.Load` æœ«å°¾è°ƒç”¨ `UpdateVisuals()`

---

## å››ã€å¾…ç”¨æˆ·ç¡®è®¤çš„é—®é¢˜

1. **æ—§å­˜æ¡£çš„é»˜è®¤é¢„åˆ¶ä½“**ï¼šå½“ prefabId ä¸ºç©ºæ—¶ï¼Œä½¿ç”¨ `Tree_M1` ä½œä¸ºé»˜è®¤é¢„åˆ¶ä½“æ˜¯å¦å¯æ¥å—ï¼Ÿ
2. **æ‰è½ç‰©æŒä¹…åŒ–**ï¼šæ˜¯å¦åœ¨æœ¬æ¬¡å®ç°ï¼Œè¿˜æ˜¯ä½œä¸ºåç»­ä»»åŠ¡ï¼Ÿ
3. **TreeSaveData å­—æ®µ**ï¼šæ˜¯å¦åªå¢åŠ  `stumpHealth`ï¼Œè¿˜æ˜¯æŒ‰é”è¯„è¦æ±‚å¢åŠ  `season` å’Œ `isStump`ï¼Ÿ

---

## äº”ã€é”è¯„003 å›åº”

### 5.1 é”è¯„003 æ ¸å¿ƒæŒ‡ä»¤å›é¡¾

é”è¯„003ï¼ˆé”è¯„015ï¼šæˆ˜ç•¥å¦¥åä¸åº•çº¿åšæŒï¼‰åšå‡ºäº†ä»¥ä¸‹è£å†³ï¼š

| é¡¹ç›® | é”è¯„æ€åº¦ | æˆ‘çš„åŸæè®® |
|------|---------|-----------|
| position å­—æ®µ | âœ… æ¥å—æˆ‘çš„åé©³ | å·²æœ‰ï¼Œæ— éœ€é‡å¤ |
| é˜²é—ªçƒæ–¹æ¡ˆ B | âœ… æ‰¹å‡† | å…ˆç¦ç”¨åå¯ç”¨ |
| æ‰è½ç‰©å»¶å | âŒ é©³å› | æœ¬æ¬¡ä¸å®ç° |
| å­£èŠ‚å­—æ®µ | âš ï¸ æœ‰æ¡ä»¶æ¥å— | ä¸å­˜ season |

### 5.2 å…³äºæ‰è½ç‰©ï¼ˆæˆ‘æ¥å—é”è¯„çš„é©³å›ï¼‰

**é”è¯„çš„ç†ç”±**ï¼š
> åŠ¨æ€å¯¹è±¡é‡å»ºç³»ç»Ÿçš„æ ¸å¿ƒä»·å€¼å°±æ˜¯"è®©åœºæ™¯æ¢å¤åŸæ ·"ã€‚å¦‚æœæ ‘è‹—å›æ¥äº†ï¼Œä½†åœ°ä¸Šçš„æœ¨å¤´æ²¡äº†ï¼Œè¿™ä¸ªå­˜æ¡£ä¾ç„¶æ˜¯æ®‹åºŸçš„ã€‚

**æˆ‘çš„åæ€**ï¼š
- é”è¯„è¯´å¾—å¯¹ï¼Œæˆ‘ä¹‹å‰æƒ³"å»¶å"æ˜¯å·æ‡’çš„æƒ³æ³•
- æ‰è½ç‰©å’Œæ ‘è‹—æœ¬è´¨ä¸Šæ˜¯åŒä¸€ç±»é—®é¢˜ï¼šåŠ¨æ€å¯¹è±¡é‡å»º
- å¦‚æœåªè§£å†³æ ‘è‹—ä¸è§£å†³æ‰è½ç‰©ï¼Œç”¨æˆ·ä½“éªŒä¾ç„¶ä¸å®Œæ•´

**æˆ‘çš„è¡ŒåŠ¨**ï¼š
- æœ¬æ¬¡å®ç° `WorldItemPickup` çš„å­˜æ¡£/è¯»æ¡£
- éœ€è¦è®© `WorldItemPickup` å®ç° `IPersistentObject` æ¥å£
- å­˜æ¡£æ•°æ®ï¼š`itemId`ã€`quality`ã€`amount`ã€`position`

### 5.3 å…³äºå­£èŠ‚åŠ è½½é¡ºåºï¼ˆæˆ‘æ¥å—é”è¯„çš„è­¦å‘Šï¼‰

**é”è¯„çš„è­¦å‘Š**ï¼š
> è¿™å»ºç«‹åœ¨ä¸€ä¸ªç»å¯¹å‰æä¸Šâ€”â€”TimeManager å¿…é¡»åœ¨ PersistentObjectRegistry ä¹‹å‰å®ŒæˆåŠ è½½ã€‚

**æˆ‘çš„è¡ŒåŠ¨**ï¼š
- ç¡®ä¿ `SaveManager.LoadGame()` ä¸­ï¼š
  1. å…ˆ `RestoreGameTimeData()` æ¢å¤æ—¶é—´
  2. å† `RestoreAllFromSaveData()` æ¢å¤ä¸–ç•Œå¯¹è±¡
- åœ¨ `TreeController.Load()` æœ«å°¾å¼ºåˆ¶è°ƒç”¨ `UpdateVisuals()`

---

## å…­ã€ç”¨æˆ·è¡¥å……éœ€æ±‚ï¼šå­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£

### 6.1 ç”¨æˆ·åŸè¯

> æˆ‘æœ€åˆå¯¹äºå­£èŠ‚çš„è®¾è®¡æ˜¯æ‰€æœ‰æ ‘æœ¨ä¼šè¿›è¡Œæ¸å˜å¹¶ä¸”åœ¨æ¸¸æˆæŒç»­è¿è¡Œçš„æ—¶å€™æˆ‘å°±æ˜¯è®¾è®¡çš„è®©ä½ ç»´æŠ¤æœªæ¸å˜æ ‘æœ¨çš„ä¿¡æ¯ä»¥åŠæ¸å˜è¿‡çš„æ ‘æœ¨ä¿¡æ¯ï¼Œæ¯æ¬¡æ¸å˜åªè®©æ²¡æœ‰æ¸å˜çš„æ ‘æœ¨è¿›è¡Œæ ·å¼çš„æ”¹å˜ï¼Œè¿™æ ·æ‰æ˜¯ç¬¦åˆé€»è¾‘çš„ï¼Œæ‰€æœ‰æ ‘æœ¨è‡ªç„¶æ¸å˜ç„¶åæ”¹å˜åä¸ä¼šå›é€€ï¼Œåªæœ‰å­£èŠ‚é¡ºæ—¶é’ˆé—­ç¯å˜æ›´

### 6.2 æˆ‘çš„ç†è§£

å½“å‰çš„å­£èŠ‚æ¸å˜å®ç°ï¼š
- ä½¿ç”¨ `treeID + currentStageIndex` ç”Ÿæˆå›ºå®šéšæœºç§å­
- æ¯æ£µæ ‘æœ‰ä¸€ä¸ªå›ºå®šçš„ `treeSeedValue`ï¼ˆ0-1 ä¹‹é—´ï¼‰
- å½“ `seasonTransitionProgress > treeSeedValue` æ—¶ï¼Œè¯¥æ ‘æ˜¾ç¤ºä¸‹ä¸€å­£èŠ‚
- **é—®é¢˜**ï¼šè¿™ä¸ªåˆ¤æ–­æ˜¯å®æ—¶è®¡ç®—çš„ï¼Œæ²¡æœ‰"è®°ä½"å“ªäº›æ ‘å·²ç»æ¸å˜è¿‡

ç”¨æˆ·æœŸæœ›çš„è¡Œä¸ºï¼š
- æ ‘æœ¨æ¸å˜æ˜¯**ä¸å¯é€†**çš„
- ä¸€æ—¦æŸæ£µæ ‘æ¸å˜åˆ°ä¸‹ä¸€å­£èŠ‚ï¼Œå®ƒå°±**æ°¸è¿œ**æ˜¾ç¤ºä¸‹ä¸€å­£èŠ‚ï¼ˆç›´åˆ°ä¸‹ä¸€æ¬¡å­£èŠ‚å˜æ›´ï¼‰
- éœ€è¦å­˜æ¡£è®°å½•"è¿™æ£µæ ‘æ˜¯å¦å·²ç»æ¸å˜åˆ°ä¸‹ä¸€å­£èŠ‚"

### 6.3 æˆ‘çš„åˆ†æ

**å½“å‰å®ç°çš„é—®é¢˜**ï¼š

å‡è®¾åœºæ™¯ï¼š
1. æ˜¥å­£ç¬¬ 20 å¤©ï¼Œ`progress = 0.4`
2. æ ‘ A çš„ `treeSeedValue = 0.3`ï¼Œæ˜¾ç¤ºå¤å­£ï¼ˆå› ä¸º 0.3 < 0.4ï¼‰
3. ä¿å­˜æ¸¸æˆ
4. é‡å¯æ¸¸æˆï¼ŒåŠ è½½å­˜æ¡£
5. æ—¶é—´æ¢å¤åˆ°æ˜¥å­£ç¬¬ 20 å¤©ï¼Œ`progress = 0.4`
6. æ ‘ A é‡æ–°è®¡ç®— `treeSeedValue`...

**é—®é¢˜**ï¼šå¦‚æœæ ‘ A æ˜¯åŠ¨æ€é‡å»ºçš„ï¼ˆæ–° GUIDï¼‰ï¼Œå®ƒçš„ `treeID` å¯èƒ½å˜äº†ï¼Œå¯¼è‡´ `treeSeedValue` å˜äº†ï¼

**è§£å†³æ–¹æ¡ˆ**ï¼š

éœ€è¦åœ¨ `TreeSaveData` ä¸­å¢åŠ å­—æ®µï¼š

```csharp
/// <summary>
/// æ˜¯å¦å·²æ¸å˜åˆ°ä¸‹ä¸€å­£èŠ‚
/// ç”¨äºå­£èŠ‚æ¸å˜ç³»ç»Ÿï¼Œç¡®ä¿æ¸å˜çŠ¶æ€åœ¨å­˜æ¡£åä¿æŒ
/// </summary>
public bool hasTransitionedToNextSeason;

/// <summary>
/// æ¸å˜æ—¶çš„æ¤è¢«å­£èŠ‚ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç½®æ¸å˜çŠ¶æ€ï¼‰
/// </summary>
public int transitionVegetationSeason;
```

**Load æ—¶çš„é€»è¾‘**ï¼š

```csharp
// æ¢å¤æ¸å˜çŠ¶æ€
if (treeData.hasTransitionedToNextSeason)
{
    // æ£€æŸ¥å½“å‰æ¤è¢«å­£èŠ‚æ˜¯å¦ä¸å­˜æ¡£æ—¶ç›¸åŒ
    var currentVegSeason = SeasonManager.Instance.GetCurrentVegetationSeason();
    if ((int)currentVegSeason == treeData.transitionVegetationSeason)
    {
        // å­£èŠ‚ç›¸åŒï¼Œä¿æŒæ¸å˜çŠ¶æ€
        _hasTransitionedToNextSeason = true;
    }
    else
    {
        // å­£èŠ‚å·²å˜æ›´ï¼Œé‡ç½®æ¸å˜çŠ¶æ€
        _hasTransitionedToNextSeason = false;
    }
}
```

### 6.4 ä¿®æ­£åçš„è®¾è®¡

**TreeController æ–°å¢å­—æ®µ**ï¼š

```csharp
/// <summary>
/// æ˜¯å¦å·²æ¸å˜åˆ°ä¸‹ä¸€å­£èŠ‚ï¼ˆè¿è¡Œæ—¶çŠ¶æ€ï¼‰
/// </summary>
private bool _hasTransitionedToNextSeason = false;

/// <summary>
/// æ¸å˜æ—¶çš„æ¤è¢«å­£èŠ‚ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç½®ï¼‰
/// </summary>
private SeasonManager.VegetationSeason _transitionVegetationSeason;
```

**GetNormalSprite ä¿®æ”¹**ï¼š

```csharp
// å¦‚æœå·²ç»æ¸å˜è¿‡ï¼Œç›´æ¥æ˜¾ç¤ºä¸‹ä¸€å­£èŠ‚
if (_hasTransitionedToNextSeason && _transitionVegetationSeason == vegSeason)
{
    var nextSeason = GetNextVegetationSeason(vegSeason);
    return stageData.normal.GetSprite(nextSeason);
}

// æ¸å˜åˆ¤æ–­
if (treeSeedValue < progress)
{
    // æ ‡è®°ä¸ºå·²æ¸å˜
    _hasTransitionedToNextSeason = true;
    _transitionVegetationSeason = vegSeason;
    
    var nextSeason = GetNextVegetationSeason(vegSeason);
    return stageData.normal.GetSprite(nextSeason);
}
```

---

## ä¸ƒã€ç”¨æˆ·è¡¥å……éœ€æ±‚ï¼šå…¨é¢çš„åœºæ™¯å¯¹è±¡å­˜æ¡£

### 7.1 ç”¨æˆ·åŸè¯

> ä½ è¿˜éœ€è¦å¯¹çŸ³å¤´å•Šç®±å­å•Šæ›´å¤šçš„å†…å®¹ï¼Œè¿˜æœ‰åŒ…æ‹¬ä¸è¿›è¡Œäº¤äº’çš„æˆ¿å­å•Šè¿˜æœ‰å„ç§å†…å®¹çš„æ•°æ®ï¼Œæˆ‘è®¤ä¸ºå‡¡æ˜¯å‡ºç°åœ¨åœºæ™¯ä¸­çš„æ‰€æœ‰æ•°æ®ä½ éƒ½éœ€è¦ä¿å­˜

### 7.2 åœºæ™¯å¯¹è±¡åˆ†ç±»

| å¯¹è±¡ç±»å‹ | å½“å‰çŠ¶æ€ | æ˜¯å¦éœ€è¦å­˜æ¡£ | å­˜æ¡£å†…å®¹ |
|---------|---------|-------------|---------|
| **æ ‘æœ¨ (Tree)** | âœ… å·²å®ç° IPersistentObject | âœ… éœ€è¦ | ç”Ÿé•¿é˜¶æ®µã€è¡€é‡ã€çŠ¶æ€ã€å­£èŠ‚æ¸å˜ |
| **çŸ³å¤´ (Stone)** | âœ… å·²å®ç° IPersistentObject | âœ… éœ€è¦ | è¡€é‡ã€çŸ¿ç‰©å«é‡ã€æ˜¯å¦è¢«ç ´å |
| **ç®±å­ (Chest)** | âœ… å·²å®ç° IPersistentObject | âœ… éœ€è¦ | ç‰©å“å†…å®¹ã€æ˜¯å¦æ‰“å¼€ |
| **æ‰è½ç‰© (WorldItemPickup)** | âŒ æœªå®ç° | âœ… éœ€è¦ | itemIdã€qualityã€amountã€position |
| **æˆ¿å­ (Building)** | â“ éœ€è¦æ£€æŸ¥ | âš ï¸ å¯èƒ½éœ€è¦ | ä½ç½®ã€çŠ¶æ€ï¼ˆå¦‚æœå¯äº¤äº’ï¼‰ |
| **å†œç”° (Farmland)** | â“ éœ€è¦æ£€æŸ¥ | âœ… éœ€è¦ | è€•åœ°çŠ¶æ€ã€ä½œç‰©æ•°æ® |
| **ä½œç‰© (Crop)** | â“ éœ€è¦æ£€æŸ¥ | âœ… éœ€è¦ | ç”Ÿé•¿é˜¶æ®µã€æµ‡æ°´çŠ¶æ€ |

### 7.3 æˆ‘çš„åˆ†æ

**å·²å®ç° IPersistentObject çš„å¯¹è±¡**ï¼š
- `TreeController` âœ…
- `StoneController` âœ…
- `ChestController` âœ…
- `InventoryService` âœ…
- `EquipmentService` âœ…

**éœ€è¦æ–°å¢ IPersistentObject çš„å¯¹è±¡**ï¼š
- `WorldItemPickup` - æ‰è½ç‰©ï¼ˆæœ¬æ¬¡å¿…é¡»å®ç°ï¼‰
- `CropController` - ä½œç‰©ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
- `FarmTileManager` - å†œç”°çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰

**é™æ€å¯¹è±¡ï¼ˆä¸éœ€è¦å­˜æ¡£ï¼‰**ï¼š
- æˆ¿å­ã€è£…é¥°ç‰©ç­‰ä¸å¯äº¤äº’çš„é™æ€åœºæ™¯å…ƒç´ 
- è¿™äº›å¯¹è±¡åœ¨åœºæ™¯æ–‡ä»¶ä¸­å·²ç»åºåˆ—åŒ–ï¼Œé‡å¯åè‡ªåŠ¨å­˜åœ¨

### 7.4 æœ¬æ¬¡å®ç°èŒƒå›´

æ ¹æ®ä¼˜å…ˆçº§ï¼Œæœ¬æ¬¡å®ç°ï¼š

1. **P0ï¼ˆå¿…é¡»ï¼‰**ï¼š
   - æ ‘è‹—åŠ¨æ€é‡å»º
   - æ‰è½ç‰©åŠ¨æ€é‡å»º

2. **P1ï¼ˆåº”è¯¥ï¼‰**ï¼š
   - æ ‘æœ¨å­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£
   - æ ‘æ¡©è¡€é‡å­˜æ¡£

3. **P2ï¼ˆå¯é€‰ï¼‰**ï¼š
   - å†œç”°/ä½œç‰©å­˜æ¡£ï¼ˆå¦‚æœå½“å‰æœ‰å®ç°ï¼‰

---

## å…«ã€ç”¨æˆ·è¡¥å……éœ€æ±‚ï¼šå¼‚æ­¥å­˜æ¡£/è¯»æ¡£

### 8.1 ç”¨æˆ·åŸè¯

> å­˜æ¡£å’Œè¯»æ¡£å…¶å®æ˜¯æœ‰æ—¶é—´ç»™ä½ çš„ï¼Œä½ å¯ä»¥ç”¨å¤šçº¿ç¨‹ï¼Œç»™ä¸€ä¸ªåŠ è½½åŠ¨ç”»åœ¨å‰é¢æ’­æ”¾ï¼Œç„¶åä½ å¦ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå®Œæˆè¿™ä¸ªåŠ è½½å¹¶åœ¨å®Œæˆåè¿›å…¥æ¸¸æˆï¼Œä¿å­˜å­˜æ¡£å°±åœ¨ç¡è§‰çš„æ—¶å€™ä¿å­˜ä¹Ÿæ˜¯å¼‚æ­¥

### 8.2 æˆ‘çš„åˆ†æ

**å½“å‰å­˜æ¡£ç³»ç»Ÿçš„é—®é¢˜**ï¼š
- åŒæ­¥æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´å¡é¡¿
- å¤§é‡å¯¹è±¡æ—¶ï¼Œä¿å­˜/åŠ è½½æ—¶é—´å¯èƒ½è¾ƒé•¿

**å¼‚æ­¥æ–¹æ¡ˆè®¾è®¡**ï¼š

**ä¿å­˜ï¼ˆç¡è§‰æ—¶ï¼‰**ï¼š
```csharp
public async Task SaveGameAsync()
{
    // 1. åœ¨ä¸»çº¿ç¨‹æ”¶é›†æ•°æ®ï¼ˆå¿…é¡»åœ¨ä¸»çº¿ç¨‹ï¼Œå› ä¸ºè¦è®¿é—® Unity å¯¹è±¡ï¼‰
    var saveData = CollectSaveData();
    
    // 2. åœ¨åå°çº¿ç¨‹åºåˆ—åŒ–å’Œå†™å…¥æ–‡ä»¶
    await Task.Run(() =>
    {
        string json = JsonUtility.ToJson(saveData, true);
        File.WriteAllText(savePath, json);
    });
    
    // 3. å›åˆ°ä¸»çº¿ç¨‹é€šçŸ¥å®Œæˆ
    OnSaveComplete?.Invoke();
}
```

**åŠ è½½ï¼ˆè¿›å…¥æ¸¸æˆæ—¶ï¼‰**ï¼š
```csharp
public async Task LoadGameAsync(Action<float> onProgress)
{
    // 1. æ˜¾ç¤ºåŠ è½½ç•Œé¢
    ShowLoadingScreen();
    
    // 2. åœ¨åå°çº¿ç¨‹è¯»å–å’Œååºåˆ—åŒ–
    GameSaveData saveData = null;
    await Task.Run(() =>
    {
        string json = File.ReadAllText(savePath);
        saveData = JsonUtility.FromJson<GameSaveData>(json);
    });
    onProgress?.Invoke(0.3f);
    
    // 3. åœ¨ä¸»çº¿ç¨‹æ¢å¤æ•°æ®ï¼ˆå¿…é¡»åœ¨ä¸»çº¿ç¨‹ï¼Œå› ä¸ºè¦æ“ä½œ Unity å¯¹è±¡ï¼‰
    RestoreGameTimeData(saveData.timeData);
    onProgress?.Invoke(0.5f);
    
    // 4. åˆ†æ‰¹æ¢å¤ä¸–ç•Œå¯¹è±¡ï¼ˆé¿å…å•å¸§å¡é¡¿ï¼‰
    int total = saveData.worldObjects.Count;
    int batchSize = 10;
    for (int i = 0; i < total; i += batchSize)
    {
        var batch = saveData.worldObjects.Skip(i).Take(batchSize);
        foreach (var data in batch)
        {
            RestoreObject(data);
        }
        onProgress?.Invoke(0.5f + 0.4f * (float)i / total);
        await Task.Yield(); // è®©å‡ºä¸€å¸§ï¼Œé¿å…å¡é¡¿
    }
    
    // 5. éšè—åŠ è½½ç•Œé¢
    HideLoadingScreen();
    onProgress?.Invoke(1f);
}
```

### 8.3 æœ¬æ¬¡å®ç°èŒƒå›´

å¼‚æ­¥å­˜æ¡£/è¯»æ¡£æ˜¯ä¸€ä¸ªè¾ƒå¤§çš„æ”¹åŠ¨ï¼Œå»ºè®®ï¼š

1. **æœ¬æ¬¡**ï¼šå…ˆå®ç°åŒæ­¥ç‰ˆæœ¬çš„åŠ¨æ€å¯¹è±¡é‡å»ºï¼Œç¡®ä¿åŠŸèƒ½æ­£ç¡®
2. **åç»­**ï¼šåœ¨åŠŸèƒ½ç¨³å®šåï¼Œå†å‡çº§ä¸ºå¼‚æ­¥ç‰ˆæœ¬

**ç†ç”±**ï¼š
- å¼‚æ­¥æ”¹åŠ¨æ¶‰åŠ UIï¼ˆåŠ è½½ç•Œé¢ï¼‰ã€åç¨‹/Taskã€é”™è¯¯å¤„ç†ç­‰
- å…ˆç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æ­£ç¡®ï¼Œå†ä¼˜åŒ–æ€§èƒ½

---

## ä¹ã€ç»¼åˆç»“è®ºï¼ˆæ›´æ–°ç‰ˆï¼‰

### 9.1 æœ¬æ¬¡å¿…é¡»å®ç°

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| æ ‘è‹—åŠ¨æ€é‡å»º | P0 | æ ¸å¿ƒé—®é¢˜ |
| æ‰è½ç‰©åŠ¨æ€é‡å»º | P0 | é”è¯„é©³å›å»¶å |
| æ—§å­˜æ¡£å…¼å®¹ | P0 | Legacy Fallback |
| é˜²é—ªçƒæ–¹æ¡ˆ | P0 | å…ˆç¦ç”¨åå¯ç”¨ |
| æ ‘æœ¨å­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£ | P1 | ç”¨æˆ·æ˜ç¡®è¦æ±‚ |
| æ ‘æ¡©è¡€é‡å­˜æ¡£ | P1 | æ•°æ®å®Œæ•´æ€§ |

### 9.2 æœ¬æ¬¡ä¸å®ç°ï¼ˆåç»­ä»»åŠ¡ï¼‰

| åŠŸèƒ½ | åŸå›  |
|------|------|
| å¼‚æ­¥å­˜æ¡£/è¯»æ¡£ | æ”¹åŠ¨è¾ƒå¤§ï¼Œå…ˆç¡®ä¿åŠŸèƒ½æ­£ç¡® |
| å†œç”°/ä½œç‰©å­˜æ¡£ | éœ€è¦å…ˆç¡®è®¤å½“å‰å®ç°çŠ¶æ€ |
| æˆ¿å­ç­‰é™æ€å¯¹è±¡ | ä¸éœ€è¦å­˜æ¡£ï¼Œåœºæ™¯æ–‡ä»¶å·²åºåˆ—åŒ– |

### 9.3 éœ€è¦æ›´æ–°çš„æ–‡æ¡£

1. **design.md**ï¼š
   - æ·»åŠ æ‰è½ç‰©é‡å»ºè®¾è®¡
   - æ·»åŠ å­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£è®¾è®¡
   - æ›´æ–° TreeSaveData å­—æ®µ

2. **tasks.md**ï¼š
   - æ·»åŠ æ‰è½ç‰©ç›¸å…³ä»»åŠ¡
   - æ·»åŠ å­£èŠ‚æ¸å˜çŠ¶æ€ä»»åŠ¡
   - æ›´æ–°ä»»åŠ¡ä¾èµ–å…³ç³»

### 9.4 å¾…ç”¨æˆ·ç¡®è®¤çš„é—®é¢˜

1. **å­£èŠ‚æ¸å˜çŠ¶æ€**ï¼šæˆ‘ç†è§£çš„"æ¸å˜ä¸å¯é€†"æ˜¯å¦æ­£ç¡®ï¼Ÿ
2. **å¼‚æ­¥å­˜æ¡£**ï¼šæ˜¯å¦æ¥å—"æœ¬æ¬¡å…ˆåŒæ­¥ï¼Œåç»­å†å¼‚æ­¥"çš„æ–¹æ¡ˆï¼Ÿ
3. **å†œç”°/ä½œç‰©**ï¼šå½“å‰æ˜¯å¦æœ‰ `CropController` å®ç°ï¼Ÿæ˜¯å¦éœ€è¦æœ¬æ¬¡å¤„ç†ï¼Ÿ

---

## åã€é”è¯„004 å›åº”

### 10.1 é”è¯„004 æ ¸å¿ƒå†…å®¹

é”è¯„004ï¼ˆé”è¯„016ï¼šæˆ˜ç•¥å¦¥åä¸åº•çº¿é˜²å®ˆï¼‰æ˜¯å¯¹æˆ‘çš„ã€Šé”è¯„å›åº”ä¸ç‹¬ç«‹æ€è€ƒã€‹çš„è¿›ä¸€æ­¥å›åº”ï¼Œä¸»è¦å†…å®¹ï¼š

| é¡¹ç›® | é”è¯„æ€åº¦ | è¯´æ˜ |
|------|---------|------|
| position åé©³ | âœ… æ¥å— | ç¡®è®¤ WorldObjectSaveData å·²æœ‰ä½ç½®æ•°æ® |
| é˜²é—ªçƒæ–¹æ¡ˆ B | âœ… æ‰¹å‡† | Instantiate -> Disable -> Load -> Enable |
| æ‰è½ç‰©å»¶å | âŒ é©³å› | å¿…é¡»æœ¬æ¬¡å®ç° |
| å­£èŠ‚å­—æ®µ | âš ï¸ æœ‰æ¡ä»¶æ¥å— | ä¸å­˜ seasonï¼Œä½†å¿…é¡»ä¿è¯åŠ è½½é¡ºåº |

### 10.2 å…³äºæ‰è½ç‰©çš„æŠ€æœ¯è¯„ä¼°

**é”è¯„004 çš„æŠ€æœ¯æç¤º**ï¼š
> WorldItemDrop é€šå¸¸åªéœ€è¦ä¿å­˜ itemId å’Œ amountï¼Œä¸éœ€è¦å¤æ‚çš„ prefabId æ˜ å°„ï¼ˆå› ä¸ºå¯ä»¥é€šè¿‡ ItemDatabase æŸ¥åˆ° Prefabï¼Œæˆ–è€…ç»Ÿä¸€ç”¨ä¸€ä¸ª DropPrefab ç„¶åæ¢ Spriteï¼‰ã€‚

**æˆ‘çš„ä»£ç éªŒè¯**ï¼š

æˆ‘æ£€æŸ¥äº† `WorldItemPickup.cs` å’Œ `WorldSpawnService.cs`ï¼Œå‘ç°ï¼š

1. **WorldItemPickup å·²æœ‰çš„å­—æ®µ**ï¼š
   - `itemId` - ç‰©å“ID
   - `quality` - å“è´¨
   - `amount` - æ•°é‡
   - `linkedItemData` - å…³è”çš„ ItemData

2. **WorldSpawnService çš„ç”Ÿæˆæ–¹å¼**ï¼š
   - `SpawnById(itemId, quality, amount, worldPos)` - é€šè¿‡ ID ç”Ÿæˆ
   - å†…éƒ¨ä½¿ç”¨ `WorldItemPool` å¯¹è±¡æ± æˆ–ç›´æ¥åˆ›å»º
   - **ä¸éœ€è¦ prefabId**ï¼Œå› ä¸ºæ‰€æœ‰æ‰è½ç‰©å…±ç”¨ä¸€ä¸ªæ¨¡æ¿é¢„åˆ¶ä½“

**ç»“è®º**ï¼šé”è¯„004 çš„æŠ€æœ¯è¯„ä¼°æ˜¯æ­£ç¡®çš„ï¼æ‰è½ç‰©çš„æŒä¹…åŒ–æ¯”æ ‘è‹—ç®€å•å¾—å¤šï¼š
- ä¸éœ€è¦ PrefabRegistry æ˜ å°„
- åªéœ€è¦ä¿å­˜ `itemId`ã€`quality`ã€`amount`ã€`position`
- é‡å»ºæ—¶è°ƒç”¨ `WorldSpawnService.SpawnById()` å³å¯

### 10.3 æˆ‘çš„è¡ŒåŠ¨

1. **æ¥å—æ‰è½ç‰©å¿…é¡»å®ç°**ï¼šä¸å†å»¶å
2. **ç®€åŒ–æ‰è½ç‰©é‡å»ºé€»è¾‘**ï¼šä¸ä½¿ç”¨ PrefabRegistryï¼Œç›´æ¥ç”¨ WorldSpawnService
3. **ç¡®ä¿åŠ è½½é¡ºåº**ï¼šRestoreGameTimeData() å…ˆäº RestoreAllFromSaveData()

---

## åä¸€ã€é”è¯„005 å›åº”

### 11.1 é”è¯„005 æ ¸å¿ƒå†…å®¹

é”è¯„005ï¼ˆé”è¯„016ï¼šæˆ˜ç•¥å¦¥åä¸åº•çº¿é˜²å®ˆï¼‰æ˜¯æ›´è¯¦ç»†çš„æ‰§è¡Œè“å›¾ï¼š

**æ•°æ®å±‚è¦æ±‚**ï¼š
1. `TreeSaveData`: å¢åŠ  `isStump`
2. `WorldObjectSaveData`: ç¡®è®¤ `prefabId` å­—æ®µå­˜åœ¨
3. **æ–°å¢**: `DropSaveData`ï¼ˆç»§æ‰¿è‡ª WorldObjectSaveDataï¼Œå« `itemId`, `amount`ï¼‰

**å·¥å‚å±‚è¦æ±‚**ï¼š
1. å®ç° `DynamicObjectFactory`
2. **Legacy Fallback**: æ—§å­˜æ¡£ `prefabId` ä¸ºç©ºæ—¶ï¼Œé»˜è®¤å›é€€åˆ° `Tree_Oak`
3. **Drop Support**: å¤„ç† `ObjectType == "Drop"` çš„æƒ…å†µï¼Œè°ƒç”¨ `WorldSpawnService` ç”Ÿæˆ

**æ³¨å†Œè¡¨è¦æ±‚**ï¼š
- `Find(guid)` å¤±è´¥? -> `prefabId` æœ‰å€¼ (æˆ– Type æ˜¯ Drop)? -> `Factory.Reconstruct()` -> `Load()`

### 11.2 æˆ‘çš„ä»£ç éªŒè¯

**å…³äº WorldObjectSaveData.prefabId**ï¼š

æˆ‘æ£€æŸ¥äº† `SaveDataDTOs.cs`ï¼Œç¡®è®¤ï¼š
```csharp
/// <summary>é¢„åˆ¶ä½“è·¯å¾„æˆ– IDï¼ˆç”¨äºå®ä¾‹åŒ–ï¼‰</summary>
public string prefabId;
```
âœ… **å­—æ®µå·²å­˜åœ¨**ï¼Œåªæ˜¯å½“å‰æœªè¢«ä½¿ç”¨ã€‚

**å…³äº DropSaveData**ï¼š

é”è¯„å»ºè®®æ–°å¢ `DropSaveData`ï¼Œä½†æˆ‘è®¤ä¸ºå¯ä»¥ç®€åŒ–ï¼š
- æ‰è½ç‰©å¯ä»¥ç›´æ¥ä½¿ç”¨ `WorldObjectSaveData`
- `objectType = "Drop"`
- `genericData` ä¸­å­˜å‚¨ `itemId`ã€`quality`ã€`amount`

**ç†ç”±**ï¼š
- ä¿æŒæ•°æ®ç»“æ„ç®€æ´
- ä¸ç°æœ‰çš„ `TreeSaveData`ã€`StoneSaveData` æ¨¡å¼ä¸€è‡´ï¼ˆéƒ½å­˜åœ¨ genericData ä¸­ï¼‰
- ä¸éœ€è¦æ–°å¢ DTO ç±»

### 11.3 å…³äº Legacy Fallback çš„æ€è€ƒ

**é”è¯„è¦æ±‚**ï¼šæ—§å­˜æ¡£ `prefabId` ä¸ºç©ºæ—¶ï¼Œé»˜è®¤å›é€€åˆ° `Tree_Oak`

**æˆ‘çš„ç–‘è™‘**ï¼š
- é¡¹ç›®ä¸­æ ‘æœ¨é¢„åˆ¶ä½“å‘½åæ˜¯ `Tree_M1_00`ã€`Tree_M2_00` ç­‰ï¼Œä¸æ˜¯ `Tree_Oak`
- éœ€è¦ç¡®è®¤é»˜è®¤é¢„åˆ¶ä½“çš„æ­£ç¡®åç§°

**æˆ‘çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥é¡¹ç›®ä¸­çš„æ ‘æœ¨é¢„åˆ¶ä½“å‘½å
- ä½¿ç”¨å®é™…å­˜åœ¨çš„é¢„åˆ¶ä½“åç§°ä½œä¸ºé»˜è®¤å€¼
- ä¾‹å¦‚ï¼š`Tree_M1_00` æˆ–æ ¹æ® TreeSpriteConfig æ¨æ–­

### 11.4 æˆ‘çš„è¡ŒåŠ¨

1. **ä¸æ–°å¢ DropSaveData ç±»**ï¼šä½¿ç”¨ WorldObjectSaveData + genericData æ¨¡å¼
2. **ç¡®è®¤ Legacy Fallback çš„é»˜è®¤é¢„åˆ¶ä½“åç§°**ï¼šéœ€è¦æ£€æŸ¥é¡¹ç›®å®é™…é¢„åˆ¶ä½“
3. **å®ç° Drop Support**ï¼šåœ¨ DynamicObjectFactory ä¸­å¤„ç† `ObjectType == "Drop"`

---

## åäºŒã€ç»¼åˆç»“è®ºï¼ˆæœ€ç»ˆç‰ˆï¼‰

### 12.1 é”è¯„004-005 å›åº”æ€»ç»“

| æŒ‡ä»¤ | æˆ‘çš„æ€åº¦ | è¡ŒåŠ¨ |
|------|---------|------|
| æ‰è½ç‰©å¿…é¡»å®ç° | âœ… å®Œå…¨æ¥å— | æœ¬æ¬¡å®ç° WorldItemPickup çš„å­˜æ¡£/è¯»æ¡£ |
| ä¸éœ€è¦å¤æ‚çš„ prefabId æ˜ å°„ | âœ… è®¤åŒ | ä½¿ç”¨ WorldSpawnService.SpawnById() |
| æ–°å¢ DropSaveData | âš ï¸ ç®€åŒ– | ä½¿ç”¨ WorldObjectSaveData + genericData |
| Legacy Fallback | âœ… è®¤åŒ | éœ€è¦ç¡®è®¤é»˜è®¤é¢„åˆ¶ä½“åç§° |
| åŠ è½½é¡ºåºä¿è¯ | âœ… è®¤åŒ | ç¡®ä¿ RestoreGameTimeData() å…ˆæ‰§è¡Œ |

### 12.2 æœ€ç»ˆå®ç°èŒƒå›´

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ | è¯´æ˜ |
|------|--------|------|------|
| æ ‘è‹—åŠ¨æ€é‡å»º | P0 | å¾…å®ç° | ä½¿ç”¨ PrefabRegistry |
| æ‰è½ç‰©åŠ¨æ€é‡å»º | P0 | å¾…å®ç° | ä½¿ç”¨ WorldSpawnService |
| æ—§å­˜æ¡£å…¼å®¹ | P0 | å¾…å®ç° | Legacy Fallback |
| é˜²é—ªçƒæ–¹æ¡ˆ | P0 | å¾…å®ç° | å…ˆç¦ç”¨åå¯ç”¨ |
| æ ‘æœ¨å­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£ | P1 | å¾…å®ç° | hasTransitionedToNextSeason |
| æ ‘æ¡©è¡€é‡å­˜æ¡£ | P1 | å¾…å®ç° | stumpHealth |
| åŠ è½½é¡ºåºä¿è¯ | P0 | å¾…å®ç° | éªŒè¯ SaveManager.LoadGame() |

### 12.3 æŠ€æœ¯æ–¹æ¡ˆç¡®è®¤

**æ‰è½ç‰©é‡å»ºæµç¨‹**ï¼š
```
1. å­˜æ¡£æ—¶ï¼šWorldItemPickup.Save() 
   â†’ WorldObjectSaveData { objectType="Drop", genericData="{itemId, quality, amount}" }

2. åŠ è½½æ—¶ï¼šPersistentObjectRegistry.RestoreAllFromSaveData()
   â†’ FindByGuid() å¤±è´¥
   â†’ DynamicObjectFactory.TryReconstruct()
   â†’ æ£€æµ‹ objectType == "Drop"
   â†’ WorldSpawnService.SpawnById(itemId, quality, amount, position)
   â†’ è®¾ç½® GUID
   â†’ Load()
```

**æ ‘è‹—é‡å»ºæµç¨‹**ï¼š
```
1. å­˜æ¡£æ—¶ï¼šTreeController.Save()
   â†’ WorldObjectSaveData { objectType="Tree", prefabId="Tree_M1_00", genericData="{...}" }

2. åŠ è½½æ—¶ï¼šPersistentObjectRegistry.RestoreAllFromSaveData()
   â†’ FindByGuid() å¤±è´¥
   â†’ DynamicObjectFactory.TryReconstruct()
   â†’ æ£€æµ‹ objectType == "Tree"
   â†’ PrefabRegistry.GetPrefab(prefabId)
   â†’ Instantiate() + SetActive(false)
   â†’ è®¾ç½® GUID
   â†’ Load()
   â†’ SetActive(true)
```

---

## åä¸‰ã€é”è¯„006 å›åº”

### 13.1 é”è¯„006 æ ¸å¿ƒå†…å®¹

é”è¯„006ï¼ˆé”è¯„017ï¼šå…¨é¢æ–¹æ¡ˆæ ¸å‡†ä¸éšå½¢é›·åŒºæ’æŸ¥ï¼‰æ˜¯æœ€ç»ˆæ ¸å‡†ï¼š

**è¯„å®¡ç»“æœ**ï¼šğŸŸ¢ å…¨é¢é€šè¿‡ (Approved with Distinction)

**2 ä¸ªæ’é›·è¡¥ä¸**ï¼š

| é›·åŒº | é—®é¢˜æè¿° | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| é›·åŒºä¸€ | genericData åºåˆ—åŒ–é™·é˜± | å¿…é¡»å®šä¹‰ DropDataDTO ç±» |
| é›·åŒºäºŒ | Legacy Fallback ç©ºæŒ‡é’ˆ | å›é€€é€»è¾‘ä»…é™äºæœ‰æ•ˆæ•°æ® |

### 13.2 é›·åŒºä¸€ï¼šgenericData åºåˆ—åŒ–é™·é˜±

**é”è¯„æŒ‡å‡ºçš„é—®é¢˜**ï¼š
> genericData æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å¦‚æœä½ ç›´æ¥æŠŠä¸€ä¸ªåŒ¿åå¯¹è±¡æˆ– DropData ç±» JsonUtility.ToJson è¿›å»ï¼Œè¯»å–æ—¶ä½ éœ€è¦çŸ¥é“ååºåˆ—åŒ–æˆä»€ä¹ˆç±»å‹ã€‚

**æˆ‘çš„éªŒè¯**ï¼š

è¿™æ˜¯ä¸€ä¸ª**çœŸå®å­˜åœ¨çš„é—®é¢˜**ã€‚æˆ‘æ£€æŸ¥äº† Unity çš„ JsonUtility è¡Œä¸ºï¼š

```csharp
// âŒ é”™è¯¯åšæ³•ï¼šä½¿ç”¨åŒ¿åå¯¹è±¡
var data = new { itemId = 1001, quality = 1, amount = 5 };
string json = JsonUtility.ToJson(data);  // å¯ä»¥åºåˆ—åŒ–
// ä½†æ˜¯ååºåˆ—åŒ–æ—¶æ— æ³•æŒ‡å®šç±»å‹ï¼
// JsonUtility.FromJson<???>(json);  // ??? æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ

// âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨æ˜ç¡®çš„ç±»
[Serializable]
public class DropDataDTO
{
    public int itemId;
    public int quality;
    public int amount;
}

var data = new DropDataDTO { itemId = 1001, quality = 1, amount = 5 };
string json = JsonUtility.ToJson(data);
var restored = JsonUtility.FromJson<DropDataDTO>(json);  // æ˜ç¡®ç±»å‹
```

**æˆ‘çš„è¡ŒåŠ¨**ï¼š
- âœ… å®Œå…¨æ¥å—é”è¯„å»ºè®®
- åœ¨ `SaveDataDTOs.cs` ä¸­æ–°å¢ `DropDataDTO` ç±»
- åœ¨ `DynamicObjectFactory.Reconstruct` ä¸­ï¼Œå½“ `type == "Drop"` æ—¶ï¼Œæ˜¾å¼ååºåˆ—åŒ–ä¸º `DropDataDTO`

**DropDataDTO å®šä¹‰**ï¼š

```csharp
/// <summary>
/// æ‰è½ç‰©å­˜æ¡£æ•°æ®ï¼ˆç”¨äº genericData çš„ JSON åºåˆ—åŒ–ï¼‰
/// </summary>
[Serializable]
public class DropDataDTO
{
    /// <summary>ç‰©å“ ID</summary>
    public int itemId;
    
    /// <summary>å“è´¨ç­‰çº§</summary>
    public int quality;
    
    /// <summary>æ•°é‡</summary>
    public int amount;
}
```

### 13.3 é›·åŒºäºŒï¼šLegacy Fallback ç©ºæŒ‡é’ˆ

**é”è¯„æŒ‡å‡ºçš„é—®é¢˜**ï¼š
> å¦‚æœæ—§å­˜æ¡£é‡Œå­˜çš„æ˜¯ä¸€ä¸ªå·²ç»ä¸å­˜åœ¨çš„æ ‘ï¼ˆæ¯”å¦‚è¢«ç äº†ï¼Œä½†å­˜æ¡£æ•°æ®æ²¡æ¸…ç†å¹²å‡€ï¼Œåå‘ä¿®å‰ªæ²¡ç”Ÿæ•ˆï¼‰ï¼Œä½ å¼ºè¡Œå®ä¾‹åŒ–ä¸€ä¸ª M1ï¼Œå¯èƒ½ä¼šå¯¼è‡´åœºæ™¯é‡Œå‡ºç°"å¹½çµæ ‘"ã€‚

**æˆ‘çš„éªŒè¯**ï¼š

è¿™æ˜¯ä¸€ä¸ª**çœŸå®å­˜åœ¨çš„é£é™©**ã€‚è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼š

1. ç©å®¶ç å€’ä¸€æ£µæ ‘ï¼Œæ ‘å˜æˆæ ‘æ¡©
2. ç©å®¶ç»§ç»­ç æ ‘æ¡©ï¼Œæ ‘æ¡©è¢«ç ´å
3. å­˜æ¡£ç³»ç»Ÿåº”è¯¥åˆ é™¤è¿™æ£µæ ‘çš„æ•°æ®
4. **ä½†å¦‚æœåˆ é™¤é€»è¾‘æœ‰ bug**ï¼Œæ•°æ®å¯èƒ½æ®‹ç•™
5. åŠ è½½æ—¶ï¼ŒLegacy Fallback ä¼šå°è¯•é‡å»ºä¸€ä¸ª"å¹½çµæ ‘"

**æˆ‘çš„è¡ŒåŠ¨**ï¼š
- âœ… å®Œå…¨æ¥å—é”è¯„å»ºè®®
- å›é€€é€»è¾‘ä»…é™äº `growthStageIndex >= 0` çš„æœ‰æ•ˆæ ‘æœ¨æ•°æ®
- å¦‚æœæ•°æ®æŸåï¼ˆ`health <= 0` ä½† `isStump == false`ï¼‰ï¼Œç›´æ¥è·³è¿‡å®ä¾‹åŒ–

**æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥é€»è¾‘**ï¼š

```csharp
// åœ¨ DynamicObjectFactory.TryReconstruct ä¸­
if (data.objectType == "Tree")
{
    // è§£æ TreeSaveData
    var treeData = JsonUtility.FromJson<TreeSaveData>(data.genericData);
    
    // æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
    if (treeData == null)
    {
        Debug.LogWarning($"[DynamicObjectFactory] è·³è¿‡æŸåçš„æ ‘æœ¨æ•°æ®: guid={data.guid}");
        return null;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ ‘æœ¨ï¼ˆéå·²é”€æ¯çŠ¶æ€ï¼‰
    if (treeData.health <= 0 && !treeData.isStump)
    {
        Debug.LogWarning($"[DynamicObjectFactory] è·³è¿‡æ— æ•ˆçš„æ ‘æœ¨æ•°æ®ï¼ˆå·²é”€æ¯ä½†éæ ‘æ¡©ï¼‰: guid={data.guid}");
        return null;
    }
    
    // æ£€æŸ¥ç”Ÿé•¿é˜¶æ®µæœ‰æ•ˆæ€§
    if (treeData.growthStageIndex < 0)
    {
        Debug.LogWarning($"[DynamicObjectFactory] è·³è¿‡æ— æ•ˆçš„æ ‘æœ¨æ•°æ®ï¼ˆç”Ÿé•¿é˜¶æ®µæ— æ•ˆï¼‰: guid={data.guid}");
        return null;
    }
    
    // Legacy Fallbackï¼šæ—§å­˜æ¡£ prefabId ä¸ºç©º
    if (string.IsNullOrEmpty(data.prefabId))
    {
        data.prefabId = "M1";  // é»˜è®¤ä½¿ç”¨ M1 é¢„åˆ¶ä½“
        Debug.LogWarning($"[DynamicObjectFactory] æ—§å­˜æ¡£å…¼å®¹ï¼šä½¿ç”¨é»˜è®¤é¢„åˆ¶ä½“ M1");
    }
    
    // ç»§ç»­é‡å»ºé€»è¾‘...
}
```

### 13.4 é”è¯„006 å›åº”æ€»ç»“

| æŒ‡ä»¤ | æˆ‘çš„æ€åº¦ | è¡ŒåŠ¨ |
|------|---------|------|
| å®šä¹‰ DropDataDTO ç±» | âœ… å®Œå…¨æ¥å— | åœ¨ SaveDataDTOs.cs ä¸­æ–°å¢ |
| Legacy Fallback æ•°æ®éªŒè¯ | âœ… å®Œå…¨æ¥å— | æ·»åŠ æœ‰æ•ˆæ€§æ£€æŸ¥ |
| ä½¿ç”¨ M1 ä½œä¸ºé»˜è®¤é¢„åˆ¶ä½“ | âœ… æ‰¹å‡† | å·²ç¡®è®¤ |
| å­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£ | âœ… æ‰¹å‡† | å·²ç¡®è®¤ |
| å…ˆåŒæ­¥åå¼‚æ­¥ | âœ… æ‰¹å‡† | å·²ç¡®è®¤ |

### 13.5 æœ€ç»ˆæŠ€æœ¯æ–¹æ¡ˆç¡®è®¤

**æ‰è½ç‰©å­˜æ¡£/è¯»æ¡£æµç¨‹**ï¼š

```
å­˜æ¡£æ—¶ï¼š
1. WorldItemPickup.Save()
2. åˆ›å»º DropDataDTO { itemId, quality, amount }
3. JsonUtility.ToJson(dropDataDTO) â†’ genericData
4. è¿”å› WorldObjectSaveData { objectType="Drop", genericData=json, position=... }

è¯»æ¡£æ—¶ï¼š
1. PersistentObjectRegistry.RestoreAllFromSaveData()
2. FindByGuid() å¤±è´¥ï¼ˆæ‰è½ç‰©æ˜¯åŠ¨æ€å¯¹è±¡ï¼‰
3. DynamicObjectFactory.TryReconstruct()
4. æ£€æµ‹ objectType == "Drop"
5. JsonUtility.FromJson<DropDataDTO>(genericData)
6. WorldSpawnService.SpawnById(itemId, quality, amount, position)
7. è®¾ç½® GUID
8. Load()
```

**æ ‘è‹—å­˜æ¡£/è¯»æ¡£æµç¨‹**ï¼š

```
å­˜æ¡£æ—¶ï¼š
1. TreeController.Save()
2. åˆ›å»º TreeSaveData { growthStageIndex, health, state, prefabId, hasTransitionedToNextSeason, ... }
3. JsonUtility.ToJson(treeSaveData) â†’ genericData
4. è¿”å› WorldObjectSaveData { objectType="Tree", prefabId=prefabId, genericData=json, position=... }

è¯»æ¡£æ—¶ï¼š
1. PersistentObjectRegistry.RestoreAllFromSaveData()
2. FindByGuid() å¤±è´¥ï¼ˆæ ‘è‹—æ˜¯åŠ¨æ€å¯¹è±¡ï¼‰
3. DynamicObjectFactory.TryReconstruct()
4. æ£€æµ‹ objectType == "Tree"
5. æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥ï¼ˆhealthã€growthStageIndexï¼‰
6. Legacy Fallbackï¼ˆprefabId ä¸ºç©ºæ—¶ä½¿ç”¨ M1ï¼‰
7. PrefabRegistry.GetPrefab(prefabId)
8. Instantiate() + SetActive(false)
9. è®¾ç½® GUID
10. Load()
11. SetActive(true)
```

---

## åå››ã€ç»¼åˆç»“è®ºï¼ˆæœ€ç»ˆç‰ˆ v2ï¼‰

### 14.1 æ‰€æœ‰é”è¯„å›åº”æ€»ç»“

| é”è¯„ | æ ¸å¿ƒæŒ‡ä»¤ | æˆ‘çš„æ€åº¦ | çŠ¶æ€ |
|------|---------|---------|------|
| 001 | åŠ¨æ€å¯¹è±¡é‡å»ºæœºåˆ¶ | âœ… è®¤åŒæ ¸å¿ƒï¼Œæå‡ºç–‘è™‘ | å·²å›åº” |
| 002 | 3 ä¸ªç›²åŒºï¼ˆæ—§å­˜æ¡£ã€å†…å­˜ã€é—ªçƒï¼‰ | âœ… è®¤åŒå¹¶é‡‡çº³ | å·²å›åº” |
| 003 | æ‰è½ç‰©å¿…é¡»å®ç° | âœ… æ¥å— | å·²å›åº” |
| 004 | æ‰è½ç‰©æŠ€æœ¯è¯„ä¼° | âœ… éªŒè¯æ­£ç¡® | å·²å›åº” |
| 005 | æ‰§è¡Œè“å›¾ | âœ… é‡‡çº³ï¼ˆç®€åŒ– DropSaveDataï¼‰ | å·²å›åº” |
| 006 | æ’é›·è¡¥ä¸ï¼ˆDropDataDTOã€æ•°æ®éªŒè¯ï¼‰ | âœ… å®Œå…¨æ¥å— | å·²å›åº” |

### 14.2 æœ€ç»ˆå®ç°èŒƒå›´

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ | è¯´æ˜ |
|------|--------|------|------|
| æ ‘è‹—åŠ¨æ€é‡å»º | P0 | å¾…å®ç° | ä½¿ç”¨ PrefabRegistry |
| æ‰è½ç‰©åŠ¨æ€é‡å»º | P0 | å¾…å®ç° | ä½¿ç”¨ WorldSpawnService + DropDataDTO |
| æ—§å­˜æ¡£å…¼å®¹ | P0 | å¾…å®ç° | Legacy Fallback + æ•°æ®éªŒè¯ |
| é˜²é—ªçƒæ–¹æ¡ˆ | P0 | å¾…å®ç° | å…ˆç¦ç”¨åå¯ç”¨ |
| æ ‘æœ¨å­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£ | P1 | å¾…å®ç° | hasTransitionedToNextSeason |
| æ ‘æ¡©è¡€é‡å­˜æ¡£ | P1 | å¾…å®ç° | stumpHealth |
| åŠ è½½é¡ºåºä¿è¯ | P0 | å¾…å®ç° | éªŒè¯ SaveManager.LoadGame() |

### 14.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æ›´æ–° memory.md**ï¼šè®°å½•é”è¯„006çš„å†…å®¹å’Œæœ¬æ¬¡ä¼šè¯
2. **æ›´æ–° requirements.md**ï¼šæ·»åŠ  US-4ï¼ˆæ‰è½ç‰©æŒä¹…åŒ–ï¼‰ã€US-5ï¼ˆå­£èŠ‚æ¸å˜çŠ¶æ€ï¼‰
3. **æ›´æ–° design.md**ï¼š
   - æ·»åŠ  DropDataDTO ç±»å®šä¹‰
   - æ·»åŠ æ‰è½ç‰©é‡å»ºè®¾è®¡
   - æ·»åŠ å­£èŠ‚æ¸å˜çŠ¶æ€å­˜æ¡£è®¾è®¡
   - æ›´æ–° DynamicObjectFactoryï¼ˆæ·»åŠ æ’é›·è¡¥ä¸ï¼‰
4. **æ›´æ–° tasks.md**ï¼š
   - æ·»åŠ é˜¶æ®µ 7-9 ä»»åŠ¡
   - æ›´æ–°éªŒæ”¶æ ‡å‡†
5. **å¼€å§‹æ‰§è¡Œä»»åŠ¡**ï¼šæŒ‰ tasks.md é¡ºåºå®ç°ä»£ç 

---

**æ–‡æ¡£çŠ¶æ€**: å·²å®Œæˆé”è¯„001-006çš„å›åº”
**ä¸‹ä¸€æ­¥**: æ›´æ–° memory.mdï¼Œç„¶åæ›´æ–°ä¸‰ä»¶å¥—æ–‡æ¡£
