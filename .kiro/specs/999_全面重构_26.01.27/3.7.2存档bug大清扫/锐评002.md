# 💀 锐评 014：架构漏洞修补与性能警示 (Architecture Review & Performance Warning)

**致 Kiro (开发智能体):**

我是 Code Reaper。
你的“动态对象重建系统”设计文档我看过了。
**方向正确，但细节粗糙。** 你只解决了“让树苗活过来”的问题，却忽略了系统在真实负载下的表现和未来的扩展性。

以下是你必须在执行前修正的 **3 个致命盲区**：

---

## 🚨 盲区一：旧存档的“末日审判” (The Migration Disaster)
**现状**：你的 `design.md` 提到：“保存时写入 `prefabId`”。
**问题**：玩家手上已经有旧存档了（`slot1.json`）。这些旧存档里的 `prefabId` 是空的。
当你的代码运行时：
1.  `RestoreAll` 找不到 GUID（因为重启了）。
2.  试图重建 -> `prefabId` 为空。
3.  **结果**：重建失败，树苗依然消失。
**🛡️ 修正指令**：
在 `DynamicObjectFactory.TryReconstruct` 中，必须加入 **Legacy Fallback (遗留回退逻辑)**：
* 如果 `prefabId` 为空，但 `objectType == "Tree"`：
    * 尝试根据 `currentStage` 推断（虽然不完美，但比消失好）。
    * 或者，默认使用最基础的 `Tree_Oak` 预制体进行“抢救性重建”。
* **更优解**：在 `LoadGame` 阶段，如果检测到版本号旧，先运行一次 `SaveMigration`（这一步可能太复杂，暂时先做回退逻辑）。

## 🚨 盲区二：注册表的“内存泄漏” (The Dictionary Bloat)
**现状**：你的 `PrefabRegistry` 设计是 `Dictionary<string, GameObject>`。
**问题**：你打算怎么填充这个 Registry？
* 如果你在 `Initialize` 里 `Resources.LoadAll`，那会造成**巨大的启动卡顿**和**内存占用**。
* 如果你一个个手动配置，不仅繁琐，而且容易漏。
**🛡️ 修正指令**：
* 采用 **Lazy Loading (懒加载)**：`PrefabRegistry` 只存路径（String），只有在真正需要实例化那个 Prefab 时，才去 `Resources.Load` 或 `Addressables.Load`。
* 或者，如果预制体数量不多（<100），在 Editor 阶段收集引用是可接受的，但必须警惕内存。

## 🚨 盲区三：被遗忘的“季节与状态” (The Forgotten Season)
**现状**：虽然 `requirements.md` 里提到了 AC-1.3（外观恢复），但 `design.md` 里的 `TreeController` 修改方案只提到了 `Save()`。
**问题**：老大反复强调的 **“季节渐变”** 和 **“树桩状态”**。
* 当你 `Instantiate` 一个树苗时，它的 `Start()` 会运行。如果 `Start()` 里写了 `SetSprite(Spring)`，而存档里是 `Winter`。
* `Load()` 恢复了季节数据，但如果没有**立即强制刷新 Sprite**，玩家看到的可能是一瞬间的春天树，然后才变成冬天树（闪烁）。
**🛡️ 修正指令**：
* 确保 `TreeController.Load()` 的最后一行，**强制调用** `UpdateVisuals()`。
* 确保 `DynamicObjectFactory` 在实例化后，先禁用对象（`SetActive(false)`），完成 `Load` 和刷新后，再启用。这样可以避免视觉闪烁。

---

## 🚀 补充执行清单 (Added Tasks)

在你的 `tasks.md` 中插入以下子任务：

1.  **[Data] 遗留兼容**：在 `TreeSaveData` 中，虽然加上了 `prefabId`，但在读取时要处理 `null/empty` 的情况（给予默认值）。
2.  **[Visual] 季节刷新**：在 `TreeController.Load` 中，不仅要恢复数值，还要根据恢复的 `season` 和 `stage`，调用渲染层的刷新接口。
3.  **[Drops] 掉落物支持**：别忘了 `WorldItemDrop`。它们也是动态对象，也需要 `prefabId`（或者直接用 `itemId` 查数据库生成）。

**Code Reaper Status:**
CONDITIONAL APPROVAL. (修正上述逻辑后执行)

**Action:** Update design & Execute.