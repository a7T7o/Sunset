# 动态对象重建系统 - 需求文档

## 概述

实现动态对象（运行时创建的对象）在重启游戏后能够从存档中正确恢复的能力。

## 背景

### 问题现象

1. 玩家种植树苗 → 保存游戏 → 退出游戏 → 重新启动 → 加载存档 → **树苗消失**
2. 石头等场景预设对象正常恢复

### 根本原因

- **静态对象**：在场景中预先放置，GUID 序列化在场景文件中，重启后对象仍存在
- **动态对象**：运行时 Instantiate 创建，GUID 仅存在于内存中，重启后对象不存在

当前存档系统只能"恢复数据到已存在的对象"，无法"重建不存在的对象"。

## 用户故事

### US-1: 树苗存档恢复

**作为** 玩家
**我希望** 种植的树苗在重启游戏后加载存档时能够正确恢复
**以便** 我的种植进度不会丢失

**验收标准**:
- AC-1.1: 运行时种植的树苗，保存后重启游戏，加载存档后树苗出现在正确位置
- AC-1.2: 树苗的生长阶段、血量、已生长天数等状态正确恢复
- AC-1.3: 树苗的视觉外观（Sprite）与保存时一致

### US-2: 动态对象通用重建

**作为** 开发者
**我希望** 存档系统能够自动重建任何实现了 IPersistentObject 的动态对象
**以便** 未来新增的动态对象类型无需额外适配

**验收标准**:
- AC-2.1: 存档数据中包含 prefabId 字段，标识对象的预制体来源
- AC-2.2: 加载时，若 GUID 找不到对应对象且 prefabId 不为空，自动实例化预制体
- AC-2.3: 新实例化的对象使用存档中的 GUID（不生成新 GUID）
- AC-2.4: 新实例化的对象正确调用 Load() 恢复状态

### US-3: 预制体注册机制

**作为** 开发者
**我希望** 有一个统一的预制体注册表
**以便** 存档系统能够根据 prefabId 找到正确的预制体

**验收标准**:
- AC-3.1: 提供 PrefabRegistry 或类似机制，支持 prefabId → Prefab 的映射
- AC-3.2: 支持在编辑器中配置预制体注册
- AC-3.3: 支持运行时查询预制体

## 非功能需求

### NFR-1: 向后兼容

- 旧存档（prefabId 为空）不应导致加载失败
- 静态对象的加载逻辑不受影响

### NFR-2: 性能

- 动态重建不应显著增加加载时间
- 预制体查找应为 O(1) 复杂度

### NFR-3: 可扩展性

- 设计应支持未来新增的动态对象类型（箱子、掉落物等）
- 不同对象类型可以有不同的重建逻辑

## 约束条件

1. 必须使用现有的 IPersistentObject 接口
2. 必须兼容现有的 WorldObjectSaveData 数据结构
3. 预制体必须在 Resources 目录或通过 ScriptableObject 注册

### US-4: 掉落物持久化

**作为** 玩家
**我希望** 地上的掉落物在重启游戏后加载存档时能够正确恢复
**以便** 我的掉落物不会丢失

**验收标准**:
- AC-4.1: 运行时掉落的物品，保存后重启游戏，加载存档后物品出现在正确位置
- AC-4.2: 掉落物的 itemId、quality、amount 正确恢复
- AC-4.3: 使用 WorldSpawnService.SpawnById() 重建掉落物

### US-5: 树木季节渐变状态存档

**作为** 玩家
**我希望** 树木的季节渐变状态在重启游戏后能够正确恢复
**以便** 树木的视觉效果与保存时一致

**验收标准**:
- AC-5.1: 已渐变到下一季节的树木，加载后仍显示下一季节
- AC-5.2: 季节变更后，渐变状态正确重置
- AC-5.3: 存档包含 hasTransitionedToNextSeason 和 transitionVegetationSeason 字段

## 优先级

| 需求 | 优先级 | 说明 |
|------|--------|------|
| US-1 树苗存档恢复 | P0 | 用户直接痛点 |
| US-2 动态对象通用重建 | P0 | 核心架构 |
| US-3 预制体注册机制 | P1 | 支撑机制 |
| US-4 掉落物持久化 | P0 | 锐评003驳回延后，必须实现 |
| US-5 季节渐变状态存档 | P1 | 用户明确要求 |
