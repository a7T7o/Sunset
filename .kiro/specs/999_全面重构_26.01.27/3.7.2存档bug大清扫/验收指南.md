# 动态对象重建系统 - 验收指南

## 🔴 前置配置（必须先完成！）

### 步骤 1：创建 PrefabRegistry 资产

1. 在 Unity 项目窗口中，右键点击 `Assets/111_Data/Database/` 文件夹
2. 选择 **创建 → FarmGame → PrefabRegistry**
   - 如果没有这个菜单项，选择 **创建 → Scripting → ScriptableObject**，然后搜索 `PrefabRegistry`
3. 命名为 `PrefabRegistry`

### 步骤 2：配置预制体映射

1. 选中刚创建的 `PrefabRegistry` 资产
2. 在检查器中，展开 `Prefab Entries` 列表
3. 点击 `+` 添加 3 个条目：

| Prefab Id | Prefab（拖入对应预制体） |
|-----------|------------------------|
| `M1` | `Assets/222_Prefabs/Tree/` 下的 M1 树木预制体 |
| `M2` | `Assets/222_Prefabs/Tree/` 下的 M2 树木预制体 |
| `M3` | `Assets/222_Prefabs/Tree/` 下的 M3 树木预制体 |

### 步骤 3：无需手动配置！

SaveManager 会**自动查找** PrefabRegistry 资产，你不需要手动拖拽。

代码会按以下顺序搜索：
1. `Resources/Data/Database/PrefabRegistry`
2. `Resources/PrefabRegistry`
3. 编辑器模式下会搜索整个项目

只要 PrefabRegistry 资产存在于项目中，SaveManager 启动时就会自动找到它。

---

## 功能验收测试

### 测试 1：树苗存档恢复（核心测试）

**操作步骤**：
1. 运行游戏
2. 种植 3-5 棵树苗（记住位置）
3. 按 **F5** 保存
4. **停止运行**（点击播放按钮停止）
5. 重新运行游戏
6. 按 **F9** 加载

**预期结果**：
- [ ] 树苗全部出现在正确位置
- [ ] 控制台显示 `[PersistentObjectRegistry] 重建了 X 个对象`
- [ ] 无视觉闪烁

---

### 测试 2：树苗生长状态

**操作步骤**：
1. 种植树苗
2. 用时间加速让树苗生长到 Stage 2-3
3. 保存 → 停止 → 重新运行 → 加载

**预期结果**：
- [ ] 生长阶段正确恢复
- [ ] 外观与保存时一致

---

### 测试 3：树桩状态

**操作步骤**：
1. 砍伐成熟的树，变成树桩
2. 保存 → 停止 → 重新运行 → 加载

**预期结果**：
- [ ] 树桩正确恢复
- [ ] 树桩血量正确

---

### 测试 4：掉落物存档

**操作步骤**：
1. 砍树产生掉落物
2. **不要拾取**
3. 保存 → 停止 → 重新运行 → 加载

**预期结果**：
- [ ] 掉落物出现在正确位置
- [ ] 可以正常拾取

---

### 测试 5：旧存档兼容

**操作步骤**：
1. 使用旧存档（如果有的话）
2. 加载

**预期结果**：
- [ ] 不崩溃
- [ ] 旧树苗用 M1 预制体重建

---

## 🛡️ 质量封印验收

### 封印一：DropDataDTO 序列化
打开 `SaveDataDTOs.cs`，确认 `DropDataDTO` 类上方有 `[Serializable]`
- [ ] 已验证

### 封印二：数据有效性检查
打开 `DynamicObjectFactory.cs`，确认 `TryReconstructTree` 在实例化前检查 `health <= 0 && !isStump`
- [ ] 已验证

### 封印三：UpdateSprite 位置
打开 `TreeController.cs`，确认 `Load()` 方法最后一行是 `UpdateSprite()`
- [ ] 已验证

---

## 常见问题

### 树苗仍然消失？
1. 检查 `PrefabRegistry` 是否已创建
2. 检查 `SaveManager` 的 `Prefab Registry` 字段是否已赋值
3. 看控制台有没有 `PrefabRegistry 未初始化` 的错误

### 位置错误？
检查存档文件 `Assets/Saves/slot1.json` 中的 position 数据

---

## 验收签字

| 测试项 | 通过 |
|--------|------|
| 前置配置 | ⬜ |
| 测试 1：树苗存档恢复 | ⬜ |
| 测试 2：树苗生长状态 | ⬜ |
| 测试 3：树桩状态 | ⬜ |
| 测试 4：掉落物存档 | ⬜ |
| 测试 5：旧存档兼容 | ⬜ |
| 封印一 | ⬜ |
| 封印二 | ⬜ |
| 封印三 | ⬜ |

**验收日期**：__________
