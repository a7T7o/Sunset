# å­˜æ¡£ç³»ç»Ÿç´§æ€¥ä¿®å¤ - éœ€æ±‚æ–‡æ¡£ 01

## æ¦‚è¿°

**é”è¯„æ¥æº**: 2ä¿®å¤é˜¶æ®µé”è¯„001  
**é—®é¢˜çº§åˆ«**: ğŸ’€ è‡´å‘½  
**é—®é¢˜æœ¬è´¨**: é€»è¾‘è‡ªæ€ - åœ¨ LoadGame å¼€å¤´è°ƒç”¨ Clear() å¯¼è‡´å­˜æ¡£ç³»ç»Ÿå®Œå…¨å¤±æ•ˆ

---

## é—®é¢˜è¯Šæ–­

### ğŸ’€ è‡´å‘½é”™è¯¯ï¼šè‡ªæ€å¼ Clear()

**æˆ‘ä¹‹å‰çš„é”™è¯¯ä»£ç é€»è¾‘**ï¼š

```csharp
public bool LoadGame(string slotName)
{
    // ğŸ”¥ æˆ‘åœ¨è¿™é‡Œæ¸…ç©ºäº†æ³¨å†Œè¡¨ï¼
    PersistentObjectRegistry.Instance.Clear(); 
    
    // ... è¯»å– JSON ...
    
    // ç„¶åæˆ‘è¯•å›¾é€šè¿‡ GUID å»æ‰¾å¯¹è±¡æ¢å¤æ•°æ®
    // æ­¤æ—¶æ³¨å†Œè¡¨æ˜¯ç©ºçš„ï¼_registry.TryGetValue å…¨éƒ¨è¿”å› falseï¼
    PersistentObjectRegistry.Instance.RestoreAllFromSaveData(worldData);
}
```

**ç¾éš¾æµç¨‹æ¨æ¼”**ï¼š

1. åœºæ™¯é‡Œçš„æ ‘å’Œç®±å­åœ¨ `Start()` æ—¶æŠŠè‡ªå·±æ³¨å†Œè¿›å»äº†
2. ç©å®¶ç‚¹å‡»"åŠ è½½"
3. æˆ‘è°ƒç”¨ `Clear()`ï¼ŒæŠŠè¿™äº›æ´»ç”Ÿç”Ÿçš„å¯¹è±¡å¼•ç”¨å…¨åˆ äº†
4. æ•°æ®è¯»è¿›æ¥äº†ï¼Œä»£ç æ‹¿ç€ `GUID: Tree_01` å»é—®æ³¨å†Œè¡¨ï¼š"è¿™æ£µæ ‘åœ¨å“ªï¼Ÿ"
5. æ³¨å†Œè¡¨å›ç­”ï¼š"ä¸çŸ¥é“ï¼Œæˆ‘ç©ºäº†ã€‚"
6. **ç»“æœ**ï¼šæ‰€æœ‰æ•°æ®çš„ Restore æ“ä½œå…¨éƒ¨è·³è¿‡ã€‚æ‰€æœ‰çš„åå‘ä¿®å‰ªé€»è¾‘ä¹Ÿå…¨éƒ¨å¤±æ•ˆï¼ˆå› ä¸º Keys ä¹Ÿæ˜¯ç©ºçš„ï¼‰

**æˆ‘æ‰€è°“çš„"Registry ç”Ÿå‘½å‘¨æœŸä¿®å¤"ï¼Œå˜æˆäº†"Registry è„‘æ­»äº¡"ã€‚**

---

## éœ€æ±‚æ¸…å•

### R1: åˆ é™¤è‡ªæ€å¼ Clear() è°ƒç”¨

**ç”¨æˆ·æ•…äº‹**ï¼š
> ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›åŠ è½½å­˜æ¡£åæ¸¸æˆçŠ¶æ€èƒ½æ­£ç¡®æ¢å¤ï¼Œè€Œä¸æ˜¯ä»€ä¹ˆéƒ½æ²¡å˜ã€‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `SaveManager.LoadGame()` å¼€å¤´**ä¸å†è°ƒç”¨** `PersistentObjectRegistry.Instance.Clear()`
- [ ] åŠ è½½å­˜æ¡£åï¼Œæ ‘æœ¨/ç®±å­/çŸ³å¤´çŠ¶æ€èƒ½æ­£ç¡®æ¢å¤

---

### R2: å®ç° PruneStaleRecords() æ–¹æ³•

**ç”¨æˆ·æ•…äº‹**ï¼š
> ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘éœ€è¦ä¸€ç§æ–¹å¼æ¸…ç†"å·²ç»é”€æ¯ä½†è¿˜åœ¨æ³¨å†Œè¡¨é‡Œçš„ç©ºå¼•ç”¨"ï¼Œè€Œä¸æ˜¯æ¸…ç©ºæ‰€æœ‰ã€‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] `PersistentObjectRegistry` æ–°å¢ `PruneStaleRecords()` æ–¹æ³•
- [ ] è¯¥æ–¹æ³•åªç§»é™¤ Value ä¸º null çš„é”®å€¼å¯¹ï¼ˆå¯¹è±¡å·²è¢« Destroyï¼‰
- [ ] åœ¨ `SaveManager.LoadGame()` å¼€å¤´è°ƒç”¨ `PruneStaleRecords()` æ›¿ä»£ `Clear()`

---

### R3: ä¿®æ­£ ChestController çš„ç¡¬ç¼–ç 

**ç”¨æˆ·æ•…äº‹**ï¼š
> ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘å¸Œæœ›ç®±å­å®¹é‡ä»å­˜æ¡£æ•°æ®ä¸­è¯»å–ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç ã€‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ£€æŸ¥ `ChestController` ä¸­æ˜¯å¦æœ‰ `new ChestInventoryV2(20)` ç¡¬ç¼–ç 
- [ ] å¦‚æœ `storageData` ä¸ä¸ºç©ºï¼Œä½¿ç”¨ `storageData.capacity`
- [ ] å¦‚æœå­˜æ¡£æ•°æ®ä¸­æœ‰ `capacity`ï¼Œä¼˜å…ˆä½¿ç”¨å­˜æ¡£æ•°æ®

---

### R4: éªŒè¯åå‘ä¿®å‰ªé€»è¾‘

**ç”¨æˆ·æ•…äº‹**ï¼š
> ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›è¢«ç æ‰çš„æ ‘åœ¨åŠ è½½å­˜æ¡£åä¸ä¼š"å¤æ´»"ã€‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] åå‘ä¿®å‰ªé€»è¾‘åœ¨ Registry æœ‰æ•°æ®çš„å‰æä¸‹æ­£å¸¸å·¥ä½œ
- [ ] å…ˆè·å– `currentRegistryKeys`ï¼ˆåœºæ™¯é‡Œæ´»ç€çš„ï¼‰
- [ ] å†éå† `saveDataList` æ¢å¤æ•°æ®
- [ ] æœ€åéå† `currentRegistryKeys`ï¼Œå¦‚æœå®ƒä¸åœ¨ `saveDataList` é‡Œï¼Œè¯´æ˜å®ƒè¯¥æ­» â†’ `SetActive(false)`

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `Assets/YYY_Scripts/Data/Core/SaveManager.cs` | åˆ é™¤ Clear() è°ƒç”¨ï¼Œæ”¹ä¸º PruneStaleRecords() |
| `Assets/YYY_Scripts/Data/Core/PersistentObjectRegistry.cs` | æ–°å¢ PruneStaleRecords() æ–¹æ³• |
| `Assets/YYY_Scripts/World/Placeable/ChestController.cs` | æ£€æŸ¥å¹¶ä¿®æ­£ç¡¬ç¼–ç å®¹é‡ |

---

## ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | éœ€æ±‚ | è¯´æ˜ |
|--------|------|------|
| P0 | R1 | åˆ é™¤è‡ªæ€å¼ Clear()ï¼Œè¿™æ˜¯å­˜æ¡£ç³»ç»Ÿå¤±æ•ˆçš„ç›´æ¥åŸå›  |
| P0 | R2 | å®ç° PruneStaleRecords()ï¼Œæ­£ç¡®çš„æ¸…ç†æ–¹å¼ |
| P1 | R3 | ä¿®æ­£ç¡¬ç¼–ç ï¼Œé¿å…å®¹é‡ä¸ä¸€è‡´ |
| P1 | R4 | éªŒè¯åå‘ä¿®å‰ªï¼Œç¡®ä¿å·²åˆ é™¤ç‰©ä½“ä¸å¤æ´» |

