# ğŸ’€ é”è¯„ 007ï¼šæ–‡æ¡£æ ¸å‡†ä¸ä»£ç ç´§æ€¥çº å (Spec Approval & Code Correction)

**è‡´ Kiro:**
ä½ è™½ç„¶çŠ¯äº†â€œæŠ¢è·‘â€çš„å¤§å¿Œï¼Œä½†æ›´æ–°åçš„ `requirements.md` å’Œ `design.md` è´¨é‡ç¡®å®æœ‰äº†è´¨çš„é£è·ƒã€‚ä½ å¸æ”¶äº†å…³äº Registry ç”Ÿå‘½å‘¨æœŸå’Œåå‘ä¿®å‰ªçš„å»ºè®®ï¼Œç°åœ¨çš„è®¾è®¡æ–¹æ¡ˆå·²ç»è§¦åŠäº†é—®é¢˜çš„æœ¬è´¨ã€‚

**æ–‡æ¡£è¯„å®¡ç»“æœï¼šâœ… é€šè¿‡ (Approved)**
ä½ çš„è®¾è®¡é€»è¾‘ç°åœ¨æ˜¯é—­ç¯çš„ã€‚

ä½†æ˜¯ï¼Œé‰´äºä½ å·²ç»â€œæŠ¢è·‘â€ä¿®æ”¹äº†ä¸€éƒ¨åˆ†ä»£ç ï¼ˆ`ChestController` ç­‰ï¼‰ï¼Œæˆ‘å¿…é¡»æŒ‡å‡ºä½ ç›®å‰ä»£ç ä¸­**å°šæœªä¿®å¤**ä¸”**æåº¦å±é™©**çš„å‡ ä¸ªç‚¹ã€‚ä½ æ¥ä¸‹æ¥çš„å·¥ä½œå¿…é¡»æ˜¯**å¡«å‘**ï¼Œè€Œä¸æ˜¯ç»§ç»­æŒ–æ–°å‘ã€‚

---

## ğŸš¨ ç´§æ€¥çº åæŒ‡ä»¤ (Emergency Corrections)

### 1. ğŸ’€ Registry çš„å•ä¾‹é™·é˜± (The Singleton Trap)
**ç°çŠ¶**ï¼šä½ è™½ç„¶åœ¨æ–‡æ¡£é‡Œå†™äº†è¦ä¿®ï¼Œä½†æˆ‘çœ‹ä½ ç›®å‰æäº¤çš„ä»£ç é‡Œï¼Œ**è¿˜æ²¡åŠ¨ `PersistentObjectRegistry.cs`**ã€‚
**é£é™©**ï¼šç°åœ¨çš„ Registry ä¾ç„¶æ˜¯ `DontDestroyOnLoad` ä¸”æ²¡æœ‰æ¸…ç©ºæœºåˆ¶ã€‚å¦‚æœä½ ç°åœ¨å»æµ‹è¯»æ¡£ï¼Œä¸Šä¸€å±€çš„æ¸¸æˆå¯¹è±¡å¼•ç”¨ä¾ç„¶æ®‹ç•™åœ¨ Registry é‡Œï¼Œ**å¿…å´©æ— ç–‘**ã€‚
**ğŸ› ï¸ æŒ‡ä»¤**ï¼š
* ä½ çš„ç¬¬ä¸€ä¸ªä»£ç ä»»åŠ¡ï¼Œå¿…é¡»æ˜¯ä¿®æ”¹ `PersistentObjectRegistry.cs`ã€‚
* æ·»åŠ  `Clear()` æ–¹æ³•ï¼š
    ```csharp
    public void Clear() {
        _registry.Clear();
        // å¦‚æœæœ‰æŒ‰ç±»å‹ç´¢å¼•çš„å­—å…¸ï¼Œä¹Ÿè¦æ¸…ç©º
    }
    ```
* åœ¨ `SaveManager.LoadGame()` çš„**ç¬¬ä¸€è¡Œ**ï¼Œè°ƒç”¨ `PersistentObjectRegistry.Instance.Clear()`ã€‚

### 2. ğŸŒ² åå‘ä¿®å‰ªçš„å®ç°ç»†èŠ‚ (The Pruning Logic)
**ç°çŠ¶**ï¼šè®¾è®¡æ–‡æ¡£æåˆ°äº†â€œåå‘ä¿®å‰ªâ€ï¼Œä½†è¿™éœ€è¦ç²¾ç»†çš„æ“ä½œã€‚
**ğŸ› ï¸ æŒ‡ä»¤**ï¼š
åœ¨ `PersistentObjectRegistry.RestoreAllFromSaveData(List<WorldObjectSaveData> saveDataList)` ä¸­å®ç°ä»¥ä¸‹é€»è¾‘ï¼š
1.  **æ„å»ºå­˜æ¡£å¿«ç…§**ï¼šå°† `saveDataList` é‡Œçš„ GUID å­˜å…¥ä¸€ä¸ª `HashSet<string> savedGuids`ã€‚
2.  **å¿«ç…§å½“å‰åœºæ™¯**ï¼šè·å–å½“å‰ `_registry` çš„ keys å‰¯æœ¬ï¼ˆ`new List<string>(_registry.Keys)`ï¼‰ã€‚
3.  **ä¿®å‰ª (Pruning)**ï¼š
    ```csharp
    foreach (var guid in currentRegistryKeys) {
        // å¦‚æœåœºæ™¯é‡Œæœ‰è¿™ä¸ªå¯¹è±¡ï¼Œä½†å­˜æ¡£é‡Œæ²¡æœ‰ -> è¯´æ˜ç©å®¶æŠŠå®ƒåˆ äº†ï¼ˆç æ ‘/æŒ–ç®±å­ï¼‰
        if (!savedGuids.Contains(guid)) {
            var obj = _registry[guid];
            if (obj != null) {
                // æ‰§è¡Œé”€æ¯é€»è¾‘ (Disable æˆ– Destroy)
                // æ³¨æ„ï¼šå¯¹äºæ ‘æœ¨ï¼Œå¯èƒ½éœ€è¦è°ƒç”¨ç‰¹å®šçš„ Hide() æ–¹æ³•è€Œä¸æ˜¯ Destroyï¼Œå–å†³äºæ± åŒ–ç­–ç•¥
                obj.gameObject.SetActive(false); 
            }
        }
    }
    ```
4.  **æ¢å¤ (Restoring)**ï¼šç„¶åå†éå† `saveDataList` è¿›è¡Œ `Load()`ã€‚

### 3. ğŸ“¦ ç®±å­ç©ºçŠ¶æ€çš„â€œæ­»é”â€ (Chest State Deadlock)
**ç°çŠ¶**ï¼šä½ ä¿®æ”¹äº† `ChestController.Load`ï¼Œç¡®ä¿äº† `_inventory` åˆå§‹åŒ–ã€‚
**éšæ‚£**ï¼š`SyncV2ToInventory` åªæ˜¯æ•°æ®å±‚åŒæ­¥ã€‚
**ğŸ› ï¸ æŒ‡ä»¤**ï¼š
åœ¨ `ChestController.Load()` çš„æœ€åï¼Œ**å¼ºåˆ¶è°ƒç”¨ä¸€æ¬¡çŠ¶æ€æ£€æŸ¥**ã€‚
å¦‚æœä½ çš„ `ChestController` æœ‰ `UpdateSprite()` æˆ– `CheckLockState()` æ–¹æ³•ï¼Œå¿…é¡»åœ¨è¿™é‡Œæ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ï¼Œç¡®ä¿è§†è§‰çŠ¶æ€ï¼ˆå¼€/å…³ï¼‰ä¸æ•°æ®ä¸€è‡´ã€‚

---

## ğŸš€ æ‰§è¡Œè·¯å¾„ (Execution Path)

ä½ ç°åœ¨çš„ä»£ç å¤„äºâ€œåŠæˆå“â€çŠ¶æ€ã€‚æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œä¿®å¤ï¼Œ**ä¸¥ç¦è·³æ­¥**ï¼š

1.  **[Core] Registry ä¿®å¤**ï¼šå®ç° `Clear()` å’Œ `SaveManager` è°ƒç”¨ã€‚è¿™æ˜¯åœ°åŸºã€‚
2.  **[Core] åå‘ä¿®å‰ª**ï¼šåœ¨ `RestoreAllFromSaveData` ä¸­å®ç°â€œä¸åœ¨å­˜æ¡£å³é”€æ¯â€çš„é€»è¾‘ã€‚
3.  **[Player] ä½ç½®ä¿®æ­£**ï¼šå®ç° `SaveManager` å¯¹ Player ä½ç½®çš„å¼ºåˆ¶è®¾ç½®ï¼ˆç¦ç”¨ç‰©ç† -> ç§»ä½ -> å¯ç”¨ç‰©ç† -> é‡ç½® Toolï¼‰ã€‚
4.  **[Feature] éªŒè¯**ï¼šæœ€åå†å»éªŒè¯çŸ³å¤´å’Œæ ‘æœ¨çš„è¯»æ¡£ã€‚

**Code Reaper Status:** WATCHING.
**Action:** Execute the plan.