
你好，老大。Code Reaper (锐评专家) 收到。

你的纠正如同手术刀般精准。我确实在上一轮分析中遗漏了 箱子 (Chest) 的顽疾。 箱子的问题和石头、掉落物、房子都不一样。它不是“消失了”，而是**“状态不同步”（明明空了，系统却以为还有东西；或者明明读档了，库存却没刷新）。这是一个典型的数据一致性 (Data Consistency)** 问题。

我已将“箱子幽灵库存 Bug”纳入核心修复清单，并与之前的三个大坑（石头假死、通用组件、掉落物独立）整合。

以下是完整、全面、无死角的终极诊断与重构方案。

🔍 存档系统终极诊断与重构方案 (Complete Diagnosis & Master Plan)
🎯 核心目标
彻底解决 静态物体复活/消失、掉落物逻辑断裂、通用物体不保存 以及 箱子状态不同步 四大顽疾，打造一个真正闭环的持久化生态。

一、 四大核心病灶 (The Four Horsemen of Bugs)
1. 📦 箱子幽灵库存 (Phantom Inventory)
现象：箱子里的东西拿光了，但用镐子敲不掉（提示“箱子不为空”）；或者读档后，UI 显示空，但逻辑层认为有东西。

根本病因：双数据源不同步。

ChestController 同时维护了 UI 层的 _inventory (运行时) 和数据层的 _inventoryV2 (存档用)。

在 Load() 之后，数据只恢复到了 _inventoryV2，但没有正确地强制刷新到 _inventory。

或者 IsEmpty 的判断逻辑只检查了其中一个，导致状态打架。

2. 🪨 石头/静态物体“永久死亡” (The Permadeath Bug)
现象：保存 -> 挖掉石头 -> 读档 -> 石头彻底消失（未复原）。

根本病因：Destroy() 的不可逆性。

静态物体在被挖掘时直接 Destroy，导致内存引用丢失。读档时系统找不到它，自然无法恢复。

正确逻辑：静态物体只能“假死” (SetActive(false))，不能“真死”。

3. 🏠 房子/建筑位置不复原 (The Homeless Bug)
现象：移动房子后读档，位置回滚。

根本病因：“无身份”。

房子没有挂载 IPersistentObject，也没有被自动化脚本扫描到。SaveManager 根本不知道它的存在。

4. 🎒 掉落物逻辑断裂 (Linked Data Loss)
现象：挖矿后不拾取 -> 存档 -> 读档 -> 石头没了，掉落物也没了。

根本病因：掉落物未进入“动态重建名单”。

WorldItemPickup 虽然有接口，但未被正确注册或保存。

二、 针对性解决方案 (The Solutions)
✅ 方案一：箱子状态强制同步 (Chest Synchronization)
目标：彻底消灭幽灵库存，确保“所见即所得”。

措施：

修改 ChestController.Load()：

读取 _inventoryV2 后，立即、强制调用 SyncV2ToInventory()。

随后调用 UpdateSpriteState() 刷新外观（开/关）。

修正 IsEmpty 属性：

必须同时检查 _inventory.IsEmpty 和 _inventoryV2.IsEmpty，或者统一以 _inventory 为准（因为它驱动 UI）。

调试后门：

在 OnInteract 时，如果玩家敲不掉箱子，打印 Debug Log：[Chest] IsEmpty Check: Inv={_inventory.IsEmpty}, V2={_inventoryV2.IsEmpty}，让 Bug 无处遁形。

✅ 方案二：静态物体“假死机制” (Feign Death)
目标：让石头、树木“死”后能复活。

措施：

修改 StoneController：

将 Destroy(gameObject) 改为 gameObject.SetActive(false)。

修改 PersistentObjectRegistry：

在 RestoreAll 时，如果存档数据显示该对象存在（且不是树桩），强制执行 obj.gameObject.SetActive(true)。

这能救回那些被错误隐藏的石头。

✅ 方案三：通用标签存档组件 (Generic Save Component)
目标：让房子、路灯等装饰物也能自动存档。

措施：

创建 GenericPersistentObject.cs：

一个只存 transform.position, rotation 的简单脚本。

升级自动化守门员 (PersistentIdAutomator)：

增加 Inspector 配置列表：Save Tags（如 Building, Prop）。

自动扫描带有这些 Tag 的物体，如果没有 IPersistentObject，自动挂载 GenericPersistentObject 并生成 GUID。

✅ 方案四：PrefabRegistry 重构 (Smart Scanner)
目标：一键扫描，拒绝手动搬运。

措施：

重写编辑器面板，支持文件夹拖入。

一键递归扫描文件夹下所有 Prefab，自动注册，自动命名，自动去重。

三、 执行路线图 (Execution Roadmap)
老大，这是覆盖了箱子问题的最终作战计划：

[工具升级] PrefabRegistry 重构：实现智能文件夹扫描，解决手动配置痛点。

[逻辑修复] 箱子同步：修改 ChestController，强制同步 V2 和 Inventory，修正 IsEmpty 判断。

[逻辑修复] 静态物体假死：修改 StoneController，禁止 Destroy，改为 Disable。

[新功能] 通用存档支持：创建通用组件，升级自动化脚本支持 Tag 扫描。

[数据验证] 掉落物：验证 WorldItemPickup 的 Save/Load 链路。

如果这个方案通过，Kiro 将立即开始执行。这次，一个 Bug 都不留。