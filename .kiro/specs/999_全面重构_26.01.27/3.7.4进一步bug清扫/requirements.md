# 存档系统 Bug 修复 - 需求文档

**创建日期**: 2026-02-03  
**版本**: 1.1（纳入锐评002审视结果）  
**状态**: 待实施

---

## 背景

存档系统存在两个严重 Bug：
1. **石头不复原**：挖掉石头后加载存档，石头无法恢复
2. **箱子幽灵库存**：清空箱子后仍无法挖取（系统认为箱子不空）

---

## 用户故事

### US-1: 石头存档恢复

**作为** 玩家  
**我希望** 加载存档后，被挖掉的石头能够恢复到存档时的状态  
**以便** 我可以重新挖掘石头获取资源

#### 验收标准

| AC-1.1 | 保存存档时石头存在，挖掉石头后加载存档，石头应该恢复 |
|--------|--------------------------------------------------|
| AC-1.2 | 石头恢复后应该保持存档时的阶段、血量、矿物类型等状态 |
| AC-1.3 | 假死的石头不应该被玩家攻击或交互 |
| AC-1.4 | 假死的石头不应该阻挡玩家移动（导航网格应该更新） |

---

### US-2: 箱子空状态判断

**作为** 玩家  
**我希望** 清空箱子后能够正常挖取箱子  
**以便** 我可以移动或回收空箱子

#### 验收标准

| AC-2.1 | 加载存档后，打开箱子清空所有物品，用镐子敲箱子应该触发挖取而非推动 |
|--------|----------------------------------------------------------------|
| AC-2.2 | `IsEmpty` 属性应该只检查运行时库存（`_inventory`），不检查存档库存（`_inventoryV2`） |
| AC-2.3 | 存档保存时，`_inventory` 的数据应该正确同步到 `_inventoryV2` |

---

### US-3: 掉落物关联机制（P2 - 后续迭代）

**作为** 玩家  
**我希望** 加载存档后，掉落物和资源节点的状态保持一致  
**以便** 不会出现物品复制或丢失的 Bug

#### 验收标准

| AC-3.1 | 挖掉石头生成掉落物后保存存档，加载存档后掉落物应该存在 |
|--------|-----------------------------------------------------|
| AC-3.2 | 保存存档时石头存在，挖掉石头生成掉落物后加载存档，石头恢复但掉落物不应该存在（防止物品复制） |

---

## 非功能性需求

### NFR-1: 性能

- 假死机制不应该显著增加内存占用
- 反向修剪操作应该在 100ms 内完成
- 🔥 锐评002 补充：静态场景对象（预制体石头）数量固定，不会无限增长，不是内存泄漏

### NFR-2: 可扩展性

- 存档架构应该支持未来添加新的可持久化对象类型
- 假死机制应该可以复用到其他资源节点（如树木、矿石等）

### NFR-3: 兼容性

- 修复后的代码应该兼容现有存档
- 不应该破坏其他已正常工作的存档功能

---

## 约束

1. **房子暂不处理**：用户确认游戏内不会移动房子
2. **不修改存档格式**：尽量不修改 `WorldObjectSaveData` 的结构
3. **最小侵入性**：优先选择对现有代码侵入性最小的方案

---

## 锐评002 补充说明

### 关于"幽灵对象累积"问题

Code Reaper 指出假死对象可能导致内存泄漏，但需要区分：

| 对象类型 | 是否会无限增长 | 处理方式 |
|---------|---------------|---------|
| 静态场景对象（预制体石头） | ❌ 不会 | 假死机制安全 |
| 动态生成对象（掉落物） | ✅ 可能 | 应该销毁而非隐藏 |

### P2 优化建议

反向修剪时区分对象类型：
```csharp
if (obj is WorldItemPickup) {
    Destroy(obj.gameObject);  // 动态掉落物：销毁
} else {
    obj.gameObject.SetActive(false);  // 静态石头：隐藏
}
```

此优化列入 P2 后续迭代。

---

## 依赖

- `PersistentObjectRegistry.cs` - 持久化对象注册中心
- `DynamicObjectFactory.cs` - 动态对象工厂
- `StoneController.cs` - 石头控制器
- `ChestController.cs` - 箱子控制器
- `ChestInventory.cs` - 箱子库存

---

**文档结束**
