# è¿›ä¸€æ­¥ Bug æ¸…æ‰« - å¼€å‘è®°å¿†

## æ¨¡å—æ¦‚è¿°

å¯¹å­˜æ¡£ç³»ç»Ÿè¿›è¡Œå…¨é¢å®¡æŸ¥ï¼Œè§£å†³æ ‘æœ¨ã€çŸ³å¤´ã€æˆ¿å­ã€ç®±å­ã€æ‰è½ç‰©ç­‰å¯¹è±¡çš„å­˜æ¡£æ¢å¤é—®é¢˜ã€‚

## å½“å‰çŠ¶æ€

- **å®Œæˆåº¦**: 100%ï¼ˆæ‰€æœ‰ä»£ç ä»»åŠ¡å®Œæˆï¼Œå¾…æ‰‹åŠ¨éªŒè¯ï¼‰
- **æœ€åæ›´æ–°**: 2026-02-03
- **çŠ¶æ€**: å…¨éƒ¨ä»£ç ä¿®æ”¹å®Œæˆï¼Œå¾…éªŒè¯

## ä¼šè¯è®°å½•

### ä¼šè¯ 1 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> æ ‘æœ¨æ­£ç¡®äº†ï¼Œæˆ¿å­ä½ç½®å¹¶æ²¡æœ‰å¤åŸï¼Œä¹Ÿå°±æ˜¯æˆ¿å­å¹¶æ²¡æœ‰æ³¨å†Œè¿›å»...çŸ³å¤´å¹¶ä¸ä¼šå¤åŸï¼Œè¢«æŒ–å–çš„ä¸ä¼šå¤åŸï¼Œä½†æ˜¯èƒŒåŒ…å†…çš„çŸ³å¤´å’ŒçŸ¿çŸ³ç¡®å®æ¶ˆå¤±äº†...å¯¹äºè¿™äº›å¯èƒ½ç”Ÿæˆæ‰è½ç‰©çš„ç‰©ä½“å’Œä»–çš„æ‰è½ç‰©æˆ‘è®¤ä¸ºä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªéšè—æ•°æ®è¿›è¡Œé“¾æ¥...ç®±å­bugè¿˜æ˜¯å­˜åœ¨

**å®Œæˆä»»åŠ¡**:
1. é˜…è¯»å­˜æ¡£ç³»ç»Ÿç›¸å…³ä»£ç å’Œæ–‡æ¡£
2. åˆ†æ `PersistentObjectRegistry.cs` å’Œ `DynamicObjectFactory.cs`
3. ç¡®è®¤å½“å‰å®ç°äº† `IPersistentObject` æ¥å£çš„ç±»
4. åˆ›å»ºå…¨é¢é—®é¢˜åˆ†ææŠ¥å‘Š

---

### ä¼šè¯ 2 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> æ–¹æ¡ˆAå…¶å®è¿˜æ˜¯å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜å‘€ï¼Œå¦‚æœçŸ³å¤´è¢«æŒ–æ‰äº†ç„¶åè¿™ä¸ªæ—¶å€™å…¶å®åœºæ™¯æ˜¯æ²¡æœ‰è¿™ä¸ªçŸ³å¤´äº†ä¹Ÿæ²¡æœ‰è¿™ä¸ªGUIDäº†ï¼Œè¿™æ ·åˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ
> ç®±å­é—®é¢˜æ˜¯ï¼šç®±å­çœ‹ç€æ˜¯ç©ºçš„ï¼Œä½†æ— æ³•æŒ–å–ï¼ˆç³»ç»Ÿè®¤ä¸ºå®ƒä¸ç©ºï¼‰ã€‚ä¿å­˜çš„æ—¶å€™ç®±å­é‡Œé¢æœ‰ä¸œè¥¿ï¼Œç„¶åå†è¯»å–å­˜æ¡£åå°±ç®—æ‹¿å¹²å‡€äº†ç®±å­é‡Œé¢çš„ä¸œè¥¿äº†ä½†è¿˜æ˜¯æ²¡æœ‰åŠæ³•æŒ–å–æ‰
> å¯¹äºæˆ¿å­æˆ‘ä»¬å°±ä¸å¤„ç†äº†ï¼Œæ¸¸æˆå†…ä¸ä¼šç§»åŠ¨

**å®Œæˆä»»åŠ¡**:
1. æ·±åº¦ä»£ç å®¡æŸ¥ `StoneController.cs`ã€`ChestController.cs`
2. éªŒè¯ç”¨æˆ·æå‡ºçš„é—®é¢˜åœºæ™¯
3. ç‹¬ç«‹æ€è€ƒå¹¶åˆ†æè¾…åŠ©æ–‡æ¡£çš„å»ºè®®
4. æ›´æ–°é—®é¢˜åˆ†ææŠ¥å‘Š V2

**å…³é”®å‘ç°**:

| é—®é¢˜ | æ ¹å› ï¼ˆä»£ç éªŒè¯ï¼‰ | è§£å†³æ–¹æ¡ˆ |
|------|-----------------|---------|
| çŸ³å¤´ä¸å¤åŸ | `DestroyStone()` ä½¿ç”¨ `Destroy()` è€Œé `SetActive(false)`ï¼Œä¸”ä» `PersistentObjectRegistry` æ³¨é”€ | å‡æ­»æœºåˆ¶ + ä¸æ³¨é”€ |
| ç®±å­å¹½çµåº“å­˜ | `IsEmpty` æ£€æŸ¥ä¸¤ä¸ªåº“å­˜ç³»ç»Ÿï¼Œä½† UI æ“ä½œåªä¿®æ”¹ `_inventory`ï¼Œ`_inventoryV2` æœªåŒæ­¥ | ä¿®æ”¹ `IsEmpty` åªæ£€æŸ¥ `_inventory` |
| æˆ¿å­ä¸å¤åŸ | ç”¨æˆ·ç¡®è®¤æš‚ä¸å¤„ç† | - |

**ç‹¬ç«‹æ€è€ƒï¼ˆå¯¹è¾…åŠ©æ–‡æ¡£çš„å®¡è§†ï¼‰**:

| è¾…åŠ©æ–‡æ¡£å»ºè®® | æˆ‘çš„åˆ¤æ–­ | ç†ç”± |
|-------------|---------|------|
| é™æ€ç‰©ä½“å‡æ­»æœºåˆ¶ | âœ… è®¤åŒ | æ­£ç¡®æ–¹å‘ |
| ç®±å­åŒæ•°æ®æºä¸åŒæ­¥ | âœ… è®¤åŒ | æ­£ç¡®è¯Šæ–­ |
| "RestoreAll æ—¶å¼ºåˆ¶ SetActive(true)" | âŒ æœ‰é—®é¢˜ | åº”è¯¥åœ¨ Load() å†…éƒ¨å¤„ç† |
| GenericPersistentObject | â¸ï¸ æš‚ç¼“ | ç”¨æˆ·ç¡®è®¤æˆ¿å­æš‚ä¸å¤„ç† |

**ä¿®å¤ä¼˜å…ˆçº§**:

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | çŠ¶æ€ |
|--------|------|------|
| P0 | ç®±å­ IsEmpty ä¿®å¤ | å¾…å®æ–½ |
| P0 | çŸ³å¤´å‡æ­»æœºåˆ¶ | å¾…å®æ–½ |
| P0 | çŸ³å¤´æ³¨é”€é€»è¾‘ä¿®å¤ | å¾…å®æ–½ |
| P1 | ç®±å­å®æ—¶åŒæ­¥ | å¾…å®æ–½ |
| P1 | çŸ³å¤´åŠ¨æ€é‡å»ºæ”¯æŒ | å¾…å®æ–½ |
| P2 | æ‰è½ç‰©å…³è”æœºåˆ¶ | å¾…è®¾è®¡ |

---

### ä¼šè¯ 3 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> é˜…è¯» Gemini é”è¯„ï¼ŒæŒ‰è§„åˆ™å®¡æ ¸ï¼Œæ›´æ–°åˆ†ææ–‡æ¡£ï¼Œç”Ÿæˆä¸‰ä»¶å¥—ï¼ˆrequirements.md, design.md, tasks.mdï¼‰

**å®Œæˆä»»åŠ¡**:
1. é˜…è¯» Gemini é”è¯„ï¼ˆé”è¯„001.mdï¼‰
2. ç‹¬ç«‹æ€è€ƒå¹¶å®¡è§†é”è¯„çš„æ¯ä¸ªè§‚ç‚¹
3. éªŒè¯ `PersistentObjectRegistry` çš„å®ç°ï¼ˆä½¿ç”¨ Dictionary è€Œé FindObjectsOfTypeï¼‰
4. æ›´æ–°åˆ†ææŠ¥å‘Šåˆ° V3ï¼Œçº³å…¥é”è¯„å®¡è§†ç»“æœ
5. åˆ›å»º requirements.md
6. åˆ›å»º design.md
7. åˆ›å»º tasks.md

**Gemini é”è¯„å®¡è§†ç»“æœ**:

| Gemini è§‚ç‚¹ | æˆ‘çš„åˆ¤æ–­ | ç†ç”± |
|------------|---------|------|
| `FindObjectsOfType` æ‰¾ä¸åˆ° Inactive å¯¹è±¡ | âŒ **é”™è¯¯** | æˆ‘ä»¬ä½¿ç”¨ Dictionary å­˜å‚¨ï¼Œä¸ç”¨ FindObjectsOfType |
| éœ€è¦"æ­»äº¡æŒä¹…åŒ–"å­˜å‚¨ isDead çŠ¶æ€ | âš ï¸ **ä¸éœ€è¦** | åå‘ä¿®å‰ªæœºåˆ¶ä¼šå¤„ç†"å­˜æ¡£ä¸­æ²¡æœ‰"çš„æƒ…å†µ |
| ç®±å­åŒæ•°æ®æºæ˜¯é—®é¢˜æ ¹æº | âœ… **æ­£ç¡®** | ç¡®å®æ˜¯é—®é¢˜æ ¹æº |
| å°† V2 é™çº§ä¸ºçº¯ DTO | âœ… **æ­£ç¡®** | ä½†ä¸éœ€è¦"ä¸¢å¼ƒ"ï¼Œåªéœ€è¦ä¸å‚ä¸è¿è¡Œæ—¶åˆ¤æ–­ |
| æ‰è½ç‰©"å‡ºç”Ÿå³æ³¨å†Œ" | âœ… **æ­£ç¡®** | åº”è¯¥ç«‹å³æ³¨å†Œ |

**å…³é”®æŠ€æœ¯éªŒè¯**:

Gemini æ‹…å¿ƒ `FindObjectsOfType` æ‰¾ä¸åˆ° Inactive å¯¹è±¡ï¼Œä½†å®é™…ä»£ç éªŒè¯ï¼š
```csharp
// PersistentObjectRegistry.cs - ä½¿ç”¨ Dictionary å­˜å‚¨
private Dictionary<string, IPersistentObject> _registry = new Dictionary<string, IPersistentObject>();
```

å‡æ­»å¯¹è±¡ä»åœ¨ `_registry` ä¸­ï¼Œå¯ä»¥è¢«éå†åˆ°ã€‚Gemini çš„æ‹…å¿§åŸºäºé”™è¯¯çš„å‡è®¾ã€‚

**åˆ›å»ºçš„æ–‡ä»¶**:
- `requirements.md` - éœ€æ±‚æ–‡æ¡£
- `design.md` - è®¾è®¡æ–‡æ¡£
- `tasks.md` - ä»»åŠ¡åˆ—è¡¨

**é—ç•™é—®é¢˜**:
- [ ] æ‰§è¡Œ P0 ä»»åŠ¡ï¼ˆçŸ³å¤´å‡æ­»æœºåˆ¶ã€ç®±å­ IsEmpty ä¿®å¤ï¼‰
- [ ] æ‰§è¡Œ P1 ä»»åŠ¡ï¼ˆç®±å­å®æ—¶åŒæ­¥ã€çŸ³å¤´åŠ¨æ€é‡å»ºï¼‰
- [ ] æ‰‹åŠ¨éªŒè¯ä¿®å¤æ•ˆæœ

---

### ä¼šè¯ 4 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> æ ¹æ®é”è¯„002æ›´æ–°ä¸‰ä»¶å¥—å†…å®¹ï¼Œç„¶åæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡

**å®Œæˆä»»åŠ¡**:
1. æ›´æ–° requirements.mdï¼ˆv1.1ï¼‰- çº³å…¥é”è¯„002å…³äº"å¹½çµå¯¹è±¡ç´¯ç§¯"çš„åˆ†æ
2. æ›´æ–° design.mdï¼ˆv1.1ï¼‰- è¡¥å……é”è¯„002çš„é£é™©è¯„ä¼°
3. æ›´æ–° tasks.mdï¼ˆv1.1ï¼‰- çŠ¶æ€æ”¹ä¸ºæ‰§è¡Œä¸­
4. æ‰§è¡Œ P0 ä»»åŠ¡ - çŸ³å¤´å‡æ­»æœºåˆ¶
5. æ‰§è¡Œ P0 ä»»åŠ¡ - ç®±å­ IsEmpty ä¿®å¤
6. Unity ç¼–è¯‘éªŒè¯é€šè¿‡

**ä¿®æ”¹æ–‡ä»¶**:
- `Assets/YYY_Scripts/Controller/StoneController.cs` - DestroyStone() æ”¹ä¸ºå‡æ­»æœºåˆ¶
- `Assets/YYY_Scripts/World/Placeable/ChestController.cs` - IsEmpty åªæ£€æŸ¥ _inventory
- `requirements.md` - æ›´æ–°åˆ° v1.1
- `design.md` - æ›´æ–°åˆ° v1.1
- `tasks.md` - æ ‡è®° P0 ä»»åŠ¡å®Œæˆ

**é”è¯„002 å®¡è§†ç»“æœ**:

| Code Reaper è§‚ç‚¹ | æˆ‘çš„åˆ¤æ–­ | ç†ç”± |
|-----------------|---------|------|
| è®¤å¯æˆ‘çš„æ–¹æ¡ˆ | âœ… æ¥å— | æ–¹æ¡ˆé€»è¾‘è‡ªæ´½ |
| å¹½çµå¯¹è±¡ç´¯ç§¯é—®é¢˜ | âš ï¸ éƒ¨åˆ†æ­£ç¡® | é™æ€å¯¹è±¡ä¸ä¼šæ— é™å¢é•¿ï¼ŒåŠ¨æ€å¯¹è±¡éœ€è¦æ³¨æ„ |
| ä¿®å‰ªå³é”€æ¯å»ºè®® | âœ… æ­£ç¡® | å¯¹åŠ¨æ€å¯¹è±¡åº”è¯¥é”€æ¯ï¼Œä½†æ˜¯ P2 ä¼˜åŒ– |
| æ‰¹å‡†æ‰§è¡Œ P0/P1 | âœ… æ¥å— | å¯ä»¥å¼€å§‹æ‰§è¡Œ |

**P0 ä¿®æ”¹è¯¦æƒ…**:

1. **StoneController.DestroyStone()**:
   - `Destroy()` â†’ `SetActive(false)`
   - ä¿ç•™ `ResourceNodeRegistry.Unregister()`
   - ä¸ä» `PersistentObjectRegistry` æ³¨é”€
   - æ·»åŠ è°ƒè¯•æ—¥å¿—

2. **ChestController.IsEmpty**:
   - åŸï¼š`(_inventoryV2 == null || _inventoryV2.IsEmpty) && (_inventory == null || _inventory.IsEmpty)`
   - æ”¹ï¼š`_inventory == null || _inventory.IsEmpty`
   - æ·»åŠ æ³¨é‡Šè¯´æ˜ä¿®æ”¹åŸå› 

**é—ç•™é—®é¢˜**:
- [ ] æ‰‹åŠ¨éªŒè¯çŸ³å¤´å­˜æ¡£æ¢å¤
- [ ] æ‰‹åŠ¨éªŒè¯ç®±å­ç©ºçŠ¶æ€åˆ¤æ–­
- [ ] P1 ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰ï¼šç®±å­å®æ—¶åŒæ­¥ã€çŸ³å¤´åŠ¨æ€é‡å»º

---

### ä¼šè¯ 5 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> çŸ³å¤´çš„æ¢å¤å¯èƒ½éœ€è¦æ›´åŠ æ·±å…¥çš„åˆ†æä¸€ä¸‹çŸ³å¤´è¢«æŒ–å–åçš„é€»è¾‘å¤„ç†...çŸ³å¤´å…¨éƒ¨æŒ–å–å StoneDebris æ˜¯æŒ–å–åçš„æ˜¾ç¤ºå†…å®¹...é‡ç‚¹æ˜¯çŸ³å¤´æŒ–åˆ°æœ€åæ¶ˆå¤±æ—¶ä¼šè®© active å˜æˆ falseï¼Œä½†æ ‘æœ¨è¢«æŒ–å–åˆ™æ˜¯ç›´æ¥åˆ é™¤äº†...å½“å‰çš„çŸ³å¤´å¯èƒ½å¤åŸäº†ï¼Œä½†æ˜¯å› ä¸ºæ¿€æ´»çŠ¶æ€è¿˜æ˜¯ false æ‰€ä»¥æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥

**æ·±åº¦åˆ†æç»“æœ**:

ç”¨æˆ·çš„åˆ†æå®Œå…¨æ­£ç¡®ï¼å‘ç°äº†ä¸€ä¸ª**è‡´å‘½æ¼æ´**ï¼š

| ç‰¹æ€§ | æ ‘æœ¨ (TreeController) | çŸ³å¤´ (StoneController) |
|------|----------------------|----------------------|
| **é”€æ¯æ–¹å¼** | `Destroy()` - çœŸæ­£é”€æ¯ | `SetActive(false)` - å‡æ­» |
| **æ¢å¤æœºåˆ¶** | `DynamicObjectFactory` åŠ¨æ€é‡å»º | ä¾èµ–åå‘ä¿®å‰ª + `Load()` |
| **Load() å†…å®¹** | æ¢å¤æ•°æ® + æ›´æ–°è§†è§‰ | ğŸ”´ åªæ¢å¤æ•°æ®ï¼Œ**æ²¡æœ‰æ¿€æ´»å¯¹è±¡ï¼** |

**è‡´å‘½æ¼æ´è¯¦æƒ…**ï¼š

`StoneController.Load()` ç¼ºå°‘ä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š
1. **æ²¡æœ‰ `SetActive(true)`** - å‡æ­»çš„çŸ³å¤´æ¢å¤åä»ç„¶æ˜¯ Inactive
2. **æ²¡æœ‰é‡ç½® `isDepleted = false`** - æ¢å¤å `isDepleted` ä»ç„¶æ˜¯ `true`
3. **æ²¡æœ‰é‡æ–°æ³¨å†Œåˆ° `ResourceNodeRegistry`** - æ¢å¤åçš„çŸ³å¤´æ— æ³•è¢«æ”»å‡»

**æ ¹å› åˆ†æ**ï¼š

è¿™æ˜¯è®¾è®¡-ä»»åŠ¡æ˜ å°„çš„å¤±èŒã€‚è®¾è®¡æ–‡æ¡£ä¸­åº”è¯¥æ˜ç¡®"å‡æ­»æœºåˆ¶éœ€è¦åœ¨ Load() ä¸­æ¢å¤æ¿€æ´»çŠ¶æ€"ï¼Œä½†ä»»åŠ¡æ–‡æ¡£æ²¡æœ‰å®Œæ•´æ˜ å°„è¿™ä¸ªä¿®æ”¹ç‚¹ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```csharp
public void Load(WorldObjectSaveData data)
{
    // ... ç°æœ‰çš„æ•°æ®æ¢å¤é€»è¾‘ ...
    
    // ğŸ”¥ æ–°å¢ï¼šæ¢å¤æ¿€æ´»çŠ¶æ€
    isDepleted = false;
    
    // æ¿€æ´»å¯¹è±¡
    if (transform.parent != null)
        transform.parent.gameObject.SetActive(true);
    else
        gameObject.SetActive(true);
    
    // é‡æ–°æ³¨å†Œåˆ° ResourceNodeRegistry
    if (ResourceNodeRegistry.Instance != null)
    {
        ResourceNodeRegistry.Instance.Register(this);
    }
}
```

**æ›´æ–°çš„æ–‡ä»¶**:
- `design.md` - æ›´æ–°åˆ° v1.2ï¼Œè¡¥å…… Load() æ¿€æ´»é€»è¾‘è®¾è®¡
- `tasks.md` - æ›´æ–°åˆ° v1.2ï¼Œæ·»åŠ ä»»åŠ¡ 1.3ï¼ˆLoad() ä¿®å¤ï¼‰å’Œ 1.4ï¼ˆStoneDebris æ¸…ç†ï¼‰
- `memory.md` - è®°å½•è‡´å‘½æ¼æ´å‘ç°

**é—ç•™é—®é¢˜**:
- [ ] æ‰§è¡Œä»»åŠ¡ 1.3ï¼ˆä¿®æ”¹ StoneController.Load()ï¼‰
- [ ] æ‰§è¡Œä»»åŠ¡ 1.4ï¼ˆStoneDebris æ¸…ç†ï¼Œå¯é€‰ï¼‰
- [ ] æ‰‹åŠ¨éªŒè¯çŸ³å¤´å­˜æ¡£æ¢å¤

---

### ä¼šè¯ 6 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> ç»§ç»­æ‰§è¡Œä»»åŠ¡ 1.3

**å®Œæˆä»»åŠ¡**:
1. ä¿®æ”¹ `StoneController.Load()` æ–¹æ³•
   - æ·»åŠ  `isDepleted = false` é‡ç½®
   - æ·»åŠ  `SetActive(true)` æ¿€æ´»å¯¹è±¡
   - æ·»åŠ  `ResourceNodeRegistry.Register(this, gameObject.GetInstanceID())` é‡æ–°æ³¨å†Œ
   - æ›´æ–°è°ƒè¯•æ—¥å¿—

**ä¿®æ”¹æ–‡ä»¶**:
- `StoneController.cs` - Load() æ–¹æ³•æ·»åŠ æ¿€æ´»é€»è¾‘
- `design.md` - æ›´æ–°åˆ° v1.2
- `tasks.md` - æ›´æ–°åˆ° v1.2ï¼Œæ ‡è®°ä»»åŠ¡ 1.3 å®Œæˆ
- `memory.md` - è®°å½•ä¼šè¯ 5 å’Œ 6

**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸï¼ˆ4 ä¸ªæ— å…³è­¦å‘Šï¼‰

**é—ç•™é—®é¢˜**:
- [ ] æ‰‹åŠ¨éªŒè¯çŸ³å¤´å­˜æ¡£æ¢å¤
- [ ] æ‰‹åŠ¨éªŒè¯ç®±å­ç©ºçŠ¶æ€åˆ¤æ–­
- [ ] ä»»åŠ¡ 1.4ï¼ˆStoneDebris æ¸…ç†ï¼Œå¯é€‰ï¼‰

---

### ä¼šè¯ 7 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> æ‰è½ç‰©å¹¶æœªä¿®å¤ï¼Œæ˜¯å¦ä»»åŠ¡åˆ—è¡¨è¿˜æœªå…¨éƒ¨å®Œæˆï¼Ÿä½†æ˜¯ç°åœ¨çŸ³å¤´ç¡®å®å¯ä»¥æ¢å¤æˆåŠŸäº†ï¼Œä½†æ˜¯æ‰è½ç‰©å’Œstonedebrisä¸ä¼šé”€æ¯ï¼Œè¿™ä¸ªå¾ˆä¸å¯¹ï¼Œä½ è¿˜æ˜¯æ²¡æœ‰å®Œå–„ï¼Œè¯·ä½ ç»§ç»­å®Œæˆå‰©ä½™å†…å®¹ï¼Œæˆ‘éœ€è¦éªŒæ”¶æœ€å®Œæ•´çš„å†…å®¹

**é—®é¢˜åˆ†æ**:

ç”¨æˆ·éªŒè¯å‘ç°ï¼š
1. âœ… çŸ³å¤´æ¢å¤æˆåŠŸ
2. âŒ æ‰è½ç‰©æœªé”€æ¯ - åœ°ä¸Šçš„å°çŸ³å¤´ï¼ˆæ‰è½ç‰©ï¼‰è¿˜åœ¨
3. â“ StoneDebris - è¿™æ˜¯ä¸´æ—¶ç¢ç‰‡æ•ˆæœï¼Œä¼šåœ¨ 0.5 ç§’åè‡ªåŠ¨é”€æ¯

**æ ¹å› åˆ†æ**:

1. **æ‰è½ç‰©æ²¡æœ‰æ³¨å†Œåˆ° PersistentObjectRegistry**
   - `WorldItemPickup` æ²¡æœ‰åœ¨ `Start()` ä¸­æ³¨å†Œ
   - åå‘ä¿®å‰ªæ— æ³•æ‰¾åˆ°æ‰è½ç‰©ï¼Œæ‰€ä»¥æ— æ³•é”€æ¯

2. **åå‘ä¿®å‰ªé€»è¾‘ä¸åŒºåˆ†å¯¹è±¡ç±»å‹**
   - åŸé€»è¾‘å¯¹æ‰€æœ‰å¯¹è±¡éƒ½ä½¿ç”¨ `SetActive(false)`
   - æ‰è½ç‰©æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œåº”è¯¥è¢«é”€æ¯è€Œéç¦ç”¨

**ä¿®å¤å†…å®¹**:

1. **WorldItemPickup.cs**:
   - æ·»åŠ  `Start()` ä¸­æ³¨å†Œåˆ° `PersistentObjectRegistry`
   - æ·»åŠ  `OnDestroy()` ä¸­ä» `PersistentObjectRegistry` æ³¨é”€

2. **PersistentObjectRegistry.cs**:
   - ä¿®æ”¹åå‘ä¿®å‰ªé€»è¾‘ï¼ŒåŒºåˆ†åŠ¨æ€å¯¹è±¡å’Œé™æ€å¯¹è±¡
   - åŠ¨æ€å¯¹è±¡ï¼ˆ`WorldItemPickup`ï¼‰ä½¿ç”¨ `Destroy()` é”€æ¯
   - é™æ€å¯¹è±¡ï¼ˆçŸ³å¤´ã€æ ‘æœ¨ï¼‰ä½¿ç”¨ `SetActive(false)` ç¦ç”¨

**ä¿®æ”¹æ–‡ä»¶**:
- `WorldItemPickup.cs` - æ·»åŠ æ³¨å†Œ/æ³¨é”€é€»è¾‘
- `PersistentObjectRegistry.cs` - ä¿®æ”¹åå‘ä¿®å‰ªé€»è¾‘
- `tasks.md` - æ·»åŠ ä»»åŠ¡ 3ï¼ˆæ‰è½ç‰©åå‘ä¿®å‰ªä¿®å¤ï¼‰
- `memory.md` - è®°å½•ä¼šè¯ 7

**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸï¼ˆ4 ä¸ªæ— å…³è­¦å‘Šï¼‰

**é—ç•™é—®é¢˜**:
- [ ] æ‰‹åŠ¨éªŒè¯æ‰è½ç‰©é”€æ¯
- [ ] æ‰‹åŠ¨éªŒè¯çŸ³å¤´å­˜æ¡£æ¢å¤
- [ ] æ‰‹åŠ¨éªŒè¯ç®±å­ç©ºçŠ¶æ€åˆ¤æ–­

---

### ä¼šè¯ 8 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> æ‰€æœ‰å¯é€‰ä»»åŠ¡å‡ä¸ºå¿…é¡»å®Œæˆçš„ä»»åŠ¡ï¼Œè¯·ä½ å…¨éƒ¨å®Œæˆï¼Œé«˜æ•ˆé«˜è´¨é‡çš„å®Œæˆæ‰€æœ‰å†…å®¹

**å®Œæˆä»»åŠ¡**:

1. **ä»»åŠ¡ 4 - ç®±å­å®æ—¶åŒæ­¥**
   - åœ¨ `ChestController.Initialize()` ä¸­è®¢é˜… `_inventory.OnInventoryChanged` äº‹ä»¶
   - æ·»åŠ  `OnInventoryChangedHandler()` äº‹ä»¶å¤„ç†å™¨ï¼Œè°ƒç”¨ `SyncInventoryToV2()`
   - åœ¨ `OnDestroy()` ä¸­å–æ¶ˆè®¢é˜…äº‹ä»¶ï¼Œé¿å…å†…å­˜æ³„æ¼

2. **ä»»åŠ¡ 5 - çŸ³å¤´åŠ¨æ€é‡å»ºæ”¯æŒ**
   - åœ¨ `DynamicObjectFactory.TryReconstruct()` ä¸­æ·»åŠ  "Stone" ç±»å‹åˆ¤æ–­
   - å®ç° `TryReconstructStone()` æ–¹æ³•ï¼Œæ”¯æŒçŸ³å¤´çš„åŠ¨æ€é‡å»º
   - åœ¨ `StoneController` ä¸­æ·»åŠ  `SetPersistentIdForLoad()` æ–¹æ³•
   - æ›´æ–° `SetPersistentId()` è¾…åŠ©æ–¹æ³•ï¼Œæ”¯æŒ StoneController

3. **ä»»åŠ¡ 6 - æ‰è½ç‰©å…³è”æœºåˆ¶**
   - åœ¨ `DropDataDTO` ä¸­æ·»åŠ  `sourceNodeGuid` å­—æ®µ
   - åœ¨ `WorldItemPickup` ä¸­æ·»åŠ  `sourceNodeGuid` å­—æ®µå’Œ `SetSourceNodeGuid()` æ–¹æ³•
   - ä¿®æ”¹ `WorldItemPickup.Save()` å’Œ `Load()` ä¿å­˜/æ¢å¤ `sourceNodeGuid`
   - ä¿®æ”¹ `StoneController.SpawnOreDrops()` å’Œ `SpawnStoneDrops()` è®¾ç½®æ¥æº GUID
   - åœ¨ `DynamicObjectFactory.TryReconstructDrop()` ä¸­æ·»åŠ å…³è”æ£€æŸ¥

**ä¿®æ”¹æ–‡ä»¶**:
- `ChestController.cs` - æ·»åŠ äº‹ä»¶è®¢é˜…å’Œå¤„ç†å™¨
- `DynamicObjectFactory.cs` - æ·»åŠ çŸ³å¤´é‡å»ºæ”¯æŒå’Œæ‰è½ç‰©å…³è”æ£€æŸ¥
- `StoneController.cs` - æ·»åŠ  SetPersistentIdForLoad() å’Œæ‰è½ç‰©æ¥æºè®¾ç½®
- `WorldItemPickup.cs` - æ·»åŠ  sourceNodeGuid å­—æ®µå’Œç›¸å…³æ–¹æ³•
- `SaveDataDTOs.cs` - åœ¨ DropDataDTO ä¸­æ·»åŠ  sourceNodeGuid å­—æ®µ
- `tasks.md` - æ›´æ–°ä»»åŠ¡çŠ¶æ€

**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸï¼ˆ4 ä¸ªæ— å…³è­¦å‘Šï¼‰

**é—ç•™é—®é¢˜**:
- [ ] æ‰‹åŠ¨éªŒè¯çŸ³å¤´å­˜æ¡£æ¢å¤
- [ ] æ‰‹åŠ¨éªŒè¯ç®±å­ç©ºçŠ¶æ€åˆ¤æ–­
- [ ] æ‰‹åŠ¨éªŒè¯æ‰è½ç‰©å…³è”æœºåˆ¶

---

## å…³é”®å†³ç­–

| å†³ç­– | åŸå›  | æ—¥æœŸ |
|------|------|------|
| æˆ¿å­æš‚ä¸å¤„ç† | ç”¨æˆ·ç¡®è®¤æ¸¸æˆå†…ä¸ä¼šç§»åŠ¨æˆ¿å­ | 2026-02-03 |
| çŸ³å¤´ä½¿ç”¨å‡æ­»æœºåˆ¶ | `Destroy()` å¯¼è‡´æ— æ³•é€šè¿‡åå‘ä¿®å‰ªæ¢å¤ | 2026-02-03 |
| çŸ³å¤´ä¸ä» PersistentObjectRegistry æ³¨é”€ | å¦åˆ™åå‘ä¿®å‰ªæ— æ³•æ‰¾åˆ°è¿™ä¸ªçŸ³å¤´ | 2026-02-03 |
| ç®±å­ IsEmpty åªæ£€æŸ¥ _inventory | _inventoryV2 åªç”¨äºå­˜æ¡£ï¼Œä¸å‚ä¸è¿è¡Œæ—¶é€»è¾‘ | 2026-02-03 |

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `å­˜æ¡£ç³»ç»Ÿå…¨é¢é—®é¢˜åˆ†ææŠ¥å‘Š.md` | è¯¦ç»†é—®é¢˜åˆ†ææŠ¥å‘Š V3ï¼ˆå«é”è¯„å®¡è§†ï¼‰ |
| `åˆ†æè¾…åŠ©æ–‡æ¡£.md` | å¦ä¸€ä¸ªæ™ºèƒ½ä½“çš„åˆ†æï¼ˆå·²å®¡è§†ï¼‰ |
| `é”è¯„001.md` | Gemini é”è¯„ï¼ˆå·²å®¡è§†ï¼‰ |
| `requirements.md` | éœ€æ±‚æ–‡æ¡£ |
| `design.md` | è®¾è®¡æ–‡æ¡£ |
| `tasks.md` | ä»»åŠ¡åˆ—è¡¨ |
| `Assets/YYY_Scripts/Controller/StoneController.cs` | çŸ³å¤´æ§åˆ¶å™¨ï¼ˆéœ€è¦å‡æ­»æœºåˆ¶ï¼‰ |
| `Assets/YYY_Scripts/World/Placeable/ChestController.cs` | ç®±å­æ§åˆ¶å™¨ï¼ˆéœ€è¦ IsEmpty ä¿®å¤ï¼‰ |
| `Assets/YYY_Scripts/Data/Core/PersistentObjectRegistry.cs` | æŒä¹…åŒ–å¯¹è±¡æ³¨å†Œä¸­å¿ƒ |
| `Assets/YYY_Scripts/Data/Core/DynamicObjectFactory.cs` | åŠ¨æ€å¯¹è±¡å·¥å‚ï¼ˆéœ€è¦çŸ³å¤´é‡å»ºæ”¯æŒï¼‰ |


---

### ä¼šè¯ 9 - 2026-02-03

**ç”¨æˆ·éœ€æ±‚**:
> æ‰€æœ‰å¯é€‰ä»»åŠ¡å‡ä¸ºå¿…é¡»å®Œæˆçš„ä»»åŠ¡ï¼Œè¯·ä½ å…¨éƒ¨å®Œæˆï¼Œé«˜æ•ˆé«˜è´¨é‡çš„å®Œæˆæ‰€æœ‰å†…å®¹
> ç”¨æˆ·éªŒè¯å‘ç°ï¼šStoneDebris æ— é™åˆ·å‡ºã€ç®±å­ä¸æ¢å¤ï¼ˆGUID å†²çªï¼‰

**å®Œæˆä»»åŠ¡**:

1. **ä»»åŠ¡ 1.4 - StoneDebris æ¸…ç†**
   - åœ¨ `PersistentObjectRegistry.RestoreAllFromSaveData()` å¼€å§‹æ—¶è°ƒç”¨ `CleanupStoneDebris()`
   - æ–°å¢ `CleanupStoneDebris()` æ–¹æ³•ï¼ŒæŸ¥æ‰¾å¹¶é”€æ¯æ‰€æœ‰åç§°ä»¥ "StoneDebris_" å¼€å¤´çš„å¯¹è±¡
   - StoneDebris æ˜¯ä¸´æ—¶ç¢ç‰‡æ•ˆæœï¼Œä¸æ˜¯æŒä¹…åŒ–å¯¹è±¡ï¼ŒåŠ è½½å­˜æ¡£æ—¶éœ€è¦æ¸…ç†

2. **ä»»åŠ¡ 9 - ç®±å­åŠ¨æ€é‡å»ºæ”¯æŒ**
   - åœ¨ `ChestController` ä¸­æ·»åŠ  `SetPersistentIdForLoad()` æ–¹æ³•
   - åœ¨ `ChestController.Save()` ä¸­ä¿å­˜ `prefabId`ï¼ˆä½¿ç”¨ storageData.nameï¼‰
   - åœ¨ `DynamicObjectFactory.TryReconstruct()` ä¸­æ·»åŠ  "Chest" ç±»å‹åˆ¤æ–­
   - å®ç° `TryReconstructChest()` æ–¹æ³•
   - æ›´æ–° `SetPersistentId()` è¾…åŠ©æ–¹æ³•ï¼Œæ·»åŠ  ChestController æ”¯æŒ

**ä¿®æ”¹æ–‡ä»¶**:
- `PersistentObjectRegistry.cs` - æ·»åŠ  StoneDebris æ¸…ç†é€»è¾‘
- `ChestController.cs` - æ·»åŠ  SetPersistentIdForLoad()ã€Save() ä¿å­˜ prefabId
- `DynamicObjectFactory.cs` - æ·»åŠ ç®±å­é‡å»ºæ”¯æŒ

**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸï¼ˆ4 ä¸ªæ— å…³è­¦å‘Šï¼‰

**é…ç½®è¦æ±‚**:
- ç®±å­åŠ¨æ€é‡å»ºéœ€è¦åœ¨ PrefabRegistry ä¸­é…ç½®ç®±å­é¢„åˆ¶ä½“æ˜ å°„
- prefabId ä½¿ç”¨ StorageData çš„èµ„äº§åç§°

**é—ç•™é—®é¢˜**:
- [ ] æ‰‹åŠ¨éªŒè¯ StoneDebris æ¸…ç†
- [ ] æ‰‹åŠ¨éªŒè¯ç®±å­åŠ¨æ€é‡å»º
- [ ] åœ¨ PrefabRegistry ä¸­é…ç½®ç®±å­é¢„åˆ¶ä½“

