# å­˜æ¡£ç³»ç»Ÿå…¨é¢é—®é¢˜åˆ†ææŠ¥å‘Š V3

**åˆ›å»ºæ—¥æœŸ**: 2026-02-03  
**æ›´æ–°æ—¥æœŸ**: 2026-02-03  
**åˆ›å»ºè€…**: é¡¹ç›®ä¸»ç¼–è¾‘äºº  
**çŠ¶æ€**: æ·±åº¦åˆ†æå®Œæˆ + Gemini é”è¯„å®¡è§†å®Œæˆï¼Œå¾…å®æ–½

---

## ğŸ” Gemini é”è¯„å®¡è§†ç»“æœ

### å®¡è§†æ€»ç»“

| Gemini è§‚ç‚¹ | æˆ‘çš„åˆ¤æ–­ | ç†ç”± |
|------------|---------|------|
| `FindObjectsOfType` æ‰¾ä¸åˆ° Inactive å¯¹è±¡ | âŒ **é”™è¯¯** | æˆ‘ä»¬ä½¿ç”¨ Dictionary å­˜å‚¨ï¼Œä¸ç”¨ FindObjectsOfType |
| éœ€è¦"æ­»äº¡æŒä¹…åŒ–"å­˜å‚¨ isDead çŠ¶æ€ | âš ï¸ **ä¸éœ€è¦** | åå‘ä¿®å‰ªæœºåˆ¶ä¼šå¤„ç†"å­˜æ¡£ä¸­æ²¡æœ‰"çš„æƒ…å†µ |
| ç®±å­åŒæ•°æ®æºæ˜¯é—®é¢˜æ ¹æº | âœ… **æ­£ç¡®** | ç¡®å®æ˜¯é—®é¢˜æ ¹æº |
| å°† V2 é™çº§ä¸ºçº¯ DTO | âœ… **æ­£ç¡®** | ä½†ä¸éœ€è¦"ä¸¢å¼ƒ"ï¼Œåªéœ€è¦ä¸å‚ä¸è¿è¡Œæ—¶åˆ¤æ–­ |
| æ‰è½ç‰©"å‡ºç”Ÿå³æ³¨å†Œ" | âœ… **æ­£ç¡®** | åº”è¯¥ç«‹å³æ³¨å†Œ |

### å…³é”®æŠ€æœ¯éªŒè¯

**Gemini æ‹…å¿ƒçš„é—®é¢˜**ï¼š
> "å¦‚æœ SaveManager åªæ˜¯ FindObjectsOfType<IPersistentObject>()ï¼Œå®ƒæ‰¾ä¸åˆ°è¢«ç¦ç”¨çš„ç‰©ä½“ï¼"

**å®é™…ä»£ç éªŒè¯**ï¼š
```csharp
// PersistentObjectRegistry.cs - ä½¿ç”¨ Dictionary å­˜å‚¨ï¼Œä¸æ˜¯ FindObjectsOfType
private Dictionary<string, IPersistentObject> _registry = new Dictionary<string, IPersistentObject>();

// GetAllSaveable() éå†çš„æ˜¯ _registry.Values
public IEnumerable<IPersistentObject> GetAllSaveable()
{
    return _registry.Values.Where(obj => obj.ShouldSave);
}
```

**ç»“è®º**ï¼šå‡æ­»å¯¹è±¡ï¼ˆ`SetActive(false)`ï¼‰ä»ç„¶åœ¨ `_registry` ä¸­ï¼Œ**å¯ä»¥è¢«éå†åˆ°**ã€‚Gemini çš„æ‹…å¿§åŸºäºé”™è¯¯çš„å‡è®¾ã€‚

### ä¸ºä»€ä¹ˆä¸éœ€è¦"æ­»äº¡æŒä¹…åŒ–"

Gemini å»ºè®®å­˜å‚¨ `isDead` çŠ¶æ€ï¼Œä½†è¿™æ˜¯**ä¸å¿…è¦çš„**ï¼š

1. **å­˜æ¡£è¯­ä¹‰**ï¼šå­˜æ¡£ä¿å­˜çš„æ˜¯"å½“å‰ä¸–ç•ŒçŠ¶æ€"
2. **å‡æ­»çŸ³å¤´**ï¼š`ShouldSave` è¿”å› `false`ï¼Œä¸ä¼šè¢«ä¿å­˜
3. **è¯»æ¡£æ¢å¤**ï¼šåå‘ä¿®å‰ªæœºåˆ¶ä¼šå¤„ç†"åœºæ™¯ä¸­æœ‰ä½†å­˜æ¡£ä¸­æ²¡æœ‰"çš„æƒ…å†µ
4. **æœ€ç»ˆæ•ˆæœ**ï¼šçŸ³å¤´è¢«ç¦ç”¨ï¼Œä¸"æ­»äº¡"æ•ˆæœä¸€è‡´

**åå‘ä¿®å‰ªä»£ç **ï¼š
```csharp
// PersistentObjectRegistry.RestoreAllFromSaveData()
foreach (var guid in currentRegistryKeys)
{
    if (!savedGuids.Contains(guid))
    {
        // å­˜æ¡£ä¸­æ²¡æœ‰è¿™ä¸ªå¯¹è±¡ â†’ è¯´æ˜ç©å®¶æŠŠå®ƒåˆ äº†
        mb.gameObject.SetActive(false);  // ç¦ç”¨è€Œéé”€æ¯
    }
}
```

---

## ä¸€ã€é—®é¢˜æ¦‚è¿°

æ ¹æ®ç”¨æˆ·æµ‹è¯•åé¦ˆå’Œä»£ç æ·±åº¦å®¡æŸ¥ï¼Œå½“å‰å­˜æ¡£ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | ä¸¥é‡ç¨‹åº¦ | æ ¹å› ç±»å‹ | å½“å‰çŠ¶æ€ |
|---------|---------|---------|---------|---------|
| P1 | æˆ¿å­ä½ç½®ä¸å¤åŸ | ï¿½ ä¸­ç­‰ | æœªå®ç°æ¥å£ | **ç”¨æˆ·ç¡®è®¤æš‚ä¸å¤„ç†** |
| P2 | çŸ³å¤´è¢«æŒ–å–åä¸å¤åŸ | ğŸ”´ ä¸¥é‡ | æ¶æ„ç¼ºé™· | éœ€æ·±åº¦ä¿®å¤ |
| P3 | æ‰è½ç‰©ä¸èµ„æºèŠ‚ç‚¹ç¼ºä¹å…³è”æœºåˆ¶ | ğŸŸ¡ ä¸­ç­‰ | è®¾è®¡ç¼ºå¤± | éœ€è®¾è®¡æ–¹æ¡ˆ |
| P4 | ç®±å­å¹½çµåº“å­˜ Bug | ğŸ”´ ä¸¥é‡ | æ•°æ®åŒæ­¥é—®é¢˜ | éœ€æ·±åº¦ä¿®å¤ |

---

## äºŒã€é—®é¢˜è¯¦ç»†åˆ†æ

### P1: æˆ¿å­ä½ç½®ä¸å¤åŸï¼ˆç”¨æˆ·ç¡®è®¤æš‚ä¸å¤„ç†ï¼‰

ç”¨æˆ·æ˜ç¡®è¡¨ç¤ºï¼š
> "å¯¹äºæˆ¿å­æˆ‘ä»¬å°±ä¸å¤„ç†äº†ï¼Œæ¸¸æˆå†…ä¸ä¼šç§»åŠ¨ï¼Œè¯·ä½ æš‚æ—¶æ— éœ€ç†ä¼šï¼Œä½†æ˜¯è¯·ä½ ç¡®ä¿ä½ çš„å­˜æ¡£éƒ¨åˆ†æ˜¯å¯æ‹“å±•çš„ä¸”æ˜¯è®¾è®¡ä¼˜è‰¯çš„"

**ç»“è®º**ï¼šæš‚ä¸å¤„ç†ï¼Œä½†å­˜æ¡£æ¶æ„éœ€è¦ä¿æŒå¯æ‰©å±•æ€§ã€‚

---

### P2: çŸ³å¤´è¢«æŒ–å–åä¸å¤åŸï¼ˆæ·±åº¦åˆ†æï¼‰

#### ç°è±¡æè¿°
- ä¿å­˜å­˜æ¡£æ—¶çŸ³å¤´å­˜åœ¨
- æŒ–æ‰çŸ³å¤´ååŠ è½½å­˜æ¡£
- çŸ³å¤´æ²¡æœ‰æ¢å¤ï¼ˆä½†èƒŒåŒ…ä¸­çš„çŸ³å¤´å’ŒçŸ¿çŸ³ç¡®å®æ¶ˆå¤±äº†ï¼‰

#### ğŸ”´ ç”¨æˆ·æå‡ºçš„å…³é”®é—®é¢˜

> "å¦‚æœçŸ³å¤´è¢«æŒ–æ‰äº†ç„¶åè¿™ä¸ªæ—¶å€™å…¶å®åœºæ™¯æ˜¯æ²¡æœ‰è¿™ä¸ªçŸ³å¤´äº†ä¹Ÿæ²¡æœ‰è¿™ä¸ªGUIDäº†ï¼Œè¿™æ ·åˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ"

è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸“ä¸šçš„é—®é¢˜ï¼Œæ­ç¤ºäº†å½“å‰æ¶æ„çš„æ ¸å¿ƒç¼ºé™·ã€‚

#### æ ¹å› åˆ†æï¼ˆä»£ç éªŒè¯ï¼‰

**é—®é¢˜é“¾è·¯**ï¼š

```
1. ç©å®¶æŒ–æ‰çŸ³å¤´
   â†“
2. StoneController.DestroyStone() è¢«è°ƒç”¨
   â†“
3. isDepleted = true
   â†“
4. Destroy(gameObject) æ‰§è¡Œ
   â†“
5. çŸ³å¤´ä»åœºæ™¯ä¸­å®Œå…¨æ¶ˆå¤±
   â†“
6. PersistentObjectRegistry ä¸­çš„å¼•ç”¨å˜ä¸º null
   â†“
7. ç©å®¶åŠ è½½å­˜æ¡£
   â†“
8. RestoreAllFromSaveData() å°è¯•æ¢å¤
   â†“
9. FindByGuid() è¿”å› nullï¼ˆå› ä¸ºçŸ³å¤´å·²è¢«é”€æ¯ï¼‰
   â†“
10. DynamicObjectFactory.TryReconstruct() ä¸æ”¯æŒ "Stone" ç±»å‹
   â†“
11. çŸ³å¤´æ— æ³•æ¢å¤ âŒ
```

**ä»£ç è¯æ®**ï¼š

```csharp
// StoneController.cs - DestroyStone() æ–¹æ³•
private void DestroyStone()
{
    isDepleted = true;
    
    // ä»æ³¨å†Œè¡¨æ³¨é”€
    if (ResourceNodeRegistry.Instance != null)
    {
        ResourceNodeRegistry.Instance.Unregister(gameObject.GetInstanceID());
    }
    
    // ğŸ”´ é—®é¢˜ï¼šç›´æ¥é”€æ¯ï¼Œæ²¡æœ‰"å‡æ­»"æœºåˆ¶
    if (transform.parent != null)
    {
        Destroy(transform.parent.gameObject);
    }
    else
    {
        Destroy(gameObject);
    }
}
```

```csharp
// StoneController.cs - ShouldSave å±æ€§
public bool ShouldSave => gameObject.activeInHierarchy && !isDepleted;
// ğŸ”´ é—®é¢˜ï¼šisDepleted = true æ—¶ä¸ä¿å­˜ï¼Œä½†æ­¤æ—¶å¯¹è±¡å·²è¢«é”€æ¯
```

```csharp
// DynamicObjectFactory.cs - TryReconstruct() æ–¹æ³•
public static IPersistentObject TryReconstruct(WorldObjectSaveData data)
{
    if (data.objectType == "Drop")
        return TryReconstructDrop(data);
    
    if (data.objectType == "Tree")
        return TryReconstructTree(data);
    
    // ğŸ”´ é—®é¢˜ï¼šä¸æ”¯æŒ "Stone" ç±»å‹
    return null;
}
```

#### è§£å†³æ–¹æ¡ˆï¼ˆä¸‰å±‚é˜²æŠ¤ï¼‰

**æ–¹æ¡ˆ Aï¼šå‡æ­»æœºåˆ¶ï¼ˆæ¨èï¼‰**

å°† `Destroy()` æ”¹ä¸º `SetActive(false)`ï¼Œè®©çŸ³å¤´"å‡æ­»"è€Œé"çœŸæ­»"ã€‚

```csharp
// ä¿®æ”¹ StoneController.DestroyStone()
private void DestroyStone()
{
    isDepleted = true;
    
    // ä»èµ„æºèŠ‚ç‚¹æ³¨å†Œè¡¨æ³¨é”€ï¼ˆä¸å½±å“æŒä¹…åŒ–æ³¨å†Œè¡¨ï¼‰
    if (ResourceNodeRegistry.Instance != null)
    {
        ResourceNodeRegistry.Instance.Unregister(gameObject.GetInstanceID());
    }
    
    // ğŸ”¥ å‡æ­»ï¼šç¦ç”¨è€Œéé”€æ¯
    if (transform.parent != null)
    {
        transform.parent.gameObject.SetActive(false);
    }
    else
    {
        gameObject.SetActive(false);
    }
    
    // ğŸ”¥ ä¿æŒåœ¨ PersistentObjectRegistry ä¸­çš„æ³¨å†Œ
    // è¿™æ ·è¯»æ¡£æ—¶å¯ä»¥æ‰¾åˆ°å¹¶æ¢å¤
}
```

**æ–¹æ¡ˆ Bï¼šåŠ¨æ€é‡å»ºæ”¯æŒï¼ˆè¡¥å……ï¼‰**

åœ¨ `DynamicObjectFactory` ä¸­æ·»åŠ çŸ³å¤´é‡å»ºæ”¯æŒï¼Œä½œä¸ºæ–¹æ¡ˆ A çš„è¡¥å……ã€‚

```csharp
// åœ¨ DynamicObjectFactory.cs ä¸­æ·»åŠ 
private static IPersistentObject TryReconstructStone(WorldObjectSaveData data)
{
    // 1. è§£æ StoneSaveData
    // 2. æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
    // 3. æŸ¥æ‰¾é¢„åˆ¶ä½“ï¼ˆéœ€è¦ PrefabRegistry æ”¯æŒï¼‰
    // 4. å®ä¾‹åŒ–å¹¶è®¾ç½® GUID
    // 5. æ³¨å†Œåˆ° Registry
}
```

**æ–¹æ¡ˆ Cï¼šShouldSave é€»è¾‘ä¿®æ­£ï¼ˆå…³é”®ï¼‰**

```csharp
// ä¿®æ”¹ StoneController.ShouldSave
public bool ShouldSave => gameObject.activeInHierarchy;
// ğŸ”¥ ç§»é™¤ !isDepleted æ¡ä»¶
// å› ä¸ºå‡æ­»çš„çŸ³å¤´ä¹Ÿéœ€è¦ä¿å­˜ï¼ˆä¿å­˜å…¶"å·²è¢«æŒ–æ‰"çš„çŠ¶æ€ï¼‰
```

**ä½†è¿™é‡Œæœ‰ä¸€ä¸ªæ›´æ·±å±‚çš„é—®é¢˜**ï¼š

å¦‚æœçŸ³å¤´è¢«æŒ–æ‰å `SetActive(false)`ï¼Œé‚£ä¹ˆå­˜æ¡£ä¸­åº”è¯¥ä¿å­˜ä»€ä¹ˆï¼Ÿ

- **é€‰é¡¹ 1**ï¼šä¿å­˜"çŸ³å¤´å­˜åœ¨ä½†è¢«ç¦ç”¨"çš„çŠ¶æ€ â†’ è¯»æ¡£æ—¶æ¢å¤ä¸ºç¦ç”¨çŠ¶æ€
- **é€‰é¡¹ 2**ï¼šä¸ä¿å­˜å·²è¢«æŒ–æ‰çš„çŸ³å¤´ â†’ è¯»æ¡£æ—¶çŸ³å¤´æ¢å¤ï¼ˆå› ä¸ºå­˜æ¡£ä¸­æ²¡æœ‰"å·²æŒ–æ‰"çš„è®°å½•ï¼‰

**æ­£ç¡®ç­”æ¡ˆæ˜¯é€‰é¡¹ 2**ï¼š

å­˜æ¡£çš„è¯­ä¹‰æ˜¯"ä¿å­˜å½“å‰ä¸–ç•ŒçŠ¶æ€"ã€‚å¦‚æœçŸ³å¤´è¢«æŒ–æ‰äº†ï¼Œå­˜æ¡£ä¸­å°±ä¸åº”è¯¥æœ‰è¿™ä¸ªçŸ³å¤´çš„è®°å½•ã€‚è¯»æ¡£æ—¶ï¼Œç³»ç»Ÿä¼šå‘ç°"å­˜æ¡£ä¸­æ²¡æœ‰è¿™ä¸ªçŸ³å¤´"ï¼Œç„¶åé€šè¿‡åå‘ä¿®å‰ªæœºåˆ¶å°†åœºæ™¯ä¸­çš„çŸ³å¤´ç¦ç”¨ã€‚

**å®Œæ•´çš„ä¿®å¤æ–¹æ¡ˆ**ï¼š

1. **å‡æ­»æœºåˆ¶**ï¼š`DestroyStone()` æ”¹ä¸º `SetActive(false)`
2. **ShouldSave ä¿æŒä¸å˜**ï¼š`isDepleted = true` æ—¶ä¸ä¿å­˜ï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼ï¼‰
3. **åå‘ä¿®å‰ª**ï¼š`RestoreAllFromSaveData()` ä¸­çš„åå‘ä¿®å‰ªé€»è¾‘ä¼šå¤„ç†"åœºæ™¯ä¸­æœ‰ä½†å­˜æ¡£ä¸­æ²¡æœ‰"çš„æƒ…å†µ

**éªŒè¯åå‘ä¿®å‰ªé€»è¾‘**ï¼š

```csharp
// PersistentObjectRegistry.cs - RestoreAllFromSaveData()
// ğŸ”¥ Step 3: ä¿®å‰ª (Pruning) - åœºæ™¯ä¸­æœ‰ä½†å­˜æ¡£ä¸­æ²¡æœ‰ = å·²åˆ é™¤
foreach (var guid in currentRegistryKeys)
{
    if (!savedGuids.Contains(guid))
    {
        // å­˜æ¡£ä¸­æ²¡æœ‰è¿™ä¸ªå¯¹è±¡ â†’ è¯´æ˜ç©å®¶æŠŠå®ƒåˆ äº†
        if (_registry.TryGetValue(guid, out var obj) && obj != null)
        {
            if (obj is MonoBehaviour mb && mb != null)
            {
                mb.gameObject.SetActive(false);  // ğŸ”¥ ç¦ç”¨è€Œéé”€æ¯
                pruned++;
            }
        }
    }
}
```

**é—®é¢˜**ï¼šå½“å‰çš„åå‘ä¿®å‰ªé€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œä½†å‰ææ˜¯çŸ³å¤´åœ¨è¢«æŒ–æ‰åä»ç„¶åœ¨ `_registry` ä¸­ã€‚

**å…³é”®ä¿®å¤ç‚¹**ï¼š

```csharp
// StoneController.DestroyStone() ä¸­
// ğŸ”´ å½“å‰ä»£ç ï¼šä» PersistentObjectRegistry æ³¨é”€
// è¿™ä¼šå¯¼è‡´åå‘ä¿®å‰ªæ— æ³•æ‰¾åˆ°è¿™ä¸ªçŸ³å¤´

// ğŸ”¥ ä¿®å¤ï¼šä¸è¦ä» PersistentObjectRegistry æ³¨é”€
// åªä» ResourceNodeRegistry æ³¨é”€ï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºå‡æ­»çš„çŸ³å¤´ä¸åº”è¯¥è¢«æ”»å‡»ï¼‰
```

---

### P3: æ‰è½ç‰©ä¸èµ„æºèŠ‚ç‚¹ç¼ºä¹å…³è”æœºåˆ¶

#### ç°è±¡æè¿°ï¼ˆç”¨æˆ·åŸè¯ï¼‰

> "å¯¹äºè¿™äº›å¯èƒ½ç”Ÿæˆæ‰è½ç‰©çš„ç‰©ä½“å’Œä»–çš„æ‰è½ç‰©æˆ‘è®¤ä¸ºä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªéšè—æ•°æ®è¿›è¡Œé“¾æ¥"

#### é—®é¢˜åœºæ™¯

```
åœºæ™¯ Aï¼šç‰©å“å¤åˆ¶ Bug
1. ä¿å­˜å­˜æ¡£ï¼ˆçŸ³å¤´å­˜åœ¨ï¼‰
2. æŒ–æ‰çŸ³å¤´ï¼Œç”Ÿæˆæ‰è½ç‰©
3. ä¸æ‹¾å–æ‰è½ç‰©
4. åŠ è½½å­˜æ¡£
5. çŸ³å¤´æ¢å¤ + æ‰è½ç‰©ä¹Ÿæ¢å¤ = ç‰©å“å¤åˆ¶ï¼

åœºæ™¯ Bï¼šç‰©å“ä¸¢å¤± Bug
1. æŒ–æ‰çŸ³å¤´ï¼Œç”Ÿæˆæ‰è½ç‰©
2. ä¿å­˜å­˜æ¡£ï¼ˆçŸ³å¤´å·²æ¶ˆå¤±ï¼Œæ‰è½ç‰©å­˜åœ¨ï¼‰
3. åŠ è½½å­˜æ¡£
4. å¦‚æœæ‰è½ç‰©æ²¡æœ‰æ­£ç¡®ä¿å­˜ = ç‰©å“ä¸¢å¤±ï¼
```

#### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šæ‰è½ç‰©æ ‡è®°æ¥æºï¼ˆæ¨èï¼‰**

```csharp
// åœ¨ WorldItemPickup ä¸­æ·»åŠ 
[SerializeField] private string sourceNodeGuid;  // æ¥æºèµ„æºèŠ‚ç‚¹çš„ GUID

// åœ¨èµ„æºèŠ‚ç‚¹ç”Ÿæˆæ‰è½ç‰©æ—¶
public void SpawnDrops()
{
    var pickup = WorldSpawnService.Instance.Spawn(...);
    pickup.SetSourceNodeGuid(this.PersistentId);
}

// åœ¨ RestoreAllFromSaveData() ä¸­
// å¦‚æœ sourceNodeGuid å¯¹åº”çš„èµ„æºèŠ‚ç‚¹å­˜åœ¨ä¸”æ´»è·ƒï¼Œåˆ™ä¸æ¢å¤æ‰è½ç‰©
```

**æ–¹æ¡ˆ Bï¼šèµ„æºèŠ‚ç‚¹è®°å½•å·²æ‰è½çŠ¶æ€**

```csharp
// åœ¨ StoneSaveData ä¸­æ·»åŠ 
public bool hasDroppedItems;  // æ˜¯å¦å·²ç”Ÿæˆæ‰è½ç‰©

// æ¢å¤æ—¶ï¼š
// å¦‚æœ hasDroppedItems = trueï¼Œè¯´æ˜èµ„æºèŠ‚ç‚¹å·²è¢«ç ´åå¹¶ç”Ÿæˆäº†æ‰è½ç‰©
// æ­¤æ—¶åº”è¯¥æ¢å¤æ‰è½ç‰©ï¼Œè€Œä¸æ˜¯æ¢å¤èµ„æºèŠ‚ç‚¹
```

**æˆ‘çš„ç‹¬ç«‹æ€è€ƒ**ï¼š

æ–¹æ¡ˆ A æ›´ä¼˜é›…ï¼Œå› ä¸ºå®ƒå°†å…³è”ä¿¡æ¯å­˜å‚¨åœ¨æ‰è½ç‰©ä¾§ï¼Œä¸éœ€è¦ä¿®æ”¹èµ„æºèŠ‚ç‚¹çš„æ•°æ®ç»“æ„ã€‚ä½†æ–¹æ¡ˆ A éœ€è¦åœ¨æ¢å¤æ—¶è¿›è¡Œé¢å¤–çš„æ£€æŸ¥ï¼Œå¯èƒ½å½±å“æ€§èƒ½ã€‚

æ–¹æ¡ˆ B æ›´ç®€å•ç›´æ¥ï¼Œä½†éœ€è¦ä¿®æ”¹æ‰€æœ‰èµ„æºèŠ‚ç‚¹çš„æ•°æ®ç»“æ„ã€‚

**æ¨è**ï¼šå…ˆå®ç°æ–¹æ¡ˆ Aï¼Œå› ä¸ºå®ƒå¯¹ç°æœ‰ä»£ç çš„ä¾µå…¥æ€§æ›´å°ã€‚

---

### P4: ç®±å­å¹½çµåº“å­˜ Bugï¼ˆæ·±åº¦åˆ†æï¼‰

#### ç°è±¡æè¿°ï¼ˆç”¨æˆ·åŸè¯ï¼‰

> "ç®±å­çœ‹ç€æ˜¯ç©ºçš„ï¼Œä½†æ— æ³•æŒ–å–ï¼ˆç³»ç»Ÿè®¤ä¸ºå®ƒä¸ç©ºï¼‰"
> "ä¿å­˜çš„æ—¶å€™ç®±å­é‡Œé¢æœ‰ä¸œè¥¿ï¼Œç„¶åå†è¯»å–å­˜æ¡£åå°±ç®—æ‹¿å¹²å‡€äº†ç®±å­é‡Œé¢çš„ä¸œè¥¿äº†ä½†è¿˜æ˜¯æ²¡æœ‰åŠæ³•æŒ–å–æ‰"
> "æ— è®ºæ€ä¹ˆæ ·ç”¨é•å­éƒ½æ˜¯è§¦å‘ç§»åŠ¨ç®±å­è€Œä¸æ˜¯æŒ–å–ç®±å­"

#### æ ¹å› åˆ†æï¼ˆä»£ç éªŒè¯ï¼‰

**é—®é¢˜é“¾è·¯**ï¼š

```
1. ä¿å­˜å­˜æ¡£ï¼ˆç®±å­æœ‰ç‰©å“ï¼‰
   â†“
2. Save() è°ƒç”¨ SyncInventoryToV2()ï¼Œå°† _inventory åŒæ­¥åˆ° _inventoryV2
   â†“
3. å­˜æ¡£ä¿å­˜ _inventoryV2 çš„æ•°æ®
   â†“
4. åŠ è½½å­˜æ¡£
   â†“
5. Load() è°ƒç”¨ SyncV2ToInventory()ï¼Œå°† _inventoryV2 åŒæ­¥åˆ° _inventory
   â†“
6. ç©å®¶æ‰“å¼€ç®±å­ UIï¼Œæ¸…ç©ºæ‰€æœ‰ç‰©å“
   â†“
7. UI æ“ä½œä¿®æ”¹çš„æ˜¯ _inventoryï¼ˆé€šè¿‡ ChestInventoryï¼‰
   â†“
8. ğŸ”´ é—®é¢˜ï¼š_inventoryV2 æ²¡æœ‰è¢«åŒæ­¥æ›´æ–°ï¼
   â†“
9. ç©å®¶ç”¨é•å­æ•²ç®±å­
   â†“
10. OnHit() æ£€æŸ¥ IsEmpty
   â†“
11. IsEmpty = (_inventoryV2.IsEmpty) && (_inventory.IsEmpty)
   â†“
12. _inventory.IsEmpty = trueï¼ˆç©å®¶å·²æ¸…ç©ºï¼‰
13. _inventoryV2.IsEmpty = falseï¼ˆæ²¡æœ‰åŒæ­¥ï¼ï¼‰
   â†“
14. IsEmpty = false
   â†“
15. è§¦å‘æ¨åŠ¨è€ŒéæŒ–å– âŒ
```

**ä»£ç è¯æ®**ï¼š

```csharp
// ChestController.cs - IsEmpty å±æ€§
public bool IsEmpty => (_inventoryV2 == null || _inventoryV2.IsEmpty) && (_inventory == null || _inventory.IsEmpty);
// ğŸ”´ é—®é¢˜ï¼šéœ€è¦ä¸¤ä¸ªåº“å­˜éƒ½ä¸ºç©ºæ‰è¿”å› true
```

```csharp
// ChestController.cs - OnHit() æ–¹æ³•
public void OnHit(ToolHitContext ctx)
{
    // ...
    
    // æœ‰ç‰©å“ï¼šæ¨åŠ¨
    if (!IsEmpty)  // ğŸ”´ è¿™é‡Œæ£€æŸ¥ IsEmpty
    {
        TryPush(ctx.hitDir);
        return;
    }
    
    // ç©ºç®±å­ï¼šé€ æˆä¼¤å®³
    // ...
}
```

**é—®é¢˜çš„æœ¬è´¨**ï¼š

ç®±å­æœ‰ä¸¤ä¸ªåº“å­˜ç³»ç»Ÿï¼š
- `_inventory`ï¼ˆChestInventoryï¼‰ï¼šUI æ“ä½œçš„ç›®æ ‡
- `_inventoryV2`ï¼ˆChestInventoryV2ï¼‰ï¼šå­˜æ¡£ä¿å­˜çš„ç›®æ ‡

å½“ç©å®¶é€šè¿‡ UI æ¸…ç©ºç®±å­æ—¶ï¼Œåªæœ‰ `_inventory` è¢«ä¿®æ”¹ï¼Œ`_inventoryV2` æ²¡æœ‰åŒæ­¥ã€‚

#### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šå®æ—¶åŒæ­¥ï¼ˆæ¨èï¼‰**

åœ¨ `_inventory` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç«‹å³åŒæ­¥åˆ° `_inventoryV2`ã€‚

```csharp
// åœ¨ ChestInventory ä¸­æ·»åŠ äº‹ä»¶
public event System.Action OnInventoryChanged;

// åœ¨ ChestController ä¸­è®¢é˜…
private void Initialize()
{
    _inventory = new ChestInventory(capacity);
    _inventory.OnInventoryChanged += OnInventoryChangedHandler;
    // ...
}

private void OnInventoryChangedHandler()
{
    SyncInventoryToV2();
}
```

**æ–¹æ¡ˆ Bï¼šç®€åŒ– IsEmpty æ£€æŸ¥**

åªæ£€æŸ¥ `_inventory`ï¼Œå› ä¸ºå®ƒæ˜¯ UI æ“ä½œçš„çœŸå®æ¥æºã€‚

```csharp
// ä¿®æ”¹ IsEmpty å±æ€§
public bool IsEmpty => _inventory == null || _inventory.IsEmpty;
// ğŸ”¥ åªæ£€æŸ¥ _inventoryï¼Œå› ä¸ºå®ƒæ˜¯ UI æ“ä½œçš„ç›®æ ‡
```

**æ–¹æ¡ˆ Cï¼šç»Ÿä¸€åº“å­˜ç³»ç»Ÿï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰**

ç§»é™¤ `_inventoryV2`ï¼Œè®© `_inventory` ç›´æ¥æ”¯æŒå­˜æ¡£ã€‚

**æˆ‘çš„ç‹¬ç«‹æ€è€ƒ**ï¼š

æ–¹æ¡ˆ B æ˜¯æœ€ç®€å•çš„ä¿®å¤ï¼Œä½†å¯èƒ½å¼•å…¥å…¶ä»–é—®é¢˜ï¼ˆå¦‚æœ `_inventoryV2` åœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯æ­£ç¡®çš„æ¥æºï¼‰ã€‚

æ–¹æ¡ˆ A æ˜¯æ›´ç¨³å¥çš„ä¿®å¤ï¼Œç¡®ä¿ä¸¤ä¸ªåº“å­˜ç³»ç»Ÿå§‹ç»ˆåŒæ­¥ã€‚

æ–¹æ¡ˆ C æ˜¯æœ€å½»åº•çš„ä¿®å¤ï¼Œä½†éœ€è¦è¾ƒå¤§çš„é‡æ„å·¥ä½œã€‚

**æ¨è**ï¼šå…ˆå®æ–½æ–¹æ¡ˆ B ä½œä¸ºç´§æ€¥ä¿®å¤ï¼Œç„¶åå®æ–½æ–¹æ¡ˆ A ä½œä¸ºé•¿æœŸæ–¹æ¡ˆã€‚

---

## ä¸‰ã€è¾…åŠ©æ–‡æ¡£åˆ†æï¼ˆç‹¬ç«‹æ€è€ƒï¼‰

å¦ä¸€ä¸ªæ™ºèƒ½ä½“çš„åˆ†ææ–‡æ¡£æå‡ºäº†ä»¥ä¸‹è§‚ç‚¹ï¼š

### è®¤åŒçš„éƒ¨åˆ†

1. **ç®±å­åŒæ•°æ®æºä¸åŒæ­¥** - è¿™æ˜¯æ­£ç¡®çš„è¯Šæ–­
2. **é™æ€ç‰©ä½“"å‡æ­»æœºåˆ¶"** - è¿™æ˜¯æ­£ç¡®çš„æ–¹å‘
3. **PrefabRegistry é‡æ„** - è¿™æ˜¯æœ‰ä»·å€¼çš„æ”¹è¿›

### æœ‰ç–‘è™‘çš„éƒ¨åˆ†

1. **"ä¿®æ”¹ StoneControllerï¼šå°† Destroy(gameObject) æ”¹ä¸º gameObject.SetActive(false)"**
   - è¿™æ˜¯æ­£ç¡®çš„ï¼Œä½†éœ€è¦åŒæ—¶ä¿®æ”¹ `DestroyStone()` ä¸­çš„æ³¨é”€é€»è¾‘
   - ä¸èƒ½ä» `PersistentObjectRegistry` æ³¨é”€ï¼Œå¦åˆ™åå‘ä¿®å‰ªæ— æ³•å·¥ä½œ

2. **"ä¿®æ”¹ PersistentObjectRegistryï¼šåœ¨ RestoreAll æ—¶ï¼Œå¦‚æœå­˜æ¡£æ•°æ®æ˜¾ç¤ºè¯¥å¯¹è±¡å­˜åœ¨ï¼ˆä¸”ä¸æ˜¯æ ‘æ¡©ï¼‰ï¼Œå¼ºåˆ¶æ‰§è¡Œ obj.gameObject.SetActive(true)"**
   - è¿™ä¸ªé€»è¾‘æ˜¯é”™è¯¯çš„ï¼
   - æ­£ç¡®çš„é€»è¾‘æ˜¯ï¼šå¦‚æœå­˜æ¡£ä¸­æœ‰è¿™ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨ `Load()` æ¢å¤çŠ¶æ€
   - `SetActive(true)` åº”è¯¥åœ¨ `Load()` å†…éƒ¨å¤„ç†ï¼Œè€Œä¸æ˜¯åœ¨ `RestoreAll` ä¸­

3. **"GenericPersistentObject.cs"**
   - è¿™æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œä½†ç”¨æˆ·å·²ç¡®è®¤æˆ¿å­æš‚ä¸å¤„ç†
   - å¯ä»¥ä½œä¸ºæœªæ¥çš„æ‰©å±•æ–¹æ¡ˆ

### æˆ‘çš„ç‹¬ç«‹è§è§£

1. **çŸ³å¤´é—®é¢˜çš„æ ¸å¿ƒä¸æ˜¯"åŠ¨æ€é‡å»º"ï¼Œè€Œæ˜¯"å‡æ­»æœºåˆ¶"**
   - åŠ¨æ€é‡å»ºæ˜¯è¡¥å……æ–¹æ¡ˆï¼Œä¸æ˜¯ä¸»è¦æ–¹æ¡ˆ
   - å‡æ­»æœºåˆ¶æ‰æ˜¯æ­£ç¡®çš„æ¶æ„æ–¹å‘

2. **ç®±å­é—®é¢˜çš„æ ¸å¿ƒæ˜¯"æ•°æ®åŒæ­¥"ï¼Œä¸æ˜¯"çŠ¶æ€æ£€æŸ¥"**
   - ä¿®æ”¹ `IsEmpty` åªæ˜¯æ²»æ ‡
   - å®ç°å®æ—¶åŒæ­¥æ‰æ˜¯æ²»æœ¬

3. **å­˜æ¡£ç³»ç»Ÿçš„æ ¸å¿ƒåŸåˆ™**ï¼š
   - å­˜æ¡£ä¿å­˜çš„æ˜¯"å½“å‰ä¸–ç•ŒçŠ¶æ€"
   - è¯»æ¡£æ¢å¤çš„æ˜¯"å­˜æ¡£æ—¶çš„ä¸–ç•ŒçŠ¶æ€"
   - åå‘ä¿®å‰ªå¤„ç†çš„æ˜¯"åœºæ™¯ä¸­æœ‰ä½†å­˜æ¡£ä¸­æ²¡æœ‰"çš„æƒ…å†µ
   - åŠ¨æ€é‡å»ºå¤„ç†çš„æ˜¯"å­˜æ¡£ä¸­æœ‰ä½†åœºæ™¯ä¸­æ²¡æœ‰"çš„æƒ…å†µ

---

## å››ã€ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç´§æ€¥ä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼‰

1. **ç®±å­ IsEmpty ä¿®å¤** - ä¿®æ”¹ `IsEmpty` å±æ€§åªæ£€æŸ¥ `_inventory`
2. **çŸ³å¤´å‡æ­»æœºåˆ¶** - ä¿®æ”¹ `DestroyStone()` ä½¿ç”¨ `SetActive(false)`
3. **çŸ³å¤´æ³¨é”€é€»è¾‘ä¿®å¤** - ä¸ä» `PersistentObjectRegistry` æ³¨é”€

### P1 - é‡è¦ä¿®å¤ï¼ˆæœ¬å‘¨å®Œæˆï¼‰

4. **ç®±å­å®æ—¶åŒæ­¥** - å®ç° `_inventory` å˜åŒ–æ—¶è‡ªåŠ¨åŒæ­¥åˆ° `_inventoryV2`
5. **çŸ³å¤´åŠ¨æ€é‡å»ºæ”¯æŒ** - åœ¨ `DynamicObjectFactory` ä¸­æ·»åŠ çŸ³å¤´é‡å»º

### P2 - æ¶æ„æ”¹è¿›ï¼ˆåç»­è¿­ä»£ï¼‰

6. **æ‰è½ç‰©å…³è”æœºåˆ¶** - å®ç° `sourceNodeGuid` æ–¹æ¡ˆ
7. **ç»Ÿä¸€åº“å­˜ç³»ç»Ÿ** - ç§»é™¤ `_inventoryV2`ï¼Œç®€åŒ–ç®±å­æ¶æ„

---

## äº”ã€æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 5.1 çŸ³å¤´å‡æ­»æœºåˆ¶ï¼ˆP0ï¼‰

```csharp
// StoneController.cs - ä¿®æ”¹ DestroyStone()
private void DestroyStone()
{
    isDepleted = true;
    
    // ğŸ”¥ åªä» ResourceNodeRegistry æ³¨é”€ï¼ˆä¸å½±å“æŒä¹…åŒ–ï¼‰
    if (ResourceNodeRegistry.Instance != null)
    {
        ResourceNodeRegistry.Instance.Unregister(gameObject.GetInstanceID());
    }
    
    // ğŸ”¥ ä¸ä» PersistentObjectRegistry æ³¨é”€ï¼
    // è¿™æ ·åå‘ä¿®å‰ªæ‰èƒ½æ­£ç¡®å·¥ä½œ
    
    // ğŸ”¥ å‡æ­»ï¼šç¦ç”¨è€Œéé”€æ¯
    if (transform.parent != null)
    {
        transform.parent.gameObject.SetActive(false);
    }
    else
    {
        gameObject.SetActive(false);
    }
    
    if (showDebugInfo)
        Debug.Log($"<color=orange>[StoneController] {gameObject.name} è¢«å®Œå…¨æŒ–æ˜ï¼ˆå‡æ­»ï¼‰</color>");
}
```

### 5.2 ç®±å­ IsEmpty ä¿®å¤ï¼ˆP0ï¼‰

```csharp
// ChestController.cs - ä¿®æ”¹ IsEmpty å±æ€§
/// <summary>
/// æ˜¯å¦ä¸ºç©º
/// ğŸ”¥ P4 ä¿®å¤ï¼šåªæ£€æŸ¥ _inventoryï¼Œå› ä¸ºå®ƒæ˜¯ UI æ“ä½œçš„ç›®æ ‡
/// _inventoryV2 åªç”¨äºå­˜æ¡£ï¼Œä¸å‚ä¸è¿è¡Œæ—¶é€»è¾‘åˆ¤æ–­
/// </summary>
public bool IsEmpty => _inventory == null || _inventory.IsEmpty;
```

### 5.3 ç®±å­å®æ—¶åŒæ­¥ï¼ˆP1ï¼‰

```csharp
// ChestInventory.cs - æ·»åŠ å˜åŒ–äº‹ä»¶
public event System.Action OnInventoryChanged;

// åœ¨æ‰€æœ‰ä¿®æ”¹æ–¹æ³•ä¸­è§¦å‘äº‹ä»¶
public void SetSlot(int index, ItemStack stack)
{
    // ... åŸæœ‰é€»è¾‘ ...
    OnInventoryChanged?.Invoke();
}

public void ClearSlot(int index)
{
    // ... åŸæœ‰é€»è¾‘ ...
    OnInventoryChanged?.Invoke();
}

// ChestController.cs - è®¢é˜…äº‹ä»¶
private void Initialize()
{
    _inventory = new ChestInventory(capacity);
    _inventory.OnInventoryChanged += () => SyncInventoryToV2();
    // ...
}
```

### 5.4 çŸ³å¤´åŠ¨æ€é‡å»ºï¼ˆP1ï¼‰

```csharp
// DynamicObjectFactory.cs - æ·»åŠ çŸ³å¤´é‡å»ºæ”¯æŒ
public static IPersistentObject TryReconstruct(WorldObjectSaveData data)
{
    if (data.objectType == "Drop")
        return TryReconstructDrop(data);
    
    if (data.objectType == "Tree")
        return TryReconstructTree(data);
    
    // ğŸ”¥ æ–°å¢ï¼šçŸ³å¤´é‡å»º
    if (data.objectType == "Stone")
        return TryReconstructStone(data);
    
    return null;
}

private static IPersistentObject TryReconstructStone(WorldObjectSaveData data)
{
    // 1. è§£æ StoneSaveData
    if (string.IsNullOrEmpty(data.genericData))
        return null;
    
    StoneSaveData stoneData;
    try
    {
        stoneData = JsonUtility.FromJson<StoneSaveData>(data.genericData);
    }
    catch
    {
        return null;
    }
    
    // 2. æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
    if (stoneData == null || stoneData.currentHealth <= 0)
        return null;
    
    // 3. æŸ¥æ‰¾é¢„åˆ¶ä½“ï¼ˆéœ€è¦ PrefabRegistry æ”¯æŒï¼‰
    string prefabId = data.prefabId;
    if (string.IsNullOrEmpty(prefabId))
        prefabId = "Stone_M1";  // é»˜è®¤é¢„åˆ¶ä½“
    
    var prefab = _registry?.GetPrefab(prefabId);
    if (prefab == null)
        return null;
    
    // 4. å®ä¾‹åŒ–
    var instance = Object.Instantiate(prefab, data.GetPosition(), Quaternion.identity);
    instance.SetActive(false);
    
    // 5. è·å–ç»„ä»¶å¹¶è®¾ç½® GUID
    var stoneController = instance.GetComponentInChildren<StoneController>();
    if (stoneController == null)
    {
        Object.Destroy(instance);
        return null;
    }
    
    // 6. è®¾ç½® GUIDï¼ˆéœ€è¦æ·»åŠ  SetPersistentIdForLoad æ–¹æ³•ï¼‰
    // stoneController.SetPersistentIdForLoad(data.guid);
    
    // 7. æ³¨å†Œåˆ° Registry
    if (PersistentObjectRegistry.Instance != null)
        PersistentObjectRegistry.Instance.Register(stoneController);
    
    return stoneController;
}
```

---

## å…­ã€éªŒè¯æ¸…å•

### çŸ³å¤´ä¿®å¤éªŒè¯

- [ ] ä¿å­˜å­˜æ¡£ï¼ˆçŸ³å¤´å­˜åœ¨ï¼‰
- [ ] æŒ–æ‰çŸ³å¤´
- [ ] åŠ è½½å­˜æ¡£
- [ ] çŸ³å¤´æ¢å¤ âœ“

### ç®±å­ä¿®å¤éªŒè¯

- [ ] ä¿å­˜å­˜æ¡£ï¼ˆç®±å­æœ‰ç‰©å“ï¼‰
- [ ] åŠ è½½å­˜æ¡£
- [ ] æ‰“å¼€ç®±å­ï¼Œæ¸…ç©ºæ‰€æœ‰ç‰©å“
- [ ] å…³é—­ç®±å­
- [ ] ç”¨é•å­æ•²ç®±å­
- [ ] ç®±å­è¢«æŒ–å–ï¼ˆè€Œéæ¨åŠ¨ï¼‰âœ“

---

## ä¸ƒã€æ€»ç»“

å½“å‰å­˜æ¡£ç³»ç»Ÿçš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š

1. **çŸ³å¤´**ï¼šä½¿ç”¨ `Destroy()` è€Œé `SetActive(false)`ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡åå‘ä¿®å‰ªæ¢å¤
2. **ç®±å­**ï¼šåŒåº“å­˜ç³»ç»Ÿä¸åŒæ­¥ï¼Œå¯¼è‡´ `IsEmpty` è¿”å›é”™è¯¯å€¼

ä¿®å¤æ–¹æ¡ˆçš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼š

1. **å‡æ­»æœºåˆ¶**ï¼šæ‰€æœ‰å¯æ¢å¤çš„å¯¹è±¡éƒ½åº”è¯¥ä½¿ç”¨ `SetActive(false)` è€Œé `Destroy()`
2. **æ•°æ®åŒæ­¥**ï¼šç¡®ä¿è¿è¡Œæ—¶æ•°æ®å’Œå­˜æ¡£æ•°æ®å§‹ç»ˆä¸€è‡´
3. **åå‘ä¿®å‰ª**ï¼šåˆ©ç”¨ç°æœ‰çš„åå‘ä¿®å‰ªæœºåˆ¶å¤„ç†"åœºæ™¯ä¸­æœ‰ä½†å­˜æ¡£ä¸­æ²¡æœ‰"çš„æƒ…å†µ

---

**æ–‡æ¡£ç»“æŸ**
