# 存档系统 Bug 修复 - 验收指南

**创建日期**: 2026-02-03  
**版本**: 1.1（新增 StoneDebris 清理和箱子动态重建）

---

## 功能验收清单

### 1. 石头存档恢复

- [ ] 保存存档（场景中有石头）
- [ ] 挖掉一个石头（完全消失）
- [ ] 加载存档
- [ ] 验证石头恢复到原位置
- [ ] 验证石头可以被攻击（注册到 ResourceNodeRegistry）

### 2. StoneDebris 清理（新增）

- [ ] 挖石头，在碎片动画播放时保存存档
- [ ] 加载存档
- [ ] 验证 StoneDebris 碎片被清理（不会无限累积）

### 3. 箱子空状态判断

- [ ] 保存存档（箱子内有物品）
- [ ] 加载存档
- [ ] 打开箱子，清空所有物品
- [ ] 关闭箱子
- [ ] 用镐子敲箱子
- [ ] 验证触发挖取（而非推动）

### 4. 箱子动态重建（新增）

- [ ] 放置一个箱子
- [ ] 按 F5 保存存档
- [ ] 用镐子挖取箱子（箱子消失）
- [ ] 按 F9 加载存档
- [ ] 验证箱子恢复到原位置

**注意**：需要在 PrefabRegistry 中配置箱子预制体映射

### 5. 掉落物反向修剪

- [ ] 保存存档（地上没有掉落物）
- [ ] 挖石头产生掉落物
- [ ] 加载存档
- [ ] 验证掉落物被销毁（地上干净）

### 6. 箱子实时同步

- [ ] 打开箱子
- [ ] 放入物品
- [ ] 保存存档
- [ ] 重新加载存档
- [ ] 验证箱子内物品正确恢复

### 7. 掉落物关联机制

- [ ] 保存存档（石头存在）
- [ ] 挖石头产生掉落物
- [ ] 保存存档（掉落物存在）
- [ ] 加载第一个存档（石头恢复）
- [ ] 验证掉落物不会重复出现（因为来源石头已恢复）

---

## 测试步骤详解

### 测试 1：石头假死机制

1. 进入游戏，找到一个石头
2. 按 F5 保存存档
3. 用镐子挖掉石头（直到完全消失）
4. 按 F9 加载存档
5. 检查石头是否恢复

**预期结果**：石头恢复到原位置，可以被攻击

### 测试 2：StoneDebris 清理

1. 挖石头，在碎片动画播放时（0.5秒内）按 F5 保存
2. 按 F9 加载存档

**预期结果**：StoneDebris 碎片被清理，不会无限累积

### 测试 3：箱子 IsEmpty 修复

1. 放置一个箱子
2. 往箱子里放入物品
3. 按 F5 保存存档
4. 按 F9 加载存档
5. 打开箱子，取出所有物品
6. 关闭箱子
7. 用镐子敲箱子

**预期结果**：箱子被挖取（而非推动）

### 测试 4：箱子动态重建

1. 放置一个箱子
2. 按 F5 保存存档
3. 用镐子挖取箱子
4. 按 F9 加载存档

**预期结果**：箱子恢复到原位置

### 测试 5：掉落物销毁

1. 按 F5 保存存档（确保地上没有掉落物）
2. 挖石头产生掉落物
3. 按 F9 加载存档

**预期结果**：掉落物消失，地面干净

---

## 配置要求

### PrefabRegistry 配置

箱子动态重建需要在 PrefabRegistry 中配置箱子预制体映射：

1. 打开 `Assets/111_Data/Database/PrefabRegistry.asset`
2. 添加箱子预制体条目：
   - prefabId: `Chest` 或 StorageData 的资产名称
   - prefab: 对应的箱子预制体

---

## 已知限制

1. **房子不处理**：用户确认游戏内不会移动房子，暂不处理房子的存档恢复
2. **StoneDebris**：临时碎片效果会在加载存档时被清理

---

## 修改的文件

| 文件 | 修改内容 |
|------|---------|
| `StoneController.cs` | 假死机制、Load() 激活、SetPersistentIdForLoad()、掉落物来源设置 |
| `ChestController.cs` | IsEmpty 修复、事件订阅、SetPersistentIdForLoad()、Save() 保存 prefabId |
| `WorldItemPickup.cs` | 注册/注销、sourceNodeGuid |
| `PersistentObjectRegistry.cs` | 反向修剪逻辑、StoneDebris 清理 |
| `DynamicObjectFactory.cs` | 石头重建、箱子重建、掉落物关联检查 |
| `SaveDataDTOs.cs` | DropDataDTO.sourceNodeGuid |

---

**文档结束**
