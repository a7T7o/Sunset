# 自动化存档系统 - 需求文档

**创建日期**: 2026-02-03  
**版本**: 1.0

---

## 背景

当前存档系统存在以下问题：
1. PrefabRegistry 需要手动配置每个预制体映射
2. prefabId 命名不统一（TreeController 用 `M1`，ChestController 用 `storageData.name`）
3. 新增可存档对象时需要大量重复工作
4. 找不到预制体时直接失败，没有智能回退

本次迭代目标是引入自动化机制，解决这些问题。

---

## 用户故事

### US-1：自动扫描预制体

**作为** 开发者  
**我希望** 预制体能够自动注册到数据库  
**以便** 不需要手动配置每个预制体映射

**验收标准**：
- AC-1.1：PrefabDatabase 支持配置多个预制体文件夹路径
- AC-1.2：点击"扫描预制体"按钮后，自动扫描所有配置的文件夹
- AC-1.3：扫描结果自动去重（同名预制体只保留第一个）
- AC-1.4：扫描完成后显示统计信息（已注册 N 个预制体）

### US-2：预制体名称即 ID

**作为** 开发者  
**我希望** 直接使用预制体名称作为 ID  
**以便** 不需要维护额外的 prefabId 字段

**验收标准**：
- AC-2.1：`PrefabDatabase.GetPrefab(name)` 根据预制体名称查找
- AC-2.2：支持模糊匹配（去掉 `(Clone)`、`(1)` 等后缀）
- AC-2.3：各对象的 `Save()` 方法使用预制体名称作为 prefabId

### US-3：智能回退机制

**作为** 玩家  
**我希望** 即使预制体配置有问题，存档也能尽量恢复  
**以便** 不会因为小问题丢失游戏进度

**验收标准**：
- AC-3.1：精确匹配失败时，尝试模糊匹配
- AC-3.2：模糊匹配失败时，尝试类型推断（如箱子使用默认 Box_1）
- AC-3.3：所有回退操作都输出警告日志，便于调试

### US-4：箱子存档恢复

**作为** 玩家  
**我希望** 箱子能正确保存和恢复  
**以便** 不会丢失箱子中的物品

**验收标准**：
- AC-4.1：保存存档时，箱子的 prefabId 使用世界预制体名称
- AC-4.2：加载存档时，能根据 prefabId 找到正确的预制体
- AC-4.3：箱子的位置、库存、锁定状态都能正确恢复

### US-5：编辑器自动化

**作为** 开发者  
**我希望** 预制体变化时自动更新数据库  
**以便** 不需要手动触发扫描

**验收标准**：
- AC-5.1：新增预制体后，自动触发扫描
- AC-5.2：删除预制体后，自动从数据库移除
- AC-5.3：重命名预制体后，自动更新数据库

### US-6：向后兼容

**作为** 玩家  
**我希望** 旧存档能正常加载  
**以便** 不会丢失之前的游戏进度

**验收标准**：
- AC-6.1：旧存档中的 prefabId（如 `Storage_1400_小木箱子_0`）能通过回退机制恢复
- AC-6.2：旧存档中的树木、石头、掉落物都能正常恢复
- AC-6.3：兼容层不影响新存档的正常工作

---

## 非功能需求

### NFR-1：性能

- 预制体扫描应在 1 秒内完成（100 个预制体以内）
- 运行时查找预制体应在 O(1) 时间复杂度

### NFR-2：可维护性

- 新增预制体类型时，不需要修改 PrefabDatabase 代码
- 代码结构清晰，易于理解和扩展

### NFR-3：可测试性

- 提供编辑器工具验证预制体配置
- 提供日志输出便于调试

---

## 约束

1. 保留 IPersistentObject 接口，不做破坏性修改
2. 保留 DynamicObjectFactory 的基本结构
3. 兼容现有的存档格式

---

**文档结束**
