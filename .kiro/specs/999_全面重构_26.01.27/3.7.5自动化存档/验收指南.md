# 自动化存档系统 - 验收指南

**创建日期**: 2026-02-03  
**版本**: 1.0

---

## 一、功能验收清单

### 1. PrefabDatabase 基础功能

- [ ] **1.1 资产创建**
  - 打开 `Assets/111_Data/Database/PrefabDatabase.asset`
  - 确认资产存在且可以在 Inspector 中查看

- [ ] **1.2 预制体扫描**
  - 点击 Inspector 中的"🔍 扫描预制体"按钮
  - 确认显示"已注册 57 个预制体（4 个文件夹）"
  - 确认预制体列表按文件夹分组显示

- [ ] **1.3 别名配置**
  - 展开"ID 别名映射"区域
  - 确认有 5 个默认别名：
    - `Storage_1400_小木箱子_0` → `Box_1`
    - `Storage_1401_大木箱子_0` → `Box_2`
    - `Storage_1402_小铁箱子_0` → `Box_3`
    - `Storage_1403_大铁箱子_0` → `Box_4`
    - `Chest` → `Box_1`

- [ ] **1.4 搜索功能**
  - 在预制体列表的搜索框中输入"Box"
  - 确认只显示包含"Box"的预制体

### 2. PersistentManagers 配置

- [ ] **2.1 组件配置**
  - 在场景中找到 `PersistentManagers` 对象
  - 确认 `Prefab Database` 字段已配置（或留空让系统从 Resources 加载）

- [ ] **2.2 初始化日志**
  - 运行游戏
  - 确认 Console 中显示：`[PersistentManagers] DynamicObjectFactory 已初始化`

### 3. 箱子存档恢复

- [ ] **3.1 放置箱子**
  - 运行游戏
  - 放置一个箱子（任意类型）
  - 记录箱子位置

- [ ] **3.2 保存存档**
  - 保存游戏

- [ ] **3.3 挖掉箱子**
  - 使用工具挖掉箱子
  - 确认箱子从场景中消失

- [ ] **3.4 加载存档**
  - 加载刚才保存的存档
  - 确认箱子在原位置恢复
  - 确认箱子内物品正确恢复

### 4. 旧存档兼容性

- [ ] **4.1 加载旧存档**
  - 如果有包含旧 prefabId 的存档，尝试加载
  - 确认不会崩溃

- [ ] **4.2 前缀回退**
  - 如果存档中有 `Storage_` 开头的 prefabId
  - 确认 Console 中显示回退警告：`[PrefabDatabase] 前缀回退: Storage_xxx → Box_1`

---

## 二、测试步骤

### 测试 A：完整存档流程

1. 启动游戏
2. 放置 2-3 个不同类型的箱子
3. 在箱子中放入一些物品
4. 保存游戏
5. 退出游戏
6. 重新启动游戏
7. 加载存档
8. 验证所有箱子和物品都正确恢复

### 测试 B：自动扫描

1. 在 Unity 编辑器中
2. 在 `Assets/222_Prefabs/Box/` 下创建一个新的预制体
3. 等待 1-2 秒
4. 打开 `PrefabDatabase.asset`
5. 确认新预制体已自动添加到列表中

### 测试 C：菜单命令

1. 点击菜单 `FarmGame/PrefabDatabase/手动扫描`
2. 确认 Console 显示扫描完成信息
3. 点击菜单 `FarmGame/PrefabDatabase/启用自动扫描`
4. 确认菜单项的勾选状态切换

---

## 三、预期结果

| 测试项 | 预期结果 |
|--------|----------|
| 预制体扫描 | 显示 57 个预制体，4 个文件夹 |
| 别名配置 | 5 个默认别名正确显示 |
| 箱子存档 | 箱子位置和内容正确恢复 |
| 旧存档兼容 | 不崩溃，显示回退警告 |
| 自动扫描 | 新预制体自动添加 |

---

## 四、已知限制

1. **PrefabDatabase 需要手动配置到 PersistentManagers**
   - 或者将 `PrefabDatabase.asset` 放到 `Resources` 文件夹下

2. **别名映射需要手动维护**
   - 如果有新的旧存档 ID 需要映射，需要手动添加别名

3. **自动扫描只监控配置的文件夹**
   - 默认监控：Tree、Rock、Box、WorldItems
   - 其他文件夹需要手动添加到配置中

---

## 五、故障排除

### 问题 1：箱子加载后消失

**可能原因**：
- PrefabDatabase 未初始化
- prefabId 找不到对应预制体

**解决方法**：
1. 检查 Console 是否有 `[DynamicObjectFactory]` 相关警告
2. 确认 PersistentManagers 上配置了 PrefabDatabase
3. 检查 PrefabDatabase 中是否有对应的预制体

### 问题 2：编译错误

**可能原因**：
- PrefabDatabase.cs 的 .meta 文件丢失

**解决方法**：
1. 在 Unity 中执行 `Assets/Refresh`
2. 或者删除 `PrefabDatabase.cs` 后重新创建

### 问题 3：自动扫描不工作

**可能原因**：
- 自动扫描被禁用
- PrefabDatabase.asset 不存在

**解决方法**：
1. 检查菜单 `FarmGame/PrefabDatabase/启用自动扫描` 是否勾选
2. 确认 `Assets/111_Data/Database/PrefabDatabase.asset` 存在

---

**文档结束**
