# è‡ªåŠ¨åŒ–å­˜æ¡£ç³»ç»Ÿ - æ–¹æ¡ˆè®¾è®¡

**åˆ›å»ºæ—¥æœŸ**: 2026-02-03  
**ä½œè€…**: Kiro  
**ç‰ˆæœ¬**: 1.0

---

## ä¸€ã€è®¾è®¡ç›®æ ‡

### 1.1 æ ¸å¿ƒç›®æ ‡

1. **é›¶é…ç½®**ï¼šæ–°å¢å¯å­˜æ¡£å¯¹è±¡æ—¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨é…ç½® PrefabRegistry
2. **ç»Ÿä¸€ç®¡ç†**ï¼šä¸€ä¸ªä¸­å¿ƒç®¡ç†æ‰€æœ‰å­˜æ¡£é€»è¾‘ï¼Œè€Œéåˆ†æ•£åœ¨å„ä¸ªå¯¹è±¡ä¸­
3. **æ™ºèƒ½å®¹é”™**ï¼šæ‰¾ä¸åˆ°é¢„åˆ¶ä½“æ—¶æœ‰æ™ºèƒ½å›é€€ï¼Œè€Œéç›´æ¥å¤±è´¥
4. **å‘åå…¼å®¹**ï¼šç°æœ‰çš„ IPersistentObject å®ç°ç»§ç»­å·¥ä½œ

### 1.2 éç›®æ ‡ï¼ˆæœ¬æ¬¡è¿­ä»£ä¸åšï¼‰

- å®Œå…¨ç§»é™¤ IPersistentObject æ¥å£
- åŸºäº Tag çš„å£°æ˜å¼å­˜æ¡£ï¼ˆç•™ç»™ä¸‹æ¬¡è¿­ä»£ï¼‰
- è·¨åœºæ™¯å­˜æ¡£

---

## äºŒã€æ ¸å¿ƒè®¾è®¡

### 2.1 PrefabDatabaseï¼ˆæ–°å¢ï¼‰

æ›¿ä»£ç°æœ‰çš„ PrefabRegistryï¼Œæä¾›è‡ªåŠ¨åŒ–çš„é¢„åˆ¶ä½“ç®¡ç†ã€‚

```csharp
[CreateAssetMenu(fileName = "PrefabDatabase", menuName = "FarmGame/Data/PrefabDatabase")]
public class PrefabDatabase : ScriptableObject
{
    [Header("é¢„åˆ¶ä½“æ–‡ä»¶å¤¹")]
    [Tooltip("è‡ªåŠ¨æ‰«æè¿™äº›æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰é¢„åˆ¶ä½“")]
    public string[] prefabFolders = new string[]
    {
        "Assets/222_Prefabs/Tree",
        "Assets/222_Prefabs/Rock",
        "Assets/222_Prefabs/Box",
        "Assets/222_Prefabs/WorldItems"
    };
    
    [Header("è¿è¡Œæ—¶æ•°æ®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰")]
    [SerializeField] private List<PrefabEntry> entries = new List<PrefabEntry>();
    
    // è¿è¡Œæ—¶ç¼“å­˜
    private Dictionary<string, GameObject> _cache;
    
    /// <summary>
    /// æ ¹æ®é¢„åˆ¶ä½“åç§°è·å–é¢„åˆ¶ä½“
    /// </summary>
    public GameObject GetPrefab(string prefabName)
    {
        // 1. ç²¾ç¡®åŒ¹é…
        if (_cache.TryGetValue(prefabName, out var prefab))
            return prefab;
        
        // 2. æ¨¡ç³ŠåŒ¹é…ï¼ˆå»æ‰åç¼€ï¼‰
        string cleanName = CleanPrefabName(prefabName);
        if (_cache.TryGetValue(cleanName, out prefab))
            return prefab;
        
        // 3. æ™ºèƒ½å›é€€ï¼ˆæ ¹æ®ç±»å‹æ¨æ–­ï¼‰
        return TryFallback(prefabName);
    }
    
    /// <summary>
    /// ç¼–è¾‘å™¨ï¼šæ‰«ææ–‡ä»¶å¤¹å¹¶æ›´æ–° entries
    /// </summary>
    [ContextMenu("æ‰«æé¢„åˆ¶ä½“")]
    public void ScanPrefabs()
    {
        entries.Clear();
        foreach (var folder in prefabFolders)
        {
            ScanFolder(folder);
        }
        // å»é‡æ£€æŸ¥
        RemoveDuplicates();
    }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **é¢„åˆ¶ä½“åç§°å³ ID**ï¼šä¸éœ€è¦é¢å¤–çš„ prefabId å­—æ®µ
2. **è‡ªåŠ¨æ‰«æ**ï¼šç¼–è¾‘å™¨ä¸­ç‚¹å‡»æŒ‰é’®å³å¯æ‰«ææ‰€æœ‰é¢„åˆ¶ä½“
3. **æ™ºèƒ½å›é€€**ï¼šæ‰¾ä¸åˆ°ç²¾ç¡®åŒ¹é…æ—¶ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…æˆ–ç±»å‹æ¨æ–­

### 2.2 prefabId å‘½åè§„èŒƒ

ç»Ÿä¸€æ‰€æœ‰å¯¹è±¡çš„ prefabId å‘½åï¼š

| å¯¹è±¡ç±»å‹ | å½“å‰å‘½å | æ–°å‘½åè§„èŒƒ |
|---------|---------|-----------|
| æ ‘æœ¨ | `M1`, `M2` | é¢„åˆ¶ä½“åç§°ï¼š`Tree_M1_00` |
| çŸ³å¤´ | `Stone_Iron_M1` | é¢„åˆ¶ä½“åç§°ï¼š`Rock_Iron_M1` |
| ç®±å­ | `Storage_1400_å°æœ¨ç®±å­_0` | é¢„åˆ¶ä½“åç§°ï¼š`Box_1` |
| æ‰è½ç‰© | æ— ï¼ˆä½¿ç”¨ itemIdï¼‰ | ä¿æŒä¸å˜ï¼ˆé€šè¿‡ WorldSpawnService é‡å»ºï¼‰ |

**æ ¸å¿ƒåŸåˆ™**ï¼š`prefabId = é¢„åˆ¶ä½“çš„ GameObject.name`

### 2.3 ChestController.Save() ä¿®æ”¹

```csharp
public WorldObjectSaveData Save()
{
    var data = new WorldObjectSaveData
    {
        guid = PersistentId,
        objectType = ObjectType,
        // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ä¸–ç•Œé¢„åˆ¶ä½“åç§°ï¼Œè€Œé StorageData åç§°
        prefabId = GetWorldPrefabName(),
        // ...
    };
    return data;
}

/// <summary>
/// è·å–ä¸–ç•Œé¢„åˆ¶ä½“åç§°
/// ä¼˜å…ˆä½¿ç”¨ storagePrefab çš„åç§°ï¼Œå›é€€åˆ° gameObject åç§°
/// </summary>
private string GetWorldPrefabName()
{
    // 1. ä¼˜å…ˆä½¿ç”¨ StorageData ä¸­é…ç½®çš„ä¸–ç•Œé¢„åˆ¶ä½“åç§°
    if (storageData != null && storageData.storagePrefab != null)
    {
        return storageData.storagePrefab.name;
    }
    
    // 2. å›é€€ï¼šä½¿ç”¨å½“å‰ GameObject åç§°ï¼ˆå»æ‰ "(Clone)" åç¼€ï¼‰
    string name = gameObject.name;
    if (name.EndsWith("(Clone)"))
    {
        name = name.Substring(0, name.Length - 7);
    }
    return name;
}
```

### 2.4 DynamicObjectFactory æ”¹è¿›

```csharp
private static IPersistentObject TryReconstructChest(WorldObjectSaveData data)
{
    string prefabId = data.prefabId;
    
    // 1. å°è¯•ç²¾ç¡®åŒ¹é…
    var prefab = _database.GetPrefab(prefabId);
    
    // 2. å¦‚æœå¤±è´¥ï¼Œå°è¯•ä» StorageData åç§°æ¨æ–­
    if (prefab == null && prefabId.StartsWith("Storage_"))
    {
        // Storage_1400_å°æœ¨ç®±å­_0 â†’ å°è¯•åŒ¹é… Box_1, Box_2 ç­‰
        prefab = _database.FindChestPrefabByCapacity(data);
    }
    
    // 3. æœ€ç»ˆå›é€€ï¼šä½¿ç”¨é»˜è®¤ç®±å­é¢„åˆ¶ä½“
    if (prefab == null)
    {
        prefab = _database.GetPrefab("Box_1");
        Debug.LogWarning($"[DynamicObjectFactory] ä½¿ç”¨é»˜è®¤ç®±å­é¢„åˆ¶ä½“ Box_1");
    }
    
    // ...
}
```

---

## ä¸‰ã€ç¼–è¾‘å™¨å·¥å…·

### 3.1 PrefabDatabaseEditor

```csharp
[CustomEditor(typeof(PrefabDatabase))]
public class PrefabDatabaseEditor : Editor
{
    public override void OnInspectorGUI()
    {
        var database = (PrefabDatabase)target;
        
        // ç»˜åˆ¶æ–‡ä»¶å¤¹åˆ—è¡¨
        DrawDefaultInspector();
        
        EditorGUILayout.Space();
        
        // æ‰«ææŒ‰é’®
        if (GUILayout.Button("ğŸ” æ‰«æé¢„åˆ¶ä½“", GUILayout.Height(30)))
        {
            database.ScanPrefabs();
            EditorUtility.SetDirty(database);
        }
        
        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        EditorGUILayout.HelpBox(
            $"å·²æ³¨å†Œ {database.EntryCount} ä¸ªé¢„åˆ¶ä½“",
            MessageType.Info
        );
        
        // æ˜¾ç¤ºé¢„åˆ¶ä½“åˆ—è¡¨ï¼ˆæŒ‰æ–‡ä»¶å¤¹åˆ†ç»„ï¼‰
        DrawPrefabList(database);
    }
}
```

### 3.2 è‡ªåŠ¨æ‰«æè§¦å‘

åœ¨ä»¥ä¸‹æ—¶æœºè‡ªåŠ¨è§¦å‘æ‰«æï¼š
1. ç¼–è¾‘å™¨å¯åŠ¨æ—¶
2. é¢„åˆ¶ä½“æ–‡ä»¶å¤¹å†…å®¹å˜åŒ–æ—¶ï¼ˆé€šè¿‡ AssetPostprocessorï¼‰
3. æ‰‹åŠ¨ç‚¹å‡»"æ‰«æé¢„åˆ¶ä½“"æŒ‰é’®

```csharp
public class PrefabDatabaseAutoScanner : AssetPostprocessor
{
    static void OnPostprocessAllAssets(
        string[] importedAssets,
        string[] deletedAssets,
        string[] movedAssets,
        string[] movedFromAssetPaths)
    {
        // æ£€æŸ¥æ˜¯å¦æœ‰é¢„åˆ¶ä½“å˜åŒ–
        bool prefabChanged = importedAssets
            .Concat(deletedAssets)
            .Any(path => path.EndsWith(".prefab") && IsInWatchedFolder(path));
        
        if (prefabChanged)
        {
            // å»¶è¿Ÿæ‰«æï¼Œé¿å…é¢‘ç¹è§¦å‘
            EditorApplication.delayCall += () =>
            {
                var database = LoadPrefabDatabase();
                if (database != null)
                {
                    database.ScanPrefabs();
                    EditorUtility.SetDirty(database);
                }
            };
        }
    }
}
```

---

## å››ã€è¿ç§»è®¡åˆ’

### 4.1 ç¬¬ä¸€æ­¥ï¼šåˆ›å»º PrefabDatabase

1. åˆ›å»º `PrefabDatabase.cs`
2. åˆ›å»º `PrefabDatabaseEditor.cs`
3. åœ¨ `Assets/111_Data/Database/` ä¸‹åˆ›å»º `PrefabDatabase.asset`
4. é…ç½®é¢„åˆ¶ä½“æ–‡ä»¶å¤¹è·¯å¾„
5. æ‰§è¡Œæ‰«æ

### 4.2 ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ DynamicObjectFactory

1. å°† `_registry` æ›¿æ¢ä¸º `_database`
2. æ›´æ–° `Initialize()` æ–¹æ³•
3. æ›´æ–°æ‰€æœ‰ `GetPrefab()` è°ƒç”¨

### 4.3 ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹å„å¯¹è±¡çš„ Save() æ–¹æ³•

1. `ChestController.Save()` - ä½¿ç”¨ `storagePrefab.name`
2. `TreeController.Save()` - ç¡®è®¤ä½¿ç”¨é¢„åˆ¶ä½“åç§°
3. `StoneController.Save()` - ç¡®è®¤ä½¿ç”¨é¢„åˆ¶ä½“åç§°

### 4.4 ç¬¬å››æ­¥ï¼šæ¸…ç†æ—§ä»£ç 

1. åˆ é™¤ `PrefabRegistry.cs`ï¼ˆæˆ–æ ‡è®°ä¸º Obsoleteï¼‰
2. æ›´æ–° `PersistentManagers.cs` ä¸­çš„åˆå§‹åŒ–é€»è¾‘

---

## äº”ã€é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| æ—§å­˜æ¡£ä¸å…¼å®¹ | æ—§å­˜æ¡£ä¸­çš„ prefabId å¯èƒ½æ— æ³•åŒ¹é… | æ™ºèƒ½å›é€€æœºåˆ¶ + å…¼å®¹å±‚ |
| é¢„åˆ¶ä½“é‡å‘½å | é‡å‘½ååæ—§å­˜æ¡£æ— æ³•æ¢å¤ | ä¿ç•™æ—§åç§°çš„åˆ«åæ˜ å°„ |
| æ‰«ææ€§èƒ½ | å¤§é‡é¢„åˆ¶ä½“æ—¶æ‰«æå¯èƒ½è¾ƒæ…¢ | å¢é‡æ‰«æ + ç¼“å­˜ |

---

## å…­ã€éªŒæ”¶æ ‡å‡†

1. **ç®±å­æ¢å¤æ­£å¸¸**ï¼šåŠ è½½å­˜æ¡£åç®±å­èƒ½æ­£ç¡®é‡å»º
2. **é›¶é…ç½®**ï¼šæ–°å¢é¢„åˆ¶ä½“åä¸éœ€è¦æ‰‹åŠ¨é…ç½®
3. **ç¼–è¾‘å™¨å‹å¥½**ï¼šä¸€é”®æ‰«æï¼Œæ¸…æ™°çš„é¢„åˆ¶ä½“åˆ—è¡¨
4. **å‘åå…¼å®¹**ï¼šæ—§å­˜æ¡£èƒ½æ­£å¸¸åŠ è½½

---

**æ–‡æ¡£ç»“æŸ**
