# ğŸ”´ é—®é¢˜å®¡æ ¸æŠ¥å‘Šï¼šæ ‘æœ¨æ¶ˆå¤± Bug

**å®¡æ ¸æ—¥æœŸ**: 2026-02-01  
**å®¡æ ¸äºº**: Kiro  
**çŠ¶æ€**: ğŸ”´ ä¸¥é‡é—®é¢˜å¾…ä¿®å¤

---

## ä¸€ã€é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼š
- é…ç½®å®Œ PrefabRegistry åæµ‹è¯•
- ä¸ä»…ç§ä¸‹çš„æ ‘è‹—æ¶ˆå¤±
- è¿åŸæœ¬åœºæ™¯ä¸­é¢„è®¾çš„æ ‘æœ¨ä¹Ÿéƒ½æ²¡åŠ è½½å‡ºæ¥
- åªæœ‰ 1 æ£µæ ‘æˆåŠŸé‡å»º

---

## äºŒã€æ—¥å¿—è¯æ®åˆ†æ

### 2.1 å…³é”®è­¦å‘Šæ—¥å¿—

```
[PrefabRegistry] æ‰¾ä¸åˆ°é¢„åˆ¶ä½“: M1 (1)
[DynamicObjectFactory] æ‰¾ä¸åˆ°é¢„åˆ¶ä½“: M1 (1)
[PrefabRegistry] æ‰¾ä¸åˆ°é¢„åˆ¶ä½“: M1 (2)
[DynamicObjectFactory] æ‰¾ä¸åˆ°é¢„åˆ¶ä½“: M1 (2)
... (é‡å¤ 18 æ¬¡)
```

### 2.2 æˆåŠŸæ—¥å¿—

```
[DynamicObjectFactory] æ ‘æœ¨é‡å»ºæˆåŠŸ: prefabId=M1, guid=5f0a3f07-d948-4349-b341-56314ab5d0e1
```

### 2.3 åŒ¹é…ç‡

```
[Registry] å­˜æ¡£åŒ¹é…ç‡: 7/25
```

---

## ä¸‰ã€æ ¹å› åˆ†æ

### ğŸ”´ é—®é¢˜ä¸€ï¼šprefabId æ ¼å¼é”™è¯¯ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰

**å­˜æ¡£ä¸­çš„ prefabId**:
```json
"prefabId": "M1 (5)"
"prefabId": "M1 (18)"
"prefabId": "M1 (7)"
...
```

**PrefabRegistry ä¸­é…ç½®çš„ prefabId**:
```
M1
M2
M3
```

**é—®é¢˜**ï¼šå­˜æ¡£ä¸­å­˜çš„æ˜¯ `M1 (5)` è¿™ç§å¸¦æ‹¬å·åç¼€çš„æ ¼å¼ï¼Œè€Œ PrefabRegistry åªé…ç½®äº† `M1`ï¼Œå¯¼è‡´æŸ¥æ‰¾å¤±è´¥ã€‚

**æ ¹å› è¿½æº¯**ï¼š`TreeController.GetPrefabId()` æ–¹æ³•çš„è§£æé€»è¾‘æœ‰é—®é¢˜ã€‚

### ğŸ”´ é—®é¢˜äºŒï¼šGetPrefabId() æ–¹æ³• Bug

**å½“å‰ä»£ç **:
```csharp
private string GetPrefabId()
{
    string parentName = transform.parent != null ? transform.parent.name : gameObject.name;
    
    // ç§»é™¤ (Clone) åç¼€
    if (parentName.EndsWith("(Clone)"))
    {
        parentName = parentName.Substring(0, parentName.Length - 7).Trim();
    }
    
    // è§£ææ ¼å¼ï¼šTree_M1_00 æˆ– M1_00 æˆ– M1
    string[] parts = parentName.Split('_');
    foreach (var part in parts)
    {
        if (part.Length >= 2 && part[0] == 'M' && char.IsDigit(part[1]))
        {
            return part;  // â† è¿™é‡Œè¿”å›çš„æ˜¯ "M1 (5)" è€Œä¸æ˜¯ "M1"
        }
    }
    
    return "M1";
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. åœºæ™¯ä¸­çš„æ ‘æœ¨çˆ¶ç‰©ä½“åç§°æ˜¯ `M1 (5)`ã€`M1 (18)` è¿™ç§æ ¼å¼ï¼ˆUnity å¤åˆ¶ç‰©ä½“æ—¶è‡ªåŠ¨æ·»åŠ çš„ç¼–å·ï¼‰
2. `Split('_')` åˆ†å‰²åï¼Œ`M1 (5)` æ•´ä½“ä½œä¸ºä¸€ä¸ª part
3. æ£€æŸ¥ `part[0] == 'M' && char.IsDigit(part[1])` é€šè¿‡ï¼ˆå› ä¸º `M1 (5)` çš„å‰ä¸¤ä¸ªå­—ç¬¦æ˜¯ `M1`ï¼‰
4. ç›´æ¥è¿”å› `M1 (5)` è€Œä¸æ˜¯ `M1`

**æ­£ç¡®é€»è¾‘åº”è¯¥æ˜¯**ï¼š
- åªæå– `M` + æ•°å­—éƒ¨åˆ†ï¼Œå¿½ç•¥åé¢çš„ç©ºæ ¼å’Œæ‹¬å·

### ğŸŸ¡ é—®é¢˜ä¸‰ï¼šNavGrid2D æ—¥å¿—åˆ·å±

**æ—¥å¿—**:
```
[NavGrid2D] è‡ªåŠ¨æ£€æµ‹ä¸–ç•Œè¾¹ç•Œ: Origin=(-46.00, -22.00), Size=(64.00, 76.00)
[NavGrid2D] ç½‘æ ¼é‡å»ºå®Œæ¯•: 128x152=19456 å•å…ƒï¼Œéšœç¢ç‰©=324
```

**é—®é¢˜**ï¼šæ¯æ¬¡é‡å»ºéƒ½è¾“å‡ºä¸¤è¡Œæ—¥å¿—ï¼ŒåŠ è½½å­˜æ¡£æ—¶è§¦å‘äº† 20+ æ¬¡é‡å»ºï¼Œå¯¼è‡´ 40+ è¡Œæ—¥å¿—åˆ·å±ã€‚

**å»ºè®®**ï¼šæ·»åŠ æ—¥å¿—å¼€å…³æˆ–é™ä½æ—¥å¿—é¢‘ç‡ã€‚

### ğŸŸ¢ é—®é¢˜å››ï¼šå°å°äºŒé€»è¾‘å·²ä¿®æ­£

ä¹‹å‰çš„å°å°äºŒè¯¯æ€æ ‘è‹—é—®é¢˜å·²åœ¨ä¸Šä¸€æ¬¡ä¿®æ­£ä¸­è§£å†³ï¼Œæœ¬æ¬¡æ—¥å¿—ä¸­æ²¡æœ‰å‡ºç°"è·³è¿‡æ­»æ ‘"çš„è­¦å‘Šã€‚

---

## å››ã€é—®é¢˜å½±å“è¯„ä¼°

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | ä¿®å¤éš¾åº¦ |
|------|---------|---------|---------|
| prefabId æ ¼å¼é”™è¯¯ | ğŸ”´ ä¸¥é‡ | æ‰€æœ‰é™æ€æ ‘æœ¨æ— æ³•é‡å»º | ç®€å• |
| GetPrefabId() Bug | ğŸ”´ ä¸¥é‡ | æ–°å­˜æ¡£ä¹Ÿä¼šæœ‰é—®é¢˜ | ç®€å• |
| NavGrid2D æ—¥å¿—åˆ·å± | ğŸŸ¡ ä¸­ç­‰ | æ§åˆ¶å°å¯è¯»æ€§å·® | ç®€å• |

---

## äº”ã€ä¿®å¤æ–¹æ¡ˆ

### 5.1 ä¿®å¤ GetPrefabId() æ–¹æ³•

**æ–‡ä»¶**: `Assets/YYY_Scripts/Controller/TreeController.cs`

**ä¿®æ”¹**:
```csharp
private string GetPrefabId()
{
    string parentName = transform.parent != null ? transform.parent.name : gameObject.name;
    
    // ç§»é™¤ (Clone) åç¼€
    if (parentName.EndsWith("(Clone)"))
    {
        parentName = parentName.Substring(0, parentName.Length - 7).Trim();
    }
    
    // ğŸ”¥ æ–°å¢ï¼šç§»é™¤ Unity å¤åˆ¶ç‰©ä½“æ—¶æ·»åŠ çš„ç¼–å·åç¼€ï¼Œå¦‚ " (5)"
    int spaceParenIndex = parentName.IndexOf(" (");
    if (spaceParenIndex > 0)
    {
        parentName = parentName.Substring(0, spaceParenIndex);
    }
    
    // è§£ææ ¼å¼ï¼šTree_M1_00 æˆ– M1_00 æˆ– M1
    string[] parts = parentName.Split('_');
    foreach (var part in parts)
    {
        if (part.Length >= 2 && part[0] == 'M' && char.IsDigit(part[1]))
        {
            // ğŸ”¥ åªæå– M + æ•°å­—éƒ¨åˆ†
            int i = 1;
            while (i < part.Length && char.IsDigit(part[i]))
            {
                i++;
            }
            return part.Substring(0, i);
        }
    }
    
    return "M1";
}
```

### 5.2 NavGrid2D æ—¥å¿—é™å™ª

**æ–‡ä»¶**: `Assets/YYY_Scripts/Utils/NavGrid2D.cs`

**ä¿®æ”¹**ï¼šå°†æ—¥å¿—æ”¾å…¥ `showDebugInfo` å¼€å…³æ§åˆ¶ã€‚

### 5.3 æ¸…ç†æ—§å­˜æ¡£

ä¿®å¤ä»£ç åï¼Œéœ€è¦ï¼š
1. åˆ é™¤æ—§å­˜æ¡£ `slot1.json`
2. é‡æ–°ä¿å­˜åœºæ™¯
3. é‡æ–°å¼€å§‹æ¸¸æˆæµ‹è¯•

---

## å…­ã€åçœä¸æ•™è®­

### 6.1 æˆ‘çš„å¤±è¯¯

1. **æ²¡æœ‰å……åˆ†æµ‹è¯• GetPrefabId() æ–¹æ³•**
   - åªè€ƒè™‘äº† `Tree_M1_00` æ ¼å¼
   - æ²¡æœ‰è€ƒè™‘ Unity å¤åˆ¶ç‰©ä½“æ—¶æ·»åŠ çš„ ` (N)` åç¼€

2. **æ²¡æœ‰æ£€æŸ¥å­˜æ¡£æ–‡ä»¶å†…å®¹**
   - å¦‚æœåœ¨ç¬¬ä¸€æ¬¡æµ‹è¯•åå°±æ£€æŸ¥ slot1.jsonï¼Œä¼šç«‹å³å‘ç° prefabId æ ¼å¼é—®é¢˜

3. **æ—¥å¿—é™å™ªä¸å½»åº•**
   - åªå¤„ç†äº† InventoryBootstrap å’Œ StoneController
   - å¿½ç•¥äº† NavGrid2D çš„åˆ·å±é—®é¢˜

### 6.2 æ”¹è¿›æªæ–½

1. **æ–°å¢åŠŸèƒ½åå¿…é¡»æ£€æŸ¥å­˜æ¡£å†…å®¹**
   - ä¿å­˜åç«‹å³æŸ¥çœ‹ JSON æ–‡ä»¶
   - éªŒè¯æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®

2. **æµ‹è¯•ç”¨ä¾‹è¦è¦†ç›–è¾¹ç•Œæƒ…å†µ**
   - åœºæ™¯ä¸­çš„é™æ€ç‰©ä½“ï¼ˆå¸¦ Unity ç¼–å·åç¼€ï¼‰
   - è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºçš„ç‰©ä½“ï¼ˆå¸¦ Clone åç¼€ï¼‰

3. **æ—¥å¿—å®¡æŸ¥è¦å…¨é¢**
   - ä¸åªæ˜¯çœ‹é”™è¯¯å’Œè­¦å‘Š
   - ä¹Ÿè¦å…³æ³¨åˆ·å±çš„æ™®é€šæ—¥å¿—

---

## ä¸ƒã€æ‰§è¡Œè®¡åˆ’

| æ­¥éª¤ | ä»»åŠ¡ | çŠ¶æ€ |
|------|------|------|
| 1 | ä¿®å¤ GetPrefabId() æ–¹æ³• | â³ å¾…æ‰§è¡Œ |
| 2 | NavGrid2D æ—¥å¿—é™å™ª | â³ å¾…æ‰§è¡Œ |
| 3 | åˆ é™¤æ—§å­˜æ¡£ | â³ å¾…ç”¨æˆ·æ“ä½œ |
| 4 | é‡æ–°ä¿å­˜åœºæ™¯ | â³ å¾…ç”¨æˆ·æ“ä½œ |
| 5 | é‡æ–°æµ‹è¯• | â³ å¾…ç”¨æˆ·æ“ä½œ |

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2026-02-01 22:50
