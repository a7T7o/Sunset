# 自动化 GUID 管理系统 - 需求文档

## 背景

当前的持久化系统存在一个工作流痛点：
- 静态场景物体（树木、石头等）需要在编辑器中预生成 GUID
- 每次新增或复制物体后，需要手动执行"重新生成 GUID"并保存场景
- 开发者容易忘记这个操作，导致存档系统出现 GUID 冲突或丢失

## 用户故事

### US-1: 自动化 GUID 生成
**作为**游戏开发者
**我希望**在保存场景时自动为所有缺失 GUID 的持久化对象生成 GUID
**以便**我不需要手动记住每次都要执行"重新生成 GUID"操作

**验收标准**:
- AC-1.1: 当按下 Ctrl+S 保存场景时，系统自动扫描所有 `IPersistentObject`
- AC-1.2: 对于 `persistentId` 为空的对象，自动生成新的 GUID
- AC-1.3: 已有 GUID 的对象不受影响
- AC-1.4: 在控制台输出修复数量的日志（仅当有修复时）

### US-2: 支持所有持久化对象类型
**作为**游戏开发者
**我希望**自动化系统能处理所有实现 `IPersistentObject` 的组件
**以便**不仅是树木，石头、箱子等也能自动管理

**验收标准**:
- AC-2.1: 支持 `TreeController`
- AC-2.2: 支持 `StoneController`
- AC-2.3: 支持 `ChestController`
- AC-2.4: 支持未来新增的任何 `IPersistentObject` 实现

### US-3: 构建时验证
**作为**游戏开发者
**我希望**在构建游戏时自动验证所有场景的 GUID 完整性
**以便**确保发布的游戏不会有 GUID 问题

**验收标准**:
- AC-3.1: 构建前自动扫描所有 Build Settings 中的场景
- AC-3.2: 检测并报告任何缺失 GUID 的对象
- AC-3.3: 可选择自动修复或中断构建

### US-4: 手动验证工具
**作为**游戏开发者
**我希望**有一个菜单命令可以手动验证当前场景的 GUID 状态
**以便**在需要时主动检查场景健康度

**验收标准**:
- AC-4.1: 提供菜单项 `工具/持久化系统/验证当前场景 GUID`
- AC-4.2: 输出详细的验证报告（缺失数量、重复数量）
- AC-4.3: 提供一键修复选项

### US-5: GUID 冲突检测
**作为**游戏开发者
**我希望**系统能检测并警告 GUID 重复的情况
**以便**避免 Ctrl+D 复制物体导致的 GUID 冲突

**验收标准**:
- AC-5.1: 保存场景时检测同一场景内的 GUID 重复
- AC-5.2: 对重复的 GUID 自动重新生成（保留第一个，修复后续的）
- AC-5.3: 在控制台输出警告信息

## 非功能需求

### NFR-1: 性能
- 场景保存时的扫描应在 100ms 内完成（对于 1000 个对象）
- 不应影响正常的编辑器操作体验

### NFR-2: 兼容性
- 必须兼容现有的 `IPersistentObject` 接口
- 不修改现有组件的运行时逻辑
- 仅在编辑器模式下运行

### NFR-3: 可配置性
- 提供开关控制是否启用自动化
- 提供日志级别控制（静默/简洁/详细）

## 约束

1. **仅编辑器模式**：所有自动化逻辑只在 Unity Editor 中运行，不影响运行时
2. **不修改运行时代码**：现有的 `TreeController`、`StoneController` 等运行时逻辑不变
3. **向后兼容**：现有的手动 ContextMenu 功能保留

## 术语表

| 术语 | 定义 |
|------|------|
| GUID | 全局唯一标识符，用于在存档系统中唯一标识一个对象 |
| 静态对象 | 在场景编辑器中预先放置的对象（非运行时生成） |
| 动态对象 | 运行时通过代码生成的对象（如玩家放置的树苗） |
| IPersistentObject | 持久化对象接口，所有需要存档的对象都实现此接口 |
