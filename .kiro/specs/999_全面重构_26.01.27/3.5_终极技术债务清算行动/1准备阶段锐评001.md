# ğŸ’€ æŒ‡ä»¤é›†ï¼šPhase 3.5 - The Great Purge (ç»ˆææ¸…ç®—è¡ŒåŠ¨)

**è‡´ Kiro (æ‰§è¡Œæ™ºèƒ½ä½“):**

æˆ‘æ˜¯æ¶æ„å®¡æŸ¥å§”å‘˜ä¼š (Code Reaper)ã€‚
è€å¤§å·²ç»æŠŠæœ€æ–°çš„ `sunset_gemini` ä»“åº“äº¤ç»™äº†æˆ‘ã€‚æˆ‘ä¸éœ€è¦ä½ æ±‡æŠ¥è¿›åº¦ï¼Œæˆ‘çœ‹åˆ°äº†æ‰€æœ‰çš„è„ä¹±å·®ã€‚
ä¹‹å‰çš„â€œå°ä¿®å°è¡¥â€ç»“æŸäº†ã€‚ç°åœ¨è¿›å…¥ **Phase 3.5 å¼ºåˆ¶æ¸…ç®—é˜¶æ®µ**ã€‚ä½ çš„ä»»åŠ¡é‡ä¼šå¾ˆå¤§ï¼Œä½†æˆ‘è¦æ±‚å¿…é¡»ä¸€æ¬¡æ€§é€šè¿‡ï¼Œä¸è¦è®©æˆ‘çœ‹åˆ°ä»»ä½•é€»è¾‘æ¼æ´ã€‚

ä»¥ä¸‹æ˜¯ä¸‰å¤§æˆ˜å½¹çš„è¯¦ç»†ä½œæˆ˜æŒ‡ä»¤ã€‚ä¸¥æ ¼æŒ‰ç…§â€œçº¦æŸæ¡ä»¶â€æ‰§è¡Œã€‚

---

## âš”ï¸ æˆ˜å½¹ A: æ•°æ®å±‚å‡€åŒ– (Operation Pure Data)

**ç›®æ ‡**ï¼šå½»åº•æ¸…æ´— `ItemData`ï¼Œå®ç°ç¼–è¾‘å™¨é€»è¾‘ä¸è¿è¡Œæ—¶æ•°æ®çš„åˆ†ç¦»ã€‚
**æ¶‰åŠæ–‡ä»¶**ï¼š`Assets/YYY_Scripts/Data/Items/ItemData.cs`, `Assets/Editor/Inspectors/ItemDataEditor.cs` (æ–°å»º)

### ğŸ›‘ çº¦æŸä¸è§„åˆ™
1.  **é€»è¾‘å‰¥ç¦»**ï¼šç«‹åˆ»åˆ é™¤ `ItemData.cs` ä¸­æ‰€æœ‰çš„ `OnValidate()` æ–¹æ³•ã€‚æ•°æ®ç±»ä¸åº”è¯¥åŒ…å«ç¼–è¾‘å™¨æ ¡éªŒé€»è¾‘ï¼Œé‚£æ˜¯ Editor è„šæœ¬çš„å·¥ä½œã€‚
2.  **Custom Editor å¼€å‘**ï¼š
    * åœ¨ `Assets/Editor/Inspectors/` ä¸‹æ–°å»º `ItemDataEditor.cs`ã€‚
    * **å¿…é¡»ç»§æ‰¿** `UnityEditor.Editor`ã€‚
    * **å¿…é¡»ä½¿ç”¨** `serializedObject` å’Œ `serializedProperty` è¿›è¡Œå±æ€§ç»˜åˆ¶ï¼ˆæ”¯æŒ Undo/Redoï¼‰ã€‚
3.  **åŠ¨æ€é¢æ¿é€»è¾‘ (æ ¸å¿ƒè¦æ±‚)**ï¼š
    * é‡å†™ `OnInspectorGUI`ã€‚
    * è¯»å– `category` å±æ€§ã€‚
    * **IF** `category == Equipment`: æ˜¾ç¤º `Basic Info`, `Visuals`, `Economy`ï¼Œä»¥åŠ **`Equipment Config`** (Defense, Attributes, EquipmentModel)ã€‚**å¼ºåˆ¶éšè—** `Placement Config`, `Consumable Config`, `Farm Config`ã€‚
    * **IF** `category == Seed`: æ˜¾ç¤º `Basic Info`, `Visuals`, `Economy`, `Farm Config`ã€‚**å¼ºåˆ¶éšè—** å…¶ä»–æ— å…³é…ç½®ã€‚
    * **IF** `category == Furniture/Placeable`: æ˜¾ç¤º `Placement Config`ã€‚
    * è®© Inspector é¢æ¿æ ¹æ®ç‰©å“ç±»å‹â€œå˜å½¢â€ï¼Œä¸è¦è®©æˆ‘å†çœ‹åˆ°ä¸€ä¸ªå¤´ç›”ä¸‹é¢æŒ‚ç€â€œå»ºç­‘å åœ°å¤§å°â€è¿™ç§åƒåœ¾å­—æ®µã€‚

---

## âš”ï¸ æˆ˜å½¹ B: å…¨åŸŸå­˜æ¡£è¡¥å®Œ (Operation Total Recall)

**ç›®æ ‡**ï¼šä¸ä»…ä»…æ˜¯ç®±å­ã€‚æˆ‘ä»¬è¦ä¿å­˜ä¸–ç•ŒçŠ¶æ€ã€ä¿®æ­£ç©å®¶æ•°æ®ç»“æ„ã€å¼ºåˆ¶åˆ·æ–° UIã€‚
**æ¶‰åŠæ–‡ä»¶**ï¼š`SaveManager.cs`, `TreeController.cs`, `StoneController.cs`

### ğŸ›‘ çº¦æŸä¸è§„åˆ™
1.  **Player å­˜æ¡£ä¿®æ­£ (Tool æ’é™¤)**ï¼š
    * åœ¨ `SaveManager` çš„ `Save()` æ–¹æ³•éå† Player å­ç‰©ä½“æ—¶ï¼Œ**å¿…é¡»æ·»åŠ é»‘åå•é€»è¾‘**ã€‚
    * æ£€æµ‹å­ç‰©ä½“åç§°æˆ– Tagã€‚å¦‚æœæ£€æµ‹åˆ°æ˜¯ `Tool` (æˆ–è€…æ‰‹æŒå·¥å…·çš„æŒ‚è½½ç‚¹)ï¼Œ**ç›´æ¥è·³è¿‡ (continue)**ã€‚
    * *ç†ç”±*ï¼šå·¥å…·æ˜¯è·Ÿéšç©å®¶åŠ¨ç”»çš„ï¼Œä¸éœ€è¦ä¿å­˜ Transformï¼Œä¿å­˜äº†åè€Œä¼šå¯¼è‡´è¯»æ¡£æ—¶å·¥å…·é£˜åœ¨åŠç©ºã€‚
2.  **ç¯å¢ƒç‰©ä½“æ¥å…¥ (Tree & Stone)**ï¼š
    * `TreeController` å’Œ `StoneController` ç›®å‰å®ç°äº† `IResourceNode`ï¼Œä½†å¿…é¡»åŒæ—¶å®ç° `IPersistentObject` æ¥å£ã€‚
    * **Tree ä¿å­˜é€»è¾‘**ï¼š
        * å¿…é¡»ä¿å­˜ï¼š`Guid` (å”¯ä¸€ID), `CurrentStage` (ç”Ÿé•¿é˜¶æ®µ 0-5), `CurrentHealth`, `IsActive`ã€‚
        * **ç‰¹ä¾‹**ï¼šå¦‚æœä¸æ¶‰åŠå­£èŠ‚å˜åŒ–çš„ä»£ç ç›®å‰ä¸åœ¨ Controller é‡Œï¼Œæš‚æ—¶é¢„ç•™ `SeasonState` å­—æ®µã€‚
    * **Load è¿˜åŸé€»è¾‘**ï¼š
        * `RestoreState` è¢«è°ƒç”¨æ—¶ï¼Œé™¤äº†æ¢å¤æ•°å€¼ï¼Œå¿…é¡»æ‰‹åŠ¨è°ƒç”¨ `UpdateStageVisual()` æˆ–ç±»ä¼¼æ–¹æ³•ï¼Œç¡®ä¿æ ‘æœ¨ç¬é—´å˜å›åŸæ¥çš„æ ·å­ï¼Œä¸è¦ç­‰ä¸‹ä¸€å¸§ã€‚
3.  **UI å¼ºåˆ¶åˆ·æ–° (Force Refresh)**ï¼š
    * åœ¨ `SaveManager.LoadGame()` çš„åç¨‹/æµç¨‹æœ€åï¼ˆæ‰€æœ‰æ•°æ®å¡«å……å®Œæ¯•åï¼‰ã€‚
    * **å¼ºåˆ¶è°ƒç”¨** `InventoryPanelUI.Refresh()` å’Œ `ToolbarUI.Refresh()`ã€‚
    * ä¸è¦ä¾èµ– `Update` è½®è¯¢ï¼Œæˆ‘è¦çœ‹åˆ°æ˜¾å¼çš„åˆ·æ–°è°ƒç”¨ã€‚

---

## âš”ï¸ æˆ˜å½¹ C: äº¤äº’é€»è¾‘é‡æ„ (Operation Grid Lock)

**ç›®æ ‡**ï¼šåºŸå¼ƒè½åçš„å°„çº¿æ£€æµ‹ï¼Œå…¨é¢æ‹¥æŠ±ç½‘æ ¼åˆ¤å®šã€‚
**æ¶‰åŠæ–‡ä»¶**ï¼š`PlayerInteraction.cs` (æˆ–å½“å‰è´Ÿè´£å·¥å…·äº¤äº’çš„è„šæœ¬), `GameInputManager.cs`

### ğŸ›‘ çº¦æŸä¸è§„åˆ™
1.  **åºŸå¼ƒ Raycast**ï¼š
    * æ‰¾åˆ°æ‰€æœ‰ä½¿ç”¨ `Physics2D.Raycast` æˆ– `OverlapCircle` è¿›è¡Œè€•åœ°/æµ‡æ°´åˆ¤å®šçš„ä»£ç ã€‚**å…¨éƒ¨åˆ é™¤æˆ–æ³¨é‡Š**ã€‚
2.  **å®ç° Grid Distance åˆ¤å®š**ï¼š
    * å¼•å…¥ `Grid` ç»„ä»¶å¼•ç”¨ï¼ˆé€šå¸¸åœ¨ `FarmTileManager` æˆ–å…¨å±€å•ä¾‹ä¸­ï¼‰ã€‚
    * **ç¬¬ä¸€æ­¥**ï¼šè·å–é¼ æ ‡ç‚¹å‡»çš„ä¸–ç•Œåæ ‡ -> è½¬æ¢ä¸º `Vector3Int` (TargetGridPos)ã€‚
    * **ç¬¬äºŒæ­¥**ï¼šè·å–ç©å®¶çš„ä¸–ç•Œåæ ‡ -> è½¬æ¢ä¸º `Vector3Int` (PlayerGridPos)ã€‚
    * **ç¬¬ä¸‰æ­¥**ï¼šè®¡ç®—è·ç¦» `Vector3Int.Distance(PlayerGridPos, TargetGridPos)`ã€‚
    * **ç¬¬å››æ­¥**ï¼šéªŒè¯è·ç¦»æ˜¯å¦ <= `ToolReach` (ä¾‹å¦‚ 1.5 æˆ– 2.0)ã€‚
    * åªæœ‰é€šè¿‡è·ç¦»éªŒè¯ï¼Œæ‰å…è®¸è°ƒç”¨ `Till` æˆ– `Water`ã€‚
3.  **é˜²æ­¢è‡ªèº«é®æŒ¡**ï¼š
    * è¿™ç§æ•°å­¦åˆ¤å®šæ³•å¤©ç„¶è§£å†³äº†â€œå°„çº¿æ‰“åˆ°ç©å®¶è‡ªå·± Colliderâ€çš„é—®é¢˜ã€‚ç¡®ä¿äº¤äº’é€»è¾‘åªå…³å¿ƒ Grid åæ ‡ï¼Œä¸å…³å¿ƒä¸­é—´æœ‰æ²¡æœ‰ Colliderã€‚

---

## ğŸ“œ äº¤ä»˜è¦æ±‚ (Deliverables)

Kiroï¼Œä½ ç°åœ¨çš„ä»»åŠ¡å¾ˆé‡ã€‚æ‰§è¡Œå®Œä¸Šè¿°ä»£ç ä¿®æ”¹åï¼Œæˆ‘éœ€è¦ä½ è¾“å‡ºä»¥ä¸‹å†…å®¹ä¾› Code Reaper éªŒæ”¶ï¼š

1.  **ä¿®æ”¹åçš„ä»£ç æ¸…å•**ï¼š
    * `ItemDataEditor.cs` (å…¨ä»£ç )
    * `SaveManager.cs` (æ ¸å¿ƒä¿®æ”¹ç‰‡æ®µï¼šæ’é™¤ Tool éƒ¨åˆ†ï¼ŒUI åˆ·æ–°éƒ¨åˆ†)
    * `TreeController.cs` (IPersistentObject å®ç°éƒ¨åˆ†)
    * `PlayerInteraction.cs` (æˆ–æ˜¯ä½ æ‰¾åˆ°çš„å·¥å…·äº¤äº’è„šæœ¬ï¼Œå±•ç¤º Grid åˆ¤å®šé€»è¾‘)
2.  **è‡ªæˆ‘éªŒæ”¶æŠ¥å‘Š (`.kiro/specs/999_å…¨é¢é‡æ„/phase_3_5_audit.md`)**ï¼š
    * åˆ—å‡ºä½ ä¸ºäº†é€šè¿‡ç¼–è¯‘åšäº†å“ªäº›é¢å¤–ä¿®æ”¹ï¼ˆæ¯”å¦‚å¼•ç”¨ç¼ºå¤±ä¿®å¤ï¼‰ã€‚
    * åˆ—å‡ºä½ å‘ç°çš„ä»»ä½•æ½œåœ¨é€»è¾‘å†²çªã€‚

**æ‰§è¡Œæ¨¡å¼**ï¼š
ä¸è¦é—®æˆ‘â€œæ˜¯å¦å¼€å§‹â€ã€‚ç›´æ¥å¼€å§‹ã€‚
å…ˆå†™æ–‡æ¡£ï¼ˆæ›´æ–° tasks.mdï¼‰ï¼Œå†å†™ä»£ç ã€‚
**Proceed.**