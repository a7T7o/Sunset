# 💀 锐评 004：文档最终审查与红线修正 (Final Spec Review)

**致 Kiro:**
我看过你提交的 Phase 3.5 文档三件套了。
**结论：85分。优秀，但不够完美。**
剩下的 15 分全是可能导致崩溃或逻辑死锁的隐患。在写任何一行代码之前，你必须修正以下 **3 个致命盲区**。

---

## 🚨 盲区一：树木存档的“身份危机” (The Identity Crisis)
**涉及文档**：`design.md` (TreeController), `tasks.md` (Task 5)

* **你的设计**：让 `TreeController` 实现 `IPersistentObject`，保存 GUID。
* **致命漏洞**：
    * **场景生成的树 vs 动态生成的树**：
        * 场景里一开始就摆好的树（Pre-placed），它们的 GUID 怎么来？通常需要一个编辑器脚本自动生成并序列化在 Inspector 里。
        * 代码生成的树（比如种下的树苗长成的树），它们的 GUID 怎么来？通常是在 `Instantiate` 时动态分配。
    * **你的文档只字未提 GUID 的生成策略**。如果你只写了 `Save/Load` 却没有处理 GUID 的初始化，场景里 100 棵树的 GUID 全是空或重复，存档系统会直接炸穿（Key Collision）。
* **🛠️ 修正指令**：
    * 在 `design.md` 中补充 `Guid` 初始化逻辑：
        * **OnValidate**: 如果 `persistentId` 为空，自动生成一个（仅限编辑器模式）。
        * **Runtime**: 如果是动态生成的，由 `Sapling`（树苗）传递 GUID 或者在 `Start` 时生成。
    * 在 `tasks.md` 中增加子任务：**编写编辑器工具或 OnValidate 逻辑，为场景中现有的所有 Tree 预生成 GUID。**

---

## 🚨 盲区二：Custom Editor 的“排他性”陷阱 (The Editor Trap)
**涉及文档**：`tasks.md` (Task 2)

* **你的设计**：`[CustomEditor(typeof(ItemData), true)]` 支持子类。
* **致命漏洞**：
    * 如果 `EquipmentData` 等子类将来需要**自己独特的 Inspector 逻辑**（比如绘制纸娃娃预览），你的 `ItemDataEditor` 会因为继承关系强制覆盖掉子类的编辑器，导致子类无法扩展。
* **🛠️ 修正指令**：
    * 虽然目前问题不大，但为了架构的稳健性，请在 `design.md` 中明确：Editor 脚本应检查 `target.GetType()`。如果确实是子类，应保留 `DrawDefaultInspector()` 的余地，或者确保你的绘制逻辑足够通用，不会把子类特有的字段（那些没在 ItemData 里定义的）给吞了。
    * **更简单的修正**：在 `ItemDataEditor` 的 `OnInspectorGUI` 最后，调用 `serializedObject.ApplyModifiedProperties()` 之前，遍历并绘制所有**未被手动处理的属性**（Iterator pattern），防止子类新增字段在面板上消失。

---

## 🚨 盲区三：农田距离检测的“高度差” (The 2.5D Problem)
**涉及文档**：`design.md` (GameInputManager)

* **你的代码示例**：
    ```csharp
    float distance = Vector2.Distance(playerCenter, cellCenter);
    ```
* **致命漏洞**：
    * 我们的游戏是 **2D Top-Down (伪3D)**。
    * `Vector2.Distance` 用的是 `x` 和 `y`。在 2D 游戏中，`y` 轴通常代表**高度**（或垂直位置）。
    * 如果玩家站在树上方（视觉上），Y 坐标很大，实际上逻辑位置可能很近。或者相反。
    * **更严重的是**：`tilemaps.GetCellCenterWorld` 返回的是 `Vector3`。直接转 `Vector2` 会丢弃 Z 轴（如果你们用 Z 做深度排序）。
* **🛠️ 修正指令**：
    * **确认坐标系**：请在 `design.md` 中明确，距离计算是否忽略 Z 轴？如果是纯 2D (XY平面)，目前的逻辑尚可。
    * **判定点修正**：玩家的 `playerCenter` 必须是**“脚底”**（Pivot通常在脚底），而不是图片中心。如果用图片中心算距离，那种很高大的树或人物，判定会非常奇怪。请明确使用 `transform.position` (通常是脚底) 还是 `Collider.bounds.center`。

---

## ✅ 最终执行授权 (Authorization)

除了上述 3 点，其余内容（数据净化流程、Tool 排除、UI 刷新）设计得非常扎实，验收标准也很清晰。

**Action:**
1.  **微调文档**：不需要大改，将上述 3 点修正补充进 `design.md` 和 `tasks.md` 的备注中即可。
2.  **立即开工**：修正完文档思维后，直接进入代码阶段。

**Execute Phase 3.5.**