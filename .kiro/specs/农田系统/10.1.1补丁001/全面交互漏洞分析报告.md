# å…¨é¢äº¤äº’æ¼æ´åˆ†ææŠ¥å‘Š

> åˆ›å»ºæ—¶é—´ï¼š2026-02-18 ä¼šè¯3ç»­21
> åŸºäºä»£ç äº‹å®çš„å…¨é¢åˆ†æï¼Œè¦†ç›–æ‰€æœ‰äº¤äº’åœºæ™¯çš„æ¼æ´æ’æŸ¥

---

## ä¸€ã€å½“å‰æ¶æ„æ¦‚è¿°

### 1.1 å…³é”®è°ƒç”¨é“¾

```
ç”¨æˆ·ç‚¹å‡» â†’ HandleUseCurrentTool()
  â”œâ”€ _isExecutingFarming é˜»æ–­ â†’ CacheFarmInput() â†’ return
  â”œâ”€ IsPerformingAction() é˜»æ–­ â†’ CacheFarmInput() â†’ return
  â”œâ”€ å¯¼èˆªä¸­é‡æ–°ç‚¹å‡» â†’ CancelFarmingNavigation() â†’ ç»§ç»­å¾€ä¸‹
  â””â”€ æ­£å¸¸æ‰§è¡Œ â†’ TryTillSoil/TryWaterTile/TryPlantSeed
       â”œâ”€ è¿‘è·ç¦»ï¼šLockPosition â†’ RequestAction â†’ Execute â†’ UnlockPosition
       â””â”€ è¿œè·ç¦»ï¼šLockPosition â†’ StartFarmingNavigation â†’ åç¨‹ç­‰å¾… â†’ åˆ°è¾¾åæ‰§è¡Œ

åŠ¨ç”»ç»“æŸ â†’ OnActionComplete()
  â”œâ”€ é•¿æŒ‰ç»§ç»­ï¼šStartAction(é‡æ’­åŠ¨ç”») â†’ æœ‰ç¼“å­˜? ConsumePendingFarmInput : ProcessFarmInputAt(é¼ æ ‡ä½ç½®)
  â””â”€ æ¾å¼€ï¼šConsumePendingFarmInput() â†’ è§£é”/æ¸…ç†

ç¼“å­˜æ¶ˆè´¹ â†’ ConsumePendingFarmInput()
  â†’ ProcessFarmInputAt(_pendingFarmWorldPos)
    â†’ ForceUpdatePreviewToPosition(worldPos) â†’ TryHandleFarmingTool/TryPlantSeed
```

### 1.2 é¢„è§ˆæ›´æ–°é“¾

```
æ¯å¸§ Update â†’ UpdatePreviews()
  â†’ UpdateFarmToolPreview(é¼ æ ‡å¯¹é½ä½ç½®, isHoe)
    â†’ FarmToolPreview.UpdateHoePreview(layerIndex, cellPos, ...)
      â”œâ”€ è®¡ç®— isValidï¼ˆéšœç¢ç‰©+CanTillï¼‰
      â”œâ”€ UpdateRealtimeData()  â† æ— æ¡ä»¶æ›´æ–°ï¼ˆå³ä½¿é”å®šï¼‰
      â”œâ”€ if (_isLocked) return;  â† é”å®šæ—¶è·³è¿‡è§†è§‰æ›´æ–°
      â”œâ”€ ClearGhostTilemap()
      â”œâ”€ GetPreviewTiles() â†’ ghostTilemap.SetTile()  â† 1+8 é¢„è§ˆ
      â””â”€ UpdateCursor()  â† å…‰æ ‡ä½ç½®+é¢œè‰²
```

---

## äºŒã€é—®é¢˜é€ä¸€æ·±åº¦åˆ†æ

### é—®é¢˜ 1ï¼šç¼“å­˜æœŸé—´é¢„è§ˆä¸é”å®š

**ç°è±¡**ï¼šåŠ¨ç”»æ’­æ”¾æœŸé—´ç‚¹å‡»æ–°ä½ç½®ï¼Œé¢„è§ˆæ¡†ä»è·Ÿéšé¼ æ ‡ç§»åŠ¨ï¼Œæ²¡æœ‰é”å®šåˆ°ç‚¹å‡»ä½ç½®ã€‚

**æ ¹å› **ï¼š`CacheFarmInput()` åªç¼“å­˜äº† `_pendingFarmWorldPos` å’Œ `_pendingFarmItemId`ï¼Œ**æ²¡æœ‰è°ƒç”¨ `LockPosition()`**ã€‚

```csharp
// CacheFarmInput (L2087) â€” å½“å‰å®ç°
private void CacheFarmInput(int itemId)
{
    _hasPendingFarmInput = true;
    _pendingFarmWorldPos = GetMouseWorldPosition();  // âœ… ç¼“å­˜ä½ç½®
    _pendingFarmItemId = itemId;
    // âŒ ç¼ºå°‘ LockPosition è°ƒç”¨
}
```

**åæœ**ï¼š
- åŠ¨ç”»æœŸé—´é¢„è§ˆæ¡†è·Ÿéšé¼ æ ‡ï¼Œç”¨æˆ·æ— æ³•ç¡®è®¤ç¼“å­˜çš„ç›®æ ‡ä½ç½®
- è§†è§‰åé¦ˆä¸å®é™…è¡Œä¸ºä¸ä¸€è‡´ï¼ˆé¢„è§ˆæ˜¾ç¤º A ä½ç½®ï¼Œä½†ç¼“å­˜çš„æ˜¯ B ä½ç½®ï¼‰

**æ–¹æ¡ˆ A å®¡è§†ï¼šCacheFarmInput ä¸­è°ƒç”¨ LockPosition**

```
CacheFarmInput â†’ GetMouseWorldPosition â†’ å¯¹é½æ ¼å­ â†’ è®¡ç®— layerIndex/cellPos â†’ LockPosition
```

#### ğŸ”´ æ¼æ´ A-1ï¼š1+8 é¢„è§ˆåŠ è½½æ—¶åºé—®é¢˜ï¼ˆç”¨æˆ·é‡ç‚¹å…³æ³¨ï¼‰

**é—®é¢˜æœ¬è´¨**ï¼š`LockPosition` åªåˆ·æ–°å…‰æ ‡ï¼ˆ`UpdateCursor`ï¼‰ï¼Œä¸åˆ·æ–° 1+8 GhostTilemap é¢„è§ˆã€‚

**æ—¶åºåˆ†æ**ï¼š

```
å¸§ Nï¼šç”¨æˆ·ç‚¹å‡»ï¼ˆåŠ¨ç”»ä¸­ï¼‰
  â†’ HandleUseCurrentTool â†’ _isExecutingFarming é˜»æ–­
  â†’ CacheFarmInput()
    â†’ å¦‚æœåœ¨æ­¤è°ƒç”¨ LockPosition(targetPos, cellPos, layerIndex)
      â†’ _isLocked = true
      â†’ UpdateCursor(layerIndex, cellPos)  â† å…‰æ ‡ç«‹å³ç§»åˆ°æ–°ä½ç½® âœ…
      â†’ ä½† 1+8 GhostTilemap æ²¡æœ‰æ›´æ–° âŒ

å¸§ N+1ï¼šUpdatePreviews â†’ UpdateFarmToolPreview â†’ UpdateHoePreview
  â†’ UpdateRealtimeData()  â† æ›´æ–°å®æ—¶æ•°æ®åˆ°é¼ æ ‡ä½ç½®
  â†’ if (_isLocked) return;  â† è·³è¿‡ï¼1+8 é¢„è§ˆä¸ä¼šæ›´æ–°åˆ°é”å®šä½ç½®
```

**ç»“æœ**ï¼šå…‰æ ‡ç§»åˆ°äº†æ–°ä½ç½®ï¼ˆæ­£ç¡®ï¼‰ï¼Œä½† 1+8 GhostTilemap ä»ç„¶æ˜¾ç¤ºæ—§ä½ç½®çš„é¢„è§ˆï¼ˆé”™è¯¯ï¼‰ã€‚

**æ ¹æœ¬åŸå› **ï¼š`UpdateHoePreview` ä¸­ 1+8 é¢„è§ˆï¼ˆ`GetPreviewTiles` + `ghostTilemap.SetTile`ï¼‰åœ¨ `if (_isLocked) return` **ä¹‹å**ï¼Œé”å®šçŠ¶æ€ä¸‹æ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚

**è§£å†³æ€è·¯**ï¼š`CacheFarmInput` ä¸­è°ƒç”¨ `LockPosition` ä¹‹å‰ï¼Œå…ˆè°ƒç”¨ä¸€æ¬¡ `ForceUpdatePreviewToPosition` å¼ºåˆ¶åˆ·æ–°é¢„è§ˆåˆ°ç¼“å­˜ä½ç½®ã€‚

```
CacheFarmInput ä¿®æ­£æµç¨‹ï¼š
1. worldPos = GetMouseWorldPosition()
2. ForceUpdatePreviewToPosition(worldPos, itemData)  â† å…ˆåˆ·æ–°å®Œæ•´é¢„è§ˆï¼ˆå« 1+8ï¼‰
3. LockPosition(targetPos, cellPos, layerIndex)       â† å†é”å®šï¼ˆæ­¤å 1+8 ä¸å†æ›´æ–°ï¼‰
```

**å…³é”®éªŒè¯**ï¼š`ForceUpdatePreviewToPosition` å†…éƒ¨è°ƒç”¨ `UpdateHoePreview`ï¼Œæ­¤æ—¶ `_isLocked` è¿˜æ˜¯ `false`ï¼Œæ‰€ä»¥ 1+8 é¢„è§ˆä¼šæ­£å¸¸æ¸²æŸ“ã€‚ç„¶å `LockPosition` è®¾ç½® `_isLocked = true`ï¼Œåç»­å¸§çš„ `UpdateHoePreview` å°±ä¼šåœ¨ `if (_isLocked) return` å¤„è·³è¿‡ï¼Œä¿æŒé”å®šçš„è§†è§‰ã€‚

**æ—¶åºéªŒè¯ï¼ˆä¿®æ­£åï¼‰**ï¼š
```
å¸§ Nï¼šCacheFarmInput
  â†’ ForceUpdatePreviewToPosition(ç¼“å­˜ä½ç½®)
    â†’ UpdateHoePreview(_isLocked=false)
      â†’ UpdateRealtimeData âœ…
      â†’ ClearGhostTilemap âœ…
      â†’ GetPreviewTiles â†’ SetTile âœ…ï¼ˆ1+8 é¢„è§ˆæ¸²æŸ“åˆ°ç¼“å­˜ä½ç½®ï¼‰
      â†’ UpdateCursor âœ…ï¼ˆå…‰æ ‡ç§»åˆ°ç¼“å­˜ä½ç½®ï¼‰
  â†’ LockPosition â†’ _isLocked = true â†’ UpdateCursorï¼ˆå†æ¬¡ç¡®è®¤å…‰æ ‡ä½ç½®ï¼‰

å¸§ N+1ï¼šUpdatePreviews â†’ UpdateHoePreview
  â†’ UpdateRealtimeDataï¼ˆæ›´æ–°å®æ—¶æ•°æ®åˆ°é¼ æ ‡ä½ç½®ï¼‰
  â†’ if (_isLocked) return;  â† è·³è¿‡è§†è§‰æ›´æ–°ï¼Œ1+8 ä¿æŒåœ¨ç¼“å­˜ä½ç½® âœ…
```


#### ğŸ”´ æ¼æ´ A-2ï¼šè¿ç»­ç‚¹å‡»è¦†ç›–ç¼“å­˜æ—¶çš„é¢„è§ˆæ›´æ–°

**åœºæ™¯**ï¼šåŠ¨ç”»æœŸé—´è¿ç»­ç‚¹å‡» A â†’ B â†’ C ä¸‰ä¸ªä½ç½®ã€‚

**å½“å‰è¡Œä¸º**ï¼šæ¯æ¬¡ `CacheFarmInput` éƒ½ä¼šè¦†ç›– `_pendingFarmWorldPos`ï¼Œæœ€ç»ˆåªä¿ç•™ C çš„ä½ç½®ã€‚

**ä¿®æ­£åè¡Œä¸º**ï¼šæ¯æ¬¡ `CacheFarmInput` éƒ½ä¼šï¼š
1. `ForceUpdatePreviewToPosition(C)` â€” åˆ·æ–° 1+8 é¢„è§ˆåˆ° C
2. `LockPosition(C)` â€” é”å®šåˆ° C

**éªŒè¯**ï¼š`LockPosition` å†…éƒ¨ä¼šè¦†ç›– `_lockedWorldPosition/_lockedCellPos/_lockedLayerIndex`ï¼Œæ‰€ä»¥è¿ç»­è°ƒç”¨æ˜¯å®‰å…¨çš„ã€‚`ForceUpdatePreviewToPosition` å†…éƒ¨è°ƒç”¨ `UpdateHoePreview`ï¼Œåœ¨ `_isLocked=true` æ—¶ä¼šè¢« `if (_isLocked) return` è·³è¿‡ã€‚

**ğŸ”´ é—®é¢˜**ï¼šç¬¬äºŒæ¬¡åŠä¹‹åçš„ `CacheFarmInput` è°ƒç”¨æ—¶ï¼Œ`_isLocked` å·²ç»æ˜¯ `true`ï¼ˆç¬¬ä¸€æ¬¡è°ƒç”¨è®¾ç½®çš„ï¼‰ï¼Œæ‰€ä»¥ `ForceUpdatePreviewToPosition` â†’ `UpdateHoePreview` ä¼šåœ¨ `if (_isLocked) return` å¤„è·³è¿‡ï¼Œ1+8 é¢„è§ˆä¸ä¼šæ›´æ–°åˆ°æ–°ä½ç½®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š`CacheFarmInput` ä¸­å…ˆ `UnlockPosition()`ï¼Œå† `ForceUpdatePreviewToPosition`ï¼Œå† `LockPosition`ã€‚

```
CacheFarmInput æœ€ç»ˆä¿®æ­£æµç¨‹ï¼š
1. worldPos = GetMouseWorldPosition()
2. UnlockPosition()                              â† å…ˆè§£é”ï¼ˆè®© ForceUpdate èƒ½æ­£å¸¸æ¸²æŸ“ï¼‰
3. ForceUpdatePreviewToPosition(worldPos, itemData)  â† åˆ·æ–°å®Œæ•´é¢„è§ˆï¼ˆå« 1+8ï¼‰
4. LockPosition(targetPos, cellPos, layerIndex)       â† å†é”å®š
5. ç¼“å­˜ _pendingFarmWorldPos / _pendingFarmItemId
```

#### ğŸŸ¡ æ¼æ´ A-3ï¼šCacheFarmInput éœ€è¦è·å– ItemData æ¥è°ƒç”¨ ForceUpdatePreviewToPosition

**é—®é¢˜**ï¼šå½“å‰ `CacheFarmInput(int itemId)` åªæ¥æ”¶ `itemId`ï¼Œä½† `ForceUpdatePreviewToPosition` éœ€è¦ `ItemData` å¯¹è±¡æ¥åˆ¤æ–­å·¥å…·ç±»å‹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ `CacheFarmInput` å†…éƒ¨é€šè¿‡ `database.GetItemByID(itemId)` è·å– `ItemData`ï¼Œæˆ–è€…ä¿®æ”¹ç­¾åä¼ å…¥ `ItemData`ã€‚æ¨èå†…éƒ¨è·å–ï¼Œä¿æŒè°ƒç”¨ç‚¹ç®€æ´ã€‚

#### ğŸŸ¡ æ¼æ´ A-4ï¼šCacheFarmInput éœ€è¦è®¡ç®— layerIndex å’Œ cellPos

**é—®é¢˜**ï¼š`LockPosition` éœ€è¦ `worldPos`ã€`cellPos`ã€`layerIndex` ä¸‰ä¸ªå‚æ•°ã€‚`CacheFarmInput` å½“å‰åªæœ‰ `worldPos`ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ `CacheFarmInput` å†…éƒ¨è®¡ç®—ï¼Œä¸ `ForceUpdatePreviewToPosition` ç±»ä¼¼çš„é€»è¾‘ï¼š
```
alignedPos = PlacementGridCalculator.GetCellCenter(worldPos)
layerIndex = farmTileManager.GetCurrentLayerIndex(alignedPos)
cellPos = tilemaps.WorldToCell(alignedPos)
```

---

### é—®é¢˜ 2ï¼šé•¿æŒ‰é”„å¤´åŸåœ°é‡å¤è€•åœ°

**ç°è±¡**ï¼šé•¿æŒ‰å·¦é”®ä½¿ç”¨é”„å¤´æ—¶ï¼ŒåŠ¨ç”»ç»“æŸååŸåœ°é‡å¤æ’­æ”¾é”„åœ°åŠ¨ç”»ï¼Œä¸ä¼šå¯¼èˆªåˆ°é¼ æ ‡æŒ‡å‘çš„æ–°ä½ç½®ã€‚

**æ ¹å› åˆ†æ**ï¼š

```csharp
// OnActionComplete() é•¿æŒ‰åˆ†æ”¯
if (shouldContinue)  // shouldContinue = isCurrentlyHolding && IsToolAction(currentAction)
{
    StartAction(actionToRepeat, true);  // â† å…ˆæ’­æ”¾åŠ¨ç”»
    
    if (gimContinue.HasPendingFarmInput)
        gimContinue.ConsumePendingFarmInput();  // â† æœ‰ç¼“å­˜ï¼šæ¶ˆè´¹ç¼“å­˜
    else if (isCurrentlyHolding)
        gimContinue.ProcessFarmInputAt(currentMouseWorldPos);  // â† æ— ç¼“å­˜ï¼šç”¨å½“å‰é¼ æ ‡ä½ç½®
}
```

**é—®é¢˜é“¾**ï¼š
1. `IsToolAction` åŒ…å« `Crush`ï¼ˆé”„å¤´ï¼‰ï¼Œæ‰€ä»¥é•¿æŒ‰é”„å¤´ä¼šè§¦å‘ `shouldContinue = true`
2. `StartAction(Crush, true)` å…ˆæ’­æ”¾åŠ¨ç”» â†’ `isPerformingAction = true`
3. ç„¶å `ProcessFarmInputAt(é¼ æ ‡ä½ç½®)` â†’ `ForceUpdatePreviewToPosition` â†’ `TryHandleFarmingTool` â†’ `TryTillSoil`
4. `TryTillSoil` å†…éƒ¨ï¼šå¦‚æœé¼ æ ‡ä½ç½®æ˜¯è¿œè·ç¦»ï¼Œä¼šè°ƒç”¨ `StartFarmingNavigation`
5. **ä½†æ­¤æ—¶ `isPerformingAction = true`**ï¼ˆåˆšåˆš `StartAction` è®¾ç½®çš„ï¼‰ï¼ŒåŠ¨ç”»æ­£åœ¨æ’­æ”¾
6. å¯¼èˆªåç¨‹ `WaitForNavigationComplete` åœ¨ç­‰å¾…åˆ°è¾¾ï¼Œä½†ç©å®¶è¢«åŠ¨ç”»é”å®šæ— æ³•ç§»åŠ¨

**æ›´æ·±å±‚é—®é¢˜**ï¼šå³ä½¿è¿‘è·ç¦»ï¼Œ`TryTillSoil` ä¼šè®¾ç½® `_isExecutingFarming = true`ï¼Œä½† `StartAction` å·²ç»è®¾ç½®äº† `isPerformingAction = true`ï¼Œä¸¤ä¸ªé”åŒæ—¶å­˜åœ¨ã€‚

**æ–¹æ¡ˆ B å®¡è§†ï¼šCrush åŠ¨ä½œä¸è§¦å‘é•¿æŒ‰ç»§ç»­**

```csharp
// IsToolAction ä¿®æ”¹
private bool IsToolAction(PlayerAnimController.AnimState action)
{
    return action == PlayerAnimController.AnimState.Slice ||
           // action == PlayerAnimController.AnimState.Crush ||  â† ç§»é™¤
           action == PlayerAnimController.AnimState.Pierce ||
           action == PlayerAnimController.AnimState.Watering;
}
```

#### ï¿½ æ¼æ´ B-1ï¼šCrush ä¸åªæ˜¯é”„å¤´â€”â€”é•å­ä¹Ÿç”¨ Crush ä¸”éœ€è¦é•¿æŒ‰è¿ç»­

**ä»£ç äº‹å®**ï¼ˆ`ResolveAction` L1118ï¼‰ï¼š
```
Pickaxeï¼ˆé•å­ï¼‰â†’ Crush   â† éœ€è¦é•¿æŒ‰è¿ç»­æŒ–çŸ¿ï¼
Hoeï¼ˆé”„å¤´ï¼‰â†’ Crush       â† ä¸éœ€è¦é•¿æŒ‰ï¼ˆè€•åœ°æ˜¯ä¸€æ¬¡æ€§æ“ä½œï¼‰
```

**é—®é¢˜**ï¼šå¦‚æœä» `IsToolAction` ç§»é™¤ `Crush`ï¼Œé•å­ä¹Ÿæ— æ³•é•¿æŒ‰è¿ç»­æŒ–çŸ¿äº†ã€‚è¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚

**ä½† `HandleUseCurrentTool` ä¸­ï¼ŒHoe å’Œ WateringCan èµ°å†œç”°ä¸“ç”¨è·¯å¾„ï¼ˆ`TryHandleFarmingTool`ï¼‰ï¼Œé•å­èµ° `ResolveAction` â†’ `RequestAction` é€šç”¨è·¯å¾„ã€‚**

**å…³é”®åŒºåˆ«**ï¼š`OnActionComplete` çš„é•¿æŒ‰åˆ†æ”¯ä¸­ï¼Œ`shouldContinue` åªçœ‹ `IsToolAction(currentAction)`ï¼Œä¸åŒºåˆ†æ˜¯å“ªä¸ªå·¥å…·è§¦å‘çš„ `Crush`ã€‚æ‰€ä»¥ï¼š
- é•å­ Crush é•¿æŒ‰ â†’ `shouldContinue = true` â†’ `StartAction(Crush, true)` â†’ é€šç”¨å·¥å…·é‡æ’­åŠ¨ç”» âœ… æ­£ç¡®
- é”„å¤´ Crush é•¿æŒ‰ â†’ `shouldContinue = true` â†’ `StartAction(Crush, true)` â†’ ç„¶åæ‰§è¡Œå†œç”°æ“ä½œ âŒ é”™è¯¯

**æ–¹æ¡ˆ B ä¿®æ­£ï¼šä¸ä¿®æ”¹ IsToolActionï¼Œè€Œæ˜¯åœ¨é•¿æŒ‰åˆ†æ”¯ä¸­åŒºåˆ†å†œç”°å·¥å…·å’Œé€šç”¨å·¥å…·**

åœ¨ `OnActionComplete` çš„é•¿æŒ‰åˆ†æ”¯ä¸­ï¼Œæ£€æŸ¥å½“å‰æ‰‹æŒç‰©å“æ˜¯å¦æ˜¯å†œç”°å·¥å…·ï¼ˆHoe/WateringCan/Seedï¼‰ï¼š
- å¦‚æœæ˜¯å†œç”°å·¥å…· â†’ ä¸å…ˆ `StartAction`ï¼Œç›´æ¥æ¶ˆè´¹ç¼“å­˜æˆ–æ‰§è¡Œæ“ä½œ
- å¦‚æœæ˜¯é€šç”¨å·¥å…·ï¼ˆé•å­/æ–§å¤´ç­‰ï¼‰â†’ ä¿æŒåŸæœ‰è¡Œä¸ºï¼ˆ`StartAction` é‡æ’­åŠ¨ç”»ï¼‰

```
é•¿æŒ‰åˆ†æ”¯ä¿®æ­£é€»è¾‘ï¼š
if (shouldContinue)
{
    bool isFarmTool = å½“å‰æ‰‹æŒæ˜¯ Hoe/WateringCan/Seed;
    
    if (isFarmTool)
    {
        // å†œç”°å·¥å…·ï¼šä¸å…ˆæ’­åŠ¨ç”»ï¼Œè®© TryXxx å†…éƒ¨å¤„ç†
        isPerformingAction = false;  // è§£é”
        if (æœ‰ç¼“å­˜) ConsumePendingFarmInput();
        else ProcessFarmInputAt(é¼ æ ‡ä½ç½®);
    }
    else
    {
        // é€šç”¨å·¥å…·ï¼šä¿æŒåŸæœ‰è¡Œä¸º
        StartAction(actionToRepeat, true);
    }
}
```

#### ğŸŸ¡ æ¼æ´ B-2ï¼šå†œç”°å·¥å…·é•¿æŒ‰åˆ†æ”¯ä¸å…ˆ StartAction çš„è¡Œä¸º

**åœºæ™¯**ï¼šç”¨æˆ·é•¿æŒ‰é”„å¤´/æµ‡æ°´å£¶ï¼ŒåŠ¨ç”»ç»“æŸåèµ°å†œç”°å·¥å…·åˆ†æ”¯ã€‚

**è¡Œä¸º**ï¼š`isPerformingAction = false` â†’ æ¶ˆè´¹ç¼“å­˜æˆ–ç”¨é¼ æ ‡ä½ç½®æ‰§è¡Œ â†’ `TryTillSoil`/`TryWaterTile` å†…éƒ¨è‡ªå·±è°ƒç”¨ `RequestAction` æ’­æ”¾åŠ¨ç”»ã€‚

**éªŒè¯**ï¼š
- è¿‘è·ç¦»ï¼š`TryTillSoil` â†’ `RequestAction(Crush)` â†’ æ’­æ”¾åŠ¨ç”» â†’ `ExecuteTillSoil` â†’ æ­£ç¡® âœ…
- è¿œè·ç¦»ï¼š`TryTillSoil` â†’ `StartFarmingNavigation` â†’ å¯¼èˆª â†’ åˆ°è¾¾å `RequestAction(Crush)` â†’ æ­£ç¡® âœ…
- æ— ç¼“å­˜+é¼ æ ‡ä½ç½®æ— æ•ˆï¼š`TryTillSoil` â†’ `!farmPreview.IsValid()` â†’ return false â†’ ä»€ä¹ˆéƒ½ä¸åš â†’ æ­£ç¡® âœ…

**ç»“è®º**ï¼šå†œç”°å·¥å…·ä¸å…ˆ `StartAction` æ˜¯å®‰å…¨çš„ï¼Œ`TryXxx` å†…éƒ¨ä¼šå¤„ç†åŠ¨ç”»ã€‚

---

### é—®é¢˜ 3ï¼šUpdateRealtimeData åœ¨é”å®šçŠ¶æ€ä¸‹ä»æ›´æ–°å®æ—¶æ•°æ®

**ç°è±¡**ï¼šé”å®šé¢„è§ˆåï¼Œ`CurrentCellPos`/`CurrentCursorPos`/`IsInRange` ä»ç„¶è·Ÿéšé¼ æ ‡æ›´æ–°ã€‚

**æ ¹å› **ï¼š

```csharp
// UpdateHoePreview (L329)
UpdateRealtimeData(layerIndex, cellPos, cellCenter, playerTransform, reach);  // â† æ— æ¡ä»¶æ›´æ–°
if (_isLocked) return;  // â† ä¹‹åæ‰æ£€æŸ¥é”å®š
```

`UpdateRealtimeData` åœ¨ `if (_isLocked) return` **ä¹‹å‰**è°ƒç”¨ï¼Œæ‰€ä»¥é”å®šçŠ¶æ€ä¸‹å®æ—¶æ•°æ®ä»ç„¶è¢«é¼ æ ‡ä½ç½®è¦†ç›–ã€‚

**å½±å“åˆ†æ**ï¼š

| æ¶ˆè´¹è€… | è¯»å–çš„å­—æ®µ | å½±å“ |
|--------|-----------|------|
| `TryTillSoil` | `CurrentCursorPos`/`CurrentCellPos`/`CurrentLayerIndex`/`IsInRange` | ğŸ”´ ä¸¥é‡ï¼šè¯»å–çš„æ˜¯é¼ æ ‡ä½ç½®è€Œéé”å®šä½ç½® |
| `TryWaterTile` | åŒä¸Š | ğŸ”´ ä¸¥é‡ï¼šåŒä¸Š |
| `TryPlantSeed` | `CurrentCursorPos`/`CurrentCellPos`/`CurrentLayerIndex`/`IsInRange` | ğŸ”´ ä¸¥é‡ï¼šåŒä¸Š |
| `HandleUseCurrentTool` å¯¼èˆªä¸­é‡æ–°ç‚¹å‡» | `CurrentCellPos` vs `LockedCellPos` | ğŸŸ¡ ä¸­ç­‰ï¼šE-10 åŒä½ç½®æ£€æŸ¥å¯èƒ½è¯¯åˆ¤ |


**ä½†å®é™…ä¸Šè¿™ä¸ªé—®é¢˜åœ¨å½“å‰æµç¨‹ä¸­è¢« `ForceUpdatePreviewToPosition` ç¼“è§£äº†**ï¼š

`ConsumePendingFarmInput` â†’ `ProcessFarmInputAt(_pendingFarmWorldPos)` â†’ `ForceUpdatePreviewToPosition(worldPos, itemData)` â†’ `UpdateHoePreview(layerIndex, cellPos, ...)`

`ForceUpdatePreviewToPosition` ä¼šç”¨ç¼“å­˜çš„ä½ç½®è°ƒç”¨ `UpdateHoePreview`ï¼Œè¿™ä¼šæ›´æ–° `CurrentCellPos` ç­‰å®æ—¶æ•°æ®åˆ°ç¼“å­˜ä½ç½®ã€‚ç„¶å `TryTillSoil` è¯»å–çš„å°±æ˜¯æ­£ç¡®çš„ä½ç½®ã€‚

**ä½†æœ‰ä¸€ä¸ªæ—¶åºæ¼æ´**ï¼š`ForceUpdatePreviewToPosition` è°ƒç”¨ `UpdateHoePreview` æ—¶ï¼Œå¦‚æœ `_isLocked = true`ï¼Œ`UpdateRealtimeData` ä¼šè¢«è°ƒç”¨ï¼ˆæ›´æ–°åˆ°ç¼“å­˜ä½ç½®ï¼‰ï¼Œä½†åé¢çš„ `if (_isLocked) return` ä¼šè·³è¿‡è§†è§‰æ›´æ–°ã€‚

**ç»“è®º**ï¼šå®æ—¶æ•°æ®çš„æ›´æ–°é—®é¢˜åœ¨ `ProcessFarmInputAt` è·¯å¾„ä¸­è¢« `ForceUpdatePreviewToPosition` æ­£ç¡®å¤„ç†äº†ã€‚ä½†åœ¨ `TryTillSoil`/`TryWaterTile` çš„**é¦–æ¬¡è°ƒç”¨**ï¼ˆéç¼“å­˜è·¯å¾„ï¼‰ä¸­ï¼Œè¯»å–çš„æ˜¯ `UpdatePreviews` æ¯å¸§æ›´æ–°çš„å®æ—¶æ•°æ®ï¼Œè¿™æ˜¯æ­£ç¡®çš„ï¼ˆå› ä¸ºé¦–æ¬¡è°ƒç”¨æ—¶é¢„è§ˆæ²¡æœ‰è¢«é”å®šï¼Œå®æ—¶æ•°æ®å°±æ˜¯é¼ æ ‡ä½ç½®ï¼‰ã€‚

**æ–¹æ¡ˆ C-è¡¥å……ï¼šæ˜¯å¦éœ€è¦ä¿®æ”¹ UpdateRealtimeData çš„è¡Œä¸ºï¼Ÿ**

ä¸éœ€è¦ã€‚å½“å‰è¡Œä¸ºæ˜¯åˆç†çš„ï¼š
- é”å®šçŠ¶æ€ä¸‹ï¼Œå®æ—¶æ•°æ®è¢«é¼ æ ‡ä½ç½®è¦†ç›–ï¼Œä½†æ²¡æœ‰æ¶ˆè´¹è€…åœ¨é”å®šæœŸé—´è¯»å–å®æ—¶æ•°æ®æ¥åšå†³ç­–
- `TryTillSoil` ç­‰æ–¹æ³•åœ¨è°ƒç”¨å‰å·²ç»é€šè¿‡ `ForceUpdatePreviewToPosition` æˆ–ç›´æ¥ä» `UpdatePreviews` è·å–äº†æ­£ç¡®çš„ä½ç½®
- `HandleUseCurrentTool` å¯¼èˆªä¸­é‡æ–°ç‚¹å‡»çš„ E-10 æ£€æŸ¥ä½¿ç”¨ `CurrentCellPos == LockedCellPos`ï¼Œè¿™é‡Œ `CurrentCellPos` æ˜¯é¼ æ ‡ä½ç½®ï¼Œ`LockedCellPos` æ˜¯é”å®šä½ç½®ï¼Œæ¯”è¾ƒçš„æ˜¯"é¼ æ ‡æ˜¯å¦æŒ‡å‘é”å®šä½ç½®"ï¼Œè¯­ä¹‰æ­£ç¡®

---

### é—®é¢˜ 4ï¼šæµ‡æ°´é•¿æŒ‰ç»§ç»­çš„è¡Œä¸º

**ç°è±¡**ï¼šé•¿æŒ‰æµ‡æ°´æ—¶ï¼ŒåŠ¨ç”»ç»“æŸååº”è¯¥ç»§ç»­æµ‡æ°´ä¸‹ä¸€ä¸ªæ ¼å­ã€‚

**å½“å‰è¡Œä¸º**ï¼š`Watering` åœ¨ `IsToolAction` ä¸­ï¼Œæ‰€ä»¥é•¿æŒ‰æµ‡æ°´ä¼šè§¦å‘ `shouldContinue = true`ã€‚

**æ–¹æ¡ˆ C å®¡è§†ï¼šæµ‡æ°´æœ‰ç¼“å­˜æ—¶èµ°æ¾å¼€åˆ†æ”¯æ¶ˆè´¹ç¼“å­˜**

**åŸå§‹æ–¹æ¡ˆ C çš„æ€è·¯**ï¼šæµ‡æ°´é•¿æŒ‰ç»§ç»­æ—¶ï¼Œå¦‚æœæœ‰ç¼“å­˜ï¼Œèµ°æ¾å¼€åˆ†æ”¯æ¶ˆè´¹ç¼“å­˜ï¼ˆå«å¯¼èˆªï¼‰ï¼›æ— ç¼“å­˜æ‰åŸåœ°ç»§ç»­ã€‚

**ğŸ”´ æ¼æ´ C-1ï¼šé•¿æŒ‰åˆ†æ”¯çš„æ‰§è¡Œé¡ºåºé—®é¢˜**

```csharp
// é•¿æŒ‰åˆ†æ”¯å½“å‰é€»è¾‘
StartAction(actionToRepeat, true);  // â† å…ˆæ’­æ”¾åŠ¨ç”»ï¼ŒisPerformingAction = true
if (gimContinue.HasPendingFarmInput)
    gimContinue.ConsumePendingFarmInput();  // â† æ¶ˆè´¹ç¼“å­˜
else if (isCurrentlyHolding)
    gimContinue.ProcessFarmInputAt(currentMouseWorldPos);  // â† ç”¨é¼ æ ‡ä½ç½®
```

**é—®é¢˜**ï¼š`StartAction` å…ˆæ’­æ”¾åŠ¨ç”»ï¼Œç„¶å `ConsumePendingFarmInput` â†’ `ProcessFarmInputAt` â†’ `TryWaterTile`ã€‚`TryWaterTile` å†…éƒ¨ä¼šè°ƒç”¨ `RequestAction(Watering)`ï¼Œä½†æ­¤æ—¶ `isPerformingAction = true`ï¼ˆ`StartAction` åˆšè®¾ç½®çš„ï¼‰ï¼Œ`PerformAction` å†…éƒ¨ç¬¬ä¸€è¡Œå°±æ˜¯ `if (isPerformingAction) return;`ï¼Œæ‰€ä»¥ `RequestAction` è¢«å¿½ç•¥ã€‚

**ç»“æœ**ï¼šåŠ¨ç”»æ’­æ”¾äº†ï¼ˆ`StartAction`ï¼‰ï¼Œä½†æµ‡æ°´æ“ä½œçš„ `RequestAction(Watering)` è¢«å¿½ç•¥ã€‚ä¸è¿‡ `ExecuteWaterTile` ä»ç„¶ä¼šæ‰§è¡Œï¼ˆåœ¨ `TryWaterTile` çš„è¿‘è·ç¦»åˆ†æ”¯ä¸­ï¼Œ`RequestAction` å’Œ `ExecuteWaterTile` æ˜¯é¡ºåºè°ƒç”¨çš„ï¼Œ`RequestAction` å¤±è´¥ä¸å½±å“ `ExecuteWaterTile`ï¼‰ã€‚

**æ›´å‡†ç¡®çš„åˆ†æ**ï¼š
- è¿‘è·ç¦»æµ‡æ°´ï¼š`StartAction(Watering)` æ’­æ”¾åŠ¨ç”» â†’ `TryWaterTile` â†’ `RequestAction(Watering)` è¢«å¿½ç•¥ï¼ˆå·²åœ¨æ’­æ”¾ï¼‰â†’ `ExecuteWaterTile` æ­£å¸¸æ‰§è¡Œ â†’ åŠŸèƒ½æ­£ç¡®ï¼Œä½†åŠ¨ç”»åªæ’­æ”¾äº†ä¸€æ¬¡ï¼ˆ`StartAction` çš„é‚£æ¬¡ï¼‰
- è¿œè·ç¦»æµ‡æ°´ï¼š`StartAction(Watering)` æ’­æ”¾åŠ¨ç”» â†’ `TryWaterTile` â†’ `StartFarmingNavigation` â†’ å¯¼èˆªå¼€å§‹ï¼Œä½†ç©å®¶è¢«åŠ¨ç”»é”å®šæ— æ³•ç§»åŠ¨ â†’ ğŸ”´ å¡æ­»

**ğŸ”´ æ¼æ´ C-2ï¼šé•¿æŒ‰æµ‡æ°´è¿œè·ç¦»åœºæ™¯å¡æ­»**

ä¸é—®é¢˜ 2ï¼ˆé”„å¤´ï¼‰å®Œå…¨ç›¸åŒçš„é—®é¢˜ï¼š`StartAction` å…ˆé”å®šç©å®¶ï¼Œç„¶å `StartFarmingNavigation` å¯åŠ¨å¯¼èˆªï¼Œä½†ç©å®¶æ— æ³•ç§»åŠ¨ã€‚

**æ–¹æ¡ˆ C ä¿®æ­£**ï¼šæµ‡æ°´ä¹Ÿåº”è¯¥åƒé”„å¤´ä¸€æ ·ï¼Œä¸åœ¨é•¿æŒ‰åˆ†æ”¯ä¸­å…ˆæ’­æ”¾åŠ¨ç”»å†æ‰§è¡Œæ“ä½œã€‚

**ç»Ÿä¸€æ–¹æ¡ˆ**ï¼šé•¿æŒ‰åˆ†æ”¯ä¸­ï¼Œä¸åº”è¯¥å…ˆ `StartAction` å†æ‰§è¡Œå†œç”°æ“ä½œã€‚åº”è¯¥ï¼š
1. æœ‰ç¼“å­˜ â†’ æ¶ˆè´¹ç¼“å­˜ï¼ˆ`ConsumePendingFarmInput`ï¼‰ï¼Œè®© `TryWaterTile` å†…éƒ¨è‡ªå·±å†³å®šæ˜¯å¦ `RequestAction`
2. æ— ç¼“å­˜ â†’ ç”¨é¼ æ ‡ä½ç½®æ‰§è¡Œï¼ˆ`ProcessFarmInputAt`ï¼‰ï¼ŒåŒä¸Š

**ä½†è¿™å¼•å‡ºæ–°é—®é¢˜**ï¼šå¦‚æœä¸å…ˆ `StartAction`ï¼Œé•¿æŒ‰ç»§ç»­æ—¶åŠ¨ç”»æ€ä¹ˆæ’­æ”¾ï¼Ÿ

**ç­”æ¡ˆ**ï¼š`TryWaterTile` å†…éƒ¨çš„è¿‘è·ç¦»åˆ†æ”¯å·²ç»è°ƒç”¨äº† `RequestAction(Watering)`ï¼Œè¿™ä¼šè§¦å‘åŠ¨ç”»æ’­æ”¾ã€‚è¿œè·ç¦»åˆ†æ”¯ä¼šå¯¼èˆªåå†æ’­æ”¾ã€‚æ‰€ä»¥ä¸éœ€è¦åœ¨ `OnActionComplete` ä¸­é¢å¤–æ’­æ”¾ã€‚

**ğŸ”´ æ¼æ´ C-3ï¼šé•¿æŒ‰åˆ†æ”¯ä¸å…ˆ StartAction çš„å½±å“**

å¦‚æœé•¿æŒ‰åˆ†æ”¯ä¸è°ƒç”¨ `StartAction`ï¼š
1. `isPerformingAction` è¢«è®¾ä¸º `false`ï¼ˆæ¾å¼€åˆ†æ”¯çš„é€»è¾‘ï¼‰
2. ä¸‹ä¸€å¸§ `HandleUseCurrentTool` ä¸­ `isPerformingAction` æ£€æŸ¥é€šè¿‡
3. å¦‚æœç”¨æˆ·ä»æŒ‰ç€å·¦é”®ï¼Œ`isFirstPress = Input.GetMouseButtonDown(0)` ä¸º `false`ï¼ˆä¸æ˜¯æ–°æŒ‰ä¸‹ï¼‰
4. æ‰€ä»¥ä¸ä¼šè§¦å‘æ–°æ“ä½œ

**ç»“è®º**ï¼šé•¿æŒ‰æµ‡æ°´çš„æ­£ç¡®è¡Œä¸ºåº”è¯¥æ˜¯ï¼š
- åŠ¨ç”»ç»“æŸ â†’ æ¶ˆè´¹ç¼“å­˜æˆ–ç”¨é¼ æ ‡ä½ç½®æ‰§è¡Œ â†’ `TryWaterTile` å†…éƒ¨å¤„ç†åŠ¨ç”»å’Œå¯¼èˆª
- ä¸éœ€è¦åœ¨ `OnActionComplete` ä¸­å…ˆæ’­æ”¾åŠ¨ç”»

---

## ä¸‰ã€å…¨é¢äº¤äº’çŸ©é˜µ

### 3.1 æ“ä½œç±»å‹ Ã— è§¦å‘æ–¹å¼ Ã— è·ç¦» Ã— çŠ¶æ€

| # | æ“ä½œ | è§¦å‘ | è·ç¦» | å½“å‰çŠ¶æ€ | é¢„æœŸè¡Œä¸º | å½“å‰è¡Œä¸º | æ¼æ´ |
|---|------|------|------|----------|----------|----------|------|
| 1 | é”„å¤´ | å•å‡» | è¿‘ | ç©ºé—² | é”å®šâ†’åŠ¨ç”»â†’è€•åœ°â†’è§£é” | âœ… æ­£ç¡® | æ—  |
| 2 | é”„å¤´ | å•å‡» | è¿œ | ç©ºé—² | é”å®šâ†’å¯¼èˆªâ†’åˆ°è¾¾â†’åŠ¨ç”»â†’è€•åœ°â†’è§£é” | âœ… æ­£ç¡® | æ—  |
| 3 | é”„å¤´ | å•å‡» | è¿‘ | åŠ¨ç”»ä¸­ | ç¼“å­˜â†’åŠ¨ç”»ç»“æŸâ†’æ¶ˆè´¹ç¼“å­˜â†’è€•åœ° | âŒ ç¼“å­˜ä½†é¢„è§ˆä¸é”å®š | A-1 |
| 4 | é”„å¤´ | å•å‡» | è¿œ | åŠ¨ç”»ä¸­ | ç¼“å­˜â†’åŠ¨ç”»ç»“æŸâ†’æ¶ˆè´¹ç¼“å­˜â†’å¯¼èˆªâ†’è€•åœ° | âŒ ç¼“å­˜ä½†é¢„è§ˆä¸é”å®š | A-1 |
| 5 | é”„å¤´ | å•å‡» | ä»»æ„ | å¯¼èˆªä¸­ | å–æ¶ˆæ—§å¯¼èˆªâ†’é‡æ–°æ‰§è¡Œ | âœ… æ­£ç¡® | æ—  |
| 6 | é”„å¤´ | é•¿æŒ‰ | è¿‘ | åŠ¨ç”»ç»“æŸ | ä¸ç»§ç»­ï¼ˆé”„å¤´æ— é•¿æŒ‰ï¼‰ | âŒ åŸåœ°é‡å¤ | B |
| 7 | é”„å¤´ | é•¿æŒ‰ | è¿œ | åŠ¨ç”»ç»“æŸ | ä¸ç»§ç»­ | âŒ å¡æ­» | B |
| 8 | é”„å¤´ | è¿ç»­ç‚¹å‡» | ä»»æ„ | åŠ¨ç”»ä¸­ | æœ€åä¸€æ¬¡ç‚¹å‡»è¦†ç›–ç¼“å­˜ | âŒ é¢„è§ˆä¸æ›´æ–° | A-2 |
| 9 | æµ‡æ°´ | å•å‡» | è¿‘ | ç©ºé—² | é”å®šâ†’åŠ¨ç”»â†’æµ‡æ°´â†’è§£é” | âœ… æ­£ç¡® | æ—  |
| 10 | æµ‡æ°´ | å•å‡» | è¿œ | ç©ºé—² | é”å®šâ†’å¯¼èˆªâ†’åˆ°è¾¾â†’åŠ¨ç”»â†’æµ‡æ°´â†’è§£é” | âœ… æ­£ç¡® | æ—  |
| 11 | æµ‡æ°´ | å•å‡» | è¿‘ | åŠ¨ç”»ä¸­ | ç¼“å­˜â†’åŠ¨ç”»ç»“æŸâ†’æ¶ˆè´¹ç¼“å­˜â†’æµ‡æ°´ | âŒ ç¼“å­˜ä½†é¢„è§ˆä¸é”å®š | A-1 |
| 12 | æµ‡æ°´ | å•å‡» | è¿œ | åŠ¨ç”»ä¸­ | ç¼“å­˜â†’åŠ¨ç”»ç»“æŸâ†’æ¶ˆè´¹ç¼“å­˜â†’å¯¼èˆªâ†’æµ‡æ°´ | âŒ ç¼“å­˜ä½†é¢„è§ˆä¸é”å®š | A-1 |
| 13 | æµ‡æ°´ | é•¿æŒ‰ | è¿‘ | åŠ¨ç”»ç»“æŸ | æœ‰ç¼“å­˜â†’æ¶ˆè´¹ï¼›æ— ç¼“å­˜â†’é¼ æ ‡ä½ç½®æµ‡æ°´ | âŒ å…ˆæ’­åŠ¨ç”»å†æ‰§è¡Œâ†’RequestActionè¢«å¿½ç•¥ | C-1 |
| 14 | æµ‡æ°´ | é•¿æŒ‰ | è¿œ | åŠ¨ç”»ç»“æŸ | æœ‰ç¼“å­˜â†’æ¶ˆè´¹â†’å¯¼èˆªï¼›æ— ç¼“å­˜â†’é¼ æ ‡ä½ç½®â†’å¯¼èˆª | âŒ å…ˆæ’­åŠ¨ç”»â†’å¯¼èˆªå¡æ­» | C-2 |

| 15 | ç§å­ | å•å‡» | è¿‘ | ç©ºé—² | é”å®šâ†’ç§æ¤â†’è§£é” | âœ… æ­£ç¡® | æ—  |
| 16 | ç§å­ | å•å‡» | è¿œ | ç©ºé—² | é”å®šâ†’å¯¼èˆªâ†’åˆ°è¾¾â†’ç§æ¤â†’è§£é” | âœ… æ­£ç¡® | æ—  |
| 17 | ç§å­ | å•å‡» | è¿‘ | åŠ¨ç”»ä¸­ | ç¼“å­˜â†’åŠ¨ç”»ç»“æŸâ†’æ¶ˆè´¹ç¼“å­˜â†’ç§æ¤ | âŒ ç¼“å­˜ä½†é¢„è§ˆä¸é”å®š | A-1 |
| 18 | ç§å­ | å•å‡» | è¿œ | åŠ¨ç”»ä¸­ | ç¼“å­˜â†’åŠ¨ç”»ç»“æŸâ†’æ¶ˆè´¹ç¼“å­˜â†’å¯¼èˆªâ†’ç§æ¤ | âŒ ç¼“å­˜ä½†é¢„è§ˆä¸é”å®š | A-1 |
| 19 | é•å­ | é•¿æŒ‰ | è¿‘ | åŠ¨ç”»ç»“æŸ | ç»§ç»­æŒ–çŸ¿ï¼ˆåŸåœ°é‡æ’­åŠ¨ç”»ï¼‰ | âœ… æ­£ç¡® | æ—  |
| 20 | æ–§å¤´ | é•¿æŒ‰ | è¿‘ | åŠ¨ç”»ç»“æŸ | ç»§ç»­ç æ ‘ï¼ˆåŸåœ°é‡æ’­åŠ¨ç”»ï¼‰ | âœ… æ­£ç¡® | æ—  |
| 21 | ä»»æ„å†œç”°å·¥å…· | å•å‡» | ä»»æ„ | æ‰§è¡Œä¸­(_isExecutingFarming) | ç¼“å­˜ | âŒ é¢„è§ˆä¸é”å®š | A-1 |
| 22 | ä»»æ„ | WASD | - | å¯¼èˆªä¸­ | å–æ¶ˆå¯¼èˆª+è§£é”é¢„è§ˆ | âš ï¸ ç¼“å­˜æœªæ¸…é™¤ | E |
| 23 | ä»»æ„ | WASD | - | åŠ¨ç”»ä¸­+æœ‰ç¼“å­˜ | æ¸…é™¤ç¼“å­˜+è§£é”é¢„è§ˆ | âŒ ç¼“å­˜æœªæ¸…é™¤ | E-æ–° |

### 3.2 å…³é”®å‘ç°

1. æ‰€æœ‰å†œç”°å·¥å…·ï¼ˆé”„å¤´/æµ‡æ°´/ç§å­ï¼‰åœ¨åŠ¨ç”»ä¸­ç¼“å­˜æ—¶éƒ½æœ‰é¢„è§ˆä¸é”å®šé—®é¢˜ï¼ˆA-1/A-2ï¼‰
2. é•¿æŒ‰åˆ†æ”¯çš„ `StartAction` å…ˆæ’­æ”¾åŠ¨ç”»å†æ‰§è¡Œæ“ä½œï¼Œå¯¹å†œç”°å·¥å…·ä¼šå¯¼è‡´è¿œè·ç¦»å¡æ­»ï¼ˆB/C-2ï¼‰
3. é•å­/æ–§å¤´ç­‰é€šç”¨å·¥å…·çš„é•¿æŒ‰è¡Œä¸ºæ˜¯æ­£ç¡®çš„ï¼Œä¸èƒ½ç ´å
4. WASD ç§»åŠ¨æ—¶åªå–æ¶ˆå¯¼èˆªå’Œè§£é”é¢„è§ˆï¼Œä½†æ²¡æœ‰æ¸…é™¤è¾“å…¥ç¼“å­˜

---

## å››ã€æ–¹æ¡ˆ D/E å®¡è§†

### æ–¹æ¡ˆ Dï¼šConsumePendingFarmInput ä¸­å…ˆ UnlockPosition

**åŸå§‹æ–¹æ¡ˆ**ï¼šåœ¨ `ConsumePendingFarmInput` ä¸­ï¼Œè°ƒç”¨ `ProcessFarmInputAt` ä¹‹å‰å…ˆ `UnlockPosition()`ã€‚

**ç›®çš„**ï¼šæ¶ˆè´¹ç¼“å­˜æ—¶ï¼Œå…ˆè§£é”é¢„è§ˆï¼Œè®© `ForceUpdatePreviewToPosition` èƒ½æ­£å¸¸æ¸²æŸ“åˆ°ç¼“å­˜ä½ç½®ï¼Œç„¶å `TryTillSoil` å†…éƒ¨ä¼šé‡æ–° `LockPosition`ã€‚

**å½“å‰ä»£ç **ï¼š
```csharp
public void ConsumePendingFarmInput()
{
    if (!_hasPendingFarmInput) return;
    _hasPendingFarmInput = false;
    int currentItemId = GetCurrentHeldItemId();
    if (currentItemId != _pendingFarmItemId) return;
    ProcessFarmInputAt(_pendingFarmWorldPos);  // â† æ²¡æœ‰å…ˆ UnlockPosition
}
```

#### ğŸŸ¡ æ¼æ´ D-1ï¼šè§£é”ååˆ° ProcessFarmInputAt ä¹‹é—´çš„ä¸€å¸§é—ªçƒ

**åœºæ™¯**ï¼š`UnlockPosition()` â†’ ä¸‹ä¸€å¸§ `UpdatePreviews` â†’ é¢„è§ˆè·³åˆ°é¼ æ ‡ä½ç½® â†’ `ProcessFarmInputAt` â†’ `ForceUpdatePreviewToPosition` â†’ é¢„è§ˆè·³åˆ°ç¼“å­˜ä½ç½® â†’ `TryTillSoil` â†’ `LockPosition`ã€‚

**åˆ†æ**ï¼š`ConsumePendingFarmInput` æ˜¯åŒæ­¥è°ƒç”¨çš„ï¼Œ`UnlockPosition` å’Œ `ProcessFarmInputAt` åœ¨åŒä¸€å¸§å†…æ‰§è¡Œã€‚ä¸­é—´ä¸ä¼šæœ‰ `UpdatePreviews` æ’å…¥ï¼ˆå› ä¸º `Update` æ˜¯å•çº¿ç¨‹çš„ï¼‰ã€‚æ‰€ä»¥ä¸ä¼šæœ‰é—ªçƒã€‚

**ç»“è®º**ï¼šæ–¹æ¡ˆ D æ˜¯å®‰å…¨çš„ã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœæ–¹æ¡ˆ A ä¿®æ­£å `CacheFarmInput` å·²ç»æ­£ç¡®å¤„ç†äº†é”å®š/è§£é”ï¼Œé‚£ä¹ˆ `ConsumePendingFarmInput` ä¸­æ˜¯å¦éœ€è¦å…ˆ `UnlockPosition` å–å†³äº `ForceUpdatePreviewToPosition` æ˜¯å¦éœ€è¦ `_isLocked = false` æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚

**éªŒè¯**ï¼š`ForceUpdatePreviewToPosition` â†’ `UpdateHoePreview` â†’ `if (_isLocked) return`ã€‚å¦‚æœ `_isLocked = true`ï¼Œ1+8 é¢„è§ˆä¸ä¼šæ›´æ–°ã€‚æ‰€ä»¥ `ConsumePendingFarmInput` ä¸­ç¡®å®éœ€è¦å…ˆ `UnlockPosition`ã€‚

**æœ€ç»ˆç»“è®º**ï¼šæ–¹æ¡ˆ D å¿…é¡»æ‰§è¡Œã€‚

### æ–¹æ¡ˆ Eï¼šWASD ç§»åŠ¨æ—¶æ¸…é™¤ç¼“å­˜ + è§£é”

**åŸå§‹æ–¹æ¡ˆ**ï¼š`HandleMovement` ä¸­ WASD ç§»åŠ¨æ—¶ï¼Œé™¤äº† `CancelFarmingNavigation()` å¤–ï¼Œè¿˜è¦æ¸…é™¤ `_hasPendingFarmInput` å’Œ `UnlockPosition`ã€‚

**å½“å‰ä»£ç **ï¼ˆ`HandleMovement` L349ï¼‰ï¼š
```csharp
// è‡ªåŠ¨å¯¼èˆªæ¿€æ´»æ—¶
if (autoNavigator.IsActive && æœ‰è¾“å…¥)
{
    autoNavigator.ForceCancel();
    CancelFarmingNavigation();  // â† ä¼š UnlockPositionï¼Œä½†ä¸æ¸…é™¤ç¼“å­˜
    playerMovement.SetMovementInput(input, shift);
}

// éè‡ªåŠ¨å¯¼èˆªä½†å†œç”°å¯¼èˆªä¸­
if (_farmNavState != Idle && æœ‰è¾“å…¥)
{
    CancelFarmingNavigation();  // â† åŒä¸Š
}
```

**`CancelFarmingNavigation` å†…éƒ¨**ï¼š
```csharp
farmPreview.UnlockPosition();  // âœ… è§£é”é¢„è§ˆ
// âŒ æ²¡æœ‰æ¸…é™¤ _hasPendingFarmInput
```

#### ğŸ”´ æ¼æ´ E-1ï¼šWASD ç§»åŠ¨ä¸æ¸…é™¤è¾“å…¥ç¼“å­˜

**åœºæ™¯**ï¼š
1. ç”¨æˆ·ç‚¹å‡»è¿œå¤„è€•åœ° â†’ å¯¼èˆªä¸­
2. å¯¼èˆªé€”ä¸­æŒ‰ WASD â†’ `CancelFarmingNavigation()` â†’ å¯¼èˆªå–æ¶ˆï¼Œé¢„è§ˆè§£é”
3. ä½† `_hasPendingFarmInput` å¯èƒ½ä»ç„¶æ˜¯ `true`ï¼ˆå¦‚æœä¹‹å‰åŠ¨ç”»ä¸­ç¼“å­˜äº†è¾“å…¥ï¼‰
4. ä¸‹æ¬¡åŠ¨ç”»ç»“æŸæ—¶ `ConsumePendingFarmInput` ä¼šæ¶ˆè´¹è¿™ä¸ªè¿‡æ—¶çš„ç¼“å­˜

**ä¿®æ­£**ï¼š`CancelFarmingNavigation` ä¸­å¢åŠ æ¸…é™¤ç¼“å­˜é€»è¾‘ã€‚

#### ğŸ”´ æ¼æ´ E-2ï¼ˆæ–°å‘ç°ï¼‰ï¼šåŠ¨ç”»ä¸­ WASD ç§»åŠ¨ä¸æ¸…é™¤ç¼“å­˜

**åœºæ™¯**ï¼š
1. ç”¨æˆ·ä½¿ç”¨é”„å¤´è€•åœ°ï¼ˆè¿‘è·ç¦»ï¼‰ï¼ŒåŠ¨ç”»æ’­æ”¾ä¸­
2. åŠ¨ç”»æœŸé—´ç‚¹å‡»æ–°ä½ç½® â†’ `CacheFarmInput` ç¼“å­˜äº†æ–°ä½ç½®
3. åŠ¨ç”»æœŸé—´æŒ‰ WASD â†’ `HandleMovement` æ£€æŸ¥ `_farmNavState`
4. æ­¤æ—¶ `_farmNavState` å¯èƒ½æ˜¯ `Preview`ï¼ˆè¿‘è·ç¦»è€•åœ°æ‰§è¡Œå®Œåå›åˆ° Previewï¼‰
5. `_farmNavState != Idle` ä¸º true â†’ `CancelFarmingNavigation()` â†’ ä½† `CancelFarmingNavigation` é¦–è¡Œæ£€æŸ¥ `if (_farmNavState == Idle || _farmNavState == Preview) return;` â†’ ç›´æ¥è¿”å›ï¼
6. ç¼“å­˜æ²¡æœ‰è¢«æ¸…é™¤

**æ›´å‡†ç¡®çš„åˆ†æ**ï¼šè¿‘è·ç¦»è€•åœ°çš„ `_isExecutingFarming` é˜»æ–­æœŸé—´ï¼Œ`_farmNavState` æ˜¯ `Executing`ã€‚`HandleMovement` ä¸­ `_farmNavState != Idle` ä¸º trueï¼Œä¼šè°ƒç”¨ `CancelFarmingNavigation`ã€‚ä½† `CancelFarmingNavigation` ä¸å¤„ç† `Executing` çŠ¶æ€å—ï¼Ÿ

çœ‹ä»£ç ï¼š`CancelFarmingNavigation` é¦–è¡Œæ˜¯ `if (_farmNavState == Idle || _farmNavState == Preview) return;`ã€‚`Executing` ä¸åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥ä¼šç»§ç»­æ‰§è¡Œã€‚ä½† `Executing` çŠ¶æ€ä¸‹è°ƒç”¨ `CancelFarmingNavigation` ä¼šå¯¼è‡´ `_isExecutingFarming` è¢«è®¾ä¸º `false`ï¼Œå¯èƒ½æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„æ“ä½œã€‚

**å®é™…ä¸Š**ï¼š`_isExecutingFarming = true` æœŸé—´ï¼Œ`HandleMovement` ä¸­çš„ `ToolActionLockManager.IsLocked` æ£€æŸ¥ä¼šé˜»æ­¢ç§»åŠ¨è¾“å…¥ä¼ é€’ç»™ `PlayerMovement`ï¼Œæ‰€ä»¥ WASD ä¸ä¼šè§¦å‘ `CancelFarmingNavigation`ã€‚

**ä½† `isPerformingAction = true` æœŸé—´å‘¢ï¼Ÿ** `HandleMovement` æ²¡æœ‰æ£€æŸ¥ `isPerformingAction`ï¼Œåªæ£€æŸ¥ `ToolActionLockManager.IsLocked`ã€‚`lockManager.IsLocked` åœ¨ `BeginAction()` åä¸º `true`ï¼Œæ‰€ä»¥åŠ¨ç”»æœŸé—´ WASD è¾“å…¥ä¼šè¢«ç¼“å­˜åˆ° `lockManager.CacheDirection(input)` è€Œä¸æ˜¯è§¦å‘ç§»åŠ¨ã€‚

**ç»“è®º**ï¼šåŠ¨ç”»æœŸé—´ WASD ä¸ä¼šè§¦å‘ `CancelFarmingNavigation`ï¼ˆå› ä¸º `lockManager.IsLocked` é˜»æ­¢äº†ï¼‰ï¼Œæ‰€ä»¥æ¼æ´ E-2 å®é™…ä¸Šä¸å­˜åœ¨ã€‚ä½†åŠ¨ç”»ç»“æŸåã€ç¼“å­˜æ¶ˆè´¹å‰çš„çª—å£æœŸï¼Œå¦‚æœç”¨æˆ·æŒ‰ WASDï¼Œç¼“å­˜å¯èƒ½ä¸ä¼šè¢«æ¸…é™¤ã€‚

**ä¿®æ­£æ–¹æ¡ˆ**ï¼šåœ¨ `CancelFarmingNavigation` ä¸­å¢åŠ æ¸…é™¤ `_hasPendingFarmInput` çš„é€»è¾‘ï¼ŒåŒæ—¶åœ¨ `HandleMovement` çš„ä¸¤ä¸ªåˆ†æ”¯ä¸­ï¼Œå¦‚æœæœ‰è¾“å…¥ç¼“å­˜ä¹Ÿä¸€å¹¶æ¸…é™¤ã€‚

```csharp
// HandleMovement ä¿®æ­£
if (autoNavigator.IsActive && æœ‰è¾“å…¥)
{
    autoNavigator.ForceCancel();
    CancelFarmingNavigation();
    ClearPendingFarmInput();  // â† æ–°å¢
}

if (_farmNavState != Idle && æœ‰è¾“å…¥)
{
    CancelFarmingNavigation();
    // ClearPendingFarmInput å·²åœ¨ CancelFarmingNavigation å†…éƒ¨å¤„ç†
}
```


---

## äº”ã€ä¿®æ­£æ–¹æ¡ˆæ±‡æ€»ï¼ˆå…¨éƒ¨äº’ç›¸é…åˆï¼‰

### æ–¹æ¡ˆ Aï¼ˆä¿®æ­£ç‰ˆï¼‰ï¼šCacheFarmInput ä¸­é”å®šé¢„è§ˆ + åˆ·æ–° 1+8

```
CacheFarmInput(int itemId) ä¿®æ­£æµç¨‹ï¼š
1. worldPos = GetMouseWorldPosition()
2. itemData = database.GetItemByID(itemId)
3. farmPreview.UnlockPosition()                    â† å…ˆè§£é”ï¼ˆè®© ForceUpdate èƒ½æ¸²æŸ“ 1+8ï¼‰
4. ForceUpdatePreviewToPosition(worldPos, itemData) â† åˆ·æ–°å®Œæ•´é¢„è§ˆï¼ˆå« 1+8 GhostTilemapï¼‰
5. è®¡ç®— alignedPos/layerIndex/cellPos
6. farmPreview.LockPosition(alignedPos, cellPos, layerIndex) â† é”å®š
7. _hasPendingFarmInput = true
8. _pendingFarmWorldPos = worldPos
9. _pendingFarmItemId = itemId
```

**è§£å†³çš„é—®é¢˜**ï¼šA-1ï¼ˆ1+8 é¢„è§ˆæ—¶åºï¼‰ã€A-2ï¼ˆè¿ç»­ç‚¹å‡»é¢„è§ˆæ›´æ–°ï¼‰ã€A-3ï¼ˆéœ€è¦ ItemDataï¼‰ã€A-4ï¼ˆéœ€è¦ layerIndex/cellPosï¼‰

### æ–¹æ¡ˆ Bï¼ˆä¿®æ­£ç‰ˆï¼‰ï¼šOnActionComplete é•¿æŒ‰åˆ†æ”¯åŒºåˆ†å†œç”°å·¥å…·å’Œé€šç”¨å·¥å…·

**ä¸ä¿®æ”¹ `IsToolAction`**ï¼ˆä¿ç•™ Crushï¼‰ï¼Œè€Œæ˜¯åœ¨é•¿æŒ‰åˆ†æ”¯ä¸­åˆ¤æ–­æ‰‹æŒç‰©å“ç±»å‹ï¼š

```
OnActionComplete é•¿æŒ‰åˆ†æ”¯ä¿®æ­£ï¼š
if (shouldContinue)
{
    bool isFarmTool = å½“å‰æ‰‹æŒæ˜¯ Hoe æˆ– WateringCan æˆ– Seed;
    
    if (isFarmTool)
    {
        // å†œç”°å·¥å…·ï¼šä¸å…ˆæ’­åŠ¨ç”»ï¼Œè®© TryXxx å†…éƒ¨å¤„ç†
        animController?.StopAnimationTracking();
        lockManager?.EndAction(true);
        isPerformingAction = false;
        
        if (æœ‰ç¼“å­˜) ConsumePendingFarmInput();
        else ProcessFarmInputAt(é¼ æ ‡ä½ç½®);
    }
    else
    {
        // é€šç”¨å·¥å…·ï¼ˆé•å­/æ–§å¤´ç­‰ï¼‰ï¼šä¿æŒåŸæœ‰è¡Œä¸º
        StartAction(actionToRepeat, true);
    }
}
```

**è§£å†³çš„é—®é¢˜**ï¼šBï¼ˆé”„å¤´é•¿æŒ‰åŸåœ°é‡å¤ï¼‰ã€C-1ï¼ˆæµ‡æ°´é•¿æŒ‰ RequestAction è¢«å¿½ç•¥ï¼‰ã€C-2ï¼ˆæµ‡æ°´é•¿æŒ‰è¿œè·ç¦»å¡æ­»ï¼‰

**ä¿æŠ¤çš„åŠŸèƒ½**ï¼šé•å­/æ–§å¤´ç­‰é€šç”¨å·¥å…·çš„é•¿æŒ‰è¿ç»­è¡Œä¸ºä¸å—å½±å“ âœ…

### æ–¹æ¡ˆ Cï¼ˆå·²åˆå¹¶åˆ°æ–¹æ¡ˆ B ä¿®æ­£ç‰ˆï¼‰

æµ‡æ°´çš„é•¿æŒ‰é—®é¢˜ä¸é”„å¤´æœ¬è´¨ç›¸åŒï¼Œç»Ÿä¸€ç”±æ–¹æ¡ˆ B ä¿®æ­£ç‰ˆå¤„ç†ã€‚

### æ–¹æ¡ˆ Dï¼šConsumePendingFarmInput ä¸­å…ˆ UnlockPosition

```
ConsumePendingFarmInput ä¿®æ­£ï¼š
1. if (!_hasPendingFarmInput) return;
2. _hasPendingFarmInput = false;
3. éªŒè¯ç‰©å“ä¸€è‡´æ€§
4. farmPreview.UnlockPosition()          â† æ–°å¢ï¼šå…ˆè§£é”
5. ProcessFarmInputAt(_pendingFarmWorldPos)
```

**è§£å†³çš„é—®é¢˜**ï¼šD-1ï¼ˆForceUpdatePreviewToPosition åœ¨é”å®šçŠ¶æ€ä¸‹æ— æ³•æ¸²æŸ“ 1+8ï¼‰

### æ–¹æ¡ˆ Eï¼ˆä¿®æ­£ç‰ˆï¼‰ï¼šWASD ç§»åŠ¨ + å¯¼èˆªå–æ¶ˆæ—¶æ¸…é™¤ç¼“å­˜

```
CancelFarmingNavigation ä¿®æ­£ï¼š
åœ¨ç°æœ‰é€»è¾‘æœ«å°¾å¢åŠ ï¼š
_hasPendingFarmInput = false;  â† æ¸…é™¤è¾“å…¥ç¼“å­˜

HandleMovement ä¿®æ­£ï¼š
åœ¨ autoNavigator.IsActive åˆ†æ”¯ä¸­å¢åŠ ï¼š
_hasPendingFarmInput = false;  â† æ¸…é™¤è¾“å…¥ç¼“å­˜
farmPreview.UnlockPosition();  â† è§£é”é¢„è§ˆï¼ˆCancelFarmingNavigation å¯èƒ½å› çŠ¶æ€æ£€æŸ¥è·³è¿‡ï¼‰
```

**è§£å†³çš„é—®é¢˜**ï¼šE-1ï¼ˆWASD ä¸æ¸…é™¤ç¼“å­˜ï¼‰

---

## å…­ã€éœ€è¦ç”¨æˆ·ç¡®è®¤çš„é—®é¢˜

### Q1ï¼šé”„å¤´é•¿æŒ‰è¡Œä¸ºç¡®è®¤

å½“å‰æ–¹æ¡ˆ B ä¿®æ­£ç‰ˆä¸­ï¼Œé”„å¤´é•¿æŒ‰æ—¶èµ°å†œç”°å·¥å…·åˆ†æ”¯ï¼Œ`isPerformingAction = false` åæ¶ˆè´¹ç¼“å­˜æˆ–ç”¨é¼ æ ‡ä½ç½®æ‰§è¡Œã€‚

**é—®é¢˜**ï¼šå¦‚æœç”¨æˆ·é•¿æŒ‰é”„å¤´ä¸”æ²¡æœ‰ç¼“å­˜ï¼Œä¼šä»¥å½“å‰é¼ æ ‡ä½ç½®æ‰§è¡Œ `ProcessFarmInputAt`ã€‚å¦‚æœé¼ æ ‡æŒ‡å‘çš„ä½ç½®æ— æ•ˆï¼ˆçº¢æ¡†ï¼‰ï¼Œ`TryTillSoil` ä¼š return falseï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚ç”¨æˆ·éœ€è¦æ¾å¼€å†é‡æ–°ç‚¹å‡»ã€‚

**è¿™æ˜¯ä½ æœŸæœ›çš„è¡Œä¸ºå—ï¼Ÿ** è¿˜æ˜¯è¯´é”„å¤´é•¿æŒ‰æ—¶åº”è¯¥å®Œå…¨å¿½ç•¥ï¼ˆä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œç­‰ç”¨æˆ·æ¾å¼€åé‡æ–°ç‚¹å‡»ï¼‰ï¼Ÿ

### Q2ï¼šæµ‡æ°´é•¿æŒ‰è¡Œä¸ºç¡®è®¤

æ–¹æ¡ˆ B ä¿®æ­£ç‰ˆä¸­ï¼Œæµ‡æ°´é•¿æŒ‰æ—¶ä¹Ÿèµ°å†œç”°å·¥å…·åˆ†æ”¯ã€‚

**é—®é¢˜**ï¼šæµ‡æ°´é•¿æŒ‰æ— ç¼“å­˜æ—¶ï¼Œä»¥å½“å‰é¼ æ ‡ä½ç½®æ‰§è¡Œ `ProcessFarmInputAt` â†’ `TryWaterTile`ã€‚å¦‚æœé¼ æ ‡æŒ‡å‘çš„æ˜¯å·²æµ‡æ°´çš„æ ¼å­ï¼Œ`TryWaterTile` ä¼š return falseã€‚å¦‚æœæŒ‡å‘æœªæµ‡æ°´çš„æ ¼å­ï¼Œä¼šæ­£å¸¸æµ‡æ°´ã€‚

**è¿™æ˜¯ä½ æœŸæœ›çš„è¡Œä¸ºå—ï¼Ÿ** æµ‡æ°´æ˜¯å¦åº”è¯¥æ”¯æŒé•¿æŒ‰è¿ç»­æµ‡æ°´ï¼ˆæ¯æ¬¡åŠ¨ç”»ç»“æŸåè‡ªåŠ¨æµ‡é¼ æ ‡æŒ‡å‘çš„ä¸‹ä¸€ä¸ªæ ¼å­ï¼‰ï¼Ÿ

### Q3ï¼šç§å­é•¿æŒ‰è¡Œä¸º

ç§å­ç›®å‰ä¸åœ¨ `IsToolAction` ä¸­ï¼ˆæ²¡æœ‰ `Planting` åŠ¨ç”»ç±»å‹ï¼‰ï¼Œæ‰€ä»¥ç§å­ä¸ä¼šè§¦å‘é•¿æŒ‰ç»§ç»­ã€‚ç§å­åŠ¨ç”»ç»“æŸåèµ°æ¾å¼€åˆ†æ”¯ï¼Œæ¶ˆè´¹ç¼“å­˜ã€‚

**è¿™æ˜¯æ­£ç¡®çš„å—ï¼Ÿ** ç§å­æ˜¯å¦éœ€è¦æ”¯æŒé•¿æŒ‰è¿ç»­ç§æ¤ï¼Ÿ

### Q4ï¼šåŠ¨ç”»æœŸé—´åˆ‡æ¢å·¥å…·æ 

`ToolActionLockManager` åœ¨åŠ¨ç”»æœŸé—´ä¼šç¼“å­˜ hotbar åˆ‡æ¢ã€‚åŠ¨ç”»ç»“æŸååº”ç”¨ç¼“å­˜çš„ hotbar åˆ‡æ¢ã€‚

**é—®é¢˜**ï¼šå¦‚æœåŠ¨ç”»æœŸé—´ç”¨æˆ·åˆ‡æ¢äº†å·¥å…·æ ï¼ˆä»é”„å¤´åˆ‡åˆ°æµ‡æ°´å£¶ï¼‰ï¼Œç„¶åç‚¹å‡»ç¼“å­˜äº†è¾“å…¥ã€‚`ConsumePendingFarmInput` ä¸­çš„ç‰©å“ä¸€è‡´æ€§æ£€æŸ¥ `currentItemId != _pendingFarmItemId` ä¼šå‘ç°ä¸ä¸€è‡´ï¼Œç¼“å­˜è¢«ä¸¢å¼ƒã€‚

**ä½† hotbar åˆ‡æ¢æ˜¯åœ¨ `OnActionComplete` çš„æ¾å¼€åˆ†æ”¯æœ«å°¾æ‰åº”ç”¨çš„**ï¼ˆ`ApplyCachedHotbarSwitch`ï¼‰ï¼Œè€Œ `ConsumePendingFarmInput` åœ¨æ¾å¼€åˆ†æ”¯çš„å¼€å¤´å°±è°ƒç”¨äº†ã€‚æ‰€ä»¥æ¶ˆè´¹ç¼“å­˜æ—¶ï¼Œhotbar è¿˜æ²¡åˆ‡æ¢ï¼Œ`currentItemId` ä»ç„¶æ˜¯æ—§å·¥å…·çš„ IDï¼Œä¸ `_pendingFarmItemId` ä¸€è‡´ï¼Œç¼“å­˜ä¼šè¢«æ¶ˆè´¹ã€‚

**æ—¶åº**ï¼š
```
æ¾å¼€åˆ†æ”¯ï¼š
1. ConsumePendingFarmInput()  â† hotbar è¿˜æ²¡åˆ‡æ¢ï¼Œç‰©å“ä¸€è‡´æ€§é€šè¿‡
2. isPerformingAction = false
3. lockManager.EndAction(false)
4. ApplyCachedHotbarSwitch()  â† è¿™é‡Œæ‰åˆ‡æ¢ hotbar
```

**è¿™æ˜¯ä¸€ä¸ªæ½œåœ¨é—®é¢˜**ï¼šç”¨æˆ·åŠ¨ç”»æœŸé—´åˆ‡æ¢äº†å·¥å…·æ ï¼Œä½†ç¼“å­˜çš„è¾“å…¥ä»ç„¶ä»¥æ—§å·¥å…·æ‰§è¡Œäº†ã€‚

**å»ºè®®**ï¼šåœ¨ `ConsumePendingFarmInput` ä¹‹å‰æ£€æŸ¥æ˜¯å¦æœ‰ hotbar ç¼“å­˜ï¼Œå¦‚æœæœ‰åˆ™å…ˆåº”ç”¨ hotbar åˆ‡æ¢å†æ¶ˆè´¹ç¼“å­˜ã€‚æˆ–è€…ï¼Œå¦‚æœæœ‰ hotbar ç¼“å­˜ï¼Œç›´æ¥ä¸¢å¼ƒå†œç”°è¾“å…¥ç¼“å­˜ã€‚

**è¯·ç¡®è®¤ä½ æœŸæœ›çš„è¡Œä¸º**ï¼šåŠ¨ç”»æœŸé—´åˆ‡æ¢å·¥å…·æ åï¼Œç¼“å­˜çš„è¾“å…¥åº”è¯¥è¢«ä¸¢å¼ƒè¿˜æ˜¯ä»¥æ–°å·¥å…·æ‰§è¡Œï¼Ÿ

---

## ä¸ƒã€æ¼æ´ä¸¥é‡åº¦æ±‡æ€»

| ç¼–å· | æ¼æ´ | ä¸¥é‡åº¦ | æ–¹æ¡ˆ |
|------|------|--------|------|
| A-1 | 1+8 é¢„è§ˆåŠ è½½æ—¶åº | ğŸ”´ ä¸¥é‡ | A ä¿®æ­£ç‰ˆ |
| A-2 | è¿ç»­ç‚¹å‡»é¢„è§ˆä¸æ›´æ–° | ğŸ”´ ä¸¥é‡ | A ä¿®æ­£ç‰ˆ |
| A-3 | CacheFarmInput éœ€è¦ ItemData | ğŸŸ¡ ä¸­ç­‰ | A ä¿®æ­£ç‰ˆ |
| A-4 | CacheFarmInput éœ€è¦ layerIndex/cellPos | ğŸŸ¡ ä¸­ç­‰ | A ä¿®æ­£ç‰ˆ |
| B | é”„å¤´é•¿æŒ‰åŸåœ°é‡å¤/è¿œè·ç¦»å¡æ­» | ğŸ”´ ä¸¥é‡ | B ä¿®æ­£ç‰ˆ |
| C-1 | æµ‡æ°´é•¿æŒ‰ RequestAction è¢«å¿½ç•¥ | ğŸ”´ ä¸¥é‡ | B ä¿®æ­£ç‰ˆ |
| C-2 | æµ‡æ°´é•¿æŒ‰è¿œè·ç¦»å¡æ­» | ğŸ”´ ä¸¥é‡ | B ä¿®æ­£ç‰ˆ |
| D-1 | ConsumePendingFarmInput é”å®šçŠ¶æ€ä¸‹ 1+8 ä¸æ¸²æŸ“ | ğŸŸ¡ ä¸­ç­‰ | D |
| E-1 | WASD ä¸æ¸…é™¤è¾“å…¥ç¼“å­˜ | ğŸ”´ ä¸¥é‡ | E ä¿®æ­£ç‰ˆ |
| Q4 | åŠ¨ç”»æœŸé—´åˆ‡æ¢å·¥å…·æ åç¼“å­˜æ¶ˆè´¹æ—¶åº | ğŸŸ¡ ä¸­ç­‰ | å¾…ç¡®è®¤ |

---

> æŠ¥å‘Šå®Œæˆã€‚è¯·å®¡é˜…å¹¶å›å¤ Q1-Q4 çš„ç¡®è®¤ï¼Œæˆ‘ä¼šæ ¹æ®ä½ çš„å›å¤è°ƒæ•´æ–¹æ¡ˆåå¼€å§‹å®ç°ã€‚


---

## å…«ã€Q1-Q4 ç¡®è®¤ç»“æœä¸å®æ–½è®°å½•

> æ›´æ–°æ—¶é—´ï¼š2026-02-18 ä¼šè¯1ç»­3
> ç”¨æˆ·å·²ç¡®è®¤æ‰€æœ‰ Q1-Q4 é—®é¢˜ï¼Œä»¥ä¸‹ä¸ºç¡®è®¤ç»“æœå’Œå®æ–½è®°å½•

### 8.1 ç”¨æˆ·ç¡®è®¤ç»“æœ

#### Q1 é”„å¤´é•¿æŒ‰è¡Œä¸º âœ… å·²ç¡®è®¤

- é•¿æŒ‰ = å¿«é€Ÿè¿ç»­è¾“å…¥ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªä½ç½®ç”Ÿæ•ˆå¹¶é”å®š
- é•¿æŒ‰æœŸé—´é¢„è§ˆæ¡†å’Œè€•åœ°é¢„è§ˆï¼ˆ1+8 GhostTilemapï¼‰éƒ½ä¸é”å®šï¼Œè·Ÿéšé¼ æ ‡
- åŠ¨ç”»å®Œæˆç¬é—´é”å®šå½“å‰é¼ æ ‡æ‰€åœ¨ä½ç½®å¹¶æ‰§è¡Œ
- ä¸éœ€è¦ç¼“å­˜çŠ¶æ€ï¼Œåªéœ€ä¿æŒé¢„è§ˆè·Ÿéš
- è€•å®Œåä»é•¿æŒ‰åˆ™è·å–æ­¤æ—¶é¼ æ ‡ä½ç½®å¹¶é”å®šæ‰§è¡Œ

#### Q2 æµ‡æ°´é•¿æŒ‰è¡Œä¸º âœ… å·²ç¡®è®¤

- ä¸é”„å¤´å®Œå…¨ä¸€è‡´çš„é€»è¾‘ï¼ŒåŒ…æ‹¬é•¿æŒ‰è¡Œä¸º
- å…±ç”¨é€»è¾‘ï¼Œæ‰‹æŒåˆ¤æ–­å’ŒåŠ¨ç”»åˆ†å¼€

#### Q3 ç§å­é•¿æŒ‰è¡Œä¸º âœ… å·²ç¡®è®¤

- ä¹Ÿä½¿ç”¨ä¸é”„å¤´/æµ‡æ°´ä¸€è‡´çš„é€»è¾‘
- æ”¯æŒç¼“å­˜å’Œé•¿æŒ‰
- ä½†æ²¡æœ‰åŠ¨ç”»æ’­æ”¾æ­¥éª¤ï¼Œåªéœ€åˆ›å»º

#### Q4 åŠ¨ç”»æœŸé—´åˆ‡æ¢å·¥å…·æ  âœ… å·²ç¡®è®¤

- åŠ¨ç”»æœŸé—´ç»å¯¹ç¦æ­¢ä»»ä½•å½¢å¼çš„åˆ‡æ¢
- åˆ‡æ¢å¿…é¡»ä¸­æ–­å½“å‰åŠ¨ç”»
- WASD ä¹Ÿä¸èƒ½ä¸­æ–­åŠ¨ç”»ï¼ˆä¸ä¹‹å‰çš„å¤„ç†ä¸€è‡´ï¼‰

#### è¡¥å……çº¦æŸ âœ… å·²ç¡®è®¤

- æ‰€æœ‰è€•åœ°åˆ›å»ºéƒ½å¿…é¡»æ’­æ”¾åŠ¨ç”»
- è¿‘è·ç¦»ç¼“å­˜ä½ç½®ä¸èƒ½è·³è¿‡åŠ¨ç”»ç›´æ¥å˜ä¸ºè€•åœ°

### 8.2 å®æ–½è®°å½•

åŸºäºç”¨æˆ·ç¡®è®¤ï¼Œè·³è¿‡ requirements æ–‡æ¡£ï¼Œç›´æ¥åˆ›å»º design.md + tasks.md åä¸€æ¡é¾™æ‰§è¡Œã€‚

#### å·²å®æ–½æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¿®æ”¹æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è§£å†³æ¼æ´ |
|------|----------|----------|----------|
| A ä¿®æ­£ç‰ˆ | `GameInputManager.cs` â€” `CacheFarmInput` | UnlockPosition â†’ ForceUpdatePreviewToPosition(åˆ·æ–°1+8) â†’ è®¡ç®— alignedPos/layerIndex/cellPos â†’ LockPosition â†’ ç¼“å­˜å­—æ®µèµ‹å€¼ | A-1, A-2, A-3, A-4 |
| B ä¿®æ­£ç‰ˆ | `GameInputManager.cs` â€” `IsHoldingFarmTool` æ”¹ publicï¼›`PlayerInteraction.cs` â€” `OnActionComplete` é•¿æŒ‰åˆ†æ”¯ | é•¿æŒ‰åˆ†æ”¯é€šè¿‡ `IsHoldingFarmTool()` åŒºåˆ†ï¼šå†œç”°å·¥å…·ä¸å…ˆ StartActionï¼ˆStopAnimationTracking â†’ EndAction(true) â†’ isPerformingAction=false â†’ ConsumePendingFarmInput æˆ– ProcessFarmInputAtï¼‰ï¼›é€šç”¨å·¥å…·ä¿æŒåŸæœ‰ StartAction | B, C-1, C-2 |
| D | `GameInputManager.cs` â€” `ConsumePendingFarmInput` | ProcessFarmInputAt ä¹‹å‰å¢åŠ  `farmPreview.UnlockPosition()` | D-1 |
| E ä¿®æ­£ç‰ˆ | `GameInputManager.cs` â€” `CancelFarmingNavigation` + `HandleMovement` | CancelFarmingNavigation æœ«å°¾å¢åŠ  `_hasPendingFarmInput = false`ï¼›HandleMovement autoNavigator åˆ†æ”¯å¢åŠ æ¸…é™¤ç¼“å­˜ + è§£é”é¢„è§ˆ | E-1 |
| Q4 | `GameInputManager.cs` â€” æ–°å¢ `ClearPendingFarmInput()`ï¼›`PlayerInteraction.cs` â€” `OnActionComplete` æ¾å¼€åˆ†æ”¯ | æ¾å¼€åˆ†æ”¯åœ¨ ConsumePendingFarmInput ä¹‹å‰æ£€æŸ¥ `HasCachedHotbarInput`ï¼Œæœ‰åˆ™è°ƒç”¨ `ClearPendingFarmInput()` ä¸¢å¼ƒå†œç”°ç¼“å­˜ | Q4 |

#### ç¼–è¯‘éªŒè¯

- getDiagnosticsï¼š0 é”™è¯¯ 0 è­¦å‘Š âœ…
- mcp_mcp_unity_recompile_scriptsï¼šç¼–è¯‘é€šè¿‡ï¼Œ0 è­¦å‘Š âœ…

### 8.3 æ¼æ´çŠ¶æ€æ›´æ–°

| ç¼–å· | æ¼æ´ | çŠ¶æ€ |
|------|------|------|
| A-1 | 1+8 é¢„è§ˆåŠ è½½æ—¶åº | âœ… å·²ä¿®å¤ |
| A-2 | è¿ç»­ç‚¹å‡»é¢„è§ˆä¸æ›´æ–° | âœ… å·²ä¿®å¤ |
| A-3 | CacheFarmInput éœ€è¦ ItemData | âœ… å·²ä¿®å¤ |
| A-4 | CacheFarmInput éœ€è¦ layerIndex/cellPos | âœ… å·²ä¿®å¤ |
| B | é”„å¤´é•¿æŒ‰åŸåœ°é‡å¤/è¿œè·ç¦»å¡æ­» | âœ… å·²ä¿®å¤ |
| C-1 | æµ‡æ°´é•¿æŒ‰ RequestAction è¢«å¿½ç•¥ | âœ… å·²ä¿®å¤ |
| C-2 | æµ‡æ°´é•¿æŒ‰è¿œè·ç¦»å¡æ­» | âœ… å·²ä¿®å¤ |
| D-1 | ConsumePendingFarmInput é”å®šçŠ¶æ€ä¸‹ 1+8 ä¸æ¸²æŸ“ | âœ… å·²ä¿®å¤ |
| E-1 | WASD ä¸æ¸…é™¤è¾“å…¥ç¼“å­˜ | âœ… å·²ä¿®å¤ |
| Q4 | åŠ¨ç”»æœŸé—´åˆ‡æ¢å·¥å…·æ åç¼“å­˜æ¶ˆè´¹æ—¶åº | âœ… å·²ä¿®å¤ |
