# 10.1.1 è¡¥ä¸001 éªŒæ”¶ Bug æ ¹å› åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

> åˆ›å»ºæ—¶é—´ï¼š2026-02-19 ä¼šè¯1ç»­6
> æ¥æºï¼šç”¨æˆ·æ¸¸æˆå†…éªŒæ”¶åé¦ˆï¼Œè¡¥ä¸001çš„ä¿®æ”¹å¼•å…¥äº†ä¸¤ä¸ªä¸¥é‡bug

---

## ä¸€ã€ç”¨æˆ·åé¦ˆçš„é—®é¢˜

### Bug 1ï¼ˆè‡´å‘½ï¼‰ï¼šé•¿æŒ‰/è¿ç»­ç‚¹å‡»åäººç‰©å®Œå…¨å¡æ­»
- æ‰§è¡Œå®Œç¬¬ä¸€ä¸ªä½ç½®åï¼Œäººç‰©ç«™ç«‹ä¸åŠ¨
- æ— æ³•ç§»åŠ¨ã€æ— æ³•è¾“å…¥ã€æ— æ³•åˆ‡æ¢å·¥å…·
- å¯¼èˆªç–¯ç‹‚æŠ¥é”™ï¼š"å¡é¡¿3æ¬¡å–æ¶ˆå¯¼èˆª"å¾ªç¯
- è¿ç»­å·¦é”®ä¹Ÿä¼šå‡ºç°åŒæ ·é—®é¢˜ï¼ˆæ™®éå­˜åœ¨ï¼‰

### Bug 2ï¼šé¢„è§ˆ 1+8 GhostTilemap ä¸è·Ÿéšæ–°ç‚¹å‡»ä½ç½®æ›´æ–°
- ç‚¹å‡» a â†’ æ¡†å’Œé¢„è§ˆéƒ½åœ¨ a
- ç‚¹å‡» b â†’ æ¡†åœ¨ b ä½†è€•åœ°é¢„è§ˆä»åœ¨ a
- åç»­ç‚¹å‡» cdefg éƒ½ä¸åˆ·æ–°
- åªæœ‰ç‚¹åˆ°æ— æ•ˆä½ç½®æ‰é‡æ–°åˆ·æ–°

---

## äºŒã€Bug 1 æ ¹å› åˆ†æï¼š`EndAction(true)` å¯¼è‡´ `IsLocked` æ°¸ä¹…é”å®š

### 2.1 é—®é¢˜ä»£ç å®šä½

**PlayerInteraction.cs â€” OnActionComplete å†œç”°å·¥å…·é•¿æŒ‰åˆ†æ”¯**ï¼ˆ10.1.1 æ–¹æ¡ˆB æ–°å¢ï¼‰ï¼š
```csharp
if (isFarmTool)
{
    animController?.StopAnimationTracking();
    lockManager?.EndAction(true);          // â† ğŸ”´ æ ¹å› åœ¨è¿™é‡Œ
    isPerformingAction = false;
    // ... è°ƒç”¨ ProcessFarmInputAt æˆ– ConsumePendingFarmInput
}
```

**ToolActionLockManager.cs â€” EndAction æ–¹æ³•**ï¼š
```csharp
public void EndAction(bool continuingAction = false)
{
    if (continuingAction)
    {
        IsContinuousMode = true;
        ClearHotbarCache();
        // ğŸ”´ æ³¨æ„ï¼šIsLocked æ²¡æœ‰è¢«è®¾ä¸º falseï¼ä¿æŒ trueï¼
    }
    else
    {
        IsLocked = false;  // æ­£å¸¸ç»“æŸæ‰è§£é”
        IsContinuousMode = false;
    }
}
```

### 2.2 å®Œæ•´æ‰§è¡Œæµç¨‹æ¨¡æ‹Ÿï¼ˆé•¿æŒ‰é”„å¤´ï¼‰

#### ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼ˆè¿‘è·ç¦»ï¼Œæ­£å¸¸æ‰§è¡Œï¼‰
```
HandleUseCurrentTool
  â†’ TryHandleFarmingTool â†’ TryTillSoil
    â†’ farmPreview.LockPosition()
    â†’ _farmNavState = Locked
    â†’ è¿‘è·ç¦»åˆ†æ”¯ï¼š
      â†’ _isExecutingFarming = true
      â†’ RequestAction(Crush) â†’ PerformAction â†’ StartAction
        â†’ isPerformingAction = true
        â†’ lockManager.BeginAction() â†’ IsLocked = true  â† åŠ¨ç”»é”å®š
      â†’ ExecuteTillSoilï¼ˆæ‰§è¡Œè€•åœ°ï¼‰
      â†’ finally: _isExecutingFarming = false, UnlockPosition(), _farmNavState = Preview
    â†’ åŠ¨ç”»ç»§ç»­æ’­æ”¾ä¸­...ï¼ˆIsLocked = true, isPerformingAction = trueï¼‰
```

#### åŠ¨ç”»å®Œæˆ â†’ OnActionCompleteï¼ˆç”¨æˆ·ä»åœ¨é•¿æŒ‰ï¼‰
```
OnActionComplete
  â†’ isCurrentlyHolding = true, shouldContinue = true
  â†’ isFarmTool = trueï¼ˆé”„å¤´ï¼‰
  â†’ è¿›å…¥å†œç”°å·¥å…·åˆ†æ”¯ï¼š
    â†’ StopAnimationTracking()
    â†’ lockManager.EndAction(true)
      â†’ ğŸ”´ IsLocked ä¿æŒ trueï¼ˆcontinuingAction=true ä¸è§£é”ï¼‰
    â†’ isPerformingAction = false
    â†’ æ— ç¼“å­˜ â†’ ProcessFarmInputAt(å½“å‰é¼ æ ‡ä½ç½®)
```

#### ProcessFarmInputAt â†’ TryTillSoil ç¬¬äºŒæ¬¡æ‰§è¡Œ
```
ProcessFarmInputAt
  â†’ ForceUpdatePreviewToPositionï¼ˆæ›´æ–°é¢„è§ˆåˆ°æ–°ä½ç½®ï¼‰
  â†’ TryHandleFarmingTool â†’ TryTillSoil
    â†’ farmPreview.LockPosition()
    â†’ _farmNavState = Locked
```

**å¦‚æœç¬¬äºŒæ¬¡æ˜¯è¿‘è·ç¦»**ï¼š
```
    â†’ _isExecutingFarming = true
    â†’ RequestAction(Crush) â†’ PerformAction
      â†’ if (isPerformingAction) return;  â† isPerformingAction = falseï¼Œæ­£å¸¸é€šè¿‡
      â†’ StartAction â†’ lockManager.BeginAction() â†’ IsLocked = trueï¼ˆå·²ç»æ˜¯trueï¼‰
    â†’ ExecuteTillSoil
    â†’ finally: _isExecutingFarming = false, UnlockPosition(), _farmNavState = Preview
    â†’ åŠ¨ç”»æ’­æ”¾... å¾ªç¯ç»§ç»­ï¼ˆè¿‘è·ç¦»ä¸ä¼šå¡æ­»ï¼‰
```

**âš¡ å¦‚æœç¬¬äºŒæ¬¡æ˜¯è¿œè·ç¦»ï¼ˆè§¦å‘å¡æ­»ï¼‰**ï¼š
```
    â†’ è¿œè·ç¦»åˆ†æ”¯ï¼š
      â†’ StartFarmingNavigation(targetPos, callback)
        â†’ autoNavigator.SetDestination(targetPos)  â† å¯¼èˆªå¯åŠ¨
        â†’ å¯åŠ¨ WaitForNavigationComplete åç¨‹
```

#### å¯¼èˆªæœŸé—´ â€” HandleMovement æ¯å¸§æ£€æŸ¥
```
HandleMovement
  â†’ lockManager.IsLocked == true  â† ğŸ”´ EndAction(true) ä¿æŒçš„é”å®šï¼
  â†’ playerMovement.SetMovementInput(Vector2.zero, false)  â† ç©å®¶æ— æ³•ç§»åŠ¨
  â†’ return
```

**ç»“æœ**ï¼šå¯¼èˆªéœ€è¦ç©å®¶ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®ï¼Œä½† `IsLocked = true` é˜»æ­¢äº†æ‰€æœ‰ç§»åŠ¨è¾“å…¥ã€‚
ç©å®¶æ°¸è¿œæ— æ³•åˆ°è¾¾ç›®æ ‡ â†’ å¯¼èˆªè¶…æ—¶ â†’ "å¡é¡¿3æ¬¡å–æ¶ˆå¯¼èˆª"ã€‚

#### å¯¼èˆªå–æ¶ˆå â€” WaitForNavigationComplete æœ€ååˆ†æ”¯
```
WaitForNavigationCompleteï¼ˆå¯¼èˆªç»“æŸä½†è·ç¦»è¿‡è¿œï¼‰
  â†’ farmPreview.UnlockPosition()      â† åªè§£é”äº† FarmToolPreview._isLocked
  â†’ _farmNavState = Preview
  â†’ _farmNavigationAction = null
  â†’ _farmingNavigationCoroutine = null
  â†’ ğŸ”´ æ²¡æœ‰é‡ç½® lockManager.IsLockedï¼
```

**æœ€ç»ˆçŠ¶æ€**ï¼š
- `lockManager.IsLocked = true`ï¼ˆæ°¸ä¹…é”å®šï¼Œæ— äººé‡ç½®ï¼‰
- `isPerformingAction = false`
- `_isExecutingFarming = false`
- `_farmNavState = Preview`
- ç©å®¶æ°¸è¿œæ— æ³•ç§»åŠ¨ â†’ å®Œå…¨å¡æ­»

### 2.3 è¿ç»­ç‚¹å‡»ä¹Ÿå¡æ­»çš„åŸå› 

åŒæ ·çš„é€»è¾‘é“¾ã€‚åªè¦ OnActionComplete é•¿æŒ‰åˆ†æ”¯è¢«è§¦å‘ï¼ˆç”¨æˆ·åœ¨åŠ¨ç”»å®Œæˆç¬é—´ä»æŒ‰ç€é¼ æ ‡ï¼‰ï¼Œ`EndAction(true)` å°±ä¼šä¿æŒ `IsLocked = true`ã€‚åç»­å¦‚æœè§¦å‘è¿œè·ç¦»å¯¼èˆªï¼Œå°±ä¼šå¡æ­»ã€‚

å³ä½¿æ˜¯æ¾å¼€åˆ†æ”¯ï¼Œå¦‚æœ `ConsumePendingFarmInput` â†’ `ProcessFarmInputAt` â†’ `TryTillSoil` è§¦å‘è¿œè·ç¦»å¯¼èˆªï¼Œè™½ç„¶æ¾å¼€åˆ†æ”¯è°ƒç”¨äº† `EndAction(false)` è§£é”ï¼Œä½† `TryTillSoil` è¿‘è·ç¦»åˆ†æ”¯çš„ `RequestAction` â†’ `BeginAction()` åˆä¼šé‡æ–°é”å®šã€‚å¦‚æœåç»­ OnActionComplete èµ°é•¿æŒ‰åˆ†æ”¯ï¼ŒåŒæ ·ä¼šå¡æ­»ã€‚

### 2.4 æ ¹å› æ€»ç»“

**æ ¸å¿ƒçŸ›ç›¾**ï¼š`EndAction(true)` çš„è®¾è®¡æ„å›¾æ˜¯"é•¿æŒ‰è¿ç»­ä½¿ç”¨æ—¶ä¿æŒé”å®šï¼Œé˜²æ­¢åŠ¨ç”»é—´éš™åˆ‡æ¢å·¥å…·"ã€‚ä½†å†œç”°å·¥å…·çš„é•¿æŒ‰ç»­æ¥éœ€è¦å¯åŠ¨å¯¼èˆªï¼ˆè¿œè·ç¦»ï¼‰ï¼Œè€Œå¯¼èˆªéœ€è¦ç©å®¶èƒ½ç§»åŠ¨ã€‚`IsLocked = true` åŒæ—¶é˜»æ­¢äº†ç§»åŠ¨å’Œå·¥å…·åˆ‡æ¢ï¼Œå¯¼è‡´å¯¼èˆªæ— æ³•å®Œæˆã€‚

**é€šç”¨å·¥å…·æ²¡æœ‰è¿™ä¸ªé—®é¢˜**ï¼šé€šç”¨å·¥å…·é•¿æŒ‰åˆ†æ”¯ç›´æ¥è°ƒç”¨ `StartAction(actionToRepeat, true)`ï¼Œä¸éœ€è¦å¯¼èˆªï¼ŒåŠ¨ç”»åœ¨åŸåœ°æ’­æ”¾ã€‚

---

## ä¸‰ã€Bug 2 æ ¹å› åˆ†æï¼šå¡æ­»åçš„è¿é”ååº” + `LockPosition` åªæ›´æ–° Cursor

### 3.1 ç‹¬ç«‹å¤ç°è·¯å¾„åˆ†æ

ç»è¿‡é€è¡Œæ¨¡æ‹Ÿï¼Œ`CacheFarmInput` çš„é€»è¾‘æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼š
```
UnlockPosition() â†’ _isLocked = false
ForceUpdatePreviewToPosition() â†’ UpdateHoePreview() â†’ _isLocked=false â†’ æ­£å¸¸æ¸²æŸ“ 1+8
LockPosition() â†’ _isLocked = true â†’ åªæ›´æ–° Cursor
```

æ¯æ¬¡ `CacheFarmInput` éƒ½ä¼šå…ˆè§£é”å†å¼ºåˆ¶æ›´æ–°ï¼Œ1+8 åº”è¯¥èƒ½æ­£ç¡®æ¸²æŸ“åˆ°æ–°ä½ç½®ã€‚

### 3.2 å®é™…è§¦å‘åœºæ™¯

Bug 2 æœ€å¯èƒ½æ˜¯ Bug 1 çš„è¿é”ååº”ï¼š

1. ç¬¬ä¸€æ¬¡æ‰§è¡Œå `lockManager.IsLocked = true`ï¼ˆEndAction(true) ä¿æŒï¼‰
2. ç¬¬äºŒæ¬¡ `TryTillSoil` è¿œè·ç¦» â†’ å¯¼èˆªå¡æ­»
3. å¯¼èˆªå–æ¶ˆå `_farmNavState = Preview`ï¼Œä½† `lockManager.IsLocked = true`
4. ç”¨æˆ·ç»§ç»­ç‚¹å‡» â†’ `HandleUseCurrentTool`ï¼š
   - `_isExecutingFarming = false` âœ“
   - `isPerformingAction = false` âœ“ï¼ˆOnActionComplete å·²é‡ç½®ï¼‰
   - `_farmNavState = Preview`ï¼ˆä¸æ˜¯ Navigating/Lockedï¼‰â†’ ä¸è¿›å…¥å¯¼èˆªä¸­æ–­åˆ†æ”¯
   - æ­£å¸¸æµç¨‹ â†’ `TryTillSoil` â†’ `LockPosition()` â†’ `_isLocked = true`
5. è¿‘è·ç¦»ï¼š`RequestAction(Crush)` â†’ `PerformAction` â†’ `if (isPerformingAction) return` â†’ `isPerformingAction = false` â†’ æ­£å¸¸æ‰§è¡Œ
6. `StartAction` â†’ `lockManager.BeginAction()` â†’ `IsLocked = true`ï¼ˆå·²ç»æ˜¯ trueï¼‰
7. åŠ¨ç”»æ’­æ”¾... ä½† `TryTillSoil` çš„ finally å—å·²ç» `UnlockPosition()` äº†

**ç­‰ç­‰**ï¼Œè¿™é‡Œæœ‰ä¸ªå…³é”®é—®é¢˜ï¼š`TryTillSoil` è¿‘è·ç¦»åˆ†æ”¯çš„ `RequestAction(Crush)` è§¦å‘åŠ¨ç”»ï¼Œä½† `ExecuteTillSoil` å’Œ finally å—åœ¨åŒä¸€å¸§åŒæ­¥æ‰§è¡Œã€‚æ‰€ä»¥ï¼š
- `_isLocked` è¢« finally è®¾ä¸º false
- ä½† `lockManager.IsLocked` è¢« `BeginAction()` è®¾ä¸º true
- åŠ¨ç”»æ’­æ”¾ä¸­ï¼Œ`lockManager.IsLocked = true`

åç»­å¸§çš„ `UpdatePreviews` â†’ `UpdateHoePreview`ï¼š
```csharp
if (_isLocked) return;  // _isLocked = falseï¼ˆfinally å·²è§£é”ï¼‰â†’ ä¸è·³è¿‡
```

æ‰€ä»¥æ¯å¸§çš„ `UpdateHoePreview` ä¼šæ­£å¸¸æ‰§è¡Œï¼Œ1+8 ä¼šè·Ÿéšé¼ æ ‡æ›´æ–°ã€‚è¿™æ„å‘³ç€åœ¨éå¡æ­»çŠ¶æ€ä¸‹ï¼Œé¢„è§ˆåº”è¯¥æ˜¯æ­£å¸¸çš„ã€‚

### 3.3 å¡æ­»çŠ¶æ€ä¸‹çš„é¢„è§ˆè¡Œä¸º

å¡æ­»åï¼ˆ`lockManager.IsLocked = true` æ°¸ä¹…é”å®šï¼‰ï¼š
1. ç”¨æˆ·ç‚¹å‡»æ–°ä½ç½® â†’ `TryTillSoil` â†’ `LockPosition()` â†’ `_isLocked = true`
2. `RequestAction(Crush)` â†’ `StartAction` â†’ åŠ¨ç”»æ’­æ”¾
3. finally: `_isLocked = false`ï¼ˆFarmToolPreview è§£é”ï¼‰
4. ä½† `lockManager.IsLocked = true`ï¼ˆæ°¸ä¹…é”å®šï¼‰â†’ ç©å®¶æ— æ³•ç§»åŠ¨

åŠ¨ç”»å®Œæˆ â†’ `OnActionComplete`ï¼š
- `isCurrentlyHolding`... å¦‚æœç”¨æˆ·è¿˜åœ¨æŒ‰ â†’ é•¿æŒ‰åˆ†æ”¯ â†’ `EndAction(true)` â†’ `IsLocked` ä¿æŒ true
- `ProcessFarmInputAt` â†’ `TryTillSoil` â†’ å¦‚æœè¿œè·ç¦» â†’ å¯¼èˆªå†æ¬¡å¡æ­»
- å¯¼èˆªæœŸé—´ `_isLocked = true`ï¼ˆLockPosition è®¾ç½®çš„ï¼‰â†’ `UpdateHoePreview` è¢« `if (_isLocked) return` è·³è¿‡
- å¯¼èˆªå–æ¶ˆ â†’ `UnlockPosition()` â†’ `_isLocked = false`
- ä½†æ­¤æ—¶ 1+8 å·²ç»åœç•™åœ¨æ—§ä½ç½®ï¼Œç›´åˆ°ä¸‹ä¸€å¸§ `UpdatePreviews` åˆ·æ–°

**ç»“è®º**ï¼šBug 2 ä¸»è¦æ˜¯ Bug 1 å¡æ­»åçš„è¿é”ååº”ã€‚åœ¨å¯¼èˆªæœŸé—´ `_isLocked = true` å¯¼è‡´ `UpdateHoePreview` è·³è¿‡è§†è§‰æ›´æ–°ï¼Œè€Œå¯¼èˆªå› ä¸º `lockManager.IsLocked` æ°¸è¿œæ— æ³•å®Œæˆï¼Œæ‰€ä»¥ 1+8 ä¸€ç›´åœç•™åœ¨æ—§ä½ç½®ã€‚

### 3.4 å¦ä¸€ä¸ªç‹¬ç«‹çš„é¢„è§ˆé—®é¢˜

å³ä½¿ä¸å¡æ­»ï¼Œ`LockPosition` æ–¹æ³•æœ¬èº«ä¹Ÿæœ‰ç¼ºé™·ï¼š
```csharp
public void LockPosition(Vector3 worldPos, Vector3Int cellPos, int layerIndex)
{
    _isLocked = true;
    // ...
    UpdateCursor(layerIndex, cellPos);  // åªæ›´æ–°å…‰æ ‡ï¼Œä¸æ¸²æŸ“ 1+8
}
```

å½“ `CacheFarmInput` è°ƒç”¨ `ForceUpdatePreviewToPosition` â†’ `UpdateHoePreview` æ¸²æŸ“äº† 1+8 åˆ°æ–°ä½ç½®ï¼Œç„¶å `LockPosition` åªæ›´æ–° Cursorã€‚è¿™éƒ¨åˆ†æ˜¯æ­£ç¡®çš„ã€‚

ä½†å¦‚æœ `ForceUpdatePreviewToPosition` å†…éƒ¨å› ä¸ºæŸäº›åŸå› ï¼ˆå¦‚ `GetLayerTilemaps` è¿”å› nullï¼‰æå‰ returnï¼Œ1+8 å°±ä¸ä¼šè¢«æ›´æ–°ï¼Œè€Œ `LockPosition` çš„ `UpdateCursor` ä»ç„¶ä¼šæ›´æ–°æ¡†çš„ä½ç½® â†’ å‡ºç°"æ¡†åœ¨æ–°ä½ç½®ï¼Œ1+8åœ¨æ—§ä½ç½®"çš„ç°è±¡ã€‚

---

## å››ã€ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ F1ï¼šOnActionComplete å†œç”°å·¥å…·é•¿æŒ‰åˆ†æ”¯ â€” å…ˆè§£é”å†æ‰§è¡Œ

**é—®é¢˜**ï¼š`EndAction(true)` ä¿æŒ `IsLocked = true`ï¼Œå¯¼è‡´åç»­è¿œè·ç¦»å¯¼èˆªæ— æ³•ç§»åŠ¨ã€‚

**æ–¹æ¡ˆ**ï¼šå†œç”°å·¥å…·é•¿æŒ‰åˆ†æ”¯ä¸åº”è¯¥ä½¿ç”¨ `EndAction(true)`ï¼Œè€Œåº”è¯¥ä½¿ç”¨ `EndAction(false)` å®Œå…¨è§£é”ã€‚å› ä¸ºå†œç”°å·¥å…·çš„é•¿æŒ‰ç»­æ¥ä¸æ˜¯"åœ¨åŸåœ°é‡å¤åŠ¨ç”»"ï¼ˆé€šç”¨å·¥å…·çš„è¡Œä¸ºï¼‰ï¼Œè€Œæ˜¯"è·å–æ–°ä½ç½®å¹¶é‡æ–°æ‰§è¡Œå®Œæ•´æµç¨‹"ï¼Œè¿™ä¸ªæµç¨‹å¯èƒ½åŒ…å«å¯¼èˆªã€‚

**ä¿®æ”¹ä½ç½®**ï¼š`PlayerInteraction.cs` â€” `OnActionComplete` æ–¹æ³•

**ä¿®æ”¹å†…å®¹**ï¼š
```csharp
// ä¿®æ”¹å‰ï¼ˆå½“å‰ä»£ç ï¼‰ï¼š
lockManager?.EndAction(true);

// ä¿®æ”¹åï¼š
lockManager?.EndAction(false);  // å†œç”°å·¥å…·éœ€è¦å®Œå…¨è§£é”ï¼Œå› ä¸ºå¯èƒ½è§¦å‘è¿œè·ç¦»å¯¼èˆª
```

**å½±å“åˆ†æ**ï¼š
- `EndAction(false)` ä¼šè®¾ç½® `IsLocked = false`ï¼Œå…è®¸ç©å®¶ç§»åŠ¨
- `ProcessFarmInputAt` â†’ `TryTillSoil` è¿‘è·ç¦»åˆ†æ”¯ä¼šè°ƒç”¨ `RequestAction` â†’ `StartAction` â†’ `BeginAction()` é‡æ–°é”å®š
- `TryTillSoil` è¿œè·ç¦»åˆ†æ”¯å¯åŠ¨å¯¼èˆªåï¼Œ`IsLocked = false`ï¼Œç©å®¶å¯ä»¥è¢«å¯¼èˆªç³»ç»Ÿç§»åŠ¨
- å¯¼èˆªåˆ°è¾¾åå›è°ƒä¸­ `RequestAction` â†’ `BeginAction()` é‡æ–°é”å®š
- **ä¸å½±å“é€šç”¨å·¥å…·**ï¼šé€šç”¨å·¥å…·åˆ†æ”¯ä»ç„¶ä½¿ç”¨ `EndAction(true)` + `StartAction`

**é£é™©**ï¼š`EndAction(false)` åˆ° `ProcessFarmInputAt` ä¹‹é—´æœ‰ä¸€ä¸ªæçŸ­çš„çª—å£ï¼ˆåŒä¸€å¸§å†…ï¼‰ï¼Œ`IsLocked = false`ã€‚ç†è®ºä¸Šç”¨æˆ·æ— æ³•åœ¨è¿™ä¸ªçª—å£å†…åˆ‡æ¢å·¥å…·æ ï¼ˆå› ä¸ºæ˜¯åŒä¸€å¸§åŒæ­¥æ‰§è¡Œï¼‰ã€‚ä½†ä¸ºäº†å®‰å…¨ï¼Œå¯ä»¥åœ¨ `ProcessFarmInputAt` ä¹‹å‰æ‰‹åŠ¨æ¸…é™¤ hotbar ç¼“å­˜ã€‚

### ä¿®å¤ F2ï¼šå¯¼èˆªå¤±è´¥/å–æ¶ˆæ—¶ç¡®ä¿ `lockManager` è§£é”

**é—®é¢˜**ï¼šå³ä½¿ä¿®å¤ F1 åï¼Œå¦‚æœå¯¼èˆªå› å…¶ä»–åŸå› å¤±è´¥ï¼Œ`lockManager` å¯èƒ½ä»å¤„äºé”å®šçŠ¶æ€ã€‚

**æ–¹æ¡ˆ**ï¼šåœ¨ `CancelFarmingNavigation` å’Œ `WaitForNavigationComplete` çš„å¤±è´¥åˆ†æ”¯ä¸­ï¼Œå¢åŠ  `lockManager.ForceUnlock()` ä½œä¸ºå®‰å…¨ç½‘ã€‚

**ä¿®æ”¹ä½ç½®**ï¼š`GameInputManager.cs`

**ä¿®æ”¹å†…å®¹**ï¼š

1. `CancelFarmingNavigation` æœ«å°¾å¢åŠ ï¼š
```csharp
// å®‰å…¨ç½‘ï¼šç¡®ä¿ lockManager ä¹Ÿè§£é”
var lockMgr = ToolActionLockManager.Instance;
if (lockMgr != null && lockMgr.IsLocked)
{
    lockMgr.ForceUnlock();
}
```

2. `WaitForNavigationComplete` å¯¼èˆªå¤±è´¥åˆ†æ”¯ï¼ˆæœ€åçš„ else å—ï¼‰å¢åŠ åŒæ ·çš„å®‰å…¨ç½‘ã€‚

**å½±å“åˆ†æ**ï¼š
- `ForceUnlock()` ä¼šè®¾ç½® `IsLocked = false`, `IsContinuousMode = false`ï¼Œå¹¶æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
- åªåœ¨å¯¼èˆªå–æ¶ˆ/å¤±è´¥æ—¶è§¦å‘ï¼Œä¸å½±å“æ­£å¸¸æµç¨‹
- ä½œä¸ºé˜²å¾¡æ€§ç¼–ç¨‹ï¼Œé˜²æ­¢ä»»ä½•å¼‚å¸¸è·¯å¾„å¯¼è‡´æ°¸ä¹…é”å®š

### ä¿®å¤ F3ï¼šWaitForNavigationComplete åˆ°è¾¾åä¹Ÿéœ€è¦å®‰å…¨è§£é”

**é—®é¢˜**ï¼š`WaitForNavigationComplete` çš„ finally å—åªè§£é”äº† `FarmToolPreview._isLocked`ï¼Œæ²¡æœ‰å¤„ç† `lockManager.IsLocked`ã€‚

**åˆ†æ**ï¼šåˆ°è¾¾åå›è°ƒä¸­ `RequestAction` â†’ `StartAction` â†’ `BeginAction()` ä¼šé‡æ–°é”å®š `lockManager`ï¼Œè¿™æ˜¯æ­£ç¡®çš„ï¼ˆåŠ¨ç”»æœŸé—´éœ€è¦é”å®šï¼‰ã€‚æ‰€ä»¥åˆ°è¾¾åä¸éœ€è¦é¢å¤–è§£é” `lockManager`ã€‚

**ç»“è®º**ï¼šä¿®å¤ F2 çš„å®‰å…¨ç½‘å·²ç»è¦†ç›–äº†å¤±è´¥åœºæ™¯ï¼Œåˆ°è¾¾æˆåŠŸåœºæ™¯ä¸éœ€è¦é¢å¤–å¤„ç†ã€‚

---

## äº”ã€ä¿®å¤æ–¹æ¡ˆæ±‡æ€»

| ç¼–å· | ä¿®å¤å†…å®¹ | æ–‡ä»¶ | æ–¹æ³• | ä¸¥é‡åº¦ |
|------|---------|------|------|--------|
| F1 | `EndAction(true)` â†’ `EndAction(false)` | PlayerInteraction.cs | OnActionComplete | ğŸ”´ è‡´å‘½ |
| F2 | å¯¼èˆªå–æ¶ˆ/å¤±è´¥æ—¶ `ForceUnlock()` å®‰å…¨ç½‘ | GameInputManager.cs | CancelFarmingNavigation + WaitForNavigationComplete | ğŸ”´ è‡´å‘½ |

---

## å…­ã€ä¿®å¤åæ—¶åºéªŒè¯

### 6.1 é•¿æŒ‰é”„å¤´ â€” è¿‘è·ç¦» â†’ è¿‘è·ç¦»ï¼ˆæ­£å¸¸å¾ªç¯ï¼‰
```
ç¬¬ä¸€æ¬¡ç‚¹å‡» â†’ TryTillSoil è¿‘è·ç¦»
  â†’ RequestAction(Crush) â†’ BeginAction() â†’ IsLocked = true
  â†’ ExecuteTillSoil
  â†’ finally: _isExecutingFarming = false, UnlockPosition()
  â†’ åŠ¨ç”»æ’­æ”¾ä¸­ï¼ˆIsLocked = trueï¼‰

OnActionCompleteï¼ˆé•¿æŒ‰ä¸­ï¼‰
  â†’ EndAction(false) â†’ IsLocked = false  â† ğŸ”§ ä¿®å¤ F1
  â†’ isPerformingAction = false
  â†’ ProcessFarmInputAt(é¼ æ ‡ä½ç½®)
    â†’ TryTillSoil è¿‘è·ç¦»
      â†’ RequestAction(Crush) â†’ BeginAction() â†’ IsLocked = true  â† é‡æ–°é”å®š
      â†’ ExecuteTillSoil
      â†’ finally: UnlockPosition()
      â†’ åŠ¨ç”»æ’­æ”¾... å¾ªç¯ç»§ç»­ âœ…
```

### 6.2 é•¿æŒ‰é”„å¤´ â€” è¿‘è·ç¦» â†’ è¿œè·ç¦»ï¼ˆä¹‹å‰å¡æ­»ï¼Œä¿®å¤åæ­£å¸¸ï¼‰
```
ç¬¬ä¸€æ¬¡è¿‘è·ç¦»æ‰§è¡Œå®Œ â†’ åŠ¨ç”»æ’­æ”¾ä¸­

OnActionCompleteï¼ˆé•¿æŒ‰ä¸­ï¼‰
  â†’ EndAction(false) â†’ IsLocked = false  â† ğŸ”§ ä¿®å¤ F1
  â†’ isPerformingAction = false
  â†’ ProcessFarmInputAt(è¿œè·ç¦»é¼ æ ‡ä½ç½®)
    â†’ TryTillSoil è¿œè·ç¦»
      â†’ LockPosition() â†’ _isLocked = trueï¼ˆFarmToolPreviewï¼‰
      â†’ StartFarmingNavigation(targetPos, callback)

HandleMovement æ¯å¸§ï¼š
  â†’ lockManager.IsLocked == false  â† ğŸ”§ ä¿®å¤ F1 çš„æ•ˆæœ
  â†’ autoNavigator.IsActive == true
  â†’ ä¸è¿›å…¥ IsLocked åˆ†æ”¯ï¼Œè¿›å…¥ autoNavigator åˆ†æ”¯
  â†’ å¯¼èˆªæ­£å¸¸æ§åˆ¶ç©å®¶ç§»åŠ¨ âœ…

å¯¼èˆªåˆ°è¾¾ï¼š
  â†’ _isExecutingFarming = true
  â†’ RequestAction(Crush) â†’ BeginAction() â†’ IsLocked = true
  â†’ ExecuteTillSoil
  â†’ finally: _isExecutingFarming = false, UnlockPosition(), _farmNavState = Preview
  â†’ åŠ¨ç”»æ’­æ”¾... å¾ªç¯ç»§ç»­ âœ…
```

### 6.3 å¯¼èˆªå¤±è´¥åœºæ™¯ï¼ˆå®‰å…¨ç½‘ï¼‰
```
å¯¼èˆªå¡æ­»/è¶…æ—¶ â†’ WaitForNavigationComplete æœ€ååˆ†æ”¯
  â†’ UnlockPosition()ï¼ˆFarmToolPreviewï¼‰
  â†’ _farmNavState = Preview

CancelFarmingNavigationï¼ˆå¦‚æœè¢«è°ƒç”¨ï¼‰
  â†’ UnlockPosition()
  â†’ _farmNavState = Preview
  â†’ ForceUnlock()  â† ğŸ”§ ä¿®å¤ F2 å®‰å…¨ç½‘
  â†’ IsLocked = false âœ…
```

### 6.4 é¢„è§ˆæ›´æ–°éªŒè¯
```
ä¿®å¤ F1 åï¼Œè¿œè·ç¦»å¯¼èˆªèƒ½æ­£å¸¸å®Œæˆ â†’ ä¸ä¼šå‡ºç°æ°¸ä¹… _isLocked = true
â†’ UpdateHoePreview ä¸ä¼šè¢« if (_isLocked) return æ°¸ä¹…è·³è¿‡
â†’ 1+8 GhostTilemap æ­£å¸¸è·Ÿéšæ›´æ–° âœ…

å¯¼èˆªæœŸé—´ _isLocked = trueï¼ˆLockPosition è®¾ç½®çš„ï¼‰â†’ 1+8 ä¿æŒåœ¨é”å®šä½ç½®
â†’ è¿™æ˜¯æ­£ç¡®è¡Œä¸ºï¼ˆå¯¼èˆªä¸­é¢„è§ˆåº”è¯¥é”å®šåœ¨ç›®æ ‡ä½ç½®ï¼‰
â†’ å¯¼èˆªå®Œæˆ/å–æ¶ˆå UnlockPosition â†’ 1+8 æ¢å¤è·Ÿéš âœ…
```

---

## ä¸ƒã€EndAction(true) vs EndAction(false) å¯¹æ¯”åˆ†æ

| åœºæ™¯ | EndAction(true)ï¼ˆå½“å‰ï¼‰ | EndAction(false)ï¼ˆä¿®å¤åï¼‰ |
|------|------------------------|--------------------------|
| IsLocked | ä¿æŒ true | è®¾ä¸º false |
| åŠ¨ç”»é—´éš™åˆ‡æ¢å·¥å…· | âœ… é˜»æ­¢ï¼ˆIsLocked=trueï¼‰ | âš ï¸ ç†è®ºä¸Šæœ‰æçŸ­çª—å£ |
| è¿œè·ç¦»å¯¼èˆª | ğŸ”´ å¡æ­» | âœ… æ­£å¸¸ |
| è¿‘è·ç¦»è¿ç»­ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ï¼ˆBeginAction é‡æ–°é”å®šï¼‰ |

**å…³äº"åŠ¨ç”»é—´éš™åˆ‡æ¢å·¥å…·"çš„é£é™©**ï¼š
- `EndAction(false)` åˆ° `ProcessFarmInputAt` â†’ `TryTillSoil` â†’ `RequestAction` â†’ `BeginAction()` ä¹‹é—´æ˜¯åŒä¸€å¸§åŒæ­¥æ‰§è¡Œ
- ç”¨æˆ·æ— æ³•åœ¨åŒä¸€å¸§å†…å®Œæˆå·¥å…·åˆ‡æ¢æ“ä½œ
- å³ä½¿æœ‰ hotbar ç¼“å­˜ï¼Œ`EndAction(true)` åŸæœ¬å°±ä¼š `ClearHotbarCache()`ï¼Œè€Œ `EndAction(false)` å `ClearAllCache()` ä¹Ÿä¼šæ¸…é™¤
- **é£é™©æä½ï¼Œå¯ä»¥å¿½ç•¥**

---

## å…«ã€éœ€è¦ç”¨æˆ·ç¡®è®¤çš„é—®é¢˜

### Q1ï¼šæ˜¯å¦åŒæ„ä¿®å¤æ–¹æ¡ˆ F1 + F2ï¼Ÿ

- F1ï¼šå°†å†œç”°å·¥å…·é•¿æŒ‰åˆ†æ”¯çš„ `EndAction(true)` æ”¹ä¸º `EndAction(false)`
- F2ï¼šåœ¨å¯¼èˆªå–æ¶ˆ/å¤±è´¥æ—¶å¢åŠ  `ForceUnlock()` å®‰å…¨ç½‘

è¿™ä¸¤ä¸ªä¿®å¤æ˜¯æœ€å°åŒ–æ”¹åŠ¨ï¼Œåªä¿®æ”¹äº† `EndAction` çš„å‚æ•°å’Œå¢åŠ äº†å®‰å…¨ç½‘ï¼Œä¸æ”¹å˜æ•´ä½“æ¶æ„ã€‚

### Q2ï¼šæ˜¯å¦éœ€è¦é¢å¤–çš„é˜²æŠ¤æªæ–½ï¼Ÿ

æ¯”å¦‚åœ¨ `ProcessFarmInputAt` ä¹‹å‰æ‰‹åŠ¨æ¸…é™¤ hotbar ç¼“å­˜ï¼Œé˜²æ­¢æç«¯æƒ…å†µä¸‹çš„å·¥å…·åˆ‡æ¢ã€‚
