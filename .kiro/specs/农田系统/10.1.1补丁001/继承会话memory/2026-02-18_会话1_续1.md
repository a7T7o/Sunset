# 继承快照 - 会话1续1

## 用户 prompt 完整摘抄

这里的crush移除你确定判断完全了吗？镐子是需要连续挖矿的，只有锄头和洒水壶会需要这些处理，也就是其他的还是和之前的设计一致即可，你懂了吗？然后你刚刚停止了，你的分析报告没有写完让我把他移到了.kiro\specs\农田系统\10.1.1补丁001，我希望在这个子工作区完成我们当前的漏洞修补，请你先重新考虑我说的情况再继续写完文档

## AI 进度摘要

**已完成**：
- 重新读取所有关键代码文件（GameInputManager/PlayerInteraction/FarmToolPreview/FarmlandBorderManager）
- 验证 ResolveAction 映射：Pickaxe→Crush, Hoe→Crush（确认镐子用 Crush 且需要长按连续）
- 修正漏洞 B-1 分析：不能从 IsToolAction 移除 Crush，改为在 OnActionComplete 长按分支中按手持工具类型判断
- 完成全面交互漏洞分析报告（7 大部分，写入 10.1.1补丁001/全面交互漏洞分析报告.md）
- 报告包含：架构概述、4 个问题深度分析、23 个交互矩阵场景、方案 D/E 审视、修正方案汇总、Q1-Q4 待确认问题、漏洞严重度汇总

**未完成**：
- 等待用户回复 Q1-Q4 确认
- 根据用户确认调整方案
- 创建 requirements.md / design.md / tasks.md（如需要）
- 执行代码修改
- 更新主 memory

## 修改文件列表

| 文件 | 操作 | 说明 |
|------|------|------|
| `全面交互漏洞分析报告.md` | 新建+修改 | 7 部分完整分析报告（从 10.1.0 移入后修正 B-1 并补全剩余部分） |

## 本轮关键决策与用户偏好

**用户核心纠正**：
1. **Crush 不能移除**：镐子（Pickaxe）也映射到 Crush，且镐子需要长按连续挖矿
2. **只有锄头和洒水壶需要特殊处理**：其他工具保持原有长按行为
3. **工作区迁移**：用户将分析报告从 10.1.0 移到新工作区 10.1.1补丁001

**方案 B 修正方向**：
- 不修改 IsToolAction（保留 Crush）
- 在 OnActionComplete 长按分支中，检查当前手持物品是否是农田工具（Hoe/WateringCan/Seed）
- 农田工具 → 不先 StartAction，直接消费缓存或执行操作
- 通用工具（镐子/斧头等）→ 保持原有 StartAction 重播动画行为

## 关联文件与待同步状态

| 文件 | 状态 |
|------|------|
| `GameInputManager.cs` | 已读取完整（CacheFarmInput/ConsumePendingFarmInput/ProcessFarmInputAt/HandleUseCurrentTool/TryTillSoil/TryWaterTile/TryPlantSeed/HandleMovement/CancelFarmingNavigation/ResolveAction 等） |
| `PlayerInteraction.cs` | 已读取完整（OnActionComplete/IsToolAction/StartAction） |
| `FarmToolPreview.cs` | 已读取完整（UpdateHoePreview/UpdateWateringPreview/LockPosition/UnlockPosition/UpdateRealtimeData） |
| `FarmlandBorderManager.cs` | 已读取 GetPreviewTiles |
| `全面交互漏洞分析报告.md` | ✅ 完成，待用户审核 |

## 遗留问题完整上下文

### 5 个修正方案（互相配合形成闭环）

- **方案 A 修正版**：CacheFarmInput 中先 UnlockPosition → ForceUpdatePreviewToPosition（刷新 1+8）→ LockPosition
- **方案 B 修正版**：OnActionComplete 长按分支区分农田工具（不先 StartAction）和通用工具（保持原有 StartAction）
- **方案 C**：已合并到方案 B 修正版（浇水与锄头统一处理）
- **方案 D**：ConsumePendingFarmInput 中先 UnlockPosition
- **方案 E 修正版**：CancelFarmingNavigation + HandleMovement 中清除 _hasPendingFarmInput

### 待用户确认的 4 个问题

- Q1：锄头长按行为（不继续 vs 忽略）
- Q2：浇水长按行为（是否支持连续浇水）
- Q3：种子长按行为（是否支持连续种植）
- Q4：动画期间切换工具栏后缓存消费时序（丢弃 vs 以新工具执行）
