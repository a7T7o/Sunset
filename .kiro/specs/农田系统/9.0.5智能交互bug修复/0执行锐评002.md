**CODE REAPER STATUS:**
**AUDIT COMPLETE.**
**VERDICT: APPROVED WITH A CRITICAL PATCH (方案总体通过，但在逻辑闭环上发现一处致命盲区).**

老大，Kiro 这次的《全面反思》和三件套文档（Requirements/Design/Tasks）质量非常高。
他终于摆脱了“补丁思维”，转而使用 **状态机 (State Machine)** 来重构交互。这是从“写功能”到“设计系统”的质变。
他精准地捕捉到了“预览锁定”、“中断恢复”、“快照安全”这三个核心支柱。

**但是**，在他构建的看似完美的逻辑堡垒中，我那“最锐利的眼光”发现了一个**极其隐蔽但致命的逻辑死结**。如果不解开这个结，9.0.5 上线后玩家会感觉手感极度僵硬。

以下是我的深度分析与修正指令。

---

### 💀 致命盲区：导航中的“盲人摸象” (The Blind Navigation Paradox)

#### 1. 问题定位

Kiro 在 `design.md` 和 `tasks.md` (Task 1.2, 3.1) 中设计了如下逻辑：

* **逻辑 A**: 当状态为 `Locked` 或 `Navigating` 时，`UpdatePreviews()` **不再更新** `FarmToolPreview` 的位置和状态（为了保持视觉锁定）。
* **逻辑 B**: `HandleUseCurrentTool()` 依赖 `FarmToolPreview` 的数据（如 `CurrentCellPos`, `IsValid`）来处理点击。

#### 2. 场景推演 (The Crash Scenario)

想象玩家的操作：

1. 玩家点击 A 点。状态变为 `Navigating`。预览框**锁定**在 A 点。
2. `UpdatePreviews()` 检测到锁定，**停止更新**。此时 `FarmToolPreview.CurrentCellPos` **永久停留在 A 点**。
3. 玩家在走路过程中，突然后悔了，鼠标移到了 B 点（也是一块合法的地），并点击了左键（试图改道去 B）。
4. **Bug 爆发**：
* `HandleUseCurrentTool` 被触发。
* 它去问 `FarmToolPreview`：“我现在指的是哪里？”
* `FarmToolPreview` 回答：“我还是指着 A 点。”（因为 `UpdatePreviews` 没更新数据）。
* 结果：**玩家明明点击了 B，角色却仅仅是确认了一下“继续去 A”。** 玩家无法中途改道！



#### 3. 结论

Kiro 的设计为了实现 **“视觉锁定”**，错误地导致了 **“数据冻结”**。
这会让交互变得“不可打断”或“不可重定向”，手感极差。

---

### ⚔️ 修正指令：视觉与数据分离 (VISUAL-DATA SEPARATION)

**To Kiro:**
Code Reaper 已验收你的设计。**架构方向完全正确**，状态机思路清晰。
但你犯了一个经典错误：**混淆了“显示层”与“逻辑层”**。

你为了让绿框不乱跑（显示层），让整个预览组件的数据停止了更新（逻辑层）。这导致你在导航过程中“瞎了”。

**立即执行以下修正 (Mandatory Patch):**

#### 1. 分离“锁定目标”与“实时鼠标”

在 `FarmToolPreview.cs` 中，不能只有一套数据。你需要两套：

* **Visual/Locked Data**: `_lockedCellPos`, `_lockedLayerIndex`。这是给 `GhostTilemap` 渲染用的，锁定时不变。
* **Input/Realtime Data**: `CurrentCellPos`, `CurrentLayerIndex`, `IsValid`。这是给 `GameInputManager` 每一帧做判断用的，**必须永远跟随鼠标实时更新**。

#### 2. 修正 `UpdatePreviews` 逻辑

`UpdatePreviews` **不能 return**。它必须跑完一半逻辑。

```csharp
public void UpdateHoePreview(...) {
    // 1. 永远计算当前鼠标下的数据 (Realtime Data)
    CalculateCurrentCellData(); 
    IsInRange = ...;
    IsValid = ...;

    // 2. 只有在未锁定时，才更新视觉 (Visuals)
    if (!_isLocked) {
        UpdateGhostTilemapPosition();
        UpdateCursorPosition();
    }
    // 注意：如果是 Locked 状态，这里就不动 GhostTilemap，保持视觉锁定
}

```

#### 3. 修正点击处理 (`GameInputManager`)

在 `Navigating` 状态下处理点击时：

* 不要读取 `Locked` 数据，要读取 `Realtime` 数据。
* 如果点击了新的位置（且 Valid），则 **Cancel Current Navigation -> Start New Navigation**。

---

### 🛡️ 其他注意事项 (MINOR ALERTS)

1. **执行中的 Input 封锁**:
Task 5.1 提到了 `_isExecutingFarming`。请确保这个状态下不仅屏蔽点击，还要屏蔽 **WASD 移动**（除非 `PlayerInteraction` 已经处理了）。否则玩家会在锄地动画播放时产生“太空步”滑行。
2. **中断恢复的原子性**:
Task 4.2 提到 `UnlockPosition`。请确保无论导航是成功、失败、超时还是被强杀，`UnlockPosition` **一定**会被调用。建议放在 `finally` 块或统一的 `ResetState` 方法中。

---

**Code Reaper Verdict:**
Kiro，你的 9.0.5 方案是目前为止最成熟的方案。
只要修补上我指出的这个 **“盲人导航”漏洞**，这套系统就完美了。

**Execute.**