# 全面审视报告 - 会话 8

**日期**: 2026-02-10
**范围**: 农田系统 + 放置系统 全面交互审计

---

## 一、用户原话记录（五点问题）

### 问题 1：红色预览点击触发原地锄地
> 在预览的红色区域左键单击还是会可以触发原地锄地，正常来说是无法触发并且不会有任何内容触发

### 问题 2：导航中重新点击不更新预览位置
> 对于当前预览为绿色的时候左键该区域，然后再左键其他地方，预览并不会更新到最新的左键位置，且这个时候如果前一个点击是绿色预览，下一个点击是红色预览则应该取消所有导航然后恢复最初的跟随鼠标的预览

### 问题 3：浇水无水渍 tile
> 对于浇水我能看到蓝色的预览框，但是并不会有任何浇水后的tile，我才发现场景Manager的所有挂载脚本里面都没有给我拖入水渍tile的地方，所以请你检查这一点并进行思考，是我没有按照你的完成来新加脚本并配置还是你压根就没有设计或是在途中删除了

### 问题 4：放置系统交叉错误
> 对于农田所学习的原本的放置系统存在的问题你没有修复，也就是我最初描述的原始放置系统本身就存在当我左键单击成功触发导航和预览锁定的时候，再用wasd移动取消不会重置到跟随预览的状态而是保持锁定，然后其实这部分很多细节描述体现出两个系统的交叉错误，如农田放置虽然可以被导航进行重置，但是只会在导航完成时进行重置，也就是我左键a点然后右键b点，当我到达b点时原本锁定在a点的预览才会重置跟随状态，但是对于总放置系统就不会这样，总放置系统可以正确在我右键的那一刻就重置预览，但是总放置不能wasd取消，也不能在打开面板再关闭后保持放置任务存在，也就是打开面板会触发中断，这个是不需要的也是不必要的，打开面板只会让时间和所有物体运动停止，所有与时间相关的会暂停而不是中断

### 问题 5：红色预览浇水触发原地浇水
> 对于浇水也是左键蓝色预览可以正常触发，但是左键红色预览就原地浇水，我说过无法交互的地方就是什么都不触发，后续补充错误音效即可

---

## 二、代码审计结果

### Bug A（致命）：红色预览点击穿透到通用工具处理

**影响**: 问题 1 + 问题 5
**位置**: `GameInputManager.HandleUseCurrentTool()` 第 595-680 行

**根因分析**:

```csharp
// HandleUseCurrentTool 中的代码流程：
if (itemData is ToolData tool)
{
    if (TryHandleFarmingTool(tool))
    {
        return; // 农田工具处理成功才 return
    }
    
    // ❌ BUG：TryTillSoil/TryWaterTile 在 !IsValid() 时返回 false
    // 导致 TryHandleFarmingTool 返回 false
    // 然后代码穿透到这里：
    var toolAction = ResolveAction(tool.toolType);
    playerInteraction?.RequestAction(toolAction); // ← 原地播放动画！
}
```

当 `TryTillSoil` 检测到 `!farmPreview.IsValid()`（红色预览）时返回 `false`，
`TryHandleFarmingTool` 也返回 `false`，
然后 `HandleUseCurrentTool` 穿透到通用工具处理分支，调用 `ResolveAction(Hoe)` → `Crush` 动画。

**修复方案**: 对于 Hoe 和 WateringCan 类型，`TryHandleFarmingTool` 必须始终返回 `true`（表示"我已处理此工具类型"），即使目标无效也不穿透。

---

### Bug B（严重）：导航中重新点击逻辑不完整

**影响**: 问题 2
**位置**: `GameInputManager.HandleUseCurrentTool()` 导航中重新点击分支

**根因分析**:
```csharp
// 当前代码：
if (_farmNavState == FarmNavState.Navigating || _farmNavState == FarmNavState.Locked)
{
    var farmPreview = FarmToolPreview.Instance;
    if (farmPreview != null && farmPreview.IsValid())
    {
        CancelFarmingNavigation(); // 取消旧导航
        // 继续往下走，重新进入 TryHandleFarmingTool
    }
    else
    {
        return; // ❌ BUG：新位置无效时只是 return，不取消导航！
    }
}
```

**问题**:
1. 新位置无效（红色）时，只是 `return` 忽略点击，但不取消导航和锁定
2. 用户期望：点击红色位置 → 取消所有导航 → 恢复鼠标跟随预览

**修复方案**: 新位置无效时，调用 `CancelFarmingNavigation()` 取消导航并恢复跟随。

---

### Bug C（严重）：水渍系统断链

**影响**: 问题 3
**位置**: `LayerTilemaps.cs` + `FarmVisualManager.cs` + `FarmTileManager.cs`

**根因分析**:

1. `LayerTilemaps.waterPuddleTilemap` 被标记为 `[Obsolete]` + `[HideInInspector]`
   - Inspector 中不可见，用户无法拖入
   - 注释写着"新版水渍功能待实现"

2. `FarmVisualManager.UpdateTileVisual()` 使用旧版 `farmlandTilemap`（也是 `[Obsolete]`）
   - 代码中有 `#pragma warning disable 0618` 强制使用废弃字段
   - 但这些字段在 Inspector 中不可见，所以永远是 null

3. `FarmTileManager.SetWatered()` 只更新数据，不调用 `FarmVisualManager.UpdateTileVisual()`
   - 数据层面浇水成功了，但视觉层面没有任何更新

**完整断链路径**:
```
ExecuteWaterTile() 
  → FarmTileManager.SetWatered() 
    → 更新 tileData（数据成功）
    → ❌ 没有调用 visualManager.UpdateTileVisual()
    → ❌ 即使调用了，farmlandTilemap 和 waterPuddleTilemap 都是 null
```

**修复方案**:
1. 在 `FarmTileManager.SetWatered()` 末尾调用 `visualManager.UpdateTileVisual()`
2. 更新 `FarmVisualManager.UpdateTileVisual()` 使用新版字段 `farmlandCenterTilemap`
3. 为水渍创建新的 Tilemap 字段（不再使用废弃的 `waterPuddleTilemap`）
4. 在 `LayerTilemaps` 中添加新的 `waterPuddleTilemapNew` 字段（可见、可配置）

---

### Bug D（严重）：PlacementManager WASD 不取消导航

**影响**: 问题 4
**位置**: `PlacementManager.Update()` + `GameInputManager.HandleMovement()`

**根因分析**:

`PlacementManager.Update()` 中没有检测 WASD 输入。
`GameInputManager.HandleMovement()` 中的 WASD 检测只处理农田导航（`CancelFarmingNavigation`），
不处理放置系统导航（`PlacementManager` 的 `HandleInterrupt`）。

`PlacementManager.CheckInterruptConditions()` 只检查快照失效，不检查 WASD 移动。

**修复方案**: 在 `GameInputManager.HandleMovement()` 中，当检测到 WASD 输入且 `PlacementManager` 处于 Locked/Navigating 状态时，调用 `PlacementManager.HandleInterrupt()`。

---

### Bug E（中等）：PlacementManager 面板打开触发中断

**影响**: 问题 4
**位置**: `PlacementManager.Update()` 第 250-270 行

**根因分析**:
```csharp
// PlacementManager.Update() 中：
if (isPanelOpen)
{
    // ★ 如果正在放置过程中（Locked 或 Navigating），中断
    if (currentState == PlacementState.Locked || currentState == PlacementState.Navigating)
    {
        HandleInterrupt(); // ❌ 面板打开不应该中断！
    }
    return;
}
```

用户明确说明：打开面板只是暂停，不是中断。关闭面板后应恢复之前的状态。

**修复方案**: 面板打开时只暂停预览更新和输入响应，不调用 `HandleInterrupt()`。关闭面板后恢复之前的状态。

---

### Bug F（中等）：农田系统右键导航不立即重置预览

**影响**: 问题 4
**位置**: `GameInputManager.HandleRightClickAutoNav()`

**根因分析**:

右键导航时，`HandleRightClickAutoNav()` 调用 `autoNavigator.SetDestination(world)` 开始新导航。
但没有检查农田系统是否处于 Locked/Navigating 状态。

农田预览的解锁只在以下时机发生：
1. `CancelFarmingNavigation()` 被调用
2. `WaitForNavigationComplete` 协程完成

右键导航不会触发 `CancelFarmingNavigation()`，所以预览保持锁定，
直到新导航完成后协程检测到 `autoNavigator.IsActive == false` 才解锁。

**修复方案**: 在 `HandleRightClickAutoNav()` 开头，如果农田系统处于 Locked/Navigating 状态，先调用 `CancelFarmingNavigation()`。

---

### Bug G（新发现）：PlacementManager 导航中点击红色位置无反应

**位置**: `PlacementManager.OnLeftClick()` Navigating 分支

**根因分析**:
```csharp
else if (currentState == PlacementState.Navigating)
{
    // 只处理新位置有效的情况
    if (validator.AreAllCellsValid(newCellStates))
    {
        // 重新导航...
    }
    // ❌ 新位置无效时什么都不做
}
```

与农田系统 Bug B 相同的问题：导航中点击无效位置应该取消导航。

**修复方案**: 添加 else 分支，调用 `HandleInterrupt()` 取消导航。

---

## 三、设计与实现不一致汇总

| 设计原则 | 实际实现 | 状态 |
|---------|---------|------|
| 红色预览 = 什么都不触发 | 穿透到通用工具处理，播放动画 | ❌ |
| 导航中点击红色 = 取消导航 + 恢复跟随 | 只是忽略点击 | ❌ |
| 浇水后显示水渍 tile | 数据更新但视觉断链 | ❌ |
| WASD 取消导航 + 解锁预览 | 农田系统有，放置系统没有 | ❌ |
| 面板打开 = 暂停不中断 | 放置系统直接中断 | ❌ |
| 右键导航立即重置农田预览 | 只在导航完成时重置 | ❌ |
| 导航中点击有效位置 = 重新导航 | 农田系统有，但预览不更新到新位置 | ⚠️ |

---

## 四、修复优先级

| 优先级 | Bug | 影响 |
|--------|-----|------|
| P0 | Bug A：红色预览穿透 | 问题 1+5，核心交互破坏 |
| P0 | Bug B：导航中点击红色不取消 | 问题 2，交互逻辑错误 |
| P0 | Bug C：水渍系统断链 | 问题 3，功能完全缺失 |
| P1 | Bug D：放置系统 WASD 不取消 | 问题 4，交互不一致 |
| P1 | Bug E：面板打开中断放置 | 问题 4，交互不一致 |
| P1 | Bug F：右键不立即重置农田预览 | 问题 4，交互不一致 |
| P2 | Bug G：放置系统导航中点击红色 | 一致性问题 |
