# å†œç”°ç³»ç»Ÿäº¤äº’å®ç°å…¨é¢åæ€

**åˆ›å»ºæ—¥æœŸ**: 2026-02-09
**åæ€ç›®çš„**: å¯¹ç…§æ”¾ç½®ç³»ç»Ÿï¼Œæ·±åº¦å‰–æå†œç”°ç³»ç»Ÿäº¤äº’å®ç°çš„æ‰€æœ‰é—®é¢˜

---

## ä¸€ã€æ ¸å¿ƒé—®é¢˜ï¼šç¼ºä¹ç»Ÿä¸€çš„çŠ¶æ€æœº

### æ”¾ç½®ç³»ç»Ÿçš„çŠ¶æ€æœºï¼ˆæ­£ç¡®ç¤ºèŒƒï¼‰

```
PlacementState:
  Idle       â†’ ç©ºé—²ï¼Œæ— é¢„è§ˆ
  Preview    â†’ é¢„è§ˆè·Ÿéšé¼ æ ‡
  Locked     â†’ ä½ç½®é”å®šï¼Œç­‰å¾…å¯¼èˆª/æ‰§è¡Œ
  Navigating â†’ å¯¼èˆªä¸­
```

**å…³é”®ç‰¹æ€§**ï¼š
1. **çŠ¶æ€æ¸…æ™°**ï¼šæ¯ä¸ªçŠ¶æ€æœ‰æ˜ç¡®çš„èŒè´£å’Œè½¬æ¢æ¡ä»¶
2. **é¢„è§ˆé”å®š**ï¼šç‚¹å‡»åé¢„è§ˆå›ºå®šåœ¨ç›®æ ‡ä½ç½®ï¼Œä¸å†è·Ÿéšé¼ æ ‡
3. **ä¸­æ–­æ¢å¤**ï¼šå–æ¶ˆå¯¼èˆªåï¼Œé¢„è§ˆè§£é”ï¼Œæ¢å¤è·Ÿéšé¼ æ ‡
4. **å¿«ç…§æœºåˆ¶**ï¼šé”å®šæ—¶åˆ›å»ºå¿«ç…§ï¼Œè®°å½•ç‰©å“ä¿¡æ¯ï¼Œé˜²æ­¢"ç§ç“œå¾—è±†"

### å†œç”°ç³»ç»Ÿçš„çŠ¶æ€æœºï¼ˆå½“å‰å®ç°ï¼‰

```
FarmNavState:
  Idle       â†’ ç©ºé—²
  Navigating â†’ å¯¼èˆªä¸­
  Executing  â†’ æ‰§è¡Œä¸­
```

**ä¸¥é‡ç¼ºé™·**ï¼š
1. âŒ **ç¼ºå°‘ Preview çŠ¶æ€**ï¼šæ²¡æœ‰"é¢„è§ˆè·Ÿéšé¼ æ ‡"çš„æ¦‚å¿µ
2. âŒ **ç¼ºå°‘ Locked çŠ¶æ€**ï¼šç‚¹å‡»åé¢„è§ˆä¸ä¼šé”å®š
3. âŒ **é¢„è§ˆå§‹ç»ˆè·Ÿéšé¼ æ ‡**ï¼šå¯¼èˆªè¿‡ç¨‹ä¸­é¢„è§ˆä»åœ¨è·Ÿéšï¼Œé€ æˆè§†è§‰æ··ä¹±
4. âŒ **çŠ¶æ€è½¬æ¢ä¸å®Œæ•´**ï¼šæ²¡æœ‰ä» Navigating å›åˆ° Preview çš„è·¯å¾„

---

## äºŒã€é¢„è§ˆç³»ç»Ÿçš„è‡´å‘½ç¼ºé™·

### æ”¾ç½®ç³»ç»Ÿçš„é¢„è§ˆæœºåˆ¶ï¼ˆæ­£ç¡®ç¤ºèŒƒï¼‰

```csharp
// PlacementPreview.cs
public void LockPosition()
{
    isLocked = true;
    lockedPosition = currentPosition;
}

public void UnlockPosition()
{
    isLocked = false;
}

public void UpdatePosition(Vector3 mousePos)
{
    if (isLocked) return; // é”å®šçŠ¶æ€ä¸æ›´æ–°ä½ç½®
    currentPosition = SnapToGrid(mousePos);
}
```

**å…³é”®ç‰¹æ€§**ï¼š
1. **é”å®šæœºåˆ¶**ï¼š`LockPosition()` / `UnlockPosition()`
2. **æ¡ä»¶æ›´æ–°**ï¼šé”å®šçŠ¶æ€ä¸‹ `UpdatePosition` ä¸ç”Ÿæ•ˆ
3. **ä½ç½®ç¼“å­˜**ï¼š`lockedPosition` è®°å½•é”å®šæ—¶çš„ä½ç½®

### å†œç”°ç³»ç»Ÿçš„é¢„è§ˆæœºåˆ¶ï¼ˆå½“å‰å®ç°ï¼‰

```csharp
// FarmToolPreview.cs
// âŒ æ²¡æœ‰é”å®šæœºåˆ¶ï¼
// âŒ æ²¡æœ‰ LockPosition / UnlockPosition æ–¹æ³•ï¼
// âŒ é¢„è§ˆå§‹ç»ˆè·Ÿéšé¼ æ ‡ï¼
```

**ä¸¥é‡ç¼ºé™·**ï¼š
1. âŒ **æ— é”å®šæœºåˆ¶**ï¼š`FarmToolPreview` æ²¡æœ‰ `LockPosition()` æ–¹æ³•
2. âŒ **æ— ä½ç½®ç¼“å­˜**ï¼šæ²¡æœ‰ `lockedPosition` å­—æ®µ
3. âŒ **å¯¼èˆªæ—¶é¢„è§ˆä¹±è·³**ï¼šç©å®¶å¯¼èˆªè¿‡ç¨‹ä¸­ï¼Œé¢„è§ˆä»è·Ÿéšé¼ æ ‡ç§»åŠ¨
4. âŒ **è§†è§‰åé¦ˆæ··ä¹±**ï¼šç”¨æˆ·ä¸çŸ¥é“ç›®æ ‡ä½ç½®åœ¨å“ª

---

## ä¸‰ã€å¿«ç…§æœºåˆ¶çš„ä¸å®Œæ•´

### æ”¾ç½®ç³»ç»Ÿçš„å¿«ç…§æœºåˆ¶ï¼ˆæ­£ç¡®ç¤ºèŒƒï¼‰

```csharp
// PlacementManager.cs
private struct PlacementSnapshot
{
    public int itemId;
    public int quality;
    public int slotIndex;
    public Vector3 lockedPosition;
    public bool isValid;
}

private void LockPreviewPosition()
{
    placementPreview.LockPosition();
    ChangeState(PlacementState.Locked);
    currentSnapshot = CreateSnapshot(); // åˆ›å»ºå¿«ç…§
    
    if (!currentSnapshot.isValid)
    {
        HandleInterrupt();
        return;
    }
    // ...
}

private bool ValidateSnapshot()
{
    if (!currentSnapshot.isValid) return false;
    var slot = inventoryService.GetSlot(currentSnapshot.slotIndex);
    if (slot.IsEmpty) return false;
    if (slot.itemId != currentSnapshot.itemId) return false;
    if (slot.quality != currentSnapshot.quality) return false;
    return true;
}
```

**å…³é”®ç‰¹æ€§**ï¼š
1. **å®Œæ•´å¿«ç…§**ï¼šè®°å½• itemIdã€qualityã€slotIndexã€lockedPosition
2. **åˆ›å»ºæ—¶æœº**ï¼šé”å®šä½ç½®æ—¶ç«‹å³åˆ›å»º
3. **éªŒè¯æ—¶æœº**ï¼šæ‰§è¡Œå‰ã€å¯¼èˆªä¸­ã€äº‹ä»¶å›è°ƒæ—¶
4. **å¤±æ•ˆå¤„ç†**ï¼šå¿«ç…§å¤±æ•ˆæ—¶è°ƒç”¨ `HandleInterrupt()`

### å†œç”°ç³»ç»Ÿçš„å¿«ç…§æœºåˆ¶ï¼ˆå½“å‰å®ç°ï¼‰

```csharp
// GameInputManager.cs
private struct FarmingSnapshot
{
    public int itemId;
    public int slotIndex;
    public int count;
    public bool isValid;
    // âŒ ç¼ºå°‘ lockedPositionï¼
    // âŒ ç¼ºå°‘ qualityï¼
}
```

**ä¸¥é‡ç¼ºé™·**ï¼š
1. âŒ **ç¼ºå°‘ä½ç½®ä¿¡æ¯**ï¼šå¿«ç…§ä¸è®°å½•é”å®šä½ç½®
2. âŒ **ç¼ºå°‘å“è´¨ä¿¡æ¯**ï¼šå¿«ç…§ä¸è®°å½•ç‰©å“å“è´¨
3. âŒ **åˆ›å»ºæ—¶æœºä¸å¯¹**ï¼šåœ¨å¯¼èˆªå¼€å§‹æ—¶æ‰åˆ›å»ºï¼Œè€Œéé”å®šæ—¶
4. âŒ **éªŒè¯ä¸å®Œæ•´**ï¼šåªéªŒè¯ itemIdï¼Œä¸éªŒè¯ä½ç½®

---

## å››ã€ä¸­æ–­å¤„ç†çš„ç¼ºå¤±

### æ”¾ç½®ç³»ç»Ÿçš„ä¸­æ–­å¤„ç†ï¼ˆæ­£ç¡®ç¤ºèŒƒï¼‰

```csharp
// PlacementManager.cs
private void HandleInterrupt()
{
    // 1. å–æ¶ˆå¯¼èˆª
    if (navigator != null && navigator.IsNavigating)
        navigator.CancelNavigation();
    
    // 2. æ¸…é™¤å¿«ç…§
    currentSnapshot = PlacementSnapshot.Invalid;
    
    // 3. è§£é”é¢„è§ˆï¼Œæ¢å¤è·Ÿéšé¼ æ ‡
    if (placementPreview != null)
    {
        placementPreview.UnlockPosition();
        if (!placementPreview.gameObject.activeSelf)
            placementPreview.gameObject.SetActive(true);
    }
    
    // 4. è¿”å› Preview çŠ¶æ€
    if (currentState != PlacementState.Idle && currentPlacementItem != null)
        ChangeState(PlacementState.Preview);
}
```

**å…³é”®ç‰¹æ€§**ï¼š
1. **å®Œæ•´æ¸…ç†**ï¼šå–æ¶ˆå¯¼èˆª + æ¸…é™¤å¿«ç…§ + è§£é”é¢„è§ˆ
2. **çŠ¶æ€æ¢å¤**ï¼šå›åˆ° Preview çŠ¶æ€ï¼Œé¢„è§ˆæ¢å¤è·Ÿéšé¼ æ ‡
3. **è§†è§‰è¿ç»­**ï¼šç”¨æˆ·å¯ä»¥ç»§ç»­é€‰æ‹©æ–°ä½ç½®

### å†œç”°ç³»ç»Ÿçš„ä¸­æ–­å¤„ç†ï¼ˆå½“å‰å®ç°ï¼‰

```csharp
// GameInputManager.cs
private void CancelFarmingNavigation()
{
    if (_farmNavState == FarmNavState.Idle) return;
    
    // å–æ¶ˆåç¨‹
    if (_farmingNavigationCoroutine != null)
    {
        StopCoroutine(_farmingNavigationCoroutine);
        _farmingNavigationCoroutine = null;
    }
    
    // å–æ¶ˆå¯¼èˆª
    if (autoNavigator != null && autoNavigator.IsActive)
        autoNavigator.ForceCancel();
    
    // æ¸…é™¤çŠ¶æ€
    _farmNavState = FarmNavState.Idle;
    _farmNavigationAction = null;
    _cachedSeedData = null;
    ClearSnapshot();
    
    // âŒ æ²¡æœ‰è§£é”é¢„è§ˆï¼
    // âŒ æ²¡æœ‰æ¢å¤é¢„è§ˆè·Ÿéšé¼ æ ‡ï¼
    // âŒ é¢„è§ˆçŠ¶æ€ä¸å˜ï¼
}
```

**ä¸¥é‡ç¼ºé™·**ï¼š
1. âŒ **ä¸è§£é”é¢„è§ˆ**ï¼šå› ä¸ºæ ¹æœ¬æ²¡æœ‰é”å®šæœºåˆ¶
2. âŒ **ä¸æ¢å¤é¢„è§ˆ**ï¼šé¢„è§ˆçŠ¶æ€ä¸å˜ï¼Œå¯èƒ½ä»æ˜¾ç¤ºæ—§ä½ç½®
3. âŒ **çŠ¶æ€ä¸è¿ç»­**ï¼šå–æ¶ˆåç”¨æˆ·éœ€è¦é‡æ–°æ“ä½œ

---

## äº”ã€äº‹ä»¶è®¢é˜…çš„ç¼ºå¤±

### æ”¾ç½®ç³»ç»Ÿçš„äº‹ä»¶è®¢é˜…ï¼ˆæ­£ç¡®ç¤ºèŒƒï¼‰

```csharp
// PlacementManager.cs
private void Start()
{
    // è®¢é˜…æ‰‹æŒç‰©å“åˆ‡æ¢äº‹ä»¶
    if (hotbarSelection != null)
        hotbarSelection.OnSelectedChanged += OnHotbarSelectionChanged;
    
    // è®¢é˜…èƒŒåŒ…æ§½ä½å˜åŒ–äº‹ä»¶
    if (inventoryService != null)
        inventoryService.OnSlotChanged += OnInventorySlotChanged;
}

private void OnHotbarSelectionChanged(int newIndex)
{
    if (isExecutingPlacement) return; // æ‰§è¡Œä¸­å¿½ç•¥
    
    if (currentState == PlacementState.Locked || currentState == PlacementState.Navigating)
    {
        HandleInterrupt();
        ExitPlacementMode();
    }
}

private void OnInventorySlotChanged(int slotIndex)
{
    if (isExecutingPlacement) return;
    if (currentState == PlacementState.Idle) return;
    if (!currentSnapshot.isValid || slotIndex != currentSnapshot.slotIndex) return;
    
    // æ£€æŸ¥æ§½ä½ç‰©å“æ˜¯å¦è¿˜æœ‰æ•ˆ
    var slot = inventoryService.GetSlot(slotIndex);
    if (slot.IsEmpty || slot.itemId != currentSnapshot.itemId)
    {
        HandleInterrupt();
    }
}
```

**å…³é”®ç‰¹æ€§**ï¼š
1. **æ‰‹æŒç‰©å“åˆ‡æ¢**ï¼šåˆ‡æ¢å·¥å…·æ—¶ä¸­æ–­æ”¾ç½®
2. **èƒŒåŒ…æ§½ä½å˜åŒ–**ï¼šç‰©å“è¢«ç§»åŠ¨/ä½¿ç”¨æ—¶ä¸­æ–­æ”¾ç½®
3. **æ‰§è¡Œä¸­ä¿æŠ¤**ï¼š`isExecutingPlacement` æ ‡å¿—é˜²æ­¢è‡ªå·±è§¦å‘çš„äº‹ä»¶å¯¼è‡´ä¸­æ–­

### å†œç”°ç³»ç»Ÿçš„äº‹ä»¶è®¢é˜…ï¼ˆå½“å‰å®ç°ï¼‰

```csharp
// GameInputManager.cs
// âŒ æ²¡æœ‰è®¢é˜… OnSelectedChangedï¼
// âŒ æ²¡æœ‰è®¢é˜… OnSlotChangedï¼
// âŒ åªåœ¨ HandleHotbarSelection ä¸­æ‰‹åŠ¨è°ƒç”¨ CancelFarmingNavigationï¼
```

**ä¸¥é‡ç¼ºé™·**ï¼š
1. âŒ **æ— äº‹ä»¶è®¢é˜…**ï¼šä¸ç›‘å¬æ‰‹æŒç‰©å“åˆ‡æ¢äº‹ä»¶
2. âŒ **æ— èƒŒåŒ…ç›‘å¬**ï¼šä¸ç›‘å¬èƒŒåŒ…æ§½ä½å˜åŒ–äº‹ä»¶
3. âŒ **æ‰‹åŠ¨è°ƒç”¨**ï¼šåªåœ¨ç‰¹å®šä½ç½®æ‰‹åŠ¨è°ƒç”¨å–æ¶ˆï¼Œå®¹æ˜“é—æ¼
4. âŒ **æ— æ‰§è¡Œä¿æŠ¤**ï¼šæ²¡æœ‰ `isExecutingFarming` æ ‡å¿—

---

## å…­ã€æ‰§è¡Œä¸­ä¿æŠ¤çš„ç¼ºå¤±

### æ”¾ç½®ç³»ç»Ÿçš„æ‰§è¡Œä¿æŠ¤ï¼ˆæ­£ç¡®ç¤ºèŒƒï¼‰

```csharp
// PlacementManager.cs
private bool isExecutingPlacement = false;

private void ExecutePlacement()
{
    isExecutingPlacement = true; // è®¾ç½®æ ‡å¿—
    
    // ... æ‰§è¡Œæ”¾ç½®é€»è¾‘ ...
    // æ‰£é™¤ç‰©å“æ—¶ä¼šè§¦å‘ OnSlotChanged äº‹ä»¶
    // ä½†å› ä¸º isExecutingPlacement = trueï¼Œäº‹ä»¶å›è°ƒä¼šè¢«å¿½ç•¥
    
    isExecutingPlacement = false; // æ¸…é™¤æ ‡å¿—
}
```

### å†œç”°ç³»ç»Ÿçš„æ‰§è¡Œä¿æŠ¤ï¼ˆå½“å‰å®ç°ï¼‰

```csharp
// GameInputManager.cs
// âŒ æ²¡æœ‰ isExecutingFarming æ ‡å¿—ï¼
// âŒ æ‰§è¡Œç§æ¤æ—¶æ‰£é™¤ç§å­ï¼Œå¯èƒ½è§¦å‘æ„å¤–çš„çŠ¶æ€å˜åŒ–ï¼
```

**ä¸¥é‡ç¼ºé™·**ï¼š
1. âŒ **æ— æ‰§è¡Œæ ‡å¿—**ï¼šæ²¡æœ‰ `isExecutingFarming` ä¿æŠ¤
2. âŒ **å¯èƒ½è¢«ä¸­æ–­**ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½è¢«äº‹ä»¶ä¸­æ–­
3. âŒ **çŠ¶æ€ä¸ä¸€è‡´**ï¼šå¯èƒ½å¯¼è‡´ç‰©å“å·²æ‰£é™¤ä½†ä½œç‰©æœªåˆ›å»º

---

## ä¸ƒã€é¢„è§ˆä¸äº¤äº’çš„æ—¶åºé—®é¢˜

### æ”¾ç½®ç³»ç»Ÿçš„æ—¶åºï¼ˆæ­£ç¡®ç¤ºèŒƒï¼‰

```
Update() æµç¨‹ï¼š
1. æ£€æŸ¥èƒŒåŒ…æ˜¯å¦æ‰“å¼€ â†’ éšè—é¢„è§ˆ
2. æ£€æŸ¥ä¸­æ–­æ¡ä»¶ â†’ HandleInterrupt
3. Preview çŠ¶æ€ â†’ UpdatePreviewï¼ˆè·Ÿéšé¼ æ ‡ï¼‰
4. Locked/Navigating çŠ¶æ€ â†’ åªæ›´æ–° Sorting Layer
5. æ£€æŸ¥å–æ¶ˆè¾“å…¥
```

### å†œç”°ç³»ç»Ÿçš„æ—¶åºï¼ˆå½“å‰å®ç°ï¼‰

```
Update() æµç¨‹ï¼š
1. UpdatePreviews() â†’ å§‹ç»ˆæ›´æ–°é¢„è§ˆä½ç½®
2. HandlePanelHotkeys()
3. HandleMovement()
4. HandleHotbarSelection()
5. HandleUseCurrentTool()
6. HandleRightClickAutoNav()
```

**ä¸¥é‡ç¼ºé™·**ï¼š
1. âŒ **é¢„è§ˆå§‹ç»ˆæ›´æ–°**ï¼šä¸ç®¡æ˜¯å¦åœ¨å¯¼èˆªä¸­ï¼Œé¢„è§ˆéƒ½è·Ÿéšé¼ æ ‡
2. âŒ **æ— çŠ¶æ€æ£€æŸ¥**ï¼šä¸æ£€æŸ¥å†œç”°å¯¼èˆªçŠ¶æ€
3. âŒ **æ—¶åºæ··ä¹±**ï¼šé¢„è§ˆæ›´æ–°å’Œäº¤äº’å¤„ç†æ²¡æœ‰åè°ƒ

---

## å…«ã€æ€»ç»“ï¼šéœ€è¦ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜

### ä¼˜å…ˆçº§ P0ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰

1. **FarmToolPreview æ·»åŠ é”å®šæœºåˆ¶**
   - æ·»åŠ  `LockPosition()` / `UnlockPosition()` æ–¹æ³•
   - æ·»åŠ  `isLocked` å’Œ `lockedPosition` å­—æ®µ
   - `UpdateXxxPreview` æ–¹æ³•åœ¨é”å®šçŠ¶æ€ä¸‹ä¸æ›´æ–°ä½ç½®

2. **GameInputManager æ·»åŠ å®Œæ•´çŠ¶æ€æœº**
   - æ·»åŠ  `FarmPreviewState` æšä¸¾ï¼ˆIdle, Preview, Locked, Navigatingï¼‰
   - çŠ¶æ€è½¬æ¢é€»è¾‘ä¸æ”¾ç½®ç³»ç»Ÿå¯¹é½

3. **å®Œå–„å¿«ç…§æœºåˆ¶**
   - å¿«ç…§æ·»åŠ  `lockedPosition` å­—æ®µ
   - é”å®šæ—¶åˆ›å»ºå¿«ç…§ï¼Œè€Œéå¯¼èˆªå¼€å§‹æ—¶

4. **å®Œå–„ä¸­æ–­å¤„ç†**
   - `CancelFarmingNavigation` ä¸­è°ƒç”¨ `FarmToolPreview.UnlockPosition()`
   - ä¸­æ–­åæ¢å¤åˆ° Preview çŠ¶æ€

### ä¼˜å…ˆçº§ P1ï¼ˆåº”è¯¥ä¿®å¤ï¼‰

5. **æ·»åŠ äº‹ä»¶è®¢é˜…**
   - è®¢é˜… `HotbarSelectionService.OnSelectedChanged`
   - è®¢é˜… `InventoryService.OnSlotChanged`

6. **æ·»åŠ æ‰§è¡Œä¿æŠ¤**
   - æ·»åŠ  `isExecutingFarming` æ ‡å¿—
   - æ‰§è¡Œè¿‡ç¨‹ä¸­å¿½ç•¥äº‹ä»¶å›è°ƒ

### ä¼˜å…ˆçº§ P2ï¼ˆå»ºè®®ä¿®å¤ï¼‰

7. **æ—¶åºä¼˜åŒ–**
   - `UpdatePreviews()` æ£€æŸ¥å†œç”°å¯¼èˆªçŠ¶æ€
   - å¯¼èˆªä¸­ä¸æ›´æ–°é¢„è§ˆä½ç½®

8. **è§†è§‰åé¦ˆä¼˜åŒ–**
   - é”å®šçŠ¶æ€ä¸‹é¢„è§ˆæ˜¾ç¤ºä¸åŒé¢œè‰²/æ ·å¼
   - å¯¼èˆªä¸­æ˜¾ç¤ºç›®æ ‡æŒ‡ç¤ºå™¨

---

## ä¹ã€ä¸æ”¾ç½®ç³»ç»Ÿçš„å¯¹æ¯”è¡¨

| ç‰¹æ€§ | æ”¾ç½®ç³»ç»Ÿ | å†œç”°ç³»ç»Ÿ | å·®è· |
|------|---------|---------|------|
| çŠ¶æ€æœº | 4 çŠ¶æ€ï¼ˆIdle/Preview/Locked/Navigatingï¼‰ | 3 çŠ¶æ€ï¼ˆç¼º Lockedï¼‰ | âŒ ç¼ºå¤± |
| é¢„è§ˆé”å®š | âœ… LockPosition/UnlockPosition | âŒ æ—  | âŒ ç¼ºå¤± |
| å¿«ç…§æœºåˆ¶ | âœ… å®Œæ•´ï¼ˆå«ä½ç½®ï¼‰ | âš ï¸ ä¸å®Œæ•´ï¼ˆæ— ä½ç½®ï¼‰ | âš ï¸ éƒ¨åˆ† |
| ä¸­æ–­æ¢å¤ | âœ… HandleInterrupt | âš ï¸ CancelFarmingNavigationï¼ˆä¸å®Œæ•´ï¼‰ | âš ï¸ éƒ¨åˆ† |
| äº‹ä»¶è®¢é˜… | âœ… OnSelectedChanged/OnSlotChanged | âŒ æ—  | âŒ ç¼ºå¤± |
| æ‰§è¡Œä¿æŠ¤ | âœ… isExecutingPlacement | âŒ æ—  | âŒ ç¼ºå¤± |
| æ—¶åºæ§åˆ¶ | âœ… çŠ¶æ€æ£€æŸ¥åæ›´æ–°é¢„è§ˆ | âŒ å§‹ç»ˆæ›´æ–°é¢„è§ˆ | âŒ ç¼ºå¤± |

---

**ç»“è®º**ï¼šå†œç”°ç³»ç»Ÿçš„äº¤äº’å®ç°ä¸æ”¾ç½®ç³»ç»Ÿç›¸æ¯”ï¼Œç¼ºå¤±äº†å¤§é‡å…³é”®æœºåˆ¶ã€‚éœ€è¦è¿›è¡Œç³»ç»Ÿæ€§é‡æ„ï¼Œå°†æ”¾ç½®ç³»ç»Ÿçš„è®¾è®¡æ¨¡å¼å®Œæ•´ç§»æ¤åˆ°å†œç”°ç³»ç»Ÿä¸­ã€‚


---

## åã€æ”¾ç½®ç³»ç»ŸåŒæ ·å­˜åœ¨çš„é—®é¢˜

### ç”¨æˆ·åŸè¯
> "æ”¾ç½®ç³»ç»Ÿé‡Œé¢çš„ç‚¹å‡»åé¢„è§ˆå›ºå®šç©å®¶ç§»åŠ¨è¿‡å»åˆ°å¯è§¦å‘è·ç¦»å†è§¦å‘ï¼Œç§»åŠ¨å–æ¶ˆåé¢„è§ˆä¹Ÿå–æ¶ˆå›ºå®šç„¶åæ¢å¤è·Ÿéšé¼ æ ‡é¢„è§ˆï¼Œè¿™ä¸€ç‚¹å¯¹äºæˆ‘ä»¬å½“å‰å·²ç»å®Œæˆçš„æ”¾ç½®ç³»ç»Ÿä¹Ÿæ˜¯å­˜åœ¨è¿™ä¸ªé—®é¢˜"

### é—®é¢˜åˆ†æ

ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œæ”¾ç½®ç³»ç»Ÿè™½ç„¶æœ‰ `LockPosition()` å’Œ `UnlockPosition()` æ–¹æ³•ï¼Œä½†åœ¨ä»¥ä¸‹åœºæ™¯å¯èƒ½å­˜åœ¨é—®é¢˜ï¼š

1. **å¯¼èˆªå–æ¶ˆåé¢„è§ˆæ¢å¤**ï¼šéœ€è¦éªŒè¯ `HandleInterrupt()` æ˜¯å¦æ­£ç¡®è°ƒç”¨ `UnlockPosition()`
2. **é¢„è§ˆè·Ÿéšæ¢å¤**ï¼šå–æ¶ˆåé¢„è§ˆæ˜¯å¦ç«‹å³æ¢å¤è·Ÿéšé¼ æ ‡
3. **çŠ¶æ€ä¸€è‡´æ€§**ï¼šçŠ¶æ€æœºè½¬æ¢æ˜¯å¦å®Œæ•´

### éœ€è¦ç»Ÿä¸€ä¿®å¤çš„å†…å®¹

| ç³»ç»Ÿ | é—®é¢˜ | ä¿®å¤æ–¹æ¡ˆ |
|------|------|---------|
| æ”¾ç½®ç³»ç»Ÿ | å¯¼èˆªå–æ¶ˆåé¢„è§ˆæ¢å¤ | éªŒè¯å¹¶ä¿®å¤ HandleInterrupt |
| å†œç”°ç³»ç»Ÿ | ç¼ºå°‘é”å®šæœºåˆ¶ | æ·»åŠ  LockPosition/UnlockPosition |
| ä¸¤ä¸ªç³»ç»Ÿ | ç»Ÿä¸€äº¤äº’æ¨¡å¼ | ç¡®ä¿è¡Œä¸ºä¸€è‡´ |

### ç»Ÿä¸€çš„äº¤äº’æ¨¡å¼

```
ç‚¹å‡»æœ‰æ•ˆä½ç½®
    â†“
é”å®šé¢„è§ˆä½ç½®ï¼ˆLockPositionï¼‰
    â†“
åˆ¤æ–­è·ç¦»
    â”œâ”€ è¿‘è·ç¦» â†’ ç›´æ¥æ‰§è¡Œ â†’ è§£é”é¢„è§ˆï¼ˆUnlockPositionï¼‰
    â””â”€ è¿œè·ç¦» â†’ å¼€å§‹å¯¼èˆª
                    â†“
              å¯¼èˆªè¿‡ç¨‹ä¸­
                    â”œâ”€ åˆ°è¾¾ â†’ æ‰§è¡Œ â†’ è§£é”é¢„è§ˆ
                    â””â”€ å–æ¶ˆ â†’ è§£é”é¢„è§ˆ â†’ æ¢å¤è·Ÿéšé¼ æ ‡
```

---

## åä¸€ã€åˆ‡æ¢ç‰©å“å–æ¶ˆé¢„è§ˆçš„é€»è¾‘

### ç”¨æˆ·åŸè¯
> "è¿˜æœ‰åˆ‡æ¢ç‰©ä½“å–æ¶ˆè€•åœ°é¢„è§ˆç­‰é€»è¾‘å¤„ç†"

### å½“å‰é—®é¢˜

1. **å†œç”°ç³»ç»Ÿ**ï¼šåˆ‡æ¢ç‰©å“æ—¶ä¸å–æ¶ˆå¯¼èˆªï¼Œé¢„è§ˆæ®‹ç•™
2. **æ”¾ç½®ç³»ç»Ÿ**ï¼šéœ€è¦éªŒè¯åˆ‡æ¢ç‰©å“æ—¶çš„å¤„ç†

### æœŸæœ›è¡Œä¸º

| åœºæ™¯ | æœŸæœ›è¡Œä¸º |
|------|---------|
| å¯¼èˆªä¸­åˆ‡æ¢åˆ°å…¶ä»–å†œå…· | å–æ¶ˆå¯¼èˆª â†’ æ›´æ–°é¢„è§ˆä¸ºæ–°å†œå…· |
| å¯¼èˆªä¸­åˆ‡æ¢åˆ°éå†œå…· | å–æ¶ˆå¯¼èˆª â†’ éšè—é¢„è§ˆ |
| å¯¼èˆªä¸­åˆ‡æ¢åˆ°å¯æ”¾ç½®ç‰©å“ | å–æ¶ˆå†œç”°å¯¼èˆª â†’ æ˜¾ç¤ºæ”¾ç½®é¢„è§ˆ |
| é¢„è§ˆä¸­åˆ‡æ¢ç‰©å“ | æ›´æ–°é¢„è§ˆæˆ–éšè— |

### å®ç°æ–¹æ¡ˆ

```csharp
// GameInputManager.cs
private void OnHotbarSelectedChanged(int oldIndex, int newIndex)
{
    // 1. å¦‚æœæ­£åœ¨å†œç”°å¯¼èˆªï¼Œå–æ¶ˆ
    if (_farmNavState != FarmNavState.Idle)
    {
        CancelFarmingNavigation();
    }
    
    // 2. è·å–æ–°ç‰©å“
    var newItem = GetCurrentHeldItem();
    
    // 3. æ ¹æ®æ–°ç‰©å“ç±»å‹æ›´æ–°é¢„è§ˆ
    if (newItem is ToolData tool && IsFarmTool(tool))
    {
        // æ˜¾ç¤ºå†œç”°é¢„è§ˆ
        UpdateFarmToolPreview();
    }
    else if (newItem is PlaceableItemData)
    {
        // æ˜¾ç¤ºæ”¾ç½®é¢„è§ˆï¼ˆç”± PlacementManager å¤„ç†ï¼‰
        HideFarmToolPreview();
    }
    else
    {
        // éšè—æ‰€æœ‰é¢„è§ˆ
        HideFarmToolPreview();
    }
}
```

---

## åäºŒã€æ‰€æœ‰éœ€è¦ä¸¥è‚ƒå¤„ç†çš„äº¤äº’æƒ…å†µ

### ç”¨æˆ·åŸè¯
> "å„ç§å„ç§ï¼Œæˆ‘å¸Œæœ›ä½ éƒ½èƒ½å…¨é¢è¿›è¡Œåˆ†æï¼Œæ‰€æœ‰çš„äº¤äº’æƒ…å†µï¼Œéƒ½éœ€è¦ä¸¥è‚ƒå¤„ç†"

### å®Œæ•´äº¤äº’åœºæ™¯æ¸…å•

#### A. é¢„è§ˆç›¸å…³
| # | åœºæ™¯ | å½“å‰çŠ¶æ€ | éœ€è¦ä¿®å¤ |
|---|------|---------|---------|
| A1 | é€‰ä¸­å†œå…·æ˜¾ç¤ºé¢„è§ˆ | âœ… æ­£å¸¸ | - |
| A2 | é¢„è§ˆè·Ÿéšé¼ æ ‡ | âœ… æ­£å¸¸ | - |
| A3 | ç‚¹å‡»åé¢„è§ˆé”å®š | âŒ ç¼ºå¤± | æ˜¯ |
| A4 | å¯¼èˆªä¸­é¢„è§ˆä¿æŒé”å®š | âŒ ç¼ºå¤± | æ˜¯ |
| A5 | å–æ¶ˆåé¢„è§ˆè§£é”æ¢å¤è·Ÿéš | âŒ ç¼ºå¤± | æ˜¯ |
| A6 | æ‰§è¡Œåé¢„è§ˆè§£é”æ¢å¤è·Ÿéš | âŒ ç¼ºå¤± | æ˜¯ |

#### B. å¯¼èˆªç›¸å…³
| # | åœºæ™¯ | å½“å‰çŠ¶æ€ | éœ€è¦ä¿®å¤ |
|---|------|---------|---------|
| B1 | è¿œè·ç¦»ç‚¹å‡»å¼€å§‹å¯¼èˆª | âœ… æ­£å¸¸ | - |
| B2 | å¯¼èˆªåˆ°è¾¾åæ‰§è¡Œ | âš ï¸ éƒ¨åˆ† | æ˜¯ |
| B3 | å¯¼èˆªä¸­å³é”®å–æ¶ˆ | âš ï¸ éƒ¨åˆ† | æ˜¯ |
| B4 | å¯¼èˆªä¸­ESCå–æ¶ˆ | âš ï¸ éƒ¨åˆ† | æ˜¯ |
| B5 | å¯¼èˆªä¸­ç‚¹å‡»æ–°ä½ç½® | âŒ ç¼ºå¤± | æ˜¯ |
| B6 | å¯¼èˆªä¸­æ‰‹åŠ¨ç§»åŠ¨å–æ¶ˆ | âš ï¸ éƒ¨åˆ† | æ˜¯ |

#### C. ç‰©å“åˆ‡æ¢ç›¸å…³
| # | åœºæ™¯ | å½“å‰çŠ¶æ€ | éœ€è¦ä¿®å¤ |
|---|------|---------|---------|
| C1 | é¢„è§ˆä¸­åˆ‡æ¢åˆ°å…¶ä»–å†œå…· | âŒ ç¼ºå¤± | æ˜¯ |
| C2 | é¢„è§ˆä¸­åˆ‡æ¢åˆ°éå†œå…· | âŒ ç¼ºå¤± | æ˜¯ |
| C3 | å¯¼èˆªä¸­åˆ‡æ¢ç‰©å“ | âŒ ç¼ºå¤± | æ˜¯ |
| C4 | æ‰§è¡Œä¸­åˆ‡æ¢ç‰©å“ï¼ˆåº”å¿½ç•¥ï¼‰ | âŒ ç¼ºå¤± | æ˜¯ |

#### D. é¢æ¿ç›¸å…³
| # | åœºæ™¯ | å½“å‰çŠ¶æ€ | éœ€è¦ä¿®å¤ |
|---|------|---------|---------|
| D1 | æ‰“å¼€èƒŒåŒ…å–æ¶ˆå¯¼èˆª | âš ï¸ éƒ¨åˆ† | æ˜¯ |
| D2 | æ‰“å¼€èƒŒåŒ…éšè—é¢„è§ˆ | âš ï¸ éƒ¨åˆ† | æ˜¯ |
| D3 | å…³é—­èƒŒåŒ…æ¢å¤é¢„è§ˆ | âŒ ç¼ºå¤± | æ˜¯ |

#### E. çŠ¶æ€ä¿æŠ¤ç›¸å…³
| # | åœºæ™¯ | å½“å‰çŠ¶æ€ | éœ€è¦ä¿®å¤ |
|---|------|---------|---------|
| E1 | æ‰§è¡Œä¸­ä¿æŠ¤ï¼ˆé˜²é‡å¤ï¼‰ | âŒ ç¼ºå¤± | æ˜¯ |
| E2 | å¿«ç…§éªŒè¯ï¼ˆé˜²ç§ç“œå¾—è±†ï¼‰ | âš ï¸ éƒ¨åˆ† | æ˜¯ |
| E3 | äº‹ä»¶è®¢é˜…ï¼ˆå“åº”å¤–éƒ¨å˜åŒ–ï¼‰ | âŒ ç¼ºå¤± | æ˜¯ |

---

## åä¸‰ã€ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

### P0 - é˜»å¡æ€§é—®é¢˜ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰
1. FarmToolPreview æ·»åŠ  LockPosition/UnlockPosition
2. ç‚¹å‡»åé”å®šé¢„è§ˆ
3. å¯¼èˆªä¸­é¢„è§ˆä¿æŒé”å®š
4. å–æ¶ˆ/æ‰§è¡Œåè§£é”é¢„è§ˆ

### P1 - ä¸¥é‡é—®é¢˜ï¼ˆåº”è¯¥ä¿®å¤ï¼‰
5. åˆ‡æ¢ç‰©å“æ—¶å–æ¶ˆå¯¼èˆª
6. è®¢é˜… OnSelectedChanged äº‹ä»¶
7. å¯¼èˆªä¸­ç‚¹å‡»æ–°ä½ç½®å¤„ç†
8. æ‰§è¡Œä¸­ä¿æŠ¤æ ‡å¿—

### P2 - ä¸€èˆ¬é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰
9. å¿«ç…§æ·»åŠ  Quality å­—æ®µ
10. æ‰“å¼€/å…³é—­é¢æ¿æ—¶çš„é¢„è§ˆå¤„ç†
11. æ”¾ç½®ç³»ç»ŸåŒæ­¥ä¿®å¤

---

**åæ€å®Œæˆæ—¶é—´**: 2026-02-09


---

## åå››ã€æµ‡æ°´åŠŸèƒ½çš„ä¸¥é‡é—®é¢˜ï¼ˆP0 - ç”¨æˆ·æœ€æ–°åé¦ˆï¼‰

### ç”¨æˆ·åŸè¯
> "æµ‡æ°´åŠŸèƒ½å®Œå…¨æ— æ³•éªŒæ”¶ï¼ŒGameInputManager å¤„ç†å­˜åœ¨å·¨å¤§é—®é¢˜"

### 14.1 æµ‡æ°´åŠŸèƒ½è°ƒç”¨é“¾åˆ†æ

```
HandleUseCurrentTool()
    â†“
TryHandleFarmingTool(tool)
    â†“ (tool.toolType == WateringCan)
TryWaterTile(worldPos)
    â†“
FarmToolPreview.IsValid() â† ğŸ”´ å…³é”®åˆ¤æ–­ç‚¹
    â†“ (å¦‚æœ falseï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä»»ä½•åŠ¨ä½œ)
ExecuteWaterTile(layerIndex, cellPos)
    â†“
FarmTileManager.SetWatered(layerIndex, cellPos, currentHour)
```

### 14.2 FarmToolPreview.UpdateWateringPreview çš„éªŒè¯é€»è¾‘

```csharp
// FarmToolPreview.cs - UpdateWateringPreview
public void UpdateWateringPreview(int layerIndex, Vector3Int cellPos, ...)
{
    // Step 1: éšœç¢ç‰©æ£€æµ‹
    bool hasObstacle = PlacementValidator.HasFarmingObstacle(cellCenter);
    
    // Step 2: è·ç¦»æ£€æµ‹
    bool withinReach = IsWithinReach(playerTransform, cellCenter, reach);
    
    // Step 3: æ£€æŸ¥æ˜¯å¦å¯ä»¥æµ‡æ°´ â† ğŸ”´ å…³é”®é€»è¾‘
    var tileData = FarmTileManager.Instance?.GetTileData(layerIndex, cellPos);
    bool canWater = tileData != null && 
                    tileData.isTilled && 
                    !tileData.wateredToday;
    
    // ğŸ”´ é—®é¢˜ï¼šå¦‚æœ tileData ä¸º nullï¼ŒcanWater = false
    // ğŸ”´ é—®é¢˜ï¼šå¦‚æœ tileData.isTilled = falseï¼ŒcanWater = false
    
    // IsValid = é€»è¾‘åˆæ³• AND ç‰©ç†åˆæ³•
    bool isValid = !hasObstacle && canWater;
    
    currentState = isValid ? FarmPreviewState.Valid : FarmPreviewState.Invalid;
}
```

### 14.3 é—®é¢˜æ ¹å› åˆ†æ

| é—®é¢˜ | åŸå›  | å½±å“ |
|------|------|------|
| tileData ä¸º null | è¯¥ä½ç½®æ²¡æœ‰è€•åœ°æ•°æ® | é¢„è§ˆæ˜¾ç¤ºçº¢è‰²ï¼Œæ— æ³•æµ‡æ°´ |
| tileData.isTilled = false | è€•åœ°æ•°æ®å­˜åœ¨ä½†æœªæ ‡è®°ä¸ºå·²è€•ä½œ | é¢„è§ˆæ˜¾ç¤ºçº¢è‰²ï¼Œæ— æ³•æµ‡æ°´ |
| FarmTileManager.Instance ä¸º null | åœºæ™¯ä¸­æ²¡æœ‰ FarmTileManager | é¢„è§ˆæ˜¾ç¤ºçº¢è‰²ï¼Œæ— æ³•æµ‡æ°´ |
| layerIndex ä¸æ­£ç¡® | GetCurrentLayerIndex è¿”å›é”™è¯¯æ¥¼å±‚ | æ‰¾ä¸åˆ°è€•åœ°æ•°æ® |

### 14.4 TryWaterTile çš„é—®é¢˜

```csharp
// GameInputManager.cs - TryWaterTile
private bool TryWaterTile(Vector3 worldPosition)
{
    var farmPreview = FarmGame.Farm.FarmToolPreview.Instance;
    
    // ğŸ”´ é—®é¢˜1ï¼šå¦‚æœ farmPreview ä¸º nullï¼Œç›´æ¥è¿”å› false
    // ğŸ”´ é—®é¢˜2ï¼šå¦‚æœ IsValid() è¿”å› falseï¼Œç›´æ¥è¿”å› falseï¼Œä¸ç»™ç”¨æˆ·ä»»ä½•åé¦ˆ
    if (farmPreview == null || !farmPreview.IsValid())
    {
        if (showDebugInfo)
            Debug.Log("[GameInputManager] æµ‡æ°´å¤±è´¥ï¼šç›®æ ‡æ— æ•ˆï¼ˆçº¢æ¡†çŠ¶æ€ï¼‰");
        return false; // ğŸ”´ è¿”å› falseï¼Œä¸è§¦å‘ä»»ä½•åŠ¨ç”»
    }
    
    // ... åç»­é€»è¾‘
}
```

**ä¸¥é‡é—®é¢˜**ï¼š
1. âŒ **æ— ç”¨æˆ·åé¦ˆ**ï¼šæµ‡æ°´å¤±è´¥æ—¶åªæœ‰ Debug.Logï¼Œç”¨æˆ·çœ‹ä¸åˆ°ä»»ä½•æç¤º
2. âŒ **é™é»˜å¤±è´¥**ï¼šè¿”å› false åï¼ŒHandleUseCurrentTool ä¸ä¼šè§¦å‘ä»»ä½•åŠ¨ç”»
3. âŒ **è°ƒè¯•å›°éš¾**ï¼šshowDebugInfo é»˜è®¤ä¸º falseï¼Œç”¨æˆ·æ— æ³•çŸ¥é“å¤±è´¥åŸå› 

### 14.5 ExecuteWaterTile çš„é—®é¢˜

```csharp
// GameInputManager.cs - ExecuteWaterTile
private bool ExecuteWaterTile(int layerIndex, Vector3Int cellPos)
{
    var farmTileManager = FarmGame.Farm.FarmTileManager.Instance;
    if (farmTileManager == null)
    {
        if (showDebugInfo)
            Debug.Log("[GameInputManager] FarmTileManager æœªåˆå§‹åŒ–");
        return false; // ğŸ”´ é™é»˜å¤±è´¥
    }
    
    float currentHour = TimeManager.Instance != null ? TimeManager.Instance.GetHour() : 0f;
    bool success = farmTileManager.SetWatered(layerIndex, cellPos, currentHour);
    
    // ğŸ”´ é—®é¢˜ï¼šSetWatered è¿”å› false æ—¶ï¼Œæ²¡æœ‰ä»»ä½•å¤„ç†
    if (showDebugInfo)
        Debug.Log($"[GameInputManager] æµ‡æ°´{(success ? "æˆåŠŸ" : "å¤±è´¥")}: ...");
    
    return success;
}
```

### 14.6 FarmTileManager.SetWatered çš„é—®é¢˜

```csharp
// FarmTileManager.cs - SetWatered
public bool SetWatered(int layerIndex, Vector3Int cellPosition, float waterTime, int puddleVariant = -1)
{
    var tileData = GetTileData(layerIndex, cellPosition);
    
    // ğŸ”´ é—®é¢˜1ï¼štileData ä¸º null æ—¶é™é»˜è¿”å› false
    if (tileData == null || !tileData.isTilled)
    {
        return false;
    }
    
    // ğŸ”´ é—®é¢˜2ï¼šä»Šå¤©å·²æµ‡æ°´æ—¶é™é»˜è¿”å› false
    if (tileData.wateredToday)
    {
        return false;
    }
    
    // ... æ‰§è¡Œæµ‡æ°´é€»è¾‘
    return true;
}
```

### 14.7 æµ‡æ°´åŠŸèƒ½çš„å®Œæ•´é—®é¢˜æ¸…å•

| # | é—®é¢˜ | ä½ç½® | ä¼˜å…ˆçº§ |
|---|------|------|--------|
| W1 | FarmToolPreview.Instance å¯èƒ½ä¸º null | TryWaterTile | P0 |
| W2 | IsValid() è¿”å› false æ—¶æ— ç”¨æˆ·åé¦ˆ | TryWaterTile | P0 |
| W3 | tileData ä¸º null æ—¶æ— æ³•æµ‡æ°´ | UpdateWateringPreview | P0 |
| W4 | layerIndex å¯èƒ½ä¸æ­£ç¡® | GetCurrentLayerIndex | P1 |
| W5 | SetWatered å¤±è´¥æ—¶æ— åé¦ˆ | ExecuteWaterTile | P1 |
| W6 | æµ‡æ°´åŠ¨ç”»ä¸é€»è¾‘ä¸åŒæ­¥ | TryWaterTile | P1 |
| W7 | è¿œè·ç¦»æµ‡æ°´çš„å¿«ç…§éªŒè¯ä¸å®Œæ•´ | TryWaterTile | P1 |

### 14.8 æµ‡æ°´åŠŸèƒ½ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šå¢å¼ºé”™è¯¯åé¦ˆ

```csharp
// TryWaterTile ä¿®æ”¹
private bool TryWaterTile(Vector3 worldPosition)
{
    var farmPreview = FarmGame.Farm.FarmToolPreview.Instance;
    
    if (farmPreview == null)
    {
        Debug.LogError("[GameInputManager] æµ‡æ°´å¤±è´¥ï¼šFarmToolPreview æœªåˆå§‹åŒ–");
        // TODO: æ˜¾ç¤º UI æç¤º
        return false;
    }
    
    if (!farmPreview.IsValid())
    {
        // ğŸ”¥ æ–°å¢ï¼šæ ¹æ®å¤±è´¥åŸå› ç»™å‡ºå…·ä½“æç¤º
        var reason = GetWateringFailureReason(farmPreview);
        Debug.LogWarning($"[GameInputManager] æµ‡æ°´å¤±è´¥ï¼š{reason}");
        // TODO: æ˜¾ç¤º UI æç¤º
        return false;
    }
    
    // ... åç»­é€»è¾‘
}

private string GetWateringFailureReason(FarmToolPreview preview)
{
    // æ£€æŸ¥å„ç§å¤±è´¥åŸå› 
    if (!preview.IsInRange) return "è·ç¦»å¤ªè¿œ";
    // ... å…¶ä»–åŸå› 
    return "ç›®æ ‡æ— æ•ˆ";
}
```

#### æ–¹æ¡ˆ2ï¼šä¿®å¤ UpdateWateringPreview çš„éªŒè¯é€»è¾‘

```csharp
// UpdateWateringPreview ä¿®æ”¹
public void UpdateWateringPreview(int layerIndex, Vector3Int cellPos, ...)
{
    // ğŸ”¥ æ–°å¢ï¼šè¯¦ç»†çš„å¤±è´¥åŸå› è®°å½•
    _lastFailureReason = WateringFailureReason.None;
    
    var tileData = FarmTileManager.Instance?.GetTileData(layerIndex, cellPos);
    
    if (tileData == null)
    {
        _lastFailureReason = WateringFailureReason.NoFarmland;
        canWater = false;
    }
    else if (!tileData.isTilled)
    {
        _lastFailureReason = WateringFailureReason.NotTilled;
        canWater = false;
    }
    else if (tileData.wateredToday)
    {
        _lastFailureReason = WateringFailureReason.AlreadyWatered;
        canWater = false;
    }
    else
    {
        canWater = true;
    }
    
    // ... åç»­é€»è¾‘
}
```

### 14.9 æµ‡æ°´åŠŸèƒ½éªŒæ”¶æ ‡å‡†

| åœºæ™¯ | æœŸæœ›è¡Œä¸º |
|------|---------|
| ç‚¹å‡»å·²è€•ä½œæœªæµ‡æ°´çš„è€•åœ° | é¢„è§ˆç»¿è‰²ï¼Œç‚¹å‡»åæµ‡æ°´æˆåŠŸ |
| ç‚¹å‡»å·²è€•ä½œå·²æµ‡æ°´çš„è€•åœ° | é¢„è§ˆçº¢è‰²ï¼Œç‚¹å‡»æ— ååº” |
| ç‚¹å‡»æœªè€•ä½œçš„åœ°é¢ | é¢„è§ˆçº¢è‰²ï¼Œç‚¹å‡»æ— ååº” |
| ç‚¹å‡»æœ‰éšœç¢ç‰©çš„ä½ç½® | é¢„è§ˆçº¢è‰²ï¼Œç‚¹å‡»æ— ååº” |
| è¿œè·ç¦»ç‚¹å‡»æœ‰æ•ˆè€•åœ° | é¢„è§ˆç»¿è‰²ï¼Œå¯¼èˆªåæµ‡æ°´ |
| å¯¼èˆªä¸­å–æ¶ˆ | å–æ¶ˆå¯¼èˆªï¼Œé¢„è§ˆæ¢å¤è·Ÿéš |

