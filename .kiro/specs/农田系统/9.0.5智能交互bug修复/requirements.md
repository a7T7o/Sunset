# 9.0.5 智能交互Bug修复 - 需求文档

**创建日期**: 2026-02-09
**工作区**: `.kiro/specs/农田系统/9.0.5智能交互bug修复/`

---

## 背景

农田系统（锄头、水壶、种子）的交互实现缺少"预览锁定"机制，导致：
- 点击远处目标后，预览仍跟随鼠标，用户不知道目标在哪
- 取消导航后，预览不恢复跟随
- 切换物品时状态混乱
- 浇水失败时无任何反馈

放置系统（PlacementManager）已有完整的 Locked 状态机制，农田系统需要对齐。

---

## 用户故事

### US-1：预览锁定与解锁

**作为**玩家，
**我希望**点击有效目标后，预览框固定在目标位置不再跟随鼠标，
**以便**我能清楚看到操作目标在哪里。

**验收标准**：
- AC-1.1：手持锄头/水壶/种子，点击有效位置后，预览框固定在该位置
- AC-1.2：导航过程中，预览框保持固定，不跟随鼠标
- AC-1.3：操作执行完成后，预览框解锁，恢复跟随鼠标
- AC-1.4：近距离直接执行时，预览框短暂锁定后立即解锁恢复跟随

### US-2：导航中断恢复

**作为**玩家，
**我希望**取消导航后，预览框立即恢复跟随鼠标，
**以便**我能继续选择新的操作目标。

**核心原则**：撤回权始终在玩家手中，所有操作必须可中断可撤回，撤回回到最初的跟随鼠标状态。

**验收标准**：
- AC-2.1：导航中按 WASD 手动移动，中断导航，解锁预览，回到跟随鼠标状态
- AC-2.2：导航中按 ESC，中断导航，解锁预览，回到跟随鼠标状态
- AC-2.3：导航中左键点击新的有效位置，中断当前导航，重新锁定新位置，重新开始导航（不是"修改目的地"优化，而是完整的中断+重启）
- AC-2.4：取消后预览颜色正确反映新鼠标位置的有效性

### US-3：切换物品状态清理

**作为**玩家，
**我希望**切换手持物品时，当前的导航和预览状态被正确清理，
**以便**不会出现残留的预览或错误的导航。

**验收标准**：
- AC-3.1：导航中滚轮切换物品，取消导航，更新预览为新物品类型
- AC-3.2：导航中数字键切换物品，取消导航，更新预览为新物品类型
- AC-3.3：切换到非农具/非种子时，隐藏农田预览
- AC-3.4：切换到可放置物品时，隐藏农田预览，显示放置预览

### US-4：浇水功能可靠性

**作为**玩家，
**我希望**浇水功能在所有场景下都能正确工作，
**以便**我能可靠地给耕地浇水。

**验收标准**：
- AC-4.1：近距离点击已耕作未浇水的耕地，浇水成功
- AC-4.2：近距离点击已浇水的耕地，预览红色，点击无反应
- AC-4.3：远距离点击有效耕地，导航到目标后浇水成功
- AC-4.4：浇水失败时，Debug 日志输出具体失败原因

### US-5：执行保护

**作为**系统，
**我需要**在执行农田操作时防止重复触发和状态干扰，
**以便**不会出现物品重复扣除或状态不一致。

**验收标准**：
- AC-5.1：执行种植时，不响应切换物品事件
- AC-5.2：执行锄地/浇水时，不响应新的点击
- AC-5.3：执行完成后，状态正确恢复

---

## 边界情况

| # | 场景 | 期望行为 |
|---|------|---------|
| E1 | 导航中目标被其他操作改变（如其他系统修改了耕地状态） | 到达后二次校验，校验失败则不执行，解锁预览回到跟随 |
| E2 | 导航中点击新的有效位置 | 中断当前导航，重新锁定新位置，重新开始（完整中断+重启，非"修改目的地"优化） |
| E3 | 锁定/导航状态下打开背包/面板 | **不中断导航**，面板冻结所有事件（面板本身就是事件屏蔽器），导航状态保留 |
| E4 | 关闭背包/面板后 | 恢复之前的状态（如果之前在导航就继续导航，预览保持锁定） |
| E5 | 连续快速点击同一位置 | 只执行一次，不重复 |
| E6 | 导航到达但距离仍然过远（寻路失败） | 不执行操作，解锁预览，回到跟随鼠标 |
| E7 | FarmToolPreview.Instance 为 null | 安全处理，不崩溃 |
| E8 | 导航中切换到同类型但不同物品的农具 | 中断导航，解锁预览，更新预览为新物品 |

---

## 非功能需求

- NF-1：预览锁定/解锁的响应时间 < 1帧（同帧完成）
- NF-2：状态机转换不产生 GC Alloc
- NF-3：所有新增代码遵循项目调试日志规范（showDebugInfo 开关）
