# 锐评回应：0执行锐评002

**回应日期**: 2026-02-10
**锐评来源**: `.kiro/specs/农田系统/9.0.5智能交互bug修复/0执行锐评002.md`

---

## 一、锐评核心观点摘要

Code Reaper 对三件套给予高度评价，但指出一个"致命盲区"：

**"盲人导航悖论"** — 锁定状态下 `UpdatePreviews()` 直接 return，导致 FarmToolPreview 的实时数据（CurrentCellPos、IsValid、IsInRange）也停止更新。玩家在导航中点击新位置时读到旧数据，无法改道。

修正指令：**视觉与数据分离** — 锁定时只冻结视觉（GhostTilemap/CursorRenderer），实时数据永远跟随鼠标更新。

---

## 二、事实核查结果

| # | 锐评声明 | 代码事实 | 核查结论 |
|---|---------|---------|---------|
| 1 | "UpdatePreviews 在锁定时直接 return" | design.md 4.1 确实写了 `if (Locked/Navigating/Executing) return;` | ✅ 事实正确 |
| 2 | "HandleUseCurrentTool 依赖实时数据" | TryTillSoil 等方法读取 farmPreview.IsValid()/CurrentCellPos | ✅ 事实正确 |
| 3 | "导航中点击新位置读到旧数据" | 数据冻结导致无法改道，与 requirements.md E2 矛盾 | ✅ 事实正确 |
| 4 | "WASD 需要屏蔽执行中移动" | HandleMovement 已有 ToolActionLockManager 屏蔽 | ⚠️ 已有部分处理 |
| 5 | "UnlockPosition 需要 finally 保护" | design.md 只对 _isExecutingFarming 用了 try/finally | ⚠️ 合理建议 |

---

## 三、认同的部分

### 3.1 "盲人导航"诊断完全正确

这是真实的设计缺陷。我的 design.md 为了视觉锁定，错误地冻结了逻辑数据。

### 3.2 "视觉与数据分离"方向正确

锁定时只冻结渲染，实时数据永远更新，这是正确的分层思路。

### 3.3 UnlockPosition 原子性建议合理

无论导航成功/失败/超时/被杀，UnlockPosition 都必须被调用。

---

## 四、用户修正的关键逻辑

### 4.1 中断行为的正确分类

用户明确指出了三件套中"打开背包"处理的偏差：

| 操作 | 正确行为 | 原设计 | 修正 |
|------|---------|--------|------|
| WASD移动 | 中断导航，解锁预览，回到跟随鼠标 | ✅ 正确 | 无需修改 |
| 切换物品 | 中断导航，解锁预览，回到跟随鼠标 | ✅ 正确 | 无需修改 |
| ESC | 中断导航，解锁预览，回到跟随鼠标 | ✅ 正确 | 无需修改 |
| 打开背包/面板 | **不中断**，面板冻结所有事件，导航状态保留 | ❌ 原设计写了"取消导航" | 需要修正 |
| 关闭背包/面板 | 恢复之前的状态（如果之前在导航就继续导航） | ❌ 原设计未考虑 | 需要新增 |
| 导航中重新点击 | 中断当前导航，重新锁定新位置，重新开始 | ⚠️ 原设计有E2但实现有缺陷 | 需要修正 |

### 4.2 核心原则

> "撤回权始终在玩家手中，操作必须可中断可撤回，撤回回到最初的跟随鼠标状态"

> "打开面板是中断时间，同时也中断各种事件进行" — 面板本身就是事件屏蔽器，不需要额外取消导航

> "重新点击是中断并重新启动，修改目的地是优化方案而非初始实现"

---

## 五、需要更新的文档

1. **design.md** — 修正锁定逻辑（视觉与数据分离）、修正面板行为、明确中断分类
2. **tasks.md** — 修正 Task 1.2/2.2 的锁定逻辑、修正面板相关任务、新增实时数据更新任务
3. **requirements.md** — 修正 AC-2.2（ESC 行为）和 E3/E4（面板行为）

---

## 六、采纳决策

| # | 锐评指令 | 采纳程度 | 调整说明 |
|---|---------|---------|---------|
| 盲人导航修复 | ✅ 完全采纳 | 视觉与数据分离 |
| WASD 屏蔽 | ⚠️ 概念采纳 | 已有 ToolActionLockManager 处理 |
| UnlockPosition 原子性 | ✅ 完全采纳 | 统一 ResetState 方法 |
| 面板行为 | ❌ 不采纳原设计 | 按用户修正：面板不中断导航 |

---

**结论**：锐评002 的"盲人导航"诊断完全正确，需要更新三件套。同时结合用户反馈修正面板行为和中断分类。
