# 农田系统全面交互矩阵

**创建日期**: 2026-02-09  
**目的**: 全面梳理农田系统所有交互场景，对比放置系统实现，识别缺陷并制定修复方案

---

## 一、系统对比概览

### 1.1 放置系统架构（参考标准）

| 组件 | 职责 |
|------|------|
| PlacementManager | 状态机核心，协调所有子系统 |
| PlacementPreview | 预览显示，支持锁定/解锁 |
| PlacementNavigator | 导航控制，处理中断 |
| PlacementSnapshot | 快照数据，记录锁定状态 |
| PlacementValidator | 验证逻辑 |

### 1.2 农田系统架构（当前实现）

| 组件 | 职责 | 问题 |
|------|------|------|
| GameInputManager | 输入处理+状态管理（混合） | 职责过重 |
| FarmToolPreview | 预览显示 | 缺少锁定机制 |
| FarmingSnapshot | 快照数据 | 缺少lockedPosition |
| PlayerAutoNavigator | 导航控制 | 中断处理不完整 |


---

## 二、状态机对比

### 2.1 放置系统状态机（4状态）

```
Idle → Preview → Locked → Navigating
  ↑       ↓         ↓          ↓
  └───────┴─────────┴──────────┘
         (取消/完成/中断)
```

| 状态 | 触发条件 | 行为 |
|------|---------|------|
| Idle | 初始/取消/完成 | 无预览，无导航 |
| Preview | 选中可放置物品 | 预览跟随鼠标 |
| Locked | 点击有效位置 | 预览锁定，创建快照 |
| Navigating | 距离过远 | 玩家移动中，预览保持锁定 |

### 2.2 农田系统状态机（当前：3状态，缺陷）

```
Idle → Preview → Navigating
  ↑       ↓          ↓
  └───────┴──────────┘
       (取消/完成)
```

| 状态 | 触发条件 | 行为 | 🔴 问题 |
|------|---------|------|--------|
| Idle | 初始/取消/完成 | 无预览 | - |
| Preview | 选中农具 | 预览跟随鼠标 | - |
| Navigating | 点击远处 | 玩家移动 | **缺少Locked状态！** |

### 2.3 缺失的 Locked 状态

**放置系统**：点击后立即进入 Locked → 预览固定 → 然后判断是否需要导航

**农田系统**：点击后直接进入 Navigating → 预览仍跟随鼠标 → BUG！


---

## 三、核心交互场景矩阵

### 3.1 场景A：近距离点击（可直接执行）

| 步骤 | 放置系统 | 农田系统（当前） | 农田系统（期望） |
|------|---------|----------------|----------------|
| 1. 点击 | 验证位置 | 验证位置 | ✅ 相同 |
| 2. 锁定 | LockPreviewPosition() | ❌ 无 | 需要添加 |
| 3. 创建快照 | 含lockedPosition | ❌ 缺少字段 | 需要添加 |
| 4. 执行 | ExecutePlacement() | ExecuteFarming() | ✅ 相同 |
| 5. 清理 | ClearSnapshot() | ClearSnapshot() | ✅ 相同 |
| 6. 解锁 | UnlockPreview() | ❌ 无 | 需要添加 |

### 3.2 场景B：远距离点击（需要导航）

| 步骤 | 放置系统 | 农田系统（当前） | 农田系统（期望） |
|------|---------|----------------|----------------|
| 1. 点击 | 验证位置 | 验证位置 | ✅ 相同 |
| 2. 锁定预览 | LockPreviewPosition() | ❌ 无 | **必须添加** |
| 3. 创建快照 | 含lockedPosition | ❌ 缺少 | **必须添加** |
| 4. 开始导航 | StartNavigation() | StartFarmingNavigation() | ✅ 相同 |
| 5. 导航中 | 预览保持锁定 | ❌ 预览跟随鼠标 | **必须修复** |
| 6. 到达 | OnNavigationComplete | OnFarmingNavigationComplete | ✅ 相同 |
| 7. 执行 | ExecutePlacement() | ExecuteFarming() | ✅ 相同 |
| 8. 清理 | ClearSnapshot()+Unlock | ❌ 不完整 | **必须修复** |


### 3.3 场景C：导航中取消（右键/ESC）

| 步骤 | 放置系统 | 农田系统（当前） | 农田系统（期望） |
|------|---------|----------------|----------------|
| 1. 检测取消 | HandleInterrupt() | CancelFarmingNavigation() | ✅ 相同 |
| 2. 停止导航 | StopNavigation() | StopNavigation() | ✅ 相同 |
| 3. 清除快照 | ClearSnapshot() | ClearSnapshot() | ✅ 相同 |
| 4. 解锁预览 | UnlockPreview() | ❌ 无 | **必须添加** |
| 5. 恢复状态 | → Preview | ❌ 预览消失 | **必须修复** |

### 3.4 场景D：导航中切换物品

| 步骤 | 放置系统 | 农田系统（当前） | 农田系统（期望） |
|------|---------|----------------|----------------|
| 1. 检测切换 | OnSelectedChanged | ❌ 未订阅 | **必须订阅** |
| 2. 中断导航 | HandleInterrupt() | ❌ 无 | **必须添加** |
| 3. 清除快照 | ClearSnapshot() | ❌ 无 | **必须添加** |
| 4. 隐藏预览 | HidePreview() | ❌ 预览残留 | **必须修复** |
| 5. 更新状态 | → Idle 或新Preview | ❌ 状态混乱 | **必须修复** |

### 3.5 场景E：导航中点击其他位置

| 步骤 | 放置系统 | 农田系统（当前） | 农田系统（期望） |
|------|---------|----------------|----------------|
| 1. 检测新点击 | 在Navigating状态 | 在导航中 | ✅ 相同 |
| 2. 中断旧导航 | HandleInterrupt() | ❌ 无 | **必须添加** |
| 3. 验证新位置 | ValidatePosition() | ❌ 无 | **必须添加** |
| 4. 锁定新位置 | LockPreviewPosition() | ❌ 无 | **必须添加** |
| 5. 开始新导航 | StartNavigation() | ❌ 无 | **必须添加** |


---

## 四、事件订阅对比

### 4.1 放置系统事件订阅

```csharp
// PlacementManager.cs
private void OnEnable()
{
    HotbarSelectionService.OnSelectedChanged += OnSelectedChanged;
    HotbarSelectionService.OnSlotChanged += OnSlotChanged;
}
```

### 4.2 农田系统事件订阅（当前）

```csharp
// GameInputManager.cs
// ❌ 未订阅任何 HotbarSelectionService 事件！
```

### 4.3 缺失的事件处理

| 事件 | 放置系统处理 | 农田系统处理 | 影响 |
|------|-------------|-------------|------|
| OnSelectedChanged | 中断放置，更新预览 | ❌ 无 | 切换物品时预览残留 |
| OnSlotChanged | 中断放置，更新预览 | ❌ 无 | 槽位变化时状态混乱 |

---

## 五、快照机制对比

### 5.1 放置系统快照

```csharp
public class PlacementSnapshot
{
    public int ItemId;
    public int Quality;
    public int SlotIndex;
    public Vector3Int LockedPosition;  // ✅ 锁定位置
}
```

### 5.2 农田系统快照（当前）

```csharp
public class FarmingSnapshot
{
    public int ItemId;
    public int SlotIndex;
    public Vector3Int TargetCell;
    // ❌ 缺少 Quality
    // ❌ 缺少 LockedPosition
}
```

### 5.3 快照字段对比

| 字段 | 放置系统 | 农田系统 | 说明 |
|------|---------|---------|------|
| ItemId | ✅ | ✅ | 物品ID |
| Quality | ✅ | ❌ | 品质（种子需要） |
| SlotIndex | ✅ | ✅ | 槽位索引 |
| LockedPosition | ✅ | ❌ | 锁定的世界位置 |
| TargetCell | - | ✅ | 目标格子（农田特有） |


---

## 六、预览系统对比

### 6.1 放置系统预览（PlacementPreview）

```csharp
public class PlacementPreview
{
    private bool _isLocked;
    private Vector3 _lockedPosition;
    
    public void LockPosition(Vector3 position)
    {
        _isLocked = true;
        _lockedPosition = position;
    }
    
    public void UnlockPosition()
    {
        _isLocked = false;
    }
    
    public void UpdatePosition(Vector3 mouseWorldPos)
    {
        if (_isLocked) return;  // 锁定时不更新
        // 更新预览位置
    }
}
```

### 6.2 农田系统预览（FarmToolPreview）

```csharp
public class FarmToolPreview
{
    // ❌ 无 _isLocked 字段
    // ❌ 无 _lockedPosition 字段
    // ❌ 无 LockPosition() 方法
    // ❌ 无 UnlockPosition() 方法
    
    public void UpdatePosition(Vector3 mouseWorldPos)
    {
        // 始终更新，无锁定检查
    }
}
```

### 6.3 预览功能对比

| 功能 | PlacementPreview | FarmToolPreview | 状态 |
|------|-----------------|-----------------|------|
| 显示预览 | ✅ | ✅ | 正常 |
| 跟随鼠标 | ✅ | ✅ | 正常 |
| 锁定位置 | ✅ LockPosition() | ❌ 无 | **缺失** |
| 解锁位置 | ✅ UnlockPosition() | ❌ 无 | **缺失** |
| 锁定状态检查 | ✅ if(_isLocked) | ❌ 无 | **缺失** |

---

## 七、导航中断处理对比

### 7.1 放置系统中断处理

```csharp
// PlacementManager.cs
private void HandleInterrupt()
{
    if (_currentState == PlacementState.Navigating)
    {
        _navigator.StopNavigation();
    }
    
    ClearSnapshot();
    _preview.UnlockPosition();
    
    // 根据当前物品决定下一状态
    if (HasPlaceableItem())
        SetState(PlacementState.Preview);
    else
        SetState(PlacementState.Idle);
}
```

### 7.2 农田系统中断处理（当前）

```csharp
// GameInputManager.cs
private void CancelFarmingNavigation()
{
    if (_isFarmingNavigating)
    {
        _navigator.StopNavigation();
        _isFarmingNavigating = false;
        ClearFarmingSnapshot();
        // ❌ 未调用 _farmToolPreview.UnlockPosition()
        // ❌ 未恢复预览状态
    }
}
```


---

## 八、执行保护机制对比

### 8.1 放置系统执行保护

```csharp
// PlacementManager.cs
private bool _isExecutingPlacement = false;

private void ExecutePlacement()
{
    if (_isExecutingPlacement) return;  // 防止重复执行
    _isExecutingPlacement = true;
    
    try
    {
        // 执行放置逻辑
    }
    finally
    {
        _isExecutingPlacement = false;
    }
}
```

### 8.2 农田系统执行保护（当前）

```csharp
// GameInputManager.cs
// ❌ 无 _isExecutingFarming 标志
// ❌ 无重复执行保护
```

---

## 九、问题汇总与修复优先级

### 9.1 P0 - 必须立即修复

| # | 问题 | 影响 | 修复方案 |
|---|------|------|---------|
| 1 | FarmToolPreview 缺少锁定机制 | 导航中预览跟随鼠标 | 添加 LockPosition/UnlockPosition |
| 2 | FarmingSnapshot 缺少 lockedPosition | 无法记录锁定位置 | 添加字段 |
| 3 | CancelFarmingNavigation 不解锁预览 | 取消后预览消失 | 调用 UnlockPosition |
| 4 | 未订阅 OnSelectedChanged | 切换物品时状态混乱 | 添加事件订阅 |

### 9.2 P1 - 重要修复

| # | 问题 | 影响 | 修复方案 |
|---|------|------|---------|
| 5 | 缺少 Locked 状态 | 状态机不完整 | 添加状态 |
| 6 | 缺少执行保护标志 | 可能重复执行 | 添加 _isExecutingFarming |
| 7 | 导航中点击其他位置无处理 | 无法更换目标 | 添加中断+重新导航逻辑 |

### 9.3 P2 - 优化项

| # | 问题 | 影响 | 修复方案 |
|---|------|------|---------|
| 8 | FarmingSnapshot 缺少 Quality | 种子品质丢失 | 添加字段 |
| 9 | 状态管理分散在 GameInputManager | 代码难维护 | 考虑提取 FarmingManager |


---

## 十、修复实施计划

### 10.1 第一阶段：预览锁定机制

**目标**：让 FarmToolPreview 支持锁定/解锁

```csharp
// FarmToolPreview.cs 需要添加
private bool _isLocked = false;
private Vector3 _lockedWorldPosition;

public void LockPosition(Vector3 worldPosition)
{
    _isLocked = true;
    _lockedWorldPosition = worldPosition;
    // 更新预览到锁定位置
}

public void UnlockPosition()
{
    _isLocked = false;
}

public void UpdatePreview(Vector3 mouseWorldPos)
{
    if (_isLocked) return;  // 锁定时不更新
    // 原有逻辑
}
```

### 10.2 第二阶段：快照机制完善

**目标**：FarmingSnapshot 包含完整信息

```csharp
// FarmingSnapshot 需要添加
public Vector3 LockedWorldPosition;
public int Quality;
```

### 10.3 第三阶段：事件订阅

**目标**：响应物品切换事件

```csharp
// GameInputManager.cs 需要添加
private void OnEnable()
{
    HotbarSelectionService.OnSelectedChanged += OnHotbarSelectedChanged;
}

private void OnHotbarSelectedChanged(int oldIndex, int newIndex)
{
    if (_isFarmingNavigating)
    {
        CancelFarmingNavigation();
    }
    // 更新预览状态
}
```

### 10.4 第四阶段：中断处理完善

**目标**：CancelFarmingNavigation 完整处理

```csharp
private void CancelFarmingNavigation()
{
    if (_isFarmingNavigating)
    {
        _navigator.StopNavigation();
        _isFarmingNavigating = false;
        ClearFarmingSnapshot();
        
        // ✅ 新增：解锁预览
        if (_farmToolPreview != null)
        {
            _farmToolPreview.UnlockPosition();
        }
        
        // ✅ 新增：恢复预览状态（如果仍持有农具）
        if (HasFarmTool())
        {
            _farmToolPreview.Show();
        }
    }
}
```

---

## 十一、验收标准

### 11.1 场景验收

| 场景 | 验收标准 |
|------|---------|
| 近距离点击 | 预览锁定 → 执行 → 预览解锁恢复跟随 |
| 远距离点击 | 预览锁定 → 导航 → 到达执行 → 预览解锁 |
| 导航中取消 | 预览解锁 → 恢复跟随鼠标 |
| 导航中切换物品 | 取消导航 → 隐藏预览 → 状态正确 |
| 导航中点击新位置 | 取消旧导航 → 锁定新位置 → 开始新导航 |

### 11.2 状态验收

| 状态 | 预览行为 | 导航状态 |
|------|---------|---------|
| Idle | 隐藏 | 无 |
| Preview | 跟随鼠标 | 无 |
| Locked | 固定位置 | 无 |
| Navigating | 固定位置 | 进行中 |

---

**文档完成时间**: 2026-02-09


---

## 十二、放置系统同步修复

### 12.1 用户指出的问题

> "放置系统里面的点击后预览固定玩家移动过去到可触发距离再触发，移动取消后预览也取消固定然后恢复跟随鼠标预览，这一点对于我们当前已经完成的放置系统也是存在这个问题"

### 12.2 放置系统需要验证的场景

| 场景 | 期望行为 | 需要验证 |
|------|---------|---------|
| 点击后预览锁定 | 预览固定在目标位置 | ✅ |
| 导航中预览保持锁定 | 预览不跟随鼠标 | ✅ |
| 取消后预览解锁 | 预览恢复跟随鼠标 | ✅ |
| 执行后预览解锁 | 预览恢复跟随鼠标 | ✅ |

### 12.3 统一修复方案

两个系统应该使用完全一致的交互模式：

```
┌─────────────────────────────────────────────────────────┐
│                    统一交互流程                          │
├─────────────────────────────────────────────────────────┤
│  1. 选中物品 → 显示预览（跟随鼠标）                      │
│  2. 点击有效位置 → 锁定预览（LockPosition）              │
│  3. 判断距离：                                          │
│     ├─ 近距离 → 直接执行 → 解锁预览                     │
│     └─ 远距离 → 开始导航（预览保持锁定）                │
│  4. 导航过程中：                                        │
│     ├─ 到达 → 执行 → 解锁预览                          │
│     ├─ 取消 → 解锁预览 → 恢复跟随鼠标                  │
│     └─ 切换物品 → 取消导航 → 更新/隐藏预览             │
└─────────────────────────────────────────────────────────┘
```

---

## 十三、切换物品场景矩阵

### 13.1 农田系统切换场景

| 当前状态 | 切换到 | 期望行为 |
|---------|--------|---------|
| Idle | 锄头 | 显示锄头预览 |
| Idle | 水壶 | 显示水壶预览 |
| Idle | 种子 | 显示种子预览 |
| Idle | 非农具 | 无预览 |
| Preview(锄头) | 水壶 | 更新为水壶预览 |
| Preview(锄头) | 非农具 | 隐藏预览 |
| Locked | 任何物品 | 解锁 → 更新/隐藏预览 |
| Navigating | 任何物品 | 取消导航 → 解锁 → 更新/隐藏预览 |

### 13.2 放置系统切换场景

| 当前状态 | 切换到 | 期望行为 |
|---------|--------|---------|
| Idle | 可放置物品 | 显示放置预览 |
| Idle | 非放置物品 | 无预览 |
| Preview | 其他可放置物品 | 更新预览 |
| Preview | 非放置物品 | 隐藏预览 |
| Locked | 任何物品 | 解锁 → 更新/隐藏预览 |
| Navigating | 任何物品 | 取消导航 → 解锁 → 更新/隐藏预览 |

### 13.3 跨系统切换场景

| 当前系统 | 当前状态 | 切换到 | 期望行为 |
|---------|---------|--------|---------|
| 农田 | Navigating | 可放置物品 | 取消农田导航 → 显示放置预览 |
| 农田 | Preview | 可放置物品 | 隐藏农田预览 → 显示放置预览 |
| 放置 | Navigating | 农具 | 取消放置导航 → 显示农田预览 |
| 放置 | Preview | 农具 | 隐藏放置预览 → 显示农田预览 |

---

## 十四、完整场景清单

### 14.1 预览场景（6个）

| # | 场景 | 农田系统 | 放置系统 | 修复优先级 |
|---|------|---------|---------|-----------|
| P1 | 选中物品显示预览 | ✅ | ✅ | - |
| P2 | 预览跟随鼠标 | ✅ | ✅ | - |
| P3 | 点击后预览锁定 | ❌ | ⚠️ | P0 |
| P4 | 导航中预览保持锁定 | ❌ | ⚠️ | P0 |
| P5 | 取消后预览解锁恢复跟随 | ❌ | ⚠️ | P0 |
| P6 | 执行后预览解锁恢复跟随 | ❌ | ⚠️ | P0 |

### 14.2 导航场景（6个）

| # | 场景 | 农田系统 | 放置系统 | 修复优先级 |
|---|------|---------|---------|-----------|
| N1 | 远距离点击开始导航 | ✅ | ✅ | - |
| N2 | 导航到达后执行 | ⚠️ | ✅ | P1 |
| N3 | 导航中右键取消 | ⚠️ | ✅ | P1 |
| N4 | 导航中ESC取消 | ⚠️ | ✅ | P1 |
| N5 | 导航中点击新位置 | ❌ | ⚠️ | P1 |
| N6 | 导航中手动移动取消 | ⚠️ | ⚠️ | P1 |

### 14.3 物品切换场景（4个）

| # | 场景 | 农田系统 | 放置系统 | 修复优先级 |
|---|------|---------|---------|-----------|
| S1 | 预览中切换到同类物品 | ❌ | ⚠️ | P1 |
| S2 | 预览中切换到不同类物品 | ❌ | ⚠️ | P1 |
| S3 | 导航中切换物品 | ❌ | ⚠️ | P0 |
| S4 | 执行中切换物品（应忽略） | ❌ | ⚠️ | P1 |

### 14.4 面板场景（3个）

| # | 场景 | 农田系统 | 放置系统 | 修复优先级 |
|---|------|---------|---------|-----------|
| U1 | 打开背包取消导航 | ⚠️ | ⚠️ | P1 |
| U2 | 打开背包隐藏预览 | ⚠️ | ⚠️ | P1 |
| U3 | 关闭背包恢复预览 | ❌ | ❌ | P2 |

### 14.5 状态保护场景（3个）

| # | 场景 | 农田系统 | 放置系统 | 修复优先级 |
|---|------|---------|---------|-----------|
| G1 | 执行中保护（防重复） | ❌ | ✅ | P1 |
| G2 | 快照验证（防种瓜得豆） | ⚠️ | ✅ | P1 |
| G3 | 事件订阅（响应外部变化） | ❌ | ✅ | P0 |

---

## 十五、修复任务清单

### 15.1 农田系统修复任务

| # | 任务 | 优先级 | 预计工作量 |
|---|------|--------|-----------|
| F1 | FarmToolPreview 添加 LockPosition/UnlockPosition | P0 | 中 |
| F2 | FarmToolPreview 添加 _isLocked 状态检查 | P0 | 低 |
| F3 | GameInputManager 点击后调用 LockPosition | P0 | 低 |
| F4 | GameInputManager 取消/执行后调用 UnlockPosition | P0 | 低 |
| F5 | GameInputManager 订阅 OnSelectedChanged | P0 | 中 |
| F6 | GameInputManager 添加 _isExecutingFarming 保护 | P1 | 低 |
| F7 | FarmingSnapshot 添加 LockedPosition 字段 | P1 | 低 |
| F8 | FarmingSnapshot 添加 Quality 字段 | P2 | 低 |

### 15.2 放置系统验证/修复任务

| # | 任务 | 优先级 | 预计工作量 |
|---|------|--------|-----------|
| V1 | 验证 HandleInterrupt 是否正确解锁预览 | P0 | 低 |
| V2 | 验证取消后预览是否恢复跟随鼠标 | P0 | 低 |
| V3 | 验证导航中点击新位置的处理 | P1 | 中 |
| V4 | 验证切换物品时的状态处理 | P1 | 中 |

---

**文档更新时间**: 2026-02-09


---

## 十六、浇水功能问题矩阵（P0 - 用户最新反馈）

### 16.1 浇水功能调用链

```
用户点击左键
    ↓
HandleUseCurrentTool()
    ↓
TryHandleFarmingTool(tool)  ← tool.toolType == WateringCan
    ↓
TryWaterTile(worldPos)
    ↓
┌─────────────────────────────────────────────────────────┐
│  FarmToolPreview.IsValid()  ← 🔴 关键判断点             │
│      ↓                                                  │
│  如果 false → 直接返回，不执行任何动作                  │
│  如果 true  → 继续执行                                  │
└─────────────────────────────────────────────────────────┘
    ↓
判断距离 (IsInRange)
    ├─ 近距离 → RequestAction(Watering) + ExecuteWaterTile
    └─ 远距离 → 创建快照 + StartFarmingNavigation
```

### 16.2 浇水预览验证逻辑

```csharp
// FarmToolPreview.UpdateWateringPreview
bool canWater = tileData != null &&    // 🔴 条件1：耕地数据存在
                tileData.isTilled &&    // 🔴 条件2：已耕作
                !tileData.wateredToday; // 🔴 条件3：今天未浇水

bool isValid = !hasObstacle && canWater;
```

### 16.3 浇水失败场景矩阵

| # | 场景 | 失败原因 | 预览状态 | 用户反馈 | 问题 |
|---|------|---------|---------|---------|------|
| W1 | 点击未耕作地面 | tileData == null | 红色 | 无 | ❌ 无提示 |
| W2 | 点击已浇水耕地 | wateredToday == true | 红色 | 无 | ❌ 无提示 |
| W3 | 点击有障碍物位置 | hasObstacle == true | 红色 | 无 | ❌ 无提示 |
| W4 | 距离太远 | IsInRange == false | 绿色 | 导航 | ⚠️ 可能失败 |
| W5 | FarmTileManager 为 null | Instance == null | 红色 | 无 | ❌ 静默失败 |
| W6 | 楼层索引错误 | layerIndex 不匹配 | 红色 | 无 | ❌ 难以调试 |

### 16.4 浇水功能与锄地功能对比

| 特性 | 锄地 (TryTillSoil) | 浇水 (TryWaterTile) | 差异 |
|------|-------------------|-------------------|------|
| 预览验证 | CanTillAt | canWater | 逻辑不同 |
| 失败反馈 | Debug.Log | Debug.Log | 相同（都不足） |
| 动画触发 | Crush | Watering | 正常 |
| 远距离处理 | 导航+快照 | 导航+快照 | 相同 |
| 执行逻辑 | CreateTile | SetWatered | 正常 |

### 16.5 浇水功能问题优先级

| 优先级 | 问题 | 影响 | 修复方案 |
|--------|------|------|---------|
| P0 | IsValid() 返回 false 时无用户反馈 | 用户不知道为什么浇水失败 | 添加失败原因提示 |
| P0 | tileData 为 null 时静默失败 | 无法浇水但不知道原因 | 增强错误日志 |
| P1 | 浇水动画与逻辑不同步 | 可能播放动画但浇水失败 | 确保动画和逻辑一致 |
| P1 | 远距离浇水快照验证不完整 | 导航途中状态变化 | 完善快照机制 |
| P2 | 楼层检测可能不准确 | 多楼层场景问题 | 优化 GetCurrentLayerIndex |

### 16.6 浇水功能修复任务

| # | 任务 | 优先级 | 预计工作量 |
|---|------|--------|-----------|
| W-F1 | FarmToolPreview 添加 LastFailureReason 属性 | P0 | 低 |
| W-F2 | TryWaterTile 添加失败原因日志 | P0 | 低 |
| W-F3 | 添加浇水失败的 UI 提示（可选） | P1 | 中 |
| W-F4 | 完善远距离浇水的快照验证 | P1 | 中 |
| W-F5 | 优化 GetCurrentLayerIndex 准确性 | P2 | 中 |

### 16.7 浇水功能验收场景

| # | 场景 | 操作 | 期望结果 |
|---|------|------|---------|
| WV1 | 近距离浇水有效耕地 | 点击绿色预览 | 播放动画，浇水成功，预览变红 |
| WV2 | 近距离浇水已浇水耕地 | 点击红色预览 | 无反应 |
| WV3 | 近距离浇水未耕作地面 | 点击红色预览 | 无反应 |
| WV4 | 远距离浇水有效耕地 | 点击绿色预览 | 导航到目标，播放动画，浇水成功 |
| WV5 | 远距离浇水，导航中取消 | 按ESC或右键 | 取消导航，预览恢复跟随 |
| WV6 | 远距离浇水，导航中切换物品 | 滚轮切换 | 取消导航，更新预览 |

