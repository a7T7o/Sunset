# 9.0.5 智能交互Bug修复 - 验收指南

**创建日期**: 2026-02-10

---

## 一、功能验收清单

### US-1：预览锁定与解锁

- [ ] 手持锄头，点击有效位置（绿框），预览框固定在该位置不再跟随鼠标
- [ ] 手持水壶，点击有效位置（蓝框），预览框固定在该位置
- [ ] 手持种子，点击有效位置（绿框），预览框固定在该位置
- [ ] 导航过程中，移动鼠标，预览框保持固定不动
- [ ] 近距离操作完成后，预览框立即恢复跟随鼠标
- [ ] 远距离导航到达并执行后，预览框恢复跟随鼠标

### US-2：导航中断恢复

- [ ] 导航中按 WASD → 中断导航，预览恢复跟随鼠标
- [ ] 导航中按 ESC（无面板打开）→ 中断导航，预览恢复跟随鼠标
- [ ] 导航中左键点击新的有效位置 → 中断当前导航，重新锁定新位置，重新开始导航
- [ ] 导航中左键点击无效位置 → 忽略，继续当前导航
- [ ] 取消后预览颜色正确反映新鼠标位置的有效性

### US-3：切换物品状态清理

- [ ] 导航中滚轮切换物品 → 取消导航，预览更新为新物品类型
- [ ] 导航中数字键切换物品 → 取消导航，预览更新为新物品类型
- [ ] 切换到非农具/非种子 → 隐藏农田预览
- [ ] 切换到可放置物品 → 隐藏农田预览，显示放置预览

### US-4：浇水功能

- [ ] 近距离点击已耕作未浇水的耕地 → 浇水成功
- [ ] 近距离点击已浇水的耕地 → 预览红色，点击无反应
- [ ] 远距离点击有效耕地 → 导航到目标后浇水成功
- [ ] 开启 showDebugInfo 后，浇水失败时控制台输出具体原因

### US-5：执行保护

- [ ] 执行锄地/浇水/种植时，快速点击不会重复触发
- [ ] 执行完成后，可以正常进行下一次操作

### 面板交互（关键修正）

- [ ] 导航中按 Tab 打开背包 → 导航不中断，面板打开
- [ ] 关闭背包后 → 导航继续（如果之前在导航）
- [ ] 导航中按 B/M/L/O 打开面板 → 导航不中断
- [ ] 无导航时按 ESC → 正常打开设置

---

## 二、测试步骤

### 基础测试流程

1. 进入游戏，手持锄头
2. 点击远处有效位置 → 观察预览是否锁定
3. 等待导航到达 → 观察是否自动执行锄地
4. 执行完成后 → 观察预览是否恢复跟随鼠标
5. 重复以上步骤测试水壶和种子

### 中断测试流程

1. 手持锄头，点击远处有效位置（开始导航）
2. 导航中按 W → 观察导航是否中断，预览是否恢复跟随
3. 重新点击远处 → 开始新导航
4. 导航中按 Tab → 观察面板是否打开，导航是否继续
5. 关闭面板 → 观察导航是否恢复

---

## 三、已知限制

1. 面板打开期间预览不更新（设计如此，面板冻结事件）
2. 导航中重新点击是完整的中断+重启，不是"修改目的地"优化（后续迭代）
3. 浇水失败原因日志需要开启 showDebugInfo 才能看到

---

## 四、修改的文件

| 文件 | 修改内容 |
|------|---------|
| `FarmToolPreview.cs` | 锁定机制、视觉-数据分离、浇水失败原因枚举 |
| `GameInputManager.cs` | 5状态机、锁定逻辑、中断恢复、面板不中断导航、执行保护、重新点击处理 |


---

## 五、会话 7 补充修复（2026-02-10）

### Bug A/B 修复验证：红色预览点击不触发动作

- [ ] 手持锄头，鼠标在无效位置（红框），左键点击 → 不播放动画，不执行任何动作
- [ ] 手持水壶，鼠标在无效位置（红框），左键点击 → 不播放动画，不执行任何动作
- [ ] 导航中点击红色位置 → 取消导航，恢复鼠标跟随预览

### Bug C 修复验证：浇水水渍系统

**⚠️ 前置步骤（必须）**:
1. 在 Unity Inspector 中找到 FarmTileManager 组件
2. 展开 `Layer Tilemaps` 数组
3. 将场景中的 WaterPuddle Tilemap 拖入 `Water Puddle Tilemap New` 字段
4. 确认 FarmVisualManager 的 `Wet Puddle Tiles` 数组已配置 3 种水渍 Tile

**验收步骤**:
- [ ] 锄地后浇水 → 耕地上出现水渍 Tile
- [ ] 水渍 Tile 有 3 种随机变体
- [ ] 等待 2 小时（游戏时间）→ 水渍消失，变为深色土壤
- [ ] 第二天开始 → 所有浇水状态重置
- [ ] 读档后 → 水渍状态正确恢复

### Bug D 修复验证：WASD 取消放置系统导航

- [ ] 手持可放置物品，点击远处有效位置开始导航
- [ ] 导航中按 WASD → 导航取消，预览恢复跟随鼠标

### Bug E 修复验证：面板打开不中断放置系统

- [ ] 手持可放置物品，点击远处有效位置开始导航
- [ ] 导航中按 Tab 打开背包 → 导航不中断，只隐藏预览
- [ ] 关闭背包 → 导航继续

### Bug F 修复验证：右键导航立即重置农田预览

- [ ] 手持锄头，锁定预览后
- [ ] 右键点击其他位置（自动导航）→ 农田预览立即解锁，恢复跟随鼠标

### Bug G 修复验证：放置系统导航中点击红色

- [ ] 手持可放置物品，导航中
- [ ] 点击红色（无效）位置 → 取消导航，恢复跟随鼠标

---

## 六、修改的文件（完整清单）

| 文件 | 修改内容 |
|------|---------|
| `FarmToolPreview.cs` | 锁定机制、视觉-数据分离、浇水失败原因枚举 |
| `GameInputManager.cs` | 5状态机、锁定逻辑、中断恢复、面板不中断导航、执行保护、重新点击处理、Bug A/B/D/F 修复 |
| `PlacementManager.cs` | Bug D/E/G 修复、InterruptFromExternal() 新增 |
| `LayerTilemaps.cs` | Bug C — 新增 waterPuddleTilemapNew 字段 |
| `FarmVisualManager.cs` | Bug C — UpdateTileVisual/ClearTileVisual 使用新版字段 |
| `FarmTileManager.cs` | Bug C — SetWatered 调用视觉更新、ClearAllTiles 使用新版字段 |
