# 锐评001 专业审视报告

**审视时间**: 2026-02-06
**锐评来源**: `.kiro/specs/农田系统/9.0.2放置农田/0文档锐评001.md`
**审视者**: Kiro

---

## 一、锐评核心指控验证

### 指控 1：GameInputManager 使用 `Camera.main.ScreenToWorldPoint` 裸算

**验证结果**: ✅ **部分成立**

**代码证据** (`GameInputManager.cs` 第 920-930 行):
```csharp
private Vector3 GetMouseWorldPosition()
{
    var cam = worldCamera != null ? worldCamera : Camera.main;
    if (cam == null) return Vector3.zero;
    
    Vector3 mousePos = Input.mousePosition;
    Vector3 worldPos = cam.ScreenToWorldPoint(new Vector3(mousePos.x, mousePos.y, 0f));
    worldPos.z = 0f;
    
    return worldPos;
}
```

**但是**，在 `TryTillSoil` 方法中（第 840-870 行），代码**已经使用了格子中心对齐**：
```csharp
// 转换为格子坐标
Vector3Int cellPosition = tilemaps.WorldToCell(worldPosition);

// ★ 精确距离检测：使用格子中心位置
Vector3 cellCenter = tilemaps.GetCellCenterWorld(cellPosition);
```

**结论**: 锐评指控"裸算"是**过时的**。当前代码已经通过 `WorldToCell` + `GetCellCenterWorld` 实现了格子对齐，只是没有使用 `PlacementGridCalculator`。

---

### 指控 2：农田工具没有预览系统

**验证结果**: ✅ **完全成立**

**代码证据**: 
- `GameInputManager.HandleUseCurrentTool()` 直接调用 `TryHandleFarmingTool()`
- 没有任何预览逻辑
- 玩家手持锄头时，看不到目标格子的高亮

**结论**: 这是**真实的体验问题**，需要解决。

---

### 指控 3：重复锄地问题

**验证结果**: ❌ **不成立**

**代码证据** (`FarmTileManager.CanTillAt` 第 280-290 行):
```csharp
// 检查是否已存在耕地
if (layerTiles.TryGetValue(cellPosition, out var existingTile))
{
    if (existingTile.isTilled)
    {
        return false;  // ★ 已有耕地，返回 false
    }
}
```

**结论**: 代码已经有重复锄地防御，锐评指控不成立。

---

### 指控 4：坐标偏移问题

**验证结果**: ❌ **不成立**

**代码证据** (`GameInputManager.TryTillSoil` 第 850-860 行):
```csharp
// 转换为格子坐标
Vector3Int cellPosition = tilemaps.WorldToCell(worldPosition);

// ★ 精确距离检测：使用格子中心位置
Vector3 cellCenter = tilemaps.GetCellCenterWorld(cellPosition);
```

**结论**: 代码使用 `WorldToCell` 转换坐标，然后用 `GetCellCenterWorld` 获取格子中心，这与 `PlacementGridCalculator.GetCellCenter` 的 `Floor + 0.5` 算法**等效**。

---

## 二、锐评方案的深度分析

### 2.1 "大一统"方案的优点

1. **代码复用**: 共享 `PlacementGridCalculator` 的坐标计算
2. **视觉一致性**: 农田工具也有预览，与放置系统体验一致
3. **架构统一**: 减少重复代码

### 2.2 "大一统"方案的**严重问题**

#### 问题 A：农田是 1+8 模式，不是简单的 1x1 放置

**核心差异**:
- **放置系统**: 放置一个物品，占用 NxM 格子
- **农田系统**: 锄一个格子，**自动生成周围 8 个边界 Tile**

**预览复杂度对比**:

| 系统 | 预览内容 | 复杂度 |
|------|---------|--------|
| 放置系统 | 1 个物品 + NxM 格子高亮 | 简单 |
| 农田系统 | 1 个中心块 + 8 个边界 Tile 的**动态变化** | 复杂 |

**农田预览的特殊需求**:
1. 显示中心块位置（绿/红）
2. 显示周围 8 个边界 Tile 的**预期变化**
3. 如果相邻已有耕地，边界 Tile 会**合并**，预览需要反映这一点

#### 问题 B：PlacementPreview 不支持动态边界预览

`PlacementPreview` 的设计是：
- 显示一个固定的 Sprite
- 显示 NxM 个格子高亮
- 格子状态只有 valid/invalid 两种

**农田预览需要**:
- 显示中心块 Sprite
- 显示 8 个边界 Tile 的**具体样式**（U/D/L/R/UL/UR/DL/DR...）
- 边界样式取决于**周围已有耕地的分布**

#### 问题 C：强行复用会导致代码更复杂

如果强行让农田系统"寄生"在放置系统上：
1. `PlacementPreview` 需要大量修改以支持动态边界
2. `PlacementValidator` 需要扩展以支持农田验证
3. `PlacementManager` 需要添加"农田模式"分支
4. 最终代码量可能比独立实现更多

---

## 三、我的独立思考与替代方案

### 3.1 认同的部分

1. **农田工具需要预览** - 这是真实的体验问题
2. **坐标计算应该统一** - 可以复用 `PlacementGridCalculator.GetCellCenter`
3. **视觉反馈很重要** - 玩家应该知道锄头会落在哪里

### 3.2 不认同的部分

1. **不应该强行"寄生"在放置系统上** - 农田的 1+8 模式与放置系统的 NxM 模式本质不同
2. **不应该修改 PlacementPreview** - 会破坏放置系统的稳定性
3. **不应该废弃 GameInputManager 的坐标计算** - 当前代码已经正确使用 `WorldToCell`

### 3.3 替代方案：独立的 FarmToolPreview

**核心思路**: 创建一个专门的 `FarmToolPreview` 组件，而不是复用 `PlacementPreview`

**架构设计**:
```
FarmToolPreview (新组件)
├── 中心块预览 (1x1 格子高亮)
├── 边界预览 (8 个方向的边界 Tile 预览)
└── 验证逻辑 (调用 FarmTileManager.CanTillAt)
```

**预览逻辑**:
1. 鼠标移动 → 计算目标格子（使用 `PlacementGridCalculator.GetCellCenter`）
2. 调用 `FarmTileManager.CanTillAt` 判断是否可锄
3. 调用 `FarmlandBorderManager.PreviewBordersAround` 获取边界预览
4. 显示中心块 + 8 个边界的预期样式

**优点**:
- 不破坏现有放置系统
- 专门针对农田的 1+8 模式设计
- 可以精确预览边界变化
- 代码职责清晰

---

## 四、最终建议

### 4.1 采纳的锐评建议

| 建议 | 采纳程度 | 实现方式 |
|------|---------|---------|
| 统一坐标计算 | ✅ 部分采纳 | 在 `GetMouseWorldPosition` 后调用 `PlacementGridCalculator.GetCellCenter` |
| 农田工具预览 | ✅ 完全采纳 | 创建独立的 `FarmToolPreview` 组件 |
| 废弃 GameInputManager 坐标计算 | ❌ 不采纳 | 当前代码已正确，只需微调 |
| 寄生在放置系统上 | ❌ 不采纳 | 农田 1+8 模式与放置系统本质不同 |

### 4.2 推荐的实现路线

**Phase 1: 坐标统一（低风险）**
- 在 `GetMouseWorldPosition` 返回前，调用 `PlacementGridCalculator.GetCellCenter` 对齐
- 这是最小改动，不影响现有逻辑

**Phase 2: 农田预览系统（中等复杂度）**
- 创建 `FarmToolPreview` 组件
- 实现中心块预览（绿/红高亮）
- 实现边界预览（显示 8 个方向的预期边界样式）

**Phase 3: 视觉优化（可选）**
- 添加预览动画
- 添加音效反馈

---

## 五、风险评估

| 风险 | 等级 | 说明 |
|------|------|------|
| 强行复用 PlacementPreview | 🔴 高 | 会破坏放置系统稳定性 |
| 创建独立 FarmToolPreview | 🟡 中 | 需要新增代码，但不影响现有系统 |
| 只做坐标统一 | 🟢 低 | 最小改动，风险可控 |

---

## 六、结论

锐评001的核心观点（农田工具需要预览）是正确的，但"大一统"方案过于激进，忽视了农田系统 1+8 模式的特殊性。

**推荐方案**: 创建独立的 `FarmToolPreview` 组件，复用 `PlacementGridCalculator` 的坐标计算，但不强行寄生在放置系统上。

---

**请用户确认**:
1. 是否认同上述分析？
2. 是否采纳"独立 FarmToolPreview"方案？
3. 是否需要我进一步细化设计文档？
