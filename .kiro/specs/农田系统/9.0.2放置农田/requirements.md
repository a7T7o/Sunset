# 9.0.2 农田放置系统 - 需求文档

**创建时间**: 2026-02-06
**工作区**: 9.0.2放置农田
**核心目标**: 实现高精度的农田工具交互与预览，统一坐标系，消除操作手感割裂

---

## 用户故事

### US-1 统一坐标系 (Coordinate Unification)

**作为**玩家，
**我希望**农田工具的操作位置与放置系统保持一致，
**以便**获得统一的操作手感。

#### 验收标准

- **AC-1.1**: 所有农田交互（锄地、浇水、高亮）必须使用 `PlacementGridCalculator.GetCellCenter` 进行坐标对齐
- **AC-1.2**: 彻底移除 `GameInputManager` 中私有的 `ScreenToWorldPoint` 逻辑，统一使用网格计算器
- **AC-1.3**: 农田工具的点击判定与放置系统的点击判定使用相同的坐标转换逻辑

---

### US-2 锄头动态预览 (Hoe Preview - 1+8 模式)

**作为**玩家，
**我希望**在锄地前看到预期的边界变化（虚影），
**以便**知道耕地会连成什么形状。

#### 验收标准

- **AC-2.1**: 手持锄头时，鼠标所在格子显示"操作光标"（绿色=可锄，红色=不可锄）
- **AC-2.2**: **(关键)** 光标绿色时，显示"虚拟幻象"：
  - 当前格子变为中心块
  - 周围 8 格根据邻接规则变为正确的边界 Tile
  - 已存在的耕地不受影响，只显示新增/变化的部分
- **AC-2.3**: 幻象必须是半透明的（Alpha=0.5），且不修改真实的 Tilemap 数据
- **AC-2.4**: 鼠标移动时，预览实时更新

---

### US-3 水壶预览 (Watering Preview)

**作为**玩家，
**我希望**在浇水前看到目标格子的高亮提示，
**以便**知道哪些格子可以浇水。

#### 验收标准

- **AC-3.1**: 手持水壶时，鼠标指向**已耕作**且**干燥**的格子显示蓝色光标
- **AC-3.2**: 鼠标指向非耕地或已浇水耕地，显示红色光标或无光标
- **AC-3.3**: 水壶预览不需要显示 1+8 边界变化（因为浇水不改变边界）

---

### US-4 交互原子性 (Interaction Atomicity)

**作为**玩家，
**我希望**只有在预览显示"可操作"时点击才会执行操作，
**以便**避免误操作。

#### 验收标准

- **AC-4.1**: 只有当预览状态为 Valid（绿色/蓝色）时，左键点击才触发逻辑
- **AC-4.2**: 预览状态为 Invalid（红色）时，左键点击不执行任何操作
- **AC-4.3**: 修复"重复锄地"问题：在 Input 层拦截无效请求，不发送到 Data 层

---

## 非功能性需求

### NFR-1 性能要求

- 预览更新频率：每帧更新（60fps）
- 预览计算时间：< 1ms
- 不产生 GC Alloc（使用对象池或缓存）

### NFR-2 视觉要求

- 预览 Tilemap 的 Sorting Order 高于真实 Tilemap
- 预览透明度：50%
- 光标颜色：绿色(#00FF00)、红色(#FF0000)、蓝色(#0088FF)

---

## 约束条件

1. **不破坏现有功能**：重构 `FarmlandBorderManager` 时，现有的锄地、边界更新逻辑必须保持不变
2. **联邦制架构**：`FarmToolPreview` 独立于 `PlacementPreview`，但共享 `PlacementGridCalculator`
3. **无副作用模拟**：预览计算不能修改任何真实数据

---

## 术语表

| 术语 | 定义 |
|------|------|
| 1+8 模式 | 锄一个格子，该格子变为中心块，周围 8 个格子自动生成边界 |
| 中心块 | 已耕作的格子，显示为泥土纹理 |
| 边界块 | 中心块周围的格子，根据邻接关系显示不同的边界样式 |
| 虚拟幻象 | 预览时显示的半透明 Tile，不修改真实数据 |
| 断言模式 | 通过 `Func<Vector3Int, bool>` 委托实现"假装某位置已耕作"的模拟能力 |
