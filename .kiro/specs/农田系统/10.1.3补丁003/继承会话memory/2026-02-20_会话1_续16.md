# 继承快照 - 会话1续16

## 用户 prompt 完整摘抄

```.kiro/specs/农田系统/10.1.1补丁002/design.md (3-6)
> V3 重组原则：按「修改目标（文件 × 方法/区域）」为主轴。每个版块自包含——现状代码摘要、所有需要的改动、改动后完整伪代码、该版块保证的正确性属性。执行时只需看对应版块。
>
> 来源：`补丁002全面分析与修复方案.md`（11 个改进点：P1/P2a/P2b/P3/P5 + V1/V2/V3/V4/V5/V6）
> 用户确认：Q1 连续点击+FIFO队列（非长按）、Q2 移除右键收获改左键+Collect动画+队列、Q3 成熟作物收获最高优先级、Q4 LockPosition时渲染锁定位置1+8
```请你结合V2和V3来全面更新.kiro\specs\农田系统\10.1.1补丁003\补丁003全面分析与修复方案.md，如果你认为重构一个更符合当前实际情况的话那你可以直接重构，然后对于补丁的重构我希望你的内容更加准确更加全面详细，就像.kiro\specs\农田系统\10.1.1补丁002\design.md我引用的部分，和这个设计一样，这个的设计理念我认为很不错很关键，我认为你需要学习，然后直接一条龙重构design和tasks的内容，一定要注重垂直结构的健壮程度，确保准确性，这样实施了就不会多次回头迭代修复bug，当然这肯定要从根源进行审视和剖析代码做出最准确的设计和任务列表，请你开始一步一步完成以上内容，确保专业准确高效冷静谨慎来完成这个任务，请你开始！

## AI 进度摘要

**已完成**：
（无 — AI 主体尚未开始执行此请求，被压缩中断）

**未完成**：
1. ❌ 读取补丁002 design.md 学习其设计理念（按修改目标为主轴的垂直结构）
2. ❌ 读取补丁003 V3 审视报告（所有方案已锁定）
3. ❌ 读取补丁003 V2 审视报告（一~四、六、八章内容）
4. ❌ 读取当前 design.md 和 tasks.md
5. ❌ 读取所有关键代码文件（CropController、GameInputManager、PlayerInteraction、FarmToolPreview、PlacementPreview、PlacementGridCell、FarmVisualManager）
6. ❌ 重构/更新补丁003全面分析与修复方案.md
7. ❌ 重构 design.md（按补丁002的垂直结构设计理念）
8. ❌ 重构 tasks.md
9. ❌ 更新 memory

## 修改文件列表

无文件修改（AI 被压缩中断，尚未开始执行）。

## 本轮关键决策与用户偏好

### 用户核心需求
1. 结合 V2 和 V3 审视报告全面更新/重构补丁003全面分析与修复方案.md
2. 学习补丁002 design.md 的设计理念：按「修改目标（文件 × 方法/区域）」为主轴，每个版块自包含
3. 一条龙重构 design.md 和 tasks.md
4. 注重垂直结构的健壮程度，确保准确性
5. 从根源审视和剖析代码做出最准确的设计和任务列表

### 用户引用的补丁002设计理念
- V3 重组原则：按「修改目标（文件 × 方法/区域）」为主轴
- 每个版块自包含——现状代码摘要、所有需要的改动、改动后完整伪代码、该版块保证的正确性属性
- 执行时只需看对应版块

### 已锁定的方案（来自V3审视报告，续15已全面锁定）
- P1/P5：手动修改 Prefab 结构（套一层父物体）
- P2：删除任务4（不改 HandleUseCurrentTool 入口），保留任务5（OnActionComplete 长按分支）
- P3：动画帧触发 tile 更新 + `_pendingTileUpdate` 清理策略
- P4：导航入队统一
- P6 预览系统：
  - 种子预览：复刻放置系统树苗放置效果（底部格子方框 + 物品 sprite + 颜色切换）
  - 耕地预览：取消方框，方案C（程序化 SpriteRenderer 覆盖层）
  - 浇水预览：随机水渍样式 + 颜色覆盖
  - 队列预览：双 Tilemap 分离 + SpriteRenderer 对象池
- 前置任务：CropController 添加 GetFirstStageSprite()、FarmVisualManager 暴露水渍 tile 访问接口

### V3 报告 7 个漏洞
- V1：ClearActionQueue 未清理 _pendingTileUpdate（高）
- V2：长按/松开分支清理顺序不一致（中）
- V3：Tilemap.SetColor 是乘法混合（高，方案C已锁定）
- V4：ClearGhostTilemap 会清除队列预览（高，双 Tilemap 方案已提出）
- V5：CropController.stages 是 private（中）
- V6：design.md 任务4 方向错误（中）
- V7：外部代码可能依赖 CropController 的 transform.position（中）

## 关联文件与待同步状态

| 文件 | 状态 |
|------|------|
| `003三件套审视报告V3.md` | ✅ 所有方案已锁定（续15完成） |
| `003三件套审视报告V2.md` | ✅ 已修正2.3节（续10），第五点由V3取代 |
| `补丁003全面分析与修复方案.md` | ⚠️ 待重构/更新（用户本轮请求） |
| `design.md` | ⚠️ 待重构（用户本轮请求） |
| `tasks.md` | ⚠️ 待重构（用户本轮请求） |
| `memory.md`（子） | ✅ 已更新到续15 |
| `memory.md`（主） | ✅ 已同步到续15 |

## 遗留问题完整上下文

### 需要读取的参考文件
1. `.kiro/specs/农田系统/10.1.1补丁002/design.md` — 学习其设计理念（按修改目标为主轴的垂直结构）
2. `.kiro/specs/农田系统/10.1.1补丁003/003三件套审视报告V3.md` — 所有已锁定方案
3. `.kiro/specs/农田系统/10.1.1补丁003/003三件套审视报告V2.md` — 一~四、六、八章内容（V3引用但未重复）
4. `.kiro/specs/农田系统/10.1.1补丁003/补丁003全面分析与修复方案.md` — 当前版本，待重构
5. `.kiro/specs/农田系统/10.1.1补丁003/design.md` — 当前版本，待重构
6. `.kiro/specs/农田系统/10.1.1补丁003/tasks.md` — 当前版本，待重构

### 需要读取的代码文件
- `CropController.cs` — P1/P5 作物位置修复、stages private 问题
- `GameInputManager.cs` — P2 长按、P3 队列逻辑、P4 导航入队
- `PlayerInteraction.cs` — P3 OnActionComplete 时序
- `FarmToolPreview.cs` — P6 预览系统改造
- `PlacementPreview.cs` — 种子预览复刻参考
- `PlacementGridCell.cs` — 种子预览底部格子参考
- `FarmVisualManager.cs` — 水渍 tile 资源
- `TreeController.cs` — P1/P5 父子物体参考

### 执行顺序
1. 读取补丁002 design.md 学习设计理念
2. 读取 V3 + V2 审视报告获取所有已锁定方案
3. 读取所有关键代码文件
4. 重构补丁003全面分析与修复方案.md
5. 重构 design.md（按补丁002垂直结构）
6. 重构 tasks.md
7. 更新 memory
