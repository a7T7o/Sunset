# 继承快照 - 会话1续25

> 工作区：`.kiro/specs/农田系统/10.1.1补丁003/`
> 创建时间：2026-02-20

## 用户 Prompt 完整摘抄

你的这个 耕地预览：方案C（程序化 SpriteRenderer 覆盖层），做的太菜了，就只是一个简单的绿色方块在哪里，你的浇水也是一个方块，那还不如设计shader然后双层tilemap呢，也符合我们的预览与实际图层的双层设计，哦对那就是三层了，跟随鼠标的判断预览单独一层使用shader，然后队列预览单独一层无shader，对于实际显示的单独一次无shader，你觉得呢，我觉得应该很方便，因为你的这个程序化 SpriteRenderer 覆盖层实在太雷霆了然后你的队列预览没有执行8+1的逻辑处理适配，以及浇水队列预览的内容和实际浇水出来的不一致，这很怪异，这都是严重bug，请你修复！！！然后我现在测试不了农作物，因为你报错了又，你并没有全面适配新的作物预制体结构，请你全面检查确保正确适配

（附带 Unity 控制台截图，显示：`[GameInputManager] 作物预制体缺少 CropController: 胡萝卜`，来源 GameInputManager.ExecutePlantSeed 第1691行）

## AI 进度摘要

### 已完成
1. ✅ 加载 farming.md steering 规范
2. ✅ 全局搜索 `GetComponent<CropController>` 发现4处需要适配
3. ✅ 读取4处代码上下文（GameInputManager.ExecutePlantSeed、FarmToolPreview.UpdateSeedPreview、DynamicObjectFactory.TryReconstructCrop、CropManager.CreateCrop）
4. ✅ 读取 FarmToolPreview 的 UpdateHoePreview、UpdateWateringPreview、AddQueuePreview 了解当前预览实现
5. ✅ 修复 FarmToolPreview.cs：GetComponent → GetComponentInChildren
6. ✅ 修复 DynamicObjectFactory.cs：GetComponent → GetComponentInChildren
7. ✅ 修复 CropManager.cs：GetComponent → GetComponentInChildren
8. ⚠️ 修复 GameInputManager.cs：strReplace 操作失误，把 `if (controller == null) { Debug.LogError(...)` 也吃掉了，代码结构断裂

### 未完成
1. ❌ **紧急**：修复 GameInputManager.cs ExecutePlantSeed 中被破坏的代码结构
   - 当前状态：第1688行 `var controller = cropObj.GetComponentInChildren<...>();` 后面直接跟 `Destroy(cropObj);`，缺少 `if (controller == null) {` 和 `Debug.LogError(...)` 两行
   - 需要恢复为：`var controller = ...;\n        if (controller == null)\n        {\n            Debug.LogError($"[GameInputManager] 作物预制体缺少 CropController: {seedData.itemName}");\n            Destroy(cropObj);`
2. ❌ getDiagnostics 验证所有4个修改文件
3. ❌ 讨论预览系统方案变更（用户提出shader+三层Tilemap方案替代方案C）
4. ❌ 修复队列预览8+1逻辑缺失（AddQueuePreview中耕地队列只放了中心块tile，没有8个边界tile）
5. ❌ 修复浇水队列预览与实际浇水不一致
6. ❌ 更新 memory（子+主）

## 修改文件列表

| 文件 | 操作 | 说明 |
|------|------|------|
| `GameInputManager.cs` | 修改（⚠️代码断裂） | ExecutePlantSeed GetComponent→GetComponentInChildren，但strReplace吃掉了if块头部 |
| `FarmToolPreview.cs` | 修改 | UpdateSeedPreview 第747行 GetComponent→GetComponentInChildren |
| `DynamicObjectFactory.cs` | 修改 | TryReconstructCrop 第650行 GetComponent→GetComponentInChildren |
| `CropManager.cs` | 修改 | CreateCrop 第116行 GetComponent→GetComponentInChildren |

## 本轮关键决策与用户偏好

- 用户明确否定方案C（程序化SpriteRenderer覆盖层），认为"太菜了，就是绿色方块"
- 用户提出新方案：shader+三层Tilemap
  - 第1层：跟随鼠标的判断预览（使用shader实现颜色效果）
  - 第2层：队列预览（无shader，普通显示）
  - 第3层：实际显示（无shader）
- 用户认为这符合"预览与实际图层的双层设计"理念
- 用户指出队列预览缺少8+1逻辑适配是严重bug
- 用户指出浇水队列预览与实际浇水不一致是严重bug
- 用户要求全面检查作物预制体结构适配

## 关联文件与待同步状态

- `GameInputManager.cs` — ⚠️ 代码结构断裂，需紧急修复（恢复if null检查块）
- `FarmToolPreview.cs` — GetComponentInChildren已修复 ✅，但预览方案需要重新设计
- `DynamicObjectFactory.cs` — GetComponentInChildren已修复 ✅
- `CropManager.cs` — GetComponentInChildren已修复 ✅（已废弃类）
- `designV2.md` — 模块H预览系统设计需要根据用户新方案更新
- `tasksV2.md` — 全部18个任务已完成 ✅，但预览相关任务需要返工

## 遗留问题完整上下文

### 问题1：GameInputManager代码断裂（最紧急）
strReplace 在替换 `GetComponent` 时，oldStr 包含了多行内容，导致 `if (controller == null)` 和 `Debug.LogError` 行被删除。当前第1688行后直接跟 `Destroy(cropObj);`，没有null检查守卫。

修复方案：在 `var controller = cropObj.GetComponentInChildren<...>();` 后面插入：
```
        if (controller == null)
        {
            Debug.LogError($"[GameInputManager] 作物预制体缺少 CropController: {seedData.itemName}");
```

### 问题2：预览系统方案变更（需要先设计后实现）
用户否定方案C，提出shader+三层Tilemap。这是方案级变更，需要：
1. 先讨论确认方案细节（shader类型、Tilemap层级关系、与现有ghostTilemap的关系）
2. 更新designV2.md模块H
3. 重新实现预览系统

### 问题3：队列预览bug（严重）
- AddQueuePreview 中耕地队列只放了中心块tile（通过GetPreviewTiles获取），但没有像UpdateHoePreview那样放8个边界变化tile
- 浇水队列预览使用随机水渍tile，但实际浇水后的视觉效果可能不同（FarmVisualManager.UpdateTileVisual的逻辑）
