# 10.X 纠正任务

**基于**: 10.X纠正设计.md
**执行模式**: 一条龙（用户已授权，跳过逐步审核）

---

## 任务列表

- [x] 1. FarmTileData 新增 cropController 运行时引用
  - 新增 `[System.NonSerialized] public CropController cropController` 字段
  - 不影响序列化和存档

- [x] 2. CropController 新增掉落配置字段
  - 新增 `dropItemData`（ItemData SO）
  - 新增 `dropAmount`（int，默认1）
  - 新增 `dropSpreadRadius`（float，默认0.4f）
  - 新增 `dropQuality`（int，默认0）
  - 新增 `witheredDropItemData`（ItemData SO，可为空）
  - 字段放在新的 `#region 掉落配置` 中

- [x] 3. CropController 重写收获逻辑
  - HarvestMature：改用 `WorldSpawnService.SpawnMultiple(dropItemData, dropQuality, dropAmount, position, dropSpreadRadius)`
  - HarvestWitheredMature：改用 `witheredDropItemData`，数量固定1
  - dropItemData 为空时不掉落，只清除作物
  - DetermineHarvestQuality 标记 `[Obsolete]`
  - 旧的 DropItemToWorld 标记 `[Obsolete]`

- [x] 4. CropController 扩展 DestroyCrop 为 DestroySelf
  - 清除 FarmTileData.cropData（通过 FarmTileManager 获取 tileData）
  - 清除 FarmTileData.cropController 引用
  - 取消注册 PersistentObjectRegistry
  - Destroy(gameObject)

- [x] 5. CropController.Initialize 设置 FarmTileData.cropController
  - 在 Initialize(SeedData, CropInstanceData, int, Vector3Int) 中设置
  - `FarmTileManager.Instance?.GetTileData(layerIndex, cellPosition)?.cropController = this`

- [x] 6. CropController.Load 恢复 FarmTileData.cropController
  - 在 Load() 方法末尾，恢复 layerIndex/cellPosition 后设置引用
  - `FarmTileManager.Instance?.GetTileData(layerIndex, cellPosition)?.cropController = this`

- [x] 7. 播种链路重写（GameInputManager.ExecutePlantSeed）
  - 移除 CropManager.Instance 依赖
  - 直接 Instantiate seedData.cropPrefab
  - seedData.cropPrefab 为空时返回 false + 错误日志
  - 创建 CropInstanceData 并调用 controller.Initialize
  - 设置 tileData.cropController = controller
  - 种子袋自动初始化：ConsumeSeed 前检查 IsSeedBag，未初始化则自动 InitializeSeedBag

- [x] 8. ExecuteTillSoil 替换 CropManager 引用
  - 将 `CropManager.Instance.GetCrop(layerIndex, cellPos)` 替换为 `tileData.cropController`
  - 需要先获取 tileData：`FarmTileManager.Instance.GetTileData(layerIndex, cellPos)`

- [x] 9. FarmToolPreview 替换 CropManager 引用
  - 将 `CropManager.Instance.GetCrop(layerIndex, cellPos)` 替换为通过 FarmTileData 获取
  - 需要确认 FarmToolPreview 能访问 FarmTileManager

- [x] 10. TryHarvestCropAtMouse 标记废弃
  - 整个方法标记 `[Obsolete("收获统一走 IInteractable → CropController.Harvest()")]`

- [x] 11. SeedData 字段标记 Obsolete
  - growthDays 标记 `[Obsolete]`
  - harvestCropID 标记 `[Obsolete]`
  - harvestAmountRange 标记 `[Obsolete]`
  - 更新 OnValidate：移除 harvestCropID 范围验证

- [x] 12. CropManager 整个类标记 Obsolete
  - 类级别标记 `[Obsolete("CropManager 已废弃，播种直接 Instantiate seedData.cropPrefab，收获走 IInteractable")]`
  - 不删除文件

- [x] 13. Unity 编译验证
  - 重编译所有脚本
  - 确认零错误（Obsolete 警告可接受）

- [x] 14. CropSystemTests 适配
  - 适配新的收获逻辑（dropItemData 模式）
  - 确保现有测试不被破坏
  - 新增测试：DestroySelf 清除 FarmTileData 引用

- [x] 15. 更新 farming.md 规范
  - 更新播种链路描述
  - 更新收获机制描述
  - 标注 CropManager 已废弃
  - 新增 FarmTileData.cropController 说明

- [x] 16. 更新 memory.md
  - 追加本次会话记录
  - 记录所有修改的文件
