# 10.X 纠正 — 验收指南

**工作区**: `.kiro/specs/农田系统/10.0.2.1纠正/`
**核心目标**: 废弃 CropManager，全面对齐树木系统 Prefab 驱动模式
**完成日期**: 2026-02-14

---

## 一、前置配置（Inspector 操作）

> ⚠️ 以下配置必须在 Unity Inspector 中手动完成，否则功能无法正常工作。

### 1.1 CropController Prefab 配置

对每个作物 Prefab（如小麦、胡萝卜等）的 CropController 组件：

- [ ] `dropItemData` — 拖入对应的收获物品 SO（如 CropData_Wheat）
- [ ] `dropAmount` — 设置收获数量（默认 1）
- [ ] `dropSpreadRadius` — 设置掉落散布半径（默认 0.4）
- [ ] `dropQuality` — 设置掉落品质（默认 0 = Normal）
- [ ] `witheredDropItemData` — 拖入枯萎收获物品 SO（可为空，空=不掉落）

### 1.2 SeedData SO 配置

确认每个 SeedData 的 `cropPrefab` 字段已正确配置：

- [ ] 每种种子的 `cropPrefab` 指向对应的作物 Prefab

### 1.3 场景配置

- [ ] 场景中**不需要** CropManager 组件（已废弃）
- [ ] 如果场景中仍有 CropManager，不会报错，只是不再被调用

---

## 二、功能验收

### 2.1 播种流程（核心变更）

**测试步骤**:
1. 手持种子袋，在已耕地上点击种植
2. 观察作物是否正确生成

**验收标准**:
- [ ] 种子成功种植，作物 Prefab 正确实例化
- [ ] 种子袋数量正确减少
- [ ] 不同种子种出不同作物（使用各自的 cropPrefab）
- [ ] 未耕地上无法种植
- [ ] 已有作物的格子无法重复种植

### 2.2 种子袋自动初始化

**测试步骤**:
1. 通过 InventoryBootstrap 注入种子（非正常获取途径）
2. 尝试种植

**验收标准**:
- [ ] 注入的种子能正常种植（自动初始化种子袋）
- [ ] 种子袋剩余数量正确显示

### 2.3 收获流程（核心变更）

**测试步骤**:
1. 等待作物成熟
2. 右键点击成熟作物（IInteractable 路径）

**验收标准**:
- [ ] 收获物品**掉落到地面**（不再直接加背包）
- [ ] 掉落物品类型正确（对应 dropItemData 配置）
- [ ] 掉落数量正确（对应 dropAmount 配置）
- [ ] 掉落位置在作物附近散布（dropSpreadRadius）
- [ ] 可重复收获的作物：收获后重置到再生阶段
- [ ] 不可重复收获的作物：收获后作物被销毁

### 2.4 枯萎作物收获

**测试步骤**:
1. 让作物枯萎到成熟枯萎阶段
2. 右键点击枯萎作物

**验收标准**:
- [ ] 配置了 witheredDropItemData 的：掉落枯萎物品（数量 1）
- [ ] 未配置 witheredDropItemData 的：不掉落，直接清除
- [ ] 枯萎作物收获后被销毁

### 2.5 枯萎作物清除（锄头）

**测试步骤**:
1. 手持锄头，对枯萎未成熟作物使用

**验收标准**:
- [ ] 锄头能正确检测枯萎作物（通过 FarmTileData.cropController）
- [ ] 枯萎作物被清除，耕地恢复

### 2.6 作物销毁清理

**验收标准**:
- [ ] 作物销毁后，FarmTileData.cropController 被清除为 null
- [ ] 作物销毁后，PersistentObjectRegistry 取消注册
- [ ] 销毁后的格子可以重新种植

---

## 三、存档兼容性验收

### 3.1 新存档

- [ ] 新游戏中播种→存档→读档，作物正常恢复
- [ ] 读档后 FarmTileData.cropController 引用正确恢复

### 3.2 旧存档（如有）

- [ ] 旧存档能正常加载（SeedData 旧字段标记 Obsolete 但未删除）
- [ ] 旧存档中的作物能正常显示和交互

---

## 四、编译与测试验收

### 4.1 编译状态

- [x] Unity 重编译零错误
- [x] 2 个 Obsolete 警告（Tool_BatchItemSOGenerator 引用废弃字段）— 可接受

### 4.2 单元测试

- [x] CropSystemTests 21/21 全部通过

---

## 五、已知限制

1. **Collect 动画未集成** — 收获时没有弯腰拔起动画，预留后续迭代
2. **Tool_BatchItemSOGenerator 警告** — 引用了 SeedData 的 Obsolete 字段，需后续清理
3. **dropItemData 需手动配置** — 每个作物 Prefab 的掉落配置需要在 Inspector 中手动设置
4. **品质系统简化** — dropQuality 为固定值，后续可扩展为动态计算（土壤肥力等）

---

## 六、修改文件清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `FarmTileData.cs` | 修改 | 新增 cropController 运行时引用 |
| `CropController.cs` | 修改 | 掉落字段、收获重写、DestroyCrop 扩展、Initialize/Load 设置引用 |
| `GameInputManager.cs` | 修改 | 播种链路重写、ExecuteTillSoil 替换、TryHarvestCropAtMouse 废弃 |
| `FarmToolPreview.cs` | 修改 | 替换 CropManager.GetCrop 为 tileData.cropController |
| `SeedData.cs` | 修改 | 3 个字段标记 Obsolete |
| `CropManager.cs` | 修改 | 整个类标记 Obsolete |
| `farming.md` | 修改 | 更新播种链路、收获机制、FarmTileData、SeedData |
