# è¡¥ä¸004V5 å…¨é¢å®¡æŸ¥æŠ¥å‘Š

> åˆ›å»ºæ—¶é—´ï¼š2026-02-21ï¼ˆä¼šè¯2ç»­14ï¼‰
> è§¦å‘åŸå› ï¼šç”¨æˆ·éªŒæ”¶è¡¥ä¸004V4åå‘ç°ä¸¤ä¸ªæ–°é—®é¢˜ + è¦æ±‚å…¨é¢å®¡æŸ¥æ‰€æœ‰å†œç”°äº¤äº’

---

## ä¸€ã€ç”¨æˆ·åŸå§‹è¯‰æ±‚

1. a å±‚ï¼ˆghostï¼‰æ²¡æœ‰æŠŠ b å±‚ï¼ˆé˜Ÿåˆ—é¢„è§ˆï¼‰çº³å…¥"ä¸å¯è€•ç§"åˆ¤æ–­â€”â€”ghost åœ¨å·²æœ‰é˜Ÿåˆ—é¢„è§ˆä½ç½®ä¸Šä»æ˜¾ç¤ºç»¿è‰²å¯è€•ç§ï¼Œåº”è¯¥æ˜¾ç¤ºçº¢è‰²
2. è€•åœ°ä¸å¯è€•ç§çš„è§†è§‰åé¦ˆæ˜¯çº¢è‰²æ–¹æ¡†ï¼ˆcursorRendererï¼‰ï¼Œè€Œéå’Œæ”¾ç½®ç³»ç»Ÿä¸€è‡´çš„çº¢è‰²æŸ“è‰²æ•ˆæœ
3. å¯è€•ç§çš„ç»¿è‰²ç”¨äº†å•ç‹¬ shader materialï¼ˆ`previewOverlayMaterial` + `FarmPreviewOverlay` shaderï¼‰ï¼Œä¸ºä»€ä¹ˆä¸èƒ½å’Œæ”¾ç½®ç³»ç»Ÿä¸€æ ·ç”¨ä»£ç ç»Ÿä¸€è°ƒæ§
4. æ•°æ®ä¸è¡¨å±‚ä¸ä¸€è‡´æ˜¯æ ¹æœ¬é—®é¢˜ï¼Œè¦æ±‚å…¨é¢å®¡æŸ¥æ‰€æœ‰å†œç”°äº¤äº’ï¼ˆæµ‡æ°´ã€æ’­ç§ã€æ”¶è·ï¼‰ï¼Œå½»åº•æ˜ç¡®æ‰€æœ‰å‰©ä½™æ¼æ´

---

## äºŒã€é—®é¢˜åˆ†æ

### P1ï¼ša å±‚ canTill åˆ¤æ–­æœªçº³å…¥ b å±‚ï¼ˆğŸ”´ ä¸¥é‡ï¼‰

**ä»£ç äº‹å®**ï¼ˆ`UpdateHoePreview` ç¬¬428~429è¡Œï¼‰ï¼š
```csharp
bool canTill = FarmTileManager.Instance != null && 
               FarmTileManager.Instance.CanTillAt(layerIndex, cellPos);
```

`CanTillAt` å†…éƒ¨é€»è¾‘ï¼ˆå·²è¯»å–ç¡®è®¤ï¼‰ï¼š
- æ£€æŸ¥æ¥¼å±‚æ˜¯å¦æœ‰æ•ˆ
- æ£€æŸ¥ `farmTilesByLayer` ä¸­æ˜¯å¦å·²å­˜åœ¨ `isTilled` çš„è€•åœ°æ•°æ®ï¼ˆc å±‚ï¼‰
- æ£€æŸ¥åœ°é¢ Tile æ˜¯å¦å­˜åœ¨
- **å®Œå…¨ä¸çŸ¥é“ b å±‚ï¼ˆ`queuePreviewPositions`ï¼‰çš„å­˜åœ¨**

**ç»“æœ**ï¼šå½“é¼ æ ‡æ‚¬åœåœ¨å·²å…¥é˜Ÿçš„ä½ç½®ä¸Šæ—¶ï¼Œ`CanTillAt` è¿”å› trueï¼ˆå› ä¸º c å±‚è¿˜æ²¡æœ‰è€•åœ°ï¼‰ï¼Œghost æ˜¾ç¤ºç»¿è‰²å¯è€•ç§ã€‚

**å½±å“èŒƒå›´**ï¼š
- ghost é¢„è§ˆé¢œè‰²é”™è¯¯ï¼ˆç»¿è‰²åº”ä¸ºçº¢è‰²ï¼‰
- å¦‚æœç”¨æˆ·åœ¨å·²å…¥é˜Ÿä½ç½®å†æ¬¡ç‚¹å‡»ï¼Œä¼šé‡å¤å…¥é˜Ÿï¼ˆè™½ç„¶ `queuePreviewPositions.Contains` åœ¨ `AddQueuePreview` ä¸­æœ‰é˜²é‡å¤ï¼Œä½† `TryEnqueueFarmTool` ä¸­çš„ `IsValid()` è¿”å› true ä¼šå¯¼è‡´ `EnqueueAction` è¢«è°ƒç”¨ï¼Œ`_queuedPositions` ä¹Ÿæœ‰é˜²é‡å¤ä½†é€»è¾‘åˆ†æ•£ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `canTill` åˆ¤æ–­åå¢åŠ  b å±‚æ£€æŸ¥ï¼š
```csharp
// a å±‚æŠŠ b å±‚è§†ä¸ºå’Œ c å±‚ä¸€æ ·çš„"å·²è€•ç§"åŒºåŸŸ
if (canTill && queuePreviewPositions.Contains(cellPos))
    canTill = false;
```

åŒæ—¶ï¼Œå¢é‡è¿‡æ»¤éƒ¨åˆ†å·²ç»åœ¨ç»­10ä¸­å®ç°äº†å¯¹ b+c ä¸¤å±‚çš„å¢é‡ï¼ˆ`queuePreviewTilemap.GetTile`ï¼‰ï¼Œæ‰€ä»¥å¢é‡é€»è¾‘ä¸éœ€è¦æ”¹åŠ¨ï¼Œåªéœ€è¦ä¿®æ­£ `canTill` åˆ¤æ–­ã€‚


### P2ï¼šè€•åœ°ä¸å¯è€•ç§è§†è§‰åé¦ˆæ ·å¼é”™è¯¯ï¼ˆğŸŸ¡ ä¸­ç­‰ï¼‰

**å½“å‰å®ç°**ï¼ˆ`UpdateHoePreview` ç¬¬558~564è¡Œï¼‰ï¼š
```csharp
// canTill=false åˆ†æ”¯
if (cursorRenderer != null)
{
    cursorRenderer.enabled = true;
    UpdateCursor(layerIndex, cellPos);
}
```
`cursorRenderer` æ˜¯ä¸€ä¸ª `SpriteRenderer`ï¼Œæ˜¾ç¤ºç¨‹åºåŒ–ç”Ÿæˆçš„ç™½è‰²æ–¹æ¡† Spriteï¼ˆ`CreateProceduralCursorSprite`ï¼‰ï¼Œé€šè¿‡ `UpdateCursor` è®¾ç½® `invalidColor`ï¼ˆçº¢è‰²ï¼‰ã€‚

**æ”¾ç½®ç³»ç»Ÿçš„åšæ³•**ï¼ˆå·²è¯»å– `PlacementGridCell.cs` ç¡®è®¤ï¼‰ï¼š
- æ¯ä¸ªæ ¼å­æ˜¯ä¸€ä¸ª `PlacementGridCell`ï¼Œå†…å« `SpriteRenderer`
- Sprite æ˜¯ç¨‹åºåŒ–ç”Ÿæˆçš„ 32x32 æ–¹å—ï¼ˆ2px è¾¹æ¡† + åŠé€æ˜å†…éƒ¨å¡«å……ï¼‰
- é¢œè‰²é€šè¿‡ `spriteRenderer.color = isValid ? validColor : invalidColor` ç›´æ¥è®¾ç½®
- `validColor = new Color(0f, 1f, 0f, 0.4f)`ï¼Œ`invalidColor = new Color(1f, 0f, 0f, 0.4f)`
- ç‰©å“é¢„è§ˆæœ¬èº«ä¹Ÿä¼šå˜è‰²ï¼šæœ‰æ•ˆæ—¶ç™½è‰²ï¼Œæ— æ•ˆæ—¶åçº¢ `new Color(1f, 0.5f, 0.5f)`

**æ ¸å¿ƒå·®å¼‚**ï¼š
| ç»´åº¦ | æ”¾ç½®ç³»ç»Ÿ | å½“å‰è€•åœ°é¢„è§ˆ |
|------|---------|-------------|
| å¯æ”¾ç½®/å¯è€•ç§ | ç»¿è‰²åŠé€æ˜æ ¼å­ | shader å åŠ ç»¿è‰²ï¼ˆ`previewOverlayMaterial`ï¼‰ |
| ä¸å¯æ”¾ç½®/ä¸å¯è€•ç§ | çº¢è‰²åŠé€æ˜æ ¼å­ + ç‰©å“åçº¢ | çº¢è‰²æ–¹æ¡†ï¼ˆ`cursorRenderer`ï¼‰ï¼Œæ—  1+8 é¢„è§ˆ |
| é¢œè‰²æ§åˆ¶æ–¹å¼ | `SpriteRenderer.color` | shader `_OverlayColor` + `SpriteRenderer.color` æ··ç”¨ |

**ç”¨æˆ·æœŸæœ›**ï¼š
- canTill=false æ—¶ä¹Ÿæ˜¾ç¤º 1+8 é¢„è§ˆ tileï¼Œä½†æ•´ä½“æŸ“çº¢è‰²
- canTill=true æ—¶æ˜¾ç¤º 1+8 é¢„è§ˆ tileï¼Œæ•´ä½“æŸ“ç»¿è‰²
- é¢œè‰²æ§åˆ¶ç»Ÿä¸€ç”¨ `ghostTilemap.color`ï¼Œä¸ç”¨ shader

### P3ï¼šå¯è€•ç§ç»¿è‰²ç”¨äº†å•ç‹¬ shader materialï¼ˆğŸŸ¡ ä¸­ç­‰ï¼‰

**å½“å‰å®ç°**ï¼ˆ`EnsureComponents` ç¬¬370~382è¡Œï¼‰ï¼š
```csharp
var shader = Shader.Find("Custom/FarmPreviewOverlay");
previewOverlayMaterial = new Material(shader);
previewOverlayMaterial.SetColor("_OverlayColor", Color.clear);
ghostTilemapRenderer.material = previewOverlayMaterial;
```

`UpdateHoePreview` æœ«å°¾ï¼ˆç¬¬570~573è¡Œï¼‰ï¼š
```csharp
if (previewOverlayMaterial != null)
{
    previewOverlayMaterial.SetColor("_OverlayColor", isValid ? overlayValidColor : overlayInvalidColor);
}
```

**é—®é¢˜**ï¼š
- `FarmPreviewOverlay` shader æ˜¯ä¸“é—¨ä¸ºè€•åœ°é¢„è§ˆåˆ›å»ºçš„è‡ªå®šä¹‰ shader
- æ”¾ç½®ç³»ç»Ÿå®Œå…¨ä¸ç”¨ shaderï¼Œç›´æ¥ç”¨ `SpriteRenderer.color` æ§åˆ¶é¢œè‰²
- è€•åœ°é¢„è§ˆçš„ ghostTilemap å·²ç»æ˜¯ç‹¬ç«‹çš„ä¸€å±‚ï¼ˆSorting Order 9999ï¼‰ï¼Œå®Œå…¨å¯ä»¥ç›´æ¥ç”¨ `ghostTilemap.color` æ§åˆ¶æ•´ä½“é¢œè‰²
- shader æ–¹æ¡ˆå¢åŠ äº†ä¸å¿…è¦çš„å¤æ‚åº¦

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. ç§»é™¤ `previewOverlayMaterial` å’Œ `FarmPreviewOverlay` shader çš„ä½¿ç”¨
2. `ghostTilemapRenderer.material` æ¢å¤ä¸ºé»˜è®¤ Material
3. é€šè¿‡ `ghostTilemap.color` æ§åˆ¶æ•´ä½“é¢œè‰²ï¼š
   - canTill=trueï¼š`new Color(0f, 1f, 0f, previewAlpha)` ç»¿è‰²
   - canTill=falseï¼š`new Color(1f, 0f, 0f, previewAlpha)` çº¢è‰²
4. canTill=false æ—¶ä¹Ÿè®¡ç®—å¹¶æ˜¾ç¤º 1+8 é¢„è§ˆ tileï¼ˆè®©ç”¨æˆ·çœ‹åˆ°"å¦‚æœè€•ç§ä¼šæ˜¯ä»€ä¹ˆæ ·"ï¼Œä½†æŸ“çº¢è‰²è¡¨ç¤ºä¸å¯æ“ä½œï¼‰


---

## ä¸‰ã€å…¨é¢å®¡æŸ¥ â€” æ‰€æœ‰å†œç”°äº¤äº’å‰©ä½™æ¼æ´

### å®¡æŸ¥èŒƒå›´

é€ä¸€æ£€æŸ¥è€•åœ°ã€æµ‡æ°´ã€æ’­ç§ã€æ”¶è·å››ç§æ“ä½œåœ¨ä»¥ä¸‹ç»´åº¦çš„æ­£ç¡®æ€§ï¼š
- ghost é¢„è§ˆï¼ˆa å±‚ï¼‰ï¼šé¢œè‰²ã€å¢é‡ã€b å±‚æ„ŸçŸ¥
- é˜Ÿåˆ—é¢„è§ˆï¼ˆb å±‚ï¼‰ï¼šå…¥é˜Ÿã€æ¸…ç†ã€æ‰§è¡Œä¿æŠ¤
- æ‰§è¡Œè½åœ°ï¼ˆc å±‚ï¼‰ï¼šæ•°æ®ä¸€è‡´æ€§
- äº¤äº’è¾¹ç•Œï¼šé‡å¤æ“ä½œã€çŠ¶æ€å˜åŒ–ã€è·¨æ“ä½œå†²çª

### R1ï¼šæµ‡æ°´ ghost æœªæ£€æŸ¥ b å±‚å·²å…¥é˜Ÿä½ç½®ï¼ˆğŸŸ¡ ä½é£é™©ï¼‰

**ä»£ç äº‹å®**ï¼ˆ`UpdateWateringPreview` ç¬¬597~600è¡Œï¼‰ï¼š
```csharp
var tileData = FarmTileManager.Instance?.GetTileData(layerIndex, cellPos);
bool canWater = tileData != null && tileData.isTilled && !tileData.wateredToday;
```

**åˆ†æ**ï¼š
- `canWater` åªæ£€æŸ¥ c å±‚æ•°æ®ï¼ˆ`FarmTileData.isTilled` å’Œ `wateredToday`ï¼‰
- ä¸æ£€æŸ¥ b å±‚ï¼ˆ`queuePreviewPositions`ï¼‰æ˜¯å¦å·²æœ‰æµ‡æ°´å…¥é˜Ÿ
- å¦‚æœç”¨æˆ·åœ¨åŒä¸€ä½ç½®è¿ç»­ç‚¹å‡»æµ‡æ°´ï¼Œç†è®ºä¸Šå¯ä»¥é‡å¤å…¥é˜Ÿ

**å®é™…é£é™©**ï¼š
- `_queuedPositions` åœ¨ `EnqueueAction` ä¸­æœ‰é˜²é‡å¤æ£€æŸ¥ï¼ˆ`_queuedPositions.Contains`ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šçœŸæ­£é‡å¤å…¥é˜Ÿ
- ä½† ghost é¢„è§ˆä¼šåœ¨å·²å…¥é˜Ÿä½ç½®ä¸Šç»§ç»­æ˜¾ç¤ºè“è‰²å¯æµ‡æ°´ï¼Œè§†è§‰ä¸Šæœ‰è¯¯å¯¼
- é£é™©è¾ƒä½ï¼Œå› ä¸ºæµ‡æ°´æ˜¯å•ç‚¹æ“ä½œï¼Œä¸æ¶‰åŠ 1+8 è¾¹ç•Œé—®é¢˜

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `canWater` åˆ¤æ–­åå¢åŠ  b å±‚æ£€æŸ¥ï¼š
```csharp
if (canWater && queuePreviewPositions.Contains(cellPos))
    canWater = false;
```

### R2ï¼šæ’­ç§ ghost æœªæ£€æŸ¥ b å±‚å·²å…¥é˜Ÿä½ç½®ï¼ˆğŸŸ¡ ä½é£é™©ï¼‰

**ä»£ç äº‹å®**ï¼ˆ`UpdateSeedPreview` ç¬¬720è¡Œï¼‰ï¼š
```csharp
bool canPlant = tileData != null && tileData.CanPlant();
```

**åˆ†æ**ï¼šåŒ R1ï¼Œ`canPlant` åªæ£€æŸ¥ c å±‚æ•°æ®ï¼Œä¸çŸ¥é“ b å±‚ã€‚

**å®é™…é£é™©**ï¼š
- åŒæ ·æœ‰ `_queuedPositions` é˜²é‡å¤
- ç§å­é¢„è§ˆç”¨ `SpriteRenderer`ï¼ˆä¸æ˜¯ Tilemapï¼‰ï¼Œè§†è§‰è¯¯å¯¼ç¨‹åº¦è¾ƒä½
- ä½†é€»è¾‘ä¸Šåº”è¯¥ç»Ÿä¸€ï¼šå·²å…¥é˜Ÿä½ç½®ä¸åº”æ˜¾ç¤ºå¯æ“ä½œ

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `canPlant` åˆ¤æ–­åå¢åŠ  b å±‚æ£€æŸ¥ï¼š
```csharp
if (canPlant && queuePreviewPositions.Contains(cellPos))
    canPlant = false;
```

### R3ï¼šæµ‡æ°´ ghost é¢œè‰²å¤„ç†æ–¹å¼ï¼ˆğŸŸ¡ ä¸­ç­‰ï¼‰

**ä»£ç äº‹å®**ï¼ˆ`UpdateWateringPreview` ç¬¬651~654è¡Œï¼‰ï¼š
```csharp
if (previewOverlayMaterial != null)
{
    previewOverlayMaterial.SetColor("_OverlayColor", isValid ? overlayValidColor : overlayInvalidColor);
}
```

**åˆ†æ**ï¼šæµ‡æ°´é¢„è§ˆä¹Ÿä½¿ç”¨äº† `previewOverlayMaterial` shader æ–¹æ¡ˆã€‚å¦‚æœ P3 ç§»é™¤ shaderï¼Œæµ‡æ°´é¢„è§ˆä¹Ÿéœ€è¦åŒæ­¥ä¿®æ”¹ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼šç»Ÿä¸€æ”¹ä¸º `ghostTilemap.color` æ§åˆ¶ï¼š
- isValid=trueï¼šè“è‰²ï¼ˆ`wateringColor`ï¼‰æˆ–ç»¿è‰²
- isValid=falseï¼šçº¢è‰²

### R4ï¼šæ’­ç§ ghost é¢œè‰²å¤„ç†æ–¹å¼ï¼ˆğŸŸ¢ æ— é—®é¢˜ï¼‰

**ä»£ç äº‹å®**ï¼ˆ`UpdateSeedPreview` ç¬¬752~753è¡Œï¼‰ï¼š
```csharp
if (previewOverlayMaterial != null)
    previewOverlayMaterial.SetColor("_OverlayColor", Color.clear);
```

**åˆ†æ**ï¼šç§å­é¢„è§ˆä¸»åŠ¨æ¸…é™¤ shader å åŠ è‰²ï¼Œä½¿ç”¨ `seedGridRenderer.color` å’Œ `seedPreviewRenderer.color` ç›´æ¥æ§åˆ¶é¢œè‰²ã€‚è¿™å·²ç»æ˜¯æ­£ç¡®çš„åšæ³•ï¼Œå’Œæ”¾ç½®ç³»ç»Ÿä¸€è‡´ã€‚

**ç»“è®º**ï¼šæ— éœ€ä¿®æ”¹ã€‚

### R5ï¼šæ”¶è·é˜Ÿåˆ—é¢„è§ˆï¼ˆğŸŸ¢ æ— é—®é¢˜ï¼‰

**ä»£ç äº‹å®**ï¼šæ”¶è·æ“ä½œï¼ˆ`FarmActionType.Harvest`ï¼‰æ²¡æœ‰é¢„è§ˆ tileï¼Œä¸æ¶‰åŠ ghost/é˜Ÿåˆ—é¢„è§ˆç³»ç»Ÿã€‚æ”¶è·é€šè¿‡ `TryDetectAndEnqueueHarvest` å…¥é˜Ÿï¼Œç›´æ¥èµ° `IInteractable` æ¥å£ã€‚

**ç»“è®º**ï¼šæ— éœ€ä¿®æ”¹ã€‚


### R6ï¼šè€•åœ°è½åœ°å UpdateBordersAround ä¸é˜Ÿåˆ—é¢„è§ˆ tile å†²çªï¼ˆğŸŸ¡ å·²çŸ¥é™åˆ¶ï¼‰

**åœºæ™¯**ï¼šA è€•åœ°è½åœ° â†’ `FarmTileManager.CreateTile` â†’ `FarmlandBorderManager.OnCenterBlockPlaced` â†’ `UpdateBordersAround` é‡æ–°è®¡ç®—å‘¨å›´ 8 æ ¼çš„è¾¹ç•Œ tileã€‚å¦‚æœå‘¨å›´æœ‰ B çš„é˜Ÿåˆ—é¢„è§ˆ tile åœ¨ `queuePreviewTilemap` ä¸Šï¼Œå®é™…å±‚çš„è¾¹ç•Œ tile æ›´æ–°åï¼ŒB çš„é˜Ÿåˆ—é¢„è§ˆ tile å¯èƒ½å˜å¾—ä¸å‡†ç¡®ï¼ˆå› ä¸º B å…¥é˜Ÿæ—¶è®¡ç®—çš„å¢é‡æ˜¯åŸºäºå½“æ—¶çš„ c å±‚çŠ¶æ€ï¼‰ã€‚

**åˆ†æ**ï¼šè¿™æ˜¯ V4 æŠ¥å‘Šä¸­ R8 çš„åŒä¸€é—®é¢˜ã€‚è½åœ°åå®é™…å±‚çš„è¾¹ç•Œ tile ä¼šè¢« `UpdateBordersAround` æ­£ç¡®æ›´æ–°ï¼Œä½† b å±‚çš„å¢é‡ tile ä¸ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—ã€‚

**å®é™…å½±å“**ï¼šè§†è§‰ç‘•ç–µâ€”â€”b å±‚çš„å¢é‡ tile å¯èƒ½å¤šæ˜¾ç¤ºæˆ–å°‘æ˜¾ç¤ºä¸€äº›æ–¹å‘ã€‚ä½† B è½åœ°æ—¶ `UpdateBordersAround` ä¼šå†æ¬¡é‡æ–°è®¡ç®—ï¼Œæœ€ç»ˆç»“æœæ­£ç¡®ã€‚

**ç»“è®º**ï¼šå·²çŸ¥é™åˆ¶ï¼Œä¸ä¿®å¤ã€‚å¦‚æœè¦ä¿®å¤éœ€è¦åœ¨ `OnCenterBlockPlaced` ä¸­éå†æ‰€æœ‰é˜Ÿåˆ—é¢„è§ˆé‡æ–°è®¡ç®—å¢é‡ï¼Œæ€§èƒ½å¼€é”€ä¸å€¼å¾—ã€‚

### R7ï¼šæ‰§è¡Œé¢„è§ˆ Promote å ghost å¢é‡è®¡ç®—æ˜¯å¦æ­£ç¡®ï¼ˆğŸŸ¢ æ— é—®é¢˜ï¼‰

**åœºæ™¯**ï¼šA å…¥é˜Ÿ â†’ A Promote åˆ°æ‰§è¡Œé¢„è§ˆ â†’ `queuePreviewPositions.Remove(A.cellPos)` â†’ ghost ä¸‹ä¸€å¸§è®¡ç®—å¢é‡æ—¶ï¼ŒA çš„ä½ç½®ä¸å†åœ¨ `queuePreviewPositions` ä¸­ã€‚

**åˆ†æ**ï¼š
- Promote å A çš„ tile ä»åœ¨ `queuePreviewTilemap` ä¸Šï¼ˆåªæ˜¯è¿½è¸ªæ•°æ®è½¬ç§»ï¼‰
- ghost å¢é‡è¿‡æ»¤å¯¹æ¯” b+c ä¸¤å±‚æ—¶ï¼Œä¼šæ£€æŸ¥ `queuePreviewTilemap.GetTile(pos)`ï¼Œæ‰€ä»¥ä»èƒ½æ„ŸçŸ¥åˆ° A çš„ tile
- ä½† `GetPreviewTiles` çš„ predicate ä¼ å…¥çš„æ˜¯ `queuePreviewPositions`ï¼ŒPromote å A ä¸åœ¨å…¶ä¸­
- è¿™æ„å‘³ç€ `GetPreviewTiles` è®¡ç®—æ—¶ä¸ä¼šæŠŠ A è§†ä¸º"å·²è€•ç§é‚»å±…"

**å®é™…å½±å“**ï¼š
- å¦‚æœ A æ­£åœ¨æ‰§è¡Œï¼ˆåŠ¨ç”»ä¸­ï¼‰ï¼Œghost çš„ `GetPreviewTiles` ä¸ä¼šæ„ŸçŸ¥ A ä¸ºé‚»å±…
- ä½† A çš„ tile ä»åœ¨ `queuePreviewTilemap` ä¸Šï¼Œå¢é‡è¿‡æ»¤æ—¶ä¼šè¢«æ£€æµ‹åˆ°
- ä¸¤ä¸ªç¯èŠ‚çš„ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´ ghost åœ¨ A é™„è¿‘çš„è¾¹ç•Œ tile è®¡ç®—ä¸å®Œå…¨å‡†ç¡®
- å®é™…åœºæ™¯ä¸­ï¼ŒA æ‰§è¡ŒåŠ¨ç”»åªæœ‰å‡ ç™¾æ¯«ç§’ï¼Œä¸” ghost æ¯å¸§æ›´æ–°ï¼Œç”¨æˆ·å‡ ä¹ä¸ä¼šæ³¨æ„åˆ°

**ç»“è®º**ï¼šæä½é£é™©ï¼Œä¸ä¿®å¤ã€‚å¦‚æœè¦ä¿®å¤éœ€è¦åœ¨ predicate ä¸­åŒæ—¶ä¼ å…¥ `executingTileGroups` çš„ keyï¼Œä½†å¢åŠ å¤æ‚åº¦ä¸å€¼å¾—ã€‚

### R8ï¼šcanTill=false æ—¶ previewOverlayMaterial ä»è¢«è®¾ç½®ï¼ˆğŸŸ¡ ä¸­ç­‰ï¼‰

**ä»£ç äº‹å®**ï¼ˆ`UpdateHoePreview` ç¬¬570~573è¡Œï¼‰ï¼š
```csharp
// åœ¨ if/else ä¹‹åï¼Œæ— è®º canTill æ˜¯ä»€ä¹ˆéƒ½ä¼šæ‰§è¡Œ
if (previewOverlayMaterial != null)
{
    previewOverlayMaterial.SetColor("_OverlayColor", isValid ? overlayValidColor : overlayInvalidColor);
}
```

**åˆ†æ**ï¼šå½“ canTill=false æ—¶ï¼ŒghostTilemap ä¸Šæ²¡æœ‰ä»»ä½• tileï¼ˆè¢« `ClearGhostTilemap` æ¸…ç©ºäº†ï¼‰ï¼Œä½† shader ä»è¢«è®¾ç½®ä¸ºçº¢è‰²å åŠ ã€‚è¿™ä¸ä¼šé€ æˆè§†è§‰é—®é¢˜ï¼ˆå› ä¸ºæ²¡æœ‰ tile å¯ä»¥å åŠ ï¼‰ï¼Œä½†é€»è¾‘ä¸Šæ˜¯å¤šä½™çš„ã€‚

**ç»“è®º**ï¼šP3 ä¿®å¤ç§»é™¤ shader åæ­¤é—®é¢˜è‡ªåŠ¨æ¶ˆå¤±ã€‚

### R9ï¼šæµ‡æ°´é˜Ÿåˆ—é¢„è§ˆä¸è€•åœ°é˜Ÿåˆ—é¢„è§ˆçš„ Tilemap å…±ç”¨ï¼ˆğŸŸ¢ æ— é—®é¢˜ï¼‰

**åˆ†æ**ï¼šæµ‡æ°´å’Œè€•åœ°çš„é˜Ÿåˆ—é¢„è§ˆéƒ½å†™å…¥ `queuePreviewTilemap`ã€‚æµ‡æ°´æ˜¯å•ç‚¹ï¼ˆåªæœ‰ä¸­å¿ƒå—ï¼‰ï¼Œè€•åœ°æ˜¯ 1+8ã€‚ä¸¤è€…ä¸ä¼šåœ¨åŒä¸€ä½ç½®å†²çªï¼ˆæµ‡æ°´å‰ææ˜¯å·²æœ‰è€•åœ°ï¼Œè€•åœ°å‰ææ˜¯æ²¡æœ‰è€•åœ°ï¼‰ã€‚

**ç»“è®º**ï¼šæ— é—®é¢˜ã€‚

### R10ï¼šClearAllQueuePreviews ä¸­ activeSeedQueuePreviews.Clear() çš„æ—¶æœºï¼ˆğŸŸ¡ ä½é£é™©ï¼‰

**ä»£ç äº‹å®**ï¼ˆ`ClearAllQueuePreviews` ç¬¬1222è¡Œï¼‰ï¼š
```csharp
activeSeedQueuePreviews.Clear();
```

**åˆ†æ**ï¼šåœ¨å›æ”¶ç§å­é˜Ÿåˆ—é¢„è§ˆçš„ for å¾ªç¯ä¹‹åï¼Œæ— æ¡ä»¶ `Clear()`ã€‚ä½† for å¾ªç¯ä¸­è·³è¿‡äº†æ‰§è¡Œä¸­çš„ç§å­é¢„è§ˆï¼ˆ`executingSeedPreviews.Exists`ï¼‰ï¼Œè¿™äº›è¢«è·³è¿‡çš„æ¡ç›®åœ¨ `Clear()` åä¸¢å¤±äº†è¿½è¸ªã€‚

**å®é™…å½±å“**ï¼š
- è¢«è·³è¿‡çš„ç§å­é¢„è§ˆå·²ç»åœ¨ `executingSeedPreviews` ä¸­è¿½è¸ªï¼Œæ‰€ä»¥ä¸ä¼šä¸¢å¤±
- ä½† `activeSeedQueuePreviews.Clear()` ä¼šæŠŠå®ƒä»¬ä» active åˆ—è¡¨ä¸­ç§»é™¤ï¼Œè¿™æ˜¯æ­£ç¡®çš„ï¼ˆå®ƒä»¬å·²ç»ä¸æ˜¯"é˜Ÿåˆ—"é¢„è§ˆäº†ï¼Œæ˜¯"æ‰§è¡Œ"é¢„è§ˆï¼‰
- ç­‰ç­‰â€”â€”for å¾ªç¯ä¸­è·³è¿‡çš„æ¡ç›®æ²¡æœ‰è¢«ç§»é™¤ï¼Œ`Clear()` ä¼šæŠŠå®ƒä»¬ä¹Ÿæ¸…æ‰ã€‚ä½†è¿™äº›æ¡ç›®çš„ renderer æ²¡æœ‰è¢«å›æ”¶ï¼ˆå› ä¸ºè¢«è·³è¿‡äº†ï¼‰ï¼Œæ‰€ä»¥ renderer ä»ç„¶å¯è§ï¼Œç”± `executingSeedPreviews` è¿½è¸ªã€‚

**ç»“è®º**ï¼šé€»è¾‘æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ã€‚


---

## å››ã€é£é™©æ¸…å•æ±‡æ€»

| ç¼–å· | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ç»“è®º |
|------|------|---------|------|
| P1 | a å±‚ canTill åˆ¤æ–­æœªçº³å…¥ b å±‚ | ğŸ”´ ä¸¥é‡ | éœ€ä¿®å¤ |
| P2 | è€•åœ°ä¸å¯è€•ç§è§†è§‰åé¦ˆæ˜¯çº¢è‰²æ–¹æ¡† | ğŸŸ¡ ä¸­ç­‰ | éœ€ä¿®å¤ |
| P3 | å¯è€•ç§ç»¿è‰²ç”¨äº†å•ç‹¬ shader material | ğŸŸ¡ ä¸­ç­‰ | éœ€ä¿®å¤ |
| R1 | æµ‡æ°´ ghost æœªæ£€æŸ¥ b å±‚å·²å…¥é˜Ÿä½ç½® | ğŸŸ¡ ä½é£é™© | å»ºè®®ä¿®å¤ï¼ˆç»Ÿä¸€é€»è¾‘ï¼‰ |
| R2 | æ’­ç§ ghost æœªæ£€æŸ¥ b å±‚å·²å…¥é˜Ÿä½ç½® | ğŸŸ¡ ä½é£é™© | å»ºè®®ä¿®å¤ï¼ˆç»Ÿä¸€é€»è¾‘ï¼‰ |
| R3 | æµ‡æ°´ ghost é¢œè‰²å¤„ç†æ–¹å¼ï¼ˆshaderï¼‰ | ğŸŸ¡ ä¸­ç­‰ | éš P3 ä¸€èµ·ä¿®å¤ |
| R4 | æ’­ç§ ghost é¢œè‰²å¤„ç†æ–¹å¼ | ğŸŸ¢ æ— é—®é¢˜ | å·²æ­£ç¡® |
| R5 | æ”¶è·é˜Ÿåˆ—é¢„è§ˆ | ğŸŸ¢ æ— é—®é¢˜ | æ— é¢„è§ˆ |
| R6 | è€•åœ°è½åœ°åé˜Ÿåˆ—é¢„è§ˆå¢é‡ä¸æ›´æ–° | ğŸŸ¡ å·²çŸ¥é™åˆ¶ | ä¸ä¿®å¤ |
| R7 | Promote å ghost å¢é‡è®¡ç®— | ğŸŸ¢ æä½é£é™© | ä¸ä¿®å¤ |
| R8 | canTill=false æ—¶ shader ä»è¢«è®¾ç½® | ğŸŸ¡ ä¸­ç­‰ | éš P3 è‡ªåŠ¨æ¶ˆå¤± |
| R9 | æµ‡æ°´/è€•åœ°é˜Ÿåˆ—é¢„è§ˆ Tilemap å…±ç”¨ | ğŸŸ¢ æ— é—®é¢˜ | æ— å†²çª |
| R10 | ClearAllQueuePreviews ç§å­æ¸…ç† | ğŸŸ¢ æ— é—®é¢˜ | é€»è¾‘æ­£ç¡® |

---

## äº”ã€ä¿®å¤æ–¹æ¡ˆè¯¦ç»†è®¾è®¡

### æ¨¡å— Nï¼ša å±‚ canTill çº³å…¥ b å±‚ï¼ˆP1ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`FarmToolPreview.cs` â€” `UpdateHoePreview`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬428~429è¡Œ `canTill` åˆ¤æ–­ä¹‹å

**ä¿®æ”¹å†…å®¹**ï¼š
```csharp
bool canTill = FarmTileManager.Instance != null && 
               FarmTileManager.Instance.CanTillAt(layerIndex, cellPos);

// ğŸ”´ è¡¥ä¸004V5 æ¨¡å—Nï¼ˆCP-N1ï¼‰ï¼ša å±‚æŠŠ b å±‚è§†ä¸ºå’Œ c å±‚ä¸€æ ·çš„"å·²è€•ç§"åŒºåŸŸ
if (canTill && queuePreviewPositions.Contains(cellPos))
    canTill = false;
```

**å½±å“åˆ†æ**ï¼š
- `canTill=false` åï¼Œ`isValid` ä¹Ÿå˜ä¸º falseï¼ˆé™¤é `canClearWithered` ä¸º trueï¼‰
- ghost è¿›å…¥ else åˆ†æ”¯ï¼Œä¹‹å‰æ˜¯æ˜¾ç¤ºçº¢è‰²æ–¹æ¡†ï¼ŒP2 ä¿®å¤åæ”¹ä¸ºæ˜¾ç¤ºçº¢è‰² 1+8 é¢„è§ˆ
- å¢é‡è¿‡æ»¤éƒ¨åˆ†ä¸å—å½±å“ï¼ˆå·²ç»å¯¹æ¯” b+c ä¸¤å±‚ï¼‰

### æ¨¡å— Oï¼šç»Ÿä¸€é¢œè‰²æ§åˆ¶æ–¹å¼ï¼ˆP2 + P3 + R3ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šç§»é™¤ `previewOverlayMaterial` shader æ–¹æ¡ˆï¼Œç»Ÿä¸€ç”¨ `ghostTilemap.color` æ§åˆ¶é¢œè‰²ã€‚

**ä¿®æ”¹æ–‡ä»¶**ï¼š`FarmToolPreview.cs`

**ä¿®æ”¹ 1 â€” EnsureComponents**ï¼š
- ç§»é™¤ `previewOverlayMaterial` çš„åˆ›å»ºå’Œèµ‹å€¼
- `ghostTilemapRenderer.material` ä¿æŒé»˜è®¤ï¼ˆä¸èµ‹è‡ªå®šä¹‰ Materialï¼‰
- æˆ–è€…ï¼šä¿ç•™ `previewOverlayMaterial` çš„åˆ›å»ºä½†ä¸èµ‹ç»™ rendererï¼Œæ”¹ä¸ºç›´æ¥è®¾ç½® `ghostTilemap.color`

**æ¨èæ–¹æ¡ˆ**ï¼šç›´æ¥ç§»é™¤ shader ç›¸å…³ä»£ç ï¼Œç”¨ `ghostTilemap.color` æ›¿ä»£ã€‚

**ä¿®æ”¹ 2 â€” UpdateHoePreview**ï¼š
- canTill=true åˆ†æ”¯æœ«å°¾ï¼š`ghostTilemap.color = new Color(0f, 1f, 0f, previewAlpha);`
- canTill=false åˆ†æ”¯ï¼šä¹Ÿè®¡ç®—å¹¶æ˜¾ç¤º 1+8 é¢„è§ˆ tileï¼Œç„¶å `ghostTilemap.color = new Color(1f, 0f, 0f, previewAlpha);`
- ç§»é™¤ `previewOverlayMaterial.SetColor` è°ƒç”¨
- ç§»é™¤ `cursorRenderer.enabled = true` + `UpdateCursor`ï¼ˆè€•åœ°æ¨¡å¼ä¸å†ä½¿ç”¨æ–¹æ¡†å…‰æ ‡ï¼‰

**ä¿®æ”¹ 3 â€” UpdateWateringPreview**ï¼ˆR3ï¼‰ï¼š
- ç§»é™¤ `previewOverlayMaterial.SetColor` è°ƒç”¨
- isValid=trueï¼š`ghostTilemap.color = new Color(0f, 0.5f, 1f, previewAlpha);`ï¼ˆè“è‰²ï¼‰
- isValid=falseï¼š`ghostTilemap.color = new Color(1f, 0f, 0f, previewAlpha);`ï¼ˆçº¢è‰²ï¼‰

**ä¿®æ”¹ 4 â€” UpdateSeedPreview**ï¼š
- å·²ç»ç”¨ `Color.clear` æ¸…é™¤ shaderï¼Œæ”¹ä¸ºä¸æ“ä½œ `ghostTilemap.color`ï¼ˆç§å­é¢„è§ˆä¸ç”¨ ghostTilemapï¼‰


### æ¨¡å— N è¡¥å……ï¼šcanTill=false æ—¶ä¹Ÿæ˜¾ç¤º 1+8 é¢„è§ˆï¼ˆP2 æ ¸å¿ƒï¼‰

**å½“å‰ canTill=false åˆ†æ”¯**ï¼š
```csharp
else
{
    _currentGhostTileData?.Clear();
    if (cursorRenderer != null)
    {
        cursorRenderer.enabled = true;
        UpdateCursor(layerIndex, cellPos);
    }
}
```

**ä¿®æ”¹å**ï¼šcanTill=false æ—¶ä¹Ÿè°ƒç”¨ `GetPreviewTiles` è®¡ç®— 1+8 é¢„è§ˆï¼Œå†™å…¥ ghostTilemapï¼Œä½†é¢œè‰²è®¾ä¸ºçº¢è‰²ã€‚

```csharp
else
{
    _currentGhostTileData?.Clear();
    
    // ğŸ”´ è¡¥ä¸004V5 æ¨¡å—Oï¼ˆCP-O1ï¼‰ï¼šcanTill=false ä¹Ÿæ˜¾ç¤º 1+8 é¢„è§ˆï¼ˆçº¢è‰²æŸ“è‰²ï¼‰
    if (FarmlandBorderManager.Instance != null)
    {
        var previewTiles = FarmlandBorderManager.Instance.GetPreviewTiles(
            layerIndex, cellPos, queuePreviewPositions);
        foreach (var kvp in previewTiles)
        {
            if (kvp.Value == null) continue;
            ghostTilemap.SetTile(kvp.Key, kvp.Value);
            currentPreviewPositions.Add(kvp.Key);
        }
    }
    // cursorRenderer ä¸å†å¯ç”¨ï¼ˆç§»é™¤æ–¹æ¡†æ–¹æ¡ˆï¼‰
}
```

**æ³¨æ„**ï¼šcanTill=false æ—¶æ˜¾ç¤ºçš„æ˜¯"å®Œæ•´é¢„è§ˆ"ï¼ˆä¸åšå¢é‡è¿‡æ»¤ï¼‰ï¼Œå› ä¸ºç›®çš„æ˜¯è®©ç”¨æˆ·çœ‹åˆ°"å¦‚æœè€•ç§ä¼šæ˜¯ä»€ä¹ˆæ ·"ã€‚å¢é‡è¿‡æ»¤åªåœ¨ canTill=true æ—¶æœ‰æ„ä¹‰ï¼ˆé¿å…ç»¿è‰² tile è¦†ç›–å·²æœ‰è€•åœ°ï¼‰ã€‚

**ä½†æ˜¯**â€”â€”å¦‚æœ canTill=false çš„åŸå› æ˜¯"å·²åœ¨é˜Ÿåˆ—ä¸­"ï¼ˆP1 ä¿®å¤ï¼‰ï¼Œé‚£ä¹ˆè¯¥ä½ç½®å·²ç»æœ‰é˜Ÿåˆ—é¢„è§ˆ tile åœ¨ b å±‚ä¸Šäº†ã€‚æ­¤æ—¶ ghost æ˜¾ç¤ºå®Œæ•´ 1+8 é¢„è§ˆä¼šå’Œ b å±‚é‡å ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šcanTill=false æ—¶åˆ†ä¸¤ç§æƒ…å†µï¼š
1. å·²åœ¨é˜Ÿåˆ—ä¸­ï¼ˆ`queuePreviewPositions.Contains(cellPos)`ï¼‰ï¼šæ˜¾ç¤ºå®Œæ•´ 1+8 é¢„è§ˆï¼Œçº¢è‰²æŸ“è‰²ã€‚b å±‚çš„ tile ä¼šè¢« ghost çš„ Sorting Orderï¼ˆ9999 > 9998ï¼‰è¦†ç›–ï¼Œè§†è§‰ä¸Šçœ‹åˆ°çš„æ˜¯çº¢è‰²çš„ 1+8
2. å·²æœ‰å®é™…è€•åœ°ï¼ˆ`CanTillAt` è¿”å› falseï¼‰ï¼šæ˜¾ç¤ºå®Œæ•´ 1+8 é¢„è§ˆï¼Œçº¢è‰²æŸ“è‰²ã€‚c å±‚çš„ tile ä¼šè¢« ghost è¦†ç›–ï¼Œè§†è§‰ä¸Šçœ‹åˆ°çš„æ˜¯çº¢è‰²çš„ 1+8
3. æœ‰éšœç¢ç‰©ï¼š`hasObstacle=true` å¯¼è‡´ `isValid=false`ï¼Œä½† `canTill` å¯èƒ½ä¸º trueã€‚è¿™ç§æƒ…å†µä¸‹ ghost ä»ç„¶æ˜¾ç¤ºç»¿è‰² 1+8 é¢„è§ˆï¼ˆå› ä¸ºè¿›å…¥äº† canTill=true åˆ†æ”¯ï¼‰ï¼Œåªæ˜¯ `isValid=false`

ç­‰ç­‰ï¼Œé‡æ–°å®¡è§†é€»è¾‘æµï¼š
```
isValid = !hasObstacle && (canTill || canClearWithered)
```

- `hasObstacle=true` â†’ `isValid=false`ï¼Œä½† `canTill` å¯èƒ½ä¸º true â†’ è¿›å…¥ canTill=true åˆ†æ”¯ â†’ æ˜¾ç¤ºç»¿è‰² 1+8
- è¿™æ˜¯å¦æ­£ç¡®ï¼Ÿæœ‰éšœç¢ç‰©æ—¶æ˜¾ç¤ºç»¿è‰²é¢„è§ˆï¼Ÿ

**å‘ç°æ–°é—®é¢˜**ï¼šå½“å‰é€»è¾‘ä¸­ï¼Œ`canTill=true` ä½† `hasObstacle=true` æ—¶ï¼Œghost æ˜¾ç¤ºç»¿è‰² 1+8 é¢„è§ˆï¼Œä½† `isValid=false`ã€‚shader ä¼šè®¾ç½®çº¢è‰²å åŠ ï¼ˆ`overlayInvalidColor`ï¼‰ï¼Œæ‰€ä»¥è§†è§‰ä¸Šæ˜¯çº¢è‰²çš„ã€‚ä½†å¦‚æœç§»é™¤ shader æ”¹ç”¨ `ghostTilemap.color`ï¼Œéœ€è¦æ ¹æ® `isValid`ï¼ˆè€Œé `canTill`ï¼‰æ¥è®¾ç½®é¢œè‰²ã€‚

**ä¿®æ­£æ–¹æ¡ˆ**ï¼šé¢œè‰²è®¾ç½®åº”åŸºäº `isValid` è€Œé `canTill`ï¼š
- `isValid=true`ï¼šç»¿è‰²
- `isValid=false`ï¼šçº¢è‰²

è¿™æ ·æ— è®ºæ˜¯éšœç¢ç‰©ã€å·²æœ‰è€•åœ°ã€è¿˜æ˜¯å·²åœ¨é˜Ÿåˆ—ä¸­ï¼Œåªè¦ `isValid=false`ï¼Œghost éƒ½æ˜¾ç¤ºçº¢è‰²ã€‚

### æ¨¡å— Pï¼šæµ‡æ°´/æ’­ç§ ghost çº³å…¥ b å±‚æ£€æŸ¥ï¼ˆR1 + R2ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`FarmToolPreview.cs`

**ä¿®æ”¹ 1 â€” UpdateWateringPreview**ï¼š
```csharp
bool canWater = tileData != null && tileData.isTilled && !tileData.wateredToday;

// ğŸ”´ è¡¥ä¸004V5 æ¨¡å—Pï¼ˆCP-P1ï¼‰ï¼šæµ‡æ°´ ghost çº³å…¥ b å±‚æ£€æŸ¥
if (canWater && queuePreviewPositions.Contains(cellPos))
    canWater = false;
```

**ä¿®æ”¹ 2 â€” UpdateSeedPreview**ï¼š
```csharp
bool canPlant = tileData != null && tileData.CanPlant();

// ğŸ”´ è¡¥ä¸004V5 æ¨¡å—Pï¼ˆCP-P2ï¼‰ï¼šæ’­ç§ ghost çº³å…¥ b å±‚æ£€æŸ¥
if (canPlant && queuePreviewPositions.Contains(cellPos))
    canPlant = false;
```

---

## å…­ã€æ­£ç¡®æ€§å±æ€§

| ç¼–å· | å±æ€§ | éªŒè¯æ–¹å¼ |
|------|------|---------|
| CP-N1 | å½“ `queuePreviewPositions.Contains(cellPos)` æ—¶ï¼Œè€•åœ° ghost çš„ `canTill` å¿…é¡»ä¸º false | ä»£ç å®¡æŸ¥ |
| CP-O1 | canTill=false æ—¶ ghostTilemap ä¸Šä»æ˜¾ç¤º 1+8 é¢„è§ˆ tileï¼ˆçº¢è‰²æŸ“è‰²ï¼‰ | æ¸¸æˆå†…éªŒæ”¶ |
| CP-O2 | canTill=true æ—¶ ghostTilemap.color ä¸ºç»¿è‰²ï¼ˆ`previewAlpha` é€æ˜åº¦ï¼‰ | æ¸¸æˆå†…éªŒæ”¶ |
| CP-O3 | isValid=false æ—¶ ghostTilemap.color ä¸ºçº¢è‰² | æ¸¸æˆå†…éªŒæ”¶ |
| CP-O4 | `previewOverlayMaterial` ä¸å†èµ‹ç»™ `ghostTilemapRenderer` | ä»£ç å®¡æŸ¥ |
| CP-O5 | è€•åœ°æ¨¡å¼ä¸‹ `cursorRenderer` å§‹ç»ˆ disabled | ä»£ç å®¡æŸ¥ |
| CP-O6 | æµ‡æ°´é¢„è§ˆé¢œè‰²é€šè¿‡ `ghostTilemap.color` æ§åˆ¶ï¼Œä¸é€šè¿‡ shader | ä»£ç å®¡æŸ¥ |
| CP-P1 | å½“ `queuePreviewPositions.Contains(cellPos)` æ—¶ï¼Œæµ‡æ°´ ghost çš„ `canWater` å¿…é¡»ä¸º false | ä»£ç å®¡æŸ¥ |
| CP-P2 | å½“ `queuePreviewPositions.Contains(cellPos)` æ—¶ï¼Œæ’­ç§ ghost çš„ `canPlant` å¿…é¡»ä¸º false | ä»£ç å®¡æŸ¥ |

---

## ä¸ƒã€æ¶‰åŠæ–‡ä»¶æ±‡æ€»

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `FarmToolPreview.cs` | æ¨¡å— Nï¼ˆcanTill çº³å…¥ b å±‚ï¼‰+ æ¨¡å— Oï¼ˆç»Ÿä¸€é¢œè‰²æ§åˆ¶ï¼‰+ æ¨¡å— Pï¼ˆæµ‡æ°´/æ’­ç§çº³å…¥ b å±‚ï¼‰ |
| `FarmToolPreview.cs` â€” `EnsureComponents` | ç§»é™¤ shader Material èµ‹å€¼ï¼ˆæˆ–ä¿ç•™åˆ›å»ºä½†ä¸èµ‹ç»™ rendererï¼‰ |
| `FarmToolPreview.cs` â€” `UpdateHoePreview` | P1 ä¿®å¤ + P2/P3 ä¿®å¤ï¼ˆé¢œè‰²ç»Ÿä¸€ + canTill=false æ˜¾ç¤º 1+8ï¼‰ |
| `FarmToolPreview.cs` â€” `UpdateWateringPreview` | R1 ä¿®å¤ + R3 ä¿®å¤ï¼ˆb å±‚æ£€æŸ¥ + é¢œè‰²ç»Ÿä¸€ï¼‰ |
| `FarmToolPreview.cs` â€” `UpdateSeedPreview` | R2 ä¿®å¤ï¼ˆb å±‚æ£€æŸ¥ï¼‰ |

**ä¸éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `GameInputManager.cs` â€” å…¥é˜Ÿé€»è¾‘ä¸å—å½±å“
- `FarmlandBorderManager.cs` â€” é¢„è§ˆè®¡ç®—é€»è¾‘ä¸å—å½±å“
- `FarmTileManager.cs` â€” æ•°æ®å±‚ä¸å—å½±å“

---

## å…«ã€å…³é”®è®¾è®¡å†³ç­–è¯´æ˜

### ä¸ºä»€ä¹ˆ canTill=false æ—¶æ˜¾ç¤ºå®Œæ•´ 1+8 è€Œéå¢é‡ï¼Ÿ

canTill=false çš„åœºæ™¯ï¼š
1. å·²æœ‰å®é™…è€•åœ°ï¼ˆc å±‚ï¼‰â†’ æ˜¾ç¤ºå®Œæ•´ 1+8 ä¼šå’Œ c å±‚é‡å ï¼Œä½† ghost Sorting Order æ›´é«˜ï¼Œè§†è§‰ä¸Šè¦†ç›–ä¸ºçº¢è‰²
2. å·²åœ¨é˜Ÿåˆ—ä¸­ï¼ˆb å±‚ï¼‰â†’ æ˜¾ç¤ºå®Œæ•´ 1+8 ä¼šå’Œ b å±‚é‡å ï¼ŒåŒç†è¦†ç›–ä¸ºçº¢è‰²
3. æ— åœ°é¢ Tile â†’ `GetPreviewTiles` å¯èƒ½è¿”å›ç©ºï¼ˆå–å†³äº `groundTilemap` æ£€æŸ¥ï¼‰ï¼Œä¸å½±å“

å¢é‡è¿‡æ»¤çš„ç›®çš„æ˜¯"åªæ˜¾ç¤ºæ–°å¢éƒ¨åˆ†"ï¼Œè¿™åœ¨ canTill=true æ—¶æœ‰æ„ä¹‰ï¼ˆç»¿è‰² tile ä¸åº”è¦†ç›–å·²æœ‰è€•åœ°çš„æ­£å¸¸é¢œè‰²ï¼‰ã€‚ä½† canTill=false æ—¶ï¼Œæ•´ä½“æŸ“çº¢è‰²å°±æ˜¯è¦å‘Šè¯‰ç”¨æˆ·"è¿™é‡Œä¸èƒ½æ“ä½œ"ï¼Œè¦†ç›–æ˜¯æœŸæœ›è¡Œä¸ºã€‚

### ä¸ºä»€ä¹ˆç§»é™¤ shader è€Œéä¿ç•™ï¼Ÿ

1. æ”¾ç½®ç³»ç»Ÿä¸ç”¨ shaderï¼Œç»Ÿä¸€æ–¹æ¡ˆé™ä½ç»´æŠ¤æˆæœ¬
2. `ghostTilemap.color` æ˜¯ Unity Tilemap åŸç”Ÿ APIï¼Œæ€§èƒ½å’Œå…¼å®¹æ€§æ›´å¥½
3. `FarmPreviewOverlay` shader æ˜¯ä¸“é—¨ä¸ºæ­¤åˆ›å»ºçš„ï¼Œç§»é™¤åå‡å°‘é¡¹ç›®ä¸­çš„è‡ªå®šä¹‰ shader æ•°é‡
4. shader æ–¹æ¡ˆéœ€è¦åœ¨æ¯ä¸ª Update* æ–¹æ³•ä¸­è°ƒç”¨ `SetColor`ï¼Œ`ghostTilemap.color` åŒæ ·éœ€è¦æ¯å¸§è®¾ç½®ï¼Œä½†ä¸éœ€è¦é¢å¤–çš„ Material å®ä¾‹

### ghostTilemap.color çš„å·¥ä½œåŸç†

`Tilemap.color` æ˜¯ä¸€ä¸ªå…¨å±€é¢œè‰²ä¹˜æ•°ï¼Œä¼šå½±å“è¯¥ Tilemap ä¸Šæ‰€æœ‰ tile çš„æ¸²æŸ“é¢œè‰²ã€‚è®¾ç½®ä¸º `new Color(0, 1, 0, 0.5)` æ—¶ï¼Œæ‰€æœ‰ tile ä¼šæ˜¾ç¤ºä¸ºç»¿è‰²åŠé€æ˜ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„æ•ˆæœã€‚

**æ³¨æ„**ï¼š`ghostTilemap.color` ä¼šå½±å“ ghostTilemap ä¸Šçš„æ‰€æœ‰ tileã€‚ç”±äº ghost æ¯å¸§ `ClearGhostTilemap` åé‡æ–°è®¾ç½® tileï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ®‹ç•™ tile è¢«é”™è¯¯æŸ“è‰²çš„é—®é¢˜ã€‚
