# 003é”è¯„002 å®¡è§†æŠ¥å‘Š

> é”è¯„æ¥æºï¼š`003é”è¯„002.md`ï¼ˆGemini å¯¹ 003é”è¯„001å®¡è§†æŠ¥å‘Šçš„"é‡ç«åŠ›"å›åº”ï¼‰
> å®¡è§†æ—¶é—´ï¼š2026-02-23
> è·¯å¾„åˆ¤æ–­ï¼šğŸŸ¡ è·¯å¾„ Bï¼ˆè¯‰æ±‚1 âœ… å®Œå…¨æ­£ç¡®ä¸”é‡å¤§ï¼Œè¯‰æ±‚2 âš ï¸ éƒ¨åˆ†æ­£ç¡®ä½†"æ°¸ä¹…é”æ­»"å¤¸å¤§ï¼Œè¯‰æ±‚3 âœ… æ–¹å‘æ­£ç¡®ï¼‰

---

## ä¸€ã€é”è¯„æ ¸å¿ƒè§‚ç‚¹æ‘˜è¦

é”è¯„002æ˜¯ Gemini å¯¹ç»­33å®¡è§†æŠ¥å‘Šçš„å¼ºåŠ›å›åº”ï¼Œé’ˆå¯¹å®¡è§†æŠ¥å‘Šä¸­"éœ€è¦å…·ä½“å¤ç°åœºæ™¯"çš„å›åº”ï¼Œæä¾›äº†3ä¸ªå…·ä½“çš„æŠ€æœ¯è®ºè¯ï¼š

| ç¼–å· | è¯‰æ±‚ | ä¸¥é‡ç¨‹åº¦ | æ ¸å¿ƒå£°ç§° |
|------|------|---------|---------|
| è¯‰æ±‚1 | æ‰§è¡Œæ€çœŸç©ºæœŸ | ğŸ”´ | æ‰§è¡Œä¸­çš„æ ¼å­ä» b å±‚ç§»é™¤ä½†è¿˜æ²¡åœ¨ c å±‚è½åœ°ï¼Œç›¸é‚» ghost æŠŠå®ƒå½“ç©ºåœ° |
| è¯‰æ±‚2 | ç§å­å¹½çµå ä½ | ğŸ”´ | å¿«é€Ÿè¿ç‚¹æ’­ç§å¯¼è‡´æ ¼å­è¢«æ°¸ä¹…é”æ­»ï¼Œè§†è§‰ä¸Šæ— ä½œç‰©ä½† CanPlant=false |
| è¯‰æ±‚3 | æµ‡æ°´å…¥é˜Ÿç¬é—´éšæœº | ğŸ”´ | é‡ç”³å…¥é˜Ÿç¬é—´éšæœºï¼Œå…·ä½“åšæ³•ï¼šTryEnqueueFarmTool æˆåŠŸåç«‹åˆ» Random.Range |

---

## äºŒã€äº‹å®æ ¸æŸ¥ç»“æœ

### è¯‰æ±‚1ï¼šæ‰§è¡Œæ€çœŸç©ºæœŸ â€” âœ… å®Œå…¨æ­£ç¡®ï¼Œé‡å¤§å‘ç°

**é”è¯„å£°ç§°**ï¼šæ­£åœ¨æ‰§è¡ŒåŠ¨ç”»çš„æ ¼å­å·²ä» `queuePreviewPositions`ï¼ˆbå±‚ï¼‰ç§»é™¤ï¼Œä½†è¿˜æ²¡åœ¨ `FarmTileManager`ï¼ˆcå±‚ï¼‰è½åœ°ã€‚ç›¸é‚»æ ¼å­çš„ `UpdateHoePreview` æŠŠå®ƒå½“ç©ºåœ°ï¼Œå·®é›†è®¡ç®—å¤±æ•ˆã€‚

**ä»£ç äº‹å®**ï¼š

`PromoteToExecutingPreview`ï¼ˆç¬¬1350è¡Œï¼‰æœ€åä¸€è¡Œï¼š
```csharp
queuePreviewPositions.Remove(cellPos);  // â† ä» b å±‚è¿½è¸ªä¸­ç§»é™¤
```

`UpdateHoePreview`ï¼ˆç¬¬487è¡Œï¼‰è°ƒç”¨ `GetPreviewTiles` æ—¶ä¼ å…¥ `queuePreviewPositions`ï¼š
```csharp
var previewTiles = FarmlandBorderManager.Instance.GetPreviewTiles(layerIndex, cellPos, queuePreviewPositions);
```

`GetPreviewTiles` é‡è½½ï¼ˆç¬¬319è¡Œï¼‰çš„ predicateï¼š
```csharp
System.Func<Vector3Int, bool> predicate = (pos) =>
{
    if (pos == centerPos) return true;
    if (additionalTilledPositions != null && additionalTilledPositions.Contains(pos)) return true;
    return IsCenterBlock(layerIndex, pos);  // â† åªæŸ¥ c å±‚å®é™…è€•åœ°
};
```

**æ¨æ¼”**ï¼š
1. æ ¼å­ A å…¥é˜Ÿ â†’ `queuePreviewPositions` åŒ…å« A
2. è§’è‰²åˆ°è¾¾ A â†’ `ExecuteFarmAction` â†’ `PromoteToExecutingPreview(A)` â†’ A ä» `queuePreviewPositions` ç§»é™¤ï¼Œè½¬å…¥ `executingTileGroups`
3. åŠ¨ç”»æ’­æ”¾ä¸­ï¼ˆå‡ ç™¾æ¯«ç§’ï¼‰ï¼Œc å±‚è¿˜æ²¡æœ‰ A çš„è€•åœ°æ•°æ®
4. æ­¤æ—¶é¼ æ ‡ç§»åˆ° A æ—è¾¹çš„æ ¼å­ B â†’ `UpdateHoePreview(B)` â†’ `GetPreviewTiles(B, queuePreviewPositions)`
5. predicate æ£€æŸ¥ Aï¼š`centerPos` ä¸æ˜¯ A â†’ `queuePreviewPositions` ä¸åŒ…å« Aï¼ˆå·²ç§»é™¤ï¼‰â†’ `IsCenterBlock` è¿”å› falseï¼ˆc å±‚è¿˜æ²¡è½åœ°ï¼‰
6. **ç»“æœï¼šA è¢«å½“æˆç©ºåœ°ï¼** B çš„ 1+8 é¢„è§ˆä¸çŸ¥é“ A çš„å­˜åœ¨ï¼Œè¾¹ç•Œè®¡ç®—é”™è¯¯

**æ ¸æŸ¥ç»“è®º**ï¼šâœ… å®Œå…¨æ­£ç¡®ã€‚è¿™æ˜¯ç»­33å®¡è§†æŠ¥å‘Šä¸­è¯‰æ±‚1A"éœ€è¦å…·ä½“å¤ç°åœºæ™¯"çš„å®Œç¾å›ç­”ã€‚æ‰§è¡Œæ€çœŸç©ºæœŸç¡®å®å­˜åœ¨ï¼Œ`executingTileGroups` ä¸­çš„æ ¼å­ä½ç½®æ²¡æœ‰è¢«ä¼ é€’ç»™ `GetPreviewTiles` çš„ predicateã€‚

**ä¿®å¤æ–¹å‘**ï¼šé”è¯„å»ºè®® `cDirs | bDirs | executingDirs` åˆå¹¶è®¡ç®—ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œåº”è¯¥åœ¨è°ƒç”¨ `GetPreviewTiles` æ—¶ï¼Œå°† `executingTileGroups` çš„ keys ä¹Ÿçº³å…¥ `additionalTilledPositions`ï¼š

```
// åˆå¹¶ b å±‚ + æ‰§è¡Œå±‚
var combinedPositions = new HashSet<Vector3Int>(queuePreviewPositions);
foreach (var key in executingTileGroups.Keys)
    combinedPositions.Add(key);
foreach (var pos in executingWaterPositions)
    combinedPositions.Add(pos);

var previewTiles = GetPreviewTiles(layerIndex, cellPos, combinedPositions);
```

åŒæ—¶ï¼Œå¢é‡å·®é›†è¿‡æ»¤ä¸­æŸ¥ b å±‚ tile æ—¶ï¼Œä¹Ÿè¦æŸ¥æ‰§è¡Œå±‚ tileï¼ˆ`queuePreviewTilemap` ä¸Šæ‰§è¡Œå±‚çš„ tile ä»ç„¶ä¿ç•™ç€ï¼Œåªæ˜¯è¿½è¸ªæ•°æ®ä» `tillQueueTileGroups` è½¬ç§»åˆ°äº† `executingTileGroups`ï¼‰ã€‚


### è¯‰æ±‚2ï¼šç§å­å¹½çµå ä½ â€” âš ï¸ éƒ¨åˆ†æ­£ç¡®ï¼Œ"æ°¸ä¹…é”æ­»"å¤¸å¤§

**é”è¯„å£°ç§°**ï¼šå¿«é€Ÿè¿ç‚¹æ’­ç§å¯¼è‡´"å¹½çµæ“ä½œ"â€”â€”æ ¼å­è§†è§‰ä¸Šæ²¡é•¿å‡ºä½œç‰©ä½†è¢«æ°¸ä¹…é”æ­»ï¼ˆ`CanPlant=false`ï¼‰ã€‚ç§å­é˜Ÿåˆ—å¤„ç†ä¸è·ç¦»åˆ¤å®š/å¯¼èˆªä½“ç³»å‘ç”Ÿç«æ€å†²çªã€‚

**ä»£ç äº‹å®**ï¼š

1. **é˜²é‡å¤æœºåˆ¶**ï¼š`EnqueueAction`ï¼ˆç¬¬2332è¡Œï¼‰æœ‰ `_queuedPositions.Contains(key)` æ£€æŸ¥ï¼ŒåŒä¸€æ ¼å­ä¸ä¼šé‡å¤å…¥é˜Ÿã€‚

2. **ç§å­æ‰§è¡Œåˆ†æ”¯**ï¼ˆ`ExecuteFarmAction` ç¬¬2497è¡Œï¼‰ï¼š
```csharp
case FarmActionType.PlantSeed:
    var seedData = GetCurrentSeedData();
    if (seedData != null)
        ExecutePlantSeed(seedData, request.layerIndex, request.cellPos);
    // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ‰§è¡Œæ¸…ç†ï¼š
    FarmToolPreview.Instance?.RemoveExecutingPreview(request.cellPos);
    _isExecutingFarming = false;
    _queuedPositions.Remove((request.layerIndex, request.cellPos));
    ProcessNextAction();
    break;
```

3. **`ExecutePlantSeed`**ï¼ˆç¬¬1595è¡Œï¼‰å†…éƒ¨æœ‰å®Œæ•´çš„æ ¡éªŒé“¾ï¼š
   - `tileData == null || !tileData.CanPlant()` â†’ è¿”å› false
   - ç§å­æ¶ˆè€—å¤±è´¥ â†’ è¿”å› false
   - cropPrefab ä¸ºç©º â†’ è¿”å› false
   - æ‰€æœ‰å¤±è´¥è·¯å¾„éƒ½åªæ˜¯ return falseï¼Œä¸ä¿®æ”¹è€•åœ°æ•°æ®

4. **å…³é”®**ï¼š`_queuedPositions.Remove` åœ¨ `ExecutePlantSeed` ä¹‹å**æ— æ¡ä»¶æ‰§è¡Œ**ï¼Œä¸ç®¡ç§å­æ˜¯å¦ç§æ¤æˆåŠŸã€‚æ ¼å­ä¸ä¼šè¢«"æ°¸ä¹…é”æ­»"ã€‚

**æ¨æ¼”å¿«é€Ÿè¿ç‚¹åœºæ™¯**ï¼š
1. é¼ æ ‡åœ¨æ ¼å­ A â†’ ç‚¹å‡» â†’ `TryEnqueueSeed` â†’ `EnqueueAction` â†’ `_queuedPositions.Add(A)` â†’ `ProcessNextAction` â†’ å¯¼èˆªåˆ° A
2. é¼ æ ‡ç§»åˆ°æ ¼å­ B â†’ ç‚¹å‡» â†’ `TryEnqueueSeed` â†’ `EnqueueAction` â†’ `_queuedPositions.Add(B)` â†’ æ’é˜Ÿç­‰å¾…
3. åˆ°è¾¾ A â†’ `ExecuteFarmAction` â†’ `ExecutePlantSeed` æˆåŠŸ â†’ `_queuedPositions.Remove(A)` â†’ `ProcessNextAction` â†’ å¯¼èˆªåˆ° B
4. åˆ°è¾¾ B â†’ `ExecuteFarmAction` â†’ `ExecutePlantSeed` æˆåŠŸ â†’ `_queuedPositions.Remove(B)`

**"å¹½çµå ä½"å¯èƒ½çš„çœŸå®åœºæ™¯**ï¼š
- ç§å­å…¥é˜Ÿæ—¶ `CanPlant=true`ï¼Œä½†æ‰§è¡Œæ—¶ `CanPlant=false`ï¼ˆå…¶ä»–æ“ä½œæ”¹å˜äº†çŠ¶æ€ï¼‰
- `ExecutePlantSeed` è¿”å› falseï¼Œä½† `_queuedPositions.Remove` ä»ç„¶æ‰§è¡Œ â†’ æ ¼å­è¢«é‡Šæ”¾
- **ä¸å­˜åœ¨"æ°¸ä¹…é”æ­»"**

**ä½†é”è¯„çš„æ ¸å¿ƒæ–¹å‘æ˜¯å¯¹çš„**ï¼šç§å­ç¡®å®ä¸åº”è¯¥èµ°å†œç”°é˜Ÿåˆ—ã€‚ç§å­"æ— åŠ¨ç”»ç›´æ¥æ‰§è¡Œ"çš„ç‰¹æ€§ä¸é˜Ÿåˆ—ç³»ç»Ÿï¼ˆå¯¼èˆªâ†’åˆ°è¾¾â†’æ‰§è¡Œâ†’åŠ¨ç”»â†’å®Œæˆï¼‰çš„è®¾è®¡ä¸åŒ¹é…ã€‚è¿™æ˜¯å·²çŸ¥å¾…åŠï¼ˆæ¨¡å—Rï¼‰ï¼Œä¸æ˜¯æ–°å‘ç°ã€‚

**æ ¸æŸ¥ç»“è®º**ï¼šâš ï¸ éƒ¨åˆ†æ­£ç¡®ã€‚ç§å­èµ°é˜Ÿåˆ—ç¡®å®ä¸åˆç†ï¼ˆå·²çŸ¥å¾…åŠï¼‰ï¼Œä½†"æ ¼å­è¢«æ°¸ä¹…é”æ­»"çš„å£°ç§°ä¸ä»£ç äº‹å®ä¸ç¬¦ã€‚`_queuedPositions.Remove` æ— æ¡ä»¶æ‰§è¡Œï¼Œä¸å­˜åœ¨æ°¸ä¹…é”æ­»ã€‚é”è¯„å°†"è®¾è®¡ä¸åˆç†"å‡çº§ä¸º"æ¶æ€§ Bug"æœ‰å¤¸å¤§æˆåˆ†ã€‚

---

### è¯‰æ±‚3ï¼šæµ‡æ°´å…¥é˜Ÿç¬é—´éšæœº â€” âœ… æ–¹å‘æ­£ç¡®ï¼Œå…·ä½“åšæ³•åˆç†

**é”è¯„å£°ç§°**ï¼šåœ¨ `TryEnqueueFarmTool` æµ‡æ°´åˆ†æ”¯æˆåŠŸ `EnqueueAction` åç«‹åˆ» `Random.Range` æ›´æ–°ç¼“å­˜ã€‚

**ä»£ç äº‹å®**ï¼š

å½“å‰éšæœºè§¦å‘é“¾ï¼ˆç»­33å·²ç¡®è®¤æ˜¯ bugï¼‰ï¼š
```
ExecuteWaterTile æˆåŠŸ â†’ OnWaterExecuted(cellPos)
  â†’ _needsNewPuddleVariant = true
  â†’ _lastWateringCellPos = wateredCellPos

UpdateWateringPreview æ¯å¸§ï¼š
  â†’ if (_needsNewPuddleVariant && cellPos != _lastWateringCellPos)
    â†’ éšæœºæ–°æ ·å¼
```

é—®é¢˜ï¼šè§’è‰²åœ¨è¿œå¤„æ‰§è¡Œæµ‡æ°´ â†’ `_needsNewPuddleVariant=true` â†’ é¼ æ ‡åœåœ¨åŸåœ° â†’ `cellPos â‰  _lastWateringCellPos` â†’ æ¯æ¬¡æ‰§è¡Œå®Œéƒ½è§¦å‘éšæœº â†’ ghost ç–¯ç‹‚å˜å¹»ã€‚

**é”è¯„å»ºè®®çš„åšæ³•**ï¼š
```
TryEnqueueFarmTool æµ‡æ°´å…¥é˜ŸæˆåŠŸåï¼š
  â†’ Random.Range æ›´æ–° _cachedPuddleVariant
  â†’ ä¸‹ä¸€å¸§ UpdateWateringPreview ç›´æ¥ä½¿ç”¨æ–° variant
```

**è¯„ä¼°**ï¼š
- é€»è¾‘æ¸…æ™°ï¼šå…¥é˜Ÿ = ç©å®¶ç¡®è®¤å½“å‰æ ·å¼ â†’ ç«‹åˆ»ä¸ºä¸‹ä¸€æ¬¡å‡†å¤‡æ–°æ ·å¼
- ä¸è§’è‰²æ‰§è¡Œå®Œå…¨è§£è€¦ï¼Œä¸ä¼šå› è¿œå¤„æ‰§è¡Œå½±å“é¼ æ ‡å¤„ ghost
- æ¯”å½“å‰çš„ `OnWaterExecuted` + `_needsNewPuddleVariant` æœºåˆ¶ç®€å•å¾—å¤š
- å¯ä»¥åºŸå¼ƒ `_needsNewPuddleVariant` å’Œ `_lastWateringCellPos` å­—æ®µ

**æ ¸æŸ¥ç»“è®º**ï¼šâœ… æ–¹å‘æ­£ç¡®ï¼Œå…·ä½“åšæ³•åˆç†ã€‚ä¸ç»­33å®¡è§†æŠ¥å‘Šçš„ä¿®å¤æ–¹å‘ä¸€è‡´ï¼Œé”è¯„002è¿›ä¸€æ­¥æ˜ç¡®äº†å®ç°ç»†èŠ‚ã€‚

---

## ä¸‰ã€è®¤åŒçš„éƒ¨åˆ†

1. **è¯‰æ±‚1 å®Œå…¨è®¤åŒ**ï¼šæ‰§è¡Œæ€çœŸç©ºæœŸæ˜¯çœŸå®å­˜åœ¨çš„æ¶æ„ç›²åŒºã€‚ç»­33å®¡è§†æŠ¥å‘Šä¸­è¯´"éœ€è¦å…·ä½“å¤ç°åœºæ™¯"ï¼Œé”è¯„002ç»™å‡ºäº†ç²¾ç¡®çš„ä»£ç çº§è®ºè¯ã€‚è¿™æ˜¯æœ¬è½®æœ€é‡è¦çš„å‘ç°ã€‚
2. **è¯‰æ±‚3 å®Œå…¨è®¤åŒ**ï¼šæµ‡æ°´å…¥é˜Ÿç¬é—´éšæœºçš„å…·ä½“åšæ³•åˆç†ï¼Œæ¯”å½“å‰æ–¹æ¡ˆæ›´ç®€æ´ã€‚
3. **è¯‰æ±‚2 éƒ¨åˆ†è®¤åŒ**ï¼šç§å­ä¸åº”èµ°é˜Ÿåˆ—ï¼ˆå·²çŸ¥å¾…åŠï¼‰ï¼Œä½†"æ°¸ä¹…é”æ­»"çš„æè¿°ä¸ä»£ç äº‹å®ä¸ç¬¦ã€‚

## å››ã€ç–‘è™‘ä¸å¼‚è®®

### è¯‰æ±‚2 çš„"æ°¸ä¹…é”æ­»"å£°ç§°ä¸æˆç«‹

é”è¯„è¯´"æ ¼å­åœ¨è§†è§‰ä¸Šä»€ä¹ˆéƒ½æ²¡é•¿å‡ºæ¥ï¼Œä½†å·²ç»è¢«æ°¸ä¹…é”æ­»"ã€‚ä»£ç äº‹å®ï¼š

- `ExecuteFarmAction` çš„ `PlantSeed` åˆ†æ”¯ä¸­ï¼Œ`_queuedPositions.Remove` åœ¨ `ExecutePlantSeed` ä¹‹å**æ— æ¡ä»¶æ‰§è¡Œ**
- å³ä½¿ `ExecutePlantSeed` è¿”å› falseï¼ˆç§å­ç”¨å®Œã€CanPlant=falseã€å­£èŠ‚ä¸å¯¹ç­‰ï¼‰ï¼Œæ ¼å­ä»ç„¶è¢«ä» `_queuedPositions` é‡Šæ”¾
- `RemoveExecutingPreview` ä¹Ÿæ— æ¡ä»¶æ‰§è¡Œï¼Œæ¸…é™¤æ‰§è¡Œé¢„è§ˆ
- ä¸å­˜åœ¨"æ°¸ä¹…é”æ­»"çš„ä»£ç è·¯å¾„

**å¯èƒ½çš„æ··æ·†**ï¼šé”è¯„å¯èƒ½å°†"ç§å­èµ°é˜Ÿåˆ—ä¸åˆç†"ï¼ˆè®¾è®¡é—®é¢˜ï¼‰ä¸"æ ¼å­è¢«æ°¸ä¹…é”æ­»"ï¼ˆæ•°æ® bugï¼‰æ··ä¸ºä¸€è°ˆã€‚ç§å­èµ°é˜Ÿåˆ—ç¡®å®æœ‰é—®é¢˜ï¼ˆå¯¼èˆªå»¶è¿Ÿã€æ— åŠ¨ç”»ç›´æ¥æ‰§è¡Œçš„ä¸ä¸€è‡´æ€§ï¼‰ï¼Œä½†ä¸ä¼šå¯¼è‡´æ ¼å­æ•°æ®æŸåã€‚

### è¯‰æ±‚1 çš„ä¿®å¤æ–¹å‘éœ€è¦ç»†åŒ–

é”è¯„å»ºè®® `cDirs | bDirs | executingDirs` åˆå¹¶ã€‚è¿™ä¸ªæ–¹å‘å®Œå…¨æ­£ç¡®ï¼Œä½†å®ç°ä¸Šéœ€è¦æ³¨æ„ï¼š

1. `GetPreviewTiles` çš„ predicate éœ€è¦åŒæ—¶æ„ŸçŸ¥ `queuePreviewPositions` + `executingTileGroups.Keys` + `executingWaterPositions`
2. å¢é‡å·®é›†è¿‡æ»¤ä¸­æŸ¥ b å±‚ tile æ—¶ï¼Œæ‰§è¡Œå±‚çš„ tile ä»åœ¨ `queuePreviewTilemap` ä¸Šï¼ˆ`PromoteToExecutingPreview` åªç§»é™¤è¿½è¸ªæ•°æ®ï¼Œä¸æ¸…é™¤ tileï¼‰ï¼Œæ‰€ä»¥ç°æœ‰çš„ `queuePreviewTilemap.GetTile()` æŸ¥è¯¢å·²ç»èƒ½è·å–åˆ°æ‰§è¡Œå±‚ tile
3. çœŸæ­£éœ€è¦ä¿®å¤çš„æ˜¯ predicate ä¸­ç¼ºå°‘æ‰§è¡Œå±‚ä½ç½®

---

## äº”ã€ç‹¬ç«‹åˆ†æä¸ä¿®å¤å»ºè®®

### è¯‰æ±‚1 ä¿®å¤æ–¹æ¡ˆï¼ˆæ˜ç¡®å¯æ‰§è¡Œï¼‰

åœ¨ `UpdateHoePreview` ä¸­ï¼Œè°ƒç”¨ `GetPreviewTiles` å‰åˆå¹¶æ‰§è¡Œå±‚ä½ç½®ï¼š

```csharp
// åˆå¹¶ b å±‚ + æ‰§è¡Œå±‚ä½ç½®
var combinedPositions = new HashSet<Vector3Int>(queuePreviewPositions);
foreach (var key in executingTileGroups.Keys)
    combinedPositions.Add(key);
foreach (var pos in executingWaterPositions)
    combinedPositions.Add(pos);

var previewTiles = FarmlandBorderManager.Instance.GetPreviewTiles(
    layerIndex, cellPos, combinedPositions);
```

åŒæ ·ï¼Œ`AddQueuePreview` çš„ Till åˆ†æ”¯ä¸­è°ƒç”¨ `GetPreviewTiles` æ—¶ä¹Ÿéœ€è¦åˆå¹¶æ‰§è¡Œå±‚ã€‚

å¢é‡å·®é›†è¿‡æ»¤ä¸éœ€è¦é¢å¤–ä¿®æ”¹â€”â€”`queuePreviewTilemap` ä¸Šæ‰§è¡Œå±‚çš„ tile ä»ç„¶å­˜åœ¨ï¼Œç°æœ‰çš„ `queuePreviewTilemap.GetTile()` å·²ç»èƒ½æ­£ç¡®è·å–ã€‚

### è¯‰æ±‚3 ä¿®å¤æ–¹æ¡ˆï¼ˆæ˜ç¡®å¯æ‰§è¡Œï¼‰

åœ¨ `TryEnqueueFarmTool` æµ‡æ°´å…¥é˜ŸæˆåŠŸåï¼Œç«‹åˆ»éšæœºæ–°æ ·å¼ï¼š

```csharp
// TryEnqueueFarmTool ä¸­ï¼ŒEnqueueAction ä¹‹åï¼š
if (type == FarmActionType.Water)
{
    // å…¥é˜ŸæˆåŠŸ = ç¡®è®¤å½“å‰æ ·å¼ï¼Œç«‹åˆ»ä¸ºä¸‹ä¸€æ¬¡å‡†å¤‡æ–°æ ·å¼
    var puddleTiles = FarmVisualManager.Instance?.GetPuddleTiles();
    int count = puddleTiles != null ? puddleTiles.Length : 3;
    farmPreview.SetPuddleVariant(Random.Range(0, count));
}
```

åºŸå¼ƒ `OnWaterExecuted` ä¸­çš„ `_needsNewPuddleVariant = true` é€»è¾‘ã€‚
åºŸå¼ƒ `UpdateWateringPreview` ä¸­çš„ `_needsNewPuddleVariant` éšæœºè§¦å‘ä»£ç ã€‚
ä¿ç•™ `_wateringModeInitialized` çš„åˆ‡æ¢æ—¶éšæœºé€»è¾‘ï¼ˆT1 ä¸å˜ï¼‰ã€‚

### è¯‰æ±‚2 å¤„ç†å»ºè®®

æ¨¡å—Rï¼ˆç§å­æ”¾ç½®åŒ–ï¼‰å·²åœ¨ä»£åŠä¸­ï¼ˆ`TD_10.1.4è¡¥ä¸004.md`ï¼‰ï¼ŒæŒ‰åŸè®¡åˆ’æ‰§è¡Œã€‚å½“å‰ä»£ç ä¸å­˜åœ¨"æ°¸ä¹…é”æ­»"bugï¼Œä¸éœ€è¦ç´§æ€¥ä¿®å¤ã€‚

---

## å…­ã€ç»™ Gemini çš„ä¿¡æ¯è¡¥å……

1. **æ‰§è¡Œæ€çœŸç©ºæœŸ**ï¼šå®Œå…¨è®¤åŒï¼Œè¿™æ˜¯æˆ‘åœ¨ç»­33å®¡è§†æŠ¥å‘Šä¸­é—æ¼çš„å…³é”®ç›²åŒºã€‚`executingTileGroups` çš„ keys ç¡®å®éœ€è¦çº³å…¥ `GetPreviewTiles` çš„ predicateã€‚æ„Ÿè°¢æä¾›ç²¾ç¡®çš„ä»£ç çº§è®ºè¯ã€‚

2. **ç§å­å¹½çµå ä½**ï¼š`ExecuteFarmAction` çš„ `PlantSeed` åˆ†æ”¯ä¸­ï¼Œ`_queuedPositions.Remove` å’Œ `RemoveExecutingPreview` éƒ½æ˜¯æ— æ¡ä»¶æ‰§è¡Œçš„ï¼ˆä¸ä¾èµ– `ExecutePlantSeed` çš„è¿”å›å€¼ï¼‰ã€‚ä¸å­˜åœ¨"æ°¸ä¹…é”æ­»"çš„ä»£ç è·¯å¾„ã€‚ç§å­èµ°é˜Ÿåˆ—ç¡®å®ä¸åˆç†ï¼ˆå·²çŸ¥å¾…åŠæ¨¡å—Rï¼‰ï¼Œä½†ä¸æ˜¯æ•°æ®æŸåçº§åˆ«çš„ bugã€‚

3. **æµ‡æ°´éšæœº**ï¼šå®Œå…¨è®¤åŒå…¥é˜Ÿç¬é—´éšæœºçš„åšæ³•ï¼Œæ¯”å½“å‰çš„ `OnWaterExecuted` æœºåˆ¶æ›´ç®€æ´å¯é ã€‚

---

## ä¸ƒã€æ¶‰åŠæ–‡ä»¶æ±‡æ€»

| æ–‡ä»¶ | æ ¸æŸ¥å†…å®¹ |
|------|---------|
| `FarmToolPreview.cs` | PromoteToExecutingPreviewï¼ˆqueuePreviewPositions.Remove ç¡®è®¤ï¼‰ã€UpdateHoePreviewï¼ˆGetPreviewTiles è°ƒç”¨ + å¢é‡å·®é›†4åˆ†æ”¯ï¼‰ã€AddQueuePreviewï¼ˆTill åˆ†æ”¯ GetPreviewTiles è°ƒç”¨ï¼‰ã€UpdateWateringPreviewï¼ˆéšæœºé€»è¾‘ï¼‰ã€OnWaterExecuted |
| `GameInputManager.cs` | ExecuteFarmActionï¼ˆPlantSeed åˆ†æ”¯æ— æ¡ä»¶æ¸…ç†ï¼‰ã€ProcessNextActionï¼ˆæ‰§è¡Œæ—¶åºï¼‰ã€TryEnqueueFarmToolï¼ˆæµ‡æ°´å…¥é˜Ÿï¼‰ã€TryEnqueueSeedï¼ˆç§å­å…¥é˜Ÿï¼‰ã€EnqueueActionï¼ˆé˜²é‡å¤æœºåˆ¶ï¼‰ã€ExecutePlantSeedï¼ˆå®Œæ•´æ ¡éªŒé“¾ï¼‰ |
| `FarmlandBorderManager.cs` | GetPreviewTiles ä¸¤ä¸ªé‡è½½ï¼ˆpredicate åªçœ‹ queuePreviewPositions + IsCenterBlockï¼Œä¸çœ‹ executingTileGroupsï¼‰ |
