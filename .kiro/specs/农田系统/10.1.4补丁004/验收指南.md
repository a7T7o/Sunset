# 补丁004 验收指南 V2 — 三层预览架构重构

> 基于 designV2.md 22 条正确性属性。编译验证已通过（0 错误 0 警告）。

---

## 一、编译验证

- [ ] `FarmToolPreview.cs` — getDiagnostics 0 错误 0 警告
- [ ] `GameInputManager.cs` — getDiagnostics 0 错误 0 警告
- [ ] 全局搜索 `LockPosition` — 仅出现在注释和 PlacementPreview（放置系统，不相关）
- [ ] 全局搜索 `UnlockPosition` — 同上
- [ ] 全局搜索 `_isLocked` — FarmToolPreview 中无引用（仅注释）
- [ ] 全局搜索 `LockedWorldPos` — 无引用

---

## 二、功能验收（游戏内测试）

### 2.1 Ghost 预览差异化（CP-B1/B2/B3）

- [ ] 在空地上使用锄头：ghost 显示完整 1+8 tile（中心块 + 8 个边界）
- [ ] 在已有耕地旁使用锄头：ghost 只显示差异 tile（已有相同边界的位置不显示）
- [ ] 中心块始终显示（因为目标位置未耕作）
- [ ] 鼠标移动时 ghost 实时更新，无闪烁

### 2.2 Ghost 永不锁定（CP-A1/A2）

- [ ] 点击锄地后，ghost 预览继续跟随鼠标（不冻结在点击位置）
- [ ] 远距离导航中，ghost 预览继续跟随鼠标
- [ ] 动画执行中，ghost 预览继续跟随鼠标

### 2.3 浇水预览稳定（CP-C1/C2/C3/C4）

- [ ] 鼠标停在同一格子上：水渍样式不闪烁（不每帧随机）
- [ ] 鼠标移出再移回同一格子：水渍样式可能变化（重新随机）
- [ ] 切换工具后再切回浇水壶：缓存已重置，重新随机

### 2.4 队列预览复制 Ghost 数据（CP-F1/F2）

- [ ] 快速连续点击多个位置锄地：每个队列预览的 tile 与点击时的 ghost 一致
- [ ] 浇水入队：队列预览的水渍样式与 ghost 一致（不重新随机）

### 2.5 执行预览保护（CP-D1/D2/D3/E3/G6）

- [ ] 入队多个操作 → 第一个开始执行 → 按 WASD 中断
  - 正在执行的预览保留（不消失）
  - 队列中等待的预览被清除
- [ ] 动画完成后，执行预览消失（tile 已落地，视觉无缝）

### 2.6 边界残留修复（CP-E1/E2）

- [ ] 入队多个锄地操作 → 按 WASD 中断 → 检查 queuePreviewTilemap
  - 队列中的耕地预览（包括边界 tile）全部清除
  - 无残留的半透明边界 tile

### 2.7 旧单次执行路径（TryTillSoil/TryWaterTile/TryPlantSeed）

- [ ] 近距离锄地：正常执行，无报错
- [ ] 远距离锄地（触发导航）：导航到达后正常执行
- [ ] 远距离锄地 → 导航中切换工具：操作取消，无报错
- [ ] 近距离浇水：正常执行
- [ ] 远距离浇水（触发导航）：导航到达后正常执行
- [ ] 近距离种植：正常执行
- [ ] 远距离种植（触发导航）：导航到达后正常执行
- [ ] ESC 中断：操作取消，预览恢复正常

---

## 三、已知限制

1. designV2 中 `tilledTilemap` 字段不存在 → 实际使用 `farmlandCenterTilemap` + `farmlandBorderTilemap` 分别对比
2. Obsolete 方法（`ClearPendingFarmInput`/`CacheFarmInput`/`ConsumePendingFarmInput`）中的 Lock/Unlock 调用已移除，但方法本身保留（标记为 Obsolete）
3. `ForceUpdatePreviewToPosition` 的 Obsolete 注释仍引用 `LockPosition`（仅注释，不影响编译）

---

## 四、修改文件汇总

| 文件 | 修改内容 |
|------|---------|
| `FarmToolPreview.cs` | 移除锁定机制（A）、差异化过滤（B）、浇水缓存（C）、执行预览层（D）、ClearAllQueuePreviews 修复（E）、AddQueuePreview 接收 ghost 数据（F） |
| `GameInputManager.cs` | 移除全部 Lock/Unlock 调用（G）、执行预览集成（G）、ghost 数据传递（G）、旧路径 LockedWorldPos → targetPos（G） |
