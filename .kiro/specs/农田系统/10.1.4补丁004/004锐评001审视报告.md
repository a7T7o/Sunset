# 004锐评001 审视报告

## 一、锐评核心观点摘要

Gemini 针对用户验收反馈的 4 个问题给出分析和执行指令：
1. 临界帧崩溃（TOCTOU 竞态）：WASD 在动画即将开始的微小时差内抢先清理
2. 浇水随机状态机"失忆症"：入队瞬间立刻随机导致鼠标未移开就变样式
3. 种子与作物底盘错位：连点播种出错 + 位置偏移
4. 锄草操作"提前结算"：动画未完成就销毁作物

---

## 二、事实核查结果表

| # | 锐评声明 | 代码事实 | 结论 |
|---|---------|---------|------|
| 1A | `_isExecutingFarming` 还没来得及设为 true 时 WASD 抢先介入 | `HandleMovement` 中 WASD 中断逻辑：`bool wasExecuting = _isExecutingFarming;` → `ClearActionQueue()` → 如果 `wasExecuting` 则只清队列不取消导航/不解锁。`ClearActionQueue` 内部：`if (!_isExecutingFarming)` 才清空执行状态。**双重保护已存在** | ⚠️ 部分正确 |
| 1B | `ClearActionQueue` 清空了状态导致 `RemoveExecutingPreview` 永远不会被调用 | `ClearActionQueue` 在 `_isExecutingFarming=true` 时保留 `_pendingTileUpdate`/`_currentProcessingRequest`/`_isExecutingFarming`。`OnFarmActionAnimationComplete` 仍会正常调用 `RemoveExecutingPreview`。**保护机制已存在（补丁004V2 模块H）** | ❌ 事实错误 |
| 1C | 导航到达回调到 `_isExecutingFarming=true` 之间有时差 | `WaitForNavigationComplete` 协程中：到达后 `_isExecutingFarming = true` → `onArrived?.Invoke()` → finally 中 `_isExecutingFarming = false`。但 `onArrived` 回调内调用 `ExecuteFarmAction`，而 `ExecuteFarmAction` 开头又设置 `_isExecutingFarming = true`。**协程的 finally 会在 ExecuteFarmAction 之后执行，覆盖掉 true → 变回 false** | ✅ 正确（但原因不同） |
| 2A | 入队瞬间立刻 Random.Range 导致原地预览变样 | `TryEnqueueFarmTool` 末尾确实有 `farmPreview.SetPuddleVariant(Random.Range(0, count))`（003修复注释）。**入队后立刻更新 variant，ghost 下一帧就会用新 variant 渲染** | ✅ 正确 |
| 2B | 建议找回 `_needsNewPuddleVariant` 标志位 | `_needsNewPuddleVariant` 已在续36中被废弃删除。`OnWaterExecuted` 注释明确写"003修复：_needsNewPuddleVariant 已废弃"。**锐评建议恢复一个已被有意废弃的机制** | ❌ 事实错误 |
| 2C | 建议在 UpdateWateringPreview 中检测跨格子才随机 | 当前 `UpdateWateringPreview` 中已无任何随机逻辑（003修复已移除）。随机只在两处：(1) `_wateringModeInitialized` 首次切换到水壶时；(2) `TryEnqueueFarmTool` 入队成功后。**锐评描述的代码结构与实际不符** | ❌ 事实错误 |
| 3A | 种子预览位置用 `GetCellCenterWorld` 导致 32x32 sprite 在 16x16 格子里偏移 | `UpdateSeedPreview` 中 `seedPreviewRenderer.transform.position = correctCenter`（Tilemap 原生格子中心）。`ExecutePlantSeed` 中 `cropWorldPos = tilemaps.GetCellCenterWorld(cellPos)`。**两者使用相同的坐标源**。`AlignSpriteBottom` 在 `UpdateVisuals` 中调用，将 sprite 底部对齐到 transform 位置。**预览和实际种植使用不同的对齐方式（预览直接放中心，实际种植后 AlignSpriteBottom 调整）** | ⚠️ 部分正确 |
| 3B | 连点播种出错是种子无动画执行导致的时序问题 | `ExecuteFarmAction` 中 PlantSeed 分支：直接执行 → `RemoveExecutingPreview` → `_isExecutingFarming = false` → `ProcessNextAction()`。**种子无动画，同帧完成，不存在时序竞态** | 🔍 推测性声明 |
| 4A | `ExecuteRemoveCrop` 在动画50%触发时直接调用 `RemoveCrop()` 销毁 GameObject | 代码确认：`ExecuteRemoveCrop` 调用 `tileData.cropController.RemoveCrop()` → `DestroyCrop()` → `Destroy(gameObject)`。**但 ExecuteRemoveCrop 不是在动画50%触发的——它在 `_pendingTileUpdate` 兜底逻辑中被调用** | ⚠️ 部分正确 |
| 4B | 建议 `HideCropVisuals()` + 延迟 `RemoveCrop()` | `RemoveCrop` 在 `OnFarmActionAnimationComplete` 的兜底分支中调用（`_pendingTileUpdate != null && !_tileUpdateTriggered`）。**如果动画中期事件正常触发了 ExecuteRemoveCrop，则 `_tileUpdateTriggered` 应为 true，兜底不会重复调用。但当前代码中 RemoveCrop 没有动画中期触发机制——它只在兜底中调用** | 🔍 推测性声明 |

---

## 三、认同的部分

1. **声明1C 的核心洞察**：`WaitForNavigationComplete` 协程中确实存在一个严重的状态覆盖 bug。协程的 `finally` 块会在 `onArrived` 回调（即 `ExecuteFarmAction`）执行完毕后运行，将 `_isExecutingFarming` 重置为 false，覆盖掉 `ExecuteFarmAction` 中设置的 true。这意味着通过导航到达的动作，`_isExecutingFarming` 在动画期间实际上是 false，WASD 保护机制完全失效。

2. **声明2A 的问题描述**：入队后立刻更新 variant 确实会导致 ghost 预览在鼠标未移开时就变样式，用户体验不佳。

3. **声明3A 的方向**：预览和实际种植的对齐方式确实不一致（预览用格子中心，实际种植后 AlignSpriteBottom 调整），可能导致视觉偏差。

4. **声明4 的方向**：锄草清除作物的视觉体验确实可以优化（先隐藏后删除）。

---

## 四、疑虑与异议

### 异议1：锐评对现有保护机制完全无知（严重）

锐评声称 `ClearActionQueue` 会清空执行状态导致预览残留，但实际上补丁004V2 模块H 已经实现了完善的保护：

```csharp
// ClearActionQueue 中：
if (!_isExecutingFarming)
{
    _isExecutingFarming = false;
    _currentHarvestTarget = null;
    _currentProcessingRequest = default;
    _pendingTileUpdate = null;
    _tileUpdateTriggered = false;
}
// else: 动画执行中，保留所有执行状态
```

```csharp
// HandleMovement 中：
bool wasExecuting = _isExecutingFarming;
ClearActionQueue();
if (!wasExecuting)
{
    CancelFarmingNavigation();
    ToolActionLockManager.Instance?.ForceUnlock();
}
// else: 动画执行中 → 只清空队列，不取消导航/不解锁
```

```csharp
// CancelFarmingNavigation 中：
if (_isExecutingFarming)
{
    _farmNavState = FarmNavState.Preview;
    _farmNavigationAction = null;
    return;  // 不清除 _isExecutingFarming，不 ForceUnlock
}
```

**三重保护已存在**。锐评的"执行指令"要求增加的保护，实际上是重复已有逻辑。

### 异议2：锐评建议恢复已废弃的机制

锐评建议"找回 `_needsNewPuddleVariant` 标志位"，但这个机制在续36中已被有意废弃。当前的随机逻辑是：
- 切换到水壶时随机一次（`_wateringModeInitialized`）
- 入队成功后随机下一次（`TryEnqueueFarmTool` 末尾）

锐评描述的"在 UpdateWateringPreview 中检测跨格子才随机"的代码结构，在当前代码中已不存在。

### 异议3：锐评提出的执行指令与实际代码结构不匹配

锐评的"完美执行指令"基于对代码的错误理解：
- 任务一要求在 `HandleMovement` 中增加"临界状态检测"，但实际问题不在 HandleMovement，而在 `WaitForNavigationComplete` 的 finally 块
- 任务二要求修改 `UpdateWateringPreview` 中的随机逻辑，但该方法中已无随机代码
- 任务三要求在 `ExecuteRemoveCrop` 中改为 `HideCropVisuals()`，但 `ExecuteRemoveCrop` 不是在"动画50%"触发的

---

## 五、独立分析

### 真正的 bug：WaitForNavigationComplete 的 finally 覆盖

这是锐评中唯一触及到的真实 bug，但锐评给出了错误的诊断和错误的修复方向。

**问题代码**（WaitForNavigationComplete 协程，到达分支）：
```csharp
_farmNavState = FarmNavState.Executing;
_isExecutingFarming = true;          // ← 设为 true
try
{
    onArrived?.Invoke();              // ← 调用 ExecuteFarmAction，内部也设 true
}
finally
{
    _isExecutingFarming = false;      // ← 覆盖回 false！
    _farmNavState = ...Preview/Idle;
    _farmNavigationAction = null;
    _farmingNavigationCoroutine = null;
}
```

`onArrived` 回调就是 `ExecuteFarmAction`，它在开头设置 `_isExecutingFarming = true`。但 `finally` 块在回调返回后立即执行，将其重置为 false。

**后果**：通过导航到达后执行的农田动作，在整个动画期间 `_isExecutingFarming` 都是 false。WASD 的三重保护全部失效。

**修复方向**：移除 `WaitForNavigationComplete` 中的 `_isExecutingFarming` 设置和 finally 块中的重置。让 `ExecuteFarmAction` 全权管理执行状态。协程只负责导航和调用回调。

### 浇水随机的真正问题

当前逻辑：入队成功 → 立刻 `SetPuddleVariant(Random.Range(...))`。

用户反馈的问题是：鼠标还没移开当前格子，ghost 预览就变了样式。

但这里有个微妙之处：入队成功后，该格子已被 `queuePreviewPositions` 拦截（`canWater = false`），ghost 显示的是红色无效状态。所以 variant 变化在视觉上可能并不明显（红色叠加下水渍样式差异不大）。

**需要用户确认**：这个问题在当前代码中是否仍然可复现？如果入队后 ghost 已经变红，variant 变化是否真的影响体验？

### 种子对齐问题

预览用 `correctCenter`（格子中心），实际种植用 `tilemaps.GetCellCenterWorld(cellPos)`（也是格子中心），然后 `AlignSpriteBottom` 将 sprite 底部对齐到 transform 位置（向上偏移 `spriteBounds.min.y`）。

预览的 `seedPreviewRenderer.transform.position = correctCenter` 没有做 AlignSpriteBottom 处理，所以预览和实际种植后的视觉位置确实会有偏差。

**但这不是"底盘错位"**——这是预览没有模拟 AlignSpriteBottom 的偏移。修复方向是在预览中也应用相同的偏移。

---

## 六、建议的执行方向

### 优先级排序

| 优先级 | 问题 | 修复方向 |
|--------|------|---------|
| 🔴 P0 | WaitForNavigationComplete finally 覆盖 _isExecutingFarming | 移除协程中的 _isExecutingFarming 管理，让 ExecuteFarmAction 全权负责 |
| 🟡 P1 | 浇水入队后 variant 立刻变化 | 需用户确认是否仍可复现（入队后 ghost 已变红） |
| 🟡 P2 | 种子预览未模拟 AlignSpriteBottom 偏移 | 在 seedPreviewRenderer 位置计算中加入偏移 |
| 🟢 P3 | 锄草先隐藏后删除 | 新增 HideCropVisuals + 延迟 RemoveCrop |

### 不建议执行的内容

- 锐评任务一（HandleMovement 增加临界状态检测）：问题不在 HandleMovement，保护机制已存在
- 锐评任务二（恢复 _needsNewPuddleVariant + 跨格子检测）：机制已废弃，代码结构已变
- 锐评任务三的具体实现方式：ExecuteRemoveCrop 不在动画50%触发，需要重新设计触发时机

---

## 七、给 Gemini 的信息补充

1. 补丁004V2 模块H 已实现 ClearActionQueue 的执行状态保护（`_isExecutingFarming` 检查），你的锐评完全忽略了这个保护机制
2. `_needsNewPuddleVariant` 已在续36中被废弃删除，当前浇水随机逻辑已重构为入队瞬间随机
3. `WaitForNavigationComplete` 的 finally 块覆盖 `_isExecutingFarming` 是真正的 bug，但修复方向不是在 HandleMovement 加保护，而是修复协程本身
4. RemoveCrop 的触发时机不是"动画50%"，而是 OnFarmActionAnimationComplete 的兜底逻辑
5. 种子系统已在模块R待办中计划剥离出农田队列，连点播种问题将随之解决
