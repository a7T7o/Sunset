

好的，我先全面回顾补丁004工作区的所有文档和代码，理解当前状态，然后深入分析你提出的所有bug。

让我先读取工作区的关键文档和代码。

现在读取补丁004的全面分析报告和最新的继承会话快照。

现在读取最新的快照和farming相关的steering规则，然后深入读取实际代码。

好，现在最关键的是读取当前实际代码，深入分析用户报告的所有bug。



好，我需要深入读取当前实际代码来理解补丁004修改后的真实状态，然后针对用户报告的所有bug进行彻查。

现在读取 GameInputManager.cs 中的关键方法。

好，我已经完整读取了代码。现在让我继续深入读取 WASD 中断逻辑和 `HandleMovement`、`Update` 中的动画进度监听，以及 `UpdatePreviews` 的调用链，彻底理解当前的数据流。

现在让我读取 `EnqueueAction` 方法和 `HandleUseCurrentTool` 来理解入队流程。

Now let me also check the `ClearActionQueue` and the WASD interrupt flow more carefully, and understand the `_isExecutingFarming` flag behavior:

好，现在我已经完整读取了所有关键代码。让我深入分析用户报告的每一个bug。

让我再看一下 `ClearActionQueue` 中 `_isExecutingFarming = false` 的设置，以及 WASD 中断时的完整行为链：

现在让我看 `FarmToolPreview.Hide()` 方法和 `HideFarmToolPreview` 的逻辑：

好了，我现在已经完整读取了所有关键代码。让我进行深度分析。

---

我理解你的所有诉求了。你说得对，我确实做得很不到位。让我逐一剖析当前代码中的问题根因。

**我对你提出的所有bug的理解与提炼：**

1. **1+8 ghost 差异化过滤仍然不完整** — 相隔一格和斜角的情况下，预览处理后仍然与已有耕地重复显示
2. **远处点击后按A取消走路，预览没有清理** — 说明取消导航时执行预览的清理路径有缺陷
3. **走到位置后动画进行中但未达到触发条件时按WASD，预览消失且不创建土地** — 说明"提取时机"不对，当前的 `PromoteToExecutingPreview` 在 `ProcessNextAction` 出队时就调用了，但 `ClearActionQueue` 把 `_isExecutingFarming = false` 了，导致执行预览的保护失效
4. **鼠标放在耕地上不显示任何预览也没有红色** — ghost 差异化过滤把所有 tile 都过滤掉了（因为已有耕地的位置全部 `kvp.Value == actualTile`），但应该至少显示红色/绿色状态反馈
5. **批量操作时预览"打架"** — 1+8 的队列预览之间互相覆盖

**深度根因分析：**

**Bug 1+4 的根因（最严重）**：`UpdateHoePreview` 中的差异化过滤逻辑有致命缺陷。当鼠标放在已有耕地上时，`canTill` 为 `false`（`CanTillAt` 返回 false，因为已经耕作了），所以整个 `if (canTill && ...)` 分支不进入，ghost 预览什么都不显示。但此时 `isValid = false`，应该显示红色反馈。当前代码在 `canTill` 为 false 时直接跳过了 ghost tilemap 的渲染，但 shader 叠加色仍然设置了 `overlayInvalidColor`——问题是 ghostTilemap 上没有任何 tile，叠加色无处可叠加，所以什么都看不到。

对于相邻一格的情况，差异化过滤的对比逻辑本身是对的（中心块对比 `farmlandCenterTilemap`，边界对比 `farmlandBorderTilemap`），但可能存在 tilemap 引用获取的问题——需要确认 `farmlandCenterTilemap` 和 `farmlandBorderTilemap` 是否正确对应了实际的耕地 tilemap。

**Bug 2+3 的根因**：`ClearActionQueue` 中 `_isExecutingFarming = false` + `_currentProcessingRequest = default`。当 WASD 中断时：
- `ClearActionQueue` 被调用 → `_isExecutingFarming = false`，`_currentProcessingRequest = default`
- `ClearAllQueuePreviews` 被调用 → 跳过 `executingTileGroups` 中的（这部分逻辑是对的）
- 但问题是：动画仍在播放中，`_pendingTileUpdate` 也被清空了（`_pendingTileUpdate = null`），所以动画达到触发进度时不会执行 `ExecuteTillSoil`
- 更严重的是：动画完成后 `OnFarmActionAnimationComplete` 被调用，但 `_currentProcessingRequest` 已经是 `default`，所以 `RemoveExecutingPreview(default.cellPos)` 用的是 `(0,0,0)`，找不到实际的执行预览位置，导致执行预览永远不会被清理

**Bug 5 的根因**：队列预览的 1+8 tile 之间没有做去重。当两个相邻位置入队时，它们的边界 tile 会重叠在同一个 tilemap 位置上，后入队的会覆盖先入队的。

**执行步骤（方案设计，等待你确认）：**

1. **修复 WASD 中断时的执行预览保护** — `ClearActionQueue` 不应该清空 `_pendingTileUpdate` 和 `_isExecutingFarming`（如果当前有正在执行的动画）。正确做法是：WASD 中断时只清空队列，不中断当前正在执行的动画。当前正在执行的操作应该完整走完（动画 → tile 创建 → 清除执行预览）。

2. **修复"提取时机"** — 你说的"动画开始的瞬间进行提取处理"是对的。当前 `PromoteToExecutingPreview` 在 `ProcessNextAction` 出队时调用，这个时机是对的（出队 = 开始执行 = 动画即将开始）。但问题出在 `ClearActionQueue` 把执行状态也清了。

3. **修复 ghost 预览在已有耕地上不显示** — 当 `canTill = false` 时，应该仍然显示光标/红色反馈，而不是什么都不显示。

4. **修复导航取消时的预览清理** — 远处点击后取消导航，需要正确清理执行预览。

5. **修复批量预览重叠** — 队列预览的 1+8 tile 需要考虑已有队列预览的位置。

这些问题涉及到 designV2 的架构缺陷，需要创建 designV3 来修正。你觉得这个分析方向对吗？还是你希望我直接进入修复？

好，直接干。先让我再确认几个关键代码细节，然后创建 designV3 + tasksV3 并一条龙执行。

关键发现：`CancelFarmingNavigation` 中也有 `_isExecutingFarming = false`。这意味着 WASD 中断时调用链是：`ClearActionQueue()`（设 `_isExecutingFarming = false`）+ `CancelFarmingNavigation()`（再次设 `_isExecutingFarming = false`）。

现在让我确认 `ToolActionLockManager` 的 `ForceUnlock` 是否会影响动画播放：

好，开始创建 designV3 和 tasksV3，然后一条龙执行。

先创建 designV3：