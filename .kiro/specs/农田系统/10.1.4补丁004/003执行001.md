哎呀，我的错我的错！差点忘了我的“宪法”和本职工作。我是拿着放大镜找 Bug 的架构锐评者和拿鞭子监工的鞭策者，而你 Kiro，才是那个在 IDE 里挥洒汗水、把逻辑转化成一行行 C# 艺术品的主刀医生！

既然角色归位，那我们就收起那些虚头巴脑的客套。这份审视报告已经把病灶剖析得明明白白了，现在的关键是**安全、精准、不留后遗症地落地**。

听好了 Kiro，这是我为你准备的**【003号手术执行命令】**。你在敲键盘的时候，把这份清单放在旁边，一项一项对照着砍！我不会给你写具体代码，因为那是你的专业领域，但我会死死盯着你的逻辑链路，绝对不允许出错！

---

# 🛠️ 003号手术执行命令：真空期缝合与随机重构

**致主刀医生 Kiro：**
本次手术涉及核心状态机与预览边界的底层逻辑。不要想当然，不要凭肌肉记忆，严格按照以下步骤斩断病根！

### 🔪 手术任务一：彻底缝合“执行态真空期”（最高优先级）

**病理回顾**：执行动画时的格子被 `queuePreviewPositions` 抛弃，又还没被 c层接纳，导致相邻格子刷新预览时把它当成了空气，引发连环判定崩溃。

**执行目标**：让 `GetPreviewTiles` 的判定条件重新“看见”执行中的格子。

**你的操作步骤与高危警告**：

1. **定位目标**：去 `FarmToolPreview.cs` 里，死死盯住 `UpdateHoePreview` 和 `AddQueuePreview`（仅限 `Till` 分支）这两个方法。
2. **构建联合集合**：在调用 `GetPreviewTiles` 之前，你必须手动构建一个新的 `HashSet<Vector3Int>`。
3. **塞入三股势力**：把 `queuePreviewPositions` 的数据、`executingTileGroups` 里的 Keys、以及 `executingWaterPositions` 里的数据，统统塞进这个新的 HashSet 里。
4. **替换传参**：把这个全新的、包含所有 b层和执行层数据的集合，作为参数喂给 `GetPreviewTiles`。

⚠️ **【监工 Kiro 的死亡警告】**：

* **绝对不准碰增量差集过滤的代码**！`queuePreviewTilemap.GetTile()` 那块逻辑没有任何问题，因为执行层的 tile 物理上还躺在那个 tilemap 上，你千万别画蛇添足去改那里的查询逻辑！
* 一定要确保 `executingTileGroups.Keys` 遍历提取完全，漏掉一个，真空期就依然存在！

---

### 🔪 手术任务二：浇水随机逻辑的“外科切除与重建”

**病理回顾**：由于依赖 `OnWaterExecuted` 去改变状态，导致远处的物理浇水动作，居然能跨越空间让鼠标底下的 Ghost 疯狂闪烁变异，逻辑耦合极其丑陋。

**执行目标**：让随机样式的决定权回归到“入队瞬间”，与执行动作彻底解绑。

**你的操作步骤与高危警告**：

1. **做加法（重建）**：去 `GameInputManager.cs` 的 `TryEnqueueFarmTool` 里。在 `EnqueueAction` 成功执行后的浇水分支里，立刻调用 `FarmVisualManager` 获取水坑总数，然后 `Random.Range` 选个随机数，直接通过 `farmPreview.SetPuddleVariant` 存起来。
2. **做减法（切除）**：去 `FarmToolPreview.cs`，找到 `UpdateWateringPreview` 方法，把里面所有基于 `_needsNewPuddleVariant` 触发随机的代码，**连根拔起，全部删掉**！
3. **大扫除（斩草除根）**：顺藤摸瓜，把 `OnWaterExecuted` 里面设置 `_needsNewPuddleVariant = true` 的代码删掉，最好顺便把 `_needsNewPuddleVariant` 和 `_lastWateringCellPos` 这两个已经没用的字段直接从类里抹除。

⚠️ **【监工 Kiro 的死亡警告】**：

* **手下留情**！在删减代码的时候，必须、绝对要保留 `_wateringModeInitialized` 相关的逻辑！那是玩家刚切出水壶时第一下随机的保证，你要是把那个也删了，水壶初次拿出来就不会随机了！

---

### 🗂️ 备忘录：关于“种子幽灵占位”的降级处理

* 虽然我之前言辞激烈，但你的审视是对的。`_queuedPositions.Remove` 是无条件执行的，并不会造成永久锁死这种毁灭性 Bug。
* **指令**：对于这个问题，**现在什么都不要做**！把它老老实实地放进“模块R（种子放置化）”的待办清单里，按原计划后续再杀。不要在这次修复里节外生枝！

---

Kiro，手术方案已经下达，逻辑陷阱也已经全部标红。现在，打开你的代码编辑器，开始执行！写完之后，立刻向我汇报你的落地情况，我会用最苛刻的眼光进行下一轮 Review！去吧，别让我失望！