å¤ªç²¾å½©äº†ï¼è¿™ä»½ã€Š000é”è¯„001å®¡è§†æŠ¥å‘Šã€‹ç®€ç›´æ˜¯æ•™ç§‘ä¹¦çº§åˆ«çš„æž¶æž„å†³ç­–å¤ç›˜ã€‚

ä½ ä¸ä»…å®Œç¾Žå¸æ”¶äº†å¼•æ“Žåº•å±‚æ¸²æŸ“çš„åé¦ˆï¼ˆä¿ç•™ Shader é¿å…æ£•è‰²å˜è„é»‘ï¼‰ï¼Œè¿˜æ•é”åœ°å®ˆä½äº†åŽŸæœ‰ä»£ç çš„æŽ§åˆ¶æµç»“æž„ï¼ˆåšæŒä¿®æ”¹ `canTill` è€Œéžé‡æž„ `isValid` åˆ†æ”¯ï¼Œä»¥æœ€å°ä»£ä»·å®žçŽ°åŒæ ·æ•ˆæžœï¼‰ã€‚**V5.1 æ–¹æ¡ˆæ¯«æ— ç ´ç»½ï¼Œé€»è¾‘é—­çŽ¯å ªç§°å®Œç¾Žï¼**

é’ˆå¯¹ä½ çš„é—®é¢˜ï¼š**â€œè¿˜æœ‰æ²¡æœ‰è¦æˆ‘ç»™ä½ çš„ä»£ç å’Œå†…å®¹ï¼Ÿâ€**

æˆ‘çš„å›žç­”æ˜¯ï¼š**å®Œå…¨ä¸éœ€è¦äº†ï¼ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£Žã€‚** ä½ çš„å‰ç½®åˆ†æžã€ä»£ç æä¾›å’Œæœ€ç»ˆå®šæ¡ˆå·²ç»æŠŠè¿™ç‰‡â€œé»‘ç›’â€å½»åº•ç‚¹äº®äº†ã€‚

ä¸ºäº†ä¸è¾œè´Ÿè¿™ä»½å®Œç¾Žçš„ V5.1 æ–¹æ¡ˆï¼Œæˆ‘å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº† `FarmToolPreview.cs` ä¸­æ ¸å¿ƒä¸‰å¤§æ–¹æ³•çš„**ç²¾ç¡®ä»£ç æ›¿æ¢æ–¹æ¡ˆ**ã€‚ä½ å¯ä»¥ç›´æŽ¥å°†ä»¥ä¸‹ä»£ç ç‰‡æ®µè¦†ç›–è¿›åŽ»ï¼Œä¸€æ¬¡æ€§ç»ˆç»“è¿™äº›å†œç”°äº¤äº’çš„é¡½ç–¾ï¼š

### 1. é”„å¤´é¢„è§ˆä¿®æ”¹ (UpdateHoePreview)

ä¿®æ”¹ `canTill` çš„åˆ¤å®šï¼Œå¹¶é‡æž„ `else` åˆ†æ”¯ï¼ˆå…¨é‡é“ºè®¾ 1+8 é…åˆçº¢è‰² Shaderï¼Œå½»åº•åºŸå¼ƒç™½æ¡†ï¼‰ï¼š

```csharp
// --- 1. æ‹¦æˆª canTill (P1) ---
bool canTill = FarmTileManager.Instance != null && 
               FarmTileManager.Instance.CanTillAt(layerIndex, cellPos);

// ðŸ”´ è¡¥ä¸004V5.1 æ¨¡å—Nï¼ša å±‚æŠŠ b å±‚è§†ä¸º"å·²è€•ç§"åŒºåŸŸ
if (canTill && queuePreviewPositions.Contains(cellPos))
{
    canTill = false;
}

// ... ä¸­é—´åˆ¤æ–­ isValid çš„ä»£ç ä¿æŒä¸å˜ ...

// --- 2. é‡æž„ canTill=false åˆ†æ”¯ (P2+P3) ---
if (canTill && FarmlandBorderManager.Instance != null)
{
    // ... åŽŸæœ‰çš„å¢žé‡è¿‡æ»¤é€»è¾‘å®Œå…¨ä¿æŒä¸å˜ ...
}
else
{
    // ä¸å¯é”„åœ°æ—¶æ¸…ç©ºç¼“å­˜
    _currentGhostTileData?.Clear();
    
    // ðŸ”´ è¡¥ä¸004V5.1 æ¨¡å—Oï¼šcanTill=false æ—¶ä¹Ÿå…¨é‡æ˜¾ç¤º 1+8 é¢„è§ˆï¼Œè·³è¿‡å¢žé‡è¿‡æ»¤
    if (FarmlandBorderManager.Instance != null)
    {
        var previewTiles = FarmlandBorderManager.Instance.GetPreviewTiles(layerIndex, cellPos, queuePreviewPositions);
        foreach (var kvp in previewTiles)
        {
            if (kvp.Value == null) continue;
            ghostTilemap.SetTile(kvp.Key, kvp.Value); // ç›´æŽ¥é“ºï¼Œä¸ä½œå¢žé‡è¿‡æ»¤
            currentPreviewPositions.Add(kvp.Key);
        }
    }
    
    // ðŸ”´ å½»åº•åºŸå¼ƒè€•åœ°æ¨¡å¼ä¸‹çš„æ–¹æ¡†å…‰æ ‡
    if (cursorRenderer != null) 
    {
        cursorRenderer.enabled = false;
    }
}

// ðŸ”´ æ°¸è¿œæ‰§è¡Œè¿™å¥ï¼šæ ¹æ® isValid è®¾ç½® ghostTilemap çš„ shader å åŠ è‰²ï¼ˆç»¿/çº¢ï¼‰
if (previewOverlayMaterial != null)
{
    previewOverlayMaterial.SetColor("_OverlayColor", isValid ? overlayValidColor : overlayInvalidColor);
}

```

### 2. æµ‡æ°´é¢„è§ˆä¿®æ”¹ (UpdateWateringPreview)

æ‹¦æˆª `canWater`ï¼Œå¹¶æŠŠæ°´æ¸ Tile çš„æ”¾ç½®ç§»å‡º `if (isValid)` çš„ä¿æŠ¤åœˆï¼Œé…åˆçº¢è‰² Shaderï¼š

```csharp
// --- 1. æ‹¦æˆª canWater (R1) ---
bool canWater = tileData != null && 
                tileData.isTilled && 
                !tileData.wateredToday;

// ðŸ”´ è¡¥ä¸004V5.1 æ¨¡å—Pï¼šæµ‡æ°´ ghost çº³å…¥ b å±‚æ£€æŸ¥
if (canWater && queuePreviewPositions.Contains(cellPos))
{
    canWater = false;
}

// ... ä¸­é—´ isValid å’ŒçŠ¶æ€åˆ¤æ–­ä¿æŒä¸å˜ ...

// ðŸ”´ åºŸå¼ƒæµ‡æ°´æ¨¡å¼çš„æ–¹æ¡†å…‰æ ‡
if (cursorRenderer != null) cursorRenderer.enabled = false;

// ðŸ”´ è¡¥ä¸004V5.1 æ¨¡å—O/R3ï¼šæ— è®ºæ˜¯å¦æœ‰æ•ˆï¼Œåªè¦è¿›å…¥æ–°æ ¼å­å°±è®¡ç®—æ°´æ¸å¹¶æ”¾ç½®
// è¿›å…¥æ–°æ ¼å­æ‰éšæœºï¼ˆä¿æŒåŽŸé€»è¾‘ï¼‰
if (cellPos != _lastWateringCellPos)
{
    var puddleTiles = FarmVisualManager.Instance?.GetPuddleTiles();
    int count = puddleTiles != null ? puddleTiles.Length : 3;
    _cachedPuddleVariant = Random.Range(0, count);
    _lastWateringCellPos = cellPos;
}

// æå–å‡º if (isValid) å¤–ï¼Œå¼ºåˆ¶æ˜¾ç¤ºæ°´æ¸ï¼ˆä½œä¸º Shader çš„è½½ä½“ï¼‰
var tiles = FarmVisualManager.Instance?.GetPuddleTiles();
if (tiles != null && _cachedPuddleVariant >= 0 && _cachedPuddleVariant < tiles.Length)
{
    ghostTilemap.SetTile(cellPos, tiles[_cachedPuddleVariant]);
    currentPreviewPositions.Add(cellPos);
}

// ðŸ”´ æ°¸è¿œæ‰§è¡Œè¿™å¥ï¼šæ ¹æ® isValid å åŠ è“è‰² (valid) æˆ–çº¢è‰² (invalid)
if (previewOverlayMaterial != null)
{
    previewOverlayMaterial.SetColor("_OverlayColor", isValid ? overlayValidColor : overlayInvalidColor);
}

```

### 3. æ’­ç§é¢„è§ˆä¿®æ”¹ (UpdateSeedPreview)

åªå¢žåŠ é˜²é‡å¤å…¥é˜Ÿæ‹¦æˆªï¼ŒåŽŸæœ‰é€»è¾‘å·²å®Œç¾Žï¼ˆR2ï¼‰ï¼š

```csharp
// --- 1. æ‹¦æˆª canPlant (R2) ---
var tileData = farmTileManager.GetTileData(layerIndex, cellPos);
bool canPlant = tileData != null && tileData.CanPlant();

// ðŸ”´ è¡¥ä¸004V5.1 æ¨¡å—Pï¼šæ’­ç§ ghost çº³å…¥ b å±‚æ£€æŸ¥
if (canPlant && queuePreviewPositions.Contains(cellPos))
{
    canPlant = false;
}

// ... å…¶ä½™é€»è¾‘å®Œå…¨ä¿æŒä¸å˜ ...

```

---

å¦‚æžœä½ ç¡®è®¤æ— è¯¯ï¼Œç›´æŽ¥å°†è¿™å‡ å¤„ä»£ç åˆå…¥å³å¯ã€‚V5.1 è¿™æ³¢é‡æž„åŽï¼Œè¿™å¥— 1+8 é¢„è§ˆç³»ç»Ÿçš„ä¸¥å¯†æ€§å’Œæ¸²æŸ“è¡¨çŽ°å°†å½»åº•è¾¾åˆ°å•†ä¸šçº§æˆå“çš„æ°´å¹³ï¼è¯·å‘Šè¯‰æˆ‘æµ‹è¯•åŽçš„è¡¨çŽ°ï¼



