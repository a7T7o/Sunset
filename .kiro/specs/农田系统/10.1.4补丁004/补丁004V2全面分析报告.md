# è¡¥ä¸004V2 å…¨é¢åˆ†ææŠ¥å‘Š

> åˆ›å»ºæ—¶é—´ï¼š2026-02-21
> å·¥ä½œåŒºï¼š10.1.4è¡¥ä¸004
> å‰ç½®æ–‡æ¡£ï¼š`èŠå¤©è®°å½•003_prompt.md`ï¼ˆç”¨æˆ·å®Œæ•´éœ€æ±‚ï¼‰ã€`èŠå¤©è®°å½•002.md`ï¼ˆå››ç‚¹çº æ­£ä»£ç éªŒè¯ï¼‰ã€`å†œç”°ä¸‰å±‚æ˜¾ç¤ºäº¤äº’çŸ©é˜µV2.md`ï¼ˆå¢é‡è®¡ç®—é”™è¯¯åˆ†æï¼‰
> æœ¬æŠ¥å‘Šæ•´åˆæ‰€æœ‰å†å²éœ€æ±‚ï¼Œå½¢æˆè¡¥ä¸004V2çš„å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

---

## ä¸€ã€å†å²éœ€æ±‚å›æº¯ä¸é—®é¢˜å…¨æ™¯

### 1.1 é—®é¢˜æ¥æº

è¡¥ä¸004 V1ï¼ˆdesign.md æ¨¡å— A-Gï¼‰å·²å®Œæˆä»£ç ä¿®æ”¹å¹¶é€šè¿‡ç¼–è¯‘ï¼Œä½†ç”¨æˆ·éªŒæ”¶å‘ç°å¤šä¸ªä¸¥é‡ bugã€‚ç”¨æˆ·åœ¨èŠå¤©è®°å½•003_prompt ä¸­ç»™å‡ºå››ç‚¹çº æ­£ï¼Œåç»­å¯¹è¯ä¸­è¿›ä¸€æ­¥æ˜ç¡®äº†"tile å¯æ‹†åˆ†"çš„æ ¸å¿ƒè®¤çŸ¥ä¿®æ­£ã€‚

### 1.2 å…­å¤§é—®é¢˜æ¸…å•

| ç¼–å· | é—®é¢˜ | æ¥æº | ä¸¥é‡ç¨‹åº¦ |
|------|------|------|---------|
| P1 | ClearActionQueue æ¸…ç©ºæ‰§è¡ŒçŠ¶æ€ â†’ åŠ¨ç”»æ’­å®Œä¸åˆ›å»ºè€•åœ° + æ‰§è¡Œé¢„è§ˆæ®‹ç•™ | çº æ­£1 | ğŸ”´ ä¸¥é‡ |
| P2 | PromoteToExecutingPreview æ—¶æœºè¿‡æ—©ï¼ˆå‡ºé˜Ÿæ—¶è€ŒéåŠ¨ç”»å¼€å§‹æ—¶ï¼‰ | çº æ­£4 | ğŸ”´ ä¸¥é‡ |
| P3 | Ghost é¢„è§ˆæ˜¾ç¤ºæœ€ç»ˆ tile è€Œéå¢é‡ tileï¼ˆå·²å­˜åœ¨éƒ¨åˆ†è¢«å¤šä½™æŸ“ç»¿ï¼‰ | çº æ­£3 + tile å¯æ‹†åˆ†ä¿®æ­£ | ğŸ”´ ä¸¥é‡ |
| P4 | canTill=false æ—¶æ— ä»»ä½•è§†è§‰åé¦ˆï¼ˆé¼ æ ‡åœ¨å·²æœ‰è€•åœ°ä¸Šä»€ä¹ˆéƒ½ä¸æ˜¾ç¤ºï¼‰ | èŠå¤©è®°å½•003_prompt | ğŸŸ¡ ä¸­ç­‰ |
| P5 | æ‰¹é‡æ“ä½œæ—¶é˜Ÿåˆ—é¢„è§ˆä¹‹é—´ tile äº’ç›¸è¦†ç›– | èŠå¤©è®°å½•003_prompt | ğŸŸ¡ å·²çŸ¥é™åˆ¶ |
| P6 | Sorting Order éœ€ç¡®è®¤ï¼ˆghost å±‚å¿…é¡»è¦†ç›–å®é™…å±‚ï¼‰ | designV3 æ¨¡å— K | ğŸŸ¢ éªŒè¯æ€§ |

---

## äºŒã€P1ï¼šClearActionQueue æ‰§è¡ŒçŠ¶æ€ä¿æŠ¤

### 2.1 æ ¹å› é“¾ï¼ˆä»£ç äº‹å®éªŒè¯ï¼‰

å½“å‰ `ClearActionQueue`ï¼ˆGameInputManager.cs ç¬¬2531è¡Œï¼‰ï¼š

```csharp
public void ClearActionQueue()
{
    _farmActionQueue.Clear();
    _queuedPositions.Clear();
    _isProcessingQueue = false;
    _isExecutingFarming = false;          // â† åŠ¨ç”»è¿˜åœ¨æ’­æ”¾
    _currentHarvestTarget = null;
    _currentProcessingRequest = default;   // â† åŠ¨ç”»å®Œæˆåæ‰¾ä¸åˆ°ä½ç½®
    _pendingTileUpdate = null;             // â† tile åˆ›å»ºä¸è§¦å‘
    _tileUpdateTriggered = false;
    FarmToolPreview.Instance?.ClearAllQueuePreviews();
}
```

WASD ä¸­æ–­æ—¶çš„å®Œæ•´æ•…éšœé“¾ï¼š
1. WASD â†’ `HandleMovement` â†’ `ClearActionQueue()`
2. `_pendingTileUpdate = null` â†’ Update ä¸­ `_pendingTileUpdate != null` æ¡ä»¶ä¸æ»¡è¶³ â†’ tile åˆ›å»ºæ°¸è¿œä¸è§¦å‘
3. `_currentProcessingRequest = default` â†’ `OnFarmActionAnimationComplete` ä¸­ `RemoveExecutingPreview(default.cellPos)` å³ `RemoveExecutingPreview((0,0,0))` â†’ æ‰¾ä¸åˆ°å®é™…ä½ç½® â†’ æ‰§è¡Œé¢„è§ˆæ°¸è¿œæ®‹ç•™
4. `_isExecutingFarming = false` â†’ æ¨¡å— H çš„ä¿æŠ¤æ¡ä»¶å¤±æ•ˆ

### 2.2 ä¿®å¤æ–¹æ¡ˆ

åœ¨ `ClearActionQueue` ä¸­æ£€æŸ¥ `_isExecutingFarming`ï¼šåŠ¨ç”»æ‰§è¡Œä¸­æ—¶ä¿ç•™æ‰§è¡Œç›¸å…³çŠ¶æ€ã€‚

```
å¦‚æœ _isExecutingFarming == trueï¼š
  - åªæ¸…ç©ºé˜Ÿåˆ—ï¼ˆ_farmActionQueueã€_queuedPositionsï¼‰
  - åªæ¸…ç©ºé˜Ÿåˆ—é¢„è§ˆï¼ˆClearAllQueuePreviewsï¼‰
  - ä¿ç•™ï¼š_pendingTileUpdateã€_currentProcessingRequestã€_isExecutingFarmingã€_tileUpdateTriggered
  
å¦‚æœ _isExecutingFarming == falseï¼š
  - å…¨éƒ¨æ¸…ç©ºï¼ˆä¿æŒåŸæœ‰è¡Œä¸ºï¼‰
```

### 2.3 æ­£ç¡®æ€§å±æ€§

| ç¼–å· | å±æ€§ |
|------|------|
| CP-H1 | WASD ä¸­æ–­æ—¶ï¼Œæ­£åœ¨æ‰§è¡Œçš„åŠ¨ç”»æ“ä½œä¸å—å½±å“ï¼ˆ`_isExecutingFarming` ä¸º true æ—¶ä¿ç•™æ‰§è¡ŒçŠ¶æ€ï¼‰ |
| CP-H2 | åŠ¨ç”»æ’­å®Œå tile æ­£å¸¸åˆ›å»ºï¼ˆ`_pendingTileUpdate` æœªè¢«æ¸…ç©ºï¼‰ |
| CP-H3 | åŠ¨ç”»å®Œæˆåæ‰§è¡Œé¢„è§ˆæ­£å¸¸æ¸…é™¤ï¼ˆ`_currentProcessingRequest` æœªè¢«æ¸…ç©ºï¼Œ`RemoveExecutingPreview` ç”¨æ­£ç¡®çš„ cellPosï¼‰ |
| CP-H4 | é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ“ä½œä»è¢«æ­£å¸¸æ¸…ç©ºï¼ˆ`_farmActionQueue.Clear()` å’Œ `ClearAllQueuePreviews()` æ­£å¸¸æ‰§è¡Œï¼‰ |


---

## ä¸‰ã€P2ï¼šPromoteToExecutingPreview æ—¶æœºä¿®æ­£

### 3.1 æ ¹å› åˆ†æï¼ˆä»£ç äº‹å®éªŒè¯ï¼‰

å½“å‰ `ProcessNextAction`ï¼ˆGameInputManager.cs ç¬¬2319è¡Œï¼‰ä¸­ï¼š

```csharp
_isExecutingFarming = true;
FarmToolPreview.Instance?.PromoteToExecutingPreview(request.cellPos);

if (distance <= farmToolReach)
{
    ExecuteFarmAction(request);  // è¿‘è·ç¦»ç›´æ¥æ‰§è¡Œ
}
else
{
    StartFarmingNavigation(request.worldPos, () => {
        ExecuteFarmAction(request);  // è¿œè·ç¦»å¯¼èˆªåæ‰§è¡Œ
    });
}
```

é—®é¢˜ï¼šè¿œè·ç¦»æ“ä½œæ—¶ï¼Œå‡ºé˜Ÿåè¿˜åœ¨å¯¼èˆªä¸­ï¼Œé¢„è§ˆå·²è¢«æå‡ä¸ºæ‰§è¡Œé¢„è§ˆã€‚å¯¼èˆªé€”ä¸­ WASD æ‰“æ–­æ—¶ï¼š
- æ‰§è¡Œé¢„è§ˆè¢«ä¿æŠ¤ï¼ˆ`ClearAllQueuePreviews` è·³è¿‡æ‰§è¡Œé¢„è§ˆï¼‰
- ä½†æ“ä½œä¸ä¼šæ‰§è¡Œï¼ˆå¯¼èˆªå·²å–æ¶ˆï¼‰
- ç»“æœï¼šæ‰§è¡Œé¢„è§ˆæ°¸è¿œæ®‹ç•™

ç”¨æˆ·æ ¸å¿ƒè§‚ç‚¹ï¼š**æ‰§è¡Œ = åŠ¨ç”»å¼€å§‹çš„ç¬é—´ï¼Œå¯¼èˆªé€”ä¸­åªæ˜¯å‰ç½®è¡Œä¸º**ã€‚å‰ç½®è¡Œä¸ºè¢«æ‰“æ–­ï¼Œæ“ä½œåº”éšé˜Ÿåˆ—ä¸€èµ·æ¸…ç©ºã€‚

### 3.2 ä¿®å¤æ–¹æ¡ˆ

å°† `_isExecutingFarming = true` å’Œ `PromoteToExecutingPreview` ä» `ProcessNextAction` ç§»åˆ° `ExecuteFarmAction` å¼€å¤´ã€‚

ProcessNextAction ä¸­åˆ é™¤ï¼š
```
_isExecutingFarming = true;
FarmToolPreview.Instance?.PromoteToExecutingPreview(request.cellPos);
```

ExecuteFarmAction å¼€å¤´æ–°å¢ï¼š
```
_isExecutingFarming = true;
FarmToolPreview.Instance?.PromoteToExecutingPreview(request.cellPos);
```

### 3.3 æ—¶åºå¯¹æ¯”

| åœºæ™¯ | V1 è¡Œä¸º | V2 è¡Œä¸º |
|------|---------|---------|
| è¿‘è·ç¦»æ‰§è¡Œ | å‡ºé˜Ÿâ†’Promoteâ†’æ‰§è¡Œâ†’å®Œæˆ | å‡ºé˜Ÿâ†’æ‰§è¡Œ(Promote)â†’å®Œæˆ âœ… |
| è¿œè·ç¦»æ‰§è¡Œ | å‡ºé˜Ÿâ†’Promoteâ†’å¯¼èˆªâ†’æ‰§è¡Œâ†’å®Œæˆ | å‡ºé˜Ÿâ†’å¯¼èˆªâ†’æ‰§è¡Œ(Promote)â†’å®Œæˆ âœ… |
| å¯¼èˆªä¸­ WASD | å‡ºé˜Ÿâ†’Promoteâ†’å¯¼èˆªâ†’WASDâ†’æ‰§è¡Œé¢„è§ˆæ®‹ç•™ âŒ | å‡ºé˜Ÿâ†’å¯¼èˆªâ†’WASDâ†’é˜Ÿåˆ—é¢„è§ˆæ¸…ç©º âœ… |
| åŠ¨ç”»ä¸­ WASD | å‡ºé˜Ÿâ†’Promoteâ†’æ‰§è¡Œâ†’WASDâ†’tileä¸åˆ›å»º+é¢„è§ˆæ®‹ç•™ âŒ | å‡ºé˜Ÿâ†’æ‰§è¡Œ(Promote)â†’WASDâ†’tileæ­£å¸¸åˆ›å»º+é¢„è§ˆæ­£å¸¸æ¸…é™¤ âœ… |

### 3.4 P1+P2 è”åŠ¨æ•ˆæœ

P2 ä¿®æ­£åï¼Œ`_isExecutingFarming` åªåœ¨ `ExecuteFarmAction` ä¸­è®¾ä¸º trueã€‚è¿™æ„å‘³ç€ï¼š
- å¯¼èˆªé€”ä¸­ WASD â†’ `ClearActionQueue` â†’ `_isExecutingFarming == false` â†’ å…¨éƒ¨æ¸…ç©ºï¼ˆæ­£ç¡®ï¼Œå› ä¸ºæ²¡æœ‰åŠ¨ç”»åœ¨æ‰§è¡Œï¼‰
- åŠ¨ç”»æ‰§è¡Œä¸­ WASD â†’ `ClearActionQueue` â†’ `_isExecutingFarming == true` â†’ P1 ä¿æŠ¤ç”Ÿæ•ˆï¼Œä¿ç•™æ‰§è¡ŒçŠ¶æ€

ä¸¤ä¸ªä¿®å¤äº’ç›¸é…åˆï¼Œè¦†ç›–äº†æ‰€æœ‰ä¸­æ–­åœºæ™¯ã€‚

### 3.5 PlantSeed åˆ†æ”¯ç‰¹æ®Šå¤„ç†

PlantSeed æ— åŠ¨ç”»ï¼Œåœ¨ `ExecuteFarmAction` ä¸­ç›´æ¥æ‰§è¡Œã€‚æ—¶åºï¼š
```
ExecuteFarmAction å¼€å¤´ â†’ _isExecutingFarming = true â†’ PromoteToExecutingPreview
â†’ PlantSeed åˆ†æ”¯ â†’ ExecutePlantSeed â†’ RemoveExecutingPreview â†’ _isExecutingFarming = false
â†’ ProcessNextAction
```
æ•´ä¸ªè¿‡ç¨‹åœ¨åŒä¸€å¸§å†…å®Œæˆï¼Œä¸å­˜åœ¨ WASD ä¸­æ–­çª—å£ï¼Œè¡Œä¸ºæ­£ç¡®ã€‚

### 3.6 æ­£ç¡®æ€§å±æ€§

| ç¼–å· | å±æ€§ |
|------|------|
| CP-I1 | æ‰§è¡Œé¢„è§ˆåªåœ¨åŠ¨ç”»çœŸæ­£å¼€å§‹æ—¶æ‰è¢«ä¿æŠ¤ï¼ˆ`PromoteToExecutingPreview` åœ¨ `ExecuteFarmAction` ä¸­è°ƒç”¨ï¼‰ |
| CP-I2 | å¯¼èˆªé€”ä¸­è¢«æ‰“æ–­çš„æ“ä½œéšé˜Ÿåˆ—ä¸€èµ·æ¸…ç©ºï¼ˆæ“ä½œè¿˜åœ¨é˜Ÿåˆ—é¢„è§ˆä¸­ï¼‰ |
| CP-I3 | `_isExecutingFarming` åªåœ¨åŠ¨ç”»å¼€å§‹æ—¶è®¾ä¸º true |
| CP-I4 | è¿‘è·ç¦»æ“ä½œè¡Œä¸ºä¸å˜ï¼ˆ`ProcessNextAction` ç›´æ¥è°ƒç”¨ `ExecuteFarmAction`ï¼Œæ—¶åºä¸€è‡´ï¼‰ |

---

## å››ã€P3ï¼šGhost é¢„è§ˆå¢é‡å·®é›†è®¡ç®—ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰

### 4.1 é—®é¢˜æœ¬è´¨

å½“å‰å·®å¼‚åŒ–è¿‡æ»¤ï¼ˆFarmToolPreview.cs UpdateHoePreview ç¬¬487-501è¡Œï¼‰ï¼š

```csharp
if (kvp.Value == actualTile) continue;  // ç›¸åŒåˆ™è·³è¿‡
ghostTilemap.SetTile(kvp.Key, kvp.Value);  // ä¸åŒåˆ™æ˜¾ç¤ºé¢„è§ˆtileï¼ˆæœ€ç»ˆçŠ¶æ€ï¼‰
```

è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯"æœ€ç»ˆçŠ¶æ€ tile"è€Œé"å¢é‡ tile"ã€‚å½“å®é™…å±‚å·²æœ‰è¾¹ç•Œ tile æ—¶ï¼Œghost å±‚ä¼šæŠŠå·²å­˜åœ¨çš„æ–¹å‘ä¹ŸæŸ“ç»¿ã€‚

### 4.2 æ ¸å¿ƒè®¤çŸ¥ä¿®æ­£ï¼štile å¯æ‹†åˆ†

é¡¹ç›®ä¸­æœ‰å®Œæ•´çš„ 16 ç§è¾¹ç•Œ tile + 4 ç§é˜´å½± tileï¼Œæ¯ä¸ªæ–¹å‘ç»„åˆéƒ½æœ‰ç‹¬ç«‹ Sprite èµ„æºï¼š
- å•æ–¹å‘ï¼š`B_U`, `B_D`, `B_L`, `B_R`
- åŒæ–¹å‘ï¼ˆå¯¹è¾¹ï¼‰ï¼š`B_UD`, `B_LR`
- åŒæ–¹å‘ï¼ˆç›¸é‚»ï¼‰ï¼š`B_UL`, `B_UR`, `B_DL`, `B_DR`
- ä¸‰æ–¹å‘ï¼š`B_UDL`, `B_UDR`, `B_ULR`, `B_DLR`
- å››æ–¹å‘ï¼š`B_UDLR`
- é˜´å½±ï¼š`S_LU`, `S_RU`, `S_LD`, `S_RD`

`B_LR` = `B_L` + `B_R` çš„åˆæˆï¼Œå¯ä»¥æ‹†å¼€ã€‚é¢„è§ˆå±‚å®Œå…¨å¯ä»¥åªæ˜¾ç¤ºå¢é‡æ–¹å‘çš„ tileã€‚

### 4.3 ç”¨æˆ·æ ¸å¿ƒåŸåˆ™

**é¢„è§ˆ + å®é™… = æœ€ç»ˆæ•ˆæœ**ã€‚é¢„è§ˆåªæ˜¾ç¤ºå¢é‡ï¼Œä¸ä¸å®é™…å±‚å†…å®¹é‡å ã€‚

### 4.4 å·²è¯†åˆ«çš„å¢é‡è®¡ç®—é”™è¯¯ï¼ˆæ¥è‡ªäº¤äº’çŸ©é˜µV2ï¼‰

| åœºæ™¯ | é”™è¯¯ä½ç½® | å®é™… tile | é¢„è§ˆæœ€ç»ˆ tile | å½“å‰ ghostï¼ˆé”™è¯¯ï¼‰ | æ­£ç¡® ghost | å¢é‡å·®é›† |
|------|---------|----------|-------------|-----------|-----------|---------|
| åœºæ™¯2ï¼ˆæ°´å¹³ç›´æ¥ç›¸é‚»ï¼‰ | (-1,-1) | `B_U` | `B_UR` | `B_UR` | `B_R` | `{U,R}-{U}={R}` |
| åœºæ™¯3ï¼ˆæ°´å¹³éš”ä¸€æ ¼ï¼‰ | M=(0,0) | `B_L` | `B_LR` | `B_LR` | `B_R` | `{L,R}-{L}={R}` |
| åœºæ™¯4ï¼ˆæ–œè§’ç›´æ¥ç›¸é‚»ï¼‰ | (-1,0) | `B_D` | `B_DR` | `B_DR` | `B_R` | `{D,R}-{D}={R}` |
| åœºæ™¯4ï¼ˆæ–œè§’ç›´æ¥ç›¸é‚»ï¼‰ | (0,-1) | `B_L` | `B_UL` | `B_UL` | `B_U` | `{U,L}-{L}={U}` |

æ‰€æœ‰é”™è¯¯éƒ½æ˜¯åŒä¸€æ¨¡å¼ï¼šå®é™…å±‚æœ‰ `B_X`ï¼Œé¢„è§ˆæœ€ç»ˆæ˜¯ `B_XY`ï¼Œå½“å‰æ˜¾ç¤º `B_XY`ï¼ˆX æ–¹å‘è¢«å¤šä½™æŸ“ç»¿ï¼‰ï¼Œåº”è¯¥åªæ˜¾ç¤º `B_Y`ã€‚


### 4.5 ä¿®å¤æ–¹æ¡ˆï¼šå¢é‡å·®é›†è®¡ç®—

åœ¨ `UpdateHoePreview` çš„å·®å¼‚åŒ–è¿‡æ»¤å¾ªç¯ä¸­ï¼Œå½“é¢„è§ˆ tile â‰  å®é™… tile ä¸”ä¸¤è€…éƒ½æ˜¯è¾¹ç•Œ tile æ—¶ï¼Œä¸ç›´æ¥æ˜¾ç¤ºé¢„è§ˆ tileï¼Œè€Œæ˜¯è®¡ç®—æ–¹å‘å·®é›†ï¼Œæ˜¾ç¤ºå¢é‡ tileã€‚

#### 4.5.1 æ–°å¢æ–¹æ³•ï¼šParseDirections

åœ¨ `FarmlandBorderManager` ä¸­æ–°å¢æ–¹æ³•ï¼Œå°† tile å¼•ç”¨è§£æä¸ºæ–¹å‘é›†åˆï¼š

```
ParseDirections(TileBase tile) â†’ (hasU, hasD, hasL, hasR)

ä¾‹ï¼š
  borderL    â†’ (false, false, true, false)
  borderLR   â†’ (false, false, true, true)
  borderUR   â†’ (true, false, false, true)
  borderUDLR â†’ (true, true, true, true)
```

å®ç°æ–¹å¼ï¼šé€ä¸€æ¯”è¾ƒ tile å¼•ç”¨ä¸ 16 ä¸ªè¾¹ç•Œ tile å­—æ®µï¼ˆ`borderU`ã€`borderD`...`borderUDLR`ï¼‰ï¼ŒåŒ¹é…åè¿”å›å¯¹åº”æ–¹å‘ç»„åˆã€‚

#### 4.5.2 æ–°å¢æ–¹æ³•ï¼šIsBorderTile / IsShadowTile

åˆ¤æ–­ä¸€ä¸ª tile æ˜¯å¦å±äºè¾¹ç•Œ tile æˆ–é˜´å½± tileï¼Œç”¨äºåˆ†æ”¯åˆ¤æ–­ã€‚

#### 4.5.3 SelectBorderTile å…¬å¼€è®¿é—®

å½“å‰ `SelectBorderTile` æ˜¯ `private` æ–¹æ³•ã€‚å¢é‡è®¡ç®—éœ€è¦ä»å·®é›†æ–¹å‘ç”Ÿæˆå¢é‡ tileï¼Œéœ€è¦å°†å…¶æ”¹ä¸º `public`ï¼ˆæˆ–æä¾›å…¬å¼€åŒ…è£…æ–¹æ³•ï¼‰ã€‚

#### 4.5.4 å·®å¼‚åŒ–è¿‡æ»¤æ”¹é€ ä¼ªä»£ç 

```
foreach (kvp in previewTiles):
    if kvp.Value == null: continue
    
    actualTile = GetActualTile(kvp.Key)  // ä¸­å¿ƒå—ç”¨ centerTilemapï¼Œå…¶ä»–ç”¨ borderTilemap
    if kvp.Value == actualTile: continue  // æ— å·®å¼‚ï¼Œè·³è¿‡
    
    if actualTile == null:
        // å…¨æ–°ä½ç½®ï¼Œç›´æ¥æ˜¾ç¤ºé¢„è§ˆ tile
        ghost.SetTile(kvp.Key, kvp.Value)
    elif IsShadowTile(actualTile):
        // é˜´å½±â†’è¾¹ç•Œ/é˜´å½±ï¼Œå®Œå…¨æ›¿æ¢ï¼ˆéœ€è¦ Sorting Order è¦†ç›–ï¼‰
        ghost.SetTile(kvp.Key, kvp.Value)
    elif IsBorderTile(actualTile) && IsBorderTile(kvp.Value):
        // è¾¹ç•Œâ†’è¾¹ç•Œï¼Œè®¡ç®—å¢é‡
        actualDirs = ParseDirections(actualTile)
        previewDirs = ParseDirections(kvp.Value)
        deltaDirs = previewDirs AND NOT actualDirs  // é€æ–¹å‘å¸ƒå°”è¿ç®—
        deltaTile = SelectBorderTile(deltaDirs)
        if deltaTile != null:
            ghost.SetTile(kvp.Key, deltaTile)
        // deltaTile == null è¯´æ˜å¢é‡ä¸ºç©ºï¼ˆä¸åº”å‘ç”Ÿï¼Œå‰é¢å·² == åˆ¤æ–­è¿‡ï¼‰
    else:
        // å…¶ä»–æƒ…å†µï¼ˆä¸­å¿ƒå—æ›¿æ¢ç­‰ï¼‰ï¼Œç›´æ¥è¦†ç›–
        ghost.SetTile(kvp.Key, kvp.Value)
```

#### 4.5.5 ä¸å—å½±å“çš„æƒ…å†µ

| æƒ…å†µ | åŸå›  |
|------|------|
| å®é™…å±‚ä¸ºç©ºï¼ˆ`âˆ…`ï¼‰ | å…¨æ–° tileï¼Œæ— éœ€å¢é‡è®¡ç®—ï¼Œç›´æ¥æ˜¾ç¤º |
| é¢„è§ˆ tile = å®é™… tile | å·²è¢« `== actualTile` è·³è¿‡ |
| é˜´å½± tile æ›¿æ¢ | é˜´å½±ä¸å­˜åœ¨æ–¹å‘ç»„åˆæ‹†åˆ†ï¼Œæ˜¯å®Œå…¨æ›¿æ¢ï¼Œéœ€è¦ Sorting Order è¦†ç›– |
| ä¸­å¿ƒå—æ›¿æ¢ï¼ˆP ä½ç½®ï¼‰ | ä»è¾¹ç•Œ/é˜´å½±å˜æˆä¸­å¿ƒå—ï¼Œæ˜¯å®Œå…¨æ›¿æ¢ |
| é¢„è§ˆ tile ä¸º null | å·²è¢« `== null continue` è·³è¿‡ |

### 4.6 æ­£ç¡®æ€§å±æ€§

| ç¼–å· | å±æ€§ |
|------|------|
| CP-L1 | å®é™…å±‚ä¸ºç©ºæ—¶ï¼Œghost æ˜¾ç¤ºå®Œæ•´é¢„è§ˆ tileï¼ˆå…¨æ–°å¢é‡ï¼‰ |
| CP-L2 | å®é™…å±‚å’Œé¢„è§ˆå±‚éƒ½æ˜¯è¾¹ç•Œ tile æ—¶ï¼Œghost åªæ˜¾ç¤ºæ–¹å‘å·®é›†çš„å¢é‡ tile |
| CP-L3 | é˜´å½± tile æ›¿æ¢æ—¶ï¼Œghost æ˜¾ç¤ºé¢„è§ˆ tile è¦†ç›–å®é™…å±‚ï¼ˆSorting Order è¦†ç›–ï¼‰ |
| CP-L4 | ä¸­å¿ƒå—æ›¿æ¢æ—¶ï¼Œghost æ˜¾ç¤ºä¸­å¿ƒå—è¦†ç›–å®é™…å±‚ |
| CP-L5 | `ParseDirections` æ­£ç¡®è§£ææ‰€æœ‰ 16 ç§è¾¹ç•Œ tile çš„æ–¹å‘é›†åˆ |
| CP-L6 | å¢é‡æ–¹å‘ä¸ºç©ºé›†æ—¶ä¸åœ¨ ghost å±‚æ”¾ç½® tile |

---

## äº”ã€P4ï¼šcanTill=false çº¢è‰²åé¦ˆ

### 5.1 ç°çŠ¶é—®é¢˜ï¼ˆä»£ç äº‹å®éªŒè¯ï¼‰

`UpdateHoePreview`ï¼ˆFarmToolPreview.cs ç¬¬403è¡Œï¼‰ä¸­ï¼š
- `canTill = false` â†’ ä¸è¿›å…¥ `if (canTill && ...)` åˆ†æ”¯
- `else` åˆ†æ”¯åªåš `_currentGhostTileData?.Clear()` + è¯Šæ–­æ—¥å¿—
- `cursorRenderer.enabled = false`ï¼ˆåœ¨ `if` ä¹‹å‰è®¾ç½®ï¼Œè€•åœ°æ¨¡å¼ä¸æ˜¾ç¤ºæ–¹æ¡†å…‰æ ‡ï¼‰
- `previewOverlayMaterial.SetColor` è®¾ç½®äº†çº¢è‰²ä½† ghostTilemap ä¸Šæ²¡æœ‰ tile â†’ æ— è½½ä½“ â†’ ä»€ä¹ˆéƒ½ä¸æ˜¾ç¤º

### 5.2 ä¿®å¤æ–¹æ¡ˆ

åœ¨ `else` åˆ†æ”¯ä¸­å¯ç”¨ `cursorRenderer` å¹¶è°ƒç”¨ `UpdateCursor`ï¼š

```
else
{
    _currentGhostTileData?.Clear();
    
    // V2 æ¨¡å—Jï¼šcanTill=false æ—¶æ˜¾ç¤ºå…‰æ ‡åé¦ˆ
    if (cursorRenderer != null)
    {
        cursorRenderer.enabled = true;
        UpdateCursor(layerIndex, cellPos);
        // UpdateCursor æ ¹æ® currentState è®¾ç½®é¢œè‰²ï¼šValid=ç»¿è‰²ï¼ŒInvalid=çº¢è‰²
    }
}
```

æ¯èä½œç‰©åœºæ™¯ï¼ˆ`canClearWithered = true`ï¼‰ï¼š`isValid = true`ï¼Œ`currentState = Valid` â†’ æ˜¾ç¤ºç»¿è‰²æ–¹æ¡†ã€‚
å·²æœ‰è€•åœ°åœºæ™¯ï¼ˆ`canTill = false` + `!canClearWithered`ï¼‰ï¼š`isValid = false`ï¼Œ`currentState = Invalid` â†’ æ˜¾ç¤ºçº¢è‰²æ–¹æ¡†ã€‚

### 5.3 æ­£ç¡®æ€§å±æ€§

| ç¼–å· | å±æ€§ |
|------|------|
| CP-J1 | é¼ æ ‡åœ¨å·²æœ‰è€•åœ°ä¸Šæ—¶æ˜¾ç¤ºçº¢è‰²æ–¹æ¡†ï¼ˆ`canTill=false` + `!canClearWithered` â†’ Invalid çº¢è‰²ï¼‰ |
| CP-J2 | é¼ æ ‡åœ¨æ¯èä½œç‰©ä¸Šæ—¶æ˜¾ç¤ºç»¿è‰²æ–¹æ¡†ï¼ˆ`canClearWithered=true` â†’ Valid ç»¿è‰²ï¼‰ |
| CP-J3 | å¯é”„åœ°æ—¶ä»ç„¶ä¸æ˜¾ç¤ºå…‰æ ‡ï¼ˆ`canTill=true` åˆ†æ”¯ä¸­ `cursorRenderer.enabled = false` ä¸å˜ï¼‰ |


---

## å…­ã€P5ï¼šæ‰¹é‡æ“ä½œé¢„è§ˆå†²çªï¼ˆå·²çŸ¥é™åˆ¶ï¼‰

### 6.1 é—®é¢˜æè¿°

ç”¨æˆ·åœ¨èŠå¤©è®°å½•003_prompt ä¸­æŒ‡å‡ºï¼šæ‰¹é‡æ“ä½œæ—¶é¢„è§ˆä¼š"å½»åº•æ‰“æ¶"ã€‚

### 6.2 æ ¹å› åˆ†æ

`GetPreviewTiles` çš„ predicate åªå‡è£…å•ä¸ªä½ç½®ï¼ˆ`centerPos`ï¼‰å·²è€•ä½œï¼Œä¸è€ƒè™‘é˜Ÿåˆ—ä¸­å…¶ä»–ä½ç½®ã€‚å½“ä¸¤ä¸ªç›¸é‚»ä½ç½®å…ˆåå…¥é˜Ÿæ—¶ï¼š
- ç¬¬ä¸€ä¸ªå…¥é˜Ÿï¼šé¢„è§ˆè®¡ç®—æ­£ç¡®
- ç¬¬äºŒä¸ªå…¥é˜Ÿï¼špredicate ä¸çŸ¥é“ç¬¬ä¸€ä¸ªä½ç½®ä¹Ÿå°†è¢«è€•ä½œï¼Œè¾¹ç•Œè®¡ç®—ä¸å®Œæ•´
- ä¸¤ä¸ªé˜Ÿåˆ—é¢„è§ˆçš„è¾¹ç•Œ tile å¯èƒ½äº’ç›¸è¦†ç›–

### 6.3 å¤„ç†ç­–ç•¥

è¿™æ˜¯ä¸€ä¸ªå·²çŸ¥é™åˆ¶ï¼ŒåŸå› æ˜¯ `GetPreviewTiles` çš„è®¾è®¡åªæ”¯æŒå•ç‚¹é¢„æµ‹ã€‚è¦æ”¯æŒå¤šç‚¹é¢„æµ‹éœ€è¦é‡æ„ predicate é€»è¾‘ï¼ˆä¼ å…¥æ‰€æœ‰é˜Ÿåˆ—ä½ç½®ï¼‰ï¼Œå¤æ‚åº¦è¾ƒé«˜ã€‚

å®é™…è½åœ°æ—¶ `UpdateBorderAt` ç”¨çœŸå®æ•°æ®é‡æ–°è®¡ç®—ï¼Œç»“æœæ­£ç¡®ã€‚æ‰€ä»¥è¿™ä¸ªé—®é¢˜åªå½±å“é¢„è§ˆçš„è§†è§‰å‡†ç¡®æ€§ï¼Œä¸å½±å“æœ€ç»ˆè€•åœ°æ•°æ®ã€‚

å½“å‰é˜¶æ®µæ ‡è®°ä¸ºå·²çŸ¥é™åˆ¶ï¼Œåç»­å¯ä½œä¸ºä¼˜åŒ–é¡¹å¤„ç†ã€‚

### 6.4 æ­£ç¡®æ€§å±æ€§

æ— æ–°å¢å±æ€§ã€‚æ­¤é—®é¢˜ä¸åœ¨ V2 ä¿®å¤èŒƒå›´å†…ã€‚

---

## ä¸ƒã€P6ï¼šSorting Order ç¡®è®¤

### 7.1 ä»£ç äº‹å®éªŒè¯

`EnsureComponents`ï¼ˆFarmToolPreview.cs ç¬¬230è¡Œï¼‰ä¸­ï¼š
- `ghostTilemapRenderer.sortingOrder = 9999`ï¼ˆæé«˜å€¼ï¼‰
- `queuePreviewTilemapRenderer.sortingOrder = 9998`
- `cursorRenderer.sortingOrder = 10000`

`farmlandBorderTilemap` çš„ Sorting Order ç”±åœºæ™¯é…ç½®å†³å®šï¼Œé€šå¸¸è¿œä½äº 9999ã€‚

### 7.2 ç»“è®º

ghostTilemapï¼ˆ9999ï¼‰> farmlandBorderTilemapï¼ˆåœºæ™¯é…ç½®å€¼ï¼‰â†’ è¦†ç›–å…³ç³»æˆç«‹ã€‚

ä½†éœ€è¦åœ¨ä»»åŠ¡æ‰§è¡Œæ—¶å®é™…ç¡®è®¤åœºæ™¯ä¸­ `farmlandBorderTilemap` çš„ Sorting Order å€¼ï¼Œç¡®ä¿ä¸å­˜åœ¨å¼‚å¸¸é…ç½®ã€‚

### 7.3 æ­£ç¡®æ€§å±æ€§

| ç¼–å· | å±æ€§ |
|------|------|
| CP-K1 | ghostTilemap Sorting Orderï¼ˆ9999ï¼‰> farmlandBorderTilemap Sorting Order |

---

## å…«ã€å®Œæ•´æ•°æ®æµï¼ˆV2 ä¿®æ­£ç‰ˆï¼‰

### 8.1 è€•åœ°å®Œæ•´æµç¨‹

```
1. é¼ æ ‡ç§»åŠ¨ â†’ UpdateHoePreview
   â”œâ”€ canTill=trueï¼š
   â”‚   â”œâ”€ GetPreviewTiles â†’ å¢é‡å·®é›†è¿‡æ»¤ï¼ˆP3 ä¿®å¤ï¼‰ â†’ ghostTilemap æ˜¾ç¤ºå¢é‡ tile
   â”‚   â”œâ”€ cursorRenderer.enabled = false
   â”‚   â””â”€ ç¼“å­˜ CurrentGhostTileData
   â””â”€ canTill=falseï¼š
       â”œâ”€ ghostTilemap æ—  tile
       â”œâ”€ cursorRenderer.enabled = true â†’ çº¢è‰²/ç»¿è‰²æ–¹æ¡†ï¼ˆP4 ä¿®å¤ï¼‰
       â””â”€ _currentGhostTileData.Clear()

2. ç©å®¶ç‚¹å‡» â†’ TryEnqueueFarmTool â†’ EnqueueAction
   â”œâ”€ å¤åˆ¶ CurrentGhostTileData å¿«ç…§
   â”œâ”€ AddQueuePreview â†’ queuePreviewTilemap æ˜¾ç¤ºé˜Ÿåˆ—é¢„è§ˆ
   â””â”€ ghost ç»§ç»­è·Ÿéšé¼ æ ‡

3. ProcessNextAction å‡ºé˜Ÿ
   â”œâ”€ ä¸å†è°ƒç”¨ PromoteToExecutingPreviewï¼ˆP2 ä¿®å¤ï¼‰
   â”œâ”€ ä¸å†è®¾ç½® _isExecutingFarming = trueï¼ˆP2 ä¿®å¤ï¼‰
   â”œâ”€ è·ç¦»åˆ¤æ–­ï¼šè¿‘è·ç¦» â†’ ç›´æ¥ ExecuteFarmAction
   â””â”€ è¿œè·ç¦» â†’ StartFarmingNavigation â†’ åˆ°è¾¾å ExecuteFarmAction

4. ExecuteFarmActionï¼ˆåŠ¨ç”»å¼€å§‹ç¬é—´ï¼‰
   â”œâ”€ _isExecutingFarming = trueï¼ˆP2 ä¿®å¤ï¼‰
   â”œâ”€ PromoteToExecutingPreview(cellPos)ï¼ˆP2 ä¿®å¤ï¼‰
   â”œâ”€ FaceTarget â†’ RequestAction â†’ å¼€å§‹åŠ¨ç”»
   â””â”€ _pendingTileUpdate = request

5. WASD ä¸­æ–­ï¼ˆå¯¼èˆªé€”ä¸­ï¼‰
   â”œâ”€ ClearActionQueueï¼š
   â”‚   â”œâ”€ æ¸…ç©ºé˜Ÿåˆ—
   â”‚   â”œâ”€ _isExecutingFarming == false â†’ å…¨éƒ¨æ¸…ç©ºï¼ˆP1+P2 è”åŠ¨ï¼‰
   â”‚   â””â”€ ClearAllQueuePreviews â†’ æ“ä½œè¿˜åœ¨é˜Ÿåˆ—é¢„è§ˆä¸­ï¼Œè¢«æ­£å¸¸æ¸…ç©º âœ…
   â””â”€ å¯¼èˆªå–æ¶ˆ

6. WASD ä¸­æ–­ï¼ˆåŠ¨ç”»æ‰§è¡Œä¸­ï¼‰
   â”œâ”€ ClearActionQueueï¼š
   â”‚   â”œâ”€ æ¸…ç©ºé˜Ÿåˆ—
   â”‚   â”œâ”€ _isExecutingFarming == true â†’ ä¿ç•™æ‰§è¡ŒçŠ¶æ€ï¼ˆP1 ä¿®å¤ï¼‰
   â”‚   â””â”€ ClearAllQueuePreviews â†’ è·³è¿‡æ‰§è¡Œé¢„è§ˆ
   â”œâ”€ åŠ¨ç”»ç»§ç»­æ’­æ”¾
   â”œâ”€ Update è¿›åº¦ç›‘å¬ â†’ _pendingTileUpdate æœªè¢«æ¸…ç©º â†’ tile æ­£å¸¸åˆ›å»º âœ…
   â””â”€ OnFarmActionAnimationComplete â†’ RemoveExecutingPreview(æ­£ç¡®çš„ cellPos) âœ…

7. åŠ¨ç”»æ­£å¸¸å®Œæˆ
   â”œâ”€ TillAt â†’ UpdateBorderAtï¼ˆæ•°æ®å±‚è½åœ°ï¼‰
   â”œâ”€ RemoveExecutingPreview(cellPos)
   â””â”€ ProcessNextActionï¼ˆå–ä¸‹ä¸€ä¸ªï¼‰
```

### 8.2 Ghost é¢„è§ˆå¢é‡æ˜¾ç¤ºæµç¨‹

```
UpdateHoePreviewï¼ˆcanTill=true åˆ†æ”¯ï¼‰ï¼š
  1. GetPreviewTiles(layerIndex, cellPos) â†’ è·å–æœ€ç»ˆçŠ¶æ€ tile å­—å…¸
  2. éå†æ¯ä¸ªä½ç½®ï¼š
     â”œâ”€ é¢„è§ˆ tile == null â†’ è·³è¿‡
     â”œâ”€ è·å–å®é™… tileï¼ˆä¸­å¿ƒå—ç”¨ centerTilemapï¼Œå…¶ä»–ç”¨ borderTilemapï¼‰
     â”œâ”€ é¢„è§ˆ tile == å®é™… tile â†’ è·³è¿‡ï¼ˆæ— å·®å¼‚ï¼‰
     â”œâ”€ å®é™… tile == null â†’ ghost æ˜¾ç¤ºé¢„è§ˆ tileï¼ˆå…¨æ–°ï¼‰
     â”œâ”€ å®é™… tile æ˜¯é˜´å½± â†’ ghost æ˜¾ç¤ºé¢„è§ˆ tileï¼ˆå®Œå…¨æ›¿æ¢ï¼ŒSorting Order è¦†ç›–ï¼‰
     â”œâ”€ ä¸¤è€…éƒ½æ˜¯è¾¹ç•Œ tile â†’ å¢é‡å·®é›†è®¡ç®—ï¼š
     â”‚   â”œâ”€ ParseDirections(å®é™… tile) â†’ å®é™…æ–¹å‘é›†åˆ
     â”‚   â”œâ”€ ParseDirections(é¢„è§ˆ tile) â†’ é¢„è§ˆæ–¹å‘é›†åˆ
     â”‚   â”œâ”€ å¢é‡æ–¹å‘ = é¢„è§ˆæ–¹å‘ AND NOT å®é™…æ–¹å‘
     â”‚   â”œâ”€ å¢é‡ tile = SelectBorderTile(å¢é‡æ–¹å‘)
     â”‚   â””â”€ ghost æ˜¾ç¤ºå¢é‡ tile
     â””â”€ å…¶ä»–æƒ…å†µ â†’ ghost æ˜¾ç¤ºé¢„è§ˆ tileï¼ˆè¦†ç›–ï¼‰
```


---

## ä¹ã€æ­£ç¡®æ€§å±æ€§å®Œæ•´æ±‡æ€»

### 9.1 V2 æ–°å¢å±æ€§

| ç¼–å· | å±æ€§ | æ‰€å±æ¨¡å— |
|------|------|---------|
| CP-H1 | WASD ä¸­æ–­æ—¶æ­£åœ¨æ‰§è¡Œçš„åŠ¨ç”»æ“ä½œä¸å—å½±å“ | P1ï¼ˆClearActionQueue ä¿æŠ¤ï¼‰ |
| CP-H2 | åŠ¨ç”»æ’­å®Œå tile æ­£å¸¸åˆ›å»º | P1 |
| CP-H3 | åŠ¨ç”»å®Œæˆåæ‰§è¡Œé¢„è§ˆæ­£å¸¸æ¸…é™¤ | P1 |
| CP-H4 | é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ“ä½œä»è¢«æ­£å¸¸æ¸…ç©º | P1 |
| CP-I1 | æ‰§è¡Œé¢„è§ˆåªåœ¨åŠ¨ç”»çœŸæ­£å¼€å§‹æ—¶æ‰è¢«ä¿æŠ¤ | P2ï¼ˆPromote æ—¶æœºï¼‰ |
| CP-I2 | å¯¼èˆªé€”ä¸­è¢«æ‰“æ–­çš„æ“ä½œéšé˜Ÿåˆ—ä¸€èµ·æ¸…ç©º | P2 |
| CP-I3 | `_isExecutingFarming` åªåœ¨åŠ¨ç”»å¼€å§‹æ—¶è®¾ä¸º true | P2 |
| CP-I4 | è¿‘è·ç¦»æ“ä½œè¡Œä¸ºä¸å˜ | P2 |
| CP-L1 | å®é™…å±‚ä¸ºç©ºæ—¶ï¼Œghost æ˜¾ç¤ºå®Œæ•´é¢„è§ˆ tile | P3ï¼ˆå¢é‡å·®é›†ï¼‰ |
| CP-L2 | ä¸¤è€…éƒ½æ˜¯è¾¹ç•Œ tile æ—¶ï¼Œghost åªæ˜¾ç¤ºæ–¹å‘å·®é›†å¢é‡ tile | P3 |
| CP-L3 | é˜´å½± tile æ›¿æ¢æ—¶ï¼Œghost æ˜¾ç¤ºé¢„è§ˆ tile è¦†ç›–å®é™…å±‚ | P3 |
| CP-L4 | ä¸­å¿ƒå—æ›¿æ¢æ—¶ï¼Œghost æ˜¾ç¤ºä¸­å¿ƒå—è¦†ç›–å®é™…å±‚ | P3 |
| CP-L5 | `ParseDirections` æ­£ç¡®è§£ææ‰€æœ‰ 16 ç§è¾¹ç•Œ tile | P3 |
| CP-L6 | å¢é‡æ–¹å‘ä¸ºç©ºé›†æ—¶ä¸åœ¨ ghost å±‚æ”¾ç½® tile | P3 |
| CP-J1 | é¼ æ ‡åœ¨å·²æœ‰è€•åœ°ä¸Šæ—¶æ˜¾ç¤ºçº¢è‰²æ–¹æ¡† | P4ï¼ˆcanTill=false åé¦ˆï¼‰ |
| CP-J2 | é¼ æ ‡åœ¨æ¯èä½œç‰©ä¸Šæ—¶æ˜¾ç¤ºç»¿è‰²æ–¹æ¡† | P4 |
| CP-J3 | å¯é”„åœ°æ—¶ä»ç„¶ä¸æ˜¾ç¤ºå…‰æ ‡ | P4 |
| CP-K1 | ghostTilemap Sorting Order > farmlandBorderTilemap | P6ï¼ˆSorting Orderï¼‰ |

### 9.2 V1 ä¿ç•™å±æ€§ï¼ˆä¸å˜ï¼‰

CP-A1~A2ï¼ˆç§»é™¤ LockPositionï¼‰ã€CP-B1~B3ï¼ˆGhost å·®å¼‚åŒ–è¿‡æ»¤åŸºç¡€ï¼‰ã€CP-C1~C4ï¼ˆæµ‡æ°´ Ghost ç¨³å®šæ€§ï¼‰ã€CP-D1~D3ï¼ˆæ‰§è¡Œé¢„è§ˆæ•°æ®ç»“æ„ï¼‰ã€CP-E1~E3ï¼ˆClearAllQueuePreviews é‡å†™ï¼‰ã€CP-F1~F2ï¼ˆAddQueuePreview æ¥æ”¶ ghost æ•°æ®ï¼‰ã€CP-G1~G6ï¼ˆGameInputManager é›†æˆï¼‰

---

## åã€æ¶‰åŠæ–‡ä»¶æ±‡æ€»

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | æ¶‰åŠé—®é¢˜ |
|------|----------|----------|
| `GameInputManager.cs` | ä¿®æ”¹ | P1ï¼ˆClearActionQueue ä¿æŠ¤ï¼‰ã€P2ï¼ˆPromote æ—¶æœºä¿®æ­£ï¼‰ |
| `FarmToolPreview.cs` | ä¿®æ”¹ | P3ï¼ˆå¢é‡å·®é›†è¿‡æ»¤ï¼‰ã€P4ï¼ˆcanTill=false åé¦ˆï¼‰ |
| `FarmlandBorderManager.cs` | ä¿®æ”¹ | P3ï¼ˆæ–°å¢ ParseDirections / IsBorderTile / IsShadowTileï¼ŒSelectBorderTile æ”¹ä¸º publicï¼‰ |

---

## åä¸€ã€ä¸ designV3 çš„å…³ç³»

å½“å‰ designV3 æœ‰ 4 ä¸ªæ¨¡å—ï¼ˆH/I/J/Kï¼‰ï¼Œå¯¹åº”å…³ç³»ï¼š

| designV3 æ¨¡å— | æœ¬æŠ¥å‘Šé—®é¢˜ | éœ€è¦æ›´æ–°çš„å†…å®¹ |
|--------------|-----------|---------------|
| æ¨¡å— Hï¼ˆClearActionQueue ä¿æŠ¤ï¼‰ | P1 | æ–¹æ¡ˆä¸€è‡´ï¼Œæ— éœ€å¤§æ”¹ |
| æ¨¡å— Iï¼ˆPromote æ—¶æœºä¿®æ­£ï¼‰ | P2 | æ–¹æ¡ˆä¸€è‡´ï¼Œæ— éœ€å¤§æ”¹ |
| æ¨¡å— Jï¼ˆcanTill=false åé¦ˆï¼‰ | P4 | æ–¹æ¡ˆä¸€è‡´ï¼Œæ— éœ€å¤§æ”¹ |
| æ¨¡å— Kï¼ˆSorting Order ç¡®è®¤ï¼‰ | P6 | æ–¹æ¡ˆä¸€è‡´ï¼Œæ— éœ€å¤§æ”¹ |
| **æ— å¯¹åº”æ¨¡å—** | **P3ï¼ˆå¢é‡å·®é›†è®¡ç®—ï¼‰** | **éœ€è¦æ–°å¢æ¨¡å— L** |

designV4 åº”åœ¨ designV3 åŸºç¡€ä¸Šï¼š
1. æ–°å¢æ¨¡å— Lï¼šå¢é‡å·®é›†è®¡ç®—ï¼ˆ`ParseDirections` + `IsBorderTile` + `IsShadowTile` + å·®å¼‚åŒ–è¿‡æ»¤æ”¹é€ ï¼‰
2. ä¿®æ­£æ¨¡å—æè¿°ä¸­"tile ä¸å¯åˆ†å‰²"çš„é”™è¯¯è¡¨è¿°
3. æ–°å¢ CP-L1~L6 æ­£ç¡®æ€§å±æ€§
4. æ›´æ–°æ¶‰åŠæ–‡ä»¶æ±‡æ€»ï¼ˆæ–°å¢ `FarmlandBorderManager.cs`ï¼‰

---

## åäºŒã€å·²çŸ¥é™åˆ¶ä¸åç»­äº‹é¡¹

| ç¼–å· | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| L1 | æ‰¹é‡æ“ä½œé˜Ÿåˆ—é¢„è§ˆä¹‹é—´ tile äº’ç›¸è¦†ç›–ï¼ˆP5ï¼‰ | å·²çŸ¥é™åˆ¶ï¼Œåç»­ä¼˜åŒ– |
| L2 | `GetPreviewTiles` åªæ”¯æŒå•ç‚¹é¢„æµ‹ | P5 çš„æ ¹å› ï¼Œåç»­å¯é‡æ„ |
| L3 | é˜´å½± tile æ›¿æ¢ä¾èµ– Sorting Order è¦†ç›– | å½“å‰æ–¹æ¡ˆå¯è¡Œï¼Œéå¢é‡é—®é¢˜ |

---

> æœ¬æŠ¥å‘Šæ•´åˆäº†èŠå¤©è®°å½•003_prompt çš„å››ç‚¹çº æ­£ã€èŠå¤©è®°å½•002 çš„ä»£ç éªŒè¯ã€å†œç”°ä¸‰å±‚æ˜¾ç¤ºäº¤äº’çŸ©é˜µV2 çš„å¢é‡è®¡ç®—é”™è¯¯åˆ†æï¼Œå½¢æˆè¡¥ä¸004V2çš„å®Œæ•´ä¿®å¤æ–¹æ¡ˆã€‚
> 
> å¾…ç”¨æˆ·å®¡æ ¸é€šè¿‡åï¼Œå°†åŸºäºæœ¬æŠ¥å‘Šè¿­ä»£ designV4 å’Œ tasksV4ã€‚
