# ç»§æ‰¿å¿«ç…§ - ä¼šè¯1ç»­4

> å·¥ä½œåŒºï¼š.kiro/specs/å†œç”°ç³»ç»Ÿ/10.1.4è¡¥ä¸004/
> åˆ›å»ºæ—¶é—´ï¼š2026-02-20

## ç”¨æˆ· Prompt å®Œæ•´æ‘˜æŠ„

æœ¬è½®ä¸º CONTEXT TRANSFER ç»§æ‰¿æ¢å¤ã€‚ç”¨æˆ·åŸå§‹æŒ‡ä»¤ï¼ˆæ¥è‡ªç»­2å¿«ç…§ï¼‰ï¼šå‚ç…§è¡¥ä¸002/003ç»“æ„å‡çº§ä¸‰ä»¶å¥—ï¼Œç„¶åä¸€æ¡é¾™æ‰§è¡Œå…¨éƒ¨ä»»åŠ¡ã€‚

ç»§æ‰¿æ¢å¤å AI æŒ‰ tasksV2 é¡ºåºæ‰§è¡Œä¸€æ¡é¾™ä»£ç ä¿®æ”¹ã€‚

## AI è¿›åº¦æ‘˜è¦

### å·²å®Œæˆ
1. âœ… ç»§æ‰¿æ¢å¤ï¼šè¯»å–å¿«ç…§ï¼ˆç»­3ï¼‰ã€memoryã€CONTEXT TRANSFERï¼Œäº¤å‰éªŒè¯æ— å¼‚å¸¸
2. âœ… é‡æ–°è¯»å–æ ¸å¿ƒä»£ç ï¼šFarmToolPreview.csã€GameInputManager.csã€LayerTilemaps.csã€FarmlandBorderManager.cs
3. âœ… å…³é”®å‘ç°ï¼š`LayerTilemaps` æ²¡æœ‰ `tilledTilemap` å­—æ®µ â†’ å·®å¼‚åŒ–è¿‡æ»¤æ”¹ä¸ºå¯¹æ¯” `farmlandCenterTilemap`ï¼ˆä¸­å¿ƒå—ï¼‰+ `farmlandBorderTilemap`ï¼ˆè¾¹ç•Œï¼‰
4. âœ… Phase 1ï¼ˆä»»åŠ¡1.1ï¼‰ï¼šFarmToolPreview ç§»é™¤ LockPosition æœºåˆ¶
   - åˆ é™¤ `_isLocked`/`_lockedWorldPosition`/`_lockedCellPos`/`_lockedLayerIndex` å­—æ®µ
   - åˆ é™¤ `LockPosition()`/`UnlockPosition()` æ–¹æ³•
   - åˆ é™¤ `IsLocked`/`LockedWorldPos`/`LockedCellPos` å±æ€§
   - ç§»é™¤ 3 ä¸ª Update*Preview ä¸­çš„ `if (_isLocked) return;`
5. âœ… Phase 2ï¼ˆä»»åŠ¡2.1ï¼‰ï¼šGhost å·®å¼‚åŒ–è¿‡æ»¤ + CurrentGhostTileData ç¼“å­˜
6. âœ… Phase 2ï¼ˆä»»åŠ¡2.2ï¼‰ï¼šæµ‡æ°´ Ghost è¿›å…¥æ–°æ ¼å­æ‰éšæœº + CurrentPuddleVariant + Hide é‡ç½®
7. âœ… Phase 3ï¼ˆä»»åŠ¡3.1ï¼‰ï¼šæ‰§è¡Œé¢„è§ˆæ•°æ®ç»“æ„ + PromoteToExecutingPreview + RemoveExecutingPreview
8. âœ… Phase 3ï¼ˆä»»åŠ¡3.2ï¼‰ï¼šClearAllQueuePreviews å®Œæ•´é‡å†™ï¼ˆè¾¹ç•Œæ®‹ç•™ä¿®å¤ + æ‰§è¡Œé¢„è§ˆä¿æŠ¤ï¼‰
9. âœ… Phase 4ï¼ˆä»»åŠ¡4.1ï¼‰ï¼šAddQueuePreview æ¥æ”¶ ghostTileData å‚æ•°ï¼ˆä¼˜å…ˆ ghost æ•°æ®ï¼Œå…œåº•ç‹¬ç«‹è®¡ç®—ï¼‰
10. âœ… Phase 5ï¼ˆä»»åŠ¡5.1 éƒ¨åˆ†ï¼‰ï¼šç§»é™¤é˜Ÿåˆ—è·¯å¾„ä¸­çš„ LockPosition/UnlockPosition è°ƒç”¨
    - ProcessNextAction é˜Ÿåˆ—ç©ºåˆ†æ”¯ UnlockPosition â†’ ç§»é™¤
    - ProcessNextAction å‡ºé˜Ÿ LockPosition â†’ æ›¿æ¢ä¸º PromoteToExecutingPreview
    - HandleMovement WASD ä¸­æ–­ UnlockPosition â†’ ç§»é™¤
    - HandleMovement autoNavigator åˆ†æ”¯ UnlockPosition â†’ ç§»é™¤
    - CancelFarmingNavigation å†…éƒ¨ UnlockPosition â†’ ç§»é™¤
11. âœ… Phase 5ï¼ˆä»»åŠ¡5.2ï¼‰ï¼šProcessNextAction å‡ºé˜Ÿæ—¶è°ƒç”¨ PromoteToExecutingPreview
12. âœ… Phase 5ï¼ˆä»»åŠ¡5.3ï¼‰ï¼šOnFarmActionAnimationComplete/OnCollectAnimationComplete â†’ RemoveExecutingPreviewï¼ŒPlantSeed åˆ†æ”¯æ·»åŠ  RemoveExecutingPreview
13. âœ… Phase 5ï¼ˆä»»åŠ¡5.4ï¼‰ï¼šTryEnqueueFarmTool ä¼ é€’ ghost æ•°æ®ï¼ˆè€•åœ°æ·±æ‹·è´å¿«ç…§ + æµ‡æ°´ CurrentPuddleVariantï¼‰
14. âœ… Phase 5ï¼ˆä»»åŠ¡5.5ï¼‰ï¼šEnqueueAction æ–°å¢ ghostTileData å‚æ•°
15. âœ… æ·»åŠ  `using UnityEngine.Tilemaps;` åˆ° GameInputManager.cs
16. âœ… getDiagnostics ç¼–è¯‘éªŒè¯ï¼š0 é”™è¯¯ 0 è­¦å‘Šï¼ˆé˜Ÿåˆ—è·¯å¾„æ”¹åŠ¨åï¼‰

### æœªå®Œæˆ
1. âŒ æ—§å•æ¬¡æ‰§è¡Œè·¯å¾„ä¸­çš„ LockPosition/UnlockPosition è°ƒç”¨ç§»é™¤
   - `TryTillSoil`ï¼ˆçº¦ç¬¬1252è¡Œï¼‰ï¼š`farmPreview.LockPosition(targetPos, cellPos, layerIndex);` + finally ä¸­ `farmPreview.UnlockPosition();` + å¯¼èˆªå›è°ƒä¸­ `preview.LockedWorldPos` è·ç¦»æ ¡éªŒ
   - `TryWaterTile`ï¼ˆçº¦ç¬¬1391è¡Œï¼‰ï¼šåŒç»“æ„çš„ LockPosition + UnlockPosition + LockedWorldPos
   - `TryPlantSeed`ï¼ˆçº¦ç¬¬1505è¡Œï¼‰ï¼šåŒç»“æ„çš„ LockPosition + UnlockPosition + LockedWorldPos
   - `WaitForNavigationComplete`ï¼ˆçº¦ç¬¬1947-2014è¡Œï¼‰ï¼šå¤šå¤„ `farmPreview.UnlockPosition()`ï¼ˆtry/finally/catch ä¸­ï¼‰
   - ESC ä¸­æ–­ï¼ˆçº¦ç¬¬640è¡Œï¼‰ï¼š`FarmToolPreview.Instance?.UnlockPosition();`
   - `[Obsolete]` æ–¹æ³•ï¼ˆçº¦ç¬¬2178è¡Œ ClearFarmInputCacheã€çº¦ç¬¬2204è¡Œ ConsumeCachedFarmInputï¼‰ï¼šå†…éƒ¨æœ‰ UnlockPosition/LockPosition
   - éš¾ç‚¹ï¼š3ä¸ª Try* æ–¹æ³•ç»“æ„ç›¸ä¼¼å¯¼è‡´ strReplace åŒ¹é…å¤šå¤„ï¼Œéœ€è¦åŠ æ›´å¤šä¸Šä¸‹æ–‡åŒºåˆ†
   - `preview.LockedWorldPos` å±æ€§å·²åˆ é™¤ â†’ ç¼–è¯‘ä¼šæŠ¥é”™ï¼Œéœ€è¦æ›¿æ¢ä¸ºå…¶ä»–è·ç¦»æ ¡éªŒæ–¹å¼ï¼ˆå¦‚ç›´æ¥ç”¨ targetPos å˜é‡ï¼‰
2. âŒ Phase 6ï¼ˆä»»åŠ¡6.1ï¼‰ï¼šç¼–è¯‘éªŒè¯ï¼ˆæ—§è·¯å¾„æ”¹å®Œåé‡æ–°éªŒè¯ï¼‰
3. âŒ Phase 6ï¼ˆä»»åŠ¡6.2ï¼‰ï¼šæ­£ç¡®æ€§å±æ€§é€é¡¹å®¡æŸ¥
4. âŒ Phase 6ï¼ˆä»»åŠ¡6.3ï¼‰ï¼šåˆ›å»ºéªŒæ”¶æŒ‡å—
5. âŒ Phase 6ï¼ˆä»»åŠ¡6.4ï¼‰ï¼šæ›´æ–° memory + ä¸» memory

## ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `FarmToolPreview.cs` | ä¿®æ”¹ | Phase 1-4 å…¨éƒ¨æ”¹åŠ¨å®Œæˆ |
| `GameInputManager.cs` | ä¿®æ”¹ | Phase 5 é˜Ÿåˆ—è·¯å¾„æ”¹åŠ¨å®Œæˆï¼Œæ—§å•æ¬¡æ‰§è¡Œè·¯å¾„å¾…å¤„ç† |

## æœ¬è½®å…³é”®å†³ç­–ä¸ç”¨æˆ·åå¥½
1. `LayerTilemaps` æ²¡æœ‰ `tilledTilemap` â†’ å·®å¼‚åŒ–è¿‡æ»¤æ”¹ä¸ºï¼šä¸­å¿ƒå—ä½ç½®å¯¹æ¯” `farmlandCenterTilemap`ï¼Œå‘¨å›´8æ ¼å¯¹æ¯” `farmlandBorderTilemap`
2. ghost æ•°æ®å¿«ç…§åœ¨ TryEnqueueFarmTool ä¸­æ·±æ‹·è´ï¼ˆ`new Dictionary<>(ghostData)`ï¼‰
3. ä¸€æ¡é¾™æ¨¡å¼ï¼šä¸ç­‰å¾…ç”¨æˆ·å®¡æ ¸ï¼Œè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
4. PlacementPreview.cs ä¸­çš„ LockPosition/UnlockPosition æ˜¯æ”¾ç½®ç³»ç»Ÿçš„ï¼Œä¸å†œç”°é¢„è§ˆæ— å…³ï¼Œä¸éœ€è¦ç§»é™¤

## å…³è”æ–‡ä»¶ä¸å¾…åŒæ­¥çŠ¶æ€
- `FarmToolPreview.cs` â€” âœ… Phase 1-4 æ”¹åŠ¨å®Œæˆ
- `GameInputManager.cs` â€” ğŸš§ Phase 5 é˜Ÿåˆ—è·¯å¾„å®Œæˆï¼Œæ—§å•æ¬¡æ‰§è¡Œè·¯å¾„å¾…å¤„ç†
- `designV2.md` â€” æ— å˜åŒ–
- `tasksV2.md` â€” æ— å˜åŒ–ï¼ˆä»»åŠ¡çŠ¶æ€æœªæ›´æ–°åˆ°æ–‡ä»¶ä¸­ï¼‰
- `memory.md` â€” âœ… å·²è¿½åŠ ä¼šè¯1ç»­4è®°å½•
- ä¸» memory â€” âŒ æœªåŒæ­¥

## é—ç•™é—®é¢˜å®Œæ•´ä¸Šä¸‹æ–‡

### é—®é¢˜1ï¼šæ—§å•æ¬¡æ‰§è¡Œè·¯å¾„çš„ LockPosition/UnlockPosition ç§»é™¤
- èƒŒæ™¯ï¼šGameInputManager ä¸­æœ‰ä¸¤å¥—æ‰§è¡Œè·¯å¾„â€”â€”é˜Ÿåˆ—è·¯å¾„ï¼ˆEnqueueAction â†’ ProcessNextActionï¼‰å’Œæ—§å•æ¬¡è·¯å¾„ï¼ˆTryTillSoil/TryWaterTile/TryPlantSeed ç›´æ¥æ‰§è¡Œï¼‰
- é˜Ÿåˆ—è·¯å¾„å·²å®Œæˆæ”¹é€ ï¼Œæ—§å•æ¬¡è·¯å¾„ä»æœ‰ LockPosition/UnlockPosition è°ƒç”¨
- æ—§è·¯å¾„ä»è¢« TryHandleFarmingTool è°ƒç”¨ï¼ˆæ´»è·ƒä»£ç ï¼‰ï¼Œä¸æ˜¯æ­»ä»£ç 
- strReplace éš¾ç‚¹ï¼š3ä¸ª Try* æ–¹æ³•ç»“æ„å‡ ä¹ç›¸åŒï¼ˆéƒ½æœ‰ `farmPreview.LockPosition(targetPos, cellPos, layerIndex);`ï¼‰ï¼Œéœ€è¦ç”¨æ›´å¤šä¸Šä¸‹æ–‡ï¼ˆå¦‚æ–¹æ³•åæˆ–å‰åè¡Œï¼‰æ¥åŒºåˆ†
- `preview.LockedWorldPos` å±æ€§å·²åˆ é™¤ â†’ å¯¼èˆªå›è°ƒä¸­çš„è·ç¦»æ ¡éªŒéœ€è¦æ”¹ä¸ºä½¿ç”¨é—­åŒ…æ•è·çš„ `targetPos` å˜é‡ï¼ˆå·²åœ¨ä½œç”¨åŸŸå†…ï¼‰

### é—®é¢˜2ï¼šLockedWorldPos æ›¿ä»£æ–¹æ¡ˆ
- æ—§è·¯å¾„å¯¼èˆªå›è°ƒä¸­ç”¨ `preview.LockedWorldPos` åšè·ç¦»æ ¡éªŒï¼ˆåˆ°è¾¾åæ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨é”å®šç‚¹é™„è¿‘ï¼‰
- å±æ€§å·²åˆ é™¤ï¼Œä½†é—­åŒ…ä¸­å·²æœ‰ `targetPos` å˜é‡ï¼ˆå°±æ˜¯åŸæ¥ä¼ ç»™ LockPosition çš„å€¼ï¼‰
- æ›¿ä»£æ–¹æ¡ˆï¼š`float distToLocked = Vector2.Distance(playerPos, preview.LockedWorldPos);` â†’ `float distToTarget = Vector2.Distance(playerPos, targetPos);`
- è¿™æ˜¯å®‰å…¨çš„æ›¿æ¢ï¼Œå› ä¸º `targetPos` å°±æ˜¯åŸæ¥çš„ `_lockedWorldPosition`

### é—®é¢˜3ï¼šObsolete æ–¹æ³•ä¸­çš„è°ƒç”¨
- `ClearFarmInputCache`ï¼ˆçº¦ç¬¬2178è¡Œï¼‰å’Œ `ConsumeCachedFarmInput`ï¼ˆçº¦ç¬¬2204è¡Œï¼‰æ ‡è®°ä¸º `[Obsolete]`
- éœ€è¦æœç´¢ç¡®è®¤æ˜¯å¦ä»è¢«è°ƒç”¨ï¼Œå¦‚æœæ²¡æœ‰è¢«è°ƒç”¨å¯ä»¥ä¸å¤„ç†ï¼ˆç¼–è¯‘ä¸ä¼šæŠ¥é”™å› ä¸ºæ–¹æ³•å†…éƒ¨å¼•ç”¨çš„æ˜¯åŒæ–‡ä»¶çš„æ–¹æ³•ï¼‰
- ä½† `farmPreview.UnlockPosition()` å’Œ `farmPreview.LockPosition(...)` æ–¹æ³•å·²ä» FarmToolPreview ä¸­åˆ é™¤ â†’ ç¼–è¯‘ä¼šæŠ¥é”™
- å¿…é¡»å¤„ç†ï¼šè¦ä¹ˆåˆ é™¤è¿™äº› Obsolete æ–¹æ³•ï¼Œè¦ä¹ˆç§»é™¤å…¶ä¸­çš„ Lock/Unlock è°ƒç”¨
