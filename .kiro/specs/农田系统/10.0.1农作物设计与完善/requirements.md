# 农作物控制器设计与SO迭代 - 需求文档

**创建日期**: 2026-02-10
**工作区**: `.kiro/specs/农田系统/10.0.1农作物设计与完善/`

---

## 用户故事

### US-1：种子袋保质期系统

**作为**玩家，**我希望**种子袋有保质期机制，**以便**增加游戏策略性和紧迫感。

**验收标准**：
- AC-1.1：所有种子用袋子装，袋子有"未打开"和"已打开"两个状态
- AC-1.2：未打开的种子袋保质期默认为7天
- AC-1.3：打开后的种子袋保质期默认变为2天
- AC-1.4：过期后种子袋变成"腐烂的食物"
- AC-1.5："腐烂的食物"是一个独立物品（FoodData），可堆叠
- AC-1.6：所有食物腐烂后都变成同一个"腐烂的食物"物品
- AC-1.7：**种子袋不可堆叠**，每个种子袋是独立物品，保质期独立计算
- AC-1.8：一个种子袋内有一定数量的种子（由SeedData配置）
- AC-1.9：种子袋的保质期状态必须可持久化到存档

### US-2：作物7样式生长系统

**作为**玩家，**我希望**作物有丰富的视觉变化，**以便**直观了解作物的生长状态。

**验收标准**：
- AC-2.1：每种作物有4个生长阶段样式（种子→小苗→成长→成熟）
- AC-2.2：每种作物有1个拔出来的作物样式（收割后获得的物品外观）
- AC-2.3：成熟后超过2天未收割，作物变枯萎，有1个枯萎样式
- AC-2.4：枯萎作物拔出来也有1个独立样式
- AC-2.5：共7个样式覆盖作物的完整生命周期
- AC-2.6：**枯萎作物是独立的SO**（WitheredCropData），与正常作物分离
- AC-2.7：CropController需要索引两种SO（正常CropData + WitheredCropData），随时切换
- AC-2.8：作物生长状态必须可持久化到存档


### US-3：作物生长控制与枯萎机制

**作为**开发者，**我希望**生长阶段间隔在Controller里控制，**以便**灵活调整不同作物的生长节奏。

**验收标准**：
- AC-3.1：生长阶段间隔由CropController的配置决定，不硬编码在SO中
- AC-3.2：SO有三个类型：SeedData（种子）、CropData（作物）、WitheredCropData（枯萎作物）
- AC-3.3：作物样式切换参考TreeController的模式实现
- AC-3.4：**成熟后枯萎计时精确定义**：
  - 假设春季14天作物刚好成熟
  - 春季15天（第二天）：daysSinceMature = 1
  - 春季16天（第三天）：daysSinceMature = 2，此时枯萎
- AC-3.5：**过季枯萎**：所有作物在季节切换时全部枯萎（无论是否成熟）
- AC-3.6：枯萎状态必须可持久化到存档

### US-4：成熟收割系统

**作为**玩家，**我希望**成熟作物可以收割获得作物物品，**以便**完成种植→收获的完整循环。

**验收标准**：
- AC-4.1：成熟作物收割后获得对应的CropData物品（食物类）
- AC-4.2：收割数量由SeedData的harvestAmountRange决定
- AC-4.3：枯萎作物也可以收割，但获得WitheredCropData物品
- AC-4.4：收割逻辑由CropController处理
- AC-4.5：**收获的作物是食物**，可以直接食用（后续会有buff系统）
- AC-4.6：**腐烂的食物也是食物**，可以堆叠，可以作为配方材料，可以独立食用（有负面buff）

### US-5：种子播种流程

**作为**玩家，**我希望**种子播种后自动进入作物生长流程，**以便**无缝衔接种植和生长。

**验收标准**：
- AC-5.1：种子播种后消耗1个种子
- AC-5.2：播种后在耕地上生成作物GameObject
- AC-5.3：作物从阶段0开始正常生长
- AC-5.4：播种时剩余种子自动标记为"已打开"状态

---

## 用户原始需求记录

### 第一次需求（2026-02-10）

> 对于所有农作物的种子都是用袋子装的，然后种子的袋子有两个状态，一个是打开一个是未打开，种子袋在未打开时保质期先暂时设计为默认7天，然后打开后保质期默认变为2天，过期后会变成腐烂的食物，腐烂的食物就是一个独立的物品，这个腐烂的食物没有保质期，所有的食物腐烂后都会变成这个腐烂的食物

> 对于所有农作物都存在四个生长阶段的样式还有拔出来的作物样式也就是五个，然后成熟后超过2天没有收割就会变枯，枯了后也有一个样式，枯萎拔出来的作物也有一个样式，也就是一共七个样式

> 对于所有作物的生长阶段间隔在Controller里面控制，SO只有两个，就是种子和作物

> 对于种子播种后就是作物正常生长了，样式就是按照树木控制器一样学习即可，成熟后收割的作物获取也是控制器进行完成处理

### 第二次需求补充（2026-02-11）

> 首先对于所有状态和内容都需要考虑可持久化，与当前存档内容结合起来

> 种子袋都是不可堆叠的，一个种子袋里面会有一定数量的种子，每个种子袋都是独立的，所以保质期也是独立的，这样不会有任何冲突

> 成熟后超过两天就是比如当前是春季14天，作物刚好成熟了，如果今天没有收割，到了第二天也就是春季15天，则累计加一，到了春季16天还没收割，则累计加2，此时直接枯萎

> 对于过季也是全部枯萎

> 枯萎作物是独立的SO，就是作物可以有多种，一个是正常的，一个是枯萎的，然后对于控制器应该是需要索引两种SO，随时进行切换

> 对于腐烂的食物是可以堆叠的，这个物品是属于食物，可以作为其他配方的内容，也可以独立食用，只是会有其他buff，后续我们设计buff的时候会对所有可食用内容都进行完善

> 对于收获的作物其实也是可食用的，也是食物，但是作物就是更加纯粹的来源，食物可以是加工过的，但是后续我们对食用内容可能会进行全面完善

---

## 设计约束

### C-1：SO精简原则
- 有三个SO类型：SeedData（种子）、CropData（作物）、WitheredCropData（枯萎作物）
- 不新增独立的种子袋SO
- 保质期运行时状态通过 InventoryItem 动态属性管理
- **种子袋不可堆叠**（stackable = false），每个种子袋是独立物品

### C-2：架构一致性
- 作物Sprite切换参考TreeController模式
- CropController保持自治模式（订阅TimeManager事件）
- 保持与现有存档系统兼容
- **所有运行时状态必须可持久化**（保质期、生长阶段、枯萎状态等）

### C-3：新增并兼容
- 所有修改不破坏现有功能
- 新增字段使用合理默认值，兼容旧存档
- CropInstanceData 新增字段默认值为0/false

### C-4：食物系统一致性
- 作物（CropData）继承自 FoodData，可食用
- 枯萎作物（WitheredCropData）继承自 FoodData，可食用（负面buff）
- 腐烂食物（RottenFoodData）继承自 FoodData，可堆叠，可作为配方材料

---

## 边界情况

### E-1：种子堆叠
- **种子袋不可堆叠**（stackable = false）
- 每个种子袋是独立物品，有独立的保质期状态
- 一个种子袋内有一定数量的种子（由SeedData.seedsPerBag配置）

### E-2：存档兼容
- 旧存档中的CropInstanceData没有daysSinceMature字段
- 加载时默认值为0，不影响已有作物
- 旧存档中的种子袋没有保质期状态，加载时默认为"未打开"状态

### E-3：季节影响
- **所有作物在季节切换时全部枯萎**（无论是否成熟）
- 枯萎后作物变为WitheredCropData，可以收割但产出枯萎作物
- 季节切换时CropController订阅SeasonManager事件触发枯萎

### E-4：可重复收获作物
- 可重复收获的作物（如草莓）成熟后不会枯萎
- 只有不可重复收获的作物才有"过熟枯萎"机制
- 可重复收获的作物在季节切换时仍然会枯萎

### E-5：腐烂食物
- "腐烂的食物"是全局唯一物品（RottenFoodData），可堆叠
- 腐烂食物可以丢弃、可以出售（低价）、可以作为配方材料
- 腐烂食物可以食用，但有负面buff（后续buff系统会完善）
- 腐烂食物不能种植、不能再次腐烂

### E-6：枯萎作物收割
- 枯萎作物可以收割，获得WitheredCropData物品
- 枯萎作物收割数量与正常收割相同（由SeedData.harvestAmountRange决定）
- 枯萎作物也是食物，可以食用（负面buff）
