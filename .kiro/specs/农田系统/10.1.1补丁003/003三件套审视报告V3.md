# 补丁003 三件套全面审视报告 V3

> 审视目标：逐条审核 design.md 和 tasks.md 的合理性、可实施性、遗漏风险
> 审视原则：基于当前会话中实际读取的代码事实，不凭记忆推断
> V3 说明：基于用户对第五点预览系统的进一步纠正（续13），修正种子预览方案。V2→V3 变更范围：第五点重写 + 漏洞清单更新 + 改进建议更新。其余章节（一~四、六）保持 V2 不变。

---

## 一、P1/P5 作物位置修复 — 父子物体方案

（与 V2 完全一致，不再重复。参见 V2 报告第一章。）

---

## 二、P3 队列逻辑修复：动画帧触发 tile 更新

（与 V2 完全一致，不再重复。参见 V2 报告第二章。）

---

## 三、P2 长按退化修复

（与 V2 完全一致，不再重复。参见 V2 报告第三章。）

---

## 四、P4 导航入队统一

（与 V2 完全一致，不再重复。参见 V2 报告第四章。）

---

## 五、P6 预览系统改造（V3 重写）

> V3 核心纠正：种子播种需要放置预览方框，直接复刻放置系统树苗放置效果。不需要方框的只是耕地和浇水。唯一需要重新设计的是队列缓存显示部分。

### 5.1 种子预览：复刻放置系统树苗放置效果 — ✅ 完全认可

用户方案：种子播种的预览直接复刻放置系统的树苗放置效果——底部格子方框 + 作物第一阶段 sprite 预览，有效/无效颜色处理与放置系统完全一致。

锐评：✅ 技术上可以直接复刻，方案干净合理。

代码事实支撑（当前会话实际读取）：

PlacementPreview 的树苗放置效果由两部分组成：
- 底部格子：`PlacementGridCell` 程序化生成 32×32 白色方框 sprite（边框 alpha=0.8，内部填充 alpha=0.3），通过 `SetValid(bool)` 切换颜色——有效 `validColor = new Color(0f, 1f, 0f, 0.4f)`（绿色），无效 `invalidColor = new Color(1f, 0f, 0f, 0.4f)`（红色）
- 物品预览：`itemPreviewRenderer`（SpriteRenderer）显示预制体 sprite，有效时 `Color.white`（原色 + alpha=itemPreviewAlpha），无效时 `new Color(1f, 0.5f, 0.5f)`（偏红 + alpha）

种子预览复刻需要的改动：

1. 获取作物第一阶段 sprite：
   - `stages` 是 `[SerializeField] private CropStageConfig[] stages`，外部无法直接访问
   - 需要在 CropController 添加公开方法：`public Sprite GetFirstStageSprite()` → 返回 `stages[0].normalSprite`
   - 调用路径：`seedData.cropPrefab.GetComponent<CropController>().GetFirstStageSprite()`

2. 底部格子：
   - 在 FarmToolPreview 中创建一个 `PlacementGridCell` 实例（或用同样的程序化 sprite 生成方式），1×1 格子
   - 颜色切换逻辑与放置系统完全一致（绿/红）

3. 物品预览 sprite：
   - 在 FarmToolPreview 中新增 `SpriteRenderer seedPreviewRenderer`
   - 显示作物第一阶段 sprite，位置需考虑作物 Prefab 的底部对齐偏移

4. 颜色处理（完全复刻 PlacementPreview）：
   - 有效：物品原色（alpha 降低），底部格子绿色
   - 无效：物品偏红 `new Color(1f, 0.5f, 0.5f)`，底部格子红色

5. 有效/无效判断：
   - 种子有效条件 = 目标格子是已耕地且无作物
   - FarmToolPreview 的 `UpdateSeedPreview` 中已有 `isFarmland && !hasCrop` 检查，可直接复用

6. 种子预览是 1×1 格子（一次种一格），比树苗放置更简单

### 5.2 耕地预览：取消方框，改为颜色覆盖 — ✅ 认可（方案C已锁定）

用户方案：耕地和浇水不需要放置方框，取消当前的 `cursorRenderer` 方框光标，改为整个 tile 的颜色覆盖（可交互=绿色，不可交互=红色）。

锐评：⚠️ 方向认可，但 `Tilemap.SetColor` 是乘法混合不是颜色叠加，需要选择正确的实现方案。

技术问题（V2 已指出，仍然有效）：
- `Tilemap.SetColor` 实际行为是乘法混合（tint）：棕色耕地 × 绿色 = 深绿棕色，不是用户想要的"绿色覆盖"
- design.md 的 `ghostTilemap.SetColor(pos, new Color(0, 1, 0, 0.3f))` 方案视觉效果不符预期

续12提出的三个替代方案（当前会话重新评估）：

方案A：自定义 Shader
- 给 GhostTilemap 的 TilemapRenderer 使用自定义 shader，接收 `_OverlayColor` 参数做颜色混合
- 优点：不需要额外 sprite，直接在现有 tile 上生效
- 缺点：`_OverlayColor` 是全局的，同一 Tilemap 上所有 tile 共享同一颜色。如果鼠标预览和队列预览在同一 Tilemap 上，无法对不同 tile 设不同颜色
- 但如果采用双 Tilemap 分离（5.5节），这个问题自然解决——鼠标预览 Tilemap 用带颜色覆盖的 shader，队列预览 Tilemap 用默认 shader

方案C：程序化 SpriteRenderer 覆盖层
- 不用 Tilemap，用半透明 SpriteRenderer 覆盖在 tile 上方
- 程序化生成纯色半透明方块（类似 PlacementGridCell 的 `CreateGridSprite`，但不要边框，只要纯色填充）
- 优点：颜色完全可控，不受 tile 原色影响，不需要 shader
- 缺点：用户说"不想用额外 sprite"，但程序化生成的 sprite 不需要美术资源（和当前 cursorRenderer 一样是代码生成的）

两个方案性能都没问题（耕地预览最多 1+8=9 个 tile）。

用户确认选择方案C（程序化 SpriteRenderer 覆盖层）。方案已锁定。

### 5.3 浇水预览：复刻耕地预览 + 随机水渍样式 — ✅ 认可

用户方案：学习耕地预览模式，每移到新格子随机显示 3 种水渍样式之一，支持队列缓存预览。

锐评：✅ 可行，资源已有。

代码事实支撑：
- `FarmVisualManager` 已有 `wetPuddleTiles`（`TileBase[]`，3种变体），这就是水渍 tile 资源
- 浇水预览可从 FarmVisualManager 获取这些 tile，放到 GhostTilemap 上显示
- 随机逻辑：每次 `cellPos` 变化时 `Random.Range(0, 3)` 选一个变体
- 颜色覆盖：和耕地一样，可交互=绿色叠加，不可交互=红色叠加
- 需要 FarmVisualManager 暴露公开方法获取水渍 tile，如 `public TileBase GetRandomPuddleTile()` 或 `public TileBase[] GetPuddleTiles()`

浇水预览只显示 1 个格子（不像耕地的 1+8），更简单。

### 5.4 队列预览区分：鼠标跟随 vs 已锁定 — ✅ 认可方向

用户方案：
- 鼠标跟随预览 = 带颜色叠加（绿/红），实时判断有效性
- 已锁定的队列预览 = 无颜色处理，带透明度的原始 tile/sprite

锐评：✅ 视觉区分清晰，交互语义明确。

### 5.5 预览架构分离：双 Tilemap + SpriteRenderer 对象池 — ✅ 推荐

V2 已指出的架构问题（V4 漏洞）：`ClearGhostTilemap` 会清除所有预览位置，包括队列预览。

推荐架构：

耕地/浇水预览（基于 Tilemap）：
- `ghostTilemap`（现有）→ 专门用于鼠标跟随预览（带颜色覆盖）
- 新增 `queuePreviewTilemap` → 专门用于队列锁定预览（原始 tile + 透明度，无颜色叠加）
- `ClearGhostTilemap` 只清除 `ghostTilemap`，不影响 `queuePreviewTilemap`
- 队列预览在入队时写入 `queuePreviewTilemap`，出队执行后清除对应位置
- WASD 中断时 `ClearAllQueuePreviews` 清除 `queuePreviewTilemap` 所有内容

种子预览（基于 SpriteRenderer）：
- 鼠标跟随：FarmToolPreview 中的 `seedPreviewRenderer` + `seedGridCell`（带颜色判断）
- 队列锁定：独立的 SpriteRenderer 对象池，每个锁定位置创建一个 sprite 实例（作物第一阶段 sprite + 降低 alpha + 无颜色叠加）
- WASD 中断时回收所有对象池实例

双 Tilemap 的额外好处：
- 如果耕地颜色覆盖用 shader 方案（方案A），鼠标预览 Tilemap 用带颜色覆盖的 shader，队列预览 Tilemap 用默认 shader + 降低 alpha，完美解决"同一 Tilemap 上不同 tile 不同颜色"的问题
- 新增一个 Tilemap 的性能开销可以忽略

### 5.6 性能评估 — ✅ 无问题

- 耕地预览最多 9 个 tile，浇水预览 1 个 tile，种子预览 1 个 SpriteRenderer + 1 个格子
- 队列预览最多十几个 tile/sprite（取决于队列长度上限）
- 无论用 shader、SpriteRenderer 还是 Tilemap，这个量级的渲染开销可以忽略
- 自定义 shader 如果只是简单的颜色混合（几行 HLSL），draw call 不会增加

### 5.7 V3 第五点总结

| 方案 | 判定 | 说明 |
|------|------|------|
| 种子预览复刻放置系统（含底部格子方框） | ✅ 认可 | 直接复刻树苗放置效果，需 CropController 添加公开方法 |
| 耕地颜色覆盖（取消方框） | ✅ 认可（方案C） | 程序化 SpriteRenderer 覆盖层，用户已确认 |
| 浇水随机水渍预览 | ✅ 认可 | wetPuddleTiles 已有3种变体，需暴露访问接口 |
| 队列预览区分 | ✅ 认可 | 鼠标跟随带颜色，队列锁定无颜色+透明 |
| 预览架构分离 | ✅ 推荐 | 双 Tilemap（耕地/浇水）+ SpriteRenderer 对象池（种子） |
| 性能 | ✅ 无问题 | 量级太小，任何方案都无性能瓶颈 |

所有方案已确认锁定，无待确认项。

---

## 六、跨问题交互风险

（与 V2 完全一致，不再重复。参见 V2 报告第六章。）

---

## 七、tasks.md 可实施性评估（V3 更新）

### 7.1 任务粒度评估

| 任务 | 粒度 | 评估 |
|------|------|------|
| 1. CropController 子物体改造 | ⚠️ 需重写 | 方案已变更为手动修改 Prefab，不再是运行时迁移 |
| 2. 松开分支时序修复 | ✅ 合理 | 简单明确 |
| 3. 动画帧触发机制 | ✅ 合理 | 需补充 `_pendingTileUpdate` 清理子任务 |
| 4. 长按支持 | ⚠️ 需修正 | 不应改 HandleUseCurrentTool 入口为 GetMouseButton |
| 5. 长按连续执行 | ✅ 合理 | OnActionComplete 长按分支处理，方向正确 |
| 6. 导航入队统一 | ✅ 合理 | 简化为统一入队即可 |
| 7-10. 预览改造 | ⚠️ 需重写 | 种子预览需要底部格子方框（复刻放置系统），耕地/浇水不需要方框 |
| 11. 多位置队列预览 | ⚠️ 需补充 | 双 Tilemap 分离 + SpriteRenderer 对象池 |
| 12. 集成验证 | ✅ 合理 | 覆盖面足够 |

### 7.2 需要修改的任务（V3 更新）

1. 任务1 重写：手动修改 Prefab 结构 + Editor 批量工具 + 全局搜索 transform.position 引用
2. 任务3 补充：`ClearActionQueue` 清理 `_pendingTileUpdate`
3. 任务4 删除或合并到任务5
4. 任务7-11 重写（V3 变更）：
   - 种子预览：复刻 PlacementPreview 效果（底部格子 + 物品 sprite + 颜色切换）
   - 耕地预览：取消方框，改为颜色覆盖（方案C：程序化 SpriteRenderer 覆盖层）
   - 浇水预览：随机水渍样式 + 颜色覆盖
   - 新增前置任务：CropController 添加 `GetFirstStageSprite()` 公开方法
   - 新增前置任务：FarmVisualManager 暴露水渍 tile 访问接口
   - 新增架构任务：双 Tilemap 分离（ghostTilemap + queuePreviewTilemap）
   - 新增架构任务：种子队列预览 SpriteRenderer 对象池

---

## 八、001/002 教训对照检查

（与 V2 完全一致，不再重复。参见 V2 报告第八章。）

---

## 九、漏洞清单与优先级（V3 更新）

| 编号 | 漏洞描述 | 风险等级 | 涉及问题 | V3 状态 |
|------|---------|---------|---------|---------|
| V1 | `ClearActionQueue` 未清理 `_pendingTileUpdate` | 高 | P3 | 保持 |
| V2 | 长按/松开分支清理顺序不一致 | 中 | P3 | 保持 |
| V3 | `Tilemap.SetColor` 是乘法混合不是颜色叠加 | 高（已有解决方案） | P6 | 方案C已锁定（程序化 SpriteRenderer 覆盖层） |
| V4 | ClearGhostTilemap 会清除队列预览 | 高 | P6 | 保持（双 Tilemap 分离方案已提出） |
| V5 | CropController.stages 是 private | 中 | P6 | 保持（种子预览需要公开方法） |
| V6 | design.md 任务4 方向错误 | 中 | P2 | 保持 |
| V7 | 外部代码可能依赖 CropController 的 transform.position | 中 | P1/P5 | 保持 |

V2→V3 漏洞变更说明：
- 漏洞数量不变（7个），但 V3 对 V3/V4/V5 的解决方案更加明确
- V3（颜色乘法）：现在明确只影响耕地和浇水，种子预览用 SpriteRenderer 不受此影响
- V4（预览冲突）：双 Tilemap 分离 + SpriteRenderer 对象池的完整架构方案已提出
- V5（stages private）：种子预览复刻放置系统需要此公开方法，优先级提升

### 高风险漏洞汇总（必须在更新 design.md 前解决）

1. V1 — `ClearActionQueue` 清理 `_pendingTileUpdate`：方案明确，直接加入 `_pendingTileUpdate = null`
2. V3 — 耕地/浇水颜色覆盖实现：用户已确认选择方案C（程序化 SpriteRenderer 覆盖层），方案已锁定
3. V4 — 预览架构分离：双 Tilemap + SpriteRenderer 对象池，方案已明确

---

## 十、改进建议汇总（V3 更新）

### 10.1 必须修改 design.md 的项目

1. P1/P5：方案从"运行时 Awake 迁移"改为"手动修改 Prefab 结构"
2. P2：删除任务4（不改 HandleUseCurrentTool 入口），保留任务5（OnActionComplete 长按分支）
3. P3：新增 `_pendingTileUpdate` 清理策略
4. P3：建议统一长按/松开分支的清理顺序
5. P6（V3 更新）：种子预览改为复刻放置系统效果（底部格子方框 + 物品 sprite + 颜色切换）
6. P6：耕地/浇水颜色覆盖方案已锁定为方案C（程序化 SpriteRenderer 覆盖层）
7. P6：新增预览架构分离方案（双 Tilemap + SpriteRenderer 对象池）
8. P6：CropController 添加 `GetFirstStageSprite()` 公开方法
9. P6：FarmVisualManager 暴露水渍 tile 访问接口

### 10.2 必须修改 tasks.md 的项目

1. 任务1 重写：手动修改 Prefab + Editor 工具 + 全局搜索 transform.position 引用
2. 任务3 补充：`ClearActionQueue` 清理 `_pendingTileUpdate`
3. 任务4 删除或合并到任务5
4. 任务7-11 重写（V3 变更）：种子预览复刻放置系统 + 耕地/浇水颜色覆盖 + 双 Tilemap 分离 + 对象池
5. 新增前置任务：CropController 和 FarmVisualManager 的接口暴露

---

> V3 审视完成。V2→V3 的核心变更：种子预览从"不需要底部方框"修正为"需要底部方框，直接复刻放置系统树苗放置效果"。耕地和浇水仍然不需要方框，改为颜色覆盖。队列缓存显示采用双 Tilemap + SpriteRenderer 对象池的分离架构。漏洞数量不变（7个），但预览系统的解决方案更加完整和明确。
