# 继承快照 - 会话3续20

## 用户 prompt 完整摘抄

你认为以上方案是否还存在交互漏洞？我认为可能还会存在，比如你之前完备的tasks实现后到现在始终是预览更新失败，我认为是需要让耕地的预览加载完再锁定，因为预览框很快就能响应更新，可是耕地的8+1预览会慢一些，这点需要你进行严格考虑，然后写出完整的分析报告，重新给出详细的全面审视，因为bug实在是太多我需要你彻底分析完毕每个问题的核心原因和核心漏洞以及不只是当前的描述的问题，你需要全面思考每个问题的交互矩阵情况，所有可能都需要考虑到，进行全面的考虑和预防，对于你认为需要确认的请你也写入，我会回应你，请你开始

## AI 进度摘要

**已完成**：
- 读取 TryTillSoil 完整实现（1187-1277行）— 锁定+距离分流+导航回调
- 读取 TryWaterTile 完整实现（1322-1413行）— 同上结构
- 读取 StartFarmingNavigation 完整实现（1840-1880行）— 不调用 CancelFarmingNavigation
- 读取 WaitForNavigationComplete 协程（1882-1973行）— 到达后 try/finally 解锁

**未完成**：
- 读取 TryPlantSeed 完整实现
- 读取 UpdateWateringPreview 完整实现（确认浇水预览的锁定行为）
- 读取 FarmlandBorderManager.GetPreviewTiles（1+8 预览加载时序，用户重点关注）
- 读取 ExecuteTillSoil / ExecuteWaterTile（执行逻辑）
- 全面分析方案 A-E 的交互漏洞（核心任务）
- 分析 1+8 预览加载时序问题（用户明确指出的关键点）
- 分析所有交互矩阵场景（耕地/浇水/种子 × 近距离/远距离 × 动画中/导航中/空闲 × 单击/连续点击/长按）
- 创建完整分析报告文件（001分析.md 或类似）
- 输出分析报告供用户确认

## 修改文件列表

无（本轮只读取了代码）

## 本轮关键决策与用户偏好

**用户核心诉求**：
1. **方案 A-E 可能还有漏洞**：用户不满足于表面修复，要求彻底分析
2. **1+8 预览加载时序**：用户明确指出"耕地的8+1预览会慢一些"，需要让预览加载完再锁定
3. **全面交互矩阵**：不只是当前描述的问题，所有可能都需要考虑到
4. **写入分析报告文件**：不是对话中口头分析，要创建完整的分析报告文档
5. **需要确认的也写入**：用户允许 AI 提出疑问，会回应

**用户偏好**：
- 要求"彻底分析完毕每个问题的核心原因和核心漏洞"
- 要求"全面思考每个问题的交互矩阵情况"
- 要求"全面的考虑和预防"
- 先分析后实现（先设计后实现原则）

## 关联文件与待同步状态

| 文件 | 状态 |
|------|------|
| `GameInputManager.cs` | TryTillSoil/TryWaterTile/StartFarmingNavigation/WaitForNavigationComplete 已读取；TryPlantSeed/ExecuteTillSoil/ExecuteWaterTile 待读取 |
| `PlayerInteraction.cs` | 上轮（续19）已完整读取，OnActionComplete 长按分支已了解 |
| `FarmToolPreview.cs` | 上轮（续19）已读取 LockPosition/UnlockPosition/UpdateRealtimeData/UpdateHoePreview；UpdateWateringPreview 待读取 |
| `FarmlandBorderManager.cs` | 待读取 GetPreviewTiles（1+8 预览加载时序，用户重点关注） |
| `design.md` | 上轮已读取 1.2 节 |
| `requirements.md` | 上轮已读取 AC-1.1~AC-1.6 |

## 遗留问题完整上下文

### 问题背景

续19 输出了 5 个修复方案（A-E），用户审视后认为：
1. 方案可能还有漏洞
2. 1+8 预览加载时序是关键问题（预览框快，1+8 慢，需要加载完再锁定）
3. 需要全面的交互矩阵分析，不只是当前 3 个问题

### 续19 的 5 个方案（待审视漏洞）

- **方案 A**：`CacheFarmInput` 中调用 `LockPosition` 锁定预览到缓存位置
  - 潜在漏洞：`LockPosition` 调用 `UpdateCursor` 刷新光标，但 1+8 GhostTilemap 预览不会被刷新（因为 `UpdateHoePreview` 中 `if (_isLocked) return` 跳过了 GhostTilemap 更新）
  - 用户指出的问题：需要让 1+8 预览加载完再锁定

- **方案 B**：Crush 动作（锄头）不触发长按继续
  - 潜在漏洞：需要确认 `IsToolAction` 中移除 Crush 后，其他使用 Crush 的场景是否受影响

- **方案 C**：浇水有缓存时走松开分支消费缓存
  - 潜在漏洞：浇水长按继续时，如果有缓存走松开分支，但松开分支的 `ConsumePendingFarmInput` 会触发 `ProcessFarmInputAt`，此时 `isPerformingAction` 已经是 false 了吗？

- **方案 D**：`ConsumePendingFarmInput` 中先 `UnlockPosition`
  - 潜在漏洞：解锁后 `ProcessFarmInputAt` 内部调用 `ForceUpdatePreviewToPosition` 会重新更新预览，但此时预览已解锁，下一帧 `UpdatePreviews` 会用鼠标位置覆盖

- **方案 E**：WASD 移动时清除缓存 + 解锁
  - 潜在漏洞：`HandleMovement` 中有两个分支（autoNavigator.IsActive 和 _farmNavState != Idle），需要两个都加

### 下一步

1. 读取 FarmlandBorderManager.GetPreviewTiles（1+8 预览加载时序）
2. 读取 TryPlantSeed / UpdateWateringPreview / ExecuteTillSoil / ExecuteWaterTile
3. 全面分析所有交互矩阵场景
4. 分析方案 A-E 的每个漏洞
5. 创建完整分析报告文件
6. 输出报告供用户确认
