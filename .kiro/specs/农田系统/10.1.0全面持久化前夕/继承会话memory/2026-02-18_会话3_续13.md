# 继承快照 - 会话3续13

## 用户 prompt 完整摘抄

> 首先对于缓存的不只是缓存输入左键这个操作，而是应该还要缓存当时左键的位置，你认为呢？这样才能正确复原并执行动画结束前最后一个输入的精确位置啊，现在就变成我动画结束前左键一下，然后结束后鼠标放到哪里你就读取哪里的，然后再过去交互，这是不对的孩子

## AI 进度摘要

### 已完成
- 确认用户反馈的问题：输入缓存设计缺陷
- 分析问题根因：`CacheFarmInput()` 只缓存 itemId，没有缓存点击时的世界坐标
- 开始搜索 `CacheFarmInput` 方法的实现位置

### 未完成
- [ ] 修改 `CacheFarmInput()` 方法，增加世界坐标参数
- [ ] 修改所有调用点（4处），传入当前鼠标世界坐标
- [ ] 修改 `ConsumePendingFarmInput()` 使用缓存的坐标而非实时鼠标位置
- [ ] 编译验证
- [ ] 更新 memory

## 修改文件列表

本轮无代码修改（被压缩中断）

## 本轮关键决策与用户偏好

- 用户明确指出：输入缓存必须同时缓存**点击时的世界坐标**
- 正确行为：动画期间点击 → 缓存坐标 → 动画结束 → 使用缓存坐标执行
- 错误行为（当前）：动画期间点击 → 只缓存 itemId → 动画结束 → 读取实时鼠标位置

## 关联文件与待同步状态

| 文件 | 状态 |
|------|------|
| `GameInputManager.cs` | 待修改（CacheFarmInput/ConsumePendingFarmInput） |
| `_pendingFarmWorldPos` 字段 | 已存在但未使用 |

## 遗留问题完整上下文

### 问题背景
10.1.0 任务中实现了输入缓存机制（AC-1.1），但设计有缺陷：
- `_hasPendingFarmInput` - 是否有缓存 ✅
- `_pendingFarmItemId` - 缓存的物品 ID ✅
- `_pendingFarmWorldPos` - 缓存的世界坐标 ❌ 字段存在但未使用

### 当前代码问题
```csharp
// CacheFarmInput 只缓存 itemId
private void CacheFarmInput(int itemId)
{
    _hasPendingFarmInput = true;
    _pendingFarmItemId = itemId;
    // ❌ 没有缓存 _pendingFarmWorldPos
}
```

### 修复方案
1. `CacheFarmInput(int itemId)` → `CacheFarmInput(int itemId, Vector3 worldPos)`
2. 所有调用点传入 `GetMouseWorldPosition()`
3. `ConsumePendingFarmInput()` 使用 `_pendingFarmWorldPos` 而非实时鼠标位置
