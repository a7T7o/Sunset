# 农田系统全面审查报告 V2

> 审查时间：2026-02-17
> 审查范围：农田系统全部代码 + 全部工作区文档
> 审查方法：逐文件阅读代码实现，对照需求文档和 memory 记录，验证每个功能点的真实状态
> 本报告替代 `10.1.0全面持久化前夕/全面审查报告.md`（V1 杂乱冗余，本版精简重写）

---

## 一、动作生命周期系统（核心缺陷）

这是当前农田系统最严重的架构问题。影响锄头、水壶、种子三种工具的全部交互。

### 1.1 问题本质

每个工具动画的播放 = 一个动作的完整生命周期。动画开始 = 动作开始，动画结束 = 动作完毕。下一次输入应该启动一个新的完整动作链（判断有效性 → 导航 → 到达 → 执行 → 动画 → 完成）。

当前代码没有这个概念。`HandleUseCurrentTool` 用 `IsPerformingAction()` 一刀切地吞掉所有输入，没有缓存机制，导致动画期间的输入全部丢失。

### 1.2 代码事实链

```
HandleUseCurrentTool() 第 654 行：
  bool isPerformingAction = playerInteraction.IsPerformingAction();
  if (isPerformingAction) return;  ← 所有输入在此被吞掉
```

`PlayerInteraction.IsPerformingAction()` 返回 `isPerformingAction` 字段，该字段在 `StartAction()` 中设为 true，在 `OnActionComplete()` 中才设为 false。动画时长由 `toolAnimationDuration`（默认 0.8s）控制。

关键发现：`PlayerInteraction.OnActionComplete()` 已经有长按继续逻辑：
```csharp
bool isCurrentlyHolding = Input.GetMouseButton(0);
bool shouldContinue = isCurrentlyHolding && IsToolAction(currentAction);
if (shouldContinue) { StartAction(actionToRepeat, true); }
```

但这个长按逻辑对农田工具无效，因为：
1. `OnActionComplete` 只是重新播放同一个动画（`StartAction(actionToRepeat, true)`）
2. 它不会重新调用 `TryTillSoil` / `TryWaterTile` — 不会检查新位置、不会更新预览、不会执行耕地/浇水
3. 结果：长按时动画循环播放，但没有任何实际效果（因为第一次已经执行了 `ExecuteTillSoil`）

### 1.3 三个具体 Bug

**Bug A：动画期间点击新位置无响应**
- 现象：耕地动画播放中点击其他位置，玩家原地播放动画不移动
- 根因：`IsPerformingAction()` return 吞掉输入，无缓存
- 影响：锄头、水壶、种子全部受影响

**Bug B：长按左键对同一块地重复播放动画**
- 现象：长按时动画循环播放，看起来在反复耕同一块地
- 根因：`PlayerInteraction.OnActionComplete()` 检测到长按 → 重新 `StartAction` → 动画重播
- 但 `ExecuteTillSoil` 只在第一次调用，后续动画纯粹是空播放（`CanTillAt` 返回 false 阻止重复耕地）
- 实际危害：视觉误导（看起来在耕但没效果），浪费精力值（每次 `StartAction` 都消耗）

**Bug C：导航中点击新位置，预览不更新**
- 现象：导航去 A 点途中点击 B 点，预览仍显示 A 点，但实际耕的是 B 点
- 根因：`HandleUseCurrentTool` 第 622-639 行的重新点击逻辑
  时序：`CancelFarmingNavigation()` 解锁旧预览 → 同帧 `TryTillSoil` 读取实时数据（B 点）→ 立即锁定 B 点
  `LockPosition()` 只设置 `_isLocked=true` 和坐标，不刷新视觉
  预览视觉仍冻结在 A 点的位置，直到下一帧 `UpdatePreviews` 才会更新
  但下一帧时已经被锁定到 B 点了，所以视觉直接跳到 B 点的锁定状态，没有过渡

### 1.4 修复方向

**核心思路：输入缓存 + 动作链管理**

动画播放期间的新输入不应被丢弃，而应被缓存。动画结束时检查缓存，有缓存则启动新的完整动作链。

状态机模型：
```
Idle → 等待输入
  ↓ 点击
Evaluating → 判断有效性 + 距离
  ↓ 近距离          ↓ 远距离
Executing          Navigating
  ↓ 动画结束         ↓ 到达
CheckBuffer        Executing
  ↓ 有缓存           ↓ 动画结束
Evaluating         CheckBuffer
  ↓ 无缓存
Idle
```

缓存规则：
- 只保留最后一次输入（后来的覆盖前面的）
- 缓存内容：鼠标世界坐标（不缓存 cellPos，因为到执行时鼠标可能已移动）
- 长按处理：动画结束时如果仍在长按，自动以当前鼠标位置作为缓存输入
- 导航中重新输入：更新导航目的地 + 更新预览到新位置 + 重新锁定

`LockPosition` 修复：锁定时自动刷新一次视觉到锁定位置，保证视觉和数据一致。

---

## 二、水渍与土壤视觉系统

### 2.1 当前状态（已确认可用）

水渍显示问题已解决。用户已在 Inspector 中正确配置：
- `FarmVisualManager.wetPuddleTiles` 数组：Tile_Water_A/B/C 三个变体
- `LayerTilemaps.waterPuddleTilemapNew`：需确认每个楼层是否已配置

浇水逻辑链路完整：
```
TryWaterTile → ExecuteWaterTile → FarmTileManager.SetWatered()
  → tileData.SetWatered(waterTime, puddleVariant)
  → moistureState = WetWithPuddle
  → FarmVisualManager.UpdateTileVisual() → 显示水渍 Tile
```

水渍消退链路完整：
```
OnHourChanged() → 遍历 wateredTodayTiles
  → hoursSinceWatering >= hoursUntilPuddleDry（默认 2 小时）
  → moistureState = WetDark → UpdateTileVisual() → 清除水渍 Tile
```

日结重置链路完整：
```
OnDayChanged() → ResetDailyWaterState()
  → wateredYesterday = wateredToday
  → wateredToday = false
  → moistureState = Dry
  → RefreshAllTileVisuals()
```

### 2.2 缺失功能：干燥/湿润耕地 Tile 渲染

当前 `UpdateTileVisual` 只处理水渍叠加层（`puddleTilemap`），不修改耕地本身的 Tile。

`FarmVisualManager` Inspector 中有两个未使用的字段：
- `Dry Farmland Tile`（干燥耕地 Tile）— 当前为空
- `Wet Dark Tile`（湿润深色 Tile）— 当前为空

这两个字段在 `UpdateTileVisual` 中完全没有被使用。当前代码只操作 `puddleTilemap`（水渍叠加层），不操作 `farmTilemap`（耕地层）。

用户需求：
1. 刚锄的地 = 干燥耕地 Tile
2. 浇水后 = 水渍叠加 + 耕地保持干燥
3. 水渍消退后（游戏时间半小时内渐变）→ 耕地变为湿润深色 Tile
4. 这个过程要灵动，不是瞬间切换

实现思路：
- `UpdateTileVisual` 中根据 `moistureState` 同时更新 `farmTilemap` 的 Tile
- `Dry` → 使用 `dryFarmlandTile`
- `WetWithPuddle` → 耕地层保持 `dryFarmlandTile`，水渍层显示 `wetPuddleTiles[variant]`
- `WetDark` → 耕地层切换为 `wetDarkTile`，水渍层清除
- 渐变效果：可以用 Shader 或分阶段 Tile 实现（需要讨论具体方案）

### 2.3 存档字段缺失（P0）

`FarmTileSaveData` 当前只存 5 个字段：`tileX`/`tileY`/`layer`/`soilState`/`isWatered`

缺失 3 个字段：

| 缺失字段 | 影响 | 修复方案 |
|---------|------|---------|
| `wateredYesterday` | 加载后丢失"昨天浇水"信息，当天作物不生长 | 新增字段，默认 false |
| `waterTime` | 加载后水渍视觉无法恢复（默认 -1f = 干燥） | 新增字段，默认 -1f |
| `puddleVariant` | 加载后水渍变体丢失 | 新增字段，默认 0 |

`Save()` 方法（第 606 行）只写入 5 个字段。
`CreateTileFromSaveData()` 方法（第 750 行）只恢复 5 个字段，`wateredYesterday`/`waterTime`/`puddleVariant` 全部使用默认值。

---

## 三、各模块完成度总览

### 3.1 完全可用的模块

| 模块 | 核心类 | 状态 |
|------|--------|------|
| 耕地创建/管理 | FarmTileManager | ✅ 多楼层字典存储，CreateTile/CanTillAt/RemoveTile 完整 |
| 浇水逻辑 | FarmTileManager.SetWatered | ✅ 防重复浇水、水渍变体、时间记录 |
| 耕地边界 | FarmlandBorderManager | ✅ 15 种边界 Tile + 阴影 + 预览 |
| 作物状态机 | CropController | ✅ Growing/Mature/WitheredImmature/WitheredMature 四状态 |
| 作物生长 | CropController.HandleGrowingDay | ✅ 累加模式、浇水依赖、枯萎机制 |
| 收获掉落 | CropController.HarvestMature | ✅ WorldSpawnService.SpawnMultiple 掉落模式 |
| 作物存档 | CropSaveData | ✅ 所有运行时字段完整覆盖 |
| 作物重建 | DynamicObjectFactory.TryReconstructCrop | ✅ seedId → SeedData → cropPrefab → 实例化 → Load |
| 预览系统 | FarmToolPreview | ✅ 锄头/水壶/种子三种模式，锁定/解锁机制 |
| 播种链路 | GameInputManager.ExecutePlantSeed | ✅ 直接 Instantiate cropPrefab，绕过废弃的 CropManager |
| 种子袋 | SeedBagHelper | ✅ 保质期、日结过期检查、腐烂食物合并 |

### 3.2 有缺陷但可用的模块

| 模块 | 问题 | 严重度 |
|------|------|--------|
| 耕地存档 | 缺 3 个字段（wateredYesterday/waterTime/puddleVariant） | P0 |
| 工具交互 | 动作生命周期缺失（见第一章） | P0 |
| 水渍视觉 | 配置已修复，但缺干燥/湿润 Tile 渲染 | P1 |

### 3.3 未实现的模块

| 模块 | 来源 | 说明 |
|------|------|------|
| 智能交互（自动导航+到达执行） | 9.0.4 设计 | 设计完成但未实现，距离不够时仍是红色光标+无效 |
| Collect 动画集成 | 10.0.3 US-3 | 收获是即时执行，无弯腰拔起动画 |
| 经验值接入 | SeedData.plantingExp/harvestingExp | 字段存在但未接入 Controller |
| Tooltip 生长周期 | growthDays 已删除 | 无数据源显示总生长天数 |

---

## 四、`PlayerInteraction` 与 `GameInputManager` 的职责冲突

这是导致动作生命周期问题的架构根因。

`PlayerInteraction` 负责：
- 动画播放控制（`StartAction` / `OnActionComplete`）
- 长按检测（`OnActionComplete` 中检查 `Input.GetMouseButton(0)`）
- 动作锁定（`isPerformingAction` 标志）
- 方向缓存和 Hotbar 缓存（通过 `ToolActionLockManager`）

`GameInputManager` 负责：
- 输入检测（`HandleUseCurrentTool` 中 `GetMouseButtonDown(0)`）
- 工具路由（锄头/水壶/种子/武器）
- 农田导航（`StartFarmingNavigation` / `WaitForNavigationComplete`）
- 预览管理（`UpdatePreviews`）
- 实际执行（`ExecuteTillSoil` / `ExecuteWaterTile` / `ExecutePlantSeed`）

冲突点：
1. `GameInputManager` 用 `IsPerformingAction()` 阻止新输入 → 但 `PlayerInteraction` 自己有长按继续逻辑
2. `PlayerInteraction.OnActionComplete()` 的长按继续只重播动画，不通知 `GameInputManager` 执行新的农田操作
3. 两个系统各自管理状态，没有统一的动作生命周期协议

正确的职责划分应该是：
- `PlayerInteraction`：只管动画播放和计时，提供"动画结束"回调
- `GameInputManager`：管理输入缓存、动作链、导航、执行，在动画结束时决定下一步

---

## 五、问题优先级清单

### P0 — 必须修复

| # | 问题 | 影响 |
|---|------|------|
| 1 | 动作生命周期缺失（输入缓存） | 连续操作失效、长按空播动画、预览跳变 |
| 2 | FarmTileSaveData 缺 3 字段 | 存档后浇水状态丢失 |

### P1 — 建议修复

| # | 问题 | 影响 |
|---|------|------|
| 3 | 干燥/湿润耕地 Tile 未渲染 | 耕地视觉单一，无浇水前后对比 |
| 4 | LockPosition 不刷新视觉 | 导航中重新点击时预览跳变 |
| 5 | ToolData.effectRadius 仍是 int | 不支持小数半径 |

### P2 — 后续迭代

| # | 问题 | 影响 |
|---|------|------|
| 6 | 智能交互未实现 | 远距离无法自动导航 |
| 7 | Collect 动画未集成 | 收获无动画反馈 |
| 8 | 经验值未接入 | 种植/收获不给经验 |
| 9 | Tooltip 生长周期无数据源 | 无法显示总生长天数 |
| 10 | 耕地持久化完善 | 需要完整的存档/读档测试 |

---

## 六、废弃代码清单

| 文件/字段 | 状态 | 说明 |
|-----------|------|------|
| CropManager.cs | 整类 `[Obsolete]` | 被 CropController 直接实例化替代 |
| CropInstance.cs | 整类 `[Obsolete]` | 被 CropInstanceData + CropController 替代 |
| LayerTilemaps.farmlandTilemap | `[Obsolete]` | 被 farmlandCenterTilemap 替代 |
| LayerTilemaps.waterPuddleTilemap | `[Obsolete]` | 被 waterPuddleTilemapNew 替代 |
| SeedData.needsWatering | `[Obsolete]` | 迁移到 CropController |
| CropData.seedID/witheredCropID/harvestExp | `[Obsolete]` | 数据流改为单向 |
| WitheredCropData.seedID | `[Obsolete]` | 数据流改为单向 |
| FarmTileSaveData 旧作物字段 | `[Obsolete]` | cropId/cropGrowthStage 等 5 个 |

---

## 七、工作区进程索引

| 工作区 | 完成度 | 核心产出 |
|--------|--------|---------|
| 9.0.1 重生之我在种田 | 80% | 基础耕地系统框架 |
| 9.0.2 放置农田 | 80% | FarmToolPreview 联邦制 |
| 9.0.3 预览农田 | 90% | 动态 Layer/障碍物/距离/种子预览 |
| 9.0.4 智能交互升级 | 30% | 设计完成，代码未实现 |
| 9.0.5 智能交互 bug 修复 | 100% | 锁定机制/预览修复 |
| 10.0.1 农作物设计与完善 | 100% | CropController 状态机/存档 |
| 10.0.2 农BUG农SO | 100% | CropStageConfig Prefab 驱动 |
| 10.0.2.1 纠正 | 100% | 废弃 CropManager/掉落模式/播种重写 |
| 10.0.3 收获DropTable与动画 | 80% | 掉落完成，Collect 动画待集成 |
| 10.1.0 全面持久化前夕 | 30% | 审查报告完成，bug 分析完成 |
