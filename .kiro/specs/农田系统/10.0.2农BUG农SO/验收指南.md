# 10.0.2 农作物视觉层 Prefab 驱动重构 — 验收指南

## 一、重构概述

将作物 Sprite 配置从 SeedData SO 迁移到 CropController Prefab 的 `CropStageConfig[]` 数组上，学习 TreeController 的 Prefab 驱动模式。业务逻辑（状态机/收获/枯萎/保质期/存档）一行不动。

## 二、编译验证 ✅

- Unity 重编译：零错误零警告
- CropSystemTests：16/16 全部通过（状态转换、种子袋保质期、腐烂食物堆叠、收获产出、过季枯萎）

## 三、代码改动清单

| 文件 | 改动类型 | 说明 |
|------|---------|------|
| `CropStageConfig.cs` | 新建 | 作物阶段配置结构体（normalSprite + witheredSprite） |
| `CropController.cs` | 修改 | 新增 stages[] 字段，GetCurrentSprite/UpdateGrowthStage/IsMatureStage 等从 stages 读取 |
| `SeedData.cs` | 修改 | 删除 growthStageSprites/witheredStageSprites，新增 cropPrefab |
| `CropManager.cs` | 修改 | TryHarvest 阶段计算改用 controller.GetTotalStages() |
| `CropInstance.cs` | 修改 | Obsolete 方法兼容处理 |
| `DynamicObjectFactory.cs` | 修改 | 新增 TryReconstructCrop + Crop 分支 + CropController SetPersistentId |
| `Tool_BatchItemSOGenerator.cs` | 修改 | DrawSeedSettings 新增 cropPrefab 绘制，CreateSeedData 新增赋值 |
| `farming.md` | 修改 | 更新 SeedData 字段描述、新增 CropStageConfig、更新重建说明 |

## 四、手动验收步骤

### 步骤 1：Prefab 配置验证
1. 打开任意作物 Prefab（如果已有）
2. 在 CropController 组件上应能看到 `Stages` 数组
3. 每个元素有 `Normal Sprite` 和 `Withered Sprite` 两个字段
4. 配置 4 个阶段的 Sprite 后，Inspector 应正常显示

### 步骤 2：SeedData SO 验证
1. 打开任意 SeedData SO
2. 应能看到 `Crop Prefab` 字段（在"作物预制体"分组下）
3. 不应再看到 `Growth Stage Sprites` 和 `Withered Stage Sprites` 字段
4. 拖入作物 Prefab 后，OnValidate 应验证 CropController 组件存在

### 步骤 3：批量工具验证
1. 打开 Tools > 📦 批量生成物品 SO
2. 选择 种植类 > 种子
3. 应能看到"作物预制体"区域和 `作物 Prefab` 的 ObjectField
4. 拖入 Prefab 后应显示"✓ 预制体包含 CropController 组件"

### 步骤 4：运行时验证（需要配置好 Prefab 后）
1. 种植种子 → 作物应正常显示对应阶段 Sprite
2. 浇水生长 → 阶段递进，Sprite 正确切换
3. 枯萎 → 显示枯萎 Sprite（向前回退查找非空）
4. 收获 → 正常产出，可重复收获作物正确重置
5. 存档/读档 → 作物状态完整恢复

## 五、存档兼容性

存档格式完全不变（seedId/currentStage/grownDays/isWithered 等字段不变），旧存档可正常加载。唯一前提：对应的 SeedData SO 需要配置好 cropPrefab 引用。

## 六、回滚方案

如果需要回滚：
1. 恢复 SeedData 的 growthStageSprites/witheredStageSprites 字段
2. 恢复 CropController 从 seedData 读取 Sprite 的逻辑
3. 移除 CropStageConfig.cs 和 stages 字段
4. 存档数据无需任何修改
