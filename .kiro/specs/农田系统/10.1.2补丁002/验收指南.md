# 10.1.1 补丁002 — 运行时验收指南

> 版本：补丁002 V3（FIFO 操作队列）
> 测试环境：Unity Editor Play Mode
> 前提条件：
> - 场景中有可耕地、已耕地（可浇水）、已种植作物（各生长阶段）、成熟作物、枯萎成熟作物
> - 快捷栏中准备好：锄头、浇水壶、种子、镐子、斧头、武器
> - 场景中有多层级区域（用于层级隔离测试）
> - 有可打开的面板（背包/箱子等）

---

## 一、左键点击入队矩阵（S1-S11）

- [ ] S1：手持任意物品，左键点击同层级的成熟作物 → 入队 Harvest，玩家走过去执行收获动画并收获（CP-5）
- [ ] S1b：手持任意物品，左键点击同层级的枯萎成熟作物 → 同样入队 Harvest 并收获（CP-5）
- [ ] S2：手持任意物品，左键点击不同层级的成熟作物 → 不触发收获，走后续工具/种子逻辑（CP-6）
- [ ] S3：手持锄头，鼠标在可耕地上（预览 Valid），左键点击 → 入队 Till，玩家走过去锄地（CP-9）
- [ ] S3b：队列非空时重复 S3 点击不同格子 → 多个 Till 操作按点击顺序依次执行（CP-1）
- [ ] S4：手持锄头，鼠标在不可耕地上（预览 Invalid），左键点击 → 无操作（CP-9）
- [ ] S5：手持浇水壶，鼠标在可浇水地上（预览 Valid），左键点击 → 入队 Water，玩家走过去浇水（CP-9）
- [ ] S6：手持浇水壶，鼠标在不可浇水地上（预览 Invalid），左键点击 → 无操作（CP-9）
- [ ] S7：手持种子，鼠标在可种植地上（预览 Valid），左键点击 → 入队 PlantSeed，玩家走过去种植（CP-9）
- [ ] S8：手持种子，鼠标在不可种植地上（预览 Invalid），左键点击 → 无操作（CP-9）
- [ ] S9：手持镐子/斧头/武器，鼠标位置无成熟作物，左键点击 → 走原有工具/武器逻辑，不入队（CP-19）
- [ ] S10：空手，鼠标位置无成熟作物，左键点击 → 无操作
- [ ] S11：队列非空时，左键点击已入队的同一格子 → 忽略，不重复入队（CP-2）

---

## 二、队列执行期间点击矩阵（E1-E6）

- [ ] E1：队列正在执行（`_isExecutingFarming = true`），左键点击有效农田目标 → 新操作入队，当前操作完成后自动执行（CP-11）
- [ ] E2：动画播放中（`isPerformingAction = true`），左键点击有效农田目标 → 新操作入队（CP-11）
- [ ] E3：玩家正在导航到目标格子，左键点击同一格子 → 忽略（CP-2）
- [ ] E4：玩家正在导航到目标格子，左键点击不同的有效格子 → 新操作入队，导航完成后按顺序执行（CP-1）
- [ ] E5：队列暂停（面板打开），左键点击任意位置 → 不处理（CP-13）
- [ ] E6：队列正在执行，左键点击同层级成熟作物 → 入队 Harvest（CP-5/CP-11）

---

## 三、中断矩阵

### 3.1 WASD 移动中断

- [ ] 队列执行期间按 WASD → 队列清空、导航取消、预览恢复鼠标跟随、锁定 ForceUnlock，玩家立即开始移动（CP-12）
- [ ] 远距离导航途中按 WASD → 同上，导航立即取消（CP-12）

### 3.2 ESC 中断

- [ ] 队列执行期间按 ESC → 队列清空、导航取消、预览恢复跟随、锁定解除（CP-3）

### 3.3 切换快捷栏中断

- [ ] 队列执行期间切换快捷栏 → 队列清空、导航取消、预览隐藏或切换模式、锁定解除（CP-3）
- [ ] 动画播放期间切换快捷栏 → 队列清空、预览切换模式、锁定解除（CP-3）

### 3.4 面板暂停/恢复

- [ ] 队列有多个操作排队时打开面板 → 队列暂停（不清空），当前导航取消，预览保持锁定（CP-4/CP-13）
- [ ] 关闭面板 → 队列恢复执行，导航重新开始，预览锁定到下一个目标（CP-13）
- [ ] 暂停前队列中有 3 个操作，关闭面板后确认剩余操作仍按原顺序执行（CP-4）

### 3.5 种子用完

- [ ] 快捷栏种子数量为 3，连续点击 5 块可种植地 → 前 3 块种植成功，后 2 个请求被自动丢弃（CP-10）
- [ ] 种子用完后队列中如有其他类型操作（如 Till），仍继续执行

---

## 四、预览状态矩阵

- [ ] 队列为空，无操作 → 预览跟随鼠标实时显示（CP-14）
- [ ] 队列执行中（近距离操作）→ 预览锁定到当前目标位置，锄头模式显示 1+8（CP-14/CP-15）
- [ ] 队列执行中（远距离导航）→ 预览锁定到当前目标位置，锄头模式显示 1+8（CP-14/CP-15）
- [ ] 队列暂停（面板打开）→ 预览保持锁定在暂停时的位置（CP-13）
- [ ] 队列刚清空（WASD/ESC 中断后）→ 预览解锁，恢复鼠标跟随（CP-14）

---

## 五、OnActionComplete 分支矩阵

### 5.1 收获（Collect）

- [ ] 成熟作物收获动画完成 → 走专用分支，执行收获逻辑，自动取队列下一个操作（CP-17）
- [ ] 收获不受鼠标是否按住影响（Collect 不走 IsToolAction 长按逻辑）（CP-17）

### 5.2 锄地（Crush）

- [ ] 锄地动画完成，鼠标按住 → OnFarmActionAnimationComplete → 自动取队列下一个（CP-18）
- [ ] 锄地动画完成，鼠标松开 → 同上，仍走队列出队（CP-18）

### 5.3 浇水（Watering）

- [ ] 浇水动画完成，鼠标按住 → OnFarmActionAnimationComplete → 自动取队列下一个（CP-18）
- [ ] 浇水动画完成，鼠标松开 → 同上，仍走队列出队（CP-18）

### 5.4 斧头（Slice）

- [ ] 斧头动画完成，鼠标按住 → 保持原有长按连续砍伐行为（CP-19）
- [ ] 斧头动画完成，鼠标松开 → 保持原有松开行为（CP-19）

### 5.5 镐子（Pierce）

- [ ] 镐子动画完成，鼠标按住 → 保持原有长按连续挖掘行为（CP-19）
- [ ] 镐子动画完成，鼠标松开 → 保持原有松开行为（CP-19）

---

## 六、队列二次验证矩阵

- [ ] Till 操作：到达目标后直接执行，无额外验证
- [ ] Water 操作：到达目标后直接执行，无额外验证
- [ ] PlantSeed 操作：执行前检查手持仍为种子且数量 > 0，不满足则丢弃该请求并取下一个（CP-10）
- [ ] Harvest 操作：执行前检查 targetCrop 不为 null 且 CanInteract() 为 true，不满足则丢弃并取下一个（CP-7）
- [ ] 验证场景：排队收获某作物，在执行前被其他方式收获（如果可能）→ 二次验证失败，自动跳过

---

## 七、额外验证项

### 7.1 作物底部对齐（CP-16）

- [ ] 观察作物各生长阶段（种子→幼苗→成长→成熟）的 Sprite 底部中心是否对齐格子中心
- [ ] 枯萎作物的 Sprite 底部中心是否对齐格子中心
- [ ] 存档加载后作物对齐是否正确

### 7.2 LockPosition 渲染 1+8（CP-15）

- [ ] 锄头模式，远距离左键点击可耕地 → 1+8 预览立即刷新到锁定位置（不是停留在鼠标位置）
- [ ] 近距离锄地预览仍正常显示 1+8
- [ ] 浇水模式下 LockPosition 不显示 1+8（只显示光标）

### 7.3 右键不触发收获（CP-8）

- [ ] 右键点击成熟作物 → 不触发收获（不导航、不播放动画）
- [ ] 右键点击其他可交互物体（箱子、NPC 等）→ 仍正常交互
