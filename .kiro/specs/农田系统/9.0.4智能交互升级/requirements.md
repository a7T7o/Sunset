# 9.0.4 智能交互升级 - 需求文档

## 模块概述

将农田工具（锄头、水壶、种子）的交互逻辑从"短视模式"升级为"智能模式"：
- **短视模式（9.0.3）**：距离不够 → 红色光标 → 点击无效
- **智能模式（9.0.4）**：距离不够但目标有效 → 绿色光标 → 点击触发自动导航 → 到达后自动执行

## 核心用户故事

### US-1：远距离锄地
**作为**玩家
**我希望**点击远处的可耕作地块时，角色能自动走过去并锄地
**以便**我不需要手动走到每个格子旁边再操作

**验收标准**：
- AC-1.1：远处可耕作地块显示绿色光标（不是红色）
- AC-1.2：点击后角色自动导航到目标格子附近
- AC-1.3：到达后自动执行锄地动作
- AC-1.4：如果导航过程中目标变为不可用（如被其他物体占据），到达后不执行动作

### US-2：远距离浇水
**作为**玩家
**我希望**点击远处的已耕作地块时，角色能自动走过去并浇水
**以便**我可以快速浇灌大片农田

**验收标准**：
- AC-2.1：远处可浇水地块显示蓝色光标
- AC-2.2：点击后角色自动导航到目标格子附近
- AC-2.3：到达后自动执行浇水动作
- AC-2.4：如果导航过程中地块已被浇水，到达后不重复浇水

### US-3：远距离种植
**作为**玩家
**我希望**点击远处的可种植地块时，角色能自动走过去并种植
**以便**我可以快速种植大片农田

**验收标准**：
- AC-3.1：远处可种植地块显示绿色光标
- AC-3.2：点击后角色自动导航到目标格子附近
- AC-3.3：到达后自动执行种植动作
- AC-3.4：如果导航过程中地块已被种植，到达后不重复种植

### US-4：近距离立即执行
**作为**玩家
**我希望**点击近处的有效地块时，立即执行动作而不触发导航
**以便**近距离操作保持流畅

**验收标准**：
- AC-4.1：在工具使用距离内点击，立即执行动作
- AC-4.2：不触发任何导航逻辑
- AC-4.3：与 9.0.3 行为一致

### US-5：无效目标反馈
**作为**玩家
**我希望**点击无效地块时，显示红色光标且点击无效
**以便**我知道这个位置不能操作

**验收标准**：
- AC-5.1：无效地块（有障碍物、不可耕作等）显示红色光标
- AC-5.2：点击无效地块不触发任何动作
- AC-5.3：点击无效地块不触发导航

## 交互矩阵

### 维度定义

**工具类型**：
- 锄头（Hoe）
- 水壶（WateringCan）
- 种子（Seed）

**目标状态**：
- 可操作（Valid）：逻辑合法 + 物理合法（无障碍物）
- 不可操作（Invalid）：逻辑不合法 或 有障碍物

**距离状态**：
- 近距离（Near）：在 farmToolReach 范围内
- 远距离（Far）：超出 farmToolReach 范围

**导航状态**：
- 可达（Reachable）：NavGrid 可以找到路径
- 不可达（Unreachable）：NavGrid 无法找到路径

### 完整交互矩阵

| # | 工具 | 目标状态 | 距离 | 导航 | 光标颜色 | 点击行为 |
|---|------|---------|------|------|---------|---------|
| 1 | 锄头 | Valid | Near | - | 绿色 | 立即锄地 |
| 2 | 锄头 | Valid | Far | Reachable | 绿色 | 导航→锄地 |
| 3 | 锄头 | Valid | Far | Unreachable | 绿色* | 无动作（可选：提示） |
| 4 | 锄头 | Invalid | Near | - | 红色 | 无动作 |
| 5 | 锄头 | Invalid | Far | - | 红色 | 无动作 |
| 6 | 水壶 | Valid | Near | - | 蓝色 | 立即浇水 |
| 7 | 水壶 | Valid | Far | Reachable | 蓝色 | 导航→浇水 |
| 8 | 水壶 | Valid | Far | Unreachable | 蓝色* | 无动作（可选：提示） |
| 9 | 水壶 | Invalid | Near | - | 红色 | 无动作 |
| 10 | 水壶 | Invalid | Far | - | 红色 | 无动作 |
| 11 | 种子 | Valid | Near | - | 绿色 | 立即种植 |
| 12 | 种子 | Valid | Far | Reachable | 绿色 | 导航→种植 |
| 13 | 种子 | Valid | Far | Unreachable | 绿色* | 无动作（可选：提示） |
| 14 | 种子 | Invalid | Near | - | 红色 | 无动作 |
| 15 | 种子 | Invalid | Far | - | 红色 | 无动作 |

**注**：绿色* 表示目标有效但不可达，可以考虑使用特殊颜色（如暗绿色）区分，但这是 P2 需求。

### 边界情况

| # | 场景 | 预期行为 |
|---|------|---------|
| E1 | 导航过程中目标被占据 | 到达后二次检查，不执行动作 |
| E2 | 导航过程中玩家手动移动 | 取消导航，不执行动作 |
| E3 | 导航过程中切换工具 | 取消导航，不执行动作 |
| E4 | 导航过程中打开面板 | 取消导航，不执行动作 |
| E5 | 导航到达但距离仍超出 | 二次检查距离，不执行动作 |
| E6 | 连续点击同一目标 | 防抖，不重复触发导航 |
| E7 | 快速点击不同目标 | 取消旧导航，启动新导航 |
| E8 | 玩家站在目标格子上 | 立即执行（HasFarmingObstacle 不检测 Player） |
| E9 | 导航过程中种子被消耗（如被其他系统使用） | 到达后快照校验失败，不执行动作，播放取消音效 |
| E10 | 导航过程中物品槽位变化（如拖拽移动） | 到达后快照校验失败，不执行动作 |

## 非功能需求

### NFR-1：性能
- 预览更新不应增加额外的 NavGrid 查询
- 导航回调执行时间 < 1 帧

### NFR-2：兼容性
- 与现有 PlacementManager（放置系统）互不干扰
- 与现有 PlayerAutoNavigator 回调机制兼容

### NFR-3：可维护性
- IsValid 和 IsInRange 分离，便于调试
- 提供公开属性供外部查询状态

## 依赖项

- FarmToolPreview.cs（9.0.3 已实现）
- GameInputManager.cs（9.0.3 已实现）
- PlayerAutoNavigator.cs（已支持 Action 回调）
- PlacementValidator.cs（9.0.3 已实现 HasFarmingObstacle）

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 导航路径不可达 | 玩家点击无反应 | 提供视觉/音效反馈 |
| 二次检查失败率高 | 玩家体验差 | 优化停止距离计算 |
| 与放置系统冲突 | 功能混乱 | 明确优先级和互斥逻辑 |
| 种瓜得豆问题 | 导航期间物品变化导致错误操作 | 使用 FarmingSnapshot 快照机制校验 |
