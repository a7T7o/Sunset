# 9.0.4 智能交互升级 - 交互矩阵详细分析

## 文档概述

本文档详细分析农田工具系统的所有交互场景，确保设计阶段全面覆盖所有情况。

---

## 一、维度定义

### 1.1 工具类型（Tool Type）

| 代码 | 工具 | 说明 | 对应动作 |
|------|------|------|---------|
| T1 | 锄头（Hoe） | 将普通地面转为耕地 | `FarmTileManager.CreateTile()` |
| T2 | 水壶（WateringCan） | 给耕地浇水 | `FarmTileManager.SetWatered()` |
| T3 | 种子（Seed） | 在耕地上种植作物 | `CropManager.CreateCrop()` |

### 1.2 目标地块状态（Target State）

| 代码 | 状态 | 说明 | 检测方法 |
|------|------|------|---------|
| S1 | 可耕作（Tillable） | 普通地面，可以锄地 | `FarmTileManager.CanTillAt()` |
| S2 | 已耕作未浇水（Tilled-Dry） | 耕地，未浇水 | `tileData.isTilled && !tileData.wateredToday` |
| S3 | 已耕作已浇水（Tilled-Wet） | 耕地，已浇水 | `tileData.isTilled && tileData.wateredToday` |
| S4 | 可种植（Plantable） | 耕地，无作物 | `tileData.CanPlant()` |
| S5 | 已种植（Planted） | 耕地，有作物 | `tileData.HasCrop()` |
| S6 | 不可操作（Invalid） | 有障碍物或非耕作区 | `HasFarmingObstacle()` 或 `!CanTillAt()` |

### 1.3 距离状态（Distance State）

| 代码 | 状态 | 说明 | 检测方法 |
|------|------|------|---------|
| D1 | 近距离（Near） | 在 `farmToolReach` 范围内 | `distance <= farmToolReach` |
| D2 | 远距离（Far） | 超出 `farmToolReach` 范围 | `distance > farmToolReach` |

### 1.4 导航可达性（Navigation Reachability）

| 代码 | 状态 | 说明 | 检测方法 |
|------|------|------|---------|
| N1 | 可达（Reachable） | NavGrid 可以找到路径 | `navGrid.TryFindPath()` 返回 true |
| N2 | 不可达（Unreachable） | NavGrid 无法找到路径 | `navGrid.TryFindPath()` 返回 false |
| N0 | 不适用（N/A） | 近距离时不需要导航 | - |

### 1.5 玩家状态（Player State）

| 代码 | 状态 | 说明 |
|------|------|------|
| P1 | 空闲（Idle） | 玩家静止或正常移动 |
| P2 | 导航中（Navigating） | 玩家正在自动导航 |
| P3 | 动作中（Acting） | 玩家正在执行工具动作 |


---

## 二、锄头（Hoe）交互矩阵

### 2.1 基础交互矩阵

| # | 目标状态 | 距离 | 导航 | 光标颜色 | 点击行为 | 结果 |
|---|---------|------|------|---------|---------|------|
| H01 | S1 可耕作 | D1 近 | N0 | 🟢 绿色 | 立即执行 | 创建耕地 |
| H02 | S1 可耕作 | D2 远 | N1 可达 | 🟢 绿色 | 导航→执行 | 导航后创建耕地 |
| H03 | S1 可耕作 | D2 远 | N2 不可达 | 🟢 绿色 | 无动作 | 提示不可达（可选） |
| H04 | S2 已耕作未浇水 | D1 近 | N0 | 🔴 红色 | 无动作 | 已经是耕地 |
| H05 | S2 已耕作未浇水 | D2 远 | - | 🔴 红色 | 无动作 | 已经是耕地 |
| H06 | S3 已耕作已浇水 | D1 近 | N0 | 🔴 红色 | 无动作 | 已经是耕地 |
| H07 | S3 已耕作已浇水 | D2 远 | - | 🔴 红色 | 无动作 | 已经是耕地 |
| H08 | S5 已种植 | D1 近 | N0 | 🔴 红色 | 无动作 | 有作物 |
| H09 | S5 已种植 | D2 远 | - | 🔴 红色 | 无动作 | 有作物 |
| H10 | S6 不可操作 | D1 近 | N0 | 🔴 红色 | 无动作 | 有障碍物 |
| H11 | S6 不可操作 | D2 远 | - | 🔴 红色 | 无动作 | 有障碍物 |

### 2.2 锄头特殊情况

| # | 场景 | 预期行为 | 原因 |
|---|------|---------|------|
| H-E1 | 玩家站在目标格子上 | 可以锄地 | `HasFarmingObstacle` 排除 Player |
| H-E2 | 目标格子有掉落物 | 可以锄地 | 掉落物不是障碍物 |
| H-E3 | 目标格子有 NPC | 不可锄地 | NPC 是障碍物（待确认） |
| H-E4 | 目标格子在水边 | 取决于 CanTillAt | 由 FarmTileManager 决定 |
| H-E5 | 目标格子在建筑内 | 不可锄地 | Building 是障碍物 |

---

## 三、水壶（WateringCan）交互矩阵

### 3.1 基础交互矩阵

| # | 目标状态 | 距离 | 导航 | 光标颜色 | 点击行为 | 结果 |
|---|---------|------|------|---------|---------|------|
| W01 | S1 可耕作（未耕） | D1 近 | N0 | 🔴 红色 | 无动作 | 不是耕地 |
| W02 | S1 可耕作（未耕） | D2 远 | - | 🔴 红色 | 无动作 | 不是耕地 |
| W03 | S2 已耕作未浇水 | D1 近 | N0 | 🔵 蓝色 | 立即执行 | 浇水成功 |
| W04 | S2 已耕作未浇水 | D2 远 | N1 可达 | 🔵 蓝色 | 导航→执行 | 导航后浇水 |
| W05 | S2 已耕作未浇水 | D2 远 | N2 不可达 | 🔵 蓝色 | 无动作 | 提示不可达（可选） |
| W06 | S3 已耕作已浇水 | D1 近 | N0 | 🔴 红色 | 无动作 | 已经浇过水 |
| W07 | S3 已耕作已浇水 | D2 远 | - | 🔴 红色 | 无动作 | 已经浇过水 |
| W08 | S4 可种植（未浇水） | D1 近 | N0 | 🔵 蓝色 | 立即执行 | 浇水成功 |
| W09 | S4 可种植（未浇水） | D2 远 | N1 可达 | 🔵 蓝色 | 导航→执行 | 导航后浇水 |
| W10 | S5 已种植（未浇水） | D1 近 | N0 | 🔵 蓝色 | 立即执行 | 浇水成功 |
| W11 | S5 已种植（未浇水） | D2 远 | N1 可达 | 🔵 蓝色 | 导航→执行 | 导航后浇水 |
| W12 | S5 已种植（已浇水） | D1 近 | N0 | 🔴 红色 | 无动作 | 已经浇过水 |
| W13 | S5 已种植（已浇水） | D2 远 | - | 🔴 红色 | 无动作 | 已经浇过水 |
| W14 | S6 不可操作 | D1 近 | N0 | 🔴 红色 | 无动作 | 有障碍物 |
| W15 | S6 不可操作 | D2 远 | - | 🔴 红色 | 无动作 | 有障碍物 |

### 3.2 水壶特殊情况

| # | 场景 | 预期行为 | 原因 |
|---|------|---------|------|
| W-E1 | 玩家站在目标格子上 | 可以浇水 | `HasFarmingObstacle` 排除 Player |
| W-E2 | 水壶没水 | 不可浇水 | 需要检查水壶状态（待实现） |
| W-E3 | 下雨天 | 可以浇水 | 但可能无意义（待设计） |
| W-E4 | 作物已成熟 | 可以浇水 | 但可能无意义（待设计） |

---

## 四、种子（Seed）交互矩阵

### 4.1 基础交互矩阵

| # | 目标状态 | 距离 | 导航 | 光标颜色 | 点击行为 | 结果 |
|---|---------|------|------|---------|---------|------|
| P01 | S1 可耕作（未耕） | D1 近 | N0 | 🔴 红色 | 无动作 | 不是耕地 |
| P02 | S1 可耕作（未耕） | D2 远 | - | 🔴 红色 | 无动作 | 不是耕地 |
| P03 | S2 已耕作未浇水 | D1 近 | N0 | 🟢 绿色 | 立即执行 | 种植成功 |
| P04 | S2 已耕作未浇水 | D2 远 | N1 可达 | 🟢 绿色 | 导航→执行 | 导航后种植 |
| P05 | S2 已耕作未浇水 | D2 远 | N2 不可达 | 🟢 绿色 | 无动作 | 提示不可达（可选） |
| P06 | S3 已耕作已浇水 | D1 近 | N0 | 🟢 绿色 | 立即执行 | 种植成功 |
| P07 | S3 已耕作已浇水 | D2 远 | N1 可达 | 🟢 绿色 | 导航→执行 | 导航后种植 |
| P08 | S3 已耕作已浇水 | D2 远 | N2 不可达 | 🟢 绿色 | 无动作 | 提示不可达（可选） |
| P09 | S4 可种植 | D1 近 | N0 | 🟢 绿色 | 立即执行 | 种植成功 |
| P10 | S4 可种植 | D2 远 | N1 可达 | 🟢 绿色 | 导航→执行 | 导航后种植 |
| P11 | S4 可种植 | D2 远 | N2 不可达 | 🟢 绿色 | 无动作 | 提示不可达（可选） |
| P12 | S5 已种植 | D1 近 | N0 | 🔴 红色 | 无动作 | 已有作物 |
| P13 | S5 已种植 | D2 远 | - | 🔴 红色 | 无动作 | 已有作物 |
| P14 | S6 不可操作 | D1 近 | N0 | 🔴 红色 | 无动作 | 有障碍物 |
| P15 | S6 不可操作 | D2 远 | - | 🔴 红色 | 无动作 | 有障碍物 |

### 4.2 种子特殊情况

| # | 场景 | 预期行为 | 原因 |
|---|------|---------|------|
| P-E1 | 玩家站在目标格子上 | 可以种植 | `HasFarmingObstacle` 排除 Player |
| P-E2 | 种子数量为 0 | 不可种植 | 需要检查库存 |
| P-E3 | 季节不匹配 | 可以种植但会枯萎 | 由 CropController 处理 |
| P-E4 | 导航过程中切换种子 | 取消导航 | 防止种错种子 |
| P-E5 | 导航过程中种子用完 | 到达后不执行 | 二次检查库存 |



---

## 五、导航过程中的状态变化矩阵

### 5.1 导航中断条件

| # | 中断条件 | 检测时机 | 处理方式 |
|---|---------|---------|----------|
| N01 | 玩家手动移动（WASD） | 每帧检测 | 立即取消导航 |
| N02 | 切换快捷栏物品 | 按键/滚轮事件 | 立即取消导航 |
| N03 | 打开任意面板（背包/箱子等） | 按键事件 | 立即取消导航 |
| N04 | 受到攻击/伤害 | 伤害事件 | 立即取消导航 |
| N05 | 进入对话 | 对话触发 | 立即取消导航 |
| N06 | 场景切换 | 场景加载 | 自动取消 |
| N07 | 游戏暂停 | 暂停事件 | 暂停导航（恢复后继续？） |

### 5.2 导航到达后的二次检查

| # | 检查项 | 失败处理 | 说明 |
|---|--------|---------|------|
| C01 | 目标仍然有效（IsValid） | 不执行动作 | 目标可能被其他因素改变 |
| C02 | 距离在范围内（IsInRange） | 不执行动作 | 导航可能未完全到达 |
| C03 | 手持物品未变（仅种子） | 不执行动作 | 防止种错种子 |
| C04 | 库存充足（仅种子） | 不执行动作 | 防止无种子种植 |
| C05 | 玩家状态正常 | 不执行动作 | 玩家可能在动作中 |

### 5.3 导航过程中目标状态变化

| # | 初始状态 | 变化后状态 | 到达后行为 |
|---|---------|----------|----------|
| T01 | 可耕作 | 被其他玩家耕作 | 不执行（已是耕地） |
| T02 | 可耕作 | 被放置物体占据 | 不执行（有障碍物） |
| T03 | 可浇水 | 被其他玩家浇水 | 不执行（已浇水） |
| T04 | 可浇水 | 下雨自动浇水 | 不执行（已浇水） |
| T05 | 可种植 | 被其他玩家种植 | 不执行（已有作物） |
| T06 | 可种植 | 耕地退化 | 不执行（不是耕地） |

### 5.4 操作失败反馈（锐评002补充）

| # | 失败场景 | 失败原因 | 反馈方式 | 优先级 |
|---|---------|---------|---------|--------|
| F01 | 导航到达后目标失效 | 被占据/被耕作/被浇水/被种植 | Debug Log + 可选音效 | P1 |
| F02 | 导航被中断 | 手动移动/切换工具/打开面板 | 无反馈（用户主动中断） | - |
| F03 | 目标不可达 | NavGrid 无路径 | 无动作（P2 加提示） | P2 |
| F04 | 距离仍超出 | 导航未完全到达 | Debug Log | P1 |

**设计决策**：
- P1 阶段：失败时输出 Debug Log，便于调试
- P2 阶段：添加错误音效和视觉反馈

### 5.5 导航回调时序（锐评002补充）

**关键约束**：T1 到 T3 必须在同一帧内完成，避免滑步。

| 时序点 | 说明 | 帧要求 |
|--------|------|--------|
| T0 | 玩家点击，启动导航 | Frame N |
| T1 | 导航到达，触发 onComplete | Frame N+X |
| T2 | onComplete 内执行二次检查 | Frame N+X（同帧） |
| T3 | 二次检查通过，执行动作 | Frame N+X（同帧） |

**风险点**：
- 如果 `PlayerAutoNavigator.onComplete` 在 Stop() 之后、下一帧才回调，会导致 T2/T3 延迟
- 必须在 Phase 0 验证回调时机

**验证方法**：
```csharp
// 在 onComplete 回调中添加帧号日志
Debug.Log($"[FarmNav] onComplete at frame {Time.frameCount}");
// 在 ExecuteAction 中添加帧号日志
Debug.Log($"[FarmNav] ExecuteAction at frame {Time.frameCount}");
// 两者必须相同
```

### 5.6 状态机定义（锐评002补充）

**农田导航状态机**：

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  ┌──────┐    点击远距离目标    ┌────────────┐           │
│  │ Idle │ ──────────────────> │ Navigating │           │
│  └──────┘                     └────────────┘           │
│      ▲                              │                   │
│      │                              │ 到达              │
│      │                              ▼                   │
│      │    动作完成/失败      ┌────────────┐           │
│      └────────────────────── │ Executing  │           │
│                              └────────────┘           │
│                                                         │
│  中断条件（任意状态 → Idle）：                          │
│  - 手动移动（WASD）                                     │
│  - 切换快捷栏                                           │
│  - 打开面板                                             │
│  - 受到攻击                                             │
└─────────────────────────────────────────────────────────┘
```

**状态定义**：

| 状态 | 说明 | 允许的操作 |
|------|------|-----------|
| Idle | 无导航任务 | 点击触发新导航/立即执行 |
| Navigating | 正在导航 | 中断、到达 |
| Executing | 正在执行动作 | 等待完成 |

**状态变量**：
```csharp
private enum FarmNavState { Idle, Navigating, Executing }
private FarmNavState _farmNavState = FarmNavState.Idle;
```

**中断规则**：任何中断都必须将状态重置为 Idle，并清理相关变量。

---

## 六、视觉反馈矩阵

### 6.1 光标颜色规则

| 工具 | 有效+近距离 | 有效+远距离 | 无效 |
|------|-----------|-----------|------|
| 锄头 | 🟢 绿色 | 🟢 绿色 | 🔴 红色 |
| 水壶 | 🔵 蓝色 | 🔵 蓝色 | 🔴 红色 |
| 种子 | 🟢 绿色 | 🟢 绿色 | 🔴 红色 |

**设计决策**：有效目标无论远近都显示有效颜色，因为远距离可以通过导航到达。

### 6.2 GhostTilemap 显示规则

| 工具 | 显示 GhostTilemap | 说明 |
|------|------------------|------|
| 锄头 | ✅ 是 | 显示耕地预览 |
| 水壶 | ✅ 是 | 显示浇水预览 |
| 种子 | ❌ 否 | 仅显示光标 |

### 6.3 导航过程中的视觉反馈

| 状态 | 光标显示 | 说明 |
|------|---------|------|
| 导航中 | 跟随鼠标 | 继续显示当前鼠标位置的预览 |
| 导航到达 | 跟随鼠标 | 继续显示当前鼠标位置的预览 |
| 执行动作 | 隐藏 | 动作期间隐藏预览 |

### 6.4 可选：距离视觉区分（P2）

| 状态 | 光标样式 | 说明 |
|------|---------|------|
| 有效+近距离 | 实心 | 可立即执行 |
| 有效+远距离+可达 | 半透明 | 需要导航 |
| 有效+远距离+不可达 | 虚线 | 无法到达 |

**注**：这是 P2 需求，当前版本不实现。

---

## 七、优先级和互斥逻辑

### 7.1 输入优先级

当多个系统可能响应同一输入时，按以下优先级处理：

| 优先级 | 系统 | 说明 |
|--------|------|------|
| 1 | UI 面板 | 面板打开时屏蔽所有游戏输入 |
| 2 | 对话系统 | 对话中屏蔽所有游戏输入 |
| 3 | 放置系统 | 手持可放置物品时优先 |
| 4 | 农田工具 | 手持农田工具时 |
| 5 | 默认交互 | 与世界物体交互 |

### 7.2 农田工具内部优先级

当手持农田工具时，按以下顺序检测：

```
1. 检查是否是种子 → UpdateSeedPreview
2. 检查是否是锄头 → UpdateHoePreview
3. 检查是否是水壶 → UpdateWateringPreview
```

### 7.3 导航互斥

| 场景 | 处理方式 |
|------|----------|
| 农田导航 + 手动移动 | 取消农田导航 |
| 农田导航 + 点击新目标 | 取消旧导航，启动新导航 |
| 农田导航 + 放置系统导航 | 取消农田导航（放置优先） |
| 农田导航 + NPC 交互 | 取消农田导航 |

### 7.4 动作互斥

| 场景 | 处理方式 |
|------|----------|
| 锄地动作中 + 点击 | 忽略点击 |
| 浇水动作中 + 点击 | 忽略点击 |
| 种植动作中 + 点击 | 忽略点击 |
| 任意动作中 + 移动 | 动作完成后响应 |

### 7.5 输入吞噬逻辑（锐评002补充）

**核心原则**：HandleMovement 拥有最高中断权。

**输入处理顺序**：

```
1. UI 面板检查 → 如果打开，吞噬所有输入
2. 对话系统检查 → 如果对话中，吞噬所有输入
3. HandleMovement → 如果有移动输入，中断农田导航
4. HandleHotbar → 如果切换快捷栏，中断农田导航
5. HandleFarmingClick → 处理农田点击
```

**中断触发点**：

| 输入 | 检测位置 | 中断行为 |
|------|---------|---------|
| WASD | HandleMovement() | `CancelFarmingNavigation()` |
| 数字键 1-9 | HandleHotbar() | `CancelFarmingNavigation()` |
| 滚轮 | HandleHotbar() | `CancelFarmingNavigation()` |
| Tab/ESC | HandleUI() | `CancelFarmingNavigation()` |

**CancelFarmingNavigation() 实现**：
```csharp
private void CancelFarmingNavigation()
{
    if (_farmNavState == FarmNavState.Idle) return;
    
    _farmNavState = FarmNavState.Idle;
    _farmNavigationAction = null;
    _cachedSeedData = null;
    
    // 停止导航
    if (_playerNavigator != null)
        _playerNavigator.Stop();
    
    Debug.Log("[FarmNav] Navigation cancelled");
}
```

---

## 八、边界情况汇总

### 8.1 玩家位置相关

| # | 场景 | 预期行为 | 实现要点 |
|---|------|---------|----------|
| E01 | 玩家站在目标格子上 | 可以操作 | `HasFarmingObstacle` 排除 Player |
| E02 | 玩家在目标格子边缘 | 可以操作 | 使用 Collider.bounds.center |
| E03 | 玩家在楼梯上 | 取决于楼层检测 | 使用 PlacementLayerDetector |
| E04 | 玩家在不同楼层 | 只能操作同楼层 | layerIndex 匹配检查 |

### 8.2 目标位置相关

| # | 场景 | 预期行为 | 实现要点 |
|---|------|---------|----------|
| E05 | 目标在屏幕外 | 可以操作（如果有效） | 不限制屏幕范围 |
| E06 | 目标在地图边缘 | 取决于 CanTillAt | 由 FarmTileManager 决定 |
| E07 | 目标在水面上 | 不可操作 | CanTillAt 返回 false |
| E08 | 目标在悬崖边 | 取决于 NavGrid | 导航可达性检查 |

### 8.3 时间相关

| # | 场景 | 预期行为 | 实现要点 |
|---|------|---------|----------|
| E09 | 跨天时浇水 | 正常浇水 | 使用当前时间 |
| E10 | 导航过程中跨天 | 继续导航 | 不影响导航 |
| E11 | 导航过程中季节变化 | 继续导航 | 不影响导航 |

### 8.4 多人相关（未来扩展）

| # | 场景 | 预期行为 | 实现要点 |
|---|------|---------|----------|
| E12 | 其他玩家占据目标 | 不可操作 | 障碍物检测 |
| E13 | 导航过程中被其他玩家抢先 | 到达后不执行 | 二次检查 |
| E14 | 同时操作同一格子 | 先到先得 | 服务器仲裁（未来） |

---

## 九、实现检查清单

### 9.1 FarmToolPreview 检查项

- [ ] `IsValid` 不包含距离判断
- [ ] `IsInRange` 独立属性
- [ ] `CurrentCursorPos` 暴露当前光标位置
- [ ] `CurrentCellPos` 暴露当前格子坐标
- [ ] `CurrentLayerIndex` 暴露当前楼层
- [ ] 锄头预览正确显示颜色
- [ ] 水壶预览正确显示颜色
- [ ] 种子预览正确显示颜色

### 9.2 GameInputManager 检查项

- [ ] `TryTillSoil` 支持近距离立即执行
- [ ] `TryTillSoil` 支持远距离导航执行
- [ ] `TryWaterTile` 支持近距离立即执行
- [ ] `TryWaterTile` 支持远距离导航执行
- [ ] `TryPlantSeed` 支持近距离立即执行
- [ ] `TryPlantSeed` 支持远距离导航执行
- [ ] `TryPlantSeed` 缓存 seedData
- [ ] `TryPlantSeed` 二次检查手持物品
- [ ] 导航回调正确执行
- [ ] 二次检查机制正确工作

### 9.3 导航中断检查项

- [ ] 手动移动取消导航
- [ ] 切换快捷栏取消导航
- [ ] 打开面板取消导航
- [ ] 受到攻击取消导航
- [ ] 进入对话取消导航

### 9.4 边界情况检查项

- [ ] 玩家站在目标格子上可以操作
- [ ] 目标格子有掉落物可以操作
- [ ] 导航过程中目标被占据不执行
- [ ] 导航过程中切换种子不执行
- [ ] 导航过程中种子用完不执行
- [ ] 连续点击同一目标防抖
- [ ] 快速点击不同目标切换导航

---

## 十、测试用例矩阵

### 10.1 锄头测试用例

| # | 测试场景 | 操作步骤 | 预期结果 |
|---|---------|---------|---------|
| TH01 | 近距离锄地 | 站在可耕作地块旁，点击 | 立即锄地，显示耕地 |
| TH02 | 远距离锄地（可达） | 站在远处，点击可耕作地块 | 导航→锄地 |
| TH03 | 远距离锄地（不可达） | 点击被障碍物包围的地块 | 无动作 |
| TH04 | 锄已耕地 | 点击已耕作地块 | 红色光标，无动作 |
| TH05 | 锄有作物地块 | 点击有作物的地块 | 红色光标，无动作 |
| TH06 | 锄有障碍物地块 | 点击有树/石头的地块 | 红色光标，无动作 |
| TH07 | 导航中切换工具 | 导航过程中按数字键 | 取消导航 |
| TH08 | 导航中目标被占 | 导航过程中放置物体 | 到达后不执行 |

### 10.2 水壶测试用例

| # | 测试场景 | 操作步骤 | 预期结果 |
|---|---------|---------|---------|
| TW01 | 近距离浇水 | 站在耕地旁，点击 | 立即浇水，显示水渍 |
| TW02 | 远距离浇水（可达） | 站在远处，点击耕地 | 导航→浇水 |
| TW03 | 远距离浇水（不可达） | 点击被障碍物包围的耕地 | 无动作 |
| TW04 | 浇已浇水地块 | 点击已浇水地块 | 红色光标，无动作 |
| TW05 | 浇未耕作地块 | 点击普通地面 | 红色光标，无动作 |
| TW06 | 导航中地块被浇 | 导航过程中下雨 | 到达后不执行 |

### 10.3 种子测试用例

| # | 测试场景 | 操作步骤 | 预期结果 |
|---|---------|---------|---------|
| TP01 | 近距离种植 | 站在耕地旁，点击 | 立即种植，显示作物 |
| TP02 | 远距离种植（可达） | 站在远处，点击耕地 | 导航→种植 |
| TP03 | 远距离种植（不可达） | 点击被障碍物包围的耕地 | 无动作 |
| TP04 | 种已种植地块 | 点击有作物的地块 | 红色光标，无动作 |
| TP05 | 种未耕作地块 | 点击普通地面 | 红色光标，无动作 |
| TP06 | 导航中切换种子 | 导航过程中切换种子类型 | 取消导航 |
| TP07 | 导航中种子用完 | 导航过程中种子数量变0 | 到达后不执行 |
| TP08 | 导航中地块被种 | 导航过程中其他方式种植 | 到达后不执行 |

---

## 十一、与锐评001的对应关系

### 11.1 锐评指令映射

| 锐评指令 | 本文档对应章节 | 实现要点 |
|---------|---------------|---------|
| Action 1: 解除距离锁 | 2.1 H01-H03, 3.1 W03-W05, 4.1 P03-P08 | IsValid 不包含距离判断 |
| Action 2: 实现意图分流 | 5.2 导航到达后的二次检查 | 近距离立即执行，远距离导航执行 |
| Action 3: 导航回调支持 | 5.1 导航中断条件, 5.3 目标状态变化 | PlayerAutoNavigator 回调机制 |

### 11.2 设计决策记录

| 决策 | 选择 | 原因 |
|------|------|------|
| 远距离有效目标光标颜色 | 与近距离相同（绿/蓝） | 简化实现，P2 再区分 |
| 不可达目标处理 | 无动作，不提示 | 避免打扰，P2 再加提示 |
| 导航中断条件 | 手动移动、切换工具、打开面板 | 覆盖主要场景 |
| 二次检查时机 | 导航到达后 | 确保状态一致性 |

---

## 十二、文档版本

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|---------|
| 1.0 | 2026-02-09 | Kiro | 初始版本，完整交互矩阵 |
| 1.1 | 2026-02-09 | Kiro | 补充 5.4/5.5/5.6/7.5 章节（响应锐评002） |