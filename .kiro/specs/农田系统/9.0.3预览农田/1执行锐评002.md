**CODE REAPER STATUS:**
**AUDIT COMPLETE.**
**VERDICT: GREEN LIGHT (全线通过).**

老大，我已完成对 `.kiro/specs/农田系统/9.0.3预览农田/` 下三件套文档的最终审计。
这一次，Kiro 终于学会了什么是 **“空间宪法”** 和 **“物理分级”**。文档逻辑严密，特别是对障碍物检测的区分（锄地不应该被玩家自己挡住）处理得非常精准。

以下是审计详情：

### 💀 审计详情 (AUDIT DETAILS)

#### 1. 空间维度的回归 (`requirements.md`)

* **US-1 动态空间感知**: 明确规定了使用 `PlacementLayerDetector.GetPlayerSortingLayer()`。这意味着预览框终于能像影子一样跟随玩家穿梭于楼层之间，不再会有“二楼锄地显示在一楼”的穿帮镜头。

#### 2. 物理规则的修正 (`requirements.md` & `design.md`)

* **分级避障 (Tiered Obstacles)**: US-2 明确指出 `HasFarmingObstacle` **不检测 Player 标签**。
* *逻辑*: 放置箱子时，箱子不能压住玩家（HasObstacle）。
* *逻辑*: 锄地时，玩家必然站在地里，所以不能被自己挡住（HasFarmingObstacle）。
* *判定*: **S 级设计**。这避免了严重的交互死锁。



#### 3. 逻辑流的闭环 (`design.md`)

* **调用链**: `UpdatePreviews` -> `CheckObstacle` -> `CheckDistance` -> `UpdateCursor`。
* **种子路由**: 明确了 `SeedData` 指向 `FarmToolPreview`。这填补了之前的逻辑黑洞。

#### 4. 任务颗粒度 (`tasks.md`)

* **原子化**: P0/P1/P2 分级清晰。先做 Layer（视觉基础），再做 Physics（逻辑修正），最后做 Seed（功能补全）。符合“先对再好”的原则。

---

### ⚔️ 终极执行令 (EXECUTE ORDER)

**To Kiro:**
文档已锁定。现在的蓝图已经不仅是“能跑”，而是具备了**工业级的健壮性**。

**立即执行代码落地 (Code Generation Phase)。**
请一次性生成/修改以下 **3 个核心文件**。注意保持与文档的绝对一致：

1. **`PlacementValidator.cs`** (修改)
* **任务**: 增加静态方法 `HasFarmingObstacle(Vector3 cellCenter)`。
* **细节**: 确保它检测 `Tree`, `Rock`, `Building`，但**显式排除** `Player`。


2. **`FarmToolPreview.cs`** (完整重构)
* **任务**: 实现“联邦制”预览逻辑。
* **核心逻辑**:
* `Update`: 获取 `PlacementGridCalculator` 坐标。
* `UpdateSortingLayer`: 每帧同步玩家层级。
* `IsValid`: = `!HasFarmingObstacle` && `IsWithinReach` && `CanTill/CanPlant`。
* `UpdateSeedPreview`: 只显示红/绿光标，隐藏 GhostTilemap。




3. **`GameInputManager.cs`** (修改)
* **任务**: 接入新路由。
* **核心逻辑**:
* 在 `UpdatePreviews` 中拦截 `SeedData` 并导向 `FarmToolPreview`。
* 确保点击操作 (`TryTillSoil` / `TryWater` / `TryPlantSeed`) 进行同样的 `IsValid` 检查（所见即所得）。





**Code Reaper Warning:**
不要在 `HasFarmingObstacle` 里偷懒复用 `HasObstacle`，必须重写或者拆分逻辑，否则玩家会发现自己无法在脚下锄地。

**Generate. NOW.**