**CODE REAPER STATUS:**
**PROTOCOL UPGRADE: GRANDMASTER AUDIT.**
**TARGET:** 9.0.3 Farm System Preview & Interaction Rules.

老大，收到批评。Code Reaper 之前确实低估了 **“图层 (Layer)”** 和 **“物理 (Physics)”** 的复杂性，把农田想简单了。
你提到的 `PlacementLayerDetector` 不仅仅是一个工具类，它是整个游戏世界的 **“空间宪法”**。如果农田系统不遵守这部宪法，就会出现“二楼的人锄了一楼的地”这种**空间撕裂 bug**。

既然要追求极致专业，那就按照 **Requirements -> Design -> Tasks** 的绝对正序，进行一场**核磁共振级**的深度规划。

以下是 **9.0.3 版本的终极锐评与执行蓝图**。

---

### 💀 深度审计：空间与逻辑的断层 (THE GRAND AUDIT)

#### 1. 空间维度的缺失 (The Spatial Void)

* **现状**: `FarmToolPreview` 目前的 GhostTilemap 即使自动生成了，它的 Sorting Layer 也是写死的（如 "Ground"）。
* **致命伤**:
* 在 Isometric (2.5D) 游戏中，Y 轴决定渲染顺序。
* 放置系统 (`PlacementManager`) 极其严格地计算了 `SortingOrder`。
* 现在的农田预览是“平面的”，一旦玩家站在物体后方或高层建筑上，预览框就会**穿模**显示在不该显示的地方。


* **修正**: 必须引入 `PlacementLayerDetector`。它不是可选项，是必选项。预览框必须实时询问：“我现在在哪一层？我的 Order 应该是多少？”

#### 2. 物理规则的双标 (The Physics Double Standard)

* **现状**: 放置箱子时，系统会检查 `HasObstacle`；但锄地时，系统只检查 `CanTillAt`（数据层）。
* **致命伤**:
* 玩家可以把地锄在 `Rock` (石头) 下面。
* 玩家可以把地锄在 `Chest` (箱子) 下面。
* **这是严重的逻辑穿模。** 农田工具必须继承放置系统的“避障智慧”。



#### 3. 交互距离的无限性 (The Infinite Reach)

* **现状**: 只要鼠标点得到，就能锄得到。
* **修正**: 必须引入 **Distance Check (距离检测)**。不仅仅是 `Vector3.Distance`，而是要基于 `PlacementGridCalculator` 的格子距离，确保手感一致。

---

### 📜 9.0.3 核心架构规划 (THE ARCHITECTURE)

请将此作为最高指令发送给 Kiro。

#### 1. Requirements (需求先行)

**原则**: 定义“所见即所得”的物理与视觉规则。

* **US-1 动态空间感知**: 预览框必须根据玩家脚下的层级（Layer 1/2/3）自动切换 Sorting Layer，确保不被遮挡也不遮挡主角。
* **US-2 统一避障规则**: 锄地/播种前，必须通过 `PlacementValidator` 的障碍物检测（不能在石头/箱子/NPC脚下操作）。
* **US-3 种子归化**: 种子物品 (`SeedData`) 必须拥有预览反馈（红/绿框），且逻辑路由归属农田系统。

#### 2. Design (设计支撑)

**原则**: 联邦制架构下的能力复用。

* **Logic Flow (Input)**:
`GameInputManager` -> (手持种子/农具) -> `FarmToolPreview` -> (每帧 Update)
1. 获取对齐坐标 (`PlacementGridCalculator`)
2. 获取层级信息 (`PlacementLayerDetector`) -> **同步 GhostTilemap 层级**
3. 检查障碍物 (`PlacementValidator`) -> **决定颜色**
4. 检查距离 (`Vector2.Distance`) -> **决定有效性**
* **Visual Strategy**:
* **GhostTilemap**: 仅仅用来显示“1+8”的泥土变体。
* **Cursor**: 用来显示红/绿/蓝状态。
* **Seed Preview**: 种子模式下，**隐藏 GhostTilemap**，只显示 Cursor（红/绿），避免视觉噪点。



#### 3. Tasks (任务落地)

**原则**: 原子化执行。

* **T1 (Visual)**: `FarmToolPreview` 接入 `PlacementLayerDetector`，实现 `UpdateSortingLayer()`。
* **T2 (Logic)**: `FarmToolPreview` 接入 `PlacementValidator`，实现 `HasObstacle()` 检测。
* **T3 (Input)**: `GameInputManager` 重构路由，将 `SeedData` 导向 `FarmToolPreview`。

---

### ⚔️ 给 Kiro 的终极执行令 (EXECUTE ORDER)

**To Kiro:**
老大对你的要求升级了。现在的目标不是“能跑”，而是 **“工业级精度”**。
之前的预览系统缺少了**空间感**和**物理感**。

请严格按照 **Requirements -> Design -> Tasks** 的顺序，执行 **9.0.3 预览规则补完计划**。

**重点关注对象**:

1. **图层判断 (`PlacementLayerDetector`)**: 这是你必须复用的核心组件。预览框的 Sorting Layer 必须动态跟随玩家。
2. **障碍判断 (`PlacementValidator`)**: 别让玩家把地锄到石头底下去。
3. **文档顺序**: 先写需求，再写设计，最后拆解任务。

**Action**: Generate `requirements.md`, `design.md`, `tasks.md` for Phase 9.0.3.