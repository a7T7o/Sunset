**CODE REAPER STATUS:**
**IDENTITY CONFIRMED.** (Analysis Mode: **DEEP SCAN**)
**TARGET:** Current Implementation (`FarmToolPreview`, `GameInputManager`) vs. Placement System Standards.

老大，收到。
针对之前“虚空单例”的教训，我已经把**“防御性编程”**和**“自生能力”**刻进了核心逻辑。
现在，基于你上传的代码，我对当前系统进行了全面体检。Kiro 确实修好了 Crash，但从**“放置系统对齐”**的高标准来看，现在的农田预览还处于**“能用但简陋”**的阶段。

我们必须引入**“高级预览规则 (Advanced Preview Rules)”**，让农田体验从“红白机”升级到“次世代”。

以下是我的深度分析与规则规划。

---

### 💀 深度尸检：当前实现的暗雷 (DEEP AUDIT)

#### 1. ⚠️ 种子预览的“身世之谜” (The Seed Identity Crisis)

* **现状**: `GameInputManager` 目前的逻辑只处理了 `IsHoldingFarmTool` (锄头/水壶) 和 `IsHoldingPlaceableItem` (家具/机器)。
* **漏洞**: **种子 (Seeds) 去哪了？**
* 种子通常是 `ItemData` 而非 `ToolData`。
* 如果玩家手持种子，`GameInputManager` 可能会把它当成普通物品，甚至根本不触发预览。
* **风险**: 种田系统最核心的“播种”环节，目前在预览逻辑中是**缺席**的。



#### 2. ⚠️ 障碍物检测的双重标准 (Double Standards on Obstacles)

* **放置系统**: `PlacementValidator` 会检测碰撞体（石头、树木、箱子、玩家自己）。
* **农田系统**: `FarmTileManager.CanTillAt` 目前只检查了“有没有地”和“有没有耕过”。
* **风险**: 玩家可能会站在箱子底下把地锄了，或者把地锄到石头下面。这是严重的**物理穿模**。

#### 3. ⚠️ 楼层渲染的静态死局 (Static Layering)

* **现状**: `FarmToolPreview` 自动生成的 GhostTilemap 默认设置 Sorting Layer 为 "Ground", Order 100。
* **漏洞**: 这是一个静态值。
* 如果玩家在 **Layer 2 (二楼)** 种田，这个预览可能会显示在 Layer 1 的头顶，或者被 Layer 2 的地板遮挡。
* **需求**: 预览层的 Sorting Layer 必须根据玩家所在的楼层**动态跳变**。



---

### 🗺️ 下一步规划：高级预览规则 (ADVANCED RULES)

为了对齐放置系统的精密设计，我制定了以下 **3 条铁律**，作为接下来开发的蓝图：

#### 🔧 规则一：障碍物校验互通 (The Obstacle Consensus)

**定义**: 农田操作（锄地）必须通过与放置系统相同的障碍物检查。
**执行**:

1. `FarmToolPreview` 不应只问 `CanTillAt`。
2. 它还应该调用 `PlacementValidator.HasObstacle(pos)`。
3. **逻辑公式**: `IsValid = CanTillAt(pos) && !HasObstacle(pos)`。
* *拒绝在箱子底下锄地。*
* *拒绝在NPC脚下锄地。*



#### 🔧 规则二：动态层级跟随 (Dynamic Elevation)

**定义**: Ghost Tilemap 必须像影分身一样，永远跟随玩家所在的渲染层级。
**执行**:

1. 在 `UpdatePreview` 时，获取 `PlacementLayerDetector.GetPlayerSortingLayer()`。
2. 动态修改 `ghostTilemap.GetComponent<TilemapRenderer>().sortingLayerName`。
3. **效果**: 无论玩家在平原还是高山，预览框永远正确地浮在地面上。

#### 🔧 规则三：种子归化 (Seed Naturalization)

**定义**: 种子必须被视为一种特殊的“农田工具行为”，而非普通放置。
**执行**:

1. 在 `GameInputManager` 中识别 `SeedData`。
2. 将种子路由到 `FarmToolPreview`（而非 `PlacementPreview`）。
3. **视觉表现**:
* 锄头 = 显示“1+8”地形变化。
* 水壶 = 显示蓝色高亮。
* **种子 = 显示半透明的作物成长完全体（或种子包图标）在格子上。**



---

### ⚔️ 给 Kiro 的执行简报 (BRIEFING FOR KIRO)

请根据此规划，指示 Kiro 进行下一阶段的开发。

**目标**: 完善 `FarmToolPreview` 和 `GameInputManager`，填补上述逻辑黑洞。

1. **Input 层**: 修改 `GameInputManager.UpdatePreviews`，增加对 **Seed (种子)** 的支持。
2. **Preview 层**:
* 在 `FarmToolPreview` 中增加 `UpdateSeedPreview` 模式。
* 引入 `PlacementValidator` 进行障碍物双重检查。
* 实现 `SyncSortingLayer` 方法，确保 GhostTilemap 动态跟随楼层。



**Code Reaper Status:**
**WAITING FOR COMMAND.** (规则已确立。种子、障碍、层级——这是我们接下来的三个敌人。请下令。)