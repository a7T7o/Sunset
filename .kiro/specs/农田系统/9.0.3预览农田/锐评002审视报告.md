# Gemini é”è¯„002 å®¡è§†æŠ¥å‘Š

**å®¡è§†æ—¥æœŸ**: 2026-02-08
**é”è¯„æ¥æº**: `.kiro/specs/å†œç”°ç³»ç»Ÿ/9.0.3é¢„è§ˆå†œç”°/0è®¾è®¡é”è¯„002.md`
**å®¡è§†è€…**: Kiro

---

## ä¸€ã€é”è¯„æ¦‚è¿°

Gemini (Code Reaper) åœ¨ç¬¬äºŒä»½é”è¯„ä¸­è¿›è¡Œäº†"æ ¸ç£å…±æŒ¯çº§"æ·±åº¦è§„åˆ’ï¼Œæ‰¿è®¤ä¹‹å‰ä½ä¼°äº† Layer/Physics å¤æ‚æ€§ï¼Œå¹¶æå‡ºäº†å®Œæ•´çš„ Requirements -> Design -> Tasks æ¶æ„ã€‚

### æ ¸å¿ƒè§‚ç‚¹

| ç¼–å· | è§‚ç‚¹ | å†…å®¹ |
|------|------|------|
| è§‚ç‚¹ 1 | PlacementLayerDetector å®šä½ | "ç©ºé—´å®ªæ³•"ï¼Œå†œç”°ç³»ç»Ÿå¿…é¡»éµå®ˆ |
| è§‚ç‚¹ 2 | ç©ºé—´æ’•è£‚ Bug | ä¸éµå®ˆä¼šå¯¼è‡´"äºŒæ¥¼çš„äººé”„äº†ä¸€æ¥¼çš„åœ°" |
| è§‚ç‚¹ 3 | å·¥ä½œæµå‡çº§ | Requirements -> Design -> Tasks ç»å¯¹æ­£åº |

### ä¸‰å¤§å®¡è®¡å‘ç°

| ç¼–å· | é—®é¢˜ | Gemini åˆ¤æ–­ |
|------|------|------------|
| å®¡è®¡ 1 | ç©ºé—´ç»´åº¦ç¼ºå¤± | GhostTilemap Sorting Layer å†™æ­» |
| å®¡è®¡ 2 | ç‰©ç†è§„åˆ™åŒæ ‡ | é”„åœ°ä¸æ£€æŸ¥éšœç¢ç‰© |
| å®¡è®¡ 3 | äº¤äº’è·ç¦»æ— é™ | åªè¦é¼ æ ‡ç‚¹å¾—åˆ°å°±èƒ½é”„ |

### ä¸‰ä¸ªæ ¸å¿ƒéœ€æ±‚ (US)

| ç¼–å· | éœ€æ±‚ | æè¿° |
|------|------|------|
| US-1 | åŠ¨æ€ç©ºé—´æ„ŸçŸ¥ | é¢„è§ˆæ¡†æ ¹æ®ç©å®¶æ¥¼å±‚è‡ªåŠ¨åˆ‡æ¢ Sorting Layer |
| US-2 | ç»Ÿä¸€é¿éšœè§„åˆ™ | é”„åœ°/æ’­ç§å‰å¿…é¡»é€šè¿‡éšœç¢ç‰©æ£€æµ‹ |
| US-3 | ç§å­å½’åŒ– | SeedData å¿…é¡»æœ‰é¢„è§ˆåé¦ˆ |

### ä¸‰ä¸ªæ‰§è¡Œä»»åŠ¡ (T)

| ç¼–å· | ä»»åŠ¡ | æè¿° |
|------|------|------|
| T1 | UpdateSortingLayer | FarmToolPreview æ¥å…¥ PlacementLayerDetector |
| T2 | HasObstacle é›†æˆ | FarmToolPreview æ¥å…¥ PlacementValidator |
| T3 | SeedData è·¯ç”± | GameInputManager å°†ç§å­å¯¼å‘ FarmToolPreview |

---

## äºŒã€ä¸é”è¯„001 çš„å¯¹æ¯”åˆ†æ


### 2.1 é—®é¢˜è¯†åˆ«å¯¹æ¯”

| é—®é¢˜ | é”è¯„001 | é”è¯„002 | å˜åŒ– |
|------|---------|---------|------|
| Sorting Layer é™æ€ | âœ… æå‡º | âœ… å¼ºåŒ–ä¸º"ç©ºé—´ç»´åº¦ç¼ºå¤±" | å‡çº§ |
| éšœç¢ç‰©æ£€æµ‹ç¼ºå¤± | âœ… æå‡º | âœ… å¼ºåŒ–ä¸º"ç‰©ç†è§„åˆ™åŒæ ‡" | å‡çº§ |
| ç§å­é¢„è§ˆç¼ºå¸­ | âœ… æå‡º | âœ… ä¿æŒä¸º US-3 | ä¿æŒ |
| è·ç¦»æ£€æµ‹ç¼ºå¤± | âŒ æœªæ | âœ… æ–°å¢"äº¤äº’è·ç¦»æ— é™" | **æ–°å¢** |

**è¯„ä»·**ï¼šGemini åœ¨é”è¯„002 ä¸­è¡¥å……äº†æˆ‘åœ¨é”è¯„001å®¡è§†æŠ¥å‘Šä¸­æŒ‡å‡ºçš„"è·ç¦»æ£€æµ‹ç¼ºå¤±"é—®é¢˜ï¼Œè¯´æ˜ Gemini å¸æ”¶äº†åé¦ˆã€‚

### 2.2 æ–¹æ¡ˆæ¼”è¿›å¯¹æ¯”

| æ–¹é¢ | é”è¯„001 | é”è¯„002 | æˆ‘çš„è¯„ä¼° |
|------|---------|---------|---------|
| å±‚çº§è·Ÿéš | è°ƒç”¨ GetPlayerSortingLayer() | åŒä¸Š + å¼ºè°ƒ"ç©ºé—´å®ªæ³•" | âœ… ä¸€è‡´ |
| éšœç¢ç‰©æ£€æµ‹ | è°ƒç”¨ HasObstacle() | åŒä¸Š + å¼ºè°ƒ"é¿éšœæ™ºæ…§" | âš ï¸ ä»éœ€æ’é™¤ Player |
| ç§å­é¢„è§ˆ | æ˜¾ç¤º"ä½œç‰©æˆé•¿å®Œå…¨ä½“" | ç®€åŒ–ä¸º"çº¢/ç»¿æ¡†" | âœ… é‡‡çº³æˆ‘çš„ç®€åŒ–å»ºè®® |
| è·ç¦»æ£€æµ‹ | æœªæåŠ | åŸºäº PlacementGridCalculator | âœ… æ–°å¢ï¼Œæ–¹å‘æ­£ç¡® |

**è¯„ä»·**ï¼šGemini åœ¨é”è¯„002 ä¸­é‡‡çº³äº†æˆ‘å¯¹ç§å­é¢„è§ˆçš„ç®€åŒ–å»ºè®®ï¼ˆåªæ˜¾ç¤ºå…‰æ ‡ï¼Œä¸æ˜¾ç¤ºä½œç‰©å®Œå…¨ä½“ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç§¯æçš„æ”¹è¿›ã€‚

---

## ä¸‰ã€é€æ¡æ·±åº¦åˆ†æ

### å®¡è®¡ 1ï¼šç©ºé—´ç»´åº¦ç¼ºå¤± âœ… ç¡®è®¤æ­£ç¡®

**Gemini çš„åˆ¤æ–­**ï¼šGhostTilemap çš„ Sorting Layer æ˜¯å†™æ­»çš„

**æˆ‘çš„éªŒè¯**ï¼š

```csharp
// FarmToolPreview.EnsureComponents() ç¬¬ 127-128 è¡Œï¼š
ghostTilemapRenderer.sortingLayerName = "Layer 1";  // âŒ ç¡¬ç¼–ç ï¼
cursorRenderer.sortingLayerName = "Layer 1";        // âŒ ç¡¬ç¼–ç ï¼
```

**ç»“è®º**ï¼šâœ… **å®Œå…¨æ­£ç¡®**ã€‚ä¸é”è¯„001 çš„åˆ¤æ–­ä¸€è‡´ã€‚

**Gemini çš„"ç©ºé—´å®ªæ³•"æ¯”å–»**ï¼š

Gemini å°† `PlacementLayerDetector` æ¯”å–»ä¸º"ç©ºé—´å®ªæ³•"ï¼Œè¿™ä¸ªæ¯”å–»éå¸¸è´´åˆ‡ï¼š
- æ”¾ç½®ç³»ç»Ÿå·²ç»å»ºç«‹äº†å®Œæ•´çš„å±‚çº§æ£€æµ‹æœºåˆ¶
- å†œç”°ç³»ç»Ÿä½œä¸º"æ–°å…¬æ°‘"ï¼Œå¿…é¡»éµå®ˆè¿™éƒ¨"å®ªæ³•"
- å¦åˆ™ä¼šå‡ºç°"ç©ºé—´æ’•è£‚ bug"ï¼ˆäºŒæ¥¼çš„äººé”„äº†ä¸€æ¥¼çš„åœ°ï¼‰

**æˆ‘çš„è¡¥å……**ï¼š

æŸ¥çœ‹ `PlacementLayerDetector.GetPlayerSortingLayer()` çš„å®ç°ï¼š

```csharp
public static string GetPlayerSortingLayer(Transform playerTransform)
{
    if (playerTransform == null) return "Default";
    
    var spriteRenderer = playerTransform.GetComponentInChildren<SpriteRenderer>();
    if (spriteRenderer != null)
    {
        return spriteRenderer.sortingLayerName;
    }
    return "Default";
}
```

è¿™ä¸ªæ–¹æ³•ç›´æ¥è·å–ç©å®¶ SpriteRenderer çš„ Sorting Layerï¼Œç®€å•å¯é ã€‚

---

### å®¡è®¡ 2ï¼šç‰©ç†è§„åˆ™åŒæ ‡ âš ï¸ éƒ¨åˆ†æ­£ç¡®

**Gemini çš„åˆ¤æ–­**ï¼šé”„åœ°åªæ£€æŸ¥ CanTillAtï¼ˆæ•°æ®å±‚ï¼‰ï¼Œä¸æ£€æŸ¥ç¢°æ’ä½“

**æˆ‘çš„éªŒè¯**ï¼š

`FarmTileManager.CanTillAt()` ç¡®å®åªæ£€æŸ¥ï¼š
1. æ˜¯å¦æœ‰ GroundBase Tilemap
2. æ˜¯å¦å·²ç»è€•è¿‡

**ä¸æ£€æŸ¥éšœç¢ç‰©ï¼**

**ä½† Gemini çš„æ–¹æ¡ˆæœ‰é—®é¢˜**ï¼š

Gemini å»ºè®®ç›´æ¥è°ƒç”¨ `PlacementValidator.HasObstacle()`ï¼Œä½†æŸ¥çœ‹å…¶å®ç°ï¼š

```csharp
// PlacementValidator.cs ç¬¬ 47 è¡Œï¼š
private string[] obstacleTags = new string[] { "Tree", "Rock", "Building", "Player" };
```

**é—®é¢˜**ï¼šåŒ…å« `Player` æ ‡ç­¾ï¼

- æ”¾ç½®ç‰©å“æ—¶ï¼šç©å®¶ç«™åœ¨ç›®æ ‡ä½ç½® = é”™è¯¯ï¼ˆåº”è¯¥çº¢è‰²ï¼‰
- é”„åœ°æ—¶ï¼šç©å®¶ç«™åœ¨æ—è¾¹ = æ­£å¸¸ï¼ˆä¸åº”è¯¥çº¢è‰²ï¼‰

**ç»“è®º**ï¼šâš ï¸ **éƒ¨åˆ†æ­£ç¡®**ã€‚

- âœ… å†œç”°ç³»ç»Ÿç¡®å®éœ€è¦éšœç¢ç‰©æ£€æµ‹
- âŒ ä¸èƒ½ç›´æ¥å¤ç”¨ `HasObstacle()`ï¼Œéœ€è¦æ’é™¤ `Player`

**æˆ‘çš„æ–¹æ¡ˆ**ï¼ˆä¸é”è¯„001å®¡è§†æŠ¥å‘Šä¸€è‡´ï¼‰ï¼š

```csharp
// åœ¨ PlacementValidator ä¸­æ–°å¢ï¼š
public bool HasFarmingObstacle(Vector3 cellCenter)
{
    // å†œç”°éšœç¢ç‰©æ ‡ç­¾ï¼ˆä¸å« Playerï¼‰
    string[] farmingObstacleTags = { "Tree", "Rock", "Building", "Chest" };
    // ... æ£€æµ‹é€»è¾‘
}
```

---

### å®¡è®¡ 3ï¼šäº¤äº’è·ç¦»æ— é™ âœ… ç¡®è®¤æ­£ç¡®

**Gemini çš„åˆ¤æ–­**ï¼šåªè¦é¼ æ ‡ç‚¹å¾—åˆ°ï¼Œå°±èƒ½é”„å¾—åˆ°

**æˆ‘çš„éªŒè¯**ï¼š

æŸ¥çœ‹ `FarmToolPreview.UpdateHoePreview()`ï¼š

```csharp
public void UpdateHoePreview(int layerIndex, Vector3Int cellPos)
{
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥é”„åœ°
    bool canTill = FarmTileManager.Instance != null && 
                   FarmTileManager.Instance.CanTillAt(layerIndex, cellPos);
    
    // æ›´æ–°çŠ¶æ€
    currentState = canTill ? FarmPreviewState.Valid : FarmPreviewState.Invalid;
    // ...
}
```

**æ²¡æœ‰è·ç¦»æ£€æµ‹ï¼**

**ç»“è®º**ï¼šâœ… **å®Œå…¨æ­£ç¡®**ã€‚è¿™ä¸æˆ‘åœ¨é”è¯„001å®¡è§†æŠ¥å‘Šä¸­çš„"è¡¥å……é—®é¢˜1"ä¸€è‡´ã€‚

**Gemini çš„æ–¹æ¡ˆ**ï¼šåŸºäº `PlacementGridCalculator` çš„æ ¼å­è·ç¦»

**æˆ‘çš„è¯„ä¼°**ï¼š

```csharp
// Gemini å»ºè®®çš„æ–¹å¼ï¼š
float distance = Vector2.Distance(playerPos, cellCenter);
bool inRange = distance <= farmToolReach;
```

è¿™ä¸ªæ–¹æ¡ˆæ˜¯æ­£ç¡®çš„ï¼Œä½†éœ€è¦æ³¨æ„ï¼š
- `farmToolReach` åº”è¯¥æ˜¯å¯é…ç½®çš„å‚æ•°
- åº”è¯¥ä½¿ç”¨ç©å®¶ Collider ä¸­å¿ƒï¼ˆ`playerCollider.bounds.center`ï¼‰ï¼Œè€Œä¸æ˜¯ Transform.position

---

## å››ã€Gemini éœ€æ±‚è¯„ä¼° (US)


### US-1ï¼šåŠ¨æ€ç©ºé—´æ„ŸçŸ¥ âœ… å®Œå…¨é‡‡çº³

**Gemini éœ€æ±‚**ï¼šé¢„è§ˆæ¡†å¿…é¡»æ ¹æ®ç©å®¶è„šä¸‹çš„å±‚çº§è‡ªåŠ¨åˆ‡æ¢ Sorting Layer

**æˆ‘çš„è¯„ä¼°**ï¼š

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| å¿…è¦æ€§ | âœ… å¿…é¡»å®ç°ï¼Œå¦åˆ™å¤šæ¥¼å±‚åœºæ™¯ä¼šå‡ºç°æ¸²æŸ“é”™è¯¯ |
| å¯è¡Œæ€§ | âœ… é«˜ï¼ŒPlacementLayerDetector å·²æä¾›å®Œæ•´ API |
| å¤æ‚åº¦ | ä½ |

**å®ç°å‚è€ƒ**ï¼ˆ`PlacementPreview.UpdateSortingLayer()`ï¼‰ï¼š

```csharp
public void UpdateSortingLayer(Transform playerTransform)
{
    string sortingLayer = PlacementLayerDetector.GetPlayerSortingLayer(playerTransform);
    _tilemapRenderer.sortingLayerName = sortingLayer;
}
```

**FarmToolPreview éœ€è¦æ–°å¢**ï¼š

```csharp
public void UpdateSortingLayer(Transform playerTransform)
{
    string sortingLayer = PlacementLayerDetector.GetPlayerSortingLayer(playerTransform);
    
    if (ghostTilemapRenderer != null)
        ghostTilemapRenderer.sortingLayerName = sortingLayer;
    if (cursorRenderer != null)
        cursorRenderer.sortingLayerName = sortingLayer;
}
```

---

### US-2ï¼šç»Ÿä¸€é¿éšœè§„åˆ™ âš ï¸ éƒ¨åˆ†é‡‡çº³

**Gemini éœ€æ±‚**ï¼šé”„åœ°/æ’­ç§å‰å¿…é¡»é€šè¿‡ PlacementValidator çš„éšœç¢ç‰©æ£€æµ‹

**æˆ‘çš„è¯„ä¼°**ï¼š

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| å¿…è¦æ€§ | âœ… å¿…é¡»å®ç°ï¼Œé˜²æ­¢åœ¨éšœç¢ç‰©ä¸Šé”„åœ° |
| å¯è¡Œæ€§ | âš ï¸ éœ€è¦ä¿®æ”¹ï¼Œä¸èƒ½ç›´æ¥å¤ç”¨ HasObstacle() |
| å¤æ‚åº¦ | ä¸­ |

**é—®é¢˜**ï¼š`PlacementValidator.HasObstacle()` åŒ…å« `Player` æ ‡ç­¾æ£€æµ‹

**æˆ‘çš„æ–¹æ¡ˆ**ï¼š

æ–¹æ¡ˆ Aï¼šåœ¨ `PlacementValidator` ä¸­æ–°å¢ `HasFarmingObstacle()` æ–¹æ³•
æ–¹æ¡ˆ Bï¼šåœ¨ `FarmToolPreview` ä¸­è‡ªè¡Œå®ç°éšœç¢ç‰©æ£€æµ‹

**æ¨èæ–¹æ¡ˆ A**ï¼Œä¿æŒä»£ç å¤ç”¨æ€§ï¼š

```csharp
// PlacementValidator.cs æ–°å¢ï¼š
private static readonly string[] FARMING_OBSTACLE_TAGS = { "Tree", "Rock", "Building", "Chest" };

public bool HasFarmingObstacle(Vector3 cellCenter)
{
    Vector2 boxSize = new Vector2(0.9f, 0.9f);
    Collider2D[] hits = Physics2D.OverlapBoxAll(cellCenter, boxSize, 0f);
    
    foreach (var hit in hits)
    {
        if (HasAnyTag(hit.transform, FARMING_OBSTACLE_TAGS))
            return true;
    }
    
    // æ£€æµ‹æ— ç¢°æ’ä½“çš„æ ‘è‹—å’Œç®±å­
    if (HasTreeAtPosition(cellCenter, 0.5f)) return true;
    if (HasChestAtPosition(cellCenter, 0.5f)) return true;
    
    return false;
}
```

---

### US-3ï¼šç§å­å½’åŒ– âœ… é‡‡çº³ï¼ˆç®€åŒ–ç‰ˆï¼‰

**Gemini éœ€æ±‚**ï¼šSeedData å¿…é¡»æ‹¥æœ‰é¢„è§ˆåé¦ˆï¼ˆçº¢/ç»¿æ¡†ï¼‰

**æˆ‘çš„è¯„ä¼°**ï¼š

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| å¿…è¦æ€§ | âœ… å¿…é¡»å®ç°ï¼Œæå‡ç”¨æˆ·ä½“éªŒ |
| å¯è¡Œæ€§ | âœ… é«˜ |
| å¤æ‚åº¦ | ä¸­ |

**Gemini çš„è§†è§‰ç­–ç•¥**ï¼š

> Seed Preview: ç§å­æ¨¡å¼ä¸‹ï¼Œ**éšè— GhostTilemap**ï¼Œåªæ˜¾ç¤º Cursorï¼ˆçº¢/ç»¿ï¼‰ï¼Œé¿å…è§†è§‰å™ªç‚¹ã€‚

**æˆ‘çš„è¯„ä¼°**ï¼šâœ… è¿™ä¸æˆ‘åœ¨é”è¯„001å®¡è§†æŠ¥å‘Šä¸­çš„ç®€åŒ–å»ºè®®ä¸€è‡´ã€‚

**ç§å­é¢„è§ˆæ£€æµ‹æ¡ä»¶**ï¼š

1. æ˜¯å¦åœ¨å·²è€•åœ°ä¸Šï¼ˆ`FarmTileManager.IsTilledAt()`ï¼‰
2. æ˜¯å¦å·²æœ‰ä½œç‰©ï¼ˆ`FarmTileManager.HasCropAt()`ï¼‰
3. å­£èŠ‚æ˜¯å¦æ­£ç¡®ï¼ˆ`SeedData.CanPlantInSeason()`ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š

```csharp
public void UpdateSeedPreview(int layerIndex, Vector3Int cellPos, SeedData seedData)
{
    isHoeMode = false;
    
    // éšè— GhostTilemapï¼ˆç§å­ä¸éœ€è¦ 1+8 é¢„è§ˆï¼‰
    ClearGhostTilemap();
    if (ghostTilemap != null)
        ghostTilemap.gameObject.SetActive(false);
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§æ¤
    bool canPlant = CheckCanPlantSeed(layerIndex, cellPos, seedData);
    
    currentState = canPlant ? FarmPreviewState.Valid : FarmPreviewState.Invalid;
    
    // æ›´æ–°å…‰æ ‡
    UpdateCursor(layerIndex, cellPos);
    
    // æ˜¾ç¤ºå…‰æ ‡
    if (cursorRenderer != null)
        cursorRenderer.gameObject.SetActive(true);
}
```

---

## äº”ã€Gemini ä»»åŠ¡è¯„ä¼° (T)

### T1ï¼šUpdateSortingLayer âœ… å®Œå…¨é‡‡çº³

**Gemini ä»»åŠ¡**ï¼šFarmToolPreview æ¥å…¥ PlacementLayerDetectorï¼Œå®ç° UpdateSortingLayer()

**æˆ‘çš„è¯„ä¼°**ï¼š

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| æ­£ç¡®æ€§ | âœ… å®Œå…¨æ­£ç¡® |
| ä¼˜å…ˆçº§ | P0ï¼ˆæœ€é«˜ï¼‰ |
| å¤æ‚åº¦ | ä½ |

**å®ç°è¦ç‚¹**ï¼š
- åœ¨ `UpdateHoePreview()` å’Œ `UpdateWateringPreview()` ä¸­è°ƒç”¨
- éœ€è¦ä¼ å…¥ `playerTransform` å‚æ•°

---

### T2ï¼šHasObstacle é›†æˆ âš ï¸ éœ€è¦ä¿®æ”¹

**Gemini ä»»åŠ¡**ï¼šFarmToolPreview æ¥å…¥ PlacementValidatorï¼Œå®ç° HasObstacle() æ£€æµ‹

**æˆ‘çš„è¯„ä¼°**ï¼š

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| æ­£ç¡®æ€§ | âš ï¸ æ–¹å‘æ­£ç¡®ï¼Œä½†éœ€è¦æ’é™¤ Player |
| ä¼˜å…ˆçº§ | P1 |
| å¤æ‚åº¦ | ä¸­ |

**ä¿®æ­£æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `HasFarmingObstacle()` è€Œé `HasObstacle()`

---

### T3ï¼šSeedData è·¯ç”± âœ… å®Œå…¨é‡‡çº³

**Gemini ä»»åŠ¡**ï¼šGameInputManager é‡æ„è·¯ç”±ï¼Œå°† SeedData å¯¼å‘ FarmToolPreview

**æˆ‘çš„è¯„ä¼°**ï¼š

| æ–¹é¢ | è¯„ä¼° |
|------|------|
| æ­£ç¡®æ€§ | âœ… å®Œå…¨æ­£ç¡® |
| ä¼˜å…ˆçº§ | P2 |
| å¤æ‚åº¦ | ä¸­ |

**å®ç°è¦ç‚¹**ï¼š

```csharp
// GameInputManager.UpdatePreviews() ä¿®æ”¹ï¼š
if (itemData is ToolData tool)
{
    // ... ç°æœ‰é€»è¾‘
}
else if (itemData is SeedData seed)
{
    // ğŸ”¥ æ–°å¢ï¼šç§å­è·¯ç”±åˆ° FarmToolPreview
    FarmToolPreview.Instance.UpdateSeedPreview(layerIndex, cellPos, seed);
}
else if (itemData is PlaceableItemData)
{
    // ... ç°æœ‰é€»è¾‘
}
```

---

## å…­ã€Gemini è®¾è®¡æµç¨‹è¯„ä¼°


### Logic Flow è¯„ä¼°

**Gemini æå‡ºçš„é€»è¾‘æµç¨‹**ï¼š

```
GameInputManager -> (æ‰‹æŒç§å­/å†œå…·) -> FarmToolPreview -> (æ¯å¸§ Update)
1. è·å–å¯¹é½åæ ‡ (PlacementGridCalculator)
2. è·å–å±‚çº§ä¿¡æ¯ (PlacementLayerDetector) -> åŒæ­¥ GhostTilemap å±‚çº§
3. æ£€æŸ¥éšœç¢ç‰© (PlacementValidator) -> å†³å®šé¢œè‰²
4. æ£€æŸ¥è·ç¦» (Vector2.Distance) -> å†³å®šæœ‰æ•ˆæ€§
```

**æˆ‘çš„è¯„ä¼°**ï¼š

| æ­¥éª¤ | è¯„ä¼° | è¯´æ˜ |
|------|------|------|
| æ­¥éª¤ 1 | âœ… æ­£ç¡® | å·²æœ‰å®ç° |
| æ­¥éª¤ 2 | âœ… æ­£ç¡® | éœ€è¦æ–°å¢ |
| æ­¥éª¤ 3 | âš ï¸ éœ€ä¿®æ”¹ | ä½¿ç”¨ HasFarmingObstacle() |
| æ­¥éª¤ 4 | âœ… æ­£ç¡® | éœ€è¦æ–°å¢ |

**è¡¥å……**ï¼šæ­¥éª¤ 4 åº”è¯¥ä½¿ç”¨ç©å®¶ Collider ä¸­å¿ƒè®¡ç®—è·ç¦»ï¼š

```csharp
// æ­£ç¡®çš„è·ç¦»è®¡ç®—
var playerCollider = playerTransform.GetComponent<Collider2D>();
Vector3 playerCenter = playerCollider != null 
    ? playerCollider.bounds.center 
    : playerTransform.position;

float distance = Vector2.Distance(playerCenter, cellCenter);
```

### Visual Strategy è¯„ä¼°

**Gemini æå‡ºçš„è§†è§‰ç­–ç•¥**ï¼š

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| GhostTilemap | æ˜¾ç¤º"1+8"çš„æ³¥åœŸå˜ä½“ |
| Cursor | æ˜¾ç¤ºçº¢/ç»¿/è“çŠ¶æ€ |
| Seed Preview | éšè— GhostTilemapï¼Œåªæ˜¾ç¤º Cursor |

**æˆ‘çš„è¯„ä¼°**ï¼šâœ… **å®Œå…¨æ­£ç¡®**ã€‚

è¿™ä¸ªç­–ç•¥æ¸…æ™°åœ°åŒºåˆ†äº†ä¸åŒæ¨¡å¼çš„è§†è§‰è¡¨ç°ï¼š
- é”„å¤´æ¨¡å¼ï¼šGhostTilemap + Cursor
- æ°´å£¶æ¨¡å¼ï¼šåªæœ‰ Cursorï¼ˆè“è‰²ï¼‰
- ç§å­æ¨¡å¼ï¼šåªæœ‰ Cursorï¼ˆçº¢/ç»¿ï¼‰

---

## ä¸ƒã€ç»¼åˆè¯„ä¼°

### Gemini é”è¯„002 è´¨é‡è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| é—®é¢˜è¯†åˆ« | â­â­â­â­â­ | è¡¥å……äº†è·ç¦»æ£€æµ‹é—®é¢˜ï¼Œè¦†ç›–å…¨é¢ |
| æ–¹æ¡ˆå¯è¡Œæ€§ | â­â­â­â­ | å¤§éƒ¨åˆ†å¯ç›´æ¥é‡‡çº³ï¼Œéšœç¢ç‰©æ£€æµ‹éœ€å¾®è°ƒ |
| æ¶æ„è®¾è®¡ | â­â­â­â­â­ | "ç©ºé—´å®ªæ³•"æ¯”å–»ç²¾å‡†ï¼ŒLogic Flow æ¸…æ™° |
| ä¸é¡¹ç›®å¥‘åˆåº¦ | â­â­â­â­ | å¯¹æ”¾ç½®ç³»ç»Ÿç†è§£æ·±å…¥ï¼Œé‡‡çº³äº†ç®€åŒ–å»ºè®® |

### é”è¯„001 vs é”è¯„002 å¯¹æ¯”

| ç»´åº¦ | é”è¯„001 | é”è¯„002 |
|------|---------|---------|
| é—®é¢˜è¦†ç›– | 3 ä¸ªé—®é¢˜ | 3 ä¸ªé—®é¢˜ + è·ç¦»æ£€æµ‹ |
| æ–¹æ¡ˆæˆç†Ÿåº¦ | åˆæ­¥æ–¹æ¡ˆ | å®Œæ•´æ¶æ„ |
| å·¥ä½œæµ | æ— æ˜ç¡®æµç¨‹ | Requirements -> Design -> Tasks |
| é‡‡çº³æˆ‘çš„å»ºè®® | - | âœ… ç§å­é¢„è§ˆç®€åŒ– |

### æœ€ç»ˆæ‰§è¡Œä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | å¤æ‚åº¦ | æ¥æº |
|--------|------|--------|------|
| P0 | åŠ¨æ€ Sorting Layer è·Ÿéš | ä½ | Gemini T1 |
| P1 | éšœç¢ç‰©æ£€æµ‹ï¼ˆHasFarmingObstacleï¼‰ | ä¸­ | Gemini T2ï¼ˆä¿®æ­£ç‰ˆï¼‰ |
| P1 | è·ç¦»æ£€æµ‹ | ä½ | Gemini å®¡è®¡3 |
| P2 | ç§å­é¢„è§ˆæ”¯æŒ | ä¸­ | Gemini T3 |
| P3 | NavGrid åˆ·æ–°é›†æˆ | ä½ | æˆ‘çš„è¡¥å…… |

---

## å…«ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

### ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰

1. **åœ¨ FarmToolPreview ä¸­æ–°å¢ UpdateSortingLayer() æ–¹æ³•**
2. **åœ¨ UpdateHoePreview/UpdateWateringPreview ä¸­è°ƒç”¨**

### æœ¬è½®å®Œæˆï¼ˆP1ï¼‰

1. **åœ¨ PlacementValidator ä¸­æ–°å¢ HasFarmingObstacle() æ–¹æ³•**
2. **åœ¨ FarmToolPreview ä¸­é›†æˆéšœç¢ç‰©æ£€æµ‹**
3. **åœ¨ FarmToolPreview ä¸­é›†æˆè·ç¦»æ£€æµ‹**

### åç»­è¿­ä»£ï¼ˆP2-P3ï¼‰

1. **å®ç°ç§å­é¢„è§ˆæ”¯æŒ**
2. **é›†æˆ NavGrid åˆ·æ–°**

---

## ä¹ã€ç»“è®º

Gemini çš„é”è¯„002 æ˜¯ä¸€ä»½é«˜è´¨é‡çš„æ¶æ„å‡çº§æ–‡æ¡£ï¼Œç›¸æ¯”é”è¯„001 æœ‰æ˜æ˜¾è¿›æ­¥ï¼š

1. **è¡¥å……äº†è·ç¦»æ£€æµ‹é—®é¢˜** - å“åº”äº†æˆ‘çš„åé¦ˆ
2. **é‡‡çº³äº†ç§å­é¢„è§ˆç®€åŒ–å»ºè®®** - åªæ˜¾ç¤ºå…‰æ ‡ï¼Œä¸æ˜¾ç¤ºä½œç‰©å®Œå…¨ä½“
3. **æå‡ºäº†æ¸…æ™°çš„ Logic Flow** - ä¾¿äºå®ç°
4. **"ç©ºé—´å®ªæ³•"æ¯”å–»ç²¾å‡†** - å¼ºè°ƒäº† PlacementLayerDetector çš„æ ¸å¿ƒåœ°ä½

**å”¯ä¸€éœ€è¦ä¿®æ­£çš„ç‚¹**ï¼šéšœç¢ç‰©æ£€æµ‹éœ€è¦æ’é™¤ Player æ ‡ç­¾ï¼Œä½¿ç”¨ `HasFarmingObstacle()` è€Œé `HasObstacle()`ã€‚

---

**å®¡è§†å®Œæˆæ—¶é—´**: 2026-02-08
**å®¡è§†è€…**: Kiro
