# 农田系统 + 放置系统 最终交互矩阵

**创建日期**: 2026-02-10
**适用范围**: 全局对照文档，所有农田/放置交互必须遵守此矩阵
**核心原则**: 无法交互的地方就是什么都不触发

---

## 一、状态定义

### 农田系统状态（FarmNavState）
| 状态 | 含义 | 预览行为 |
|------|------|---------|
| Idle | 空闲，手持非农具 | 无预览 |
| Preview | 预览跟随鼠标 | 实时跟随鼠标，显示红/绿/蓝 |
| Locked | 预览锁定在目标位置 | 视觉冻结在锁定点 |
| Navigating | 正在导航到目标 | 视觉冻结在锁定点 |
| Executing | 正在执行动作 | 视觉冻结在锁定点 |

### 放置系统状态（PlacementState）
| 状态 | 含义 | 预览行为 |
|------|------|---------|
| Idle | 空闲 | 无预览 |
| Preview | 预览跟随鼠标 | 实时跟随鼠标，显示红/绿 |
| Locked | 位置锁定 | 视觉冻结在锁定点 |
| Navigating | 导航中 | 视觉冻结在锁定点 |

---

## 二、农田系统交互矩阵

### 左键点击

| 当前状态 | 预览颜色 | 距离 | 行为 | 结果状态 |
|---------|---------|------|------|---------|
| Preview | 绿色/蓝色 | 近 | 锁定→执行→解锁 | Preview |
| Preview | 绿色/蓝色 | 远 | 锁定→导航→到达→执行→解锁 | Navigating→Preview |
| Preview | 红色 | 任意 | **什么都不做** | Preview |
| Locked | 绿色 | 任意 | 取消旧→重新锁定→导航 | Navigating |
| Locked | 红色 | 任意 | **取消导航→恢复跟随** | Preview |
| Navigating | 绿色 | 任意 | 取消旧导航→重新锁定→导航 | Navigating |
| Navigating | 红色 | 任意 | **取消导航→恢复跟随** | Preview |
| Executing | 任意 | 任意 | **忽略（执行保护）** | Executing |

### 右键点击

| 当前状态 | 行为 | 结果状态 |
|---------|------|---------|
| Preview | 正常右键导航（不影响农田预览） | Preview |
| Locked | **立即取消锁定→恢复跟随** + 执行右键导航 | Preview |
| Navigating | **立即取消导航→恢复跟随** + 执行右键导航 | Preview |
| Executing | 忽略 | Executing |

### WASD 移动

| 当前状态 | 行为 | 结果状态 |
|---------|------|---------|
| Preview | 正常移动 | Preview |
| Locked | **取消锁定→恢复跟随** + 正常移动 | Preview |
| Navigating | **取消导航→恢复跟随** + 正常移动 | Preview |
| Executing | 缓存方向（ToolActionLock） | Executing |

### ESC 键

| 当前状态 | 面板状态 | 行为 |
|---------|---------|------|
| 任意 | 面板打开 | 关闭面板（不影响农田状态） |
| Locked/Navigating | 面板关闭 | 取消导航→恢复跟随 |
| Preview | 面板关闭 | 打开设置面板 |

### 工具/物品切换（滚轮/数字键）

| 当前状态 | 行为 | 结果状态 |
|---------|------|---------|
| 任意非 Idle | 取消导航→切换工具 | Idle 或 Preview（取决于新工具） |

### 面板打开/关闭

| 当前状态 | 面板操作 | 行为 |
|---------|---------|------|
| 任意 | 打开面板 | **暂停**预览更新，不中断，不取消导航 |
| 任意 | 关闭面板 | **恢复**之前的状态，继续预览/导航 |

---

## 三、放置系统交互矩阵

### 左键点击

| 当前状态 | 预览颜色 | 距离 | 行为 | 结果状态 |
|---------|---------|------|------|---------|
| Preview | 绿色 | 近 | 锁定→直接放置→解锁 | Preview（有剩余）/ Idle |
| Preview | 绿色 | 远 | 锁定→导航→到达→放置→解锁 | Navigating→Preview/Idle |
| Preview | 红色 | 任意 | **什么都不做** | Preview |
| Navigating | 绿色 | 任意 | 取消旧导航→重新锁定→导航 | Navigating |
| Navigating | 红色 | 任意 | **取消导航→恢复跟随** | Preview |

### 右键/ESC

| 当前状态 | 行为 | 结果状态 |
|---------|------|---------|
| Preview | 退出放置模式 | Idle |
| Locked | 退出放置模式 | Idle |
| Navigating | **取消导航→恢复跟随** | Preview |

### WASD 移动

| 当前状态 | 行为 | 结果状态 |
|---------|------|---------|
| Preview | 正常移动 | Preview |
| Locked | **取消锁定→恢复跟随** + 正常移动 | Preview |
| Navigating | **取消导航→恢复跟随** + 正常移动 | Preview |

### 面板打开/关闭

| 当前状态 | 面板操作 | 行为 |
|---------|---------|------|
| 任意 | 打开面板 | **暂停**预览更新，不中断，不取消导航 |
| 任意 | 关闭面板 | **恢复**之前的状态 |

### 工具/物品切换

| 当前状态 | 行为 | 结果状态 |
|---------|------|---------|
| Locked/Navigating | 取消导航→退出放置模式 | Idle |
| Preview | 退出放置模式→进入新物品模式 | Idle 或新 Preview |

---

## 四、跨系统规则

### 优先级
1. 农田工具（锄头/水壶/种子）由农田系统处理，**不穿透**到通用工具处理
2. 放置物品（PlaceableItemData）由放置系统处理
3. 其他工具/武器由通用处理

### 互斥
- 农田系统和放置系统不会同时激活
- 农田工具不进入放置系统（SeedData 在 EnterPlacementMode 中被拦截）

### 统一原则
1. **红色 = 什么都不触发**（无动画、无动作、无导航）
2. **撤回权始终在玩家手中**（WASD/ESC/右键 随时可取消）
3. **面板 = 暂停不中断**（打开面板冻结事件，关闭恢复）
4. **导航中点击红色 = 取消一切**（取消导航 + 解锁预览 + 恢复跟随）
5. **导航中点击绿色 = 重新导航**（取消旧导航 + 锁定新位置 + 开始新导航）
