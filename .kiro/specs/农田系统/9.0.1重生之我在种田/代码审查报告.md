# å†œç”°ç³»ç»Ÿä»£ç å®¡æŸ¥æŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-05  
**ç›®çš„**: è¯Šæ–­é”„åœ°åŠŸèƒ½å¤±æ•ˆçš„å…·ä½“åŸå› 

---

## ä¸€ã€è°ƒç”¨é“¾åˆ†æ

### å®Œæ•´è°ƒç”¨é“¾

```
ç”¨æˆ·ç‚¹å‡»å·¦é”®ï¼ˆæ‰‹æŒé”„å¤´ï¼‰
    â†“
GameInputManager.HandleUseCurrentTool()
    â†“
TryHandleFarmingTool(tool)  // tool.toolType == ToolType.Hoe
    â†“
TryTillSoil(worldPosition)
    â†“
FarmTileManager.Instance  // â˜… æ£€æŸ¥ç‚¹ 1ï¼šå•ä¾‹æ˜¯å¦å­˜åœ¨
    â†“
GetCurrentLayerIndex(worldPosition)  // è¿”å› 0
    â†“
GetLayerTilemaps(0)  // â˜… æ£€æŸ¥ç‚¹ 2ï¼šé…ç½®æ˜¯å¦æœ‰æ•ˆ
    â†“
tilemaps.WorldToCell(worldPosition)  // â˜… æ£€æŸ¥ç‚¹ 3ï¼šåæ ‡è½¬æ¢
    â†“
ion)  // â˜… æ£€æŸ¥ç‚¹ 4ï¼šæ˜¯å¦å¯è€•ä½œ
    â†“
CreateTile(layerIndex, cellPosition)  // â˜… æ£€æŸ¥ç‚¹ 5ï¼šåˆ›å»ºè€•åœ°æ•°æ®
    â†“
FarmlandBorderManager.Instance.terBlockPlaced()  // â˜… æ£€æŸ¥ç‚¹ 6ï¼šè¾¹ç•Œç®¡ç†å™¨
    â†“
tilemaps.farmlandCenterTilemap.SetTile()  // â˜… æ£€æŸ¥ç‚¹ 7ï¼šæ”¾ç½® Tile
```

---

## äºŒã€é€ä¸ªæ£€æŸ¥ç‚¹åˆ†æ

### æ£€æŸ¥ç‚¹ 1ï¼šFarmTileManager.Instance

**ä»£ç ä½ç½®**: `FarmTileManager.cs` Awake()

```csharp
te void Awake()
{
    if (Instance == null)
    {
        Instance = this;
        InitializeDataStructures();
    }
    else
    {
        Destroy(gameObject);
    }
}
```

**å¯èƒ½çš„å¤±è´¥åŸå› **:
- åœºæ™¯ä¸­æ²¡æœ‰ FarmTileManager ç»„ä»¶
- FarmTileManager çš„ GameObject æœªæ¿€æ´»

**è¯Šæ–­æ–¹æ³•**: 
- æ£€æŸ¥ Console æ˜¯å¦æœ‰ `[GameInputManager] FarmTileManager æœªåˆå§‹åŒ–` æ—¥å¿—

---

### æ£€æŸ¥ç‚¹ 2ï¼šGetLayerTilemaps(0)

**ä»£ç ä½ç½®**: `FarmTileManager.cs`

```csharp
public LayerTilemaps GetLayerTilemaps(int layerIndex)
{
    if (layerTilemaps == null || layerIndex < 0 || layerIndex >= layerTilemaps.Length)
    {
        return null;
    }
    return layerTilemaps[layerIndex];
}
```

**ç”¨æˆ·é…ç½®çŠ¶æ€**ï¼ˆæ¥è‡ªæˆªå›¾ï¼‰:
- âœ… `layerTilemaps[0]` å­˜åœ¨
- âœ… r 1"
- âœ… `farmlandCenterTilemap` = Layer 1 - Farmland_Center (Tilemap)
- âœ… `farmlandBorderTilemap` = Layer 1 - Farmland_Border (Tilemap)
- â“ `groundTilemap` = æ— 

**åˆ†æ**: é…ç½®çœ‹èµ·æ¥æ˜¯å®Œæ•´çš„ï¼Œä¸åº”è¯¥è¿”å› nullã€‚

---

### æ£€æŸ¥ç‚¹ 3ï¼šWorldToCell åæ ‡è½¬æ¢

**ä»£ç ä½ç½®**: `LayerTilemaps.cs`

```csharp
public Vector3Int WorldToCell(Vector3 worldPosition)
{
    // ä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆå­—æ®µ
    if (farmlandCenterTilemap != null)
    {
        rrldPosition);
    }
    // ...
}
```

**åˆ†æ**: 
- ç”¨æˆ·é…ç½®äº† `farmlandCenterTilemap`ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨å®ƒè¿›è¡Œåæ ‡è½¬æ¢
- è¿™åº”è¯¥æ˜¯æ­£ç¡®çš„

---

###æ£€æŸ¥ç‚¹ 4ï¼šCanTillAt æ£€æŸ¥

**ä»£ç ä½ç½®**: `FarmTileManager.cs`

```csharp
public bool CanTillAt(int layerIndex, Vector3Int cellPosition)
{
    // æ£€æŸ¥æ¥¼å±‚æ˜¯å¦æœ‰æ•ˆ

    {
        return false;  // â˜… å¯èƒ½çš„å¤±è´¥ç‚¹ A
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è€•åœ°
    if (layerTiles.TryGetValue(cellPosition, out var existingTile))
    {
        if (existingTile.isTilled)
        {
            return false;  // â˜… å¯èƒ½çš„å¤±è´¥ç‚¹ Bï¼šé‡å¤é”„åœ°
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰åœ°é¢ Tile
    var tilemaps = GetLayerTilemaps(layerIndex);
    if (tilemaps == null || !tilemaps.IsValid())
    {
        return false;  // â˜… å¯èƒ½çš„å¤±è´¥ç‚¹ C
    }
    
    if (tilemaps.groundTilemap != null)
    {
groundTilemap.GetTile(cellPosition);
        if ull)
        {
            return false;  // â˜… å¯èƒ½çš„å¤±è´¥ç‚¹ D
        }
    }
    // å¦‚æœ groundTilemap == nullï¼Œè·³è¿‡æ£€æŸ¥
    
    return true;
}
```

**å…³é”®å‘ç°**:
- ç”¨æˆ·çš„ `groundTilemap` ä¸ºç©ºï¼ˆ"æ— "ï¼‰
- å½“ `groundTilemap == null` æ—¶ï¼Œæ£€æŸ¥ä¼šè¢«**è·³è¿‡**ï¼Œä¸ä¼šè¿”å› false
- æ‰€ä»¥ `groundTilemap` ä¸ºç©º**ä¸åº”è¯¥**é˜»æ­¢é”„åœ°

**å¯èƒ½çš„å¤±è´¥ç‚¹**:
- A: `farmTilesByLayer` æ²¡æœ‰ layerIndex=0 çš„æ¡ç›®
- B: è¯¥ä½ç½®å·²ç»æœ‰è€•åœ°ï¼ˆé‡å¤é”„åœ°ï¼‰
- C: `tilemaps.IsValid()` è¿”å› false

---

### æ£€æŸ¥ç‚¹ 5ï¼šCreateTile

**ä»£ç ä½ç½®**: `FarmTileManager.cs`

```csharp
public bool CreateTile(int layerIndex, Vector3Int cellPosition)
{
// ... æ£€æŸ¥é€»è¾‘ ...
    
    // åˆ›å»ºè€•åœ°æ•°æ®
n, layerIndex);
    newTile.isTilled = true;
    newTile.moistureState = SoilMoistureState.Dry;
    
    layerTiles[cellPosition] = newTile;
    
    // é€šçŸ¥è¾¹ç•Œç®¡ç†å™¨æ›´æ–°è¾¹ç•Œ
    if (FarmlandBorderManager.Instance != null)
    {
        FarmlandBorderManager.Instance.OnCenterBlockPlaced(layerIndex, cellPosition);
    }
    
    return true;
}
```

**åˆ†æ**: å¦‚æœèƒ½èµ°åˆ°è¿™é‡Œï¼Œæ•°æ®åº”è¯¥ä¼šè¢«åˆ›å»ºã€‚

---

### æ£€æŸ¥ç‚¹ 6ï¼šFarmlandBorderManager.OnCenterBlockPlaced

**ä»£ç ä½ç½®**: `FarmlandBorderManager.cs`

```csharp
public void OnCenterBlockPlaced(index, Vector3Int cellPosition, bool isFertilized = false)
{
    var tilemaps = FarmTileManager.InstancrTilemaps(layerIndex);
    if (tilemaps == null || !tilemaps.IsNewFarmlandSystemValid())
    {
        if (showDebugInfo)
            Debug.LogWarning($"[FarmlandBorderManager] æ¥¼å±‚ {layerIndex} çš„æ–°ç‰ˆè€•åœ° Tilemap æœªé…ç½®");
        return;  // â˜… å¯èƒ½çš„å¤±è´¥ç‚¹
    }
    
    // 1. æ”¾ç½®ä¸­å¿ƒå—
    TileBase centerTile = isFertilized ? centerTileFertilized : centerTileUnfertilized;
    tilemaps.farmlandCenterTilemap.SetTile(cellPosition, centerTile);
    
    // ...
}
```

**å…³é”®æ£€æŸ¥**: `IsNewFarmlandSystemValid()`

```csharp
armlandSystemValid()
{
 && farmlandBorderTilemap != null;
}
```

**ç”¨æˆ·é…ç½®çŠ¶æ€**:
- âœ… `farmlandCenterTilemap` = Layer 1 - Farmland_Center (Tilemap)
- âœ… `farmlandBorderTilemap` = Layer 1 - Farmland_Border (Tilemap)

**åˆ†æ**: é…ç½®æ˜¯å®Œæ•´çš„ï¼Œ`IsNewFarmlandSystemValid()` åº”è¯¥è¿”å› trueã€‚

---

### æ£€æŸ¥ç‚¹ 7ï¼šSetTile

**ä»£ç ä½ç½®**: `FarmlandBorderManager.cs`

```csharp
TileBase centerTile = isFertilized ? centerTileFertilized : centerTileUnfertilized;
tilemaps.farmlandCenterTilemap.SetTile(cellPosition, centerTile);
```

**ç”¨æˆ·é…ç½®çŠ¶æ€**ï¼ˆæ¥è‡ªæˆªå›¾ï¼‰:
- âœ… `centerTileUnfeTile_Farm_C0
- âœ… `centerTileFertilized` = Tile_Farm_C1

é…ç½®ï¼Œåº”è¯¥èƒ½æ­£å¸¸æ”¾ç½®ã€‚

---

## ä¸‰ã€ğŸ”´ æœ€å¯èƒ½çš„å¤±è´¥åŸå› 

æ ¹æ®ä»£ç åˆ†æï¼Œæœ€å¯èƒ½çš„å¤±è´¥åŸå› æ˜¯ï¼š

### åŸå›  1ï¼šFarmlandBorderManager.Instance ä¸º null

**ä»£ç ä½ç½®**: `FarmTileManager.CreateTile()`

```csharp
if (FarmlandBorderManager.Instance != null)
{
*è¿è¡Œæ—¶ bug**ï¼Œä¸æ˜¯æ¶æ„é—®é¢˜ã€‚éœ€è¦é€šè¿‡æ—¥å¿—å®šä½å…·ä½“å¤±è´¥ç‚¹ï¼Œè€Œä¸æ˜¯é‡æ„æ•´ä¸ªç³»ç»Ÿã€‚

---

**æ–‡æ¡£ä½œè€…**: Kiro  
**æœ€åæ›´æ–°**: 2026-02-05
ager] æ¥¼å±‚ 0 çš„ Tilemap æœªé…ç½®` | é…ç½®é—®é¢˜ |
| `[GameInputManager] æ— æ³•åœ¨ (x,y,z) è€•ä½œ` | CanTillAt è¿”å› false |
| `[FarmTileManager] è¯¥ä½ç½®å·²æœ‰è€•åœ°` | é‡å¤é”„åœ° |
| `[FarmTileManager] åˆ›å»ºè€•åœ°: Layer=0, Pos=(x,y,z)` | æ•°æ®åˆ›å»ºæˆåŠŸ |
| `[FarmlandBorderManager] æ”¾ç½®ä¸­å¿ƒå—: Layer=0, Pos=(x,y,z)` | Tile æ”¾ç½®æˆåŠŸ |
| `[FarmlandBorderManager] æ¥¼å±‚ 0 çš„æ–°ç‰ˆè€•åœ° Tilemap æœªé…ç½®` | æ–°ç‰ˆé…ç½®æ— æ•ˆ |

---

## äº”ã€å¯¹ Code Reaper é”è¯„çš„å›åº”

è¯¦è§ `é”è¯„å›åº”ä¸ç‹¬ç«‹æ€è€ƒ.md`ã€‚

**æ ¸å¿ƒè§‚ç‚¹**:
1. **ä¸åŒæ„"è‡ªåŠ¨æ‰«æ"** - ä¸ç¬¦åˆé¡¹ç›®é£æ ¼ï¼Œæ‰‹åŠ¨é…ç½®æ›´å¯é 
2. **åŒæ„"å­˜æ¡£é›†æˆ"** - ä½†è¿™æ˜¯åç»­å·¥ä½œï¼Œä¸æ˜¯å½“å‰ bug çš„åŸå› 
3. **ä¸åŒæ„"æ•°æ®è¡¨ç°åˆ†ç¦»"** - å½“å‰æ¶æ„å·²ç»æ˜¯åˆ†ç¦»çš„

**å½“å‰é—®é¢˜çš„æœ¬è´¨**:
è¿™æ˜¯ä¸€ä¸ª*æ£€æµ‹å¤±è´¥ |
| `[GameInputManager] FarmTileManager æœªåˆå§‹åŒ–` | å•ä¾‹æœªåˆå§‹åŒ– |
| `[GameInputMan
### æ­¥éª¤ 1ï¼šæ£€æŸ¥ç»„ä»¶å­˜åœ¨æ€§

1. åœ¨ Hierarchy ä¸­æœç´¢ `FarmTileManager`
2. ç¡®è®¤å®ƒå­˜åœ¨ä¸” GameObject æ˜¯æ¿€æ´»çš„
3. åœ¨ Hierarchy ä¸­æœç´¢ `FarmlandBorderManager`
4. ç¡®è®¤å®ƒå­˜åœ¨ä¸” GameObject æ˜¯æ¿€æ´»çš„

### æ­¥éª¤ 2ï¼šå¼€å¯è°ƒè¯•æ—¥å¿—

1. é€‰ä¸­ `FarmTileManager` ç»„ä»¶
2. å‹¾é€‰ `Show Debug Info`
3. é€‰ä¸­ `FarmlandBorderManager` ç»„ä»¶
4. å‹¾é€‰ `Show Debug Info`
5. é€‰ä¸­ `GameInputManager` ç»„ä»¶
6. å‹¾é€‰ `Show Debug Info`

### æ­¥éª¤ 3ï¼šè¿è¡Œæµ‹è¯•

1. è¿è¡Œæ¸¸æˆ
2. æ‰‹æŒé”„å¤´
3. ç‚¹å‡»åœ°é¢å°è¯•é”„åœ°
4. æŸ¥çœ‹ Unity Console çš„æ—¥å¿—è¾“å‡º

### æ­¥éª¤ 4ï¼šæŠ¥å‘Šæ—¥å¿—

è¯·å‘Šè¯‰æˆ‘ Console è¾“å‡ºäº†ä»€ä¹ˆæ—¥å¿—ï¼Œå¯èƒ½çš„æƒ…å†µï¼š

| æ—¥å¿—å†…å®¹ | å«ä¹‰ |
|---------|------|
| `[GameInputManager] é”„åœ°å¤±è´¥ï¼šè·ç¦»è¿‡è¿œ` | è·ç¦»éª¤ï¼š
) > farmToolReach)
{
    if (showDebugInfo)
        Debug.Log($"[GameInputManager] é”„åœ°å¤±è´¥ï¼šè·ç¦»è¿‡è¿œ ...");
    return false;
}
```

**é…ç½®**: `farmToolReach = 1.5f`ï¼ˆé»˜è®¤å€¼ï¼‰

**é—®é¢˜**: å¦‚æœ `showDebugInfo = false`ï¼Œè·ç¦»æ£€æµ‹å¤±è´¥æ—¶ä¸ä¼šæœ‰æ—¥å¿—è¾“å‡ºã€‚

**éªŒè¯æ–¹æ³•**: 
- åœ¨ GameInputManager çš„ Inspector ä¸­å‹¾é€‰ `Show Debug Info`
- é‡æ–°å°è¯•é”„åœ°ï¼ŒæŸ¥çœ‹ Console æ—¥å¿—

---

### åŸå›  3ï¼šCanTillAt è¿”å› false

**å¯èƒ½çš„å­åŸå› **:
- `farmTilesByLayer` æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–
- è¯¥ä½ç½®å·²ç»æœ‰è€•åœ°ï¼ˆé‡å¤é”„åœ°ï¼‰

**éªŒè¯æ–¹æ³•**: 
- å‹¾é€‰ `FarmTileManager.showDebugInfo`
- æŸ¥çœ‹æ˜¯å¦æœ‰ `[FarmTileManager] è¯¥ä½ç½®å·²æœ‰è€•åœ°` æ—¥å¿—

---

## å››ã€è¯Šæ–­æ­¥éª¤

è¯·åœ¨ Unity ä¸­æ‰§è¡Œä»¥ä¸‹æ­¥ryTillSoil()`

```csharp
// â˜… è·ç¦»æ£€æµ‹ï¼šæ£€æŸ¥ç©å®¶åˆ°ç›®æ ‡æ ¼å­çš„è·ç¦»
Vector2 playerCenter = GetPlayerCenter();
if (Vector2.Distance(playerCenter, worldPosition    FarmlandBorderManager.Instance.OnCenterBlockPlaced(layerIndex, cellPosition);
}
```

**é—®é¢˜**: å¦‚æœ `FarmlandBorderManager.Instance == null`ï¼Œè¿™ä¸ª if å—ä¼šè¢«**é™é»˜è·³è¿‡**ï¼Œä¸ä¼šæœ‰ä»»ä½•æ—¥å¿—è¾“å‡ºï¼

**éªŒè¯æ–¹æ³•**: 
- æ£€æŸ¥åœºæ™¯ä¸­æ˜¯å¦æœ‰ FarmlandBorderManager ç»„ä»¶
- æ£€æŸ¥ FarmlandBorderManager çš„ GameObject æ˜¯å¦æ¿€æ´»

---

### åŸå›  2ï¼šè·ç¦»æ£€æµ‹å¤±è´¥

**ä»£ç ä½ç½®**: `GameInputManager.T