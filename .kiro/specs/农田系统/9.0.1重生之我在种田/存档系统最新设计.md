# 存档系统最新设计要点

**整理日期**: 2026-02-05  
**数据来源**: `.kiro/specs/999_全面重构_26.01.27/3.7.x` 系列工作区

---

## 一、存档系统架构概览

```
┌─────────────────────────────────────────────────────────┐
│                    存档系统架构                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  SaveManager                                            │
│  ├─ 统一存档入口                                       │
│  ├─ 调用各子系统的 Save/Load                           │
│  └─ 管理存档槽位                                       │
│                                                         │
│  PrefabDatabase（自动化）                               │
│  ├─ 自动扫描项目中的 Prefab                            │
│  ├─ 建立 prefabKey → Prefab 映射                       │
│  └─ 替代手动配置的 PrefabRegistry                      │
│                                                         │
│  DynamicObjectFactory                                   │
│  ├─ 负责动态对象的重建                                 │
│  ├─ 支持：树苗、掉落物、箱子、石头                     │
│  └─ 使用 PrefabDatabase 获取 Prefab                    │
│                                                         │
│  PersistentObjectRegistry                               │
│  ├─ 管理所有持久化对象的 GUID                          │
│  ├─ 提供 GUID → 对象 的查询                            │
│  └─ 场景加载时自动注册                                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 二、核心组件详解

### 2.1 PrefabDatabase 自动化方案

**问题背景**：
- 原 PrefabRegistry 需要手动配置每个 Prefab
- 容易遗漏，维护成本高

**解决方案**：
- PrefabDatabase 自动扫描 `Assets/222_Prefabs/` 目录
- 使用 Prefab 名称作为 prefabKey
- 运行时自动建立映射

**关键代码位置**：
- `Assets/YYY_Scripts/Data/Core/PrefabDatabase.cs`

### 2.2 DynamicObjectFactory

**职责**：
- 根据存档数据重建动态对象
- 支持的对象类型：
  - 树苗（Sapling）
  - 掉落物（WorldItemPickup）
  - 箱子（ChestController）
  - 石头（StoneController）

**重建流程**：
```
1. 读取 WorldObjectSaveData
2. 根据 prefabKey 从 PrefabDatabase 获取 Prefab
3. 实例化 Prefab
4. 恢复位置、旋转、缩放
5. 恢复组件特定数据（如箱子内容物）
6. 恢复渲染层级（sortingLayerName, sortingOrder）
```

**关键代码位置**：
- `Assets/YYY_Scripts/Data/Core/DynamicObjectFactory.cs`

### 2.3 GUID 自动化管理

**问题背景**：
- 手动管理 GUID 容易出错
- Prefab 实例化后 GUID 可能重复
- 场景保存时 GUID 可能丢失

**解决方案**：PersistentIdAutomator

**功能**：
- 场景保存时自动检查所有 PersistentId 组件
- 自动修复空 GUID
- 自动修复重复 GUID
- 在 Console 输出修复日志

**触发时机**：
- `EditorSceneManager.sceneSaving` 事件

**关键代码位置**：
- `Assets/Editor/PersistentIdAutomator.cs`
- `Assets/Editor/PersistentIdValidator.cs`

---

## 三、存档数据结构

### 3.1 WorldObjectSaveData

```csharp
[Serializable]
public class WorldObjectSaveData
{
    public string persistentId;      // GUID
    public string prefabKey;         // Prefab 名称
    public Vector3 position;         // 位置
    public Quaternion rotation;      // 旋转
    public Vector3 scale;            // 缩放
    public string sortingLayerName;  // 渲染层级名称（新增）
    public int sortingOrder;         // 渲染顺序（新增）
    public string customData;        // 组件特定数据（JSON）
}
```

### 3.2 组件特定数据（customData）

不同类型的对象有不同的 customData 格式：

**箱子（ChestController）**：
```json
{
    "items": [
        {"itemId": 1001, "quantity": 5, "slotIndex": 0},
        {"itemId": 1002, "quantity": 3, "slotIndex": 1}
    ]
}
```

**树苗（SaplingController）**：
```json
{
    "plantedDay": 15,
    "growthStage": 2,
    "treeDataId": "tree_oak"
}
```

**掉落物（WorldItemPickup）**：
```json
{
    "itemId": 1001,
    "quantity": 1
}
```

---

## 四、关键修复记录

### 4.1 玩家位置存档修复（3.7.1）
- **问题**：加载存档后玩家瞬移到错误位置
- **原因**：存档时使用了错误的坐标
- **修复**：使用 `playerCollider.bounds.center` 作为存档位置

### 4.2 动态对象重建机制（3.7.2）
- **问题**：动态生成的对象（树苗、掉落物）加载后消失
- **原因**：缺少动态对象的重建逻辑
- **修复**：实现 DynamicObjectFactory

### 4.3 GUID 漂移修复（3.7.3）
- **问题**：对象的 GUID 在场景保存后发生变化
- **原因**：Prefab 实例化时 GUID 被重置
- **修复**：实现 PersistentIdAutomator 自动修复

### 4.4 石头假死机制（3.7.4）
- **问题**：石头被破坏后，加载存档时重新出现
- **原因**：石头使用 Destroy() 而非状态标记
- **修复**：改用 SetActive(false)，存档时记录激活状态

### 4.5 箱子 IsEmpty 修复（3.7.4）
- **问题**：箱子判空逻辑错误
- **原因**：同时检查了 _inventory 和 _inventoryV2
- **修复**：只检查 _inventory

### 4.6 季节渐变存档修复（3.7.6）
- **问题**：加载存档后季节渐变效果不一致
- **原因**：使用了不稳定的随机种子
- **修复**：使用 `persistentId.GetHashCode()` 作为稳定种子

### 4.7 渲染层级存档（3.7.6）
- **问题**：加载存档后对象渲染层级错误
- **原因**：未存档 sortingLayerName 和 sortingOrder
- **修复**：WorldObjectSaveData 新增这两个字段

---

## 五、存档系统与农田系统集成建议

### 5.1 耕地状态存档

```csharp
[Serializable]
public class FarmTileSaveData
{
    public Vector3Int position;      // Tilemap 坐标
    public bool isTilled;            // 是否已耕作
    public bool isWatered;           // 是否已浇水
    public int lastWateredDay;       // 最后浇水日期
}
```

### 5.2 作物存档

```csharp
[Serializable]
public class CropSaveData
{
    public string persistentId;      // GUID
    public Vector3Int tilePosition;  // 所在耕地坐标
    public string cropDataId;        // CropData SO 的 ID
    public int plantedDay;           // 种植日期
    public int growthStage;          // 当前生长阶段
    public int wateredDays;          // 累计浇水天数
}
```

### 5.3 集成要点

1. **FarmTileManager 需要实现 ISaveable 接口**
2. **CropController 需要有 PersistentId 组件**
3. **作物重建需要在 DynamicObjectFactory 中添加支持**
4. **耕地 Tilemap 状态需要单独存档**

---

## 六、相关文件索引

| 文件路径 | 说明 |
|---------|------|
| `Assets/YYY_Scripts/Data/Core/SaveManager.cs` | 存档管理器 |
| `Assets/YYY_Scripts/Data/Core/PrefabDatabase.cs` | Prefab 数据库 |
| `Assets/YYY_Scripts/Data/Core/DynamicObjectFactory.cs` | 动态对象工厂 |
| `Assets/YYY_Scripts/Data/Core/PersistentObjectRegistry.cs` | 持久化对象注册表 |
| `Assets/Editor/PersistentIdAutomator.cs` | GUID 自动化工具 |
| `Assets/Editor/PersistentIdValidator.cs` | GUID 验证工具 |
| `.kiro/specs/999_全面重构_26.01.27/3.7.2存档bug大清扫/` | 动态对象重建 |
| `.kiro/specs/999_全面重构_26.01.27/3.7.3消失bug/` | GUID 漂移修复 |
| `.kiro/specs/999_全面重构_26.01.27/3.7.5自动化存档/` | PrefabDatabase 自动化 |
| `.kiro/specs/999_全面重构_26.01.27/3.7.6再再进一步bug清扫/` | 季节渐变存档 |
