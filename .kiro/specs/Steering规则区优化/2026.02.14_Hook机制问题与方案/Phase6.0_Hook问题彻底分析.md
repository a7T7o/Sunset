# Phase 6.0 — Hook 机制问题分析与改进建议

> 日期：2026-02-14（修订：2026-02-15）
> 触发：memory-update-check Hook 在一次继承后出现多余输出
> 修订原因：原版分析过于激进，基于单次失控推导出"机制根本不可用"的结论，与实际表现不符

---

## 一、问题现象

一次继承后观察到的事件链：
1. 上下文到达 ~80% → Conversation Summary 触发
2. 继承完成后 → Memory更新检查 Hook（agentStop）触发
3. Hook prompt 注入后，AI 回复了"已更新"
4. 但 AI 没有停下来，继续输出了额外的分析内容
5. 用户 restore 重试，结果相同

## 二、实际表现评估

### 关键事实：大部分情况下 Hook 工作正常

经过会话 8-12、19-20、25-27 的多次迭代优化后，两个 Hook 在日常使用中基本可控：
- memory-update-check 在大多数 agentStop 场景下能正确判断并简短回复
- smart-assistant 的规则路由功能持续发挥作用，按需加载节省了大量 Token

### 失控场景的特征

那次失控发生在继承后，可能的触发条件：
- 继承后上下文中残留了大量未完成工作的信息
- AI 在处理 Hook prompt 时被残留上下文"拉回"继续工作
- 这是特定条件下的偶发问题，不是每次都会发生

## 三、迭代历史与成效

从会话 5 创建 Hook 到现在，经历了多轮优化：

| 阶段 | 会话 | 做了什么 | 效果 |
|------|------|---------|------|
| 创建 | 5 | 创建两个 Hook | 初始版本 |
| 优化 | 10-12 | 继承场景判断、职责修正、格式增强 | 逐步改善 |
| 诊断 | 19 | Hook 问题全面诊断 | 识别关键场景 |
| 精简 | 20 | 精简 prompt、固定回复格式 | 明显改善 |
| 精简 | 25 | 锐评规则全面精简 | 规则本身改善 |
| 观察 | 27 | 一次失控复现 | 确认偶发性 |

总体趋势：每次优化都有改善，Hook 从"经常出问题"变成了"偶尔出问题"。这说明 prompt 优化是有效的，只是在极端场景下仍有边界。

## 四、askAgent 机制的客观认识

### 机制特点（非缺陷）
- Hook prompt 注入到 AI 的上下文中，与主任务共享同一个执行流
- prompt 的约束力会受上下文长度和复杂度影响
- 在上下文较短、任务较简单时，约束力足够
- 在继承后上下文复杂时，约束力可能不足

### 规则持久性层级（参考）

| 层级 | 机制 | 说明 |
|------|------|------|
| 1（最强） | steering `inclusion: always` | 每轮系统注入（rules.md、000-context-recovery.md） |
| 2 | steering `inclusion: manual` | 用户 # 引用时注入 |
| 3 | readFile 加载 | 对话期间留在上下文 |
| 4（较弱） | Hook askAgent prompt | 注入一次，受上下文影响 |

这不意味着第 4 层"不可用"，只是在极端场景下约束力较弱。日常使用中第 4 层完全够用。

## 五、改进建议（温和版）

### 当前状态：保持现有 Hook 不变

两个 Hook 目前基本可控，不需要禁用或大幅改造。

### 可选的小幅优化（非紧急，观察后再决定）

1. **memory-update-check Hook**：如果未来再次出现失控，可以考虑在 prompt 中增加一句"如果上下文中有 Conversation Summary，直接回复'等待用户指令'，不做 memory 判断"——但目前不急
2. **smart-assistant Hook**：当前版本已经包含了继承场景的前置判断，继续观察效果
3. **锐评检测**：如果觉得每次 promptSubmit 都检测锐评太重，可以考虑把锐评检测移到 rules.md 的一句话规则中——但这是优化，不是修复

### 不建议做的事

- ❌ 禁用 memory-update-check Hook——它大部分时候工作正常，提供了有价值的 memory 更新提醒
- ❌ 大幅重写 smart-assistant Hook——规则路由功能运转良好，不需要动
- ❌ 把 Hook 职责全部回归 steering 规则——这会增加 always 加载的 Token 消耗，违背 Phase 4.0 的精简方向

## 六、结论

这次分析的核心修正：从"机制根本不行，必须大改"调整为"偶发问题，继续观察，按需微调"。

Hook 机制在咱们的使用场景中整体是有效的。偶尔的失控不值得用激进的方案去"根治"——那样反而可能引入新问题或开倒车。保持现状，遇到具体问题再针对性处理，是更稳妥的策略。

## 七、执行清单

1. [x] 重写本文档（从激进方案调整为温和评估）——2026-02-15
2. [ ] 继续观察 Hook 在日常使用中的表现
3. [ ] 如果再次出现失控，记录具体场景条件，针对性优化
