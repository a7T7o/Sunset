# v5.1 锐评分析：Hook prompt 平衡点设计

## 一、问题定位

### 1.1 两个极端

| 版本 | prompt 字符数 | 问题 |
|------|-------------|------|
| v5.0Hook.md（完整版） | ~1800 | 太长太复杂，Token 消耗高，但约束力强 |
| 当前 v5.2（精简版） | ~500 | 太短太激进，约束力不足，AI 脱离控制 |

### 1.2 "脱离控制"的具体表现

当前 v5.2 的 prompt 只有核心逻辑骨架，缺少以下关键约束：

1. **没有明确的"真实用户消息"识别规则**：只说了"排除 ADDITIONAL_INSTRUCTIONS / steering-reminder / 工具返回 / Hook prompt"，但没说什么算"真实用户消息"。AI 可能把 CONTEXT TRANSFER 摘要、系统注入消息等误判为用户消息。

2. **没有明确的输出格式约束**：只说了"多余输出"禁止，但没规定 AI 应该输出什么。结果 AI 可能输出大段分析、恢复报告、甚至开始执行任务。

3. **没有"完成后立即停止"的强制指令**：v5.0Hook.md 有明确的"完成判断或更新后，立即停止。只输出指定的回复格式，不多说一个字"，当前版本没有。

4. **没有区分"继承恢复场景"**：继承后 agentStop 触发时，AI 可能把继承恢复的 CONTEXT TRANSFER 当作"有实质工作"去更新 memory，甚至输出恢复报告。

5. **白名单/黑名单太笼统**：只有一行"禁止读代码、运行命令、执行任务、分析规划、修改其他文件、多余输出"，没有足够的威慑力。v5.0Hook.md 的逐条列举虽然长，但每一条都是一个明确的"不许做"。

### 1.3 核心矛盾

精简 prompt 的目的是省 Token，但 Hook prompt 的 Token 消耗其实不大（每次 agentStop 触发一次，~500 vs ~1000 字符差距约 200 tokens）。相比之下，AI 脱离控制后产生的额外输出和错误操作消耗的 Token 远超这 200 tokens 的节省。

**结论：在 Hook prompt 上省 Token 是错误的优化方向。约束力 > 简洁性。**

## 二、v5.0Hook.md 完整版的优缺点分析

### 2.1 优点（应该保留的部分）

1. **"真实用户消息"的明确定义**：
   > 「真实用户消息」= 用户在聊天框输入的内容（包括 CONTEXT TRANSFER 开头的继承消息）
   > 排除：ADDITIONAL_INSTRUCTIONS 注入、steering-reminder 注入、工具返回结果、Hook 注入的 prompt

   这个定义很关键。没有它，AI 会把各种系统注入消息误判为用户消息。

2. **逐条列举的黑名单**：
   每一条 ❌ 都是一个明确的边界。AI 在执行时会逐条检查自己是否越界。笼统的"禁止多余操作"没有这个效果。

3. **"完成后立即停止"的强制指令**：
   > 完成判断或更新后，立即停止。只输出指定的回复格式，不多说一个字。

4. **快照内容的明确模板**：
   规定了快照必须包含的 5 项内容（时间特征、用户 prompt 完整摘抄、AI 进度、修改文件、智能补充），防止 AI 自由发挥写出不符合要求的快照。

### 2.2 缺点（应该去掉或精简的部分）

1. **"原理"说明**：
   > 原理：rules.md 要求 AI 每次输出末尾都打【输出完毕】标记。如果最后一轮 AI 输出的末尾没有标记，说明该输出已被系统压缩。

   AI 不需要知道"为什么"，只需要知道"怎么做"。删除。

2. **标记格式描述过于详细**：
   > 标记格式：【输出完毕 YYYY-MM-DDTHH:mm:ss】

   已改为 `【输出完毕】`，不需要时间戳格式说明。

3. **分支一的子检查逻辑过于冗长**：
   "主 memory 同步子检查"写了 6 行条件判断，核心逻辑其实就是"没压缩时检查主 memory 是否同步"。可以压缩。

4. **分支二的步骤编号过于详细**：
   5 个步骤可以合并为 2-3 个。

5. **白名单不需要逐条列举**：
   白名单是"允许做的事"，AI 天然会做这些。重点应该放在黑名单（"不许做的事"）上。

## 三、v5.1 平衡方案设计

### 3.1 设计原则

- **约束力优先**：宁可多花 200 tokens，也不能让 AI 脱离控制
- **去掉解释，保留指令**：删除所有"原理""为什么"，只保留"做什么""不做什么"
- **黑名单逐条列举**：每条禁令独占一行，威慑力最大化
- **输出格式强制规定**：AI 只能输出指定格式的回复，不能自由发挥
- **目标字符数**：~800-1000 字符（在 500 和 1800 之间取平衡）

### 3.2 v5.1 Hook prompt 草案

```
你是记录员。判断是否需要更新 memory 和/或创建继承快照，执行后立即停止。

===== 压缩检测 =====
找最后一条真实用户消息（= 用户在聊天框输入的内容，包括 CONTEXT TRANSFER 继承消息）。
排除：ADDITIONAL_INSTRUCTIONS / steering-reminder / 工具返回 / Hook prompt。
检查该消息之后 AI 回复末尾是否有【输出完毕】。
- 有 → 没压缩
- 没有 → 被压缩

===== 没压缩 =====
- 无实质工作 → 不更新，停止
- memory 已更新过 → 检查主 memory 是否同步，未同步则补充，停止
- 有工作且未更新 → 追加子 memory → 追加主 memory

===== 被压缩 =====
- 追加子 memory（不更新主 memory）
- 在子工作区创建 继承会话memory/ 快照文件：
  · 用户 prompt 完整摘抄（不删减）
  · AI 进度摘要（已完成/未完成）
  · 修改文件列表
  · 智能补充（可能丢失的上下文）

===== 输出格式 =====
只允许输出以下格式之一：
- 「不需要更新」
- 「已更新子 memory」
- 「已更新子 memory + 主 memory」
- 「已更新子 memory + 创建继承快照」
不多说一个字。

===== 禁止事项 =====
❌ 禁止读取任何代码文件
❌ 禁止运行任何命令
❌ 禁止执行任何未完成的任务
❌ 禁止输出恢复报告或分析
❌ 禁止修改 memory/快照以外的文件
❌ 禁止规划、建议、讨论后续工作
完成后立即停止。
```

### 3.3 字符数估算

- 压缩检测：~250 字符
- 没压缩分支：~120 字符
- 被压缩分支：~200 字符
- 输出格式：~150 字符
- 禁止事项：~200 字符
- **总计：~920 字符**（约 300 tokens）

### 3.4 与两个极端的对比

| 维度 | v5.0Hook.md（完整版） | 当前 v5.2（精简版） | v5.1（平衡版） |
|------|---------------------|-------------------|---------------|
| 字符数 | ~1800 | ~500 | ~920 |
| Token 消耗 | ~600 | ~170 | ~300 |
| 真实用户消息定义 | ✅ 明确 | ❌ 缺失 | ✅ 明确 |
| 输出格式约束 | ✅ 有 | ❌ 缺失 | ✅ 有（更严格） |
| 黑名单 | ✅ 逐条列举 | ⚠️ 一行笼统 | ✅ 逐条列举 |
| 快照内容模板 | ✅ 5项 | ⚠️ 一行描述 | ✅ 4项（去掉时间特征） |
| "立即停止"指令 | ✅ 有 | ❌ 缺失 | ✅ 有 |
| 原理说明 | ❌ 有（多余） | ✅ 无 | ✅ 无 |
| 分支逻辑冗长度 | ❌ 过于详细 | ✅ 精简 | ✅ 精简 |

## 四、关键补充分析

### 4.1 当前 Hook 实际行为复盘

从截图和 memory 记录来看，当前 v5.2 Hook 在 agentStop 触发后的实际行为：

1. **压缩检测正确**：标记方案本身是有效的，v5.1 的"最后一轮 AI 回复末尾有标记"逻辑修正了 v5.0 的漏洞
2. **但执行过程脱离控制**：Hook 触发后，AI 不仅更新了 memory，还输出了恢复报告、读取了大量文件、甚至开始分析和规划
3. **根因**：prompt 缺少足够的约束力，AI 把 Hook 触发当成了一次"正常对话"来处理

### 4.2 "约束力"的本质是什么

从 v4.0 到 v5.2 的 15+ 轮迭代中，反复出现的问题都是同一个：**AI 在 Hook 触发后做了超出职责范围的事情**。

约束力不是靠 prompt 长度实现的，而是靠以下三个要素：

1. **角色锁定**："你是记录员"——这句话定义了 AI 的身份边界。但光说"你是记录员"不够，还需要明确"记录员只做记录，不做其他任何事"。

2. **输出格式锁定**：规定 AI 只能输出 4 种固定格式之一。这是最强的约束——AI 没有自由发挥的空间。当前 v5.2 缺少这个约束，所以 AI 可以输出任意内容。

3. **黑名单逐条列举**：每一条 ❌ 都是一个明确的"不许做"。AI 在生成每一步输出时都会检查是否违反了某条禁令。一行笼统的"禁止多余操作"不如 6 条具体禁令有效。

### 4.3 v5.0Hook.md 中被错误删除的关键约束

对比 v5.0Hook.md 和当前 v5.2，以下约束在精简过程中被错误删除了：

| 被删除的约束 | 重要性 | 后果 |
|------------|--------|------|
| 真实用户消息的明确定义 | 🔴 关键 | AI 可能误判消息来源，导致压缩检测错误 |
| 输出格式的 4 种固定回复 | 🔴 关键 | AI 自由发挥，输出恢复报告、分析等 |
| "完成后立即停止，不多说一个字" | 🔴 关键 | AI 继续输出，脱离控制 |
| 快照内容的 4 项模板 | 🟡 重要 | 快照质量不可控 |
| 逐条列举的 6 条黑名单 | 🟡 重要 | 约束力下降 |

### 4.4 000-context-recovery.md 当前状态评估

当前恢复规则已经在续14中修正为"快照优先（第一步）"，这个是正确的。但需要注意一个衔接问题：

- Hook 创建的快照质量直接决定恢复流程的效果
- 如果 Hook prompt 对快照内容没有明确模板，快照可能缺少关键信息
- v5.1 草案中保留了 4 项快照模板（用户 prompt 完整摘抄、AI 进度、修改文件、智能补充），这是必要的

### 4.5 smart-assistant Hook 的影响

当前还有一个 promptSubmit 触发的 smart-assistant Hook。从 memory 记录来看，这个 Hook 在继承场景下会抢占恢复流程。但这不是本次分析的重点——本次聚焦 memory-update-check Hook 的平衡点设计。

不过需要注意：两个 Hook 的交互可能产生叠加效应。agentStop Hook 脱离控制 + promptSubmit Hook 抢占注意力 = 双重失控。解决 agentStop Hook 的约束力问题是第一优先级。

## 五、总结与建议

### 5.1 核心结论

1. 当前 v5.2 的精简方向是对的（去掉原理说明、压缩分支逻辑），但精简得太激进，删掉了关键约束
2. v5.0Hook.md 的约束力是够的，但包含了太多解释性文字
3. 平衡点在 ~920 字符（~300 tokens），保留所有关键约束，去掉所有解释

### 5.2 建议的修改

1. **Hook prompt**：采用 3.2 节的 v5.1 草案，恢复"真实用户消息定义""输出格式锁定""逐条黑名单""立即停止指令"四个关键约束
2. **Hook description**：更新版本号为 v5.3（v5.1 已用于之前的版本，v5.2 是当前精简版）
3. **rules.md**：无需修改（第7条已经是 `【输出完毕】` 无时间戳）
4. **000-context-recovery.md**：无需修改（快照已在第一步）

### 5.3 风险评估

| 风险 | 概率 | 应对 |
|------|------|------|
| ~920 字符仍然约束力不足 | 低 | 输出格式锁定是最强约束，4 种固定回复几乎不可能被绕过 |
| Token 消耗增加 ~130 | 可忽略 | 每次 agentStop 多消耗 ~130 tokens，远小于脱离控制的代价 |
| 快照内容模板限制了灵活性 | 低 | "智能补充"项保留了灵活空间 |

### 5.4 待用户确认

- [ ] 是否同意采用 3.2 节的 v5.1 Hook prompt 草案？
- [ ] 版本号命名：v5.3（避免与历史版本混淆）还是其他？
- [ ] 是否需要对 smart-assistant Hook 也做类似的约束力分析？
