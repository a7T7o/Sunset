# 锐评回应：5.0锐评001

**回应日期**: 2026-02-12
**锐评来源**: `.kiro/specs/Steering规则区优化/2026.02.11智能加载/5.0锐评001.md`
**核查结论**: 🔴 路径 C（重大异议）— 核心声明与代码事实严重不符

---

## 一、锐评核心观点摘要

锐评声称：
1. CropController 的 `RestoreState(object state)` 中 `state as CropSaveData` 会返回 null，读档 100% 失败
2. `CropSaveData` 可能没定义在 DTO 里
3. 数据主权分裂（CropController 反向更新 FarmTileManager）是架构异味
4. Phase 5.0 原方案评级 C（不及格），必须废弃，改为"外科手术级"代码修复方案

---

## 二、事实核查结果

| # | 锐评声明 | 代码事实 | 核查结论 |
|---|---------|---------|---------|
| 1 | `RestoreState(object state)` 中 `state as CropSaveData` 必定返回 null | CropController **没有** `RestoreState` 方法。实际接口方法是 `Load(WorldObjectSaveData data)`，内部通过 `JsonUtility.FromJson<CropSaveData>(data.genericData)` 正确反序列化 | ❌ 事实错误 |
| 2 | `CropSaveData` 可能没定义在 DTO 里 | `SaveDataDTOs.cs` 第 475 行明确定义了 `[Serializable] public class CropSaveData`，注释写明"存储在 WorldObjectSaveData.genericData 中" | ❌ 事实错误 |
| 3 | CropController 反向更新 FarmTileManager 是"双重真理" | `Load()` 中 `tileData.SetCropData(instanceData)` 是读档恢复后的数据同步，不是双重真理。存档只存在 CropController 侧，恢复后同步给 Tile 是正常流程 | ⚠️ 现象对，结论错 |
| 4 | Phase 5.0 评级 C，必须废弃 | Phase 5.0 的"标注待验证"策略是合理的保守做法。代码实现正确，不需要"外科手术" | ❌ 结论错误 |

---

## 三、认同的部分

### 方向性判断（高度认可）

1. **关注农作物存档集成是对的** — 锐评敏锐地识别出农作物存档是整个存档系统中最复杂的环节之一，涉及 CropController、FarmTileManager、CropSaveData 三方协作。这个判断完全正确，也正是 Phase 5.0 的核心关注领域。锐评在众多可能的切入点中选择了最有价值的方向，这种嗅觉值得肯定。

2. **"先看代码再写规则"的方法论值得采纳** — 锐评反复强调"不看代码直接写文档是危险的"，这个原则完全正确。Phase 5.0 在创建 save-system.md 时，确实应该基于已验证的代码事实来编写。本次核查本身就是这个方法论的实践——正因为我们去看了代码，才发现锐评的事实论据有误。这恰恰证明了"先验证再下结论"的重要性。

3. **"通用存档数据 vs 特殊对象数据"的区分框架有价值** — 锐评提出的这个概念框架是好的。CropController 使用 `genericData` + JSON 序列化的模式，正是"特殊对象数据封装"的正面示例。save-system.md 应该将此作为标准模式记录，这个建议我们完全采纳。

### 具体建议（已采纳或计划采纳）

4. **`tileData.SetCropData` 同步逻辑值得在规则中记录** — 虽然这不是 bug（锐评误判为"双重真理"），但锐评注意到了这个模式的存在本身是有价值的。CropController.Load() 中恢复数据后同步给 FarmTileManager 的"恢复后同步"模式，确实是一个重要的架构决策，容易被误解。save-system.md 应该明确记录此模式及其设计意图。

5. **Hook 路由扩展建议** — 锐评建议为存档/农田相关关键词添加 Hook 路由，这已在会话 17 中实施（添加了 save-system.md 和 chest-interaction.md 的映射）。

6. **对存档系统规范化的整体推动** — 抛开事实错误不谈，锐评的核心诉求——"存档系统需要一套统一的、经过代码验证的规则文件"——与 Phase 5.0 的目标完全一致。锐评以一种激进的方式表达了这个诉求，虽然论据站不住脚，但方向是对的。这种"宁可误报也不漏报"的审查态度，在锐评专家的角色定位下是合理的。

---

## 四、核心异议

### 异议 1：锐评审查的不是真实代码

锐评声称看到了 `RestoreState(object state)` 方法，但 CropController 的 IPersistentObject 接口实现是：
- `Save()` → 返回 `WorldObjectSaveData`
- `Load(WorldObjectSaveData data)` → 接收 `WorldObjectSaveData`

没有 `RestoreState` 方法。锐评可能审查的是旧版代码、其他文件、或者基于推测。

### 异议 2：代码已经实现了锐评推荐的方案

锐评推荐的"方案一（降维打击）"：
> 修改 Save()：将作物特有数据序列化为 JSON 字符串，存入 WorldObjectSaveData.customData

代码实际实现（第 761 行）：
```csharp
saveData.genericData = JsonUtility.ToJson(cropSaveData);
```

这就是锐评推荐的方案，只是用的是 `genericData` 而非 `customData`。代码已经正确实现了。

### 异议 3：Phase 5.0 不需要废弃

Phase 5.0 的定位是"规则文件创建 + 索引修复"，不是代码修复。原方案中"标注农作物存档待验证"是合理的，因为：
- 代码实现正确（本次核查确认）
- 但端到端测试尚未完成（实际运行中是否有其他问题未知）
- 规则文件应该基于已验证的正确代码来编写

---

## 五、独立分析

经过代码核查，CropController 的存档实现是**正确且规范的**：

1. `Save()` 正确创建 `CropSaveData` 并 JSON 序列化到 `genericData`
2. `Load()` 正确从 `genericData` 反序列化并恢复所有字段
3. `CropSaveData` 在 `SaveDataDTOs.cs` 中有完整定义（含 13 个字段）
4. 恢复后同步 FarmTileManager 是合理的数据一致性保证

唯一需要关注的是：
- DynamicObjectFactory 中是否有 Crop 分支（这决定了动态重建是否完整）
- 端到端测试是否覆盖了完整的存档→读档→恢复流程

---

## 六、建议的执行方向

**不采纳锐评的"废弃 Phase 5.0"建议。** 继续按原 Phase 5.0 执行计划推进：

1. 创建 save-system.md 时，可以将 CropController 的 genericData 模式作为"特殊对象数据封装"的正面示例
2. 在 save-system.md 中补充 `genericData` 的使用规范（JSON 序列化特殊对象数据）
3. DynamicObjectFactory 的 Crop 分支仍需验证（这是 Phase 5.0 原方案已标注的待验证项）

---

## 七、给锐评专家的信息补充

1. 项目的 `IPersistentObject` 接口使用 `Save()/Load()` 模式，不是 `SaveState()/RestoreState()` 模式
2. `WorldObjectSaveData.genericData` 字段专门用于存储特殊对象的 JSON 序列化数据
3. CropController 的存档实现已经遵循了项目的标准存档模式（与 TreeController、StoneController、ChestController 一致）


---

## 八、基于锐评认可部分的采纳行动项

虽然锐评的事实核查结论有误，但以下有价值的建议已采纳或计划采纳：

| # | 锐评建议 | 采纳状态 | 具体行动 |
|---|---------|---------|---------|
| 1 | 存档/农田关键词添加 Hook 路由 | ✅ 已采纳 | 会话 17 已添加 save-system.md + chest-interaction.md 映射 |
| 2 | save-system.md 记录 genericData + JSON 封装模式 | 📋 计划采纳 | Phase 5.0 执行时将 CropController 作为正面示例 |
| 3 | 记录"恢复后同步"模式（Load → SetCropData） | 📋 计划采纳 | save-system.md 中明确记录此架构模式 |
| 4 | 先验证代码再写规则的方法论 | ✅ 已采纳 | 本次核查已实践，未来创建规则文件时继续遵循 |
| 5 | 区分"通用存档数据"与"特殊对象数据" | 📋 计划采纳 | save-system.md 的核心章节之一 |

**总结**：锐评的方向感和方法论有价值，事实层面的错误不影响这些建议的可采纳性。Phase 5.0 继续按原计划推进，同时吸收上述有价值的建议。
