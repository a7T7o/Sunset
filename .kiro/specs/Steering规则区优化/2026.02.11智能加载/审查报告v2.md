# Steering 规则全面审查报告 v2

**审查日期**: 2026-02-12
**审查范围**: `.kiro/steering/` 全部规则文件 + `.kiro/hooks/` 全部 Hook
**审查目的**: 评估 Phase 4.0+4.1 实施后的规则体系状态，对比 v1 审查时的改善情况
**对比基线**: v1 审查报告（2026-02-11）

---

## 一、总体概况

### 当前状态

| 指标 | v1 审查时 | 当前（Phase 4.0+4.1 后） | 变化 |
|------|----------|------------------------|------|
| 规则文件总数 | 19（14主+5归档） | 20（15主+5归档） | +1（placeable-items 新增章节） |
| 默认加载（always） | 8 个 | 2 个 | -75% ✅ |
| 手动加载（manual） | 11 个 | 18 个 | +7（从 always 降级） |
| 归档（archive） | 5 个 | 5 个 | 不变 |
| Hook 数量 | 0 | 2 个 | 新增 ✅ |
| 默认 Token 消耗 | ~8,000-10,000 | ~2,000 | -78% ✅ |

### 默认加载文件清单（仅 2 个）

| 文件 | 估算 Tokens | 职责 |
|------|------------|------|
| `rules.md` | ~1,500 | 核心禁令 + Unity API + 文档写入 + 语言沟通 + 工作区记忆摘要 |
| `000-context-recovery.md` | ~500 | 继承恢复智能判断（三种情况） |
| **合计** | **~2,000** | |

### Hook 驱动按需加载（2 个）

| Hook | 触发时机 | 职责 | 估算额外 Token |
|------|---------|------|---------------|
| `smart-assistant.kiro.hook` | promptSubmit | 规则路由（14 个领域映射）+ 锐评流程守卫 | ~200（Hook 本身）+ 按需加载的规则文件 |
| `memory-update-check.kiro.hook` | agentStop | 纯记录员：只更新 memory.md | ~150（Hook 本身） |

---

## 二、v1 审查问题解决状态

### v1 发现的 5 个关键缺陷

| # | 缺陷 | v1 严重度 | 当前状态 | 说明 |
|---|------|----------|---------|------|
| 1 | 默认加载膨胀（8个→预期4个） | 🔴 严重 | ✅ 已解决 | 降至 2 个，超额完成 |
| 2 | items.md vs so-design.md 品质矛盾 | 🔴 中等 | ✅ 已解决 | items.md 统一为 4 级（与代码一致） |
| 3 | structure.md 目录结构过时 | 🟡 中等 | ✅ 已解决 | 更新为实际 YYY_Scripts 结构 |
| 4 | scene-hierarchy-sync.md 无效引用 | 🟢 轻微 | ✅ 已解决 | 移除"待创建"文档引用 |
| 5 | coding-standards.md 架构模式未标注 | 🟢 轻微 | ✅ 已解决 | 标注实施状态 |

### v1 发现的 4 个完整性缺口

| # | 缺口 | 当前状态 | 说明 |
|---|------|---------|------|
| 1 | 缺少存档系统规则 | ⏳ 记录为未来待办 | 非紧急，暂不创建 |
| 2 | 缺少箱子/交互系统规则 | ⏳ 未处理 | 箱子系统稳定，暂无需求 |
| 3 | placeable-items.md 缺农田放置 | ✅ 已解决 | 新增"农田放置规范"章节 |
| 4 | 智能加载映射表不完整 | ✅ 已解决 | Hook 替代映射表，覆盖 14 个领域 |

### v1 的 12 条优化建议执行情况

| 优先级 | 建议数 | 已执行 | 执行率 |
|--------|--------|--------|--------|
| P0 | 5 | 5 | 100% |
| P1 | 4 | 4 | 100% |
| P2 | 3 | 2.5（#11 记录待办） | 83% |
| **合计** | **12** | **11.5** | **96%** |

---

## 三、逐文件效率评估（当前状态）

### 默认加载文件（always）- 2 个

| 文件 | 估算 Tokens | 效率评分 | 评价 |
|------|------------|---------|------|
| `rules.md` | ~1,500 | ⭐⭐⭐⭐⭐ | Phase 4.0 精简后信息密度极高：核心禁令+API+沟通规范+工作区摘要，无冗余 |
| `000-context-recovery.md` | ~500 | ⭐⭐⭐⭐⭐ | 智能恢复三种情况判断 + Memory 交叉验证 + 文件修改清单提醒 |


### 手动加载文件（manual）- P0 级 3 个

| 文件 | 估算 Tokens | 效率评分 | 评价 |
|------|------------|---------|------|
| `communication.md` | ~800 | ⭐⭐⭐⭐ | 核心规范已整合到 rules.md，剩余价值：一条龙完整流程、锐评详细规范 |
| `workspace-memory.md` | ~1,500 | ⭐⭐⭐⭐ | 完整的工作区记忆规范，核心禁令已摘要到 rules.md |
| `layers.md` | ~1,200 | ⭐⭐⭐⭐⭐ | 精炼，层级设计核心参考，降级后按需加载合理 |

### 手动加载文件（manual）- P1 级 8 个

| 文件 | 估算 Tokens | 效率评分 | 评价 |
|------|------------|---------|------|
| `animation.md` | ~2,000 | ⭐⭐⭐⭐ | Direction 映射是关键易错点，内容密度高 |
| `ui.md` | ~1,500 | ⭐⭐⭐⭐ | 快捷键表格实用，结构清晰 |
| `so-design.md` | ~1,800 | ⭐⭐⭐⭐⭐ | ID 分配表是权威来源，新增 ItemDatabase 访问规范 |
| `items.md` | ~1,500 | ⭐⭐⭐⭐ | 品质统一后与 so-design.md 重叠减少，ID 表改为引用 |
| `systems.md` | ~1,500 | ⭐⭐⭐⭐ | 多系统合一，信息密度高 |
| `trees.md` | ~1,800 | ⭐⭐⭐⭐ | 游戏数值表核心参考 |
| `placeable-items.md` | ~1,000 | ⭐⭐⭐⭐ | 新增农田放置规范后更完整 |
| `code-reaper-review.md` | ~2,000 | ⭐⭐⭐⭐ | 从 always 降级为 manual，由 Hook 按需触发，效率大幅提升 |

### 手动加载文件（manual）- P2 级 7 个

| 文件 | 估算 Tokens | 效率评分 | 评价 |
|------|------------|---------|------|
| `coding-standards.md` | ~2,000 | ⭐⭐⭐⭐ | 新增 Tag/Layer 编辑器规范 + 架构模式实施状态标注 |
| `documentation.md` | ~1,500 | ⭐⭐⭐⭐ | 日志式记录规范实用 |
| `scene-modification-rule.md` | ~500 | ⭐⭐⭐⭐⭐ | 精炼，核心原则清晰 |
| `scene-hierarchy-sync.md` | ~400 | ⭐⭐⭐⭐ | 无效引用已移除 |
| `debug-logging-standards.md` | ~1,200 | ⭐⭐⭐⭐ | 从 always 降级为 manual，由 Hook 按需触发 |
| `maintenance-guidelines.md` | ~3,000 | ⭐⭐⭐ | 🟡 体积最大的单文件，13 个章节，见下方分析 |
| `README.md` | ~800 | ⭐⭐⭐ | 🟡 索引信息部分过时，见下方分析 |

### 归档文件（archive）- 5 个

| 文件 | 估算 Tokens | 效率评分 | 评价 |
|------|------------|---------|------|
| `archive/product.md` | ~800 | ⭐⭐⭐⭐ | 中文概述完善，时效性提醒到位 |
| `archive/tech.md` | ~800 | ⭐⭐⭐⭐ | 中文概述完善，包版本可能需更新 |
| `archive/structure.md` | ~1,200 | ⭐⭐⭐⭐ | 已更新为实际 YYY_Scripts 结构 |
| `archive/progress.md` | ~800 | ⭐⭐⭐⭐ | 最后更新 2026-02-06，较新 |
| `archive/farming.md` | ~600 | ⭐⭐⭐ | 基础规范，农田系统持续开发中可能需更新 |

---

## 四、Hook 机制评估

### smart-assistant.kiro.hook（promptSubmit）

**优点**：
- 覆盖 14 个领域的关键词映射，替代了 rules.md 中的静态映射表
- 锐评流程守卫集成，避免单独加载 code-reaper-review.md 的判断开销
- 静默加载（不告诉用户），用户体验流畅

**潜在问题**：
- 🟡 每次用户发消息都触发，即使是简单问答也会执行关键词分析
- 🟡 Hook prompt 较长（~200 tokens），每轮对话固定消耗
- 🟡 领域映射硬编码在 Hook 中，新增规则文件需要同步更新 Hook

**Token 消耗分析**：
- Hook 本身：~200 tokens/轮
- 按需加载的规则：0-3,000 tokens（取决于匹配到的领域数）
- 对比 v1 的 always 加载 8 个文件（~10,000 tokens）：即使每轮都触发，也远优于 v1

### memory-update-check.kiro.hook（agentStop）

**优点**：
- 明确的"记录员不是执行者"定位，5 条严格禁止
- 解决了之前 memory 更新遗漏的问题

**潜在问题**：
- 🟡 继承后触发时可能误判（会话 8 已发现此问题）
- 🟡 "只追加不修改"的约束在 Hook prompt 中重复了 rules.md 的内容

**实际效果评估**：
- ✅ 正常对话场景：有效提醒 memory 更新
- ⚠️ 继承场景：可能误判，但已通过 prompt 优化缓解
- ✅ 简单问答场景：正确判断"不需要更新"


---

## 五、当前缺陷与问题

### 缺陷 1：README.md 索引信息过时（中等）

**问题**：README.md 的优先级表格仍然列出 `layers.md`、`workspace-memory.md`、`communication.md` 为"默认加载（always）"，但实际上这三个已在 Phase 4.0 中降级为 manual。

**影响**：如果 AI 或用户参考 README.md 了解加载机制，会得到错误信息。

**建议**：更新 README.md 的优先级表格，反映当前实际状态。

### 缺陷 2：maintenance-guidelines.md 体积膨胀（轻微）

**问题**：经过多轮迭代，maintenance-guidelines.md 已膨胀到 13 个章节（~3,000 tokens），是单文件中体积最大的。包含：
1. 删除/合并前检查清单
2. Single Source of Truth 标记
3. 全局 vs 模块规则归类
4. 冗余性审查流程
5. 新增规则文件规范
6. 中文概述规范
7. 定期维护检查
8. 规则更新触发机制
9. keywords 智能加载说明
10. 对话结束前检查清单
11. 工作区分层与跨域协作规范
12. 日期字段更新规范
13. 时效性提醒规范

**影响**：作为 manual 文件，只在修改 steering 时加载，影响有限。但如果需要加载，一次性消耗 ~3,000 tokens。

**建议**：暂不处理。作为维护规范，完整性比精简更重要。如果未来继续膨胀超过 4,000 tokens，考虑拆分。

### 缺陷 3：communication.md 与 rules.md 的冗余（轻微）

**问题**：Phase 4.0 将 communication.md 的核心规范整合到了 rules.md 的"语言与沟通"章节。但 communication.md 本身仍保留完整内容，存在部分冗余：
- 核心原则（中文对话、简洁明了）→ 两处都有
- 方案讨论流程 → 两处都有
- 何时展示代码 → 两处都有

**影响**：communication.md 是 manual 加载，只在"一条龙模式"时触发。冗余不会造成 Token 浪费（不会同时加载两份），但维护时需要同步更新两处。

**建议**：在 communication.md 开头标注"核心规范已整合到 rules.md，本文件仅保留一条龙完整流程和锐评详细规范"，避免未来维护时遗忘同步。

### 缺陷 4：Hook 领域映射与规则文件的同步风险（轻微）

**问题**：smart-assistant Hook 中硬编码了 14 个领域→文件的映射关系。如果未来新增或重命名规则文件，需要同步更新 Hook。但 Hook 文件不在 maintenance-guidelines.md 的维护检查范围内。

**建议**：在 maintenance-guidelines.md 的"定期维护检查"中增加一条：检查 Hook 中的规则文件映射是否与实际文件一致。

### 缺陷 5：archive/farming.md 可能需要更新（轻微）

**问题**：farming.md 最后更新于 2026-01-09，但农田系统在此后经历了大量开发（9.0.2-9.0.5、10.0.1-10.0.2），包括：
- 放置农田系统
- 预览农田
- 智能交互升级
- 农作物设计与完善

farming.md 中的 FarmTileData 字段、CropInstance 方法等可能已与实际代码不一致。

**建议**：下次涉及农田系统开发时，顺便更新 farming.md。非紧急。

---

## 六、完整性评估

### 已覆盖的领域

| 领域 | 规则文件 | 覆盖度 |
|------|---------|--------|
| 核心禁令与 API | rules.md | ✅ 完整 |
| 上下文恢复 | 000-context-recovery.md | ✅ 完整 |
| 层级设计 | layers.md | ✅ 完整 |
| 动画系统 | animation.md | ✅ 完整 |
| UI 系统 | ui.md | ✅ 完整 |
| SO 设计 | so-design.md | ✅ 完整 |
| 物品系统 | items.md | ✅ 完整 |
| 核心系统 | systems.md | ✅ 完整 |
| 树木系统 | trees.md | ✅ 完整 |
| 放置系统 | placeable-items.md | ✅ 完整（含农田） |
| 编码规范 | coding-standards.md | ✅ 完整 |
| 文档规范 | documentation.md | ✅ 完整 |
| 场景修改 | scene-modification-rule.md | ✅ 完整 |
| 场景同步 | scene-hierarchy-sync.md | ✅ 完整 |
| 调试日志 | debug-logging-standards.md | ✅ 完整 |
| 维护规范 | maintenance-guidelines.md | ✅ 完整 |
| 沟通规范 | communication.md | ✅ 完整 |
| 工作区记忆 | workspace-memory.md | ✅ 完整 |
| 锐评流程 | code-reaper-review.md | ✅ 完整 |
| 农田系统 | archive/farming.md | ⚠️ 可能过时 |
| 存档系统 | 无 | ❌ 缺失（已记录待办） |

### 未覆盖但可能需要的领域

| 领域 | 紧急度 | 说明 |
|------|--------|------|
| 存档系统 | P2 | GUID 管理、动态对象重建有易错点，但系统已稳定 |
| 战斗系统 | P3 | 尚未开发，等开发时再创建 |
| NPC 系统 | P3 | 尚未开发 |

---

## 七、优化建议汇总

### 优先级 P0（建议立即执行）

| # | 建议 | 预期收益 |
|---|------|---------|
| 1 | 更新 README.md 优先级表格（layers/communication/workspace-memory 从 always→manual） | 消除索引信息与实际状态的不一致 |

### 优先级 P1（建议近期执行）

| # | 建议 | 预期收益 |
|---|------|---------|
| 2 | communication.md 开头标注"核心已整合到 rules.md" | 避免维护同步遗忘 |
| 3 | maintenance-guidelines.md 维护检查增加 Hook 映射检查项 | 防止 Hook 与规则文件不同步 |

### 优先级 P2（建议后续执行）

| # | 建议 | 预期收益 |
|---|------|---------|
| 4 | 下次农田开发时更新 archive/farming.md | 保持规则与代码一致 |
| 5 | 未来考虑创建 save-system.md | 减少存档相关错误 |

---

## 八、规则体系健康度评分

| 维度 | v1 评分 | 当前评分 | 变化 | 说明 |
|------|--------|---------|------|------|
| 核心规则完整性 | 9/10 | 9.5/10 | +0.5 | 品质统一、农田放置补充、架构模式标注 |
| 信息一致性 | 6/10 | 8.5/10 | +2.5 | 品质矛盾已解决、ID 重复已消除、结构已更新；README 索引仍有小问题 |
| 加载效率 | 5/10 | 9.5/10 | +4.5 | 从 ~10,000 降到 ~2,000 tokens，Hook 按需加载 |
| 可维护性 | 8/10 | 8.5/10 | +0.5 | Hook 引入新的同步维护需求，但整体规范更完善 |
| 智能加载覆盖率 | 7/10 | 9/10 | +2.0 | Hook 覆盖 14 个领域，远超原映射表 |
| 文档时效性 | 7/10 | 8/10 | +1.0 | structure.md 已更新，farming.md 仍可能过时 |
| Hook 机制有效性 | N/A | 8.5/10 | 新增 | promptSubmit 路由有效，agentStop 记录员定位清晰 |
| **综合** | **7/10** | **8.8/10** | **+1.8** | 显著改善，核心问题全部解决 |

---

## 九、总结

### Phase 4.0+4.1 的核心成就

1. **Token 消耗降低 78%**：默认加载从 ~10,000 降到 ~2,000 tokens
2. **默认文件从 8 个降到 2 个**：只保留绝对必要的 rules.md 和 000-context-recovery.md
3. **Hook 驱动按需加载**：替代静态映射表，覆盖 14 个领域
4. **v1 审查的 12 条建议执行率 96%**：仅存档系统规则记录为未来待办

### 当前体系的优势

- 极低的默认 Token 消耗（~2,000）
- 智能的按需加载机制（Hook 自动路由）
- 完善的维护规范（maintenance-guidelines.md）
- 清晰的文件分层（always → manual → archive）
- 智能的上下文恢复（三种情况判断 + Memory 交叉验证）

### 当前体系的风险点

- README.md 索引过时（P0，易修复）
- communication.md 与 rules.md 部分冗余（P1，需标注）
- Hook 映射与规则文件的同步维护（P1，需加入检查流程）
- farming.md 可能与实际代码不一致（P2，非紧急）

### 与 v1 的对比结论

v1 审查时体系评分 7/10，核心问题是"默认加载膨胀"和"信息不一致"。Phase 4.0+4.1 实施后，这两个问题都得到了根本性解决。当前评分 8.8/10，剩余的 1.2 分主要来自 README 索引过时、farming.md 时效性、以及 Hook 同步维护的新增复杂度。

**审查结论**：规则体系已从"框架优秀但执行偏离"升级为"框架优秀且执行到位"。当前状态健康，无紧急问题需要处理。
