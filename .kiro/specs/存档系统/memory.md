# 存档系统 - 开发记忆

## 模块概述

存档系统是项目中最容易出错的模块之一，核心组件分散在多个工作区中开发和修复。本工作区作为存档系统的统一索引，汇总所有对存档有修改的工作区记录，提供全局视角。

**核心组件**:
- PersistentObjectRegistry：对象注册中心（Dictionary 存储，反向修剪）
- DynamicObjectFactory：动态对象重建（树木/石头/箱子/掉落物）
- PrefabDatabase：预制体自动扫描 + ID 别名映射
- SaveManager：存档管理器，协调全局存档/读档流程
- PersistentManagers：持久化管理器根物体（DontDestroyOnLoad 统一管理）
- SaveDataDTOs：存档数据结构定义

## 当前状态

- **完成度**: 80%（核心功能完成，农作物存档待集成验证）
- **最后更新**: 2026-02-12
- **状态**: 持续维护中

## 关键文件索引

### 核心存档文件
| 文件 | 说明 | 涉及子工作区 |
|------|------|-------------|
| `SaveManager.cs` | 存档管理器 | 3.7.2, 3.7.4, 3.7.5 |
| `SaveDataDTOs.cs` | 数据结构定义 | 3.7.3, 3.7.4, 10.0.1 |
| `PersistentObjectRegistry.cs` | 对象注册中心 | 3.7.2, 3.7.4 |
| `DynamicObjectFactory.cs` | 动态对象重建 | 3.7.2, 3.7.3 |
| `PrefabDatabase.cs` | 预制体数据库 | 3.7.5 |
| `PersistentManagers.cs` | 持久化管理器 | SO设计系统 会话8 |

### 存档相关的控制器
| 文件 | 存档功能 | 涉及子工作区 |
|------|---------|-------------|
| `TreeController.cs` | 树木状态存档/恢复 | 3.7.2, 3.7.3 |
| `StoneController.cs` | 石头假死存档 | 3.7.4 |
| `ChestController.cs` | 箱子存档（Initialize/Load 顺序） | 箱子系统, 3.7.6 |
| `CropController.cs` | 作物存档（CropSaveData） | 10.0.1 |
| `TimeManager.cs` | 时间数据存档（必须先于世界对象恢复） | 3.7.6 |

### 编辑器工具
| 文件 | 说明 | 涉及子工作区 |
|------|------|-------------|
| `PersistentIdAutomator.cs` | 场景保存时自动修复空/重复 GUID | 3.7.3 |
| `PersistentIdValidator.cs` | 手动验证 GUID 完整性 | 3.7.3 |
| `PrefabDatabaseAutoScanner.cs` | 预制体自动扫描 | 3.7.5 |

## 子工作区索引

| 子工作区路径 | 来源 | 存档相关内容 |
|-------------|------|-------------|
| `999_全面重构_26.01.27/3.7.2存档bug大清扫/` | 999_全面重构_26.01.27 | 动态对象重建、PrefabRegistry、DynamicObjectFactory |
| `999_全面重构_26.01.27/3.7.3消失bug/` | 999_全面重构_26.01.27 | GUID 漂移修复、PersistentIdAutomator/Validator |
| `999_全面重构_26.01.27/3.7.4进一步bug清扫/` | 999_全面重构_26.01.27 | 石头假死、反向修剪、掉落物关联、箱子 IsEmpty |
| `999_全面重构_26.01.27/3.7.5自动化存档/` | 999_全面重构_26.01.27 | PrefabDatabase 自动化、ID 别名映射、渲染层级存档 |
| `999_全面重构_26.01.27/3.7.6再再进一步bug清扫/` | 999_全面重构_26.01.27 | 季节渐变种子稳定性、加载顺序、箱子 Initialize 覆盖 |
| `箱子系统/` | 箱子系统 | ChestSaveData、Initialize/Load 顺序问题 |
| `农田系统/10.0.1农作物设计与完善/` | 农田系统 10.0.1 | CropSaveData 扩展、作物状态存档 |
| `SO设计系统与工具/` | SO设计系统与工具 | PersistentManagers 创建、DontDestroyOnLoad 统一管理 |

## 核心架构知识

### GUID 生命周期

| 对象类型 | GUID 来源 | 生成时机 | 稳定性 |
|---------|----------|---------|--------|
| 静态对象（场景预制体） | PersistentIdAutomator 自动分配 | 编辑器保存场景时 | ✅ 绝对稳定 |
| 动态对象（运行时生成） | `System.Guid.NewGuid()` | 运行时放置/生成 | ✅ 存档后稳定 |
| 重建对象（读档恢复） | 从存档数据读取 | DynamicObjectFactory.TryReconstruct | ✅ 与原始一致 |

### 执行顺序陷阱

动态重建的对象，`Load()` 在 `Instantiate` 后立即调用，但 `Start()` 要等到下一帧。
`Initialize()` 方法必须检查数据是否已被 `Load()` 填充（null 检查）。

### 加载顺序保证

TimeManager 必须先于所有世界对象恢复，否则季节渐变等依赖时间的系统会读到默认值。

### 反向修剪机制

`PruneStaleRecords()` 而非 `Clear()`，只移除"存档中没有但注册表中有"的对象。
石头使用假死机制：`SetActive(false)` 而非 `Destroy()`。


## 会话记录

### 会话 1 - 2026-02-12（工作区创建）

**用户需求**:
> 新建存档系统工作区，子工作区按"对存档有修改的其他工作区"命名，汇总散落各处的存档修改记录

**完成任务**:
1. [x] 创建主工作区 memory.md（核心架构知识、关键文件索引、子工作区索引）
2. [x] 创建 8 个子工作区 memory 文件
3. [x] Phase 5.0 补充发现：农作物存档集成待验证、save-system.md 需预留扩展位
4. [x] Hook 映射添加存档系统关键词

**修改文件**:
- `memory.md` - 主工作区记忆创建
- 8 个子工作区 `memory.md` - 全部创建
- `smart-assistant.kiro.hook` - 添加存档关键词映射
- `Phase5.0修复与完善.md` - 追加补充发现章节


### 会话 2 - 2026-02-15（层级命名修正）

**用户需求**:
> 存档系统下的子工作区层级命名不对，3.7.x 系列应该归属到 999_全面重构_26.01.27 下面，自定义命名的子工作区也应该改成对应的主工作区名称以及分层，不应该随意摆放

**问题分析**:
之前创建存档系统工作区时，把所有子工作区直接平铺在 `存档系统/` 下面，没有按照来源工作区的层级关系组织。用户强调的是层级命名必须正确，memory 的内容和记录方式不需要改。

**完成任务**:
1. [x] 创建正确层级的新目录并迁移 memory 文件
2. [x] 删除旧的错误层级目录下的文件
3. [x] 更新主 memory.md 中的子工作区索引表

**层级修正映射**:
| 旧路径（错误） | 新路径（正确） |
|---|---|
| `存档系统/3.7.2存档bug大清扫/` | `存档系统/999_全面重构_26.01.27/3.7.2存档bug大清扫/` |
| `存档系统/3.7.3消失bug/` | `存档系统/999_全面重构_26.01.27/3.7.3消失bug/` |
| `存档系统/3.7.4进一步bug清扫/` | `存档系统/999_全面重构_26.01.27/3.7.4进一步bug清扫/` |
| `存档系统/3.7.5自动化存档/` | `存档系统/999_全面重构_26.01.27/3.7.5自动化存档/` |
| `存档系统/3.7.6再再进一步bug清扫/` | `存档系统/999_全面重构_26.01.27/3.7.6再再进一步bug清扫/` |
| `存档系统/农作物存档集成/` | `存档系统/农田系统/10.0.1农作物设计与完善/` |
| `存档系统/箱子系统存档集成/` | `存档系统/箱子系统/` |
| `存档系统/SO设计系统存档相关/` | `存档系统/SO设计系统与工具/` |

**修改文件**:
- `存档系统/memory.md` - 更新子工作区索引表 + 追加会话记录
- 8 个新路径 memory.md - 创建（内容与旧文件一致）
- 8 个旧路径 memory.md - 删除
