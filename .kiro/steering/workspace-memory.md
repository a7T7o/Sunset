---
inclusion: always
priority: P0
isCanonical: true
canonicalDomain: [specs目录结构, memory.md规范, 工作区命名规则, 任务列表规范, 代码文件追踪]
lastUpdated: 2026-02-06
---

# 工作区记忆规范

## 核心原则

每个开发专题都必须有独立的 specs 区域，用于记录开发过程中的所有重要信息。

## Specs 目录结构（新规则 v2.0）

```
.kiro/specs/
├── memory.md                    # ★ 全局记忆文档（工作区级别）
├── last/                        # 历史工作区归档
│   ├── 砍树系统/
│   ├── 物品掉落拾取/
│   └── ...
├── 0_摄像头死区同步/            # 当前工作区（按编号排序）
│   ├── memory.md
│   ├── requirements.md
│   ├── design.md
│   └── tasks.md
├── 1_下一个功能/
│   └── ...
└── 2_再下一个功能/
    └── ...
```

### 命名规则

1. **工作区文件夹命名**：
   - 使用中文命名
   - 格式：`{编号}_{功能名称}`
   - 编号从 0 开始递增
   - 示例：`0_摄像头死区同步`、`1_摄像头抖动动画`

2. **历史归档**：
   - 旧工作区统一移入 `last/` 文件夹
   - `last/` 内保持原有文件夹名称
   - 不需要编号

3. **memory.md 位置**：
   - 每个工作区内有独立的 `memory.md`
   - 与编号文件夹和 `last/` 同级

## Memory 文档规范

### 文档优先级
- **memory.md** 是最核心的文档，每次对话任务完成后必须先更新
- 没有 memory.md 的更新，不能结束当前对话
- 其他文档（design, requirements, tasks）是可选的

### Memory 文档必须包含

1. **模块概述** - 简述该模块的功能和目标
2. **当前状态** - 模块完成度、最后更新时间
3. **会话记录** - 每次对话的详细记录
   - 会话时间
   - 用户需求原文
   - 完成的任务
   - 修改的文件
   - 解决方案思路
   - 遗留问题
4. **关键决策** - 重要的设计决策和原因
5. **相关文件** - 涉及的代码文件清单

### Memory 文档格式

```markdown
# {模块名称} - 开发记忆

## 模块概述
[简述模块功能]

## 当前状态
- **完成度**: XX%
- **最后更新**: YYYY-MM-DD
- **状态**: 进行中/已完成/待验证

## 会话记录

### 会话 N - YYYY-MM-DD

**用户需求**:
> [引用用户原话]

**完成任务**:
1. [任务1]
2. [任务2]

**修改文件**:
- `path/to/file1.cs` - [修改说明]
- `path/to/file2.cs` - [修改说明]

**解决方案**:
[详细描述解决思路]

**遗留问题**:
- [ ] [问题1]
- [ ] [问题2]

---

## 关键决策

| 决策 | 原因 | 日期 |
|------|------|------|
| [决策内容] | [原因] | YYYY-MM-DD |

## 相关文件

| 文件 | 说明 |
|------|------|
| `path/to/file.cs` | [说明] |
```

## 工作流程

### 开始新专题
1. 用户说"新建工作区，开始XXX工作"
2. 确定当前最大编号，新编号 = 最大编号 + 1
3. 创建 `.kiro/specs/{编号}_{功能名称}/` 目录
4. 创建 `memory.md` 文件
5. 记录第一次会话内容

### 每次对话结束前
1. 更新 `memory.md` 添加本次会话记录
2. 记录所有修改的文件
3. 记录解决方案和遗留问题
4. 确认 memory 更新完成后才能结束对话

### 继续已有专题
1. 先读取 `memory.md` 了解历史
2. 继续开发
3. 更新 `memory.md`

### 归档旧工作区
1. 将旧工作区文件夹移入 `last/`
2. 保持原有文件夹名称
3. 更新 README.md 中的状态

## 已有模块处理

对于已完成的模块（在 Docx/分类 中有总结文档的）：
- 创建对应的 specs 目录
- 从总结文档提取信息创建 memory.md
- 记录完成状态和关键决策
- 不需要详细的会话记录

## 新模块处理

对于新开始的模块：
- 详细记录每次会话的需求和完成情况
- 记录设计思路和解决方案
- 记录所有修改的文件
- 确保任何时候都能继续开发


---

## 🔴🔴🔴 最高优先级规则（2025-12-25 新增）🔴🔴🔴

### 绝对禁止事项

1. **禁止覆盖任何文档** - 所有 requirements.md、design.md、tasks.md 只允许新增，不允许覆盖
2. **禁止删除任何文档** - 任何情况下都不允许删除已有文档
3. **禁止修改 memory.md 历史记录** - memory.md 只允许追加新会话记录，不允许修改或删除已有记录
4. **禁止设置可选任务** - tasks.md 中的所有任务都是必须完成的，不允许使用 `*` 标记可选任务

### 任务列表规范（2026-02-03 新增）

**核心原则**：所有任务均为必须完成，不存在可选任务。

**规则说明**：
- 生成 tasks.md 时，**禁止**使用 `- [ ]*` 格式标记可选任务
- 所有任务都使用 `- [ ]` 格式，表示必须完成
- 如果某个功能确实不需要，应该在需求阶段就排除，而不是标记为可选
- 这确保了任务列表的明确性和执行的完整性

**示例**：
```markdown
# ❌ 错误做法
- [ ] 1. 实现核心功能
- [ ]* 2. 添加缓存优化（可选）
- [ ]* 3. 编写单元测试（可选）

# ✅ 正确做法
- [ ] 1. 实现核心功能
- [ ] 2. 添加缓存优化
- [ ] 3. 编写单元测试
```

### 工作区内部结构（v2.1 修正）

每个工作区内部结构如下：

```
.kiro/specs/砍树系统/           # 一个工作区
├── memory.md                   # ★ 核心记忆文档，与 old 同级
├── old/                        # 旧内容归档
│   ├── requirements.md
│   ├── design.md
│   └── tasks.md
├── 0_第一个任务/               # 编号任务文件夹
│   ├── requirements.md
│   ├── design.md
│   └── tasks.md
└── 1_第二个任务/               # 后续任务
    ├── requirements.md
    ├── design.md
    └── tasks.md
```

### 新任务处理流程

1. 在工作区内创建新的编号文件夹（如 `0_摄像头死区同步/`）
2. 在新文件夹内创建 requirements.md、design.md、tasks.md
3. 更新工作区的 memory.md（追加新会话记录）
4. **绝对不触碰 old/ 内的任何文件**

### 文档堆积原则

- 每次新任务都创建新的编号文件夹
- 旧文档永久保留在 old/ 或原编号文件夹中
- memory.md 是日志式记录，只追加不修改
- 这是用户的项目日志，必须完整保留历史

---

## 🔴🔴🔴 代码文件追踪规范（2026-02-06 新增）🔴🔴🔴

### 核心原则

**Memory 文档必须完整记录所有涉及的代码文件**，这是项目可追溯性的关键保障。

### 子工作区 Memory 要求

每个子工作区的 `memory.md` **必须**记录：

1. **修改的代码文件** - 在该子工作区中被修改过的所有 `.cs` 文件
2. **涉及的代码文件** - 虽未修改但与该功能密切相关的文件
3. **新增的代码文件** - 在该子工作区中新创建的文件
4. **删除的代码文件** - 在该子工作区中被删除的文件（标注原因）

**格式要求**：
```markdown
## 涉及的代码文件

### 核心文件（修改/新增）
| 文件 | 操作 | 说明 |
|------|------|------|
| `SaveManager.cs` | 修改 | 添加自动存档逻辑 |
| `AutoSaveService.cs` | 新增 | 自动存档服务 |

### 相关文件（引用/依赖）
| 文件 | 关系 |
|------|------|
| `TimeManager.cs` | 触发存档的时间源 |
| `PersistentManagers.cs` | 管理器注册 |
```

### 主工作区 Memory 要求

主工作区的 `memory.md` **必须**汇总所有子工作区涉及的代码文件：

1. **关键文件索引** - 按功能分类列出所有核心代码文件
2. **文件修改历史** - 记录哪些文件在哪个子工作区被修改
3. **跨子工作区文件** - 标注被多个子工作区修改的文件（高风险文件）

**格式要求**：
```markdown
## 关键文件索引

### 存档系统核心
| 文件 | 涉及的子工作区 | 最后修改 |
|------|---------------|---------|
| `SaveManager.cs` | 3.7.2, 3.7.4, 3.7.5 | 2026-02-05 |
| `SaveDataDTOs.cs` | 3.7.3, 3.7.4 | 2026-02-04 |

### 动态对象系统
| 文件 | 涉及的子工作区 | 最后修改 |
|------|---------------|---------|
| `DynamicObjectFactory.cs` | 3.7.2, 3.7.3 | 2026-02-03 |
```

### Memory 同步规则

**强制同步要求**：

1. **更新子 memory 时必须同步主 memory**
   - 子工作区完成一个阶段后，立即更新主 memory 的对应章节
   - 不允许只更新子 memory 而不更新主 memory

2. **工作区迭代结束检查**
   - 每次工作区迭代结束前，必须检查 memory 更新状态
   - 检查清单：
     - [ ] 子 memory 已记录本次修改的所有文件
     - [ ] 主 memory 已同步子 memory 的文件记录
     - [ ] 主 memory 的"当前状态"已更新

3. **代码修改必须有效记录**
   - 每次代码修改都必须在当前会话的 memory 中体现
   - 不允许"隐性修改"（修改了代码但 memory 中没有记录）

### 核心讨论触发记录

以下情况也必须触发 memory 记录（即使没有代码修改）：

1. **架构决策** - 讨论并确定了重要的架构方向
2. **问题分析** - 深入分析了某个 bug 或问题的根因
3. **设计变更** - 决定改变原有的设计方案
4. **技术债务识别** - 发现并记录了需要后续处理的技术债务
5. **锐评执行** - 执行了外部架构师的锐评指令

**记录格式**：
```markdown
### 会话 N - YYYY-MM-DD（讨论/分析）

**讨论主题**: [主题]

**核心结论**:
1. [结论1]
2. [结论2]

**后续行动**:
- [ ] [待办事项]
```

### 违规后果

不遵守代码文件追踪规范会导致：
- 项目历史不可追溯
- 无法定位问题引入的时间点
- 跨会话协作困难
- 技术债务失控
